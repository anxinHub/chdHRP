<?xml version="1.0" encoding="UTF-8" ?>
<root>
<!-- 集团化-->
<!-- 先判断是否存在临时表，不存在直接创建，存在 删除在创建-->
<sql id="t_groupaccobjsubjledger_result" type="sql"><![CDATA[
    /*集团===XX科目总账*/
declare
  num number(4);
begin
  select count(1)
    into num
    from USER_tables
   where TABLE_NAME = upper('t_groupaccobjsubjledger_result');
  if num = 1 then
    execute immediate 'DROP TABLE t_groupaccobjsubjledger_result';
   end if;
    execute immediate 'Create Global Temporary Table t_groupaccobjsubjledger_result(
                      xh integer,
                      acc_year varchar2(20),
                      acc_month varchar2(2),
                      subj_code varchar2(50),
                      subj_name varchar2(200),
                      summary varchar2(200),
                      debit numeric(19,2),
                      credit numeric(19,2),
                      subj_dire integer,
                      end_os numeric(19,2),
                      is_check numeric(2),
                      subj_level numeric(2),
                      is_last numeric(2)
                  )On COMMIT Delete ROWS';
  
 
end;
  
]]>
</sql>
<sql id="t_groupaccobjsubj_result" type="sql"><![CDATA[
/* 集团===XX科目明细账*/
declare num number(4);
begin
  select count(1)
    into num
    from USER_tables
   where TABLE_NAME = upper('t_groupaccobjsubj_result');
  if num = 1 then
    execute immediate 'DROP TABLE t_groupaccobjsubj_result';
  end if;
    execute immediate 'Create Global Temporary Table t_groupaccobjsubj_result(
                check_id numeric(19,0),
                xh integer,
                vouch_date date,
                acc_year varchar2(20),
                acc_month varchar2(2),
                vouch_no varchar2(50),
                subj_code varchar2(50),
                subj_name varchar2(200),
                obj_code varchar2(50),
                obj_name varchar2(200),        
                check1 varchar2(200),--核算1         
                check2 varchar2(200),--核算2
                check3 varchar2(200),--核算3
                check4 varchar2(200),--核算4
                summary varchar2(200),
                debit numeric(19,2),
                credit numeric(19,2),
                subj_dire integer,
                end_os numeric(19,2),
                is_check numeric(2)
                )On COMMIT Delete ROWS';
  
 
end;

]]>
</sql>

<sql id="t_groupaccsubjobjledger_result" type="sql"><![CDATA[
  /*集团===科目XX总账*/
declare num number(4);
begin
  select count(1)
    into num
    from USER_tables
   where TABLE_NAME = upper('t_groupaccsubjobjledger_result');
  if num = 1 then
     execute immediate 'DROP TABLE t_groupaccsubjobjledger_result';
  end if;
    execute immediate 'Create Global Temporary Table t_groupaccsubjobjledger_result(
                            xh integer,
                            acc_year varchar2(20),
                            acc_month varchar2(2),
                            obj_id numeric(18,0),
                            obj_code varchar2(50),
                            obj_name varchar2(200),
                            subj_code varchar2(200),
                            subj_name varchar2(200),
                            check1 varchar2(200),--核算1
                            check2 varchar2(200),--核算2
                            check3 varchar2(200),--核算3
                            check4 varchar2(200),--核算4
                            summary varchar2(200),
                            debit numeric(19,2),
                            credit numeric(19,2),
                            subj_dire integer,
                            end_os numeric(19,2),
                            is_check numeric(2)
                            )On COMMIT Delete ROWS';
  
end;
]]>
</sql>

<sql id="t_groupaccsubjobj_result" type="sql"><![CDATA[
  /*集团===科目XX明细账*/
declare num number(4);
begin
  select count(1)
    into num
    from USER_tables
   where TABLE_NAME = upper('t_groupaccsubjobj_result');
  if num = 1 then
    execute immediate 'DROP TABLE t_groupaccsubjobj_result';
  end if;
    execute immediate 'Create Global Temporary Table t_groupaccsubjobj_result(
                    check_id numeric(19,0),
                    xh integer,
                    vouch_date date,
                    acc_year varchar2(20),
                    acc_month varchar2(2),
                    vouch_no varchar2(50),
                    obj_id numeric(18,0),
                    obj_code varchar2(50),
                    obj_name varchar2(200),
                    subj_code varchar2(200),
                    subj_name varchar2(200),
                    check1 varchar2(200),--核算1
                    check2 varchar2(200),--核算2
                    check3 varchar2(200),--核算3
                    check4 varchar2(200),--核算4
                    summary varchar2(200),
                    debit numeric(19,2),
                    credit numeric(19,2),
                    subj_dire integer,
                    end_os numeric(19,2),
                           is_check numeric(2),
                            vouch_id integer
                    )On COMMIT Delete ROWS';
 
end;
]]>
</sql>
<sql id="t_groupbalancedetail_result_bm" type="sql"><![CDATA[
  /*集团===部门余额表*/
declare
  num number(4);
begin
  SELECT COUNT(1)
    INTO num
    FROM USER_TABLES
   WHERE TABLE_NAME = UPPER('t_groupbalancedetail_result_bm');
  IF num = 1 THEN
    execute immediate 'DROP TABLE t_groupbalancedetail_result_bm';
 END IF;
    
    execute immediate 'Create Global Temporary Table t_groupbalancedetail_result_bm(
                  idx numeric(2,0),
                  obj_id numeric(18,0),
                  obj_no numeric(18,0),
                  subj_level numeric(18,0),
                  obj_code varchar2(20),
                  obj_name varchar2(200),
                  spell_code varchar2(200),
                    wbx_code varchar2(200),
                  nc_debit numeric(19,2),
                  nc_credit numeric(19,2),
                  qc_debit numeric(19,2),
                  qc_credit numeric(19,2),
                  bq_debit numeric(19,2),
                  bq_credit numeric(19,2),
                  lj_debit numeric(19,2),
                  lj_credit numeric(19,2),
                  end_debit numeric(19,2),
                  end_credit numeric(19,2),
                        is_check numeric(2),
                       subj_code varchar2(20)
                  )On COMMIT Delete ROWS';
  
  

  SELECT COUNT(1)
    INTO num
    FROM USER_TABLES
   WHERE TABLE_NAME = UPPER('t_groupbalancedetail_resultsbm');
  IF num = 1 THEN
   execute immediate 'DROP TABLE t_groupbalancedetail_resultsbm';
   END IF;
    execute immediate 'Create Global Temporary Table t_groupbalancedetail_resultsbm(
                  idx numeric(2,0),
                  obj_id numeric(18,0),
                  obj_no numeric(18,0),
                  subj_level numeric(18,0),
                  obj_code varchar2(20),
                  obj_name varchar2(200),
                  spell_code varchar2(200),
                    wbx_code varchar2(200),
                  nc_debit numeric(19,2),
                  nc_credit numeric(19,2),
                  qc_debit numeric(19,2),
                  qc_credit numeric(19,2),
                  bq_debit numeric(19,2),
                  bq_credit numeric(19,2),
                  lj_debit numeric(19,2),
                  lj_credit numeric(19,2),
                  end_debit numeric(19,2),
                  end_credit numeric(19,2),
                        is_check numeric(2),
                      subj_code varchar2(20)
                  )On COMMIT Delete ROWS';
  
 
end;

]]>
</sql>


<sql id="t_groupbalancedetail_result_zg" type="sql"><![CDATA[
/*集团===职工余额表*/
  declare
  num number(4);
begin
  SELECT COUNT(1)
    INTO num
    FROM USER_TABLES
   WHERE TABLE_NAME = UPPER('t_groupbalancedetail_result_zg');
  IF num = 1 THEN
    execute immediate 'DROP TABLE t_groupbalancedetail_result_zg';
   END IF;
    
    execute immediate 'Create Global Temporary Table t_groupbalancedetail_result_zg(
                      idx numeric(2,0),
                      obj_id numeric(18,0),
                      obj_no numeric(18,0),
                      subj_level numeric(18,0),
                      obj_code varchar2(20),
                      obj_name varchar2(200),
                      spell_code varchar2(200),
                      wbx_code varchar2(200),
                      nc_debit numeric(19,2),
                      nc_credit numeric(19,2),
                      qc_debit numeric(19,2),
                      qc_credit numeric(19,2),
                      bq_debit numeric(19,2),
                      bq_credit numeric(19,2),
                      lj_debit numeric(19,2),
                      lj_credit numeric(19,2),
                      end_debit numeric(19,2),
                      end_credit numeric(19,2),
                      is_check numeric(2),
                      subj_code varchar2(20)
                      )On COMMIT Delete ROWS';
  
 

  SELECT COUNT(1)
    INTO num
    FROM USER_TABLES
   WHERE TABLE_NAME = UPPER('t_groupbalancedetail_resultszg');
  IF num = 1 THEN
    execute immediate 'DROP TABLE t_groupbalancedetail_resultszg';
   END IF;
    execute immediate 'Create Global Temporary Table t_groupbalancedetail_resultszg(
                      idx numeric(2,0),
                      obj_id numeric(18,0),
                      obj_no numeric(18,0),
                      subj_level numeric(18,0),
                      obj_code varchar2(20),
                      obj_name varchar2(200),
                      spell_code varchar2(200),
                      wbx_code varchar2(200),
                      nc_debit numeric(19,2),
                      nc_credit numeric(19,2),
                      qc_debit numeric(19,2),
                      qc_credit numeric(19,2),
                      bq_debit numeric(19,2),
                      bq_credit numeric(19,2),
                      lj_debit numeric(19,2),
                      lj_credit numeric(19,2),
                      end_debit numeric(19,2),
                      end_credit numeric(19,2),
                      is_check numeric(2),
                      subj_code varchar2(20)
                      )On COMMIT Delete ROWS';
 

end; 


]]>
</sql>

<sql id="t_groupbalancedetail_result_xm" type="sql"><![CDATA[
 /*集团===项目余额表*/
  declare
  num number(4);
begin
  SELECT COUNT(1)
    INTO num
    FROM USER_TABLES
   WHERE TABLE_NAME = UPPER('t_groupbalancedetail_result_xm');
  IF num = 1 THEN
   execute immediate 'DROP TABLE t_groupbalancedetail_result_xm';
   END IF;
    execute immediate 'Create Global Temporary Table t_groupbalancedetail_result_xm(
                       idx numeric(2,0),
                      obj_id numeric(18,0),
                      obj_no numeric(18,0),
                      subj_level numeric(18,0),
                      obj_code varchar2(20),
                      obj_name varchar2(200),
                      spell_code varchar2(200),
                      wbx_code varchar2(200),
                      nc_debit numeric(19,2),
                      nc_credit numeric(19,2),
                      qc_debit numeric(19,2),
                      qc_credit numeric(19,2),
                      bq_debit numeric(19,2),
                      bq_credit numeric(19,2),
                      lj_debit numeric(19,2),
                      lj_credit numeric(19,2),
                      end_debit numeric(19,2),
                      end_credit numeric(19,2),
                      is_check numeric(2),
                      subj_code varchar2(20)
                      )On COMMIT Delete ROWS';
 

  SELECT COUNT(1)
    INTO num
    FROM USER_TABLES
   WHERE TABLE_NAME = UPPER('t_groupbalancedetail_resultsxm');
  IF num = 1 THEN
   execute immediate 'DROP TABLE t_groupbalancedetail_resultsxm';
  END IF;
    execute immediate 'Create Global Temporary Table t_groupbalancedetail_resultsxm(
                      idx numeric(2,0),
                      obj_id numeric(18,0),
                      obj_no numeric(18,0),
                      subj_level numeric(18,0),
                      obj_code varchar2(20),
                      obj_name varchar2(200),
                      spell_code varchar2(200),
                      wbx_code varchar2(200),
                      nc_debit numeric(19,2),
                      nc_credit numeric(19,2),
                      qc_debit numeric(19,2),
                      qc_credit numeric(19,2),
                      bq_debit numeric(19,2),
                      bq_credit numeric(19,2),
                      lj_debit numeric(19,2),
                      lj_credit numeric(19,2),
                      end_debit numeric(19,2),
                      end_credit numeric(19,2),
                      is_check numeric(2),
                      subj_code varchar2(20)
                      )On COMMIT Delete ROWS';
  
  

end;


]]>
</sql>

<sql id="t_groupbalancedetail_resultgys" type="sql"><![CDATA[
/*集团===供应商余额表*/ 
declare
  num number(4);
begin
  SELECT COUNT(1)
    INTO num
    FROM USER_TABLES
   WHERE TABLE_NAME = UPPER('t_groupbalancedetail_resultgys');
  IF num = 1 THEN
   execute immediate 'DROP TABLE t_groupbalancedetail_resultgys';
  END IF;
    execute immediate 'Create Global Temporary Table t_groupbalancedetail_resultgys(
                  idx numeric(2,0),
                  obj_id numeric(18,0),
                  obj_no numeric(18,0),
                  subj_level numeric(18,0),
                  obj_code varchar2(20),
                  obj_name varchar2(200),
                  spell_code varchar2(200),
                  wbx_code varchar2(200),
                  nc_debit numeric(19,2),
                  nc_credit numeric(19,2),
                  qc_debit numeric(19,2),
                  qc_credit numeric(19,2),
                  bq_debit numeric(19,2),
                  bq_credit numeric(19,2),
                  lj_debit numeric(19,2),
                  lj_credit numeric(19,2),
                  end_debit numeric(19,2),
                  end_credit numeric(19,2),
                  is_check numeric(2),
                  subj_code varchar2(20)
                  )On COMMIT Delete ROWS';
 

  SELECT COUNT(1)
    INTO num
    FROM USER_TABLES
   WHERE TABLE_NAME = UPPER('t_groupbalancedetailresultsgys');
  IF num = 1 THEN
    execute immediate 'DROP TABLE t_groupbalancedetailresultsgys';
  END IF;
    
    execute immediate 'Create Global Temporary Table t_groupbalancedetailresultsgys(
                  idx numeric(2,0),
                  obj_id numeric(18,0),
                  obj_no numeric(18,0),
                  subj_level numeric(18,0),
                  obj_code varchar2(20),
                  obj_name varchar2(200),
                  spell_code varchar2(200),
                  wbx_code varchar2(200),
                  nc_debit numeric(19,2),
                  nc_credit numeric(19,2),
                  qc_debit numeric(19,2),
                  qc_credit numeric(19,2),
                  bq_debit numeric(19,2),
                  bq_credit numeric(19,2),
                  lj_debit numeric(19,2),
                  lj_credit numeric(19,2),
                  end_debit numeric(19,2),
                  end_credit numeric(19,2),
                  is_check numeric(2),
                  subj_code varchar2(20)
                  )On COMMIT Delete ROWS';
  

end;

]]>
</sql>
<sql id="t_groupbalancedetail_result_kh" type="sql"><![CDATA[
/*集团===客户余额表*/
declare
  num number(4);
begin
  SELECT COUNT(1)
    INTO num
    FROM USER_TABLES
   WHERE TABLE_NAME = UPPER('t_groupbalancedetail_result_kh');
  IF num = 1 THEN
     execute immediate 'DROP TABLE t_groupbalancedetail_result_kh';
   END IF;
  
    execute immediate 'Create Global Temporary Table t_groupbalancedetail_result_kh(
                        idx numeric(2,0),
                        obj_id numeric(18,0),
                        obj_no numeric(18,0),
                        subj_level numeric(18,0),
                        obj_code varchar2(20),
                        obj_name varchar2(200),
                        spell_code varchar2(200),
                        wbx_code varchar2(200),
                        nc_debit numeric(19,2),
                        nc_credit numeric(19,2),
                        qc_debit numeric(19,2),
                        qc_credit numeric(19,2),
                        bq_debit numeric(19,2),
                        bq_credit numeric(19,2),
                        lj_debit numeric(19,2),
                        lj_credit numeric(19,2),
                        end_debit numeric(19,2),
                        end_credit numeric(19,2),
                        is_check numeric(2),
                        subj_code varchar2(20)
                        )On COMMIT Delete ROWS';
 

  SELECT COUNT(1)
    INTO num
    FROM USER_TABLES
   WHERE TABLE_NAME = UPPER('t_groupbalancedetail_resultskh');
  IF num = 1 THEN
    execute immediate 'DROP TABLE t_groupbalancedetail_resultskh';
  END IF;
    execute immediate 'Create Global Temporary Table t_groupbalancedetail_resultskh(
                        idx numeric(2,0),
                        obj_id numeric(18,0),
                        obj_no numeric(18,0),
                        subj_level numeric(18,0),
                        obj_code varchar2(20),
                        obj_name varchar2(200),
                        spell_code varchar2(200),
                        wbx_code varchar2(200),
                        nc_debit numeric(19,2),
                        nc_credit numeric(19,2),
                        qc_debit numeric(19,2),
                        qc_credit numeric(19,2),
                        bq_debit numeric(19,2),
                        bq_credit numeric(19,2),
                        lj_debit numeric(19,2),
                        lj_credit numeric(19,2),
                        end_debit numeric(19,2),
                        end_credit numeric(19,2),
                        is_check numeric(2),
                        subj_code varchar2(20)
                        )On COMMIT Delete ROWS';
  
end;

]]>
</sql>

<sql id="t_groupbalancedetail_result_kf" type="sql"><![CDATA[
/*集团===库房余额表*/
declare
  num number(4);
begin
  SELECT COUNT(1)
    INTO num
    FROM USER_TABLES
   WHERE TABLE_NAME = UPPER('t_groupbalancedetail_result_kf');
  IF num = 1 THEN
     execute immediate 'DROP TABLE t_groupbalancedetail_result_kf';
   END IF;
    execute immediate 'Create Global Temporary Table t_groupbalancedetail_result_kf(
                      idx numeric(2,0),
                      obj_id numeric(18,0),
                      obj_no numeric(18,0),
                      subj_level numeric(18,0),
                      obj_code varchar2(20),
                      obj_name varchar2(200), 
                    spell_code varchar2(200),
                    wbx_code varchar2(200),
                      nc_debit numeric(19,2),
                      nc_credit numeric(19,2),
                      qc_debit numeric(19,2),
                      qc_credit numeric(19,2),
                      bq_debit numeric(19,2),
                      bq_credit numeric(19,2),
                      lj_debit numeric(19,2),
                      lj_credit numeric(19,2),
                      end_debit numeric(19,2),
                      end_credit numeric(19,2),
                      is_check numeric(2),
                      subj_code varchar2(20)
                      )On COMMIT Delete ROWS';
 

  SELECT COUNT(1)
    INTO num
    FROM USER_TABLES
   WHERE TABLE_NAME = UPPER('t_groupbalancedetail_resultskf');
  IF num = 1 THEN
     execute immediate 'DROP TABLE t_groupbalancedetail_resultskf';
  END IF;
    execute immediate 'Create Global Temporary Table t_groupbalancedetail_resultskf(
                      idx numeric(2,0),
                      obj_id numeric(18,0),
                      obj_no numeric(18,0),
                      subj_level numeric(18,0),
                      obj_code varchar2(20),
                      obj_name varchar2(200),
                      spell_code varchar2(200),
                    wbx_code varchar2(200),
                      nc_debit numeric(19,2),
                      nc_credit numeric(19,2),
                      qc_debit numeric(19,2),
                      qc_credit numeric(19,2),
                      bq_debit numeric(19,2),
                      bq_credit numeric(19,2),
                      lj_debit numeric(19,2),
                      lj_credit numeric(19,2),
                      end_debit numeric(19,2),
                      end_credit numeric(19,2),
                      is_check numeric(2),
                      subj_code varchar2(20)
                      )On COMMIT Delete ROWS';
 
end; 

]]>
</sql>

<sql id="t_groupbalancedetail_result_dw" type="sql"><![CDATA[
 /*集团===单位余额表*/
  declare
  num number(4);
begin
  SELECT COUNT(1)
    INTO num
    FROM USER_TABLES
   WHERE TABLE_NAME = UPPER('t_groupbalancedetail_result_dw');
  IF num = 1 THEN
     execute immediate 'DROP TABLE t_groupbalancedetail_result_dw';
 END IF;
    execute immediate 'Create Global Temporary Table t_groupbalancedetail_result_dw(
                  idx numeric(2,0),
                  obj_id numeric(18,0),
                  obj_no numeric(18,0),
                  subj_level numeric(18,0),
                  obj_code varchar2(20),
                  obj_name varchar2(200), 
                  nc_debit numeric(19,2),
                  nc_credit numeric(19,2),
                  qc_debit numeric(19,2),
                  qc_credit numeric(19,2),
                  bq_debit numeric(19,2),
                  bq_credit numeric(19,2),
                  lj_debit numeric(19,2),
                  lj_credit numeric(19,2),
                  end_debit numeric(19,2),
                  end_credit numeric(19,2),
                        is_check numeric(2),
                       subj_code varchar2(20)
                  )On COMMIT Delete ROWS';
  

  SELECT COUNT(1)
    INTO num
    FROM USER_TABLES
   WHERE TABLE_NAME = UPPER('t_groupbalancedetail_resultsdw');
  IF num = 1 THEN
    execute immediate 'DROP TABLE t_groupbalancedetail_resultsdw';
 END IF;
    execute immediate 'Create Global Temporary Table t_groupbalancedetail_resultsdw(
                  idx numeric(2,0),
                  obj_id numeric(18,0),
                  obj_no numeric(18,0),
                  subj_level numeric(18,0),
                  obj_code varchar2(20),
                  obj_name varchar2(200), 
                  nc_debit numeric(19,2),
                  nc_credit numeric(19,2),
                  qc_debit numeric(19,2),
                  qc_credit numeric(19,2),
                  bq_debit numeric(19,2),
                  bq_credit numeric(19,2),
                  lj_debit numeric(19,2),
                  lj_credit numeric(19,2),
                  end_debit numeric(19,2),
                  end_credit numeric(19,2),
                        is_check numeric(2),
                      subj_code varchar2(20)
                  )On COMMIT Delete ROWS';
  
end;

]]>
</sql>

<sql id="t_groupzcheckobjledger_result" type="sql"><![CDATA[
	/*===集团===== 核算项科目总账============*/
declare
  num number(4);
begin
  select count(1)
    into num
    from USER_tables
   where TABLE_NAME = upper('t_groupzcheckobjledger_result');
  if num = 1 then
    execute immediate 'DROP TABLE t_groupzcheckobjledger_result';
  end if;
    
    execute immediate 'Create Global Temporary Table t_groupzcheckobjledger_result(
                        check_id numeric(19,0),
                        xh integer,
                        vouch_date date,
                        acc_year varchar2(20),
                        acc_month varchar2(2),
                        vouch_no varchar2(50),
                        subj_code varchar2(50),
                        subj_name varchar2(200),
                        check1 varchar2(200),--核算1
                        check2 varchar2(200),--核算2
                        check3 varchar2(200),--核算3
                        check4 varchar2(200),--核算4
                        summary varchar2(200),
                        debit numeric(19,2),
                        credit numeric(19,2),
                        subj_dire integer,
                        end_os numeric(19,2),
                           is_check numeric(2)
                        )On COMMIT Delete ROWS';
  
  
end;

]]>
</sql>

<sql id="t_groupzcheckobjdetail_result" type="sql"><![CDATA[
	 /*==集团=====核算项科目明细账============*/
declare
  num number(4);
begin
  select count(1)
    into num
    from USER_tables
   where TABLE_NAME = upper('t_groupzcheckobjdetail_result');
  if num = 1 then
   execute immediate 'DROP TABLE t_groupzcheckobjdetail_result';
  end if;
    
    execute immediate 'Create Global Temporary Table t_groupzcheckobjdetail_result(
                check_id numeric(19,0),
                xh integer,
                vouch_date date,
                acc_year varchar2(20),
                acc_month varchar2(2),
                vouch_no varchar2(50),
                subj_code varchar2(50),
                subj_name varchar2(200),
                check1 varchar2(200),--核算1
                check2 varchar2(200),--核算2
                check3 varchar2(200),--核算3
                check4 varchar2(200),--核算4
                summary varchar2(200),
                debit numeric(19,2),
                credit numeric(19,2),
                subj_dire integer,
                end_os numeric(19,2),
                   is_check numeric(2)
                )On COMMIT Delete ROWS';
  
  
end;

]]>
</sql>

<sql id="t_groupzchecksubjledger_result" type="sql"><![CDATA[
	/*===集团====科目核算项总账============*/
declare
  num number(4);
begin
  select count(1)
    into num
    from USER_tables
   where TABLE_NAME = upper('t_groupzchecksubjledger_result');
  if num = 1 then
     execute immediate 'DROP TABLE t_groupzchecksubjledger_result';
 end if;
    execute immediate 'Create Global Temporary Table t_groupzchecksubjledger_result(
           xh integer,
            acc_year varchar2(20),
            acc_month varchar2(2),
            obj_id numeric(18,0),
            obj_code varchar2(50),
            obj_name varchar2(200),
            subj_code varchar2(200),
            subj_name varchar2(200),
            check1 varchar2(200),--核算1
            check2 varchar2(200),--核算2
            check3 varchar2(200),--核算3
            check4 varchar2(200),--核算4
            summary varchar2(200),
            debit numeric(19,2),
            credit numeric(19,2),
            subj_dire integer,
            end_os numeric(19,2),
              is_check numeric(2)
            )On COMMIT Delete ROWS';
  
  
end;

]]>
</sql>


<sql id="t_groupzchecksubjdetail_result" type="sql"><![CDATA[

	 /*===集团====科目核算项明细账============*/
declare
  num number(4);
begin
  select count(1)
    into num
    from USER_tables
   where TABLE_NAME = upper('t_groupzchecksubjdetail_result');
  if num = 1 then
    execute immediate 'DROP TABLE t_groupzchecksubjdetail_result';
  end if;
    execute immediate 'Create Global Temporary Table t_groupzchecksubjdetail_result(
                  check_id numeric(19,0),
                  xh integer,
                  vouch_date date,
                  acc_year varchar2(20),
                  acc_month varchar2(2),
                  vouch_no varchar2(50),
                  vouch_id numeric(18,0),
                  obj_id numeric(18,0),
                  obj_code varchar2(50),
                  obj_name varchar2(200),
                  subj_code varchar2(50),
                  subj_name varchar2(200),
                  check1 varchar2(200),--核算1
                  check2 varchar2(200),--核算2
                  check3 varchar2(200),--核算3
                  check4 varchar2(200),--核算4
                  summary varchar2(200),
                  debit numeric(19,2),
                  credit numeric(19,2),
                  subj_dire integer,
                  end_os numeric(19,2),
                    is_check numeric(2)
                  )On COMMIT Delete ROWS';
  
  
end;
]]>
</sql>
	
	
	/*=====集团=====*/
	<sql id="group_objsubjgeneralled_bm" type="proc"><![CDATA[
CREATE OR REPLACE PROCEDURE group_objsubjgeneralled_bm
       
      /*部门科目总账*/
      (
       prm_group_id number,
       prm_hos_id number,
       prm_copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       subj_level integer,--科目级次
       rela_code  varchar2, --- 用于多账套查询
       objdata OUT ACT_BOOKS.objsubjgeneralcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
          subj_code varchar2(4000) ;
          subj_level_sql varchar2(4000) ;
          num NUMBER;
      BEGIN

          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;


          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          else
             table_name := '';
             obj_where_field := '';
          end if;

          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||prm_subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(prm_subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(prm_subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_code in('||subj_code||') ';
             subj_code:= ' select a.subj_code from acc_subj a where a.group_id ='||prm_group_id||' and a.hos_id  = '||prm_hos_id||' and a.copy_code= '''||prm_copy_code||'''
                         and a.subj_code in('||prm_subj_code||') ';
             subj_wheresql:=' and hs.subj_code in('||subj_code||') ';
          else
            --1查询全部
             subj_wheresql:='  and ((hs.check1= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
              and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
               and   act.check_type_id = hs.check1 and act.check_type_name=''部门'')) or
          (hs.check2= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check2 and act.check_type_name=''部门'')) or
          (hs.check3= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check3 and act.check_type_name=''部门'')) or
          (hs.check4= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check4 and act.check_type_name=''部门'' ))
                         )';
          end if;

          /*科目级次查询*/
          if subj_level =1 then
                 subj_level_sql:=' and t.subj_level= 1 ';
          elsif subj_level =2 then
                 subj_level_sql:=' and t.subj_level= 2 ';
          elsif subj_level =3 then
                 subj_level_sql:=' and t.subj_level= 3 ';
          elsif subj_level =4 then
                 subj_level_sql:=' and t.subj_level= 4 ';
          elsif subj_level =5 then
                 subj_level_sql:=' and t.subj_level= 5 ';
          elsif subj_level =6 then
                 subj_level_sql:=' and t.subj_level= 6 ';
          elsif subj_level =99 then
                 subj_level_sql:=' and t.is_last = 1 ';
          else
                 subj_level_sql:='';
          end if;


          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;

          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=prm_group_id and hos_id=prm_hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          /*条件处理end*/


          if acc_month_b='01' then

            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check,subj_level,is_last)
            select 1,''0000'',''00'',hs.subj_name_all,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os),hs.is_check,hs.subj_level,hs.is_last from acc_leder_check c
            inner join acc_subj hs on c.group_id =hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and hs.subj_code=c.subj_code
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
            left join hos_copy_rela hcr on hs.group_id = hcr.group_id and hs.hos_id = hcr.hos_id and hs.copy_code = hcr.copy_code
            where c.group_id=:prm_group_id 
            and hcr.rela_code in ('||rela_code||')
             and c.acc_year=:acc_year_b and c.acc_month=''00''
            '||subj_wheresql||'
            '||obj_wheresql||'
            '||source_wheresql||'
            group by hs.subj_code,hs.subj_name_all,hs.subj_dire,hs.is_check,hs.subj_level,hs.is_last'
            using prm_group_id,acc_year_b;

          else

            /*期初余额*/
            summary:='期初余额';

            execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check,subj_level,is_last)
            select 1,''0000'',''00'',t1.subj_code,t1.subj_name_all,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os),t1.is_check,t1.subj_level,t1.is_last from
            (
              select c.acc_year,c.acc_month,hs.subj_code,hs.subj_name_all,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(c.end_os) end_os,hs.is_check
              ,hs.subj_level,hs.is_last
                from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_code=hs.subj_code
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where c.group_id=:prm_group_id 
              and hcr.rela_code in ('||rela_code||') 
              and c.acc_year=:acc_year_b and c.acc_month=''00''
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by c.acc_year,c.acc_month,hs.subj_code,hs.subj_name_all,hs.subj_dire,hs.is_check,hs.subj_level,hs.is_last
              union all
              select c.acc_year,null as acc_month,hs.subj_code,hs.subj_name_all,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
                     sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check,hs.subj_level,hs.is_last
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_code=hs.subj_code
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where v.group_id=:prm_group_id 
                    and hcr.rela_code in ('||rela_code||')
                     and v.state>=:state
                    and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by c.acc_year,v.acc_month,hs.subj_code,hs.subj_name_all,hs.subj_dire,hs.is_check,hs.subj_level,hs.is_last
             ) t1 group by t1.acc_year,t1.acc_month,t1.subj_code,t1.subj_name_all,t1.subj_dire,t1.is_check,t1.subj_level,t1.is_last'
             using prm_group_id,acc_year_b,
            prm_group_id,state,acc_year_b,acc_month_b;

          end if;

          /*本月合计数据*/
          execute immediate 'insert into t_groupaccobjsubjledger_result(
          xh,acc_year,acc_month ,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check,subj_level,is_last)
          select 2,v.acc_year,v.acc_month,hs.subj_code,hs.subj_name_all,''本月合计'',sum(c.debit),sum(c.credit),hs.subj_dire,
                 case when subj_dire=1 then sum(c.credit)-sum(c.debit) else sum(c.debit)-sum(c.credit) end   end_os,hs.is_check,hs.subj_level,hs.is_last
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code
          inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_code=hs.subj_code
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:prm_group_id 
                and hcr.rela_code in ('||rela_code||')
                and v.state>=:state
                and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
                '||subj_wheresql||'
                '||obj_wheresql||'
                '||source_wheresql||'
          group by v.acc_year,v.acc_month,hs.subj_code,hs.subj_name_all,hs.subj_dire,hs.is_check,hs.subj_level,hs.is_last
          ' using prm_group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;

          /*计算本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            subj_code varchar2(50);
            xh integer;
            i number;
            begin
              i:=1;
              subj_code:='';
              end_os_month:=0;
            for cr in (select r.xh,r.subj_code,r.subj_name,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccobjsubjledger_result r
              where r.xh<3
              order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop

              /*新的科目从0开始计算*/
              if subj_code<>cr.subj_code then
                end_os_sum:=0;
                 if (cr.xh=2 ) or (i=1 and cr.xh>1) then
                    if cr.acc_month = ''01'' then
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_code,cr.subj_name,''上年结转'',0);
                     else
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_code,cr.subj_name,''期初余额'',0);
                     end if;
                end if;
               end if;

                if subj_code=cr.subj_code and cr.xh=2 and xh!=1 then
                   --dbms_output.put_line(cr.subj_code);
                   --dbms_output.put_line(cr.acc_month);
                   insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_code,subj_name,subj_dire,summary,end_os)
                   values( 1,cr.acc_year,cr.acc_month,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);

              end if;
              end_os_sum:=end_os_sum+cr.end_os;

              /*本月合计余额*/
              if cr.xh=2 then
                 update t_groupaccobjsubjledger_result set end_os=end_os_sum where xh=2 and subj_code=cr.subj_code
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;

              i:=i+1;
              subj_code:=cr.subj_code;
              xh:=cr.xh;
            end loop;
          end; ';

    /*本年累计的发生凭证   v.acc_month<开始月*/
          execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_code,subj_name,debit,credit,subj_dire,end_os,is_check,subj_level,is_last)
            select 4,c.acc_year,null as acc_month,hs.subj_code,hs.subj_name_all,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
                     sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check,hs.subj_level,hs.is_last
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_code=hs.subj_code
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              where v.group_id=:prm_group_id and v.hos_id=:prm_hos_id and v.copy_code=:prm_copy_code and v.state>=:state
                    and v.acc_year=:acc_year_b and v.acc_month>=''01'' and v.acc_month<=:acc_month_b
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by c.acc_year, hs.subj_code,hs.subj_name_all,hs.subj_dire,hs.is_check,hs.subj_level,hs.is_last

              '
               using  prm_group_id,prm_hos_id,prm_copy_code,state,acc_year_b,acc_month_b;

          /*本年累计数据*/
          /*ddl_sql:='insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 3,t1.acc_year,t1.acc_month,t1.subj_code,t1.subj_name,''本年累计'',
          t1.debit+nvl((select sum(r1.debit) from t_groupaccobjsubjledger_result r1 where r1.xh=4 and r1.debit<>0 and r1.subj_code=t1.subj_code and t1.acc_year='''||acc_year_b||'''),0),
          t1.credit+nvl((select sum(r1.credit) from t_groupaccobjsubjledger_result r1 where r1.xh=4 and r1.credit<>0 and r1.subj_code=t1.subj_code and t1.acc_year='''||acc_year_b||'''),0),
          t1.subj_dire,t1.end_os,t1.is_check from
            (select 3,r.acc_year,r.acc_month,r.subj_code,r.subj_name,
            sum(r.debit) over(partition by r.acc_year,r.subj_code order by r.acc_month) debit,
            sum(r.credit) over(partition by r.acc_year,r.subj_code order by r.acc_month) credit,
            r.subj_dire,r.end_os,r.is_check
            from t_groupaccobjsubjledger_result r
            where r.xh=2
           ) t1
          ';*/
           ddl_sql:='insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check,subj_level,is_last)
          select 3,t1.acc_year,t1.acc_month,t1.subj_code,t1.subj_name,''本年累计'',
          t1.debit,
          t1.credit,
          t1.subj_dire,t1.end_os,t1.is_check,t1.subj_level,t1.is_last from
             t_groupaccobjsubjledger_result t1
            where t1.xh=4
          ';

          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;


         select count(1) into num from acc_subj a5 where a5.group_id = prm_group_id
                    and a5.hos_id = prm_hos_id
                    and a5.copy_code = prm_copy_code
                    and a5.acc_year = acc_year_b
                    and a5.subj_code like ''||prm_subj_code||'%' ;

         if num>1 then
           --逐级汇总
            insert into t_groupaccobjsubjledger_result
                          (xh,acc_year,acc_month,subj_code,subj_name,summary,debit,credit, end_os,
                     subj_dire,subj_level,is_last )
                 select b.xh as xh,
                        a.acc_year,
                      '00' as acc_month  ,
                      a.subj_code,
                      a.subj_name,
                      b.summary,
                      sum(nvl(b.debit, 0)) as debit,
                      sum(nvl(b.credit, 0)) as credit ,
                    sum(nvl(b.end_os, 0)) as end_os ,
                   a.subj_dire
                   ,a.subj_level,a.is_last
                 from (select distinct a5.acc_year,
                          a5.subj_code,
                          a5.subj_name,
                          a5.subj_level,
                          a5.is_check,
                          a5.is_last,
                          a5.subj_dire
                    from acc_subj a5
                    where a5.group_id = prm_group_id
                    and a5.hos_id = prm_hos_id
                    and a5.copy_code = prm_copy_code
                    and a5.acc_year = acc_year_b
                    and a5.is_last = 0
                    and a5.is_stop = 0
                    and a5.subj_code like ''||prm_subj_code||'%'
                    ) a
               right join t_groupaccobjsubjledger_result b
               on b.subj_code like (a.subj_code || '%')

               group by a.acc_year,
                        a.subj_code,
                        a.subj_name,
                        b.summary,
                        b.xh,
                    a.subj_dire,a.subj_level,a.is_last ;
          end if ;

          ddl_sql:='
          select
                 case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
                  case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
                  t.subj_code||'' ''||t.subj_name subj_name,
                  t.summary,
                    t.debit   debit,
                   t.credit   credit,
                  case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,
                  t.end_os
          from t_groupaccobjsubjledger_result t
           where t.xh<=3'||subj_level_sql||'
          order by t.subj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql;

      END group_objsubjgeneralled_bm;
	
	]]></sql>
	
	<sql id="group_objsubjdetail_bm" type="proc"><![CDATA[
	
	/*========集团=============*/
CREATE OR REPLACE PROCEDURE group_objsubjdetail_bm

      /*部门科目明细账*/
      (
       group_id number,
       hos_id number,
       copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       is_happend integer,--无发生不显示期初余额0,1
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       rela_code  varchar2, --- 用于多账套查询 
       objdata OUT ACT_BOOKS.objsubjcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_show_field varchar2(200);--要显示的动态字段
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          check_insertsql varchar2(500);--辅助核算添加动态字段
          check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
          check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
           subj_id varchar2(4000) ;
          num NUMBER;
          happen_where varchar2(4000);
      BEGIN
      
          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;
          
          
          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.dept_code obj_code,hd.dept_name obj_name';
             
          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.emp_code obj_code,hd.emp_name obj_name';
             
          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.proj_code obj_code,hd.proj_name obj_name';
            
          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.sup_code obj_code,hd.sup_name obj_name';
             
          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.cus_code obj_code,hd.cus_name obj_name';
             
          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.store_code obj_code,hd.store_name obj_name';
             
          else
             table_name := '';
             obj_where_field := '';
          end if;
    
          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
            -- subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
              subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
                         and a.subj_code in('||subj_code||') ';  
              
             subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;
    
    
          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;
    
          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          
          if is_happend = 1 then
               happen_where:='where (exists(
                                    select 1 from t_groupaccobjsubj_result t1
                                    where t1.subj_id=t.subj_id 
                                          and TO_NUMBER(t1.acc_year||''''||t1.acc_month) 
                                          between TO_NUMBER('||acc_year_b||''||acc_month_b||') 
                                          and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                          ))';
             else
               happen_where:='';
          end if;
          
          /*条件处理end*/
    
          /*明细账需要拼辅助核算字段*/
          check_insertsql:='';
          check_selectsql:='';
          check_joinsql:='';
          --check_resultsql:='';
          declare
              check_i integer;
              dict_show_para integer;
              dict_show_sql varchar2(100);
              TYPE ref_type IS REF CURSOR;--定义游标指针
              v_cursor ref_type;--定义游标变量
              check_type_id numeric(18);
              check_table varchar2(50);
              is_sys integer;
              column_id varchar2(50);
              column_no varchar2(50);
              column_code varchar2(50);
              column_name varchar2(50);
              column_check varchar2(50);
              is_change integer;
          begin
            check_i:=0;
            --dbms_output.put_line(ddl_sql);
            OPEN v_cursor FOR '
                select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
                where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
                and exists(
                  select 1 from ACC_SUBJ hs
                  where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
                   '||subj_wheresql||'
                  --and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
                  and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
                ) and b.check_type_id<>3
                order by b.sort_code' 
                using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
            LOOP
            FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中
    
              EXIT WHEN v_cursor%NOTFOUND;    
              check_i:=check_i+1;
    
              --系统核算
              if is_sys=1 then
                
                  --有变更表需要取显示方式的参数
                  dict_show_sql:='';
                  if is_change=1 then
                      SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                      IF dict_show_para = 0 THEN
                           dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check1_no ';--显示历史数据
                      else
                           dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                      end if;
                     --要拼成的结果语句
                     --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                     --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
                  end if;
    
                  check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
                  check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check1_id '||dict_show_sql;
                  --要拼成的结果语句
                  --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
                  --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;
    
              --自定义核算
              elsif is_sys=0 then
                    check_selectsql:=check_selectsql||','||column_check;
                  /*check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
                  where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id 
                  and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;  */         
                 --要拼成的结果语句 
                 /* ,(select check_item_code||' '||check_item_name from acc_check_item item
                  where exists(
                  select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id 
                  and item.check_item_id=avz.check_item_id and avz.check_type_id=29
                  )) check_name2*/
                
    
              end if;
              check_insertsql:=check_insertsql||',check'||check_i;
    
            /*只支持同时挂4个辅助核算*/
            if check_i=4 then
              exit;
            end if;     
            end loop;
            CLOSE v_cursor;--关闭游标
          end;
    
          if acc_month_b='01' then
    
            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',c.subj_id,hs.subj_code,hs.subj_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os),hs.is_check 
            from acc_leder_check c
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
            left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
            where c.group_id=:group_id 
                  and hcr.rela_code in ('||rela_code||')  
                  and c.acc_year=:acc_year_b and c.acc_month=''00''
            '||subj_wheresql||'
            '||obj_wheresql||'
            '||source_wheresql||'
            group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check ' 
            using group_id,acc_year_b;
    
          else
    
            /*期初余额*/
            summary:='期初余额'; 
           -- dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check )
            select 1,''0000'',''00'',t1.subj_id,t1.subj_code,t1.subj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os),t1.is_check  from
            (
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(c.end_os) end_os,hs.is_check  
              from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where c.group_id=:group_id 
                  and hcr.rela_code in ('||rela_code||') 
                  and c.acc_year=:acc_year_b and c.acc_month=''00''
                  '||subj_wheresql||'
                  '||obj_wheresql||'
                  '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check 
              union all
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
              sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check 
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where v.group_id=:group_id 
                  and hcr.rela_code in ('||rela_code||') 
                  and v.state>=:state
                  and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
                  '||subj_wheresql||'
                  '||obj_wheresql||'
                  '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check 
             ) t1 group by t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check ' 
             using group_id,acc_year_b,
            group_id ,state,acc_year_b,acc_month_b;

          end if;
    
          /*本期发生凭证数据*/
          execute immediate 'insert into t_groupaccobjsubj_result(check_id,xh,acc_year,acc_month,vouch_date,vouch_no,obj_code,obj_name
          '||check_insertsql||'
          ,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check )
          select c.vouch_check_id,2,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no||''-''||v.vouch_id vouch_no,'||obj_show_field||'
          '||check_selectsql||'
          ,hs.subj_id,hs.subj_code,hs.subj_name,c.summary,c.debit,c.credit,hs.subj_dire,
          (case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check 
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id 
                and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
          '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:group_id 
                and hcr.rela_code in ('||rela_code||') 
                and v.state>=:state
                and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
                '||subj_wheresql||'
                '||obj_wheresql||'
                '||source_wheresql||'
          order by v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date
          ' using group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;
    
          /*本月合计数据*/
          ddl_sql:='insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check )
          select 3,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,''本月合计'',sum(r.debit),sum(r.credit),r.subj_dire,0 end_os,r.is_check 
          from t_groupaccobjsubj_result r
          where r.xh=2
          group by r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,r.subj_dire,r.is_check 
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
    
    
          /*计算本期发生凭证、本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            acc_month_y varchar2(2);
            subj_id numeric(18);
            xh integer;
            i number;
          begin
            i:=1;
            subj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.subj_id,r.subj_code,r.subj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccobjsubj_result r
              where r.xh<4
              order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.vouch_no asc,r.check_id asc) loop
    
              /*新的科目从0开始计算*/
              if subj_id<>cr.subj_id then
                end_os_sum:=0;
    
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then
                     
                     
                         if cr.acc_month = ''01'' then    
                 insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''上年结转'',0);
                else
                   insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''期初余额'',0);
                  end if;
                
                end if;
              end if;
    
               if subj_id=cr.subj_id and cr.xh=2 and xh!=1 then
                
    
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (acc_month_y!=cr.acc_month) then
                      insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.subj_id,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);
                end if;
              end if;
    
    
              end_os_sum:=end_os_sum+cr.end_os;
    
              /*本期发生凭证余额*/
              if cr.xh=2 then
                 update t_groupaccobjsubj_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
              end if;
              /*本月合计余额*/
              if cr.xh=3 then
                 update t_groupaccobjsubj_result set end_os=end_os_sum where xh=3 and subj_id=cr.subj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;
    
              i:=i+1;
              subj_id:=cr.subj_id;
              acc_month_y:=cr.acc_month;
              xh:=cr.xh;
            end loop;
          end;
          ';
    
          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check )
          select 4,t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,''本年累计'',
          t1.debit+nvl((select r1.debit from t_groupaccobjsubj_result r1 where r1.xh=1 and r1.debit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.credit+nvl((select r1.credit from t_groupaccobjsubj_result r1 where r1.xh=1 and r1.credit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.subj_dire,t1.end_os,t1.is_check  from
            (select 4,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,
            sum(r.debit) over(partition by r.acc_year,r.subj_id order by r.acc_month) debit,
            sum(r.credit) over(partition by r.acc_year,r.subj_id order by r.acc_month) credit,
            r.subj_dire,r.end_os,r.is_check 
            from t_groupaccobjsubj_result r
            where r.xh=3
           ) t1
    
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
    
          /*返回结果集游标*/
          ddl_sql:='select 
          case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
          case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
          to_char(t.vouch_date,''dd'') day,t.vouch_no,
          t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||'
          ,t.subj_code||'' ''||t.subj_name subj_name,t.summary,
          case when t.xh=1 then NULL else t.debit end debit,
          case when t.xh=1 then NULL else t.credit end credit,
          case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check 
          from t_groupaccobjsubj_result t
          '||happen_where||'
          order by t.subj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date asc,t.vouch_no asc,t.check_id asc
          ';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql ;--using acc_year_b,acc_month_b,acc_year_e,acc_month_e;
    
      END group_objsubjdetail_bm;
 
	
 
	]]></sql>
	
	<sql id="group_subjobjgeneralled_bm" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_subjobjgeneralled_bm

      /*集团---科目部门总账*/
      (
       group_id number,
       hos_id number,
       copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       is_happend integer,
       rela_code  varchar2, --- 用于多账套查询 
       objdata OUT ACT_BOOKS.subjobjgeneralcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_show_field varchar2(200);--要显示的动态字段
          obj_group_field varchar2(200);--要分组的动态字段
          obj_group_field1 varchar2(200);--要分组的动态字段
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          check_insertsql varchar2(500);--辅助核算添加动态字段
          check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
          check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
          subj_id varchar2(4000) ;
          num NUMBER;
          happen_where varchar2(4000);
      BEGIN
      
          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;
    
          obj_group_field1 := 'r1.obj_id,r1.obj_code,r1.obj_name';
          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.dept_id obj_id,hd.dept_code obj_code,hd.dept_name obj_name';
             obj_group_field := 'hd.dept_id,hd.dept_code,hd.dept_name';
          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.emp_id obj_id,hd.emp_code obj_code,hd.emp_name obj_name';
             obj_group_field := 'hd.emp_id,hd.emp_code,hd.emp_name';
          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.proj_id obj_id,hd.proj_code obj_code,hd.proj_name obj_name';
             obj_group_field := 'hd.proj_id,hd.proj_code,hd.proj_name';
          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.sup_id obj_id,hd.sup_code obj_code,hd.sup_name obj_name';
             obj_group_field := 'hd.sup_id,hd.sup_code,hd.sup_name';
          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.cus_id obj_id,hd.cus_code obj_code,hd.cus_name obj_name';
             obj_group_field := 'hd.cus_id,hd.cus_code,hd.cus_name';
          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.store_id obj_id,hd.store_code obj_code,hd.store_name obj_name';
             obj_group_field := 'hd.store_id,hd.store_code,hd.store_name';
          else
             table_name := '';
             obj_where_field := '';
          end if;
    
          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
               subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
                         and a.subj_code in('||subj_code||') ';   
               subj_wheresql:=' and hs.subj_id in('||subj_id||') '; 
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;
    
    
          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;
    
          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          
          if is_happend = 1 then
               happen_where:='where (exists(
                                    select 1 from t_groupaccsubjobjledger_result t1
                                    where t1.obj_id=t.obj_id 
                                          and TO_NUMBER(t1.acc_year||''''||t1.acc_month) 
                                          between TO_NUMBER('||acc_year_b||''||acc_month_b||') 
                                          and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                          ))';
             else
               happen_where:='';
          end if;
          /*条件处理end*/
    
          /*明细账需要拼辅助核算字段*/
          check_insertsql:='';
          check_selectsql:='';
          check_joinsql:='';
          --check_resultsql:='';
          declare
              check_i integer;
              dict_show_para integer;
              dict_show_sql varchar2(100);
              TYPE ref_type IS REF CURSOR;--定义游标指针
              v_cursor ref_type;--定义游标变量
              check_type_id numeric(18);
              check_table varchar2(50);
              is_sys integer;
              column_id varchar2(50);
              column_no varchar2(50);
              column_code varchar2(50);
              column_name varchar2(50);
              column_check varchar2(50);
              is_change integer;
          begin
            check_i:=0;
            --dbms_output.put_line(ddl_sql);
            OPEN v_cursor FOR '
                select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
                where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
                and exists(
                  select 1 from ACC_SUBJ hs
                  where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
                   '||subj_wheresql||'
                  --and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
                  and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
                ) and b.check_type_id<>3
                order by b.sort_code'
                using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
            LOOP
            FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中
    
              EXIT WHEN v_cursor%NOTFOUND;
              check_i:=check_i+1;
    
              --系统核算
              if is_sys=1 then
    
                  --有变更表需要取显示方式的参数
                  dict_show_sql:='';
                  if is_change=1 then
                      SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                      IF dict_show_para = 0 THEN
                           dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check1_no ';--显示历史数据
                      else
                           dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                      end if;
                     --要拼成的结果语句
                     --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                     --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
                  end if;
    
                  check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
                  check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check1_id '||dict_show_sql;
                  --要拼成的结果语句
                  --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
                  --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;
    
              --自定义核算
              elsif is_sys=0 then
                    check_selectsql:=check_selectsql||','||column_check;
                  --check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
                  --where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
                  --and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;
                 --要拼成的结果语句
                 /* ,(select check_item_code||' '||check_item_name from acc_check_item item
                  where exists(
                  select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
                  and item.check_item_id=avz.check_item_id and avz.check_type_id=29
                  )) check_name2*/
    
    
              end if;
              check_insertsql:=check_insertsql||',check'||check_i;
    
            /*只支持同时挂4个辅助核算*/
            if check_i=4 then
              exit;
            end if;
            end loop;
            CLOSE v_cursor;--关闭游标
          end;
    
          if acc_month_b='01' then
    
            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month'||check_insertsql||',
            obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'''||check_insertsql||','||obj_show_field||',''上年结转'',sum(c.sum_od),sum(c.sum_oc),0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) 
            ,hs.is_check
            from acc_leder_check c
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
             '||check_joinsql||'
            left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
            where c.group_id=:group_id 
                  and hcr.rela_code in ('||rela_code||') 
                  and c.acc_year=:acc_year_b and c.acc_month=''00''
                  '||subj_wheresql||'
                  '||obj_wheresql||'
                  '||source_wheresql||'
            group by '||obj_group_field||''||check_insertsql||',hs.is_check'
            using group_id,acc_year_b;
    
          else
            
            /*期初余额*/
            summary:='期初余额';
           
            execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month'||check_insertsql||',obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'''||check_insertsql||',t1.obj_id,t1.obj_code,t1.obj_name,''期初余额'',sum(t1.debit),sum(t1.credit),1,sum(t1.end_os),t1.is_check from
            (
              select '||obj_show_field||''||check_insertsql||',sum(c.sum_od) debit,sum(c.sum_oc) credit,0 subj_dire ,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) end_os 
              ,hs.is_check
              from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
               '||check_joinsql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where c.group_id=:group_id 
                    and hcr.rela_code in ('||rela_code||') 
                    and c.acc_year=:acc_year_b 
                    and c.acc_month=''00''
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by '||obj_group_field||''||check_insertsql||',hs.is_check
              union all
              select '||obj_show_field||''||check_insertsql||',sum(c.debit) debit,sum(c.credit) credit,0 subj_dire ,
              sum(c.debit-c.credit) end_os,hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
               '||check_joinsql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where v.group_id=:group_id 
                    and hcr.rela_code in ('||rela_code||') 
                    and v.state>=:state
                    and v.acc_year=:acc_year_b 
                    and v.acc_month<:acc_month_b
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by '||obj_group_field||''||check_insertsql||',hs.is_check
             ) t1 group by t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',t1.is_check'
             using group_id,acc_year_b,
            group_id,state,acc_year_b,acc_month_b;
    
          end if;
    
    --dbms_output.put_line(obj_show_field);
    
          /*本月合计数据*/
          execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month
          '||check_insertsql||'
          ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 2,v.acc_year,v.acc_month
          '||check_insertsql||'
          ,'||obj_show_field||',''本月合计'',sum(c.debit),sum(c.credit),0 subj_dire,
           sum(c.debit)-sum(c.credit)   end_os,hs.is_check      
          from acc_vouch_check c
          left join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id 
                and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
           '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:group_id 
                and hcr.rela_code in ('||rela_code||') 
                and v.state>=:state
                and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
                '||subj_wheresql||'
                '||obj_wheresql||'
                '||source_wheresql||'
          group by v.acc_year,v.acc_month,'||obj_group_field||' '||check_insertsql||',hs.is_check
          ' using group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;
    
          /*计算本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            obj_id numeric(18);
            xh integer;
            i number;
          begin
            i:=1;
            obj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.end_os,r.acc_year,r.acc_month,subj_dire from t_groupaccsubjobjledger_result r
              where r.xh<3
              order by r.obj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop
    
              /*新的项目从0开始计算*/
              if obj_id<>cr.obj_id then
                end_os_sum:=0;
                   
                   if (cr.xh=2 ) or (i=1 and cr.xh>1) then
                     if cr.acc_month = ''01'' then
                           insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''上年结转'',0);
               
                     else
                            insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''期初余额'',0);
               
                     end if;
                end if; 
              end if;
              
               if obj_id=cr.obj_id and cr.xh=2 and xh!=1 then
        
               insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_dire,''期初余额'',end_os_sum);
                
                end if;
    
              end_os_sum:=end_os_sum+cr.end_os;
    
              /*本月合计余额*/
              if cr.xh=2 then
                 update t_groupaccsubjobjledger_result set end_os=end_os_sum where xh=2 and obj_id=cr.obj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;
    
              i:=i+1;
              obj_id:=cr.obj_id;
              xh:=cr.xh;
            end loop;
          end;
          ';
    
          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name'||check_insertsql||',summary,debit,credit,subj_dire,end_os,is_check)
          select 3,t1.acc_year,t1.acc_month,t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',''本年累计'',
          t1.debit+nvl((select sum(r1.debit) from t_groupaccsubjobjledger_result r1 where r1.xh=1 and r1.debit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||''' ),0),
          t1.credit+nvl((select sum(r1.credit) from t_groupaccsubjobjledger_result r1 where r1.xh=1 and r1.credit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
          0 subj_dire,t1.end_os,t1.is_check from
            (select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name'||check_insertsql||',
            sum(r.debit) over(partition by r.acc_year,r.obj_id order by r.acc_month) debit,
            sum(r.credit) over(partition by r.acc_year,r.obj_id order by r.acc_month) credit,
            r.subj_dire,r.end_os,r.is_check
            from t_groupaccsubjobjledger_result r
            where r.xh=2
           ) t1
    
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
    
          /*返回结果集游标*/
          ddl_sql:='select 
          case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
          case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
          t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||'
          ,subj_code||'' ''||subj_name subj_name,t.summary,
          case when t.xh=1 then NULL else t.debit end debit,
          case when t.xh=1 then NULL else t.credit end credit,
          case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,
          t.xh,t.is_check
          from t_groupaccsubjobjledger_result t
         
          order by  obj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc
          ';
          --ddl_sql:='select * from t_groupaccsubjobjledger_result ';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql;
    
      END group_subjobjgeneralled_bm;
  
	
	]]></sql>
	
	<sql id="group_subjobjdetail_bm" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_subjobjdetail_bm
       /*==集团---科目部门明细账========-*/
    (  group_id number,
       hos_id number,
       copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       is_happend integer,--无发生不显示期初余额0,1
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       rela_code  varchar2, --- 用于多账套查询 
       objdata OUT ACT_BOOKS.subjobjcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_show_field varchar2(200);--要显示的动态字段
          obj_group_field varchar2(200);--要分组的动态字段
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          check_insertsql varchar2(500);--辅助核算添加动态字段
          check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
          check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
          subj_id varchar2(4000) ;
          num NUMBER;
          happen_where varchar2(4000);
      BEGIN 
          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;
    
    
          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.dept_id obj_id,hd.dept_code obj_code,hd.dept_name obj_name';
             obj_group_field := 'hd.dept_id,hd.dept_code,hd.dept_name';
          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.emp_id obj_id,hd.emp_code obj_code,hd.emp_name obj_name';
             obj_group_field := 'hd.emp_id,hd.emp_code,hd.emp_name';
          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.proj_id obj_id,hd.proj_code obj_code,hd.proj_name obj_name';
             obj_group_field := 'hd.proj_id,hd.proj_code,hd.proj_name';
          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.sup_id obj_id,hd.sup_code obj_code,hd.sup_name obj_name';
             obj_group_field := 'hd.sup_id,hd.sup_code,hd.sup_name';
          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.cus_id obj_id,hd.cus_code obj_code,hd.cus_name obj_name';
             obj_group_field := 'hd.cus_id,hd.cus_code,hd.cus_name';
          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.store_id obj_id,hd.store_code obj_code,hd.store_name obj_name';
             obj_group_field := 'hd.store_id,hd.store_code,hd.store_name';
          else
             table_name := '';
             obj_where_field := '';
          end if;
    
          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
            -- subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
            subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
                         and a.subj_code in('||subj_code||') ';   
           subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;
    
    
          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
             
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;
    
          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          
          if is_happend = 1 then  
                   happen_where:='where (exists(
                                        select 1 from t_groupaccsubjobj_result  t1
                                        where t1.obj_id=t.obj_id 
                                              and TO_NUMBER(t1.acc_year||''''||t1.acc_month) 
                                              between TO_NUMBER('||acc_year_b||''||acc_month_b||') 
                                              and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                              ))';
          else
                happen_where:='';
          end if;
          --happen_where
          
          /*条件处理end*/
    
          /*明细账需要拼辅助核算字段*/
          check_insertsql:='';
          check_selectsql:='';
          check_joinsql:='';
          --check_resultsql:='';
          declare
              check_i integer;
              dict_show_para integer;
              dict_show_sql varchar2(100);
              TYPE ref_type IS REF CURSOR;--定义游标指针
              v_cursor ref_type;--定义游标变量
              check_type_id numeric(18);
              check_table varchar2(50);
              is_sys integer;
              column_id varchar2(50);
              column_no varchar2(50);
              column_code varchar2(50);
              column_name varchar2(50);
              column_check varchar2(50);
              is_change integer;
          begin
            check_i:=0;
            --dbms_output.put_line(ddl_sql);
            OPEN v_cursor FOR '
                select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check 
                from ACC_CHECK_TYPE b
                where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
                and exists(
                  select 1 from ACC_SUBJ hs
                  where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code 
                        and hs.acc_year=:acc_year_b
                   '||subj_wheresql||' 
                    --and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
                  and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
                ) and b.check_table =''HOS_DEPT_DICT''
                order by b.sort_code'
                using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
            LOOP
            FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中
    
              EXIT WHEN v_cursor%NOTFOUND;
              check_i:=check_i+1;
    
              --系统核算
              if is_sys=1 then
    
                  --有变更表需要取显示方式的参数
                  dict_show_sql:='';
                  if is_change=1 then
                      SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                      IF dict_show_para = 0 THEN
                           dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check1_no ';--显示历史数据
                      else
                           dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                      end if;
                     --要拼成的结果语句
                     --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                     --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
                  end if;
    
                  check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
                  check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check1_id '||dict_show_sql;
                  --要拼成的结果语句
                  --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
                  --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;
    
              --自定义核算
              elsif is_sys=0 then
                    check_selectsql:=check_selectsql||','||column_check;
                  --check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
                  --where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
                  --and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;
                 --要拼成的结果语句
                 /* ,(select check_item_code||' '||check_item_name from acc_check_item item
                  where exists(
                  select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
                  and item.check_item_id=avz.check_item_id and avz.check_type_id=29
                  )) check_name2*/
    
    
              end if;
              check_insertsql:=check_insertsql||',check'||check_i;
    
            /*只支持同时挂4个辅助核算*/
            if check_i=4 then
              exit;
            end if;
            end loop;
            CLOSE v_cursor;--关闭游标
          end;
    
    
          if acc_month_b='01' then
    
            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
            select 1,''0000'',''00'','||obj_show_field||',''上年结转'',sum(c.sum_od),sum(c.sum_oc),0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) '||check_insertsql||',hs.is_check 
            from acc_leder_check c
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
            '||check_joinsql||'
            left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
            where c.group_id=:group_id 
                  and hcr.rela_code in ('||rela_code||') 
                  and c.acc_year=:acc_year_b 
                  and c.acc_month=''00''
                  '||subj_wheresql||'
                  '||obj_wheresql||'
                  '||source_wheresql||'
            group by '||obj_group_field||''||check_insertsql||',hs.is_check'
            using group_id,acc_year_b;
    
          else
    
            /*期初余额*/
            summary:='期初余额';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
            select 1,''0000'',''00'',t1.obj_id,t1.obj_code,t1.obj_name,''期初余额'',sum(t1.debit),sum(t1.credit),0,sum(t1.end_os)'||check_insertsql||',t1.is_check from
            (
              select '||obj_show_field||',sum(c.sum_od) debit,sum(c.sum_oc) credit,0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) end_os '||check_insertsql||' ,hs.is_check
              from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                      and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
              '||check_joinsql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where c.group_id=:group_id 
                    and hcr.rela_code in ('||rela_code||') 
                    and c.acc_year=:acc_year_b 
                    and c.acc_month=''00''
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by '||obj_group_field||''||check_insertsql||',hs.is_check
              union all
              select '||obj_show_field||',sum(c.debit) debit,sum(c.credit) credit,0,
              sum(c.debit-c.credit) end_os
              '||check_insertsql||',hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                      and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
                inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              '||check_joinsql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where v.group_id=:group_id 
                    and hcr.rela_code in ('||rela_code||') 
                    and v.state>=:state
                    and v.acc_year=:acc_year_b 
                    and v.acc_month<:acc_month_b
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by '||obj_group_field||''||check_insertsql||',hs.is_check
             ) t1 group by t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',t1.is_check'
             using group_id,acc_year_b,
            group_id,state,acc_year_b,acc_month_b;
          end if;
          
          /*本期发生凭证数据*/
          execute immediate 'insert into t_groupaccsubjobj_result(check_id,xh,acc_year,acc_month,vouch_date,vouch_no
          '||check_insertsql||'
          ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select c.vouch_check_id,2,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no||''-''||v.vouch_id vouch_no
          '||check_selectsql||'
          ,'||obj_show_field||',c.summary,c.debit,c.credit,0,
          ( c.debit-c.credit) end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                      and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
            inner join acc_vouch_type t on v.group_id=t.group_id 
                  and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
          '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:group_id 
                and hcr.rela_code in ('||rela_code||') 
                and v.state>=:state
                and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
                '||subj_wheresql||'
                '||obj_wheresql||'
                '||source_wheresql||'
          order by v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date
          ' using group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;
          
          /*本月合计数据*/
          ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本月合计'',sum(r.debit),sum(r.credit),0,0 end_os,r.is_check
          from t_groupaccsubjobj_result r
          where r.xh=2
          group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,r.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
           
          
          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 4,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本年累计''
          ,(select sum(t1.debit) from t_groupaccsubjobj_result t1 where t1.acc_month<=r.acc_month and t1.xh=2 and t1.debit<>0 and r.obj_id=t1.obj_id )
          ,(select sum(t1.credit) from t_groupaccsubjobj_result t1 where t1.acc_month<=r.acc_month AND t1.xh=2 and t1.credit<>0 and r.obj_id=t1.obj_id)
         
          ,0
          ,0 end_os
          ,r.is_check
          from t_groupaccsubjobj_result r
          where r.xh=3
           ';
          dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
           /*本年累计数据*/
          /*ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 4,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本年累计'',sum(r.debit),sum(r.credit),0,0 end_os,r.is_check
          from t_groupaccsubjobj_result r
          where r.xh=3
          group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,r.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;*/
          
          /*计算本期发生凭证、本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_credit numeric(19,2);
            end_os_debit numeric(19,2);
            end_os_month numeric(19,2);
            obj_id numeric(18);
             acc_month_y varchar2(2);
            xh integer;
            i number;
          begin
            i:=1;
            obj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.subj_code,r.subj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccsubjobj_result r
              where r.xh<4
              order by r.obj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.vouch_no asc,r.check_id asc) loop
    
              /*新的项目从0开始计算*/
              if obj_id<>cr.obj_id then
                end_os_sum:=0;
    
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then
                       if cr.acc_month = ''01'' then    
                insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,''上年结转'',0);
                
                else
                  insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,''期初余额'',0);
                
                 end if;
                end if;
              end if;
              
                if obj_id=cr.obj_id and cr.xh=2 and xh!=1 then
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (acc_month_y!=cr.acc_month) then
                    insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);
                 
               end if;
              end if;
    
              end_os_sum:=end_os_sum+cr.end_os;
    
              /*本期发生凭证余额*/
              if cr.xh=2 then
                 update t_groupaccsubjobj_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
              end if;
              
              /*本月合计余额*/
              if cr.xh=3 then
                 update t_groupaccsubjobj_result set end_os=end_os_sum 
                 where xh=3 and obj_id=cr.obj_id and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;
              
             if cr.xh=4 then
                 update t_groupaccsubjobj_result set end_os=end_os_sum 
                 where xh=4 and obj_id=cr.obj_id and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;
              
              i:=i+1;
              obj_id:=cr.obj_id;
              acc_month_y:=cr.acc_month;
              xh:=cr.xh;
            end loop;
          end;
          ';
    
          /*本年累计数据*/
        /*  ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os)
          select 4,t1.acc_year,t1.acc_month,t1.obj_id,t1.obj_code,t1.obj_name,''本年累计'',
          t1.debit+nvl((select r1.debit from t_groupaccsubjobj_result r1 where r1.xh=1 and r1.debit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.credit+nvl((select r1.credit from t_groupaccsubjobj_result r1 where r1.xh=1 and r1.credit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
          0,t1.end_os from
            (select distinct  4,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,r.subj_code,r.subj_name,
            sum(r.debit) over(partition by r.acc_year,r.obj_id order by r.acc_month) debit,
            sum(r.credit) over(partition by r.acc_year,r.obj_id order by r.acc_month) credit,
            r.subj_dire,r.end_os
            from t_groupaccsubjobj_result r
            where r.xh=3 and check1 is not null
           ) t1
          ';*/
         
         -- execute immediate ddl_sql;
    
          /*返回结果集游标*/
          ddl_sql:='select 
            case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
            case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
            to_char(t.vouch_date,''dd'') day,t.vouch_no,t.obj_id,
            t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||',
            t.subj_code||'' ''||t.subj_name subj_name,t.summary,
            case when t.xh=1 then NULL else t.debit end debit,
            case when t.xh=1 then NULL else t.credit end credit,
            case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
          from t_groupaccsubjobj_result t
          '||happen_where||'
          order by t.obj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date asc ,t.vouch_no asc,t.check_id asc
          ';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql ;--using acc_year_b,acc_month_b,acc_year_e,acc_month_e;
    
      END group_subjobjdetail_bm;
    
	
    
	]]></sql>
	<sql id="group_balancedetail_bm" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_balancedetail_bm
         /*集团---部门余额表*/
      (prm_group_id        number,
       prm_hos_id          number,
       prm_copy_code       varchar2,
       prm_acc_year_b      varchar2,
       prm_acc_month_b     varchar2,
       prm_acc_year_e      varchar2,
       prm_acc_month_e     varchar2,
       prm_is_state        integer, --包含未记账:1,99
       prm_is_end_os       integer, --显示有余额的项目:0,1
       prm_cur_code        varchar2, --币种
       prm_obj_select_flag integer, --项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_obj_code        varchar2, --项目条件多个值用逗号分隔。参数格式：1='，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       prm_subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       prm_rela_code  varchar2, --- 用于多账套查询 
       cur_objdata         OUT ACT_BOOKS.balancecursor)

       IS

        ddl_sql      varchar2(4000);
        obj_wheresql varchar2(4000);
        emp_wheresql varchar2(100);
        endOsWhere   varchar2(100);
        subj_wheresql varchar2(4000);
        subj_code_begin varchar2(200);--开始科目编码
        subj_code_end varchar2(200);--结束科目编码
        subj_id varchar2(4000) ;--通过科目编码返回的科目ID
        num NUMBER;

      BEGIN




        /*项目查询方式*/
        if prm_obj_select_flag = 2 then
          --2直接选择查询,
          obj_wheresql:=' and ( obj_code like ''%'||  prm_obj_code||'%'' or
                               obj_name like ''%'||prm_obj_code||'%'' or
                               spell_code like ''%'|| UPPER (prm_obj_code)||'%'' or
                               wbx_code like ''%'|| UPPER (prm_obj_code) ||'%''
                                   ) ';
         /* obj_wheresql := ' and obj_code like ''' || prm_obj_code || '%'' ';

        elsif prm_obj_select_flag = 3 then
          --3按范围查询,
          obj_wheresql := ' and obj_code between ' ||
                          regexp_substr(prm_obj_code, '[^,]+', 1, 1, 'i') ||
                          ' and ' ||
                          regexp_substr(prm_obj_code, '[^,]+', 1, 2, 'i') || ' ';
        elsif prm_obj_select_flag = 4 then
          --4弹出页面筛选查询
          obj_wheresql := ' and obj_code in(' || prm_obj_code || ') ';*/
        else
          --1查询全部
          obj_wheresql := '';
        end if;

           /*科目查询方式*/
          if prm_subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and subj_code like '''||prm_subj_code||'%'' ';
          elsif prm_subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(prm_subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(prm_subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif prm_subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||prm_group_id||' and a.hos_id  = '||prm_hos_id||' and a.copy_code= '''||prm_copy_code||'''
                         and a.subj_code in('||prm_subj_code||') ';
             subj_wheresql:=' and subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;


        /*是否显示余额项目*/
        if prm_is_end_os = 1 then
          --2直接选择查询,
          endOsWhere := ' and nvl(end_credit,0)-nvl(end_debit,0) !=0 ';
        else
          endOsWhere := '';
        end if;

        insert into t_groupbalancedetail_result_bm (
           idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit,
           is_check,subj_id,subj_code,spell_code,wbx_code
        )
      select 1 as idx,
          tempa1.check1_id,
          tempe1.dept_code,
          tempe1.dept_name,
          nvl(tempb1.nc_debit,0),   --年初余额 借
          nvl(tempb1.nc_credit,0),   --年初余额 贷
         case when tempa1.subj_dire=0 then nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)-nvl(tempc1.bfs_credit,0) else 0 end,  --期初余额 借
         case when tempa1.subj_dire=1 then nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)-nvl(tempc1.bfs_debit,0) else 0 end, --期初余额 贷
          nvl(tempd1.bq_debit,0),  --本期发生 借
          nvl(tempd1.bq_credit,0),   --本期发生 贷
          nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0),  --累计发生 借
          nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0),  --累计发生 贷
          nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0),  --期末余额 借
          nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0), --期末余额 贷
              tempb1.is_check,
              tempa1.subj_id,
              tempa1.subj_code,
        tempe1.spell_code,
        tempe1.wbx_code
       from (
            --有数据的科目
             select a.check1_id,a.check1_no,a.group_id,a.hos_id,a.copy_code,a.acc_year,a.subj_id,b.subj_code,b.subj_dire
            from acc_leder_check a
            left join  acc_subj  b  on a.group_id = b.group_id and a.hos_id = b.hos_id and a.copy_code = b.copy_code and a.subj_id = b.subj_id
           left join hos_copy_rela hcr on a.group_id = hcr.group_id and a.hos_id = hcr.hos_id and a.copy_code = hcr.copy_code
             where a.group_id=prm_group_id
                  and hcr.rela_code in (prm_rela_code)
                  and a.acc_year = prm_acc_year_b
                  and nvl(a.check1_id,0)!=0
                  and TO_NUMBER(a.acc_year||''||a.acc_month) between TO_NUMBER(prm_acc_year_b||'00') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
                  and nvl(a.end_os,0)!=0
            union
                 select a1.check1_id,a1.check1_no,a1.group_id,a1.hos_id,a1.copy_code,a1.acc_year,a1.subj_id,c1.subj_code,c1.subj_dire
                from acc_vouch_check a1
                  left join acc_vouch b1 on a1.group_id= b1.group_id and a1.hos_id=b1.hos_id and a1.copy_code=b1.copy_code
                      and a1.acc_year = b1.acc_year and a1.vouch_id=b1.vouch_id
                      left join acc_subj c1  on a1.group_id = c1.group_id and a1.hos_id = c1.hos_id and a1.copy_code = c1.copy_code and a1.subj_id = c1.subj_id
             left join hos_copy_rela hcr on a1.group_id = hcr.group_id and a1.hos_id = hcr.hos_id and a1.copy_code = hcr.copy_code
             where a1.group_id=prm_group_id and hcr.rela_code in (prm_rela_code)
                  and a1.acc_year = prm_acc_year_b
                  and b1.state>=prm_is_state
                  and nvl(a1.check1_id,0)!=0
                  and TO_NUMBER(b1.acc_year||''||b1.acc_month) between TO_NUMBER(prm_acc_year_b||'01') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
       ) tempa1  left join (
         --年初余额
         select a2.check1_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,a2.subj_id,
              sum(case when b2.subj_dire=0 then nvl(a2.end_os,0) else 0 end) nc_debit,
              sum(case when b2.subj_dire=1 then  nvl(a2.end_os,0) else 0 end) nc_credit,b2.is_check
        from acc_leder_check a2
        left join acc_subj b2 on a2.group_id =b2.group_id and a2.hos_id=b2.hos_id  and a2.copy_code=b2.copy_code
             and a2.acc_year = b2.acc_year  and a2.subj_id=b2.subj_id
        left join hos_copy_rela hcr on a2.group_id = hcr.group_id and a2.hos_id = hcr.hos_id and a2.copy_code = hcr.copy_code
        where a2.group_id=prm_group_id  and hcr.rela_code in (prm_rela_code)
              and a2.acc_year=prm_acc_year_b and a2.acc_month='00'
              and nvl(a2.check1_id,0)!=0
       group by a2.check1_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,b2.is_check,a2.subj_id
      ) tempb1 on tempa1.group_id =tempb1.group_id  and
      tempa1.hos_id =tempb1.hos_id   and tempa1.copy_code =tempb1.copy_code
      and tempa1.check1_id =tempb1.check1_id  and tempa1.subj_id =tempb1.subj_id
      left join(
           --年初到开始日间中间数据
           select a.check1_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id,
             sum(nvl(a.debit,0)) bfs_debit,
             sum(nvl(a.credit,0)) bfs_credit
          from  acc_vouch b
          left join  acc_vouch_check a on b.group_id = a.group_id and  b.hos_id = a.hos_id
               and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id
          left join hos_copy_rela hcr on b.group_id = hcr.group_id and b.hos_id = hcr.hos_id and b.copy_code = hcr.copy_code
          where a.group_id=prm_group_id and hcr.rela_code in (prm_rela_code)
                and b.acc_year = prm_acc_year_b
                and b.state>=prm_is_state
                and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||'01'
                and TO_NUMBER(b.acc_year||''||b.acc_month) < prm_acc_year_b||''||prm_acc_month_b
                and nvl(a.check1_id,0)!=0
           group by a.check1_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id
      ) tempc1 on tempa1.group_id =tempc1.group_id and tempa1.hos_id =tempc1.hos_id
        and tempa1.copy_code =tempc1.copy_code and tempa1.acc_year =tempc1.acc_year
        and tempa1.check1_id =tempc1.check1_id  and tempa1.subj_id =tempc1.subj_id
      left join (
          -- 本期发生数据
          select a.check1_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id,
                 sum(nvl(a.debit,0)) bq_debit,
                 sum(nvl(a.credit,0)) bq_credit
          from   acc_vouch b
          left join acc_vouch_check a  on b.group_id=a.group_id and b.hos_id=a.hos_id
                 and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id
          left join hos_copy_rela hcr on b.group_id = hcr.group_id and b.hos_id = hcr.hos_id and b.copy_code = hcr.copy_code
          where a.group_id=prm_group_id and hcr.rela_code in (prm_rela_code)
                  and a.acc_year =prm_acc_year_b  and b.state>=prm_is_state
                  and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||''||prm_acc_month_b
                  and TO_NUMBER(b.acc_year||''||b.acc_month) <= prm_acc_year_e||''||prm_acc_month_e
                  and nvl(a.check1_id,0)!=0
          group by a.check1_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id
      ) tempd1 on tempa1.group_id =tempd1.group_id and tempa1.hos_id =tempd1.hos_id
        and tempa1.copy_code =tempd1.copy_code and tempa1.acc_year =tempd1.acc_year
        and  tempa1.check1_id =tempd1.check1_id  and  tempa1.subj_id =tempd1.subj_id
      left join hos_dept_dict  tempe1 on  tempa1.group_id =tempe1.group_id and tempa1.hos_id = tempe1.hos_id
        and  tempa1.check1_id =tempe1.dept_id and  tempa1.check1_no =tempe1.dept_no ;

           execute immediate '
           insert into t_groupbalancedetail_resultsbm(
             idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,
             bq_credit,lj_debit , lj_credit ,end_debit ,end_credit ,is_check ,spell_code,wbx_code
           ) select  idx,obj_id ,obj_code ,obj_name ,sum(nc_debit) ,sum(nc_credit ),sum(qc_debit ),
           sum(qc_credit) ,sum(bq_debit ),sum(bq_credit),sum(lj_debit ), sum(lj_credit) ,sum(end_debit ),
           sum(end_credit),is_check  ,spell_code,wbx_code
                   from t_groupbalancedetail_result_bm
                   where idx =1  '||obj_wheresql||''||subj_wheresql||'
                   group by idx,obj_id ,obj_code ,obj_name ,is_check,spell_code,wbx_code
          ';

               --求总合计
              insert into t_groupbalancedetail_resultsbm(
                   idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit ,is_check
              )
              select 2 as idx,'' obj_id,'总合计' as obj_code,'' as obj_name,
                 sum(nvl(nc_debit,0)) as nc_debit,
                 sum(nvl(nc_credit,0)) as nc_credit,
                 sum(nvl(qc_debit,0)) as qc_debit,
                 sum(nvl(qc_credit,0)) as qc_credit,
                 sum(nvl(bq_debit,0)) as bq_debit,
                 sum(nvl(bq_credit,0)) as bq_credit,
                 sum(nvl(lj_debit,0)) as lj_debit,
                 sum(nvl(lj_credit,0)) as lj_credit,
                 sum(nvl(end_debit,0)) as end_debit,
                 sum(nvl(end_credit,0)) as end_credit,
                 '' as is_check
              from t_groupbalancedetail_resultsbm
              where idx = 1;

         ddl_sql := 'select
                  obj_code  ,obj_name ,
                  sum(nc_debit) nc_debit,sum(nc_credit) nc_credit,sum(qc_debit) qc_debit,sum(qc_credit) qc_credit,
                  sum(bq_debit) bq_debit,sum(bq_credit) bq_credit,sum(lj_debit) lj_debit,sum(lj_credit) lj_credit,
                  case when sum(end_debit-end_credit)>=0 then sum(end_debit-end_credit) else 0 end as end_debit ,
                  case when sum(end_credit-end_debit)>0 then  sum(end_credit-end_debit) else 0 end as end_credit
                   from  t_groupbalancedetail_resultsbm
        where     (nvl(nc_debit,0)!=0
                  or  nvl(nc_credit,0)!=0
                  or  nvl(qc_debit,0)!=0
                  or  nvl(qc_credit,0)!=0
                  or  nvl(bq_debit,0)!=0
                  or  nvl(bq_credit,0)!=0
                  or  nvl(lj_debit,0)!=0
                  or  nvl(lj_credit,0)!=0
                  or  nvl(end_debit,0)!=0
                  or  nvl(end_credit,0)!=0 )
                  '||endOsWhere||'
            group by  obj_code  ,obj_name
          order by obj_code';
          --dbms_output.put_line(ddl_sql);
        open cur_objdata for ddl_sql;

      END group_balancedetail_bm;
		
	
		
	]]></sql>
	
	<sql id="group_objsubjgeneralled_zg" type="proc"><![CDATA[
	CREATE OR REPLACE PROCEDURE group_objsubjgeneralled_zg
      /*集团-----职工科目总账*/
      (
       prm_group_id number,
       prm_hos_id number,
       prm_copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       rela_code varchar2,--集团化管理   用于账套查询
       objdata OUT ACT_BOOKS.objsubjgeneralcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
          subj_id varchar2(4000) ;
          num NUMBER;
      BEGIN

          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;


          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          else
             table_name := '';
             obj_where_field := '';
          end if;

          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||prm_subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(prm_subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(prm_subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';

             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||prm_group_id||' and a.hos_id  = '||prm_hos_id||' and a.copy_code= '''||prm_copy_code||'''
                         and a.subj_code in('||prm_subj_code||') ';

             subj_wheresql:=' and hs.subj_id in('||subj_id||') ';

          else
            --1查询全部
             subj_wheresql:='  and ((hs.check1= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
              and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
               and   act.check_type_id = hs.check1 and act.check_type_name=''职工'')) or
          (hs.check2= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check2 and act.check_type_name=''职工'')) or
          (hs.check3= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check3 and act.check_type_name=''职工'')) or
          (hs.check4= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check4 and act.check_type_name=''职工'' ))
                         )';
          end if;


          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;

          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          /*条件处理end*/


          if acc_month_b='01' then

            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',c.subj_id,hs.subj_code,hs.subj_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os),hs.is_check
            from acc_leder_check c
            inner join acc_subj hs on c.group_id =hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and hs.subj_id=c.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
            left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
            where c.group_id=:prm_group_id and hcr.rela_code in ('||rela_code||') 
                  and c.acc_year=:acc_year_b and c.acc_month=''00''
                  '||subj_wheresql||'
                  '||obj_wheresql||'
                  '||source_wheresql||'
            group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check'
            using prm_group_id,acc_year_b;

          else

            /*期初余额*/
            summary:='期初余额';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',t1.subj_id,t1.subj_code,t1.subj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os),t1.is_check from
            (
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(c.end_os) end_os ,hs.is_check from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where c.group_id=:prm_group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
              union all
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
                     sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where v.group_id=:prm_group_id and hcr.rela_code in ('||rela_code||')  and v.state>=:state
                    and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
             ) t1 group by t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check'
             using prm_group_id,acc_year_b,
            prm_group_id,state,acc_year_b,acc_month_b;

          end if;



          /*本月合计数据*/
          execute immediate 'insert into t_groupaccobjsubjledger_result
          (xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 2,v.acc_year,v.acc_month,hs.subj_id,hs.subj_code,hs.subj_name,''本月合计'',sum(c.debit),sum(c.credit),hs.subj_dire,
                 case when subj_dire=1 then sum(c.credit)-sum(c.debit) else sum(c.debit)-sum(c.credit) end   end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code
          inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:prm_group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
                and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
                '||subj_wheresql||'
                '||obj_wheresql||'
                '||source_wheresql||'
          group by v.acc_year,v.acc_month,hs.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,is_check
          ' using prm_group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;



          /*计算本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            subj_id numeric(18);
            xh integer;
            i number;
          begin
            i:=1;
            subj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.subj_id,r.subj_code,r.subj_name,r.end_os,r.acc_year,r.acc_month,subj_dire from t_groupaccobjsubjledger_result r
              where r.xh<3
              order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop

              /*新的科目从0开始计算*/
              if subj_id<>cr.subj_id then
                end_os_sum:=0;

              if (cr.xh=2 ) or (i=1 and cr.xh>1) then
                     if cr.acc_month = ''01'' then
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''上年结转'',0);

                     else
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''期初余额'',0);

                     end if;

                end if;

              end if;

               if subj_id=cr.subj_id and cr.xh=2 and xh!=1 then
                      --dbms_output.put_line(cr.subj_code);
                      --dbms_output.put_line(cr.acc_month);
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.subj_id,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);

              end if;

              end_os_sum:=end_os_sum+cr.end_os;

              /*本月合计余额*/
              if cr.xh=2 then
                 update t_groupaccobjsubjledger_result set end_os=end_os_sum where xh=2 and subj_id=cr.subj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;

              i:=i+1;
              subj_id:=cr.subj_id;
              xh:=cr.xh;
            end loop;
          end;
          ';

          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 3,t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,''本年累计'',
                 t1.debit+nvl((select r1.debit from t_groupaccobjsubjledger_result r1 where r1.xh=1 and r1.debit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
                 t1.credit+nvl((select r1.credit from t_groupaccobjsubjledger_result r1 where r1.xh=1 and r1.credit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
                 t1.subj_dire,t1.end_os ,t1.is_check
          from(
                 select 3,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,
                     sum(r.debit) over(partition by r.acc_year,r.subj_id order by r.acc_month) debit,
                     sum(r.credit) over(partition by r.acc_year,r.subj_id order by r.acc_month) credit,
                     r.subj_dire,r.end_os,r.is_check
                 from t_groupaccobjsubjledger_result r
                 where r.xh=2
           ) t1';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;

          select count(1) into num from acc_subj a5 where a5.group_id = prm_group_id
                    and a5.hos_id = prm_hos_id
                    and a5.copy_code = prm_copy_code
                    and a5.acc_year = acc_year_b
                    and a5.subj_code like ''||prm_subj_code||'%' ;

         if num>1 then

          --逐级汇总
          insert into t_groupaccobjsubjledger_result
                          (xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
                 select b.xh as xh,
                        a.acc_year,
                      '00' as acc_month,
                      a.subj_id,
                      a.subj_code,
                      a.subj_name,
                      b.summary,
                      sum(nvl(b.debit, 0)) as debit,
                      sum(nvl(b.credit, 0)) as credit,
                      b.subj_dire,
                      sum(nvl(b.end_os, 0)) as end_os,
                      b.is_check
                 from (select distinct a5.acc_year,
                          a5.subj_id,
                          a5.subj_code,
                          a5.subj_name,
                          a5.subj_level,
                          a5.is_check,
                          a5.is_last
                    from acc_subj a5
                    where a5.group_id = prm_group_id
                    and a5.hos_id = prm_hos_id
                    and a5.copy_code = prm_copy_code
                    and a5.acc_year = acc_year_b
                    and a5.is_last = 0
                    and a5.is_stop = 0
                    and a5.subj_code like ''||prm_subj_code||'%'
                    ) a
               right join t_groupaccobjsubjledger_result b
               on b.subj_code like (a.subj_code || '%')
               group by a.acc_year,
                        a.subj_id,
                        a.subj_code,
                        a.subj_name,
                        b.summary,
                        b.subj_dire,
                        b.is_check,
                        b.xh;
                    end if;
          ddl_sql:='select
                case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
                case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
                t.subj_code||'' ''||t.subj_name subj_name,
                t.summary,
                t.debit  debit,
                t.credit credit,
                case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,
                t.end_os
          from t_groupaccobjsubjledger_result t
          order by t.subj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql;

      END group_objsubjgeneralled_zg;
		
	
		
	]]></sql>
	
	<sql id="group_objsubjdetail_zg" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_objsubjdetail_zg
      /*集团----职工科目明细账*/
      (
       group_id number,
       hos_id number,
       copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       is_happend integer,--无发生不显示期初余额0,1
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       rela_code varchar2,--集团化管理   用于账套查询
       objdata OUT ACT_BOOKS.objsubjcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段 id
          obj_name_where_field varchar2(200);--查询所用的动态字段名称
          obj_spell_where_field varchar2(200);--查询所用的动态字段拼音码
          obj_wbx_where_field varchar2(200);--查询所用的动态字段五笔码
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_show_field varchar2(200);--要显示的动态字段
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          check_insertsql varchar2(500);--辅助核算添加动态字段
          check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
          check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
            --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
          subj_id varchar2(4000) ;
          num NUMBER;
          happen_where varchar2(4000);
      BEGIN

          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;


          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_name_where_field := 'dept_name';
             obj_spell_where_field := 'spell_code';
             obj_wbx_where_field := 'wbx_code';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.dept_code obj_code,hd.dept_name obj_name';

          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_name_where_field := 'emp_name';
             obj_spell_where_field := 'spell_code';
             obj_wbx_where_field := 'wbx_code';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.emp_code obj_code,hd.emp_name obj_name';

          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_name_where_field := 'proj_name';
             obj_spell_where_field := 'spell_code';
             obj_wbx_where_field := 'wbx_code';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.proj_code obj_code,hd.proj_name obj_name';

          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_name_where_field := 'sup_name';
             obj_spell_where_field := 'spell_code';
             obj_wbx_where_field := 'wbx_code';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.sup_code obj_code,hd.sup_name obj_name';

          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_name_where_field := 'cus_name';
             obj_spell_where_field := 'spell_code';
             obj_wbx_where_field := 'wbx_code';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.cus_code obj_code,hd.cus_name obj_name';

          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_name_where_field := 'store_name';
             obj_spell_where_field := 'spell_code';
             obj_wbx_where_field := 'wbx_code';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.store_code obj_code,hd.store_name obj_name';

          else
             table_name := '';
             obj_where_field := '';
          end if;

          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
            -- subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||'''
                         and a.subj_code in('||subj_code||') ';

             subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;


          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
               obj_wheresql:=' and (hd.'||obj_code_where_field||' like ''%'||  obj_code||'%'' or
                                   hd.'||obj_name_where_field||' like ''%'||obj_code||'%'' or
                                   hd.'||obj_spell_where_field||'   like ''%'|| UPPER (obj_code)||'%'' or
                                   hd.'||obj_wbx_where_field||'  like ''%'|| UPPER (obj_code) ||'%''
                                   ) ';

          else
            --1查询全部
             obj_wheresql:=' ';
          end if;

          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;

          if is_happend = 1 then
               happen_where:='where (exists(
                                    select 1 from t_groupaccobjsubj_result t1
                                    where t1.subj_id=t.subj_id
                                          and TO_NUMBER(t1.acc_year||''''||t1.acc_month)
                                          between TO_NUMBER('||acc_year_b||''||acc_month_b||')
                                          and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                          ))';
             else
               happen_where:='';
          end if;
          /*条件处理end*/

          /*明细账需要拼辅助核算字段*/
          check_insertsql:='';
          check_selectsql:='';
          check_joinsql:='';
          --check_resultsql:='';
          declare
              check_i integer;
              dict_show_para integer;
              dict_show_sql varchar2(100);
              TYPE ref_type IS REF CURSOR;--定义游标指针
              v_cursor ref_type;--定义游标变量
              check_type_id numeric(18);
              check_table varchar2(50);
              is_sys integer;
              column_id varchar2(50);
              column_no varchar2(50);
              column_code varchar2(50);
              column_name varchar2(50);
              column_check varchar2(50);
              is_change integer;
          begin
            check_i:=0;
            --dbms_output.put_line(ddl_sql);
            OPEN v_cursor FOR '
                select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
                where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
                and exists(
                  select 1 from ACC_SUBJ hs
                  where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
                   '||subj_wheresql||'
                  --and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
                  and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
                ) and b.check_type_id<>3
                order by b.sort_code'
                using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
            LOOP
            FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中

              EXIT WHEN v_cursor%NOTFOUND;
              check_i:=check_i+1;

              --系统核算
              if is_sys=1 then

                  --有变更表需要取显示方式的参数
                  dict_show_sql:='';
                  if is_change=1 then
                      SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                      IF dict_show_para = 0 THEN
                           dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check2_no ';--显示历史数据
                      else
                           dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                      end if;
                     --要拼成的结果语句
                     --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                     --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
                  end if;

                  check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
                  check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check2_id '||dict_show_sql;
                  --要拼成的结果语句
                  --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
                  --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;

              --自定义核算
              elsif is_sys=0 then
                    check_selectsql:=check_selectsql||','||column_check;
                  /*check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
                  where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
                  and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;  */
                 --要拼成的结果语句
                 /* ,(select check_item_code||' '||check_item_name from acc_check_item item
                  where exists(
                  select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
                  and item.check_item_id=avz.check_item_id and avz.check_type_id=29
                  )) check_name2*/


              end if;
              check_insertsql:=check_insertsql||',check'||check_i;

            /*只支持同时挂4个辅助核算*/
            if check_i=4 then
              exit;
            end if;
            end loop;
            CLOSE v_cursor;--关闭游标
          end;

          if acc_month_b='01' then

            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',c.subj_id,hs.subj_code,hs.subj_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os) ,hs.is_check
            from acc_leder_check c
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
            left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
            where c.group_id=:group_id and  hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
            '||subj_wheresql||'
            '||obj_wheresql||'
            '||source_wheresql||'
            group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check'
            using group_id,acc_year_b;

          else

            /*期初余额*/
            summary:='期初余额';
         -- dbms_output.put_line('');
            execute immediate 'insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check
            ,obj_code,obj_name)
            select 1,''0000'',''00'',t1.subj_id,t1.subj_code,t1.subj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os),t1.is_check
              ,t1.obj_code,t1.obj_name
            from
            (
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(c.end_os) end_os ,hs.is_check
               ,hd.'||obj_code_where_field||' as obj_code,hd.'||obj_name_where_field|| ' as obj_name
              from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where c.group_id=:group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
               ,hd.'||obj_code_where_field||',hd.'||obj_name_where_field||'
              union all
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
              sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
                ,hd.'||obj_code_where_field||' as obj_code,hd.'||obj_name_where_field||'
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
              and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
               ,hd.'||obj_code_where_field||',hd.'||obj_name_where_field||'
             ) t1 group by t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check,t1.obj_code,t1.obj_name'
             using group_id,acc_year_b,
            group_id,state,acc_year_b,acc_month_b;

          end if;

          /*本期发生凭证数据*/
          execute immediate 'insert into t_groupaccobjsubj_result(check_id,xh,acc_year,acc_month,vouch_date,vouch_no,obj_code,obj_name
          '||check_insertsql||'
          ,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select c.vouch_check_id,2,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no||''-''||v.vouch_id vouch_no,'||obj_show_field||'
          '||check_selectsql||'
          ,hs.subj_id,hs.subj_code,hs.subj_name,c.summary,c.debit,c.credit,hs.subj_dire,
          (case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id
                and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
          and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          order by v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date,hs.is_check
          ' using group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;

          /*本月合计数据*/
          ddl_sql:='insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 3,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,''本月合计'',sum(r.debit),sum(r.credit),r.subj_dire,0 end_os,r.is_check
          from t_groupaccobjsubj_result r
          where r.xh=2
          group by r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,r.subj_dire,r.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;


          /*计算本期发生凭证、本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            subj_id numeric(18);
            acc_month_y varchar2(2);
            xh integer;
            i number;
          begin
            i:=1;
            subj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.subj_id,r.subj_code,r.subj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccobjsubj_result r
              where r.xh<4
              order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.vouch_no asc,r.check_id asc) loop

              /*新的科目从0开始计算*/
              if subj_id<>cr.subj_id then
                end_os_sum:=0;

                /*有发生数据没有期初余额新增加一条期初余额*/
                if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then


                 if cr.acc_month = ''01'' then
                 insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''上年结转'',0);
                else
                   insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''期初余额'',0);
                  end if;

                end if;
              end if;

               if subj_id=cr.subj_id and cr.xh=2 and xh!=1 then

                if (acc_month_y!=cr.acc_month) then
                      insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.subj_id,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);
                end if;
              end if;

              end_os_sum:=end_os_sum+cr.end_os;

              /*本期发生凭证余额*/
              if cr.xh=2 then
                 update t_groupaccobjsubj_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
              end if;
              /*本月合计余额*/
              if cr.xh=3 then
                 update t_groupaccobjsubj_result set end_os=end_os_sum where xh=3 and subj_id=cr.subj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;

              i:=i+1;
              subj_id:=cr.subj_id;
              acc_month_y:=cr.acc_month;
              xh:=cr.xh;
            end loop;
          end;
          ';

          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 4,t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,''本年累计'',
          t1.debit+nvl((select r1.debit from t_groupaccobjsubj_result r1 where r1.xh=1 and r1.debit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.credit+nvl((select r1.credit from t_groupaccobjsubj_result r1 where r1.xh=1 and r1.credit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.subj_dire,t1.end_os ,t1.is_check from
            (select 4,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,
            sum(r.debit) over(partition by r.acc_year,r.subj_id order by r.acc_month) debit,
            sum(r.credit) over(partition by r.acc_year,r.subj_id order by r.acc_month) credit,
            r.subj_dire,r.end_os,r.is_check
            from t_groupaccobjsubj_result r
            where r.xh=3
           ) t1

          ';
          --dbms_output.put_line(ddl_sql);
       --   execute immediate ddl_sql;

          /*返回结果集游标*/
          ddl_sql:='select
          case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
          case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
          to_char(t.vouch_date,''dd'') day,t.vouch_no,
          t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||'
          ,t.subj_code||'' ''||t.subj_name subj_name,t.summary,
          case when t.xh=1 then NULL else t.debit end debit,
          case when t.xh=1 then NULL else t.credit end credit,
          case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
          from t_groupaccobjsubj_result t
          '||happen_where||'
          order by t.subj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date asc,t.vouch_no asc,t.check_id asc ,t.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql ;--using acc_year_b,acc_month_b,acc_year_e,acc_month_e;

      END group_objsubjdetail_zg;
		
	
		
	]]></sql>
	
	<sql id="group_subjobjgeneralled_zg" type="proc"><![CDATA[
	CREATE OR REPLACE PROCEDURE group_subjobjgeneralled_zg
		/*集团---科目职工总账*/
  (
   group_id number,
   hos_id number,
   copy_code varchar2,
   acc_year_b varchar2,
   acc_month_b varchar2,
   acc_year_e varchar2,
   acc_month_e varchar2,
   state integer,--包含未记账:1,99
   subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
   obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
   source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
   table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
   is_happend integer,
   rela_code varchar2,--集团化管理   用于账套查询
   objdata OUT ACT_BOOKS.subjobjgeneralcursor
   )
  IS
      ddl_sql varchar2(4000);
      obj_sql varchar2(200);
      table_name varchar2(200);--动态表名称
      obj_code_where_field varchar2(200);--查询所用的动态字段名称
      obj_id_where_field varchar2(200);--查询所用的动态字段名称
      obj_history_where_field varchar2(200);--历史记录动态条件
      obj_show_field varchar2(200);--要显示的动态字段
      obj_group_field varchar2(200);--要分组的动态字段
      obj_group_field1 varchar2(200);--要分组的动态字段
      obj_where_field varchar2(200);--id关联动态条件
      subj_code_begin varchar2(200);--开始科目编码
      subj_code_end varchar2(200);--结束科目编码
      obj_code_begin varchar2(200);--开始项目编码
      obj_code_end varchar2(200);--结束项目编码
      check_insertsql varchar2(500);--辅助核算添加动态字段
      check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
      check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
      --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
      source_wheresql varchar2(200);
      subj_wheresql varchar2(4000);
      obj_wheresql varchar2(4000);
      summary varchar2(20);
      subj_id varchar2(4000) ;
      num NUMBER;
      happen_where varchar2(4000);
  BEGIN

      /*结果集临时表*/
      --EXECUTE IMMEDIATE 'drop Table t_groupaccsubjobjledger_result';
      SELECT COUNT(1) INTO num FROM USER_TABLES WHERE TABLE_NAME = UPPER('t_groupaccsubjobjledger_result') ;
      IF num = 0 THEN
           ddl_sql:='Create Global Temporary Table t_groupaccsubjobjledger_result(
            xh integer,
            acc_year varchar2(20),
            acc_month varchar2(2),
            obj_id numeric(18,0),
            obj_code varchar2(50),
            obj_name varchar2(200),
            subj_code varchar2(200),
            subj_name varchar2(200),
            check1 varchar2(200),--核算1
            check2 varchar2(200),--核算2
            check3 varchar2(200),--核算3
            check4 varchar2(200),--核算4
            summary varchar2(200),
            debit numeric(19,2),
            credit numeric(19,2),
            subj_dire integer,
            end_os numeric(19,2),
               is_check numeric(2)
            )On COMMIT Delete ROWS';
            /*
            On COMMIT PRESERVE ROWS 会话性临时表
            On Commit Delete Rows 事务性临时表
            */
            execute immediate ddl_sql;
      END IF;

      /*条件处理begin*/
      if source_id='0' then
           source_wheresql:='';--资源来源ID
      else
           source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
      end if;

      obj_group_field1 := 'r1.obj_id,r1.obj_code,r1.obj_name';
      if table_flag  = 1 then
         table_name := 'hos_dept_dict';
         obj_code_where_field := 'dept_code';
         obj_id_where_field := 'dept_id';
         obj_history_where_field := 'c.check1_no=hd.dept_no';
         obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.dept_id obj_id,hd.dept_code obj_code,hd.dept_name obj_name';
         obj_group_field := 'hd.dept_id,hd.dept_code,hd.dept_name';
      elsif table_flag = 2 then
         table_name := 'hos_emp_dict';
         obj_code_where_field := 'emp_code';
         obj_id_where_field := 'emp_id';
         obj_history_where_field := 'c.check2_no=hd.emp_no';
         obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.emp_id obj_id,hd.emp_code obj_code,hd.emp_name obj_name';
         obj_group_field := 'hd.emp_id,hd.emp_code,hd.emp_name';
      elsif table_flag = 3 then
         table_name := 'hos_proj_dict';
         obj_code_where_field := 'proj_code';
         obj_id_where_field := 'proj_id';
         obj_history_where_field := 'c.check3_no=hd.proj_no';
         obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.proj_id obj_id,hd.proj_code obj_code,hd.proj_name obj_name';
         obj_group_field := 'hd.proj_id,hd.proj_code,hd.proj_name';
      elsif table_flag = 6 then
         table_name := 'hos_sup_dict';
         obj_code_where_field := 'sup_code';
         obj_id_where_field := 'sup_id';
         obj_history_where_field := 'c.check6_no=hd.sup_no';
         obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.sup_id obj_id,hd.sup_code obj_code,hd.sup_name obj_name';
         obj_group_field := 'hd.sup_id,hd.sup_code,hd.sup_name';
      elsif table_flag = 5 then
         table_name := 'hos_cus_dict';
         obj_code_where_field := 'cus_code';
         obj_id_where_field := 'cus_id';
         obj_history_where_field := 'c.check5_no=hd.cus_no';
         obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.cus_id obj_id,hd.cus_code obj_code,hd.cus_name obj_name';
         obj_group_field := 'hd.cus_id,hd.cus_code,hd.cus_name';
      elsif table_flag = 4 then
         table_name := 'hos_store_dict';
         obj_code_where_field := 'store_code';
         obj_id_where_field := 'store_id';
         obj_history_where_field := 'c.check4_no=hd.store_no';
         obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.store_id obj_id,hd.store_code obj_code,hd.store_name obj_name';
         obj_group_field := 'hd.store_id,hd.store_code,hd.store_name';
      else
         table_name := '';
         obj_where_field := '';
      end if;

      /*科目查询方式*/
      if subj_select_flag=2 then
          --2直接选择查询,
          subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
      elsif subj_select_flag=3 then
          --3按范围查询,
          subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
          subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
          subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
      elsif subj_select_flag=4 then
         --4弹出页面筛选查询
         --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
         subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
          and a.subj_code in('||subj_code||') ';  
              
     subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
      else
        --1查询全部
         subj_wheresql:=' ';
      end if;


      /*项目查询方式*/
      if obj_select_flag=2 then
          --2直接选择查询,
          obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
      elsif obj_select_flag=3 then
          --3按范围查询,
          obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
          obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
          obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
      elsif obj_select_flag=4 then
         --4弹出页面筛选查询
         obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
         
      else
        --1查询全部
         obj_wheresql:=' ';
      end if;

      --项目显示方式:0历史数据，1最新数据
      SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
      IF num = 0 THEN
           obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
      else
           obj_sql:=' and hd.is_stop=0 ';--显示最新数据
      end if;
      
      if is_happend = 1 then
           happen_where:='where (exists(
                                select 1 from t_groupaccsubjobjledger_result t1
                                where t1.subj_code=t.subj_code 
                                      and TO_NUMBER(t1.acc_year||''''||t1.acc_month) 
                                      between TO_NUMBER('||acc_year_b||''||acc_month_b||') 
                                      and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                      ))';
         else
           happen_where:='';
      end if;
      /*条件处理end*/

      /*明细账需要拼辅助核算字段*/
      check_insertsql:='';
      check_selectsql:='';
      check_joinsql:='';
      --check_resultsql:='';
      declare
          check_i integer;
          dict_show_para integer;
          dict_show_sql varchar2(100);
          TYPE ref_type IS REF CURSOR;--定义游标指针
          v_cursor ref_type;--定义游标变量
          check_type_id numeric(18);
          check_table varchar2(50);
          is_sys integer;
          column_id varchar2(50);
          column_no varchar2(50);
          column_code varchar2(50);
          column_name varchar2(50);
          column_check varchar2(50);
          is_change integer;
      begin
        check_i:=0;
        --dbms_output.put_line(ddl_sql);
        OPEN v_cursor FOR '
            select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
            where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
            and exists(
              select 1 from ACC_SUBJ hs
              where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
               '||subj_wheresql||'
              and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
              and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
            ) and b.check_type_id<>3
            order by b.sort_code'
            using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
        LOOP
        FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中

          EXIT WHEN v_cursor%NOTFOUND;
          check_i:=check_i+1;

          --系统核算
          if is_sys=1 then

              --有变更表需要取显示方式的参数
              dict_show_sql:='';
              if is_change=1 then
                  SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                  IF dict_show_para = 0 THEN
                       dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check'||check_type_id||'_no ';--显示历史数据
                  else
                       dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                  end if;
                 --要拼成的结果语句
                 --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                 --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
              end if;

              check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
              check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check'||check_type_id||'_id '||dict_show_sql;
              --要拼成的结果语句
              --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
              --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;

          --自定义核算
          elsif is_sys=0 then
                check_selectsql:=check_selectsql||','||column_check;
              --check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
              --where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
              --and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;
             --要拼成的结果语句
             /* ,(select check_item_code||' '||check_item_name from acc_check_item item
              where exists(
              select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
              and item.check_item_id=avz.check_item_id and avz.check_type_id=29
              )) check_name2*/


          end if;
          check_insertsql:=check_insertsql||',check'||check_i;

        /*只支持同时挂4个辅助核算*/
        if check_i=4 then
          exit;
        end if;
        end loop;
        CLOSE v_cursor;--关闭游标
      end;

      if acc_month_b='01' then

        /*年初余额*/
        summary:='上年结转';
        --dbms_output.put_line(ddl_sql);
        execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month'||check_insertsql||',
        obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select 1,''0000'',''00'''||check_insertsql||','||obj_show_field||',''上年结转'',sum(c.sum_od),sum(c.sum_oc),0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end),hs.is_check 
        from acc_leder_check c
        inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
        inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
        left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code 
        where c.group_id=:group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
        '||subj_wheresql||'
        '||obj_wheresql||'
        '||source_wheresql||'
        group by '||obj_group_field||''||check_insertsql||',hs.is_check'
        using group_id,acc_year_b;

      else

        /*期初余额*/
        summary:='期初余额';
      
         
        execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month'||check_insertsql||',obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select 1,''0000'',''00'''||check_insertsql||',t1.obj_id,t1.obj_code,t1.obj_name,''期初余额'',sum(t1.debit),sum(t1.credit),0,sum(t1.end_os),t1.is_check  from
        (
          select '||obj_show_field||''||check_insertsql||',sum(c.sum_od) debit,sum(c.sum_oc) credit,0 subj_dire,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) end_os ,hs.is_check
          from acc_leder_check c
          inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where c.group_id=:group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          group by '||obj_group_field||''||check_insertsql||',hs.is_check
          union all
          select '||obj_show_field||''||check_insertsql||',sum(c.debit) debit,sum(c.credit) credit,0 subj_dire,
          sum(c.debit-c.credit) end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
          and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          group by '||obj_group_field||''||check_insertsql||',hs.is_check
         ) t1 group by t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',t1.is_check'
         using group_id,acc_year_b,
        group_id,state,acc_year_b,acc_month_b;

      end if;
  
      /*本月合计数据*/
      execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month
      '||check_insertsql||'
      ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
      select 2,v.acc_year,v.acc_month
      '||check_insertsql||'
      ,'||obj_show_field||',''本月合计'',sum(c.debit),sum(c.credit),0 subj_dire,
       sum(c.debit)-sum(c.credit)   end_os,hs.is_check
      from acc_vouch_check c
      left join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
      inner join acc_vouch_type t on v.group_id=t.group_id 
            and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
      inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
      inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
      left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
      where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
      and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
      '||subj_wheresql||'
      '||obj_wheresql||'
      '||source_wheresql||'
      group by v.acc_year,v.acc_month,'||obj_group_field||' '||check_insertsql||',hs.is_check
      ' using group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;




      /*计算本月合计余额*/
      --dbms_output.put_line(ddl_sql);
      execute immediate '
      declare
        end_os_sum numeric(19,2);
        end_os_month numeric(19,2);
        obj_id numeric(18);
        xh integer;
        i number;
      begin
        i:=1;
        obj_id:=0;
        end_os_month:=0;
        for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccsubjobjledger_result r
          where r.xh<3
          order by r.obj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop

          /*新的项目从0开始计算*/
          if obj_id<>cr.obj_id then
            end_os_sum:=0;
            
            if (cr.xh=2 ) or (i=1 and cr.xh>1) then
                 
                 
                 if cr.acc_month = ''01'' then
                       insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''上年结转'',0);
           
                 else
                   
                        insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''期初余额'',0);
           
                 end if;
            
            end if; 
          end if;

         if obj_id=cr.obj_id and cr.xh=2 and xh!=1 then
    
           insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_dire,summary,end_os)
                  values( 1,cr.acc_year,cr.acc_month,cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_dire,''期初余额'',end_os_sum);
            
            end if;

          end_os_sum:=end_os_sum+cr.end_os;

          /*本月合计余额*/
          if cr.xh=2 then
             update t_groupaccsubjobjledger_result set end_os=end_os_sum where xh=2 and obj_id=cr.obj_id
             and acc_year = cr.acc_year and acc_month=cr.acc_month;
          end if;

          i:=i+1;
          obj_id:=cr.obj_id;
          xh:=cr.xh;
        end loop;
      end;
      ';

      /*本年累计数据*/
      ddl_sql:='insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name'||check_insertsql||',summary,debit,credit,subj_dire,end_os,is_check)
      select 3,t1.acc_year,t1.acc_month,t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',''本年累计'',
      t1.debit+nvl((select sum(r1.debit) from t_groupaccsubjobjledger_result r1 where r1.xh=1 and r1.debit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||''' ),0),
      t1.credit+nvl((select sum(r1.credit) from t_groupaccsubjobjledger_result r1 where r1.xh=1 and r1.credit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
      0 subj_dire,t1.end_os ,t1.is_check from
        (select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name'||check_insertsql||',
        sum(r.debit) over(partition by r.acc_year,r.obj_id order by r.acc_month) debit,
        sum(r.credit) over(partition by r.acc_year,r.obj_id order by r.acc_month) credit,
        r.subj_dire,r.end_os,r.is_check
        from t_groupaccsubjobjledger_result r
        where r.xh=2
       ) t1

      ';
      --dbms_output.put_line(ddl_sql);
      execute immediate ddl_sql;

      /*返回结果集游标*/
      ddl_sql:='select 
          case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
          case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
          t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||'
          ,t.summary,
          case when t.xh=1 then NULL else t.debit end debit,
          case when t.xh=1 then NULL else t.credit end credit,
          case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,
          t.xh,t.is_check
      from t_groupaccsubjobjledger_result t
      
      order by  obj_code asc,t.acc_year asc,t.acc_month asc,obj_name asc,t.xh asc,t.is_check
      ';
      --dbms_output.put_line(ddl_sql);
      open objdata for ddl_sql;

  END group_subjobjgeneralled_zg;
  
	
  
	]]></sql>
	
	<sql id="group_subjobjdetail_zg" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_subjobjdetail_zg
       /*集团--科目职工明细账*/
       (
         group_id number,
         hos_id number,
         copy_code varchar2,
         acc_year_b varchar2,
         acc_month_b varchar2,
         acc_year_e varchar2,
         acc_month_e varchar2,
         state integer,--包含未记账:1,99
         is_happend integer,--无发生不显示期初余额0,1
         subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
         subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
         obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
         obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
         source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
         table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
         rela_code varchar2,--集团化管理   用于账套查询
         objdata OUT ACT_BOOKS.subjobjcursor
         )
        IS
            ddl_sql varchar2(4000);
            obj_sql varchar2(200);
            table_name varchar2(200);--动态表名称
            obj_code_where_field varchar2(200);--查询所用的动态字段名称
            obj_id_where_field varchar2(200);--查询所用的动态字段名称
            obj_name_where_field varchar2(200);--查询所用的动态字段名称
            obj_spell_where_field varchar2(200);--查询所用的动态字段拼音码
            obj_wbx_where_field varchar2(200);--查询所用的动态字段五笔码
            obj_history_where_field varchar2(200);--历史记录动态条件
            obj_show_field varchar2(200);--要显示的动态字段
            obj_group_field varchar2(200);--要分组的动态字段
            obj_where_field varchar2(200);--id关联动态条件
            subj_code_begin varchar2(200);--开始科目编码
            subj_code_end varchar2(200);--结束科目编码
            obj_code_begin varchar2(200);--开始项目编码
            obj_code_end varchar2(200);--结束项目编码
            check_insertsql varchar2(500);--辅助核算添加动态字段
            check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
            check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
            --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
            source_wheresql varchar2(200);
            subj_wheresql varchar2(4000);
            obj_wheresql varchar2(4000);
            summary varchar2(20);
            subj_id varchar2(4000) ;
            num NUMBER;
            happen_where varchar2(4000);
        BEGIN

            /*条件处理begin*/
            if source_id='0' then
                 source_wheresql:='';--资源来源ID
            else
                 source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
            end if;


            if table_flag  = 1 then
               table_name := 'hos_dept_dict';
               obj_code_where_field := 'dept_code';
               obj_id_where_field := 'dept_id';
               obj_name_where_field := 'dept_name';
               obj_spell_where_field := 'spell_code';
               obj_wbx_where_field := 'wbx_code';
               obj_history_where_field := 'c.check1_no=hd.dept_no';
               obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
               obj_show_field := 'hd.dept_id obj_id,hd.dept_code obj_code,hd.dept_name obj_name';
               obj_group_field := 'hd.dept_id,hd.dept_code,hd.dept_name';
            elsif table_flag = 2 then
               table_name := 'hos_emp_dict';
               obj_code_where_field := 'emp_code';
               obj_id_where_field := 'emp_id';
               obj_name_where_field := 'emp_name';
               obj_spell_where_field := 'spell_code';
               obj_wbx_where_field := 'wbx_code';
               obj_history_where_field := 'c.check2_no=hd.emp_no';
               obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
               obj_show_field := 'hd.emp_id obj_id,hd.emp_code obj_code,hd.emp_name obj_name';
               obj_group_field := 'hd.emp_id,hd.emp_code,hd.emp_name';
            elsif table_flag = 3 then
               table_name := 'hos_proj_dict';
               obj_code_where_field := 'proj_code';
               obj_id_where_field := 'proj_id';
               obj_name_where_field := 'proj_name';
               obj_spell_where_field := 'spell_code';
               obj_wbx_where_field := 'wbx_code';
               obj_history_where_field := 'c.check3_no=hd.proj_no';
               obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
               obj_show_field := 'hd.proj_id obj_id,hd.proj_code obj_code,hd.proj_name obj_name';
               obj_group_field := 'hd.proj_id,hd.proj_code,hd.proj_name';
            elsif table_flag = 6 then
               table_name := 'hos_sup_dict';
               obj_code_where_field := 'sup_code';
               obj_id_where_field := 'sup_id';
               obj_name_where_field := 'sup_name';
               obj_spell_where_field := 'spell_code';
               obj_wbx_where_field := 'wbx_code';
               obj_history_where_field := 'c.check6_no=hd.sup_no';
               obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
               obj_show_field := 'hd.sup_id obj_id,hd.sup_code obj_code,hd.sup_name obj_name';
               obj_group_field := 'hd.sup_id,hd.sup_code,hd.sup_name';
            elsif table_flag = 5 then
               table_name := 'hos_cus_dict';
               obj_code_where_field := 'cus_code';
               obj_id_where_field := 'cus_id';
               obj_name_where_field := 'cus_name';
               obj_spell_where_field := 'spell_code';
               obj_wbx_where_field := 'wbx_code';
               obj_history_where_field := 'c.check5_no=hd.cus_no';
               obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
               obj_show_field := 'hd.cus_id obj_id,hd.cus_code obj_code,hd.cus_name obj_name';
               obj_group_field := 'hd.cus_id,hd.cus_code,hd.cus_name';
            elsif table_flag = 4 then
               table_name := 'hos_store_dict';
               obj_code_where_field := 'store_code';
               obj_id_where_field := 'store_id';
               obj_name_where_field := 'store_name';
               obj_spell_where_field := 'spell_code';
               obj_wbx_where_field := 'wbx_code';
               obj_history_where_field := 'c.check4_no=hd.store_no';
               obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
               obj_show_field := 'hd.store_id obj_id,hd.store_code obj_code,hd.store_name obj_name';
               obj_group_field := 'hd.store_id,hd.store_code,hd.store_name';
            else
               table_name := '';
               obj_where_field := '';
            end if;

            /*科目查询方式*/
            if subj_select_flag=2 then
                --2直接选择查询,
                subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
            elsif subj_select_flag=3 then
                --3按范围查询,
                subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
                subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
                subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
            elsif subj_select_flag=4 then
               --4弹出页面筛选查询
               --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
               subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||'''
                         and a.subj_code in('||subj_code||') ';
               subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
            else
              --1查询全部
               subj_wheresql:=' ';
            end if;


            /*项目查询方式*/
            if obj_select_flag=2 then
                --2直接选择查询,
               obj_wheresql:=' and (hd.'||obj_code_where_field||' like ''%'||  obj_code||'%'' or
                                   hd.'||obj_name_where_field||' like ''%'||obj_code||'%'' or
                                   hd.'||obj_spell_where_field||'   like ''%'|| UPPER (obj_code)||'%'' or
                                   hd.'||obj_wbx_where_field||'  like ''%'|| UPPER (obj_code) ||'%''
                                   ) ';
              /*  obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
            elsif obj_select_flag=3 then
                --3按范围查询,
                obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
                obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
                obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
            elsif obj_select_flag=4 then
               --4弹出页面筛选查询
               obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';*/
            else
              --1查询全部
               obj_wheresql:=' ';
            end if;

            --项目显示方式:0历史数据，1最新数据
            SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
            IF num = 0 THEN
                 obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
            else
                 obj_sql:=' and hd.is_stop=0 ';--显示最新数据
            end if;

            if is_happend = 1 then
                     happen_where:='where (exists(
                                          select 1 from t_groupaccsubjobj_result  t1
                                          where t1.obj_id=t.obj_id
                                                and TO_NUMBER(t1.acc_year||''''||t1.acc_month)
                                                between TO_NUMBER('||acc_year_b||''||acc_month_b||')
                                                and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                                )) and t.xh<=4';
            else
                  happen_where:='where  t.xh<=4';
            end if;
            /*条件处理end*/

            /*明细账需要拼辅助核算字段*/
            check_insertsql:='';
            check_selectsql:='';
            check_joinsql:='';
            --check_resultsql:='';
            declare
                check_i integer;
                dict_show_para integer;
                dict_show_sql varchar2(100);
                TYPE ref_type IS REF CURSOR;--定义游标指针
                v_cursor ref_type;--定义游标变量
                check_type_id numeric(18);
                check_table varchar2(50);
                is_sys integer;
                column_id varchar2(50);
                column_no varchar2(50);
                column_code varchar2(50);
                column_name varchar2(50);
                column_check varchar2(50);
                is_change integer;
            begin
              check_i:=0;
              --dbms_output.put_line(ddl_sql);
              OPEN v_cursor FOR '
                  select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check
                  from ACC_CHECK_TYPE b
                  where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
                  and exists(
                    select 1 from ACC_SUBJ hs
                    where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
                     '||subj_wheresql||'
                    --and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
                    and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
                  ) and b.check_table=''HOS_EMP_DICT''
                  order by b.sort_code'
                  using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
              LOOP
              FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中

                EXIT WHEN v_cursor%NOTFOUND;
                check_i:=check_i+1;

                --系统核算
                if is_sys=1 then

                    --有变更表需要取显示方式的参数
                    dict_show_sql:='';
                    if is_change=1 then
                        SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                        IF dict_show_para = 0 THEN
                             dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check2_no ';--显示历史数据
                        else
                             dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                        end if;
                       --要拼成的结果语句
                       --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                       --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
                    end if;

                    check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
                    check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check2_id '||dict_show_sql;
                    --要拼成的结果语句
                    --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
                    --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;

                --自定义核算
                elsif is_sys=0 then
                      check_selectsql:=check_selectsql||','||column_check;
                    --check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
                    --where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
                    --and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;
                   --要拼成的结果语句
                   /* ,(select check_item_code||' '||check_item_name from acc_check_item item
                    where exists(
                    select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
                    and item.check_item_id=avz.check_item_id and avz.check_type_id=29
                    )) check_name2*/


                end if;
                check_insertsql:=check_insertsql||',check'||check_i;

              /*只支持同时挂4个辅助核算*/
              if check_i=4 then
                exit;
              end if;
              end loop;
              CLOSE v_cursor;--关闭游标
            end;

            if acc_month_b='01' then

              /*年初余额*/
              summary:='上年结转';
              --dbms_output.put_line(ddl_sql);
              execute immediate 'insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
              select 1,''0000'',''00'','||obj_show_field||',''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(case when hs.subj_dire=0 then c.end_os else c.end_os  end) '||check_insertsql||',hs.is_check from acc_leder_check c
              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                      and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where c.group_id=:group_id 
                    and hcr.rela_code in ('||rela_code||') 
                    and c.acc_year=:acc_year_b 
                    and c.acc_month=''00''
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by '||obj_group_field||''||check_insertsql||',hs.is_check,hs.subj_dire'
              using group_id,acc_year_b;

            else

              /*期初余额*/
              summary:='期初余额';
              --dbms_output.put_line(ddl_sql);
              execute immediate 'insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
              select 1,''0000'',''00'',t1.obj_id,t1.obj_code,t1.obj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os)'||check_insertsql||',t1.is_check from
              (
                select '||obj_show_field||',sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(case when hs.subj_dire=0 then c.end_os else c.end_os  end) end_os '||check_insertsql||',hs.is_check
                from acc_leder_check c
                inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                        and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
                inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
                left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
                where c.group_id=:group_id 
                      and hcr.rela_code in ('||rela_code||') 
                      and c.acc_year=:acc_year_b 
                      and c.acc_month=''00''
                      '||subj_wheresql||'
                      '||obj_wheresql||'
                      '||source_wheresql||'
                group by '||obj_group_field||''||check_insertsql||',hs.is_check,hs.subj_dire
                union all
                select '||obj_show_field||',sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
                sum(c.debit-c.credit) end_os
                '||check_insertsql||',hs.is_check
                from acc_vouch_check c
                inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                        and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
                  inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                      and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
                inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
                left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
                where v.group_id=:group_id 
                      and hcr.rela_code in ('||rela_code||') 
                      and v.state>=:state
                      and v.acc_year=:acc_year_b 
                      and v.acc_month<:acc_month_b
                      '||subj_wheresql||'
                      '||obj_wheresql||'
                      '||source_wheresql||'
                group by '||obj_group_field||''||check_insertsql||',hs.is_check,hs.subj_dire
               ) t1 group by t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',t1.is_check,t1.subj_dire'
               using group_id,acc_year_b,
              group_id,state,acc_year_b,acc_month_b;

            end if;


            /*本期发生凭证数据*/
            execute immediate 'insert into t_groupaccsubjobj_result(check_id,xh,acc_year,acc_month,vouch_date,vouch_no
            '||check_insertsql||'
            ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select c.vouch_check_id,2,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no||''-''||v.vouch_id vouch_no
            '||check_selectsql||'
            ,'||obj_show_field||',c.summary,c.debit,c.credit,hs.subj_dire,
            case when hs.subj_dire = 0 then ( c.debit-c.credit) else (c.credit-c.debit) end  as  end_os,hs.is_check
            from acc_vouch_check c
            inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                        and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_vouch_type t on v.group_id=t.group_id
                    and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code
              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                      and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
            left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
            where v.group_id=:group_id 
                  and hcr.rela_code in ('||rela_code||') 
                  and v.state>=:state
                  and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
                  '||subj_wheresql||'
                  '||obj_wheresql||'
                  '||source_wheresql||'
            order by v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date,hs.is_check,hs.subj_dire
            ' using group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;

            /*本月合计数据*/
            ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
            select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本月合计'',sum(r.debit),sum(r.credit),0,0 end_os'||check_insertsql||'
           ,r.is_check
            from t_groupaccsubjobj_result r
            where r.xh=2
            group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name'||check_insertsql||',r.is_check
            ';
            --dbms_output.put_line(ddl_sql);
            execute immediate ddl_sql;

         /*   \*本年累计数据的本期凭证*\
       execute immediate '
          insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
          select 5,c.acc_year,null as acc_month,'||obj_show_field||',sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
                 sum(nvl(case when hs.subj_dire=0 then c.debit-c.credit+(select sum(r.end_os) from t_groupaccsubjobj_result r where r.xh=2 and r.obj_id =c.subj_id ) else c.credit-c.debit+(select sum(r.end_os) from t_groupaccsubjobj_result r where r.xh=2 and r.obj_id =c.subj_id ) end,0)) end_os
                '||check_insertsql||',hs.is_check
                from acc_vouch_check c
                inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                        and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
                  inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                      and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
                inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
                '||check_joinsql||'
                where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
                and v.acc_year=:acc_year_b and  v.acc_month >=''01'' and v.acc_month<=:acc_month_e
                '||subj_wheresql||'
                '||obj_wheresql||'
                '||source_wheresql||'
                group by '||obj_group_field||''||check_insertsql||',hs.is_check,c.acc_year,hs.subj_dire'
          using   group_id,hos_id,copy_code,state,acc_year_b,acc_month_e;


            \*本年累计数据*\

             ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 4,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本年累计'', r.debit , r.credit ,r.subj_dire,
         r.end_os
         ,r.is_check
          from t_groupaccsubjobj_result r
          where r.xh=5

          ';*/



            /*计算本期发生凭证、本月合计余额*/
            --dbms_output.put_line(ddl_sql);
            execute immediate '
            declare
              end_os_sum numeric(19,2);
              end_os_month numeric(19,2);
              obj_id numeric(18);
               acc_month_y varchar2(2);
              xh integer;
              i number;
            begin
              i:=1;
              obj_id:=0;
              end_os_month:=0;
              for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.subj_code,r.subj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccsubjobj_result r
                where r.xh<4
                order by r.obj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.vouch_no asc,r.check_id asc) loop

                /*新的项目从0开始计算*/
                if obj_id<>cr.obj_id then
                  end_os_sum:=0;

                  /*有发生数据没有期初余额新增加一条期初余额*/
                  if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then

                         if cr.acc_month = ''01'' then
                            insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,summary,end_os)
                            values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,''上年结转'',0);
                         else
                            insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,summary,end_os)
                            values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,''期初余额'',0);
                        end if;
                  end if;
                end if;

                  if obj_id=cr.obj_id and cr.xh=2 and xh!=1 then

                  /*有发生数据没有期初余额新增加一条期初余额*/
                  if (acc_month_y!=cr.acc_month) then
                      insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,subj_dire,summary,end_os)
                        values( 1,cr.acc_year,cr.acc_month,cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);

                 end if;
                end if;

                end_os_sum:=end_os_sum+cr.end_os;

                /*本期发生凭证余额*/
                if cr.xh=2 then
                   update t_groupaccsubjobj_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
                end if;

                /*本月合计余额*/
                if cr.xh=3 then
                   update t_groupaccsubjobj_result set end_os=end_os_sum where xh=3 and obj_id=cr.obj_id
                   and acc_year = cr.acc_year and acc_month=cr.acc_month;
                end if;

                i:=i+1;
                obj_id:=cr.obj_id;
                acc_month_y:=cr.acc_month;
                xh:=cr.xh;
              end loop;
            end;
            ';
              /*本年累计*/
           /*  select 4,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本年累计'',
            sum(r.debit),sum(r.credit),
            r.subj_dire,sum(r.end_os),r.is_check
            from t_groupaccsubjobj_result r
            where r.xh=3
            group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,r.is_check,r.subj_dire*/

            ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
                select 4,t1.acc_year,t1.acc_month,t1.obj_id,t1.obj_code,t1.obj_name,''本年累计'',
                 t1.debit+nvl((select r1.debit from t_groupaccsubjobj_result r1 where r1.xh=1 and r1.debit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
                 t1.credit+nvl((select r1.credit from t_groupaccsubjobj_result r1 where r1.xh=1 and r1.credit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
                 t1.subj_dire,t1.end_os ,t1.is_check
                  from(
                         select 4,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,
                             sum(r.debit) over(partition by r.acc_year,r.obj_id order by r.acc_month) debit,
                             sum(r.credit) over(partition by r.acc_year,r.obj_id order by r.acc_month) credit,
                             r.subj_dire,r.end_os,r.is_check
                         from t_groupaccsubjobj_result r
                         where r.xh=3
                   ) t1
            ';
            --dbms_output.put_line(ddl_sql);
            execute immediate ddl_sql;
            /*返回结果集游标*/
            ddl_sql:='select
              case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
              case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
              to_char(t.vouch_date,''dd'') day,t.vouch_no,t.obj_id,
              t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||',
              t.subj_code||'' ''||t.subj_name subj_name,t.summary,
              case when t.xh=1 then NULL else t.debit end debit,
              case when t.xh=1 then NULL else t.credit end credit,
              case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
            from t_groupaccsubjobj_result t
            '||happen_where||'
            order by t.obj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date asc ,t.vouch_no asc,t.check_id asc,t.is_check
            ';
            --dbms_output.put_line(ddl_sql);
            open objdata for ddl_sql ;--using acc_year_b,acc_month_b,acc_year_e,acc_month_e;

        END group_subjobjdetail_zg;

	]]></sql>
	
	<sql id="group_balancedetail_zg" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_balancedetail_zg
      /*集团----职工余额表*/
    (prm_group_id        number,
     prm_hos_id          number,
     prm_copy_code       varchar2,
     prm_acc_year_b      varchar2,
     prm_acc_month_b     varchar2,
     prm_acc_year_e      varchar2,
     prm_acc_month_e     varchar2,
     prm_is_state        integer, --包含未记账:1,99
     prm_is_end_os       integer, --显示有余额的项目:0,1
     prm_cur_code        varchar2, --币种
     prm_obj_select_flag integer, --项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
     prm_obj_code        varchar2, --项目条件多个值用逗号分隔。参数格式：1='，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
     prm_subj_select_flag integer, --项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
     prm_subj_code        varchar2, --项目条件多个值用逗号分隔。参数格式：1='，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
     prm_rela_code varchar2,--集团化管理   用于账套查询
     cur_objdata         OUT ACT_BOOKS.balancecursor)

     IS

      ddl_sql      varchar2(4000);
      obj_wheresql varchar2(4000);
      emp_wheresql varchar2(100);
      endOsWhere   varchar2(100);
      subj_wheresql varchar2(4000);
      subj_code_begin varchar2(200);--开始科目编码
      subj_code_end varchar2(200);--结束科目编码
      subj_id varchar2(4000) ;
      num NUMBER;

    BEGIN
      /*项目查询方式*/
      if prm_obj_select_flag = 2 then
        --2直接选择查询,
         obj_wheresql:=' and ( obj_code like ''%'||  prm_obj_code||'%'' or
                               obj_name like ''%'||prm_obj_code||'%'' or
                               spell_code like ''%'|| UPPER (prm_obj_code)||'%'' or
                               wbx_code like ''%'|| UPPER (prm_obj_code) ||'%''
                                   ) ';

      /*  obj_wheresql := ' and obj_code like ''' || prm_obj_code || '%'' ';

      elsif prm_obj_select_flag = 3 then
        --3按范围查询,
        obj_wheresql := ' and obj_code between ' ||
                        regexp_substr(prm_obj_code, '[^,]+', 1, 1, 'i') ||
                        ' and ' ||
                        regexp_substr(prm_obj_code, '[^,]+', 1, 2, 'i') || ' ';
      elsif prm_obj_select_flag = 4 then
        --4弹出页面筛选查询
        obj_wheresql := ' and obj_id in(' || prm_obj_code || ') ';*/
      else
        --1查询全部
        obj_wheresql := '';
      end if;

     /*科目查询方式*/
          if prm_subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and subj_code like '''||prm_subj_code||'%'' ';
          elsif prm_subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(prm_subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(prm_subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif prm_subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||prm_group_id||' and a.hos_id  = '||prm_hos_id||' and a.copy_code= '''||prm_copy_code||'''
                         and a.subj_code in('||prm_subj_code||') ';
             subj_wheresql:=' and subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;


      /*是否显示余额项目*/
      if prm_is_end_os = 1 then
        --2直接选择查询,
        endOsWhere := ' and nvl(end_credit,0)-nvl(end_debit,0) !=0 ';
      else
        endOsWhere := '';
      end if;

      insert into t_groupbalancedetail_result_zg (
       idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit,
       is_check,subj_id,subj_code,spell_code,wbx_code
      )
    select 1 as idx,
        tempa1.check2_id,
        tempe1.emp_code,
        tempe1.emp_name,
        case when tempa1.subj_dire = 0 then  nvl(tempb1.nc_debit,0)-nvl(tempb1.nc_credit,0) end as nc_debit,   --年初余额 借
        case when tempa1.subj_dire = 1 then nvl(tempb1.nc_credit,0)-nvl(tempb1.nc_debit,0) end as nc_credit ,   --年初余额 贷
        case when tempa1.subj_dire = 0 then (nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0))-(nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)) end as bq_debit,  --期初余额 借
        case when tempa1.subj_dire = 1 then (nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0))-(nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)) end as bq_credit, --期初余额 贷
        nvl(tempd1.bq_debit,0),  --本期发生 借
        nvl(tempd1.bq_credit,0),   --本期发生 贷
        nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0),  --累计发生 借
        nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0),  --累计发生 贷
        case when tempa1.subj_dire = 0 then (nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0))-(nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0)) end as end_debit,  --期末余额 借
        case when tempa1.subj_dire = 1 then  (nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0))-(nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0)) end as end_credit, --期末余额 贷
        tempb1.is_check,
        tempa1.subj_id,
        tempa1.subj_code,
        tempe1.spell_code,
        tempe1.wbx_code
     from (
          --有数据的科目
         select a.check2_id,a.check2_no,a.group_id,a.hos_id,a.copy_code,a.acc_year,a.subj_id,b.subj_code,b.subj_dire
         from acc_leder_check a
         left join acc_subj b on a.group_id = b.group_id and a.hos_id = b.hos_id and a.copy_code = b.copy_code and a.subj_id = b.subj_id
         left join hos_copy_rela hcr on a.group_id = hcr.group_id and a.hos_id = hcr.hos_id and a.copy_code = hcr.copy_code
         where a.group_id=prm_group_id
               and hcr.rela_code in (prm_rela_code)
               and a.acc_year = prm_acc_year_b
               and nvl(a.check2_id,0)!=0
               and TO_NUMBER(a.acc_year||''||a.acc_month) between TO_NUMBER(prm_acc_year_b||'00') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
               and nvl(a.end_os,0)!=0
          union
          select a1.check2_id,a1.check2_no,a1.group_id,a1.hos_id,a1.copy_code,a1.acc_year,a1.subj_id,c1.subj_code ,c1.subj_dire
          from acc_vouch_check a1
          left join acc_vouch b1 on a1.group_id= b1.group_id and a1.hos_id=b1.hos_id and a1.copy_code=b1.copy_code
               and a1.acc_year = b1.acc_year and a1.vouch_id=b1.vouch_id
          left join acc_subj c1 on a1.group_id = c1.group_id and a1.hos_id = c1.hos_id and a1.copy_code = c1.copy_code and a1.subj_id = c1.subj_id
          left join hos_copy_rela hcr on a1.group_id = hcr.group_id and a1.hos_id = hcr.hos_id and a1.copy_code = hcr.copy_code
          where a1.group_id=prm_group_id and hcr.rela_code in (prm_rela_code)
                 and a1.acc_year = prm_acc_year_b
                 and b1.state>=prm_is_state
                 and nvl(a1.check2_id,0)!=0
                 and TO_NUMBER(b1.acc_year||''||b1.acc_month) between TO_NUMBER(prm_acc_year_b||'01') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
    ) tempa1
    left join (
     --年初余额
     select a2.check2_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,a2.subj_id,
            sum(case when b2.subj_dire=0 then nvl(a2.end_os,0) else 0 end) nc_debit,
            sum(case when b2.subj_dire=1 then  nvl(a2.end_os,0) else 0 end) nc_credit,b2.is_check
     from acc_leder_check a2
     left join acc_subj b2 on a2.group_id =b2.group_id and a2.hos_id=b2.hos_id  and a2.copy_code=b2.copy_code
           and a2.acc_year = b2.acc_year  and a2.subj_id=b2.subj_id
     left join hos_copy_rela hcr on a2.group_id = hcr.group_id and a2.hos_id = hcr.hos_id and a2.copy_code = hcr.copy_code
     where a2.group_id=prm_group_id  and hcr.rela_code in (prm_rela_code)
            and a2.acc_year=prm_acc_year_b and a2.acc_month='00'
            and nvl(a2.check2_id,0)!=0
     group by a2.check2_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,b2.is_check,a2.subj_id
    ) tempb1 on tempa1.group_id =tempb1.group_id and tempa1.hos_id =tempb1.hos_id
      and tempa1.copy_code =tempb1.copy_code and tempa1.acc_year =tempb1.acc_year
      and tempa1.check2_id =tempb1.check2_id  and tempa1.subj_id = tempb1.subj_id
    left join (
    --年初到开始日间中间数据
         select a.check2_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id,
           sum(nvl(a.debit,0)) bfs_debit,
           sum(nvl(a.credit,0)) bfs_credit
        from  acc_vouch b
        left join  acc_vouch_check a on b.group_id = a.group_id and  b.hos_id = a.hos_id
             and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id
        left join hos_copy_rela hcr on b.group_id = hcr.group_id and b.hos_id = hcr.hos_id and b.copy_code = hcr.copy_code     
        where a.group_id=prm_group_id and hcr.rela_code in (prm_rela_code)
              and b.acc_year = prm_acc_year_b
              and b.state>=prm_is_state
              and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||'01'
              and TO_NUMBER(b.acc_year||''||b.acc_month) < prm_acc_year_b||''||prm_acc_month_b
              and nvl(a.check2_id,0)!=0
         group by a.check2_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id
    ) tempc1 on tempa1.group_id =tempc1.group_id and tempa1.hos_id =tempc1.hos_id
      and tempa1.copy_code =tempc1.copy_code and tempa1.acc_year =tempc1.acc_year
      and tempa1.check2_id =tempc1.check2_id   and tempa1.subj_id = tempc1.subj_id
    left join (
    -- 本期发生数据
        select a.check2_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id,
               sum(nvl(a.debit,0)) bq_debit,
               sum(nvl(a.credit,0)) bq_credit
        from   acc_vouch b
        left join acc_vouch_check a  on b.group_id=a.group_id and b.hos_id=a.hos_id
               and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id
        left join hos_copy_rela hcr on b.group_id = hcr.group_id and b.hos_id = hcr.hos_id and b.copy_code = hcr.copy_code
        where a.group_id=prm_group_id and hcr.rela_code in (prm_rela_code)
                and a.acc_year =prm_acc_year_b  and b.state>=prm_is_state
                and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||''||prm_acc_month_b
                and TO_NUMBER(b.acc_year||''||b.acc_month) <= prm_acc_year_e||''||prm_acc_month_e
                and nvl(a.check2_id,0)!=0
        group by a.check2_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id
    ) tempd1 on tempa1.group_id =tempd1.group_id and tempa1.hos_id =tempd1.hos_id
      and tempa1.copy_code =tempd1.copy_code and tempa1.acc_year =tempd1.acc_year
      and tempa1.check2_id =tempd1.check2_id   and tempa1.subj_id = tempd1.subj_id
    left join hos_emp_dict  tempe1 on  tempa1.group_id =tempe1.group_id and tempa1.hos_id = tempe1.hos_id
      and  tempa1.check2_id = tempe1.emp_id and  tempa1.check2_no = tempe1.emp_no  ;

         execute immediate '
             insert into t_groupbalancedetail_resultszg(
               idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,
               end_debit ,end_credit,is_check  ,spell_code,wbx_code
             ) select  idx,obj_id ,obj_code ,obj_name ,sum(nc_debit) ,sum(nc_credit) ,sum(qc_debit ),sum(qc_credit) ,sum(bq_debit) ,sum(bq_credit),
             sum(lj_debit) , sum(lj_credit) ,sum(end_debit) ,sum(end_credit),is_check,spell_code,wbx_code
                     from t_groupbalancedetail_result_zg
                     where idx =1  '||obj_wheresql||''||subj_wheresql||'
                     group by idx,obj_id ,obj_code ,obj_name ,is_check ,spell_code,wbx_code
        ';

             --求总合计
            insert into t_groupbalancedetail_resultszg(
                 idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit,is_check
            )
            select 2 as idx,'' obj_id,'总合计' as obj_code,'' as obj_name,
               sum(nvl(nc_debit,0)) as nc_debit,
               sum(nvl(nc_credit,0)) as nc_credit,
               sum(nvl(qc_debit,0)) as qc_debit,
               sum(nvl(qc_credit,0)) as qc_credit,
               sum(nvl(bq_debit,0)) as bq_debit,
               sum(nvl(bq_credit,0)) as bq_credit,
               sum(nvl(lj_debit,0)) as lj_debit,
               sum(nvl(lj_credit,0)) as lj_credit,
               sum(nvl(end_debit,0)) as end_debit,
               sum(nvl(end_credit,0)) as end_credit,
               '' as is_check
            from t_groupbalancedetail_resultszg
            where idx = 1;

      if prm_subj_select_flag != '1'  then
          ddl_sql := 'select
                obj_code  ,obj_name ,
                sum(nvl(nc_debit,0)) as nc_debit ,sum(nvl(nc_credit,0)) as nc_credit ,sum(nvl(qc_debit,0)) as qc_debit ,
                sum(nvl(qc_credit,0)) as qc_credit,
                sum(nvl(bq_debit,0)) as bq_debit ,sum(nvl(bq_credit,0)) as bq_credit,sum(nvl(lj_debit,0)) as lj_debit ,
                sum(nvl(lj_credit,0)) as lj_credit ,
                sum(nvl(end_debit,0)) as  end_debit,
                sum(nvl(end_credit,0)) as   end_credit
                 from  t_groupbalancedetail_resultszg
      where     (nvl(nc_debit,0)!=0
                or  nvl(nc_credit,0)!=0
                or  nvl(qc_debit,0)!=0
                or  nvl(qc_credit,0)!=0
                or  nvl(bq_debit,0)!=0
                or  nvl(bq_credit,0)!=0
                or  nvl(lj_debit,0)!=0
                or  nvl(lj_credit,0)!=0
                or  nvl(end_debit,0)!=0
                or  nvl(end_credit,0)!=0 )
                '||endOsWhere||'
                group by  obj_code  ,obj_name
        order by obj_code';


       else
            ddl_sql := 'select
                obj_code  ,obj_name ,
                sum(nvl(nc_debit,0)-nvl(nc_credit,0)) as nc_debit ,0 as nc_credit ,sum(nvl(qc_debit,0)-nvl(qc_credit ,0)) as qc_debit ,
                0  as qc_credit,
                sum(nvl(bq_debit,0)) as bq_debit ,sum(nvl(bq_credit,0)) as bq_credit,sum(nvl(lj_debit,0)) as lj_debit ,
                sum(nvl(lj_credit ,0)) as lj_credit,
                 sum(nvl(end_debit,0)-nvl(end_credit,0)) as  end_debit,
                0 as   end_credit
                 from  t_groupbalancedetail_resultszg
      where     (nvl(nc_debit,0)!=0
                or  nvl(nc_credit,0)!=0
                or  nvl(qc_debit,0)!=0
                or  nvl(qc_credit,0)!=0
                or  nvl(bq_debit,0)!=0
                or  nvl(bq_credit,0)!=0
                or  nvl(lj_debit,0)!=0
                or  nvl(lj_credit,0)!=0
                or  nvl(end_debit,0)!=0
                or  nvl(end_credit,0)!=0 )
                '||endOsWhere||'
                group by obj_code  ,obj_name
        order by obj_code';

          end if ;

     open cur_objdata for ddl_sql;
    END group_balancedetail_zg;
		
	]]></sql>
	
	<sql id="group_objsubjgeneralled_xm" type="proc"><![CDATA[
	CREATE OR REPLACE PROCEDURE group_objsubjgeneralled_xm
      /*集团========项目科目总账*/
      (
       prm_group_id number,
       prm_hos_id number,
       prm_copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       rela_code varchar2,--集团化管理   账套查询
       objdata OUT ACT_BOOKS.objsubjgeneralcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
          subj_id varchar2(4000) ;
          num NUMBER;
      BEGIN

          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;


          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          else
             table_name := '';
             obj_where_field := '';
          end if;

          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||prm_subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(prm_subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(prm_subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||prm_group_id||' and a.hos_id  = '||prm_hos_id||' and a.copy_code= '''||prm_copy_code||'''
                         and a.subj_code in('||prm_subj_code||') ';
             subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' and ((hs.check1= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
              and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
               and   act.check_type_id = hs.check1 and act.check_type_name=''项目'')) or
          (hs.check2= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check2 and act.check_type_name=''项目'')) or
          (hs.check3= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check3 and act.check_type_name=''项目'')) or
          (hs.check4= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check4 and act.check_type_name=''项目'' ))
                         )';
          end if;


          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;

          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          /*条件处理end*/


          if acc_month_b='01' then

            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',c.subj_id,hs.subj_code,hs.subj_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os) ,hs.is_check
            from acc_leder_check c
            inner join acc_subj hs on c.group_id =hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and hs.subj_id=c.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
            left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
            where c.group_id=:prm_group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
                  '||subj_wheresql||'
                  '||obj_wheresql||'
                  '||source_wheresql||'
            group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check'
            using prm_group_id,acc_year_b;
          else
            /*期初余额*/
            summary:='期初余额';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',t1.subj_id,t1.subj_code,t1.subj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os),t1.is_check from
            (
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(c.end_os) end_os,hs.is_check from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where c.group_id=:prm_group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
              union all
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
                     sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where v.group_id=:prm_group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
                    and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
             ) t1 group by t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check'
             using prm_group_id,acc_year_b,
            prm_group_id,state,acc_year_b,acc_month_b;
          end if;

          /*本月合计数据*/
          execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month
          ,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 2,v.acc_year,v.acc_month,hs.subj_id,hs.subj_code,hs.subj_name,''本月合计'',sum(c.debit),sum(c.credit),hs.subj_dire,
          case when subj_dire=1 then sum(c.credit)-sum(c.debit) else sum(c.debit)-sum(c.credit) end   end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code
          inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:prm_group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
          and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
          group by v.acc_year,v.acc_month,hs.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
          ' using prm_group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;

          /*计算本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            subj_id numeric(18);
            xh integer;
            i number;
          begin
            i:=1;
            subj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.subj_id,r.subj_code,r.subj_name,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccobjsubjledger_result r
              where r.xh<3
              order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop

              /*新的科目从0开始计算*/
              if subj_id<>cr.subj_id then
                end_os_sum:=0;

             if (cr.xh=2 ) or (i=1 and cr.xh>1) then
                     if cr.acc_month = ''01'' then
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''上年结转'',0);

                     else

                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''期初余额'',0);

                     end if;

                end if;
              end if;

              if subj_id=cr.subj_id and cr.xh=2 and xh!=1 then

                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.subj_id,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);

              end if;

              end_os_sum:=end_os_sum+cr.end_os;

              /*本月合计余额*/
              if cr.xh=2 then
                 update t_groupaccobjsubjledger_result set end_os=end_os_sum where xh=2 and subj_id=cr.subj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;

              i:=i+1;
              subj_id:=cr.subj_id;
              xh:=cr.xh;
            end loop;
          end;
          ';

          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 3,t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,''本年累计'',
                 t1.debit+nvl((select r1.debit from t_groupaccobjsubjledger_result r1 where r1.xh=1 and r1.debit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
                 t1.credit+nvl((select r1.credit from t_groupaccobjsubjledger_result r1 where r1.xh=1 and r1.credit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
                 t1.subj_dire,t1.end_os ,t1.is_check
          from(
                 select 3,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,
                     sum(r.debit) over(partition by r.acc_year,r.subj_id order by r.acc_month) debit,
                     sum(r.credit) over(partition by r.acc_year,r.subj_id order by r.acc_month) credit,
                     r.subj_dire,r.end_os,r.is_check
                 from t_groupaccobjsubjledger_result r
                 where r.xh=2
           ) t1';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
          select count(1) into num from acc_subj a5 where a5.group_id = prm_group_id
                    and a5.hos_id = prm_hos_id
                    and a5.copy_code = prm_copy_code
                    and a5.acc_year = acc_year_b
                    and a5.subj_code like ''||prm_subj_code||'%' ;

         if num>1 then
                --逐级汇总
          insert into t_groupaccobjsubjledger_result
                          (xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit, end_os,
                     subj_dire )
                 select b.xh as xh,
                        a.acc_year,
                      '00' as acc_month  ,
                      a.subj_id,
                      a.subj_code,
                      a.subj_name,
                      b.summary,
                      sum(nvl(b.debit, 0)) as debit,
                      sum(nvl(b.credit, 0)) as credit ,
                    sum(nvl(b.end_os, 0)) as end_os ,
                   a.subj_dire
                 from (select distinct a5.acc_year,
                          a5.subj_id,
                          a5.subj_code,
                          a5.subj_name,
                          a5.subj_level,
                          a5.is_check,
                          a5.is_last,
                          a5.subj_dire
                    from acc_subj a5
                    where a5.group_id = prm_group_id
                    and a5.hos_id = prm_hos_id
                    and a5.copy_code = prm_copy_code
                    and a5.acc_year = acc_year_b
                    and a5.is_last = 0
                    and a5.is_stop = 0
                    and a5.subj_code like ''||prm_subj_code||'%'
                    ) a
               right join t_groupaccobjsubjledger_result b
               on b.subj_code like (a.subj_code || '%')
               group by a.acc_year,
                        a.subj_id,
                        a.subj_code,
                        a.subj_name,
                        b.summary,
                        b.xh,
                    a.subj_dire ;
           end if;
           ddl_sql:='select
                case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
                case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
                t.subj_code||'' ''||t.subj_name subj_name,
                t.summary,
                t.debit debit,
                t.credit credit,
                case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,
                t.end_os
          from t_groupaccobjsubjledger_result t
          order by t.subj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql;

      END group_objsubjgeneralled_xm;
		
	
		
	]]></sql>
	
	<sql id="group_objsubjdetail_xm" type="proc"><![CDATA[
	CREATE OR REPLACE PROCEDURE group_objsubjdetail_xm
      /*集团===项目科目明细账*/
      (
       group_id number,
       hos_id number,
       copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       is_happend integer,--无发生不显示期初余额0,1
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       rela_code varchar2,--集团化管理   账套查询
       objdata OUT ACT_BOOKS.objsubjcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_name_where_field varchar2(200);--查询所用的动态字段名称
          obj_spell_where_field varchar2(200);--查询所用的动态字段名称*/
          obj_wbx_where_field varchar2(200);--查询所用的动态字段名称*/
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_show_field varchar2(200);--要显示的动态字段
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          check_insertsql varchar2(500);--辅助核算添加动态字段
          check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
          check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
          subj_id varchar2(4000) ;
          num NUMBER;
          happen_where varchar2(4000);
      BEGIN

          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;


          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
                  obj_name_where_field := 'dept_name';
                   obj_spell_where_field := 'spell_code';
                   obj_wbx_where_field := 'wbx_code';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.dept_code obj_code,hd.dept_name obj_name';

          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
                   obj_name_where_field := 'emp_name';
                   obj_spell_where_field := 'spell_code';
                   obj_wbx_where_field := 'wbx_code';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.emp_code obj_code,hd.emp_name obj_name';

          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
                   obj_name_where_field := 'proj_name';
                   obj_spell_where_field := 'spell_code';
                   obj_wbx_where_field := 'wbx_code';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.proj_code obj_code,hd.proj_name obj_name';

          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
                   obj_name_where_field := 'sup_name';
                   obj_spell_where_field := 'spell_code';
                   obj_wbx_where_field := 'wbx_code';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.sup_code obj_code,hd.sup_name obj_name';

          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
                   obj_name_where_field := 'cus_name';
                   obj_spell_where_field := 'spell_code';
                   obj_wbx_where_field := 'wbx_code';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.cus_code obj_code,hd.cus_name obj_name';

          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
                   obj_name_where_field := 'store_name';
                   obj_spell_where_field := 'spell_code';
                   obj_wbx_where_field := 'wbx_code';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.store_code obj_code,hd.store_name obj_name';

          else
             table_name := '';
             obj_where_field := '';
          end if;

          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
            -- subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
            subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||'''
                         and a.subj_code in('||subj_code||') ';
            subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;


          /*项目查询方式*/
          if obj_select_flag=2 then

              --2直接选择查询,
              obj_wheresql:=' and (hd.'||obj_code_where_field||' like ''%'||  obj_code||'%'' or
                                   hd.'||obj_name_where_field||' like ''%'||obj_code||'%'' or
                                   hd.'||obj_spell_where_field||'   like ''%'|| UPPER (obj_code)||'%'' or
                                   hd.'||obj_wbx_where_field||'  like ''%'|| UPPER (obj_code) ||'%''
                                   ) ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;

          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;


          if is_happend = 1 then
               happen_where:='where (exists(
                                    select 1 from t_groupaccobjsubj_result t1
                                    where t1.subj_id=t.subj_id
                                          and TO_NUMBER(t1.acc_year||''''||t1.acc_month)
                                          between TO_NUMBER('||acc_year_b||''||acc_month_b||')
                                          and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                          ))';
             else
               happen_where:='';
          end if;
          /*条件处理end*/

          /*明细账需要拼辅助核算字段*/
          check_insertsql:='';
          check_selectsql:='';
          check_joinsql:='';
          --check_resultsql:='';
          declare
              check_i integer;
              dict_show_para integer;
              dict_show_sql varchar2(100);
              TYPE ref_type IS REF CURSOR;--定义游标指针
              v_cursor ref_type;--定义游标变量
              check_type_id numeric(18);
              check_table varchar2(50);
              is_sys integer;
              column_id varchar2(50);
              column_no varchar2(50);
              column_code varchar2(50);
              column_name varchar2(50);
              column_check varchar2(50);
              is_change integer;
          begin
            check_i:=0;
            --dbms_output.put_line(ddl_sql);
            OPEN v_cursor FOR '
                select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
                where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
                and exists(
                  select 1 from ACC_SUBJ hs
                  where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
                   '||subj_wheresql||'
                  --and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
                  and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
                ) and b.check_type_id<>3
                order by b.sort_code'
                using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
            LOOP
            FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中

              EXIT WHEN v_cursor%NOTFOUND;
              check_i:=check_i+1;

              --系统核算
              if is_sys=1 then

                  --有变更表需要取显示方式的参数
                  dict_show_sql:='';
                  if is_change=1 then
                      SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                      IF dict_show_para = 0 THEN
                           dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check3_no ';--显示历史数据
                      else
                           dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                      end if;
                     --要拼成的结果语句
                     --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                     --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
                  end if;

                  check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
                  check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check3_id '||dict_show_sql;
                  --要拼成的结果语句
                  --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
                  --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;

              --自定义核算
              elsif is_sys=0 then
                    check_selectsql:=check_selectsql||','||column_check;
                  /*check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
                  where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
                  and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;  */
                 --要拼成的结果语句
                 /* ,(select check_item_code||' '||check_item_name from acc_check_item item
                  where exists(
                  select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
                  and item.check_item_id=avz.check_item_id and avz.check_type_id=29
                  )) check_name2*/


              end if;
              check_insertsql:=check_insertsql||',check'||check_i;

            /*只支持同时挂4个辅助核算*/
            if check_i=4 then
              exit;
            end if;
            end loop;
            CLOSE v_cursor;--关闭游标
          end;

          if acc_month_b='01' then

            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',c.subj_id,hs.subj_code,hs.subj_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os) ,hs.is_check
            from acc_leder_check c
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
           left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
           where c.group_id=:group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
            '||subj_wheresql||'
            '||obj_wheresql||'
            '||source_wheresql||'
            group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check'
            using group_id,acc_year_b;

          else

            /*期初余额*/
            summary:='期初余额';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check,obj_code,obj_name)
            select 1,''0000'',''00'',t1.subj_id,t1.subj_code,t1.subj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os)
            ,t1.is_check ,t1.obj_code,t1.obj_name from
            (
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,
              sum(c.end_os) end_os ,hs.is_check ,hd.'||obj_code_where_field||' as obj_code,hd.'||obj_name_where_field|| ' as obj_name
              from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where c.group_id=:group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check ,hd.'||obj_code_where_field||',hd.'||obj_name_where_field||'
              union all
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
              sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,
              hs.is_check ,hd.'||obj_code_where_field||' as obj_code,hd.'||obj_name_where_field||'
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
              and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
               ,hd.'||obj_code_where_field||',hd.'||obj_name_where_field||'
             ) t1 group by t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check,t1.obj_code,t1.obj_name'
             using group_id,acc_year_b,
            group_id,state,acc_year_b,acc_month_b;

          end if;

          /*本期发生凭证数据*/
          execute immediate 'insert into t_groupaccobjsubj_result(check_id,xh,acc_year,acc_month,vouch_date,vouch_no,obj_code,obj_name
          '||check_insertsql||'
          ,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select c.vouch_check_id,2,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no||''-''||v.vouch_id vouch_no,'||obj_show_field||'
          '||check_selectsql||'
          ,hs.subj_id,hs.subj_code,hs.subj_name,c.summary,c.debit,c.credit,hs.subj_dire,
          (case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id
                and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
          and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          order by v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date,hs.is_check
          ' using group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;

          /*本月合计数据*/
          ddl_sql:='insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 3,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,''本月合计'',sum(r.debit),sum(r.credit),r.subj_dire,0 end_os,r.is_check
          from t_groupaccobjsubj_result r
          where r.xh=2
          group by r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,r.subj_dire,r.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;


          /*计算本期发生凭证、本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            subj_id numeric(18);
              acc_month_y varchar2(2);
            xh integer;
            i number;
          begin
            i:=1;
            subj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.subj_id,r.subj_code,r.subj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccobjsubj_result r
              where r.xh<4
              order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.vouch_no asc,r.check_id asc) loop

              /*新的科目从0开始计算*/
              if subj_id<>cr.subj_id then
                end_os_sum:=0;

                /*有发生数据没有期初余额新增加一条期初余额*/
                if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then


                      if cr.acc_month = ''01'' then
                 insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''上年结转'',0);
                else
                   insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''期初余额'',0);
                  end if;

                end if;
              end if;

               if subj_id=cr.subj_id and cr.xh=2 and xh!=1 then

                if (acc_month_y!=cr.acc_month) then
                      insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.subj_id,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);
                end if;
              end if;

              end_os_sum:=end_os_sum+cr.end_os;

              /*本期发生凭证余额*/
              if cr.xh=2 then
                 update t_groupaccobjsubj_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
              end if;
              /*本月合计余额*/
              if cr.xh=3 then
                 update t_groupaccobjsubj_result set end_os=end_os_sum where xh=3 and subj_id=cr.subj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;

              i:=i+1;
              subj_id:=cr.subj_id;
               acc_month_y:=cr.acc_month;
              xh:=cr.xh;
            end loop;
          end;
          ';

          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 4,t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,''本年累计'',
          t1.debit+nvl(
          (select sum(r1.debit) from t_groupaccobjsubj_result r1 where r1.xh=1 and r1.debit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.credit+nvl(
          (select sum(r1.credit) from t_groupaccobjsubj_result r1 where r1.xh=1 and r1.credit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.subj_dire,t1.end_os,t1.is_check  from
            (select 4,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,
            sum(r.debit) over(partition by r.acc_year,r.subj_id order by r.acc_month) debit,
            sum(r.credit) over(partition by r.acc_year,r.subj_id order by r.acc_month) credit,
            r.subj_dire,r.end_os,r.is_check
            from t_groupaccobjsubj_result r
            where r.xh=3
           ) t1

          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;

          /*返回结果集游标*/
          ddl_sql:='select
           case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
          case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
          to_char(t.vouch_date,''dd'') day,t.vouch_no,
          t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||'
          ,t.subj_code||'' ''||t.subj_name subj_name,t.summary,
          case when t.xh=1 then NULL else t.debit end debit,
          case when t.xh=1 then NULL else t.credit end credit,
          case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
          from t_groupaccobjsubj_result t
          '||happen_where||'
          order by t.subj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date asc,t.vouch_no asc,t.check_id asc,t.is_check
          ';
         -- dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql ;--using acc_year_b,acc_month_b,acc_year_e,acc_month_e;

      END group_objsubjdetail_xm;
		
	]]></sql>
	
	<sql id="group_subjobjgeneralled_xm" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_subjobjgeneralled_xm

  /*集团==科目项目总账*/
  (
   group_id number,
   hos_id number,
   copy_code varchar2,
   acc_year_b varchar2,
   acc_month_b varchar2,
   acc_year_e varchar2,
   acc_month_e varchar2,
   state integer,--包含未记账:1,99
   subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
   obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
   source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
   table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
   is_happend integer,
   rela_code varchar2,--集团化管理   账套查询
   objdata OUT ACT_BOOKS.subjobjgeneralcursor
   )
  IS
      ddl_sql varchar2(4000);
      obj_sql varchar2(200);
      table_name varchar2(200);--动态表名称
      obj_code_where_field varchar2(200);--查询所用的动态字段名称
      obj_id_where_field varchar2(200);--查询所用的动态字段名称
      obj_history_where_field varchar2(200);--历史记录动态条件
      obj_show_field varchar2(200);--要显示的动态字段
      obj_group_field varchar2(200);--要分组的动态字段
      obj_group_field1 varchar2(200);--要分组的动态字段
      obj_where_field varchar2(200);--id关联动态条件
      subj_code_begin varchar2(200);--开始科目编码
      subj_code_end varchar2(200);--结束科目编码
      obj_code_begin varchar2(200);--开始项目编码
      obj_code_end varchar2(200);--结束项目编码
      check_insertsql varchar2(500);--辅助核算添加动态字段
      check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
      check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
      --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
      source_wheresql varchar2(200);
      subj_wheresql varchar2(4000);
      obj_wheresql varchar2(4000);
      summary varchar2(20);
      subj_id varchar2(4000) ;
      num NUMBER;
      happen_where varchar2(4000);
  BEGIN

      /*结果集临时表*/
      --EXECUTE IMMEDIATE 'drop Table t_groupaccsubjobjledger_result';
      SELECT COUNT(1) INTO num FROM USER_TABLES WHERE TABLE_NAME = UPPER('t_groupaccsubjobjledger_result') ;
      IF num = 0 THEN
           ddl_sql:='Create Global Temporary Table t_groupaccsubjobjledger_result(
            xh integer,
            acc_year varchar2(20),
            acc_month varchar2(2),
            obj_id numeric(18,0),
            obj_code varchar2(50),
            obj_name varchar2(200),
            subj_code varchar2(200),
            subj_name varchar2(200),
            check1 varchar2(200),--核算1
            check2 varchar2(200),--核算2
            check3 varchar2(200),--核算3
            check4 varchar2(200),--核算4
            summary varchar2(200),
            debit numeric(19,2),
            credit numeric(19,2),
            subj_dire integer,
            end_os numeric(19,2),
               is_check numeric(2)
            )On COMMIT Delete ROWS';
            /*
            On COMMIT PRESERVE ROWS 会话性临时表
            On Commit Delete Rows 事务性临时表
            */
            execute immediate ddl_sql;
      END IF;

      /*条件处理begin*/
      if source_id='0' then
           source_wheresql:='';--资源来源ID
      else
           source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
      end if;

      obj_group_field1 := 'r1.obj_id,r1.obj_code,r1.obj_name';
      if table_flag  = 1 then
         table_name := 'hos_dept_dict';
         obj_code_where_field := 'dept_code';
         obj_id_where_field := 'dept_id';
         obj_history_where_field := 'c.check1_no=hd.dept_no';
         obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.dept_id obj_id,hd.dept_code obj_code,hd.dept_name obj_name';
         obj_group_field := 'hd.dept_id,hd.dept_code,hd.dept_name';
      elsif table_flag = 2 then
         table_name := 'hos_emp_dict';
         obj_code_where_field := 'emp_code';
         obj_id_where_field := 'emp_id';
         obj_history_where_field := 'c.check2_no=hd.emp_no';
         obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.emp_id obj_id,hd.emp_code obj_code,hd.emp_name obj_name';
         obj_group_field := 'hd.emp_id,hd.emp_code,hd.emp_name';
      elsif table_flag = 3 then
         table_name := 'hos_proj_dict';
         obj_code_where_field := 'proj_code';
         obj_id_where_field := 'proj_id';
         obj_history_where_field := 'c.check3_no=hd.proj_no';
         obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.proj_id obj_id,hd.proj_code obj_code,hd.proj_name obj_name';
         obj_group_field := 'hd.proj_id,hd.proj_code,hd.proj_name';
      elsif table_flag = 6 then
         table_name := 'hos_sup_dict';
         obj_code_where_field := 'sup_code';
         obj_id_where_field := 'sup_id';
         obj_history_where_field := 'c.check6_no=hd.sup_no';
         obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.sup_id obj_id,hd.sup_code obj_code,hd.sup_name obj_name';
         obj_group_field := 'hd.sup_id,hd.sup_code,hd.sup_name';
      elsif table_flag = 5 then
         table_name := 'hos_cus_dict';
         obj_code_where_field := 'cus_code';
         obj_id_where_field := 'cus_id';
         obj_history_where_field := 'c.check5_no=hd.cus_no';
         obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.cus_id obj_id,hd.cus_code obj_code,hd.cus_name obj_name';
         obj_group_field := 'hd.cus_id,hd.cus_code,hd.cus_name';
      elsif table_flag = 4 then
         table_name := 'hos_store_dict';
         obj_code_where_field := 'store_code';
         obj_id_where_field := 'store_id';
         obj_history_where_field := 'c.check4_no=hd.store_no';
         obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.store_id obj_id,hd.store_code obj_code,hd.store_name obj_name';
         obj_group_field := 'hd.store_id,hd.store_code,hd.store_name';
      else
         table_name := '';
         obj_where_field := '';
      end if;

      /*科目查询方式*/
      if subj_select_flag=2 then
          --2直接选择查询,
          subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
      elsif subj_select_flag=3 then
          --3按范围查询,
          subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
          subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
          subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
      elsif subj_select_flag=4 then
         --4弹出页面筛选查询
         --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
         subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
                         and a.subj_code in('||subj_code||') ';   
         subj_wheresql:=' and hs.subj_id in('||subj_id||') '; 
      else
        --1查询全部
         subj_wheresql:=' ';
      end if;


      /*项目查询方式*/
      if obj_select_flag=2 then
          --2直接选择查询,
          obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
      elsif obj_select_flag=3 then
          --3按范围查询,
          obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
          obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
          obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
      elsif obj_select_flag=4 then
         --4弹出页面筛选查询
         obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
      else
        --1查询全部
         obj_wheresql:=' ';
      end if;

      --项目显示方式:0历史数据，1最新数据
      SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
      IF num = 0 THEN
           obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
      else
           obj_sql:=' and hd.is_stop=0 ';--显示最新数据
      end if;
      
      if is_happend = 1 then
           happen_where:='where (exists(
                                select 1 from t_groupaccsubjobjledger_result t1
                                where t1.subj_code=t.subj_code 
                                      and TO_NUMBER(t1.acc_year||''''||t1.acc_month) 
                                      between TO_NUMBER('||acc_year_b||''||acc_month_b||') 
                                      and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                      ))';
         else
           happen_where:='';
      end if;
      /*条件处理end*/

      /*明细账需要拼辅助核算字段*/
      check_insertsql:='';
      check_selectsql:='';
      check_joinsql:='';
      --check_resultsql:='';
      declare
          check_i integer;
          dict_show_para integer;
          dict_show_sql varchar2(100);
          TYPE ref_type IS REF CURSOR;--定义游标指针
          v_cursor ref_type;--定义游标变量
          check_type_id numeric(18);
          check_table varchar2(50);
          is_sys integer;
          column_id varchar2(50);
          column_no varchar2(50);
          column_code varchar2(50);
          column_name varchar2(50);
          column_check varchar2(50);
          is_change integer;
      begin
        check_i:=0;
        --dbms_output.put_line(ddl_sql);
        OPEN v_cursor FOR '
            select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
            where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
            and exists(
              select 1 from ACC_SUBJ hs
              where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
               '||subj_wheresql||'
              and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
              and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
            ) and b.check_type_id<>3
            order by b.sort_code'
            using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
        LOOP
        FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中

          EXIT WHEN v_cursor%NOTFOUND;
          check_i:=check_i+1;

          --系统核算
          if is_sys=1 then

              --有变更表需要取显示方式的参数
              dict_show_sql:='';
              if is_change=1 then
                  SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                  IF dict_show_para = 0 THEN
                       dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check'||check_type_id||'_no ';--显示历史数据
                  else
                       dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                  end if;
                 --要拼成的结果语句
                 --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                 --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
              end if;

              check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
              check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check'||check_type_id||'_id '||dict_show_sql;
              --要拼成的结果语句
              --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
              --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;

          --自定义核算
          elsif is_sys=0 then
                check_selectsql:=check_selectsql||','||column_check;
              --check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
              --where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
              --and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;
             --要拼成的结果语句
             /* ,(select check_item_code||' '||check_item_name from acc_check_item item
              where exists(
              select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
              and item.check_item_id=avz.check_item_id and avz.check_type_id=29
              )) check_name2*/


          end if;
          check_insertsql:=check_insertsql||',check'||check_i;

        /*只支持同时挂4个辅助核算*/
        if check_i=4 then
          exit;
        end if;
        end loop;
        CLOSE v_cursor;--关闭游标
      end;

      if acc_month_b='01' then

        /*年初余额*/
        summary:='上年结转';
        --dbms_output.put_line(ddl_sql);
        execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,
        obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select 1,''0000'',''00'','||obj_show_field||',''上年结转'',sum(c.sum_od),sum(c.sum_oc),1,sum(case when hs.subj_dire=1 then c.end_os else c.end_os*(-1) end) 
       ,hs.is_check  from acc_leder_check c
        inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
        inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
        left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
        where c.group_id=:group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
        '||subj_wheresql||'
        '||obj_wheresql||'
        '||source_wheresql||'
        group by '||obj_group_field||',hs.is_check'
        using group_id,acc_year_b;

      else

        /*期初余额*/
        summary:='期初余额';
        --dbms_output.put_line(ddl_sql);
        execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select 1,''0000'',''00'',t1.obj_id,t1.obj_code,t1.obj_name,''期初余额'',sum(t1.debit),sum(t1.credit),1,sum(t1.end_os),t1.is_check from
        (
          select '||obj_show_field||',sum(c.sum_od) debit,sum(c.sum_oc) credit,1,sum(case when hs.subj_dire=1 then c.end_os else c.end_os*(-1) end) end_os ,hs.is_check
          from acc_leder_check c
          inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where c.group_id=:group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          group by '||obj_group_field||',hs.subj_dire,hs.is_check
          union all
          select '||obj_show_field||',sum(c.debit) debit,sum(c.credit) credit,1,
          sum(c.credit-c.debit) end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
          and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          group by '||obj_group_field||',hs.subj_dire,hs.is_check
         ) t1 group by t1.obj_id,t1.obj_code,t1.obj_name,t1.is_check'
         using group_id,acc_year_b,
        group_id,state,acc_year_b,acc_month_b;

      end if;

      /*本月合计数据*/
      execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month
      ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
      select 2,v.acc_year,v.acc_month
      ,'||obj_show_field||',''本月合计'',sum(c.debit),sum(c.credit),1,
       sum(c.credit)-sum(c.debit)  end_os,hs.is_check
      from acc_vouch_check c
      left join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
      inner join acc_vouch_type t on v.group_id=t.group_id 
            and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
      inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
      inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
      left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
      where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
      and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
      '||subj_wheresql||'
      '||obj_wheresql||'
      '||source_wheresql||'
      group by v.acc_year,v.acc_month,'||obj_group_field||',hs.is_check
      ' using group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;


      /*计算本月合计余额*/
      --dbms_output.put_line(ddl_sql);
      execute immediate '
      declare
        end_os_sum numeric(19,2);
        end_os_month numeric(19,2);
        obj_id numeric(18);
        xh integer;
        i number;
      begin
        i:=1;
        obj_id:=0;
        end_os_month:=0;
        for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccsubjobjledger_result r
          where r.xh<3
          order by r.obj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop

          /*新的项目从0开始计算*/
          if obj_id<>cr.obj_id then
            end_os_sum:=0;
           
            if (cr.xh=2 ) or (i=1 and cr.xh>1) then
               
               
                 if cr.acc_month = ''01'' then
                       insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''上年结转'',0);
           
                 else
                   
                        insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''期初余额'',0);
           
                 end if;
           
            end if;  
            
          end if;
          
            if obj_id=cr.obj_id and cr.xh=2 and xh!=1 then
    
           insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_dire,summary,end_os)
                  values( 1,cr.acc_year,cr.acc_month,cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_dire,''期初余额'',end_os_sum);
            
            end if;

          end_os_sum:=end_os_sum+cr.end_os;

          /*本月合计余额*/
          if cr.xh=2 then
             update t_groupaccsubjobjledger_result set end_os=end_os_sum where xh=2 and obj_id=cr.obj_id
             and acc_year = cr.acc_year and acc_month=cr.acc_month;
          end if;

          i:=i+1;
          obj_id:=cr.obj_id;
          xh:=cr.xh;
        end loop;
      end;
      ';

      /*本年累计数据*/
      ddl_sql:='insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
      select 3,t1.acc_year,t1.acc_month,t1.obj_id,t1.obj_code,t1.obj_name,''本年累计'',
      t1.debit+nvl((select sum(r1.debit) from t_groupaccsubjobjledger_result r1 where r1.xh=1 and r1.debit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||''' ),0),
      t1.credit+nvl((select sum(r1.credit) from t_groupaccsubjobjledger_result r1 where r1.xh=1 and r1.credit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
      1,t1.end_os ,t1.is_check from
        (select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,subj_code,subj_name,
        sum(r.debit) over(partition by r.acc_year,r.obj_id order by r.acc_month) debit,
        sum(r.credit) over(partition by r.acc_year,r.obj_id order by r.acc_month) credit,
        r.subj_dire,r.end_os,r.is_check
        from t_groupaccsubjobjledger_result r
        where r.xh=2
       ) t1

      ';
      --dbms_output.put_line(ddl_sql);
      execute immediate ddl_sql;

      /*返回结果集游标*/
      ddl_sql:='select 
           case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
          case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
          t.obj_code||'' ''||t.obj_name obj_name
          ,t.summary,
          case when t.xh=1 then NULL else t.debit end debit,
          case when t.xh=1 then NULL else t.credit end credit,
          case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
      from t_groupaccsubjobjledger_result t
     
      order by t.obj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.subj_code desc,t.is_check
      ';
      --dbms_output.put_line(ddl_sql);
      open objdata for ddl_sql;

  END group_subjobjgeneralled_xm;
	
	]]></sql>
	
	<sql id="group_subjobjdetail_xm" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_subjobjdetail_xm

  /*集团===科目项目明细账*/
  (
   group_id number,
   hos_id number,
   copy_code varchar2,
   acc_year_b varchar2,
   acc_month_b varchar2,
   acc_year_e varchar2,
   acc_month_e varchar2,
   state integer,--包含未记账:1,99
   is_happend integer,--无发生不显示期初余额0,1
   subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
   obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
   source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
   table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
   rela_code varchar2,--集团化管理   账套查询
   objdata OUT ACT_BOOKS.subjobjcursor
   )
  IS
      ddl_sql varchar2(4000);
      obj_sql varchar2(200);
      table_name varchar2(200);--动态表名称
      obj_code_where_field varchar2(200);--查询所用的动态字段编码
      obj_id_where_field varchar2(200);--查询所用的动态字段id
      obj_name_where_field varchar2(200);--查询所用的动态字段名称
      obj_spell_where_field varchar2(200);--查询所用的动态字段拼音码
      obj_wbx_where_field varchar2(200);--查询所用的动态字段五笔码
      obj_history_where_field varchar2(200);--历史记录动态条件
      obj_show_field varchar2(200);--要显示的动态字段
      obj_group_field varchar2(200);--要分组的动态字段
      obj_where_field varchar2(200);--id关联动态条件
      subj_code_begin varchar2(200);--开始科目编码
      subj_code_end varchar2(200);--结束科目编码
      obj_code_begin varchar2(200);--开始项目编码
      obj_code_end varchar2(200);--结束项目编码
      check_insertsql varchar2(500);--辅助核算添加动态字段
      check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
      check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
      --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
      source_wheresql varchar2(200);
      subj_wheresql varchar2(4000);
      obj_wheresql varchar2(4000);
      summary varchar2(20);
      subj_id varchar2(4000) ;
      num NUMBER;
  BEGIN

      /*条件处理begin*/
      if source_id='0' then
           source_wheresql:='';--资源来源ID
      else
           source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
      end if;


      if table_flag  = 1 then
         table_name := 'hos_dept_dict';
         obj_code_where_field := 'dept_code';
         obj_id_where_field := 'dept_id';
         obj_name_where_field := 'dept_name';
         obj_spell_where_field := 'spell_code';
         obj_wbx_where_field := 'wbx_code';
         obj_history_where_field := 'c.check1_no=hd.dept_no';
         obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.dept_id obj_id,hd.dept_code obj_code,hd.dept_name obj_name';
         obj_group_field := 'hd.dept_id,hd.dept_code,hd.dept_name';
      elsif table_flag = 2 then
         table_name := 'hos_emp_dict';
         obj_code_where_field := 'emp_code';
         obj_id_where_field := 'emp_id';
         obj_name_where_field := 'emp_name';
         obj_spell_where_field := 'spell_code';
         obj_wbx_where_field := 'wbx_code';
         obj_history_where_field := 'c.check2_no=hd.emp_no';
         obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.emp_id obj_id,hd.emp_code obj_code,hd.emp_name obj_name';
         obj_group_field := 'hd.emp_id,hd.emp_code,hd.emp_name';
      elsif table_flag = 3 then
         table_name := 'hos_proj_dict';
         obj_code_where_field := 'proj_code';
         obj_id_where_field := 'proj_id';
         obj_name_where_field := 'proj_name';
         obj_spell_where_field := 'spell_code';
         obj_wbx_where_field := 'wbx_code';
         obj_history_where_field := 'c.check3_no=hd.proj_no';
         obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.proj_id obj_id,hd.proj_code obj_code,hd.proj_name obj_name';
         obj_group_field := 'hd.proj_id,hd.proj_code,hd.proj_name';
      elsif table_flag = 6 then
         table_name := 'hos_sup_dict';
         obj_code_where_field := 'sup_code';
         obj_id_where_field := 'sup_id';
         obj_name_where_field := 'sup_name';
         obj_spell_where_field := 'spell_code';
         obj_wbx_where_field := 'wbx_code';
         obj_history_where_field := 'c.check6_no=hd.sup_no';
         obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.sup_id obj_id,hd.sup_code obj_code,hd.sup_name obj_name';
         obj_group_field := 'hd.sup_id,hd.sup_code,hd.sup_name';
      elsif table_flag = 5 then
         table_name := 'hos_cus_dict';
         obj_code_where_field := 'cus_code';
         obj_id_where_field := 'cus_id';
         obj_name_where_field := 'cus_name';
         obj_spell_where_field := 'spell_code';
         obj_wbx_where_field := 'wbx_code';
         obj_history_where_field := 'c.check5_no=hd.cus_no';
         obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.cus_id obj_id,hd.cus_code obj_code,hd.cus_name obj_name';
         obj_group_field := 'hd.cus_id,hd.cus_code,hd.cus_name';
      elsif table_flag = 4 then
         table_name := 'hos_store_dict';
         obj_code_where_field := 'store_code';
         obj_id_where_field := 'store_id';
         obj_name_where_field := 'store_name';
         obj_spell_where_field := 'spell_code';
         obj_wbx_where_field := 'wbx_code';
         obj_history_where_field := 'c.check4_no=hd.store_no';
         obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.store_id obj_id,hd.store_code obj_code,hd.store_name obj_name';
         obj_group_field := 'hd.store_id,hd.store_code,hd.store_name';
      else
         table_name := '';
         obj_where_field := '';
      end if;

      /*科目查询方式*/
      if subj_select_flag=2 then
          --2直接选择查询,
          subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
      elsif subj_select_flag=3 then
          --3按范围查询,
          subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
          subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
          subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
      elsif subj_select_flag=4 then
         --4弹出页面筛选查询
         --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
         subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||'''
                         and a.subj_code in('||subj_code||') ';
     subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
      else
        --1查询全部
         subj_wheresql:=' ';
      end if;

      /*项目查询方式*/
      if obj_select_flag=2 then
          --2直接选择查询,
            obj_wheresql:=' and (hd.'||obj_code_where_field||' like ''%'||  obj_code||'%'' or
                                   hd.'||obj_name_where_field||' like ''%'||obj_code||'%'' or
                                   hd.'||obj_spell_where_field||'   like ''%'|| UPPER (obj_code)||'%'' or
                                   hd.'||obj_wbx_where_field||'  like ''%'|| UPPER (obj_code) ||'%''
                                   ) ';
       /*   obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
      elsif obj_select_flag=3 then
          --3按范围查询,
          obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
          obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
          obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
      elsif obj_select_flag=4 then
         --4弹出页面筛选查询
         obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';*/
      else
        --1查询全部
         obj_wheresql:=' ';
      end if;

      --项目显示方式:0历史数据，1最新数据
      SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
      IF num = 0 THEN
           obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
      else
           obj_sql:=' and hd.is_stop=0 ';--显示最新数据
      end if;
      /*条件处理end*/

      /*明细账需要拼辅助核算字段*/
      check_insertsql:='';
      check_selectsql:='';
      check_joinsql:='';
      --check_resultsql:='';
      declare
          check_i integer;
          dict_show_para integer;
          dict_show_sql varchar2(100);
          TYPE ref_type IS REF CURSOR;--定义游标指针
          v_cursor ref_type;--定义游标变量
          check_type_id numeric(18);
          check_table varchar2(50);
          is_sys integer;
          column_id varchar2(50);
          column_no varchar2(50);
          column_code varchar2(50);
          column_name varchar2(50);
          column_check varchar2(50);
          is_change integer;
      begin
        check_i:=0;
        --dbms_output.put_line(ddl_sql);
        OPEN v_cursor FOR '
            select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
            where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
            and exists(
              select 1 from ACC_SUBJ hs
              where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
               '||subj_wheresql||'
             -- and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
              and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
            ) and b.check_type_id<>3
            order by b.sort_code'
            using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
        LOOP
        FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中

          EXIT WHEN v_cursor%NOTFOUND;
          check_i:=check_i+1;

          --系统核算
          if is_sys=1 then

              --有变更表需要取显示方式的参数
              dict_show_sql:='';
              if is_change=1 then
                  SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                  IF dict_show_para = 0 THEN
                       dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check3_no ';--显示历史数据
                  else
                       dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                  end if;
                 --要拼成的结果语句
                 --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                 --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
              end if;

              check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
              check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check3_id '||dict_show_sql;
              --要拼成的结果语句
              --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
              --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;

          --自定义核算
          elsif is_sys=0 then
                check_selectsql:=check_selectsql||','||column_check;
              --check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
              --where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
              --and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;
             --要拼成的结果语句
             /* ,(select check_item_code||' '||check_item_name from acc_check_item item
              where exists(
              select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
              and item.check_item_id=avz.check_item_id and avz.check_type_id=29
              )) check_name2*/


          end if;
          check_insertsql:=check_insertsql||',check'||check_i;

        /*只支持同时挂4个辅助核算*/
        if check_i=4 then
          exit;
        end if;
        end loop;
        CLOSE v_cursor;--关闭游标
      end;

      if acc_month_b='01' then

        /*年初余额*/
        summary:='上年结转';
        --dbms_output.put_line(ddl_sql);
        execute immediate 'insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os)
        select 1,''0000'',''00'','||obj_show_field||',''上年结转'',sum(c.sum_od),sum(c.sum_oc),1,sum(case when hs.subj_dire=1 then c.end_os else c.end_os*(-1) end) from acc_leder_check c
        inner join acc_subj hs on hs.subj_id=c.subj_id
        inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
        left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
        where c.group_id=:group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
        '||subj_wheresql||'
        '||obj_wheresql||'
        '||source_wheresql||'
        group by '||obj_group_field
        using group_id,acc_year_b;

      else

        /*期初余额*/
        summary:='期初余额';
        --dbms_output.put_line(ddl_sql);
        execute immediate 'insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os)
        select 1,''0000'',''00'',t1.obj_id,t1.obj_code,t1.obj_name,''期初余额'',sum(t1.debit),sum(t1.credit),1,sum(t1.end_os) from
        (
          select '||obj_show_field||',sum(c.sum_od) debit,sum(c.sum_oc) credit,1 subj_dire,sum(case when hs.subj_dire=1 then c.end_os else c.end_os*(-1) end) end_os  from acc_leder_check c
          inner join acc_subj hs on hs.subj_id=c.subj_id
          inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where c.group_id=:group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          group by '||obj_group_field||'
          union all
          select '||obj_show_field||',sum(c.debit) debit,sum(c.credit) credit,1 subj_dire,
          sum(c.credit-c.debit) end_os
          from acc_vouch_check c
          inner join acc_vouch v on v.vouch_id=c.vouch_id
          inner join acc_subj hs on hs.subj_id=c.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
          and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          group by '||obj_group_field||'
         ) t1 group by t1.obj_id,t1.obj_code,t1.obj_name'
         using group_id,acc_year_b,
        group_id,state,acc_year_b,acc_month_b;

      end if;


      /*本期发生凭证数据*/
      execute immediate 'insert into t_groupaccsubjobj_result(check_id,xh,acc_year,acc_month,vouch_date,vouch_no,vouch_id
      ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os)
      select c.vouch_check_id,2,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no vouch_no,c.vouch_id
      ,'||obj_show_field||',c.summary,c.debit,c.credit,1,
       c.credit-c.debit  end_os
      from acc_vouch_check c
      inner join acc_vouch v on v.vouch_id=c.vouch_id
      inner join acc_vouch_type t on t.vouch_type_code=v.vouch_type_code and t.group_id=v.group_id and t.hos_id=v.hos_id and t.copy_code=v.copy_code
      inner join acc_subj hs on hs.subj_id=c.subj_id
      inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
      left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
      where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
      and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
      '||subj_wheresql||'
      '||obj_wheresql||'
      '||source_wheresql||'
      order by v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date
      ' using group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;

      /*本月合计数据*/
      ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os)
      select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本月合计'',sum(r.debit),sum(r.credit),1,0 end_os
      from t_groupaccsubjobj_result r
      where r.xh=2
      group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name
      ';
      --dbms_output.put_line(ddl_sql);
      execute immediate ddl_sql;

      /*计算本期发生凭证、本月合计余额*/
      --dbms_output.put_line(ddl_sql);
      execute immediate '
      declare
        end_os_sum numeric(19,2);
        end_os_month numeric(19,2);
        obj_id numeric(18);
         acc_month_y varchar2(2);
        xh integer;
        i number;
      begin
        i:=1;
        obj_id:=0;
        end_os_month:=0;
        for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.subj_code,r.subj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccsubjobj_result r
          where r.xh<4
          order by r.obj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.vouch_no asc,r.check_id asc) loop

          /*新的项目从0开始计算*/
          if obj_id<>cr.obj_id then
            end_os_sum:=0;

            /*有发生数据没有期初余额新增加一条期初余额*/
            if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then

                  if cr.acc_month = ''01'' then
            insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,''上年结转'',0);

            else
              insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,''期初余额'',0);

             end if;

            end if;
          end if;

            if obj_id=cr.obj_id and cr.xh=2 and xh!=1 then

            if (acc_month_y!=cr.acc_month) then
                insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,subj_dire,summary,end_os)
                  values( 1,cr.acc_year,cr.acc_month,cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);


           end if;
          end if;

          end_os_sum:=end_os_sum+cr.end_os;

          /*本期发生凭证余额*/
          if cr.xh=2 then
             update t_groupaccsubjobj_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
          end if;
          /*本月合计余额*/
          if cr.xh=3 then
             update t_groupaccsubjobj_result set end_os=end_os_sum where xh=3 and obj_id=cr.obj_id
             and acc_year = cr.acc_year and acc_month=cr.acc_month;
          end if;

          i:=i+1;
          obj_id:=cr.obj_id;
          acc_month_y:=cr.acc_month;
          xh:=cr.xh;
        end loop;
      end;
      ';

      /*本年累计数据*/
      ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os)
      select 4,t1.acc_year,t1.acc_month,t1.obj_id,t1.obj_code,t1.obj_name,''本年累计'',
      t1.debit+nvl((select r1.debit from t_groupaccsubjobj_result r1 where r1.xh=1 and r1.debit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
      t1.credit+nvl((select r1.credit from t_groupaccsubjobj_result r1 where r1.xh=1 and r1.credit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
      1,t1.end_os from
        (select 4,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,
        sum(r.debit) over(partition by r.acc_year,r.obj_id order by r.acc_month) debit,
        sum(r.credit) over(partition by r.acc_year,r.obj_id order by r.acc_month) credit,
        r.subj_dire,r.end_os
        from t_groupaccsubjobj_result r
        where r.xh=3
       ) t1

      ';
      --dbms_output.put_line(ddl_sql);
      execute immediate ddl_sql;

      /*返回结果集游标*/
      ddl_sql:='select
      case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
      case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
      to_char(t.vouch_date,''dd'') day,t.vouch_no,t.vouch_id,
      t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||'
      ,t.subj_code||'' ''||t.subj_name subj_name,t.summary,
      case when t.xh=1 then NULL else t.debit end debit,
      case when t.xh=1 then NULL else t.credit end credit,
      case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os
      from t_groupaccsubjobj_result t
      where '||is_happend||'=0 or
      (exists(select 1 from t_groupaccsubjobj_result t1
      where t1.obj_id=t.obj_id and '||is_happend||'=1
      and TO_NUMBER(t1.acc_year||''''||t1.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
      ))--无发生不显示期初余额0,1
      order by t.obj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date asc ,t.vouch_no asc,t.check_id asc
      ';
      --dbms_output.put_line(ddl_sql);
      open objdata for ddl_sql using acc_year_b,acc_month_b,acc_year_e,acc_month_e;

  END group_subjobjdetail_xm;
		
	
		
	]]></sql>
	
	<sql id="group_balancedetail_xm" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_balancedetail_xm
       /*集团===项目余额表*/
      (prm_group_id        number,
       prm_hos_id          number,
       prm_copy_code       varchar2,
       prm_acc_year_b      varchar2,
       prm_acc_month_b     varchar2,
       prm_acc_year_e      varchar2,
       prm_acc_month_e     varchar2,
       prm_is_state        integer, --包含未记账:1,99
       prm_is_end_os       integer, --显示有余额的项目:0,1
       prm_emp_code        varchar2, --项目负责人
       prm_cur_code        varchar2, --币种
       prm_obj_select_flag integer, --项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_obj_code        varchar2, --项目条件多个值用逗号分隔。参数格式：1='，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       prm_subj_select_flag integer, --项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_subj_code        varchar2, --项目条件多个值用逗号分隔。参数格式：1='，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       prm_rela_code varchar2,--集团化管理   账套查询
       cur_objdata         OUT ACT_BOOKS.balancecursor)

       IS

        ddl_sql      varchar2(4000);
        obj_wheresql varchar2(4000);
        emp_wheresql varchar2(100);
        endOsWhere   varchar2(100);
        subj_wheresql varchar2(4000);
        subj_code_begin varchar2(200);--开始科目编码
        subj_code_end varchar2(200);--结束科目编码
        subj_id varchar2(4000) ;
        num NUMBER;

      BEGIN

        /*项目查询方式*/
        if prm_obj_select_flag = 2 then
          --2直接选择查询,
          /*obj_wheresql := ' and obj_code like ''' || prm_obj_code || '%'' ';*/

         obj_wheresql:=' and ( obj_code like ''%'||  prm_obj_code||'%'' or
                               obj_name like ''%'||prm_obj_code||'%'' or
                               spell_code like ''%'|| UPPER (prm_obj_code)||'%'' or
                               wbx_code like ''%'|| UPPER (prm_obj_code) ||'%''
                                   ) ';

      /*  elsif prm_obj_select_flag = 3 then
          --3按范围查询,
          obj_wheresql := ' and obj_code between ' ||
                          regexp_substr(prm_obj_code, '[^,]+', 1, 1, 'i') ||
                          ' and ' ||
                          regexp_substr(prm_obj_code, '[^,]+', 1, 2, 'i') || ' ';
        elsif prm_obj_select_flag = 4 then
          --4弹出页面筛选查询
          obj_wheresql := ' and obj_id in(' || prm_obj_code || ') ';*/
        else
          --1查询全部
          obj_wheresql := '';
        end if;

        /*项目负责人*/
        if prm_emp_code = '' then
          --2直接选择查询,
          emp_wheresql := ' and apa.con_emp_id = '' || prm_emp_code || '' ';
        else
          emp_wheresql := '';
        end if;

        /*科目查询方式*/
          if prm_subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and subj_code like '''||prm_subj_code||'%'' ';
          elsif prm_subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(prm_subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(prm_subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif prm_subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||prm_group_id||' and a.hos_id  = '||prm_hos_id||' and a.copy_code= '''||prm_copy_code||'''
                         and a.subj_code in('||prm_subj_code||') ';
             subj_wheresql:=' and subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;


       /*是否显示余额项目*/
        if prm_is_end_os = 1 then
          --2直接选择查询,
          endOsWhere := ' and nvl(end_credit,0)-nvl(end_debit,0) !=0 ';
        else
          endOsWhere := '';
        end if;

      if prm_subj_code = '' then

        insert into t_groupbalancedetail_result_xm (
         idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit,
         is_check,subj_id,subj_code,spell_code,wbx_code
        )
       select 1 as idx,
          tempa1.check3_id,
          tempe1.proj_code,
          tempe1.proj_name,
          case when tempa1.subj_dire = 0 then  nvl(tempb1.nc_debit,0)-nvl(tempb1.nc_credit,0) end as nc_debit,   --年初余额 借
          case when tempa1.subj_dire = 1 then nvl(tempb1.nc_credit,0)-nvl(tempb1.nc_debit,0) end as nc_credit,   --年初余额 贷
          case when tempa1.subj_dire = 0 then (nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0))-(nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)) end as qc_debit,  --期初余额 借
          case when tempa1.subj_dire = 1 then (nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0))-(nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)) end as qc_credit, --期初余额 贷
          nvl(tempd1.bq_debit,0),  --本期发生 借
          nvl(tempd1.bq_credit,0),   --本期发生 贷
          nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0),  --累计发生 借
          nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0),  --累计发生 贷
          case when tempa1.subj_dire = 0 then (nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0))-(nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0)) end as end_debit,  --期末余额 借
          case when tempa1.subj_dire = 1 then (nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0))-(nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0)) end as end_credit, --期末余额 贷
          tempb1.is_check,
          tempa1.subj_id,
          tempa1.subj_code,
          tempe1.spell_code,
          tempe1.wbx_code

       from (
            --有数据的科目
            select a.check3_id,a.check3_no,a.group_id,a.hos_id,a.copy_code,a.acc_year,a.subj_id,b.subj_code,b.subj_dire
            from acc_leder_check a
            left join acc_subj b on a.group_id = b.group_id and a.hos_id= b.hos_id and a.copy_code = b.copy_code and a.subj_id = b.subj_id
            left join hos_copy_rela hcr on a.group_id = hcr.group_id and a.hos_id = hcr.hos_id and a.copy_code = hcr.copy_code
            where a.group_id=prm_group_id
                and hcr.rela_code in (prm_rela_code)
                and a.acc_year = prm_acc_year_b
                and nvl(a.check3_id,0)!=0
                and TO_NUMBER(a.acc_year||''||a.acc_month) between TO_NUMBER(prm_acc_year_b||'00') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
                and nvl(a.end_os,0)!=0
            union
            select a1.check3_id,a1.check3_no,a1.group_id,a1.hos_id,a1.copy_code,a1.acc_year,a1.subj_id,c1.subj_code,c1.subj_dire  from acc_vouch_check a1
            left join acc_vouch b1 on a1.group_id= b1.group_id and a1.hos_id=b1.hos_id and a1.copy_code=b1.copy_code
                 and a1.acc_year = b1.acc_year and a1.vouch_id=b1.vouch_id
            left join acc_subj c1 on a1.group_id = c1.group_id and a1.hos_id = c1.hos_id and a1.copy_code = c1.copy_code and a1.subj_id = c1.subj_id
            left join hos_copy_rela hcr on b1.group_id = hcr.group_id and b1.hos_id = hcr.hos_id and b1.copy_code = hcr.copy_code
            where a1.group_id=prm_group_id and hcr.rela_code in (prm_rela_code)
                  and a1.acc_year = prm_acc_year_b
                  and b1.state>=prm_is_state
                  and nvl(a1.check3_id,0)!=0
                  and TO_NUMBER(b1.acc_year||''||b1.acc_month) between TO_NUMBER(prm_acc_year_b||'01') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
      ) tempa1  left join  (
           --年初余额
           select a2.check3_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,
                  sum(case when b2.subj_dire=0 then nvl(a2.end_os,0) else 0 end) nc_debit,
                  sum(case when b2.subj_dire=1 then  nvl(a2.end_os,0) else 0 end) nc_credit,
                  b2.is_check,a2.subj_id
           from acc_leder_check a2
           left join acc_subj b2 on a2.group_id =b2.group_id and a2.hos_id=b2.hos_id  and a2.copy_code=b2.copy_code
             and a2.acc_year = b2.acc_year  and a2.subj_id=b2.subj_id
           left join hos_copy_rela hcr on a2.group_id = hcr.group_id and a2.hos_id = hcr.hos_id and a2.copy_code = hcr.copy_code
           where a2.group_id=prm_group_id  and hcr.rela_code in (prm_rela_code)
              and a2.acc_year=prm_acc_year_b and a2.acc_month='00'
              and nvl(a2.check3_id,0)!=0
           group by a2.check3_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,b2.is_check,a2.subj_id
      ) tempb1 on tempa1.group_id =tempb1.group_id and tempa1.hos_id =tempb1.hos_id
        and tempa1.copy_code =tempb1.copy_code and tempa1.acc_year =tempb1.acc_year
        and tempa1.check3_id =tempb1.check3_id    and tempa1.subj_id = tempb1.subj_id
      left join  (

      --年初到开始日间中间数据
          select a.check3_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,
                 sum(nvl(a.debit,0)) bfs_debit,
                 sum(nvl(a.credit,0)) bfs_credit ,a.subj_id
          from  acc_vouch b
          left join  acc_vouch_check a on b.group_id = a.group_id and  b.hos_id = a.hos_id
               and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id
          left join acc_subj c on a.group_id = c.group_id and a.hos_id = c.group_id  and a.copy_code= c.copy_code and a.subj_id = c.subj_id
          left join hos_copy_rela hcr on b.group_id = hcr.group_id and b.hos_id = hcr.hos_id and b.copy_code = hcr.copy_code
          where a.group_id=prm_group_id and hcr.rela_code in (prm_rela_code)
                and b.acc_year = prm_acc_year_b
                and b.state>=prm_is_state
                and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||'01'
                and TO_NUMBER(b.acc_year||''||b.acc_month) < prm_acc_year_b||''||prm_acc_month_b
                and nvl(a.check3_id,0)!=0
                and a.vouch_id
              --  not
                  in  (
                    select av.vouch_id from acc_vouch_check avc
                    left join acc_vouch av on avc.group_id = av.group_id and avc.hos_id = av.hos_id and avc.copy_code=av.copy_code
                         and avc.acc_year = av.acc_year and avc.vouch_id=av.vouch_id
                    where avc.group_id=prm_group_id and avc.hos_id=prm_hos_id and avc.copy_code=prm_copy_code
                          and avc.acc_year = prm_acc_year_b
                          and avc.subj_id in  (
                              select acs.subj_id from acc_subj acs
                              where acs.group_id=prm_group_id and acs.hos_id=prm_hos_id and acs.copy_code=prm_copy_code
                                    and acs.acc_year=prm_acc_year_b
                                    and acs.subj_code like '3'||'%'
                          )
                )
               group by a.check3_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id


      ) tempc1 on tempa1.group_id =tempc1.group_id and tempa1.hos_id =tempc1.hos_id
        and tempa1.copy_code =tempc1.copy_code and tempa1.acc_year =tempc1.acc_year
        and tempa1.check3_id =tempc1.check3_id    and tempa1.subj_id = tempc1.subj_id
      left join (
            -- 本期发生数据
            select a.check3_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,
                   sum(nvl(a.debit,0)) bq_debit,
                   sum(nvl(a.credit,0)) bq_credit ,a.subj_id
            from   acc_vouch b
            left join acc_vouch_check a  on b.group_id=a.group_id and b.hos_id=a.hos_id
                 and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id
            left join acc_subj c on a.group_id = c.group_id and a.hos_id = c.group_id  and a.copy_code= c.copy_code and a.subj_id= c.subj_id
            left join hos_copy_rela hcr on b.group_id = hcr.group_id and b.hos_id = hcr.hos_id and b.copy_code = hcr.copy_code
            where a.group_id=prm_group_id and hcr.rela_code in (prm_rela_code)
                  and a.acc_year=prm_acc_year_b
                  and b.state>=prm_is_state
                  and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||''||prm_acc_month_b
                  and TO_NUMBER(b.acc_year||''||b.acc_month) <= prm_acc_year_e||''||prm_acc_month_e
                  and nvl(a.check3_id,0)!=0
                  and a.vouch_id
                 -- not
                  in  (
                      select av.vouch_id from acc_vouch_check avc
                      left join acc_vouch av on avc.group_id=av.group_id and avc.hos_id=av.hos_id and avc.copy_code=av.copy_code
                           and avc.acc_year = av.acc_year and avc.vouch_id=av.vouch_id
                      where avc.group_id=prm_group_id and avc.hos_id=prm_hos_id and avc.copy_code=prm_copy_code
                            and avc.acc_year = prm_acc_year_b
                            and avc.subj_id in (
                                select acs.subj_id from acc_subj acs
                                where acs.group_id=prm_group_id and acs.hos_id=prm_hos_id and acs.copy_code=prm_copy_code
                                      and acs.acc_year = prm_acc_year_b
                                      and acs.subj_code like '3'||'%'
                            )
                  )
            group by a.check3_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id
      ) tempd1 on tempa1.group_id =tempd1.group_id and tempa1.hos_id =tempd1.hos_id
        and tempa1.copy_code =tempd1.copy_code and tempa1.acc_year =tempd1.acc_year
        and tempa1.check3_id =tempd1.check3_id    and tempa1.subj_id = tempd1.subj_id
      left join hos_proj_dict  tempe1 on  tempa1.group_id =tempe1.group_id and tempa1.hos_id = tempe1.hos_id
      and  tempa1.check3_id =tempe1.proj_id and  tempa1.check3_no =tempe1.proj_no  ;

      else

        insert into t_groupbalancedetail_result_xm (
         idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit,
         is_check,subj_id,subj_code,spell_code,wbx_code
        )

       select 1 as idx,
          tempa1.check3_id,
          tempe1.proj_code,
          tempe1.proj_name,
          case when tempa1.subj_dire = 0 then  nvl(tempb1.nc_debit,0)-nvl(tempb1.nc_credit,0) end as nc_debit,   --年初余额 借
          case when tempa1.subj_dire = 1 then nvl(tempb1.nc_credit,0)-nvl(tempb1.nc_debit,0) end as nc_credit,   --年初余额 贷
          case when tempa1.subj_dire = 0 then (nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0))-(nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)) end as qc_debit,  --期初余额 借
          case when tempa1.subj_dire = 1 then (nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0))-(nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)) end as qc_credit, --期初余额 贷
          nvl(tempd1.bq_debit,0),  --本期发生 借
          nvl(tempd1.bq_credit,0),   --本期发生 贷
          nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0),  --累计发生 借
          nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0),  --累计发生 贷
          case when tempa1.subj_dire = 0 then (nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0))-(nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0)) end as end_debit,  --期末余额 借
          case when tempa1.subj_dire = 1 then (nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0))-(nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0)) end as end_credit, --期末余额 贷
          tempb1.is_check,
          tempa1.subj_id,
          tempa1.subj_code,
          tempe1.spell_code,
          tempe1.wbx_code

       from (
            --有数据的科目
            select a.check3_id,a.check3_no,a.group_id,a.hos_id,a.copy_code,a.acc_year,a.subj_id,b.subj_code,b.subj_dire
            from acc_leder_check a
            left join acc_subj b on a.group_id = b.group_id and a.hos_id= b.hos_id and a.copy_code = b.copy_code and a.subj_id = b.subj_id
            where a.group_id=prm_group_id
                and a.hos_id=prm_hos_id
                and a.copy_code=prm_copy_code
                and a.acc_year = prm_acc_year_b
                and nvl(a.check3_id,0)!=0
                and TO_NUMBER(a.acc_year||''||a.acc_month) between TO_NUMBER(prm_acc_year_b||'00') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
                and nvl(a.end_os,0)!=0
            union
            select a1.check3_id,a1.check3_no,a1.group_id,a1.hos_id,a1.copy_code,a1.acc_year,a1.subj_id,c1.subj_code,c1.subj_dire  from acc_vouch_check a1
            left join acc_vouch b1 on a1.group_id= b1.group_id and a1.hos_id=b1.hos_id and a1.copy_code=b1.copy_code
                 and a1.acc_year = b1.acc_year and a1.vouch_id=b1.vouch_id
            left join acc_subj c1 on a1.group_id = c1.group_id and a1.hos_id = c1.hos_id and a1.copy_code = c1.copy_code and a1.subj_id = c1.subj_id
            where a1.group_id=prm_group_id and a1.hos_id=prm_hos_id and a1.copy_code=prm_copy_code
                  and a1.acc_year = prm_acc_year_b
                  and b1.state>=prm_is_state
                  and nvl(a1.check3_id,0)!=0
                  and TO_NUMBER(b1.acc_year||''||b1.acc_month) between TO_NUMBER(prm_acc_year_b||'01') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
      ) tempa1  left join  (
           --年初余额
           select a2.check3_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,
                  sum(case when b2.subj_dire=0 then nvl(a2.end_os,0) else 0 end) nc_debit,
                  sum(case when b2.subj_dire=1 then  nvl(a2.end_os,0) else 0 end) nc_credit,
                  b2.is_check,a2.subj_id
           from acc_leder_check a2
           left join acc_subj b2 on a2.group_id =b2.group_id and a2.hos_id=b2.hos_id  and a2.copy_code=b2.copy_code
             and a2.acc_year = b2.acc_year  and a2.subj_id=b2.subj_id
           where a2.group_id=prm_group_id  and a2.hos_id=prm_hos_id and a2.copy_code=prm_copy_code
              and a2.acc_year=prm_acc_year_b and a2.acc_month='00'
              and nvl(a2.check3_id,0)!=0
           group by a2.check3_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,b2.is_check,a2.subj_id
      ) tempb1 on tempa1.group_id =tempb1.group_id and tempa1.hos_id =tempb1.hos_id
        and tempa1.copy_code =tempb1.copy_code and tempa1.acc_year =tempb1.acc_year
        and tempa1.check3_id =tempb1.check3_id    and tempa1.subj_id = tempb1.subj_id
      left join  (

      --年初到开始日间中间数据
         /* select a.check3_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,
                 sum(nvl(a.debit,0)) bfs_debit,
                 sum(nvl(a.credit,0)) bfs_credit ,a.subj_id
          from  acc_vouch b
          left join  acc_vouch_check a on b.group_id = a.group_id and  b.hos_id = a.hos_id
               and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id
          left join acc_subj c on a.group_id = c.group_id and a.hos_id = c.group_id  and a.copy_code= c.copy_code and a.subj_id = c.subj_id
          where a.group_id=prm_group_id and a.hos_id=prm_hos_id
                and a.copy_code=prm_copy_code
                and b.acc_year = prm_acc_year_b
                and b.state>=prm_is_state
                and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||'01'
                and TO_NUMBER(b.acc_year||''||b.acc_month) < prm_acc_year_b||''||prm_acc_month_b
                and nvl(a.check3_id,0)!=0
                and a.vouch_id
                not
                  in  (
                    select av.vouch_id from acc_vouch_check avc
                    left join acc_vouch av on avc.group_id = av.group_id and avc.hos_id = av.hos_id and avc.copy_code=av.copy_code
                         and avc.acc_year = av.acc_year and avc.vouch_id=av.vouch_id
                    where avc.group_id=prm_group_id and avc.hos_id=prm_hos_id and avc.copy_code=prm_copy_code
                          and avc.acc_year = prm_acc_year_b
                          and avc.subj_id in  (
                              select acs.subj_id from acc_subj acs
                              where acs.group_id=prm_group_id and acs.hos_id=prm_hos_id and acs.copy_code=prm_copy_code
                                    and acs.acc_year=prm_acc_year_b
                                    and acs.subj_code like '3'||'%'
                          )
                )
               group by a.check3_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id */

                select a.check3_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id,
           sum(nvl(a.debit,0)) bfs_debit,
           sum(nvl(a.credit,0)) bfs_credit
        from  acc_vouch b
        left join  acc_vouch_check a on b.group_id = a.group_id and  b.hos_id = a.hos_id
             and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id
        where a.group_id=prm_group_id and a.hos_id=prm_hos_id
              and a.copy_code=prm_copy_code
              and b.acc_year = prm_acc_year_b
              and b.state>=prm_is_state
              and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||'01'
              and TO_NUMBER(b.acc_year||''||b.acc_month) < prm_acc_year_b||''||prm_acc_month_b
              and nvl(a.check3_id,0)!=0
         group by a.check3_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id


      ) tempc1 on tempa1.group_id =tempc1.group_id and tempa1.hos_id =tempc1.hos_id
        and tempa1.copy_code =tempc1.copy_code and tempa1.acc_year =tempc1.acc_year
        and tempa1.check3_id =tempc1.check3_id    and tempa1.subj_id = tempc1.subj_id
      left join (
            -- 本期发生数据
           /* select a.check3_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,
                   sum(nvl(a.debit,0)) bq_debit,
                   sum(nvl(a.credit,0)) bq_credit ,a.subj_id
            from   acc_vouch b
            left join acc_vouch_check a  on b.group_id=a.group_id and b.hos_id=a.hos_id
                 and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id
            left join acc_subj c on a.group_id = c.group_id and a.hos_id = c.group_id  and a.copy_code= c.copy_code and a.subj_id= c.subj_id
            where a.group_id=prm_group_id and a.hos_id=prm_hos_id and a.copy_code=prm_copy_code
                  and a.acc_year=prm_acc_year_b
                  and b.state>=prm_is_state
                  and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||''||prm_acc_month_b
                  and TO_NUMBER(b.acc_year||''||b.acc_month) <= prm_acc_year_e||''||prm_acc_month_e
                  and nvl(a.check3_id,0)!=0
                  and a.vouch_id not in  (
                      select av.vouch_id from acc_vouch_check avc
                      left join acc_vouch av on avc.group_id=av.group_id and avc.hos_id=av.hos_id and avc.copy_code=av.copy_code
                           and avc.acc_year = av.acc_year and avc.vouch_id=av.vouch_id
                      where avc.group_id=prm_group_id and avc.hos_id=prm_hos_id and avc.copy_code=prm_copy_code
                            and avc.acc_year = prm_acc_year_b
                            and avc.subj_id in (
                                select acs.subj_id from acc_subj acs
                                where acs.group_id=prm_group_id and acs.hos_id=prm_hos_id and acs.copy_code=prm_copy_code
                                      and acs.acc_year = prm_acc_year_b
                                      and acs.subj_code like '3'||'%'
                            )
                  )
            group by a.check3_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id */


            select a.check3_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id,
                   sum(nvl(a.debit,0)) bq_debit,
                   sum(nvl(a.credit,0)) bq_credit
            from   acc_vouch b
            left join acc_vouch_check a  on b.group_id=a.group_id and b.hos_id=a.hos_id
                 and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id
            where a.group_id=prm_group_id and a.hos_id=prm_hos_id and a.copy_code=prm_copy_code
                  and a.acc_year =prm_acc_year_b  and b.state>=prm_is_state
                  and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||''||prm_acc_month_b
                  and TO_NUMBER(b.acc_year||''||b.acc_month) <= prm_acc_year_e||''||prm_acc_month_e
                  and nvl(a.check3_id,0)!=0
            group by a.check3_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id

      ) tempd1 on tempa1.group_id =tempd1.group_id and tempa1.hos_id =tempd1.hos_id
        and tempa1.copy_code =tempd1.copy_code and tempa1.acc_year =tempd1.acc_year
        and tempa1.check3_id =tempd1.check3_id    and tempa1.subj_id = tempd1.subj_id
      left join hos_proj_dict  tempe1 on  tempa1.group_id =tempe1.group_id and tempa1.hos_id = tempe1.hos_id
      and  tempa1.check3_id =tempe1.proj_id  and  tempa1.check3_no =tempe1.proj_no

      ;

      end if ;

      execute immediate '
               insert into t_groupbalancedetail_resultsxm(
                 idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,
                 end_debit ,end_credit,is_check ,spell_code,wbx_code
               ) select  idx,obj_id ,obj_code ,obj_name ,sum(nc_debit) ,sum(nc_credit) ,sum(qc_debit) ,sum(qc_credit) ,sum(bq_debit) ,sum(bq_credit),sum(lj_debit) ,
                sum(lj_credit ),sum(end_debit) ,sum(end_credit),is_check ,spell_code,wbx_code
                       from t_groupbalancedetail_result_xm
                       where idx =1  '||obj_wheresql||''||subj_wheresql||'
                    group by idx,obj_id ,obj_code ,obj_name ,is_check   ,spell_code,wbx_code
          ';

               --求总合计
              insert into t_groupbalancedetail_resultsxm(
                   idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit,is_check
              )
              select 2 as idx,'' obj_id,'总合计' as obj_code,'' as obj_name,
                 sum(nvl(nc_debit,0)) as nc_debit,
                 sum(nvl(nc_credit,0)) as nc_credit,
                 sum(nvl(qc_debit,0)) as qc_debit,
                 sum(nvl(qc_credit,0)) as qc_credit,
                 sum(nvl(bq_debit,0)) as bq_debit,
                 sum(nvl(bq_credit,0)) as bq_credit,
                 sum(nvl(lj_debit,0)) as lj_debit,
                 sum(nvl(lj_credit,0)) as lj_credit,
                 sum(nvl(end_debit,0)) as end_debit,
                 sum(nvl(end_credit,0)) as end_credit,
                 '' as is_check
              from t_groupbalancedetail_resultsxm
              where idx = 1;

         if prm_subj_select_flag !='1' then

         ddl_sql := 'select
                  obj_code  ,obj_name ,
                  sum(nvl(nc_debit ,0)) as nc_debit,sum(nvl(nc_credit,0)) as nc_credit,sum(nvl(qc_debit,0)) as qc_debit ,
                  sum(nvl(qc_credit,0)) as qc_credit ,
                  sum(nvl(bq_debit,0)) as bq_debit ,sum(nvl(bq_credit,0)) as bq_credit,sum(nvl(lj_debit,0)) as lj_debit,
                  sum(nvl(lj_credit,0)) as lj_credit ,
                  sum(nvl(end_debit,0)) as  end_debit,
                  sum(nvl(end_credit,0)) as   end_credit
                   from  t_groupbalancedetail_resultsxm
        where    obj_code is not null and  (nvl(nc_debit,0)!=0
                  or  nvl(nc_credit,0)!=0
                  or  nvl(qc_debit,0)!=0
                  or  nvl(qc_credit,0)!=0
                  or  nvl(bq_debit,0)!=0
                  or  nvl(bq_credit,0)!=0
                  or  nvl(lj_debit,0)!=0
                  or  nvl(lj_credit,0)!=0
                  or  nvl(end_debit,0)!=0
                  or  nvl(end_credit,0)!=0 )
                  '||endOsWhere||'
                  group by  obj_code  ,obj_name
          order by obj_code';

        else
         ddl_sql := 'select
                  obj_code  ,obj_name ,
                  0 as nc_debit ,sum(nvl(nc_credit,0)-nvl(nc_debit,0) ) as nc_credit,0 as qc_debit ,
                  sum(nvl(qc_credit,0)-nvl(qc_debit,0)) as qc_credit ,
                  sum(nvl(bq_debit,0)) as bq_debit ,sum(nvl(bq_credit,0)) as bq_credit ,sum(nvl(lj_debit,0)) as lj_debit ,
                  sum(nvl(lj_credit,0)) as lj_credit,
                    0  as end_debit ,
                     sum(nvl(end_credit,0)-nvl(end_debit,0)) as  end_credit
                   from  t_groupbalancedetail_resultsxm
        where    obj_code is not null and  (nvl(nc_debit,0)!=0
                  or  nvl(nc_credit,0)!=0
                  or  nvl(qc_debit,0)!=0
                  or  nvl(qc_credit,0)!=0
                  or  nvl(bq_debit,0)!=0
                  or  nvl(bq_credit,0)!=0
                  or  nvl(lj_debit,0)!=0
                  or  nvl(lj_credit,0)!=0
                  or  nvl(end_debit,0)!=0
                  or  nvl(end_credit,0)!=0 )
                  '||endOsWhere||'
                  group by  obj_code  ,obj_name
          order by obj_code';

          end if ;

        open cur_objdata for ddl_sql;
      END group_balancedetail_xm;
		
	
		
	]]></sql>
	
	<sql id="group_objsubjgeneralled_gys" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_objsubjgeneralled_gys

      /*集团===供应商科目总账*/
      (
       prm_group_id number,
       prm_hos_id number,
       prm_copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       rela_code varchar2,  -- 集团化管理  用于多账套查询
       objdata OUT ACT_BOOKS.objsubjgeneralcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
          subj_id varchar2(4000) ;
          num NUMBER;
      BEGIN

          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;


          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          else
             table_name := '';
             obj_where_field := '';
          end if;

          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||prm_subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(prm_subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(prm_subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||prm_group_id||' and a.hos_id  = '||prm_hos_id||' and a.copy_code= '''||prm_copy_code||'''
                         and a.subj_code in('||prm_subj_code||') ';
           subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:='   and ((hs.check1= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
              and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
               and   act.check_type_id = hs.check1 and act.check_type_name=''供应商'')) or
          (hs.check2= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check2 and act.check_type_name=''供应商'')) or
          (hs.check3= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check3 and act.check_type_name=''供应商'')) or
          (hs.check4= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check4 and act.check_type_name=''供应商'' ))
                         )';
          end if;


          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;

          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          /*条件处理end*/


          if acc_month_b='01' then

            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',c.subj_id,hs.subj_code,hs.subj_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os) ,hs.is_check
            from acc_leder_check c
            inner join acc_subj hs on c.group_id =hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and hs.subj_id=c.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
            left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
            where c.group_id=:prm_group_id and hcr.rela_code in ('||rela_code||')
                  and c.acc_year=:acc_year_b and c.acc_month=''00''
                  '||subj_wheresql||'
                  '||obj_wheresql||'
                  '||source_wheresql||'
            group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check'
            using prm_group_id,acc_year_b;

          else

            /*期初余额*/
            summary:='期初余额';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',t1.subj_id,t1.subj_code,t1.subj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os),t1.is_check from
            (
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(c.end_os) end_os,hs.is_check from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where c.group_id=:prm_group_id 
                    and hcr.rela_code in ('||rela_code||') 
                    and c.acc_year=:acc_year_b and c.acc_month=''00''
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
              union all
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
                     sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where v.group_id=:prm_group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
                    and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
             ) t1 group by t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check'
             using prm_group_id,acc_year_b,
            prm_group_id,state,acc_year_b,acc_month_b;

          end if;

          /*本月合计数据*/
          execute immediate 'insert into t_groupaccobjsubjledger_result
          (xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 2,v.acc_year,v.acc_month,hs.subj_id,hs.subj_code,hs.subj_name,''本月合计'',sum(c.debit),sum(c.credit),hs.subj_dire,
                 case when subj_dire=1 then sum(c.credit)-sum(c.debit) else sum(c.debit)-sum(c.credit) end   end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code
          inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:prm_group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
                and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
                '||subj_wheresql||'
                '||obj_wheresql||'
                '||source_wheresql||'
          group by v.acc_year,v.acc_month,hs.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
          ' using prm_group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;



          /*计算本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            subj_id numeric(18);
            xh integer;
            i number;
          begin
            i:=1;
            subj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.subj_id,r.subj_code,r.subj_name,r.end_os,r.acc_year,r.acc_month,subj_dire from t_groupaccobjsubjledger_result r
              where r.xh<3
              order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop

              /*新的科目从0开始计算*/
              if subj_id<>cr.subj_id then
                end_os_sum:=0;

              if (cr.xh=2 ) or (i=1 and cr.xh>1) then
                     if cr.acc_month = ''01'' then
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''上年结转'',0);

                     else
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''期初余额'',0);

                     end if;

                end if;

              end if;

               if subj_id=cr.subj_id and cr.xh=2 and xh!=1 then
                      --dbms_output.put_line(cr.subj_code);
                      --dbms_output.put_line(cr.acc_month);
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.subj_id,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);

              end if;

              end_os_sum:=end_os_sum+cr.end_os;

              /*本月合计余额*/
              if cr.xh=2 then
                 update t_groupaccobjsubjledger_result set end_os=end_os_sum where xh=2 and subj_id=cr.subj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;

              i:=i+1;
              subj_id:=cr.subj_id;
              xh:=cr.xh;
            end loop;
          end;
          ';

          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 3,t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,''本年累计'',
                 t1.debit+nvl((select r1.debit from t_groupaccobjsubjledger_result r1 where r1.xh=1 and r1.debit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
                 t1.credit+nvl((select r1.credit from t_groupaccobjsubjledger_result r1 where r1.xh=1 and r1.credit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
                 t1.subj_dire,t1.end_os ,t1.is_check
          from(
                 select 3,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,
                     sum(r.debit) over(partition by r.acc_year,r.subj_id order by r.acc_month) debit,
                     sum(r.credit) over(partition by r.acc_year,r.subj_id order by r.acc_month) credit,
                     r.subj_dire,r.end_os,r.is_check
                 from t_groupaccobjsubjledger_result r
                 where r.xh=2
           ) t1';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;

          select count(1) into num from acc_subj a5 where a5.group_id = prm_group_id
                    and a5.hos_id = prm_hos_id
                    and a5.copy_code = prm_copy_code
                    and a5.acc_year = acc_year_b
                    and a5.subj_code like ''||prm_subj_code||'%' ;

         if num>1 then
          --逐级汇总
          insert into t_groupaccobjsubjledger_result
                          (xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
                 select b.xh as xh,
                        a.acc_year,
                      '00' as acc_month,
                      a.subj_id,
                      a.subj_code,
                      a.subj_name,
                      b.summary,
                      sum(nvl(b.debit, 0)) as debit,
                      sum(nvl(b.credit, 0)) as credit,
                      b.subj_dire,
                      sum(nvl(b.end_os, 0)) as end_os,
                      null as is_check
                 from (select distinct a5.acc_year,
                          a5.subj_id,
                          a5.subj_code,
                          a5.subj_name,
                          a5.subj_level,
                          a5.is_check,
                          a5.is_last
                    from acc_subj a5
                    where a5.group_id = prm_group_id
                    and a5.hos_id = prm_hos_id
                    and a5.copy_code = prm_copy_code
                    and a5.acc_year = acc_year_b
                    and a5.is_last = 0
                    and a5.is_stop = 0
                    and a5.subj_code like ''||prm_subj_code||'%'
                    ) a
               right join t_groupaccobjsubjledger_result b
               on b.subj_code like (a.subj_code || '%')
               group by a.acc_year,
                        a.subj_id,
                        a.subj_code,
                        a.subj_name,
                        b.summary,
                        b.subj_dire,
                        b.xh ;
     end if ;
          ddl_sql:='select
                case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
                case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
                t.subj_code||'' ''||t.subj_name subj_name,
                t.summary,
                t.debit debit,
                t.credit credit,
                case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,
                t.end_os,t.is_check
          from t_groupaccobjsubjledger_result t
          order by t.subj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc ,t.summary desc';
          open objdata for ddl_sql;

  END group_objsubjgeneralled_gys;
		
	
		
	]]></sql>
	
	<sql id="group_objsubjdetail_gys" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_objsubjdetail_gys
                        
      /*集团===供应商科目明细账*/
      (
       group_id number,
       hos_id number,
       copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       is_happend integer,--无发生不显示期初余额0,1
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       vouch_no_begin number,
       vouch_no_end number,
       rela_code varchar2,  -- 集团化管理  用于多账套查询
       objdata OUT ACT_BOOKS.objsubjcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_show_field varchar2(200);--要显示的动态字段
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          check_insertsql varchar2(500);--辅助核算添加动态字段
          check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
          check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
          subj_id varchar2(4000) ;
          num NUMBER;
          happen_where varchar2(4000);
          vouch_no_num varchar2(4000);
       
      BEGIN
    
          /*结果集临时表*/
          --EXECUTE IMMEDIATE 'drop Table t_groupaccobjsubj_result';
          SELECT COUNT(1) INTO num FROM USER_TABLES WHERE TABLE_NAME = UPPER('t_groupaccobjsubj_result') ;
          IF num = 0 THEN
               ddl_sql:='Create Global Temporary Table t_groupaccobjsubj_result(
                check_id numeric(19,0),
                xh integer,
                vouch_date date,
                acc_year varchar2(20),
                acc_month varchar2(2),
                vouch_no varchar2(50),
                subj_id numeric(18,0),
                subj_code varchar2(50),
                subj_name varchar2(200),
                obj_code varchar2(50),
                obj_name varchar2(200),        
                check1 varchar2(200),--核算1         
                check2 varchar2(200),--核算2
                check3 varchar2(200),--核算3
                check4 varchar2(200),--核算4
                summary varchar2(200),
                debit numeric(19,2),
                credit numeric(19,2),
                subj_dire integer,
                end_os numeric(19,2),
                   is_check numeric(2)
                )On COMMIT Delete ROWS';
                /*
                On COMMIT PRESERVE ROWS 会话性临时表
                On Commit Delete Rows 事务性临时表
                */
                execute immediate ddl_sql;
          END IF;
    
          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;
          
          
          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.dept_code obj_code,hd.dept_name obj_name';
             
          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.emp_code obj_code,hd.emp_name obj_name';
             
          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.proj_code obj_code,hd.proj_name obj_name';
            
          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.sup_code obj_code,hd.sup_name obj_name';
             
          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.cus_code obj_code,hd.cus_name obj_name';
             
          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.store_code obj_code,hd.store_name obj_name';
             
          else
             table_name := '';
             obj_where_field := '';
          end if;
    
          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
                         and a.subj_code in('||subj_code||') ';   
            subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;
    
    
          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;
    
          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          
           if is_happend = 1 then
               happen_where:=' where  (exists(
                                    select 1 from t_groupaccobjsubj_result t1
                                    where t1.subj_id=t.subj_id 
                                          and TO_NUMBER(t1.acc_year||''''||t1.acc_month) 
                                          between TO_NUMBER('||acc_year_b||''||acc_month_b||') 
                                          and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                          ))';
             else
               happen_where:='';
          end if;
          
          /*条件处理end*/
          
          /*凭证号查询条件处理*/
          vouch_no_num:= ''; 
          if vouch_no_begin <> '0' then  
               vouch_no_num :=vouch_no_num || ' and TO_NUMBER(v.vouch_no) >= '||vouch_no_begin||' ' ; 
          end if ; 
          if vouch_no_end <> '0'   then  
               vouch_no_num := vouch_no_num || ' and TO_NUMBER(v.vouch_no) <= '||vouch_no_end||' ' ; 
          end if; 
             --  dbms_output.put_line(vouch_no_num);
            
          /*明细账需要拼辅助核算字段*/
          check_insertsql:='';
          check_selectsql:='';
          check_joinsql:='';
          --check_resultsql:='';
          declare
              check_i integer;
              dict_show_para integer;
              dict_show_sql varchar2(100);
              TYPE ref_type IS REF CURSOR;--定义游标指针
              v_cursor ref_type;--定义游标变量
              check_type_id numeric(18);
              check_table varchar2(50);
              is_sys integer;
              column_id varchar2(50);
              column_no varchar2(50);
              column_code varchar2(50);
              column_name varchar2(50);
              column_check varchar2(50);
              is_change integer;
          begin
            check_i:=0;
            --dbms_output.put_line(ddl_sql);
            OPEN v_cursor FOR '
                select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
                where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
                and exists(
                  select 1 from ACC_SUBJ hs
                  where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
                   '||subj_wheresql||'
                  --and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
                  and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
                ) and b.check_type_id<>3
                order by b.sort_code' 
                using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
            LOOP
            FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中
    
              EXIT WHEN v_cursor%NOTFOUND;    
              check_i:=check_i+1;
    
              --系统核算
              if is_sys=1 then
                
                  --有变更表需要取显示方式的参数
                  dict_show_sql:='';
                  if is_change=1 then
                      SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                      IF dict_show_para = 0 THEN
                           dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check6_no ';--显示历史数据
                      else
                           dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                      end if;
                     --要拼成的结果语句
                     --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                     --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
                  end if;
    
                  check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
                  check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check6_id '||dict_show_sql;
                  --要拼成的结果语句
                  --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
                  --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;
    
              --自定义核算
              elsif is_sys=0 then
                    check_selectsql:=check_selectsql||','||column_check;
                  /*check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
                  where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id 
                  and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;  */         
                 --要拼成的结果语句 
                 /* ,(select check_item_code||' '||check_item_name from acc_check_item item
                  where exists(
                  select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id 
                  and item.check_item_id=avz.check_item_id and avz.check_type_id=29
                  )) check_name2*/
                
    
              end if;
              check_insertsql:=check_insertsql||',check'||check_i;
    
            /*只支持同时挂4个辅助核算*/
            if check_i=4 then
              exit;
            end if;     
            end loop;
            CLOSE v_cursor;--关闭游标
          end;
    
          if acc_month_b='01' then
    
            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',c.subj_id,hs.subj_code,hs.subj_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os),hs.is_check 
            from acc_leder_check c
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
            left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
            where c.group_id=:group_id 
                  and hcr.rela_code in ('||rela_code||') 
                  and c.acc_year=:acc_year_b and c.acc_month=''00''
                  '||subj_wheresql||'
                  '||obj_wheresql||'
                  '||source_wheresql||'
            group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check' 
            using group_id,acc_year_b;
    
          else
    
            /*期初余额*/
            summary:='期初余额';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',t1.subj_id,t1.subj_code,t1.subj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os) ,t1.is_check from
            (
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(c.end_os) end_os ,hs.is_check
              from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where c.group_id=:group_id 
                    and hcr.rela_code in ('||rela_code||') 
                    and c.acc_year=:acc_year_b and c.acc_month=''00''
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
              union all
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
              sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where v.group_id=:group_id 
                  and hcr.rela_code in ('||rela_code||') and v.state>=:state
                  and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
                  '||subj_wheresql||'
                  '||obj_wheresql||'
                  '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
             ) t1 group by t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check' 
             using group_id,acc_year_b,
            group_id,state,acc_year_b,acc_month_b;
    
          end if;
    
          /*本期发生凭证数据*/
          execute immediate 'insert into t_groupaccobjsubj_result(check_id,xh,acc_year,acc_month,vouch_date,vouch_no,obj_code,obj_name
          '||check_insertsql||'
          ,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select c.vouch_check_id,2,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no||''-''||v.vouch_id vouch_no,'||obj_show_field||'
          '||check_selectsql||'
          ,hs.subj_id,hs.subj_code,hs.subj_name,c.summary,c.debit,c.credit,hs.subj_dire,
          (case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id 
                and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
                and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
                '||subj_wheresql||'
                '||obj_wheresql||'
                '||source_wheresql||'
                '||vouch_no_num||'
          order by v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date,hs.is_check
          ' using group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;
    
          /*本月合计数据*/
          ddl_sql:='insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 3,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,''本月合计'',sum(r.debit),sum(r.credit),r.subj_dire,0 end_os,r.is_check
          from t_groupaccobjsubj_result r
          where r.xh=2
          group by r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,r.subj_dire,r.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
    
    
          /*计算本期发生凭证、本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            acc_month_y varchar2(2);
            subj_id numeric(18);
            xh integer;
            i number;
          begin
            i:=1;
            subj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.subj_id,r.subj_code,r.subj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire  from t_groupaccobjsubj_result r
              where r.xh<4
              order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.vouch_no asc,r.check_id asc) loop
    
              /*新的科目从0开始计算*/
              if subj_id<>cr.subj_id then
                end_os_sum:=0;
    
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then
                     
                     
                     if cr.acc_month = ''01'' then    
                 insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''上年结转'',0);
                else
                   insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''期初余额'',0);
                  end if;
                
                end if;
              end if;
              
              if subj_id=cr.subj_id and cr.xh=2 and xh!=1 then
                
    
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (acc_month_y!=cr.acc_month) then
                      insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.subj_id,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);
                end if;
              end if;
    
              end_os_sum:=end_os_sum+cr.end_os;
    
              /*本期发生凭证余额*/
              if cr.xh=2 then
                 update t_groupaccobjsubj_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
              end if;
              /*本月合计余额*/
              if cr.xh=3 then
                 update t_groupaccobjsubj_result set end_os=end_os_sum where xh=3 and subj_id=cr.subj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;
    
              i:=i+1;
              subj_id:=cr.subj_id;
              acc_month_y:=cr.acc_month;
              xh:=cr.xh;
            end loop;
          end;
          ';
    
          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 4,t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,''本年累计'',
          t1.debit+nvl((select r1.debit from t_groupaccobjsubj_result r1 where r1.xh=1 and r1.debit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.credit+nvl((select r1.credit from t_groupaccobjsubj_result r1 where r1.xh=1 and r1.credit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.subj_dire,t1.end_os,t1.is_check  from
            (select 4,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,
            sum(r.debit) over(partition by r.acc_year,r.subj_id order by r.acc_month) debit,
            sum(r.credit) over(partition by r.acc_year,r.subj_id order by r.acc_month) credit,
            r.subj_dire,r.end_os,r.is_check
            from t_groupaccobjsubj_result r
            where r.xh=3
           ) t1
    
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
  
          /*返回结果集游标*/
          ddl_sql:='select 
          case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
          case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
          to_char(t.vouch_date,''dd'') day,t.vouch_no,
          t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||'
          ,t.subj_code||'' ''||t.subj_name subj_name,t.summary,
          case when t.xh=1 then NULL else t.debit end debit,
          case when t.xh=1 then NULL else t.credit end credit,
          case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
          from t_groupaccobjsubj_result t
           '||happen_where||'
          order by t.subj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date asc,t.vouch_no asc,t.check_id asc,t.is_check
          ';
        --  dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql ;--using acc_year_b,acc_month_b,acc_year_e,acc_month_e;
    
      END group_objsubjdetail_gys;
  
	
  
	]]></sql>
	
	<sql id="group_subjobjgeneralled_gys" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_subjobjgeneralled_gys
      /**集团===科目供应商总账****/
  (
   group_id number,
   hos_id number,
   copy_code varchar2,
   acc_year_b varchar2,
   acc_month_b varchar2,
   acc_year_e varchar2,
   acc_month_e varchar2,
   state integer,--包含未记账:1,99
   subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
   obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
   source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
   table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
   rela_code varchar2,  -- 集团化管理  用于多账套查询
   objdata OUT ACT_BOOKS.subjobjgeneralcursor
   )
  IS
      ddl_sql varchar2(4000);
      obj_sql varchar2(200);
      table_name varchar2(200);--动态表名称
      obj_code_where_field varchar2(200);--查询所用的动态字段名称
      obj_id_where_field varchar2(200);--查询所用的动态字段名称
      obj_history_where_field varchar2(200);--历史记录动态条件
      obj_show_field varchar2(200);--要显示的动态字段
      obj_group_field varchar2(200);--要分组的动态字段
      obj_group_field1 varchar2(200);--要分组的动态字段
      obj_where_field varchar2(200);--id关联动态条件
      subj_code_begin varchar2(200);--开始科目编码
      subj_code_end varchar2(200);--结束科目编码
      obj_code_begin varchar2(200);--开始项目编码
      obj_code_end varchar2(200);--结束项目编码
      check_insertsql varchar2(500);--辅助核算添加动态字段
      check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
      check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
      --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
      source_wheresql varchar2(200);
      subj_wheresql varchar2(4000);
      obj_wheresql varchar2(4000);
      summary varchar2(20);
      subj_id varchar2(4000) ;
      num NUMBER;
      happen_where varchar2(4000);
  BEGIN
 
      /*条件处理begin*/
      if source_id='0' then
           source_wheresql:='';--资源来源ID
      else
           source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
      end if;

      obj_group_field1 := 'r1.obj_id,r1.obj_code,r1.obj_name';
      if table_flag  = 1 then
         table_name := 'hos_dept_dict';
         obj_code_where_field := 'dept_code';
         obj_id_where_field := 'dept_id';
         obj_history_where_field := 'c.check1_no=hd.dept_no';
         obj_where_field := 'c.check1_id=hd.dept_id';
         obj_show_field := 'hd.dept_id obj_id,hd.dept_code obj_code,hd.dept_name obj_name';
         obj_group_field := 'hd.dept_id,hd.dept_code,hd.dept_name';
      elsif table_flag = 2 then
         table_name := 'hos_emp_dict';
         obj_code_where_field := 'emp_code';
         obj_id_where_field := 'emp_id';
         obj_history_where_field := 'c.check2_no=hd.emp_no';
         obj_where_field := 'c.check2_id=hd.emp_id';
         obj_show_field := 'hd.emp_id obj_id,hd.emp_code obj_code,hd.emp_name obj_name';
         obj_group_field := 'hd.emp_id,hd.emp_code,hd.emp_name';
      elsif table_flag = 3 then
         table_name := 'hos_proj_dict';
         obj_code_where_field := 'proj_code';
         obj_id_where_field := 'proj_id';
         obj_history_where_field := 'c.check3_no=hd.proj_no';
         obj_where_field := 'c.check3_id=hd.proj_id';
         obj_show_field := 'hd.proj_id obj_id,hd.proj_code obj_code,hd.proj_name obj_name';
         obj_group_field := 'hd.proj_id,hd.proj_code,hd.proj_name';
      elsif table_flag = 6 then
         table_name := 'hos_sup_dict';
         obj_code_where_field := 'sup_code';
         obj_id_where_field := 'sup_id';
         obj_history_where_field := 'c.check6_no=hd.sup_no';
         obj_where_field := 'c.check6_id=hd.sup_id';
         obj_show_field := 'hd.sup_id obj_id,hd.sup_code obj_code,hd.sup_name obj_name';
         obj_group_field := 'hd.sup_id,hd.sup_code,hd.sup_name';
      elsif table_flag = 5 then
         table_name := 'hos_cus_dict';
         obj_code_where_field := 'cus_code';
         obj_id_where_field := 'cus_id';
         obj_history_where_field := 'c.check5_no=hd.cus_no';
         obj_where_field := 'c.check5_id=hd.cus_id';
         obj_show_field := 'hd.cus_id obj_id,hd.cus_code obj_code,hd.cus_name obj_name';
         obj_group_field := 'hd.cus_id,hd.cus_code,hd.cus_name';
      elsif table_flag = 4 then
         table_name := 'hos_store_dict';
         obj_code_where_field := 'store_code';
         obj_id_where_field := 'store_id';
         obj_history_where_field := 'c.check4_no=hd.store_no';
         obj_where_field := 'c.check4_id=hd.store_id';
         obj_show_field := 'hd.store_id obj_id,hd.store_code obj_code,hd.store_name obj_name';
         obj_group_field := 'hd.store_id,hd.store_code,hd.store_name';
      else
         table_name := '';
         obj_where_field := '';
      end if;

      /*科目查询方式*/
      if subj_select_flag=2 then
          --2直接选择查询,
          subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
      elsif subj_select_flag=3 then
          --3按范围查询,
          subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
          subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
          subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
      elsif subj_select_flag=4 then
         --4弹出页面筛选查询
         --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
         subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
                         and a.subj_code in('||subj_code||') ';   
     subj_wheresql:=' and hs.subj_id in('||subj_id||') '; 
      else
        --1查询全部
         subj_wheresql:=' ';
      end if;


      /*项目查询方式*/
      if obj_select_flag=2 then
          --2直接选择查询,
          obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
      elsif obj_select_flag=3 then
          --3按范围查询,
          obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
          obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
          obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
      elsif obj_select_flag=4 then
         --4弹出页面筛选查询
         obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
      else
        --1查询全部
         obj_wheresql:=' ';
      end if;

      --项目显示方式:0历史数据，1最新数据
      SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
      IF num = 0 THEN
           obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
      else
           obj_sql:=' and hd.is_stop=0 ';--显示最新数据
      end if;
      
     
      /*条件处理end*/

      /*明细账需要拼辅助核算字段*/
      check_insertsql:='';
      check_selectsql:='';
      check_joinsql:='';
      --check_resultsql:='';
      declare
          check_i integer;
          dict_show_para integer;
          dict_show_sql varchar2(100);
          TYPE ref_type IS REF CURSOR;--定义游标指针
          v_cursor ref_type;--定义游标变量
          check_type_id numeric(18);
          check_table varchar2(50);
          is_sys integer;
          column_id varchar2(50);
          column_no varchar2(50);
          column_code varchar2(50);
          column_name varchar2(50);
          column_check varchar2(50);
          is_change integer;
      begin
        check_i:=0;
        --dbms_output.put_line(ddl_sql);
        OPEN v_cursor FOR '
            select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
            where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
            and exists(
              select 1 from ACC_SUBJ hs
              where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
               '||subj_wheresql||'
              and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
              and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
            ) and b.check_type_id<>3
            order by b.sort_code'
            using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
        LOOP
        FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中

          EXIT WHEN v_cursor%NOTFOUND;
          check_i:=check_i+1;

          --系统核算
          if is_sys=1 then

              --有变更表需要取显示方式的参数
              dict_show_sql:='';
              if is_change=1 then
                  SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                  IF dict_show_para = 0 THEN
                       dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check'||check_type_id||'_no ';--显示历史数据
                  else
                       dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                  end if;
                 --要拼成的结果语句
                 --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                 --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
              end if;

              check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
              check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check'||check_type_id||'_id '||dict_show_sql;
              --要拼成的结果语句
              --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
              --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;

          --自定义核算
          elsif is_sys=0 then
                check_selectsql:=check_selectsql||','||column_check;
              --check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
              --where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
              --and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;
             --要拼成的结果语句
             /* ,(select check_item_code||' '||check_item_name from acc_check_item item
              where exists(
              select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
              and item.check_item_id=avz.check_item_id and avz.check_type_id=29
              )) check_name2*/


          end if;
          check_insertsql:=check_insertsql||',check'||check_i;

        /*只支持同时挂4个辅助核算*/
        if check_i=4 then
          exit;
        end if;
        end loop;
        CLOSE v_cursor;--关闭游标
      end;

      if acc_month_b='01' then

        /*年初余额*/
        summary:='上年结转';
        --dbms_output.put_line(ddl_sql);
        execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month'||check_insertsql||',
        obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select 1,''0000'',''00'''||check_insertsql||','||obj_show_field||',''上年结转'',sum(c.sum_od),sum(c.sum_oc),1,sum(c.end_os) ,hs.is_check
        from acc_leder_check c
        inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
        inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
        left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
        where c.group_id=:group_id 
              and hcr.rela_code in ('||rela_code||') 
              and c.acc_year=:acc_year_b and c.acc_month=''00''
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
        group by '||obj_group_field||''||check_insertsql||',hs.is_check'
        using group_id,acc_year_b;

      else

        /*期初余额*/
        summary:='期初余额';
        --dbms_output.put_line(ddl_sql);
        execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month'||check_insertsql||',obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select 1,''0000'',''00'''||check_insertsql||',t1.obj_id,t1.obj_code,t1.obj_name,''期初余额'',sum(t1.debit),sum(t1.credit),1,sum(t1.end_os),t1.is_check from
        (
          select '||obj_show_field||''||check_insertsql||',sum(c.sum_od) debit,sum(c.sum_oc) credit,1,sum(c.end_os) end_os ,hs.is_check
          from acc_leder_check c
          inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where c.group_id=:group_id 
                and hcr.rela_code in ('||rela_code||') 
                and c.acc_year=:acc_year_b and c.acc_month=''00''
                '||subj_wheresql||'
                '||obj_wheresql||'
                '||source_wheresql||'
          group by '||obj_group_field||',hs.subj_dire'||check_insertsql||',hs.is_check
          union all
          select '||obj_show_field||''||check_insertsql||',sum(c.debit) debit,sum(c.credit) credit,1,
          sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:group_id 
                and hcr.rela_code in ('||rela_code||') 
                and v.state>=:state
                and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
                '||subj_wheresql||'
                '||obj_wheresql||'
                '||source_wheresql||'
          group by '||obj_group_field||',hs.subj_dire'||check_insertsql||',hs.is_check
         ) t1 group by t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',t1.is_check'
         using group_id,acc_year_b,
        group_id,state,acc_year_b,acc_month_b;

      end if;

      /*本月合计数据*/
      execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month
      '||check_insertsql||'
      ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
      select 2,v.acc_year,v.acc_month
      '||check_insertsql||'
      ,'||obj_show_field||',''本月合计'',sum(c.debit),sum(c.credit),1,
       sum(c.credit)-sum(c.debit)  end_os,hs.is_check
      from acc_vouch_check c
      left join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
      inner join acc_vouch_type t on v.group_id=t.group_id 
            and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
      inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
      inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
      left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
      where v.group_id=:group_id 
            and hcr.rela_code in ('||rela_code||') 
            and v.state>=:state
            and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
            '||subj_wheresql||'
            '||obj_wheresql||'
            '||source_wheresql||'
      group by v.acc_year,v.acc_month,'||obj_group_field||' '||check_insertsql||',hs.is_check
      ' using group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;


      /*计算本月合计余额*/
      --dbms_output.put_line(ddl_sql);
      execute immediate '
      declare
        end_os_sum numeric(19,2);
        end_os_month numeric(19,2);
        obj_id numeric(18);
        xh integer;
        i number;
      begin
        i:=1;
        obj_id:=0;
        end_os_month:=0;
        for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.end_os,r.acc_year,r.acc_month from t_groupaccsubjobjledger_result r
          where r.xh<3
          order by r.obj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop

          /*新的项目从0开始计算*/
          if obj_id<>cr.obj_id then
            end_os_sum:=0;
              if (cr.xh=2 ) or (i=1 and cr.xh>1) then
                  insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,'''||summary||''',0);
            end if; 
          end if;

          end_os_sum:=end_os_sum+cr.end_os;

          /*本月合计余额*/
          if cr.xh=2 then
             update t_groupaccsubjobjledger_result set end_os=end_os_sum where xh=2 and obj_id=cr.obj_id
             and acc_year = cr.acc_year and acc_month=cr.acc_month;
          end if;

          i:=i+1;
          obj_id:=cr.obj_id;
          xh:=cr.xh;
        end loop;
      end;
      ';

      /*本年累计数据*/
      ddl_sql:='insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name'||check_insertsql||',summary,debit,credit,subj_dire,end_os,is_check)
      select 3,t1.acc_year,t1.acc_month,t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',''本年累计'',
      t1.debit+nvl((select sum(r1.debit) from t_groupaccsubjobjledger_result r1 where r1.xh=1 and r1.debit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||''' ),0),
      t1.credit+nvl((select sum(r1.credit) from t_groupaccsubjobjledger_result r1 where r1.xh=1 and r1.credit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
      1,t1.end_os ,t1.is_check from
        (select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name'||check_insertsql||',
        sum(r.debit) over(partition by r.acc_year,r.obj_id order by r.acc_month) debit,
        sum(r.credit) over(partition by r.acc_year,r.obj_id order by r.acc_month) credit,
        r.subj_dire,r.end_os,r.is_check
        from t_groupaccsubjobjledger_result r
        where r.xh=2
       ) t1

      ';
      --dbms_output.put_line(ddl_sql);
      execute immediate ddl_sql;

      /*拼接合计  gaopei  2017/03/31*/
      ddl_sql:='insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,check1,check2,check3,check4,summary,debit,credit,subj_dire,end_os)
      select 4,''合计'','''' acc_month,'''' obj_id,'''' obj_code,'''' obj_name,'''' check1,'''' check2,'''' check3,'''' check4,'''' summary,sum(debit),sum(credit),'''',sum(end_os) 
      from   t_groupaccsubjobjledger_result
       
      '; 
      --dbms_output.put_line(ddl_sql);
      execute immediate ddl_sql;

       /*返回结果集游标*/
      ddl_sql:='select replace(t.acc_year,''0000'','''') acc_year,replace(t.acc_month,''00'','''') acc_month,
      t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||'
      ,t.summary,
      case when t.xh=1 then NULL else t.debit end debit,
      case when t.xh=1 then NULL else t.credit end credit,
      case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
      from t_groupaccsubjobjledger_result t 
      order by t.obj_code asc,t.acc_year asc,t.acc_month asc ,t.xh asc,t.is_check
      
      ';
     
      --dbms_output.put_line(ddl_sql);
      open objdata for ddl_sql;

    END group_subjobjgeneralled_gys;
  
  
	]]></sql>
	
	<sql id="group_subjobjdetail_gys" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_subjobjdetail_gys

       /*集团===科目供应商明细账*/
      (
       group_id number,
       hos_id number,
       copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       is_happend integer,--无发生不显示期初余额0,1
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       rela_code varchar2,  -- 集团化管理  用于多账套查询
       objdata OUT ACT_BOOKS.subjobjcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_show_field varchar2(200);--要显示的动态字段
          obj_group_field varchar2(200);--要分组的动态字段
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          check_insertsql varchar2(500);--辅助核算添加动态字段
          check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
          check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
              subj_id varchar2(4000) ;
          num NUMBER;
          happen_where varchar2(4000);
      BEGIN
    
          /*结果集临时表*/
          --EXECUTE IMMEDIATE 'drop Table t_groupaccsubjobj_result';
          SELECT COUNT(1) INTO num FROM USER_TABLES WHERE TABLE_NAME = UPPER('t_groupaccsubjobj_result') ;
          IF num = 0 THEN
               ddl_sql:='Create Global Temporary Table t_groupaccsubjobj_result(
                check_id numeric(19,0),
                xh integer,
                vouch_date date,
                acc_year varchar2(20),
                acc_month varchar2(2),
                vouch_no varchar2(50),
                obj_id numeric(18,0),
                obj_code varchar2(50),
                obj_name varchar2(200),
                subj_code varchar2(200),
                subj_name varchar2(200),
                check1 varchar2(200),--核算1
                check2 varchar2(200),--核算2
                check3 varchar2(200),--核算3
                check4 varchar2(200),--核算4
                summary varchar2(200),
                debit numeric(19,2),
                credit numeric(19,2),
                subj_dire integer,
                end_os numeric(19,2),
                   is_check numeric(2)
                )On COMMIT Delete ROWS';
                /*
                On COMMIT PRESERVE ROWS 会话性临时表
                On Commit Delete Rows 事务性临时表
                */
                execute immediate ddl_sql;
          END IF;
    
          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;
    
    
          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.dept_id obj_id,hd.dept_code obj_code,hd.dept_name obj_name';
             obj_group_field := 'hd.dept_id,hd.dept_code,hd.dept_name';
          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.emp_id obj_id,hd.emp_code obj_code,hd.emp_name obj_name';
             obj_group_field := 'hd.emp_id,hd.emp_code,hd.emp_name';
          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.proj_id obj_id,hd.proj_code obj_code,hd.proj_name obj_name';
             obj_group_field := 'hd.proj_id,hd.proj_code,hd.proj_name';
          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.sup_id obj_id,hd.sup_code obj_code,hd.sup_name obj_name';
             obj_group_field := 'hd.sup_id,hd.sup_code,hd.sup_name';
          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.cus_id obj_id,hd.cus_code obj_code,hd.cus_name obj_name';
             obj_group_field := 'hd.cus_id,hd.cus_code,hd.cus_name';
          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.store_id obj_id,hd.store_code obj_code,hd.store_name obj_name';
             obj_group_field := 'hd.store_id,hd.store_code,hd.store_name';
          else
             table_name := '';
             obj_where_field := '';
          end if;
    
          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
                         and a.subj_code in('||subj_code||') ';   
             subj_wheresql:=' and hs.subj_id in('||subj_id||') '; 
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;
    
    
          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;
    
          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          
          if is_happend = 1 then  
                   happen_where:='where (exists(
                                        select 1 from t_groupaccsubjobj_result  t1
                                        where t1.obj_id=t.obj_id 
                                              and TO_NUMBER(t1.acc_year||''''||t1.acc_month) 
                                              between TO_NUMBER('||acc_year_b||''||acc_month_b||') 
                                              and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                              ))';
          else
                happen_where:='';
          end if;
          
          /*条件处理end*/
    
          /*明细账需要拼辅助核算字段*/
          check_insertsql:='';
          check_selectsql:='';
          check_joinsql:='';
          --check_resultsql:='';
          declare
              check_i integer;
              dict_show_para integer;
              dict_show_sql varchar2(100);
              TYPE ref_type IS REF CURSOR;--定义游标指针
              v_cursor ref_type;--定义游标变量
              check_type_id numeric(18);
              check_table varchar2(50);
              is_sys integer;
              column_id varchar2(50);
              column_no varchar2(50);
              column_code varchar2(50);
              column_name varchar2(50);
              column_check varchar2(50);
              is_change integer;
          begin
            check_i:=0;
            --dbms_output.put_line(ddl_sql);
            OPEN v_cursor FOR '
                select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check 
                from ACC_CHECK_TYPE b
                where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
                and exists(
                  select 1 from ACC_SUBJ hs
                  where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
                   '||subj_wheresql||'
                  --and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
                  and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
                ) and b.check_table=''HOS_SUP_DICT''
                order by b.sort_code'
                using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
            LOOP
            FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中
    
              EXIT WHEN v_cursor%NOTFOUND;
              check_i:=check_i+1;
    
              --系统核算
              if is_sys=1 then
    
                  --有变更表需要取显示方式的参数
                  dict_show_sql:='';
                  if is_change=1 then
                      SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                      IF dict_show_para = 0 THEN
                           dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check6_no ';--显示历史数据
                      else
                           dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                      end if;
                     --要拼成的结果语句
                     --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                     --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
                  end if;
    
                  check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
                  check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check6_id '||dict_show_sql;
                  --要拼成的结果语句
                  --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
                  --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;
    
              --自定义核算
              elsif is_sys=0 then
                    check_selectsql:=check_selectsql||','||column_check;
                  --check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
                  --where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
                  --and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;
                 --要拼成的结果语句
                 /* ,(select check_item_code||' '||check_item_name from acc_check_item item
                  where exists(
                  select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
                  and item.check_item_id=avz.check_item_id and avz.check_type_id=29
                  )) check_name2*/
    
    
              end if;
              check_insertsql:=check_insertsql||',check'||check_i;
    
            /*只支持同时挂4个辅助核算*/
            if check_i=4 then
              exit;
            end if;
            end loop;
            CLOSE v_cursor;--关闭游标
          end;
    
          if acc_month_b='01' then
    
            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
            select 1,''0000'',''00'','||obj_show_field||',''上年结转'',sum(c.sum_od),sum(c.sum_oc),1,sum(case when hs.subj_dire=1 then c.end_os else c.end_os*(-1) end) '||check_insertsql||',hs.is_check 
            from acc_leder_check c
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
            left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
            where c.group_id=:group_id 
                  and hcr.rela_code in ('||rela_code||') 
                  and c.acc_year=:acc_year_b 
                  and c.acc_month=''00''
                  '||subj_wheresql||'
                  '||obj_wheresql||'
                  '||source_wheresql||'
            group by '||obj_group_field||''||check_insertsql||',hs.is_check'
            using group_id,acc_year_b;
    
          else
    
            /*期初余额*/
            summary:='期初余额';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
            select 1,''0000'',''00'',t1.obj_id,t1.obj_code,t1.obj_name,''期初余额'',sum(t1.debit),sum(t1.credit),1,sum(t1.end_os)'||check_insertsql||',t1.is_check from
            (
              select '||obj_show_field||',sum(c.sum_od) debit,sum(c.sum_oc) credit,1 subj_dire,sum(case when hs.subj_dire=1 then c.end_os else c.end_os*(-1) end) end_os '||check_insertsql||' ,hs.is_check
              from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                      and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where c.group_id=:group_id 
                    and hcr.rela_code in ('||rela_code||') 
                    and c.acc_year=:acc_year_b 
                    and c.acc_month=''00''
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by '||obj_group_field||''||check_insertsql||',hs.is_check
              union all
              select '||obj_show_field||',sum(c.debit) debit,sum(c.credit) credit,1 subj_dire,
              sum(c.credit-c.debit) end_os
              '||check_insertsql||',hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                      and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where v.group_id=:group_id 
                    and hcr.rela_code in ('||rela_code||') 
                    and v.state>=:state
                    and v.acc_year=:acc_year_b 
                    and v.acc_month<:acc_month_b
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by '||obj_group_field||''||check_insertsql||',hs.is_check
             ) t1 group by t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',t1.is_check'
             using group_id,acc_year_b,
            group_id,state,acc_year_b,acc_month_b;
    
          end if;
         
          /*本期发生凭证数据*/
          execute immediate 'insert into t_groupaccsubjobj_result(check_id,xh,acc_year,acc_month,vouch_date,vouch_no
          '||check_insertsql||'
          ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select c.vouch_check_id,2,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no||''-''||v.vouch_id vouch_no
          '||check_selectsql||'
          ,'||obj_show_field||',c.summary,c.debit,c.credit,1,
           c.credit-c.debit  end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                      and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id 
                  and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:group_id 
                and hcr.rela_code in ('||rela_code||') 
                and v.state>=:state
                and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
                '||subj_wheresql||'
                '||obj_wheresql||'
                '||source_wheresql||'
          order by v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date,hs.is_check
          ' using group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;
          
         
          
          /*本月合计数据*/
          ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
          select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本月合计'',sum(r.debit),sum(r.credit),1,0 end_os'||check_insertsql||',r.is_check
          from t_groupaccsubjobj_result r
          where r.xh=2
          group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name'||check_insertsql||',r.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
    
          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 4,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本年累计'',sum(r.debit),sum(r.credit),0,0 end_os,r.is_check
          from t_groupaccsubjobj_result r
          where r.xh=3
          group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,r.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
          
          /*计算本期发生凭证、本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            obj_id numeric(18);
            acc_month_y varchar2(2);
            xh integer;
            i number;
          begin
            i:=1;
            obj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.subj_code,r.subj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire  from t_groupaccsubjobj_result r
              where r.xh<4
              order by r.obj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.vouch_no asc,r.check_id asc) loop
    
              /*新的项目从0开始计算*/
              if obj_id<>cr.obj_id then
                end_os_sum:=0;
    
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then
                      
                      
                     if cr.acc_month = ''01'' then    
                insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,''上年结转'',0);
                
                else
                  insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,''期初余额'',0);
                
                 end if;
               
                end if;
              end if;
              
                if obj_id=cr.obj_id and cr.xh=2 and xh!=1 then
                
    
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (acc_month_y!=cr.acc_month) then
                    insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);
                 
              
               end if;
              end if;
    
              end_os_sum:=end_os_sum+cr.end_os;
    
              /*本期发生凭证余额*/
              if cr.xh=2 then
                 update t_groupaccsubjobj_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
              end if;
              
              /*本月合计余额*/
              if cr.xh=3 then
                 update t_groupaccsubjobj_result set end_os=end_os_sum where xh=3 and obj_id=cr.obj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;
              
              /*本年累计余额*/
                if cr.xh=4 then
                   update t_groupaccsubjobj_result set end_os=end_os_sum 
                   where xh=4 and obj_id=cr.obj_id and acc_year = cr.acc_year and acc_month=cr.acc_month;
                end if;
                
              i:=i+1;
              obj_id:=cr.obj_id;
              acc_month_y:=cr.acc_month;
              xh:=cr.xh;
            end loop;
          end;
          ';
    
          /*本年累计数据*/
          /*ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||')
          select 4,t1.acc_year,t1.acc_month,t1.obj_id,t1.obj_code,t1.obj_name,''本年累计'',
          t1.debit+nvl((select r1.debit from t_groupaccsubjobj_result r1 where r1.xh=1 and r1.debit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.credit+nvl((select r1.credit from t_groupaccsubjobj_result r1 where r1.xh=1 and r1.credit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
          1,t1.end_os'||check_insertsql||' from
            (select 4,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,
            sum(r.debit) over(partition by r.acc_year,r.obj_id order by r.acc_month) debit,
            sum(r.credit) over(partition by r.acc_year,r.obj_id order by r.acc_month) credit,
            r.subj_dire,r.end_os'||check_insertsql||'
            from t_groupaccsubjobj_result r
            where r.xh=3
           ) t1';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;*/
    
          /*返回结果集游标*/
          ddl_sql:='select 
            case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
            case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
            to_char(t.vouch_date,''dd'') day,t.vouch_no,t.obj_id,
            t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||',
            t.subj_code||'' ''||t.subj_name subj_name,t.summary,
            case when t.xh=1 then NULL else t.debit end debit,
            case when t.xh=1 then NULL else t.credit end credit,
            case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
          from t_groupaccsubjobj_result t
          '||happen_where||'
          order by t.obj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date asc ,t.vouch_no asc,t.check_id asc,t.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql ;--using acc_year_b,acc_month_b,acc_year_e,acc_month_e;
    
      END group_subjobjdetail_gys;
  
	
  
	]]></sql>
	
	<sql id="group_balancedetail_gys" type="proc"><![CDATA[
	CREATE OR REPLACE PROCEDURE group_balancedetail_gys
         /*集团====供应商余额表*/
      (prm_group_id        number,
       prm_hos_id          number,
       prm_copy_code       varchar2,
       prm_acc_year_b      varchar2,
       prm_acc_month_b     varchar2,
       prm_acc_year_e      varchar2,
       prm_acc_month_e     varchar2,
       prm_is_state        integer, --包含未记账:1,99
       prm_is_end_os       integer, --显示有余额的项目:0,1
       prm_cur_code        varchar2, --币种
       prm_obj_select_flag integer, --项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_obj_code        varchar2, --项目条件多个值用逗号分隔。参数格式：1='，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       prm_subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       prm_rela_code varchar2,  -- 集团化管理  用于多账套查询
       cur_objdata         OUT ACT_BOOKS.balancecursor)

       IS

        ddl_sql      varchar2(4000);
        obj_wheresql varchar2(4000);
        emp_wheresql varchar2(100);
        endOsWhere   varchar2(100);
        subj_wheresql varchar2(4000);
        subj_code_begin varchar2(200);--开始科目编码
        subj_code_end varchar2(200);--结束科目编码
        subj_id varchar2(4000) ;
        num NUMBER;

      BEGIN

        /*项目查询方式*/
        if prm_obj_select_flag = 2 then
          --2直接选择查询,
           obj_wheresql:=' and ( obj_code like ''%'||  prm_obj_code||'%'' or
                               obj_name like ''%'||prm_obj_code||'%'' or
                               spell_code like ''%'|| UPPER (prm_obj_code)||'%'' or
                               wbx_code like ''%'|| UPPER (prm_obj_code) ||'%''
                                   ) ';

          /*obj_wheresql := ' and obj_code like ''' || prm_obj_code || '%'' ';

        elsif prm_obj_select_flag = 3 then
          --3按范围查询,
          obj_wheresql := ' and obj_id between ' ||
                          regexp_substr(prm_obj_code, '[^,]+', 1, 1, 'i') ||
                          ' and ' ||
                          regexp_substr(prm_obj_code, '[^,]+', 1, 2, 'i') || ' ';
        elsif prm_obj_select_flag = 4 then
          --4弹出页面筛选查询
          obj_wheresql := ' and obj_id in(' || prm_obj_code || ') '; */
        else
          --1查询全部
          obj_wheresql := '';
        end if;

        /*科目查询方式*/
          if prm_subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and subj_code like '''||prm_subj_code||'%'' ';
          elsif prm_subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(prm_subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(prm_subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif prm_subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||prm_group_id||' and a.hos_id  = '||prm_hos_id||' and a.copy_code= '''||prm_copy_code||'''
                         and a.subj_code in('||prm_subj_code||') ';
             subj_wheresql:=' and subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;

        /*是否显示余额项目*/
        if prm_is_end_os = 1 then
          --2直接选择查询,
          endOsWhere := ' and nvl(end_debit,0) - nvl(end_credit,0) != 0 ';
        else
          endOsWhere := '';
        end if;

      insert into t_groupbalancedetail_resultgys (
         idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit,
         is_check,subj_id,subj_code,spell_code,wbx_code
      )
      select 1 as idx,
          tempa1.check6_id, tempe1.sup_code, tempe1.sup_name,
          case when tempa1.subj_dire=0 then nvl(tempb1.nc_debit,0)-nvl(tempb1.nc_credit,0) end as nc_debit,   --年初余额 借
          case when tempa1.subj_dire=1 then nvl(tempb1.nc_credit,0)-nvl(tempb1.nc_debit,0) end as nc_credit,   --年初余额 贷
          case when tempa1.subj_dire=0 then (nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0))-(nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)) end as qc_debit,  --期初余额 借
          case when tempa1.subj_dire=1 then (nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0))-(nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)) end as qc_credit, --期初余额 贷
          nvl(tempd1.bq_debit,0),  --本期发生 借
          nvl(tempd1.bq_credit,0),   --本期发生 贷
          nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0),  --累计发生 借
          nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0),  --累计发生 贷
          case when tempa1.subj_dire=0 then (nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0))-(nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0)) end as end_debit,  --期末余额 借
          case when tempa1.subj_dire=1 then (nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0))-(nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0)) end as end_credit, --期末余额 贷
               tempb1.is_check,
              tempa1.subj_id,
              tempa1.subj_code,
              tempe1.spell_code,
              tempe1.wbx_code
      from (
           ----有数据的科目
           select alc.check6_id,alc.check6_no,alc.group_id,alc.hos_id,alc.copy_code,alc.acc_year,alc.subj_id,accs.subj_code,accs.subj_dire
           from acc_leder_check alc
           left join acc_subj accs on alc.group_id = accs.group_id and alc.hos_id = accs.hos_id and alc.copy_code = accs.copy_code
                and alc.subj_id = accs.subj_id
           left join hos_copy_rela hcr on alc.group_id = hcr.group_id and alc.hos_id = hcr.hos_id and alc.copy_code = hcr.copy_code
           where alc.group_id=prm_group_id
             and hcr.rela_code in (prm_rela_code)
             and alc.acc_year = prm_acc_year_b
             and nvl(check6_id,0)!=0
             and TO_NUMBER(alc.acc_year||''||alc.acc_month) between TO_NUMBER(prm_acc_year_b||'00') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
             and nvl(alc.end_os,0)!=0
            union
            select a1.check6_id,a1.check6_no,a1.group_id,a1.hos_id,a1.copy_code,a1.acc_year,a1.subj_id,c1.subj_code,c1.subj_dire  from acc_vouch_check a1
            left join acc_vouch b1 on a1.group_id= b1.group_id and a1.hos_id=b1.hos_id and a1.copy_code=b1.copy_code
                 and a1.acc_year = b1.acc_year and a1.vouch_id=b1.vouch_id
            left join acc_subj c1 on a1.group_id = c1.group_id and a1.hos_id = c1.hos_id and a1.copy_code = c1.copy_code
                          and  a1.subj_id = c1.subj_id
            left join hos_copy_rela hcr on a1.group_id = hcr.group_id and a1.hos_id = hcr.hos_id and a1.copy_code = hcr.copy_code
            where a1.group_id=prm_group_id and hcr.rela_code in (prm_rela_code)
              and a1.acc_year = prm_acc_year_b
              and b1.state>=prm_is_state
              and nvl(a1.check6_id,0)!=0
              and TO_NUMBER(b1.acc_year||''||b1.acc_month) between TO_NUMBER(prm_acc_year_b||'01') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
      ) tempa1  left join(
       ---年初余额
       select a2.check6_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,a2.subj_id,
              sum(case when b2.subj_dire=0 then nvl(a2.end_os,0) else 0 end) nc_debit,
              sum(case when b2.subj_dire=1 then  nvl(a2.end_os,0) else 0 end) nc_credit,
              b2.is_check
        from acc_leder_check a2
        left join acc_subj b2 on a2.group_id =b2.group_id and a2.hos_id=b2.hos_id  and a2.copy_code=b2.copy_code
             and a2.acc_year = b2.acc_year  and a2.subj_id=b2.subj_id
        left join hos_copy_rela hcr on a2.group_id = hcr.group_id and a2.hos_id = hcr.hos_id and a2.copy_code = hcr.copy_code
        where a2.group_id=prm_group_id  and hcr.rela_code in (prm_rela_code)
              and a2.acc_year=prm_acc_year_b and a2.acc_month='00'
              and nvl(a2.check6_id,0)!=0
        group by a2.check6_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,b2.is_check,a2.subj_id
      ) tempb1 on tempa1.group_id =tempb1.group_id and tempa1.hos_id =tempb1.hos_id
        and tempa1.copy_code =tempb1.copy_code and tempa1.acc_year =tempb1.acc_year
        and tempa1.check6_id =tempb1.check6_id  and tempa1.subj_id =tempb1.subj_id
      left join (
      --年初到开始日间中间数据
          select a.check6_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id,
                 sum(nvl(a.debit,0)) bfs_debit,
                 sum(nvl(a.credit,0)) bfs_credit
          from  acc_vouch b
          left join  acc_vouch_check a on b.group_id = a.group_id and  b.hos_id = a.hos_id
               and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id
          left join hos_copy_rela hcr on b.group_id = hcr.group_id and b.hos_id = hcr.hos_id and b.copy_code = hcr.copy_code
          where a.group_id=prm_group_id and hcr.rela_code in (prm_rela_code)
                and b.acc_year = prm_acc_year_b
                and b.state>=prm_is_state
                and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||'01'
                and TO_NUMBER(b.acc_year||''||b.acc_month) < prm_acc_year_b||''||prm_acc_month_b
                and nvl(a.check6_id,0)!=0
           group by a.check6_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id
      ) tempc1 on tempa1.group_id =tempc1.group_id and tempa1.hos_id =tempc1.hos_id
        and tempa1.copy_code =tempc1.copy_code and tempa1.acc_year =tempc1.acc_year
        and tempa1.check6_id =tempc1.check6_id and tempa1.subj_id =tempc1.subj_id
      left join(
      -- 本期发生数据
            select a.check6_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id,
                   sum(nvl(a.debit,0)) bq_debit,
                   sum(nvl(a.credit,0)) bq_credit
            from   acc_vouch b
            left join acc_vouch_check a  on b.group_id=a.group_id and b.hos_id=a.hos_id
                 and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id
            left join hos_copy_rela hcr on b.group_id = hcr.group_id and b.hos_id = hcr.hos_id and b.copy_code = hcr.copy_code
            where a.group_id=prm_group_id and hcr.rela_code in (prm_rela_code)
                  and a.acc_year =prm_acc_year_b  and b.state>=prm_is_state
                  and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||''||prm_acc_month_b
                  and TO_NUMBER(b.acc_year||''||b.acc_month) <= prm_acc_year_e||''||prm_acc_month_e
                  and nvl(a.check6_id,0)!=0
            group by a.check6_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id
      ) tempd1 on tempa1.group_id =tempd1.group_id and tempa1.hos_id =tempd1.hos_id
        and tempa1.copy_code =tempd1.copy_code and tempa1.acc_year =tempd1.acc_year
        and tempa1.check6_id =tempd1.check6_id and tempa1.subj_id =tempd1.subj_id
      left join hos_sup_dict  tempe1 on  tempa1.group_id =tempe1.group_id and tempa1.hos_id = tempe1.hos_id
           and  tempa1.check6_id =tempe1.sup_id and  tempa1.check6_no =tempe1.sup_no;

      execute immediate '
       insert into t_groupbalancedetailresultsgys(
         idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,
         bq_credit,lj_debit , lj_credit ,end_debit ,end_credit ,is_check ,spell_code,wbx_code
       ) select  idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,
       bq_credit,lj_debit , lj_credit ,end_debit ,end_credit,is_check,spell_code,wbx_code
               from t_groupbalancedetail_resultgys
               where idx =1  '||obj_wheresql||''||subj_wheresql||'
      ';

               --求总合计
              insert into t_groupbalancedetailresultsgys(
                   idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit,is_check
              )
              select 2 as idx,'' obj_id,'总合计' as obj_code,'' as obj_name,
                 sum(nvl(nc_debit,0)) as nc_debit,
                 sum(nvl(nc_credit,0)) as nc_credit,
                 sum(nvl(qc_debit,0)) as qc_debit,
                 sum(nvl(qc_credit,0)) as qc_credit,
                 sum(nvl(bq_debit,0)) as bq_debit,
                 sum(nvl(bq_credit,0)) as bq_credit,
                 sum(nvl(lj_debit,0)) as lj_debit,
                 sum(nvl(lj_credit,0)) as lj_credit,
                 sum(nvl(end_debit,0)) as end_debit,
                 sum(nvl(end_credit,0)) as end_credit,
                 '' as is_check
              from t_groupbalancedetailresultsgys
              where idx = 1;

      if prm_subj_select_flag != '1' then

        ddl_sql := '
              select
                  obj_code  ,obj_name ,
                  sum(nvl(nc_debit,0)) as nc_debit,
                  sum(nvl(nc_credit,0)) as nc_credit,
                  sum(nvl(qc_debit,0)) as qc_debit,
                  sum(nvl(qc_credit,0)) as qc_credit,
                  sum(nvl(bq_debit,0)) as bq_debit,
                  sum(nvl(bq_credit,0)) as bq_credit,
                  sum(nvl(lj_debit,0)) as lj_debit,
                  sum(nvl(lj_credit,0)) as lj_credit,
                  sum(nvl(end_debit,0)) as  end_debit,
                  sum(nvl(end_credit,0)) as   end_credit
              from  t_groupbalancedetailresultsgys
              where  (nvl(nc_debit,0)!=0 or  nvl(nc_credit,0)!=0 or  nvl(qc_debit,0)!=0 or  nvl(qc_credit,0)!=0
                  or  nvl(bq_debit,0)!=0  or  nvl(bq_credit,0)!=0 or  nvl(lj_debit,0)!=0 or  nvl(lj_credit,0)!=0
                  or  nvl(end_debit,0)!=0 or  nvl(end_credit,0)!=0 )
              and obj_code is not null
              '||endOsWhere||'
           group by  obj_code  ,obj_name
          order by obj_code';

          else

           ddl_sql := '
              select
                  obj_code  ,obj_name ,
                  sum(nvl(nc_debit,0)) as nc_debit,
                  sum(nvl(nc_credit,0)) as nc_credit,
                  sum(nvl(qc_debit,0)) as qc_debit,
                  sum(nvl(qc_credit,0)) as qc_credit,
                  sum(nvl(bq_debit,0)) as bq_debit,
                  sum(nvl(bq_credit,0)) as bq_credit,
                  sum(nvl(lj_debit,0)) as lj_debit,
                  sum(nvl(lj_credit,0)) as lj_credit,
                  0  as end_debit ,
                 sum(nvl(end_credit,0)-nvl(end_debit,0)) as  end_credit
              from  t_groupbalancedetailresultsgys
              where  (nvl(nc_debit,0)!=0 or  nvl(nc_credit,0)!=0 or  nvl(qc_debit,0)!=0 or  nvl(qc_credit,0)!=0
                  or  nvl(bq_debit,0)!=0  or  nvl(bq_credit,0)!=0 or  nvl(lj_debit,0)!=0 or  nvl(lj_credit,0)!=0
                  or  nvl(end_debit,0)!=0 or  nvl(end_credit,0)!=0 )
              and obj_code is not null
              '||endOsWhere||'
           group by  obj_code  ,obj_name
          order by obj_code';

            end if;

        open cur_objdata for ddl_sql;

      END group_balancedetail_gys;
		 
		
	]]></sql>
	
	<sql id="group_objsubjgeneralled_kh" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_objsubjgeneralled_kh

      /*集团====客户科目总账*/
      (
       prm_group_id number,
       prm_hos_id number,
       prm_copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       rela_code varchar2, --集团化管理  用于多账套查询
       objdata OUT ACT_BOOKS.objsubjgeneralcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
          subj_id varchar2(4000) ;
          num NUMBER;
      BEGIN


          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;


          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          else
             table_name := '';
             obj_where_field := '';
          end if;

          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||prm_subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(prm_subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(prm_subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||prm_group_id||' and a.hos_id  = '||prm_hos_id||' and a.copy_code= '''||prm_copy_code||'''
                         and a.subj_code in('||prm_subj_code||') ';
             subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' and ((hs.check1= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
              and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
               and   act.check_type_id = hs.check1 and act.check_type_name=''客户'')) or
          (hs.check2= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check2 and act.check_type_name=''客户'')) or
          (hs.check3= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check3 and act.check_type_name=''客户'')) or
          (hs.check4= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check4 and act.check_type_name=''客户'' ))
                         ) ';
          end if;


          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;

          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          /*条件处理end*/


          if acc_month_b='01' then

            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',c.subj_id,hs.subj_code,hs.subj_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os) ,hs.is_check
            from acc_leder_check c
            inner join acc_subj hs on c.group_id =hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and hs.subj_id=c.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
            left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
            where c.group_id=:prm_group_id and hcr.rela_code in ('||rela_code||') 
                  and c.acc_year=:acc_year_b and c.acc_month=''00''
                  '||subj_wheresql||'
                  '||obj_wheresql||'
                  '||source_wheresql||'
            group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check'
            using prm_group_id,acc_year_b;

          else

            /*期初余额*/
            summary:='期初余额';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',t1.subj_id,t1.subj_code,t1.subj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os),t1.is_check  from
            (
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(c.end_os) end_os ,hs.is_check from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where c.group_id=:prm_group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
              union all
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
                     sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where v.group_id=:prm_group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
                    and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
             ) t1 group by t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check'
             using prm_group_id,acc_year_b,
            prm_group_id,state,acc_year_b,acc_month_b;

          end if;

          /*本月合计数据*/
          execute immediate 'insert into t_groupaccobjsubjledger_result
          (xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 2,v.acc_year,v.acc_month,hs.subj_id,hs.subj_code,hs.subj_name,''本月合计'',sum(c.debit),sum(c.credit),hs.subj_dire,
                 case when subj_dire=1 then sum(c.credit)-sum(c.debit) else sum(c.debit)-sum(c.credit) end   end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code
          inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:prm_group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
                and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
                '||subj_wheresql||'
                '||obj_wheresql||'
                '||source_wheresql||'
          group by v.acc_year,v.acc_month,hs.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
          ' using prm_group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;



          /*计算本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            subj_id numeric(18);
            xh integer;
            i number;
          begin
            i:=1;
            subj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.subj_id,r.subj_code,r.subj_name,r.end_os,r.acc_year,r.acc_month,subj_dire from t_groupaccobjsubjledger_result r
              where r.xh<3
              order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop

              /*新的科目从0开始计算*/
              if subj_id<>cr.subj_id then
                end_os_sum:=0;

              if (cr.xh=2 ) or (i=1 and cr.xh>1) then
                     if cr.acc_month = ''01'' then
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''上年结转'',0);

                     else
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''期初余额'',0);

                     end if;

                end if;

              end if;

               if subj_id=cr.subj_id and cr.xh=2 and xh!=1 then
                      --dbms_output.put_line(cr.subj_code);
                      --dbms_output.put_line(cr.acc_month);
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.subj_id,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);

              end if;

              end_os_sum:=end_os_sum+cr.end_os;

              /*本月合计余额*/
              if cr.xh=2 then
                 update t_groupaccobjsubjledger_result set end_os=end_os_sum where xh=2 and subj_id=cr.subj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;

              i:=i+1;
              subj_id:=cr.subj_id;
              xh:=cr.xh;
            end loop;
          end;
          ';

          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 3,t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,''本年累计'',
                 t1.debit+nvl((select r1.debit from t_groupaccobjsubjledger_result r1 where r1.xh=1 and r1.debit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
                 t1.credit+nvl((select r1.credit from t_groupaccobjsubjledger_result r1 where r1.xh=1 and r1.credit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
                 t1.subj_dire,t1.end_os ,t1.is_check
          from(
                 select 3,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,
                     sum(r.debit) over(partition by r.acc_year,r.subj_id order by r.acc_month) debit,
                     sum(r.credit) over(partition by r.acc_year,r.subj_id order by r.acc_month) credit,
                     r.subj_dire,r.end_os,r.is_check
                 from t_groupaccobjsubjledger_result r
                 where r.xh=2
           ) t1';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;

          select count(1) into num from acc_subj a5 where a5.group_id = prm_group_id
                    and a5.hos_id = prm_hos_id
                    and a5.copy_code = prm_copy_code
                    and a5.acc_year = acc_year_b
                    and a5.subj_code like ''||prm_subj_code||'%' ;

         if num>1 then

          --逐级汇总
          insert into t_groupaccobjsubjledger_result
                          (xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
                 select b.xh as xh,
                        a.acc_year,
                      '00' as acc_month,
                      a.subj_id,
                      a.subj_code,
                      a.subj_name,
                      b.summary,
                      sum(nvl(b.debit, 0)) as debit,
                      sum(nvl(b.credit, 0)) as credit,
                      a.subj_dire,
                      sum(nvl(b.end_os, 0)) as end_os,
                      b.is_check
                 from (select distinct a5.acc_year,
                          a5.subj_id,
                          a5.subj_code,
                          a5.subj_name,
                          a5.subj_level,
                          a5.is_check,
                          a5.is_last,
                          a5.subj_dire
                    from acc_subj a5
                    where a5.group_id = prm_group_id
                    and a5.hos_id = prm_hos_id
                    and a5.copy_code = prm_copy_code
                    and a5.acc_year = acc_year_b
                    and a5.is_last = 0
                    and a5.is_stop = 0
                    and a5.subj_code like ''||prm_subj_code||'%'
                    ) a
               right join t_groupaccobjsubjledger_result b
               on b.subj_code like (a.subj_code || '%')
               group by a.acc_year,
                        a.subj_id,
                        a.subj_code,
                        a.subj_name,
                        b.summary,
                        a.subj_dire,
                        b.is_check,
                        b.xh;
     end if;

          ddl_sql:='select
                case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
                case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
                t.subj_code||'' ''||t.subj_name subj_name,
                t.summary,
                t.debit debit,
                t.credit credit,
                case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,
                t.end_os
          from t_groupaccobjsubjledger_result t
          order by t.subj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql;

  END group_objsubjgeneralled_kh;
		
	
		
	]]></sql>
	<sql id="group_objsubjdetail_kh" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_objsubjdetail_kh

      /*集团===客户科目明细账*/
      (
       group_id number,
       hos_id number,
       copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       is_happend integer,--无发生不显示期初余额0,1
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       rela_code varchar2, --集团化管理  用于多账套查询
       objdata OUT ACT_BOOKS.objsubjcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_show_field varchar2(200);--要显示的动态字段
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          check_insertsql varchar2(500);--辅助核算添加动态字段
          check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
          check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
               subj_id varchar2(4000) ;
          num NUMBER;
          happen_where varchar2(4000);
      BEGIN
      
          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;
          
          
          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.dept_code obj_code,hd.dept_name obj_name';
             
          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.emp_code obj_code,hd.emp_name obj_name';
             
          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.proj_code obj_code,hd.proj_name obj_name';
            
          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.sup_code obj_code,hd.sup_name obj_name';
             
          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.cus_code obj_code,hd.cus_name obj_name';
             
          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.store_code obj_code,hd.store_name obj_name';
             
          else
             table_name := '';
             obj_where_field := '';
          end if;
    
          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
                         and a.subj_code in('||subj_code||') ';   
               subj_wheresql:=' and hs.subj_id in('||subj_id||') '; 
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;
    
    
          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;
    
          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          
          if is_happend = 1 then
               happen_where:='where (exists(
                                    select 1 from t_groupaccobjsubj_result t1
                                    where t1.subj_id=t.subj_id 
                                          and TO_NUMBER(t1.acc_year||''''||t1.acc_month) 
                                          between TO_NUMBER('||acc_year_b||''||acc_month_b||') 
                                          and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                          ))';
             else
               happen_where:='';
          end if;
          /*条件处理end*/
    
          /*明细账需要拼辅助核算字段*/
          check_insertsql:='';
          check_selectsql:='';
          check_joinsql:='';
          --check_resultsql:='';
          declare
              check_i integer;
              dict_show_para integer;
              dict_show_sql varchar2(100);
              TYPE ref_type IS REF CURSOR;--定义游标指针
              v_cursor ref_type;--定义游标变量
              check_type_id numeric(18);
              check_table varchar2(50);
              is_sys integer;
              column_id varchar2(50);
              column_no varchar2(50);
              column_code varchar2(50);
              column_name varchar2(50);
              column_check varchar2(50);
              is_change integer;
          begin
            check_i:=0;
            --dbms_output.put_line(ddl_sql);
            OPEN v_cursor FOR '
                select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
                where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
                and exists(
                  select 1 from ACC_SUBJ hs
                  where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
                   '||subj_wheresql||'
                  --and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
                  and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
                ) and b.check_type_id<>3
                order by b.sort_code' 
                using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
            LOOP
            FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中
    
              EXIT WHEN v_cursor%NOTFOUND;    
              check_i:=check_i+1;
    
              --系统核算
              if is_sys=1 then
                
                  --有变更表需要取显示方式的参数
                  dict_show_sql:='';
                  if is_change=1 then
                      SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                      IF dict_show_para = 0 THEN
                           dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check5_no ';--显示历史数据
                      else
                           dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                      end if;
                     --要拼成的结果语句
                     --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                     --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
                  end if;
    
                  check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
                  check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check5_id '||dict_show_sql;
                  --要拼成的结果语句
                  --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
                  --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;
    
              --自定义核算
              elsif is_sys=0 then
                    check_selectsql:=check_selectsql||','||column_check;
                  /*check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
                  where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id 
                  and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;  */         
                 --要拼成的结果语句 
                 /* ,(select check_item_code||' '||check_item_name from acc_check_item item
                  where exists(
                  select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id 
                  and item.check_item_id=avz.check_item_id and avz.check_type_id=29
                  )) check_name2*/
                
    
              end if;
              check_insertsql:=check_insertsql||',check'||check_i;
    
            /*只支持同时挂4个辅助核算*/
            if check_i=4 then
              exit;
            end if;     
            end loop;
            CLOSE v_cursor;--关闭游标
          end;
    
          if acc_month_b='01' then
    
            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',c.subj_id,hs.subj_code,hs.subj_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os) ,hs.is_check
            from acc_leder_check c
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
            left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
            where c.group_id=:group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
            '||subj_wheresql||'
            '||obj_wheresql||'
            '||source_wheresql||'
            group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check' 
            using group_id,acc_year_b;
    
          else
    
            /*期初余额*/
            summary:='期初余额';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',t1.subj_id,t1.subj_code,t1.subj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os),t1.is_check from
            (
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(c.end_os) end_os ,hs.is_check
              from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where c.group_id=:group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
              union all
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
              sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
              and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
             ) t1 group by t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check' 
             using group_id,acc_year_b,
            group_id,state,acc_year_b,acc_month_b;
    
          end if;
    
          /*本期发生凭证数据*/
          execute immediate 'insert into t_groupaccobjsubj_result(check_id,xh,acc_year,acc_month,vouch_date,vouch_no,obj_code,obj_name
          '||check_insertsql||'
          ,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select c.vouch_check_id,2,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no||''-''||v.vouch_id vouch_no,'||obj_show_field||'
          '||check_selectsql||'
          ,hs.subj_id,hs.subj_code,hs.subj_name,c.summary,c.debit,c.credit,hs.subj_dire,
          (case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id 
                and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
          and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          order by v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date,hs.is_check
          ' using group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;
    
          /*本月合计数据*/
          ddl_sql:='insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 3,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,''本月合计'',sum(r.debit),sum(r.credit),r.subj_dire,0 end_os,r.is_check
          from t_groupaccobjsubj_result r
          where r.xh=2
          group by r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,r.subj_dire,r.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
    
    
          /*计算本期发生凭证、本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            subj_id numeric(18);
            acc_month_y varchar2(2);
            xh integer;
            i number;
          begin
            i:=1;
            subj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.subj_id,r.subj_code,r.subj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccobjsubj_result r
              where r.xh<4
              order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.vouch_no asc,r.check_id asc) loop
    
              /*新的科目从0开始计算*/
              if subj_id<>cr.subj_id then
                end_os_sum:=0;
    
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then
                      
                      
                     if cr.acc_month = ''01'' then    
                 insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''上年结转'',0);
                else
                   insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''期初余额'',0);
                  end if;
               
                end if;
              end if;
    
             if subj_id=cr.subj_id and cr.xh=2 and xh!=1 then
    
                if (acc_month_y!=cr.acc_month) then
                      insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.subj_id,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);
                end if;
              end if;
              end_os_sum:=end_os_sum+cr.end_os;
    
              /*本期发生凭证余额*/
              if cr.xh=2 then
                 update t_groupaccobjsubj_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
              end if;
              /*本月合计余额*/
              if cr.xh=3 then
                 update t_groupaccobjsubj_result set end_os=end_os_sum where xh=3 and subj_id=cr.subj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;
    
              i:=i+1;
              subj_id:=cr.subj_id;
              acc_month_y:=cr.acc_month;
              xh:=cr.xh;
            end loop;
          end;
          ';
    
          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 4,t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,''本年累计'',
          t1.debit+nvl((select r1.debit from t_groupaccobjsubj_result r1 where r1.xh=1 and r1.debit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.credit+nvl((select r1.credit from t_groupaccobjsubj_result r1 where r1.xh=1 and r1.credit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.subj_dire,t1.end_os,t1.is_check from
            (select 4,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,
            sum(r.debit) over(partition by r.acc_year,r.subj_id order by r.acc_month) debit,
            sum(r.credit) over(partition by r.acc_year,r.subj_id order by r.acc_month) credit,
            r.subj_dire,r.end_os,r.is_check
            from t_groupaccobjsubj_result r
            where r.xh=3
           ) t1
    
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
    
          /*返回结果集游标*/
          ddl_sql:='select 
          case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
          case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
          to_char(t.vouch_date,''dd'') day,t.vouch_no,
          t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||'
          ,t.subj_code||'' ''||t.subj_name subj_name,t.summary,
          case when t.xh=1 then NULL else t.debit end debit,
          case when t.xh=1 then NULL else t.credit end credit,
          case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
          from t_groupaccobjsubj_result t
          '||happen_where||'
          order by t.subj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date asc,t.vouch_no asc,t.check_id asc
          ';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql ;--using acc_year_b,acc_month_b,acc_year_e,acc_month_e;
    
      END group_objsubjdetail_kh;
  
	
  
	]]></sql>
	
	<sql id="group_subjobjgeneralled_kh" type="proc"><![CDATA[
		
		CREATE OR REPLACE PROCEDURE group_subjobjgeneralled_kh

   /*集团====科目客户总账*/
  (
   group_id number,
   hos_id number,
   copy_code varchar2,
   acc_year_b varchar2,
   acc_month_b varchar2,
   acc_year_e varchar2,
   acc_month_e varchar2,
   state integer,--包含未记账:1,99
   subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
   obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
   source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
   table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
   rela_code varchar2, --集团化管理  用于多账套查询
   objdata OUT ACT_BOOKS.subjobjgeneralcursor
   )
  IS
      ddl_sql varchar2(4000);
      obj_sql varchar2(200);
      table_name varchar2(200);--动态表名称
      obj_code_where_field varchar2(200);--查询所用的动态字段名称
      obj_id_where_field varchar2(200);--查询所用的动态字段名称
      obj_history_where_field varchar2(200);--历史记录动态条件
      obj_show_field varchar2(200);--要显示的动态字段
      obj_group_field varchar2(200);--要分组的动态字段
      obj_group_field1 varchar2(200);--要分组的动态字段
      obj_where_field varchar2(200);--id关联动态条件
      subj_code_begin varchar2(200);--开始科目编码
      subj_code_end varchar2(200);--结束科目编码
      obj_code_begin varchar2(200);--开始项目编码
      obj_code_end varchar2(200);--结束项目编码
      check_insertsql varchar2(500);--辅助核算添加动态字段
      check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
      check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
      --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
      source_wheresql varchar2(200);
      subj_wheresql varchar2(4000);
      obj_wheresql varchar2(4000);
      summary varchar2(20);
      subj_id varchar2(4000) ;
      num NUMBER;
      happen_where varchar2(4000);
  BEGIN

      /*条件处理begin*/
      if source_id='0' then
           source_wheresql:='';--资源来源ID
      else
           source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
      end if;

      obj_group_field1 := 'r1.obj_id,r1.obj_code,r1.obj_name';
      if table_flag  = 1 then
         table_name := 'hos_dept_dict';
         obj_code_where_field := 'dept_code';
         obj_id_where_field := 'dept_id';
         obj_history_where_field := 'c.check1_no=hd.dept_no';
         obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.dept_id obj_id,hd.dept_code obj_code,hd.dept_name obj_name';
         obj_group_field := 'hd.dept_id,hd.dept_code,hd.dept_name';
      elsif table_flag = 2 then
         table_name := 'hos_emp_dict';
         obj_code_where_field := 'emp_code';
         obj_id_where_field := 'emp_id';
         obj_history_where_field := 'c.check2_no=hd.emp_no';
         obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.emp_id obj_id,hd.emp_code obj_code,hd.emp_name obj_name';
         obj_group_field := 'hd.emp_id,hd.emp_code,hd.emp_name';
      elsif table_flag = 3 then
         table_name := 'hos_proj_dict';
         obj_code_where_field := 'proj_code';
         obj_id_where_field := 'proj_id';
         obj_history_where_field := 'c.check3_no=hd.proj_no';
         obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.proj_id obj_id,hd.proj_code obj_code,hd.proj_name obj_name';
         obj_group_field := 'hd.proj_id,hd.proj_code,hd.proj_name';
      elsif table_flag = 6 then
         table_name := 'hos_sup_dict';
         obj_code_where_field := 'sup_code';
         obj_id_where_field := 'sup_id';
         obj_history_where_field := 'c.check6_no=hd.sup_no';
         obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.sup_id obj_id,hd.sup_code obj_code,hd.sup_name obj_name';
         obj_group_field := 'hd.sup_id,hd.sup_code,hd.sup_name';
      elsif table_flag = 5 then
         table_name := 'hos_cus_dict';
         obj_code_where_field := 'cus_code';
         obj_id_where_field := 'cus_id';
         obj_history_where_field := 'c.check5_no=hd.cus_no';
         obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.cus_id obj_id,hd.cus_code obj_code,hd.cus_name obj_name';
         obj_group_field := 'hd.cus_id,hd.cus_code,hd.cus_name';
      elsif table_flag = 4 then
         table_name := 'hos_store_dict';
         obj_code_where_field := 'store_code';
         obj_id_where_field := 'store_id';
         obj_history_where_field := 'c.check4_no=hd.store_no';
         obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.store_id obj_id,hd.store_code obj_code,hd.store_name obj_name';
         obj_group_field := 'hd.store_id,hd.store_code,hd.store_name';
      else
         table_name := '';
         obj_where_field := '';
      end if;

      /*科目查询方式*/
      if subj_select_flag=2 then
          --2直接选择查询,
          subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
      elsif subj_select_flag=3 then
          --3按范围查询,
          subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
          subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
          subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
      elsif subj_select_flag=4 then
         --4弹出页面筛选查询
        -- subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
        subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
                         and a.subj_code in('||subj_code||') ';   
      subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
      else
        --1查询全部
         subj_wheresql:=' ';
      end if;


      /*项目查询方式*/
      if obj_select_flag=2 then
          --2直接选择查询,
          obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
      elsif obj_select_flag=3 then
          --3按范围查询,
          obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
          obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
          obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
      elsif obj_select_flag=4 then
         --4弹出页面筛选查询
         obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
      else
        --1查询全部
         obj_wheresql:=' ';
      end if;

      --项目显示方式:0历史数据，1最新数据
      SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
      IF num = 0 THEN
           obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
      else
           obj_sql:=' and hd.is_stop=0 ';--显示最新数据
      end if;
      
      
      /*条件处理end*/

      /*明细账需要拼辅助核算字段*/
      check_insertsql:='';
      check_selectsql:='';
      check_joinsql:='';
      --check_resultsql:='';
      declare
          check_i integer;
          dict_show_para integer;
          dict_show_sql varchar2(100);
          TYPE ref_type IS REF CURSOR;--定义游标指针
          v_cursor ref_type;--定义游标变量
          check_type_id numeric(18);
          check_table varchar2(50);
          is_sys integer;
          column_id varchar2(50);
          column_no varchar2(50);
          column_code varchar2(50);
          column_name varchar2(50);
          column_check varchar2(50);
          is_change integer;
      begin
        check_i:=0;
        --dbms_output.put_line(ddl_sql);
        OPEN v_cursor FOR '
            select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
            where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
            and exists(
              select 1 from ACC_SUBJ hs
              where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
               '||subj_wheresql||'
              and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
              and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
            ) and b.check_type_id<>3
            order by b.sort_code'
            using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
        LOOP
        FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中

          EXIT WHEN v_cursor%NOTFOUND;
          check_i:=check_i+1;

          --系统核算
          if is_sys=1 then

              --有变更表需要取显示方式的参数
              dict_show_sql:='';
              if is_change=1 then
                  SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                  IF dict_show_para = 0 THEN
                       dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check'||check_type_id||'_no ';--显示历史数据
                  else
                       dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                  end if;
                 --要拼成的结果语句
                 --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                 --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
              end if;

              check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
              check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check'||check_type_id||'_id '||dict_show_sql;
              --要拼成的结果语句
              --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
              --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;

          --自定义核算
          elsif is_sys=0 then
                check_selectsql:=check_selectsql||','||column_check;
              --check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
              --where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
              --and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;
             --要拼成的结果语句
             /* ,(select check_item_code||' '||check_item_name from acc_check_item item
              where exists(
              select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
              and item.check_item_id=avz.check_item_id and avz.check_type_id=29
              )) check_name2*/


          end if;
          check_insertsql:=check_insertsql||',check'||check_i;

        /*只支持同时挂4个辅助核算*/
        if check_i=4 then
          exit;
        end if;
        end loop;
        CLOSE v_cursor;--关闭游标
      end;

      if acc_month_b='01' then

        /*年初余额*/
        summary:='上年结转';
        --dbms_output.put_line(ddl_sql);
        execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month'||check_insertsql||',
        obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select 1,''0000'',''00'''||check_insertsql||','||obj_show_field||',''上年结转'',sum(c.sum_od),sum(c.sum_oc),0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) ,hs.is_check
        from acc_leder_check c
        inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
        inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
        left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
        where c.group_id=:group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
        '||subj_wheresql||'
        '||obj_wheresql||'
        '||source_wheresql||'
        group by '||obj_group_field||''||check_insertsql||',hs.is_check'
        using group_id,acc_year_b;

      else

        /*期初余额*/
        summary:='期初余额';
        --dbms_output.put_line(ddl_sql);
        execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month'||check_insertsql||',obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select 1,''0000'',''00'''||check_insertsql||',t1.obj_id,t1.obj_code,t1.obj_name,''期初余额'',sum(t1.debit),sum(t1.credit),0,sum(t1.end_os),t1.is_check from
        (
          select '||obj_show_field||''||check_insertsql||',sum(c.sum_od) debit,sum(c.sum_oc) credit,0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) end_os ,hs.is_check
          from acc_leder_check c
          inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where c.group_id=:group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          group by '||obj_group_field||',hs.subj_dire'||check_insertsql||',hs.is_check
          union all
          select '||obj_show_field||''||check_insertsql||',sum(c.debit) debit,sum(c.credit) credit,0,
          sum(c.debit-c.credit) end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
          left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
          and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          group by '||obj_group_field||',hs.subj_dire'||check_insertsql||',hs.is_check
         ) t1 group by t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',t1.is_check'
         using group_id,acc_year_b,
        group_id,state,acc_year_b,acc_month_b;

      end if;

      /*本月合计数据*/
      execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month
      '||check_insertsql||'
      ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
      select 2,v.acc_year,v.acc_month
      '||check_insertsql||'
      ,'||obj_show_field||',''本月合计'',sum(c.debit),sum(c.credit),0,
       sum(c.debit)-sum(c.credit)  end_os,hs.is_check
      from acc_vouch_check c
      left join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
      inner join acc_vouch_type t on v.group_id=t.group_id 
            and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
      inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
      inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
      left join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
      where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
      and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
      '||subj_wheresql||'
      '||obj_wheresql||'
      '||source_wheresql||'
      group by v.acc_year,v.acc_month,'||obj_group_field||' '||check_insertsql||',hs.is_check
      ' using group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;


      /*计算本月合计余额*/
      --dbms_output.put_line(ddl_sql);
      execute immediate '
      declare
        end_os_sum numeric(19,2);
        end_os_month numeric(19,2);
        obj_id numeric(18);
        xh integer;
        i number;
      begin
        i:=1;
        obj_id:=0;
        end_os_month:=0;
        for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccsubjobjledger_result r
          where r.xh<3
          order by r.obj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop

          /*新的项目从0开始计算*/
          if obj_id<>cr.obj_id then
            end_os_sum:=0;
             if (cr.xh=2 ) or (i=1 and cr.xh>1) then
                  
                   
               if cr.acc_month = ''01'' then
                       insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''上年结转'',0);
           
                 else
                   
                        insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''期初余额'',0);
           
                 end if;
            
            end if;     

          end if;
          
           if obj_id=cr.obj_id and cr.xh=2 and xh!=1 then
    
           insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_dire,summary,end_os)
                  values( 1,cr.acc_year,cr.acc_month,cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_dire,''期初余额'',end_os_sum);
            
            end if;

          end_os_sum:=end_os_sum+cr.end_os;

          /*本月合计余额*/
          if cr.xh=2 then
             update t_groupaccsubjobjledger_result set end_os=end_os_sum where xh=2 and obj_id=cr.obj_id
             and acc_year = cr.acc_year and acc_month=cr.acc_month;
          end if;

          i:=i+1;
          obj_id:=cr.obj_id;
          xh:=cr.xh;
        end loop;
      end;
      ';

      /*本年累计数据*/
      ddl_sql:='insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name'||check_insertsql||',summary,debit,credit,subj_dire,end_os,is_check)
      select 3,t1.acc_year,t1.acc_month,t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',''本年累计'',
      t1.debit+nvl((select sum(r1.debit) from t_groupaccsubjobjledger_result r1 where r1.xh=1 and r1.debit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||''' ),0),
      t1.credit+nvl((select sum(r1.credit) from t_groupaccsubjobjledger_result r1 where r1.xh=1 and r1.credit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
      0,t1.end_os,t1.is_check from
        (select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name'||check_insertsql||',
        sum(r.debit) over(partition by r.acc_year,r.obj_id order by r.acc_month) debit,
        sum(r.credit) over(partition by r.acc_year,r.obj_id order by r.acc_month) credit,
        r.subj_dire,r.end_os,r.is_check
        from t_groupaccsubjobjledger_result r
        where r.xh=2
       ) t1

      ';
      --dbms_output.put_line(ddl_sql);
      execute immediate ddl_sql;

      /*返回结果集游标*/
      ddl_sql:='select 
      case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
      case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
      t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||'
      ,t.summary,
      case when t.xh=1 then NULL else t.debit end debit,
      case when t.xh=1 then NULL else t.credit end credit,
      case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
      from t_groupaccsubjobjledger_result t
     
      order by t.obj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.is_check
      ';
      --dbms_output.put_line(ddl_sql);
      open objdata for ddl_sql;

  END group_subjobjgeneralled_kh;
  
	]]></sql>
	
	<sql id="group_subjobjdetail_kh" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_subjobjdetail_kh
       /*集团==科目客户明细账*/
       (
       group_id number,
       hos_id number,
       copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       is_happend integer,--无发生不显示期初余额0,1
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       rela_code varchar2,--集团化  用于多账套查询
       objdata OUT ACT_BOOKS.subjobjcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_show_field varchar2(200);--要显示的动态字段
          obj_group_field varchar2(200);--要分组的动态字段
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          check_insertsql varchar2(500);--辅助核算添加动态字段
          check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
          check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
              subj_id varchar2(4000) ;
          num NUMBER;
          happen_where varchar2(4000);
      BEGIN
     
          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;
    
    
          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.dept_id obj_id,hd.dept_code obj_code,hd.dept_name obj_name';
             obj_group_field := 'hd.dept_id,hd.dept_code,hd.dept_name';
          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.emp_id obj_id,hd.emp_code obj_code,hd.emp_name obj_name';
             obj_group_field := 'hd.emp_id,hd.emp_code,hd.emp_name';
          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.proj_id obj_id,hd.proj_code obj_code,hd.proj_name obj_name';
             obj_group_field := 'hd.proj_id,hd.proj_code,hd.proj_name';
          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.sup_id obj_id,hd.sup_code obj_code,hd.sup_name obj_name';
             obj_group_field := 'hd.sup_id,hd.sup_code,hd.sup_name';
          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.cus_id obj_id,hd.cus_code obj_code,hd.cus_name obj_name';
             obj_group_field := 'hd.cus_id,hd.cus_code,hd.cus_name';
          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.store_id obj_id,hd.store_code obj_code,hd.store_name obj_name';
             obj_group_field := 'hd.store_id,hd.store_code,hd.store_name';
          else
             table_name := '';
             obj_where_field := '';
          end if;
    
          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
                         and a.subj_code in('||subj_code||') ';   
             subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;
    
    
          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;
    
          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          
          if is_happend = 1 then  
                   happen_where:='where (exists(
                                        select 1 from t_groupaccsubjobj_result  t1
                                        where t1.obj_id=t.obj_id 
                                              and TO_NUMBER(t1.acc_year||''''||t1.acc_month) 
                                              between TO_NUMBER('||acc_year_b||''||acc_month_b||') 
                                              and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                              ))';
          else
                happen_where:='';
          end if;
          /*条件处理end*/
    
          /*明细账需要拼辅助核算字段*/
          check_insertsql:='';
          check_selectsql:='';
          check_joinsql:='';
          --check_resultsql:='';
          declare
              check_i integer;
              dict_show_para integer;
              dict_show_sql varchar2(100);
              TYPE ref_type IS REF CURSOR;--定义游标指针
              v_cursor ref_type;--定义游标变量
              check_type_id numeric(18);
              check_table varchar2(50);
              is_sys integer;
              column_id varchar2(50);
              column_no varchar2(50);
              column_code varchar2(50);
              column_name varchar2(50);
              column_check varchar2(50);
              is_change integer;
          begin
            check_i:=0;
            --dbms_output.put_line(ddl_sql);
            OPEN v_cursor FOR '
                select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check 
                from ACC_CHECK_TYPE b
                where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
                and exists(
                  select 1 from ACC_SUBJ hs
                  where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
                   '||subj_wheresql||'
                  --and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
                  and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
                ) and b.check_table=''HOS_CUS_DICT''
                order by b.sort_code'
                using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
            LOOP
            FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中
    
              EXIT WHEN v_cursor%NOTFOUND;
              check_i:=check_i+1;
    
              --系统核算
              if is_sys=1 then
    
                  --有变更表需要取显示方式的参数
                  dict_show_sql:='';
                  if is_change=1 then
                      SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                      IF dict_show_para = 0 THEN
                           dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check5_no ';--显示历史数据
                      else
                           dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                      end if;
                     --要拼成的结果语句
                     --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                     --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
                  end if;
    
                  check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
                  check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check5_id '||dict_show_sql;
                  --要拼成的结果语句
                  --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
                  --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;
    
              --自定义核算
              elsif is_sys=0 then
                    check_selectsql:=check_selectsql||','||column_check;
                  --check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
                  --where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
                  --and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;
                 --要拼成的结果语句
                 /* ,(select check_item_code||' '||check_item_name from acc_check_item item
                  where exists(
                  select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
                  and item.check_item_id=avz.check_item_id and avz.check_type_id=29
                  )) check_name2*/
    
    
              end if;
              check_insertsql:=check_insertsql||',check'||check_i;
    
            /*只支持同时挂4个辅助核算*/
            if check_i=4 then
              exit;
            end if;
            end loop;
            CLOSE v_cursor;--关闭游标
          end;
    
          if acc_month_b='01' then
    
            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
            select 1,''0000'',''00'','||obj_show_field||',''上年结转'',sum(c.sum_od),sum(c.sum_oc),0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) '||check_insertsql||',hs.is_check  from acc_leder_check c
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
left        join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
            where c.group_id=:group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
            '||subj_wheresql||'
            '||obj_wheresql||'
            '||source_wheresql||'
            group by '||obj_group_field||''||check_insertsql||',hs.is_check'
            using group_id,acc_year_b;
    
          else
    
            /*期初余额*/
            summary:='期初余额';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
            select 1,''0000'',''00'',t1.obj_id,t1.obj_code,t1.obj_name,''期初余额'',sum(t1.debit),sum(t1.credit),0,sum(t1.end_os)'||check_insertsql||',t1.is_check from
            (
              select '||obj_show_field||',sum(c.sum_od) debit,sum(c.sum_oc) credit,0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) end_os '||check_insertsql||',hs.is_check  from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                      and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||' '||check_joinsql||'
left          join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where c.group_id=:group_id and hcr.rela_code in ('||rela_code||') and c.acc_year=:acc_year_b and c.acc_month=''00''
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by '||obj_group_field||''||check_insertsql||',hs.is_check
              union all
              select '||obj_show_field||',sum(c.debit) debit,sum(c.credit) credit,0,
              sum(c.debit-c.credit) end_os
              '||check_insertsql||',hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                      and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
left          join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
              where v.group_id=:group_id and hcr.rela_code in ('||rela_code||') and v.state>=:state
              and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by '||obj_group_field||''||check_insertsql||',hs.is_check
             ) t1 group by t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',t1.is_check'
             using group_id,acc_year_b,
            group_id,state,acc_year_b,acc_month_b;
    
          end if;
          
          
          /*本期发生凭证数据*/
          execute immediate 'insert into t_groupaccsubjobj_result(check_id,xh,acc_year,acc_month,vouch_date,vouch_no
          '||check_insertsql||'
          ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select c.vouch_check_id,2,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no||''-''||v.vouch_id vouch_no
          '||check_selectsql||'
          ,'||obj_show_field||',c.summary,c.debit,c.credit,0,
          ( c.debit-c.credit) end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                      and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id 
                  and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||' '||check_joinsql||'
left      join hos_copy_rela hcr on c.group_id = hcr.group_id and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code
          where v.group_id=:group_id and hcr.rela_code in ('||rela_code ||') and v.state>=:state
          and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          order by v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date,hs.is_check
          ' using group_id,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;
          
          /*本月合计数据*/
          ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
          select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本月合计'',sum(r.debit),sum(r.credit),0,0 end_os'||check_insertsql||',r.is_check
          from t_groupaccsubjobj_result r
          where r.xh=2
          group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name'||check_insertsql||',r.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
    
          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 4,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本年累计'',sum(r.debit),sum(r.credit),0,0 end_os,r.is_check
          from t_groupaccsubjobj_result r
          where r.xh=3
          group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,r.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
          
          /*计算本期发生凭证、本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            obj_id numeric(18);
            acc_month_y varchar2(2);
            xh integer;
            i number;
          begin
            i:=1;
            obj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.subj_code,r.subj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccsubjobj_result r
              where r.xh<4
              order by r.obj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.vouch_no asc,r.check_id asc) loop
    
              /*新的项目从0开始计算*/
              if obj_id<>cr.obj_id then
                end_os_sum:=0;
    
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then
                      
                      
                     if cr.acc_month = ''01'' then    
                insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,''上年结转'',0);
                
                else
                  insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,''期初余额'',0);
                
                 end if;
               
                end if;
              end if;
              
               if obj_id=cr.obj_id and cr.xh=2 and xh!=1 then
    
                if (acc_month_y!=cr.acc_month) then
                    insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);
                 
              
               end if;
              end if;
    
              end_os_sum:=end_os_sum+cr.end_os;
    
              /*本期发生凭证余额*/
              if cr.xh=2 then
                 update t_groupaccsubjobj_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
              end if;
              /*本月合计余额*/
              if cr.xh=3 then
                 update t_groupaccsubjobj_result set end_os=end_os_sum where xh=3 and obj_id=cr.obj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;
              
              /*本年累计余额*/
                if cr.xh=4 then
                   update t_groupaccsubjobj_result set end_os=end_os_sum 
                   where xh=4 and obj_id=cr.obj_id and acc_year = cr.acc_year and acc_month=cr.acc_month;
                end if;
                
              i:=i+1;
              obj_id:=cr.obj_id;
              xh:=cr.xh;
              acc_month_y:=cr.acc_month;
            end loop;
          end;
          ';
    
          /*本年累计数据*/
          /*ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||')
          select 4,t1.acc_year,t1.acc_month,t1.obj_id,t1.obj_code,t1.obj_name,''本年累计'',
          t1.debit+nvl((select r1.debit from t_groupaccsubjobj_result r1 where r1.xh=1 and r1.debit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.credit+nvl((select r1.credit from t_groupaccsubjobj_result r1 where r1.xh=1 and r1.credit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
          0,t1.end_os'||check_insertsql||' from
            (select 4,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,r.subj_code,r.subj_name,
            sum(r.debit) over(partition by r.acc_year,r.obj_id order by r.acc_month) debit,
            sum(r.credit) over(partition by r.acc_year,r.obj_id order by r.acc_month) credit,
            r.subj_dire,r.end_os'||check_insertsql||'
            from t_groupaccsubjobj_result r
            where r.xh=3
           ) t1
    
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;*/
    
          /*返回结果集游标*/
          ddl_sql:='select 
            case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
            case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
            to_char(t.vouch_date,''dd'') day,t.vouch_no,t.obj_id,
            t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||',
            t.subj_code||'' ''||t.subj_name subj_name,t.summary,
            case when t.xh=1 then NULL else t.debit end debit,
            case when t.xh=1 then NULL else t.credit end credit,
            case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
          from t_groupaccsubjobj_result t
          '||happen_where||'
          order by t.obj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date asc ,t.vouch_no asc,t.check_id asc,t.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql ;--using acc_year_b,acc_month_b,acc_year_e,acc_month_e;
    
      END group_subjobjdetail_kh;
  
	]]></sql>
	<sql id="group_balancedetail_kh" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_balancedetail_kh
         /*集团===客户余额表*/
      (prm_group_id        number,
       prm_hos_id          number,
       prm_copy_code       varchar2,
       prm_acc_year_b      varchar2,
       prm_acc_month_b     varchar2,
       prm_acc_year_e      varchar2,
       prm_acc_month_e     varchar2,
       prm_is_state        integer, --包含未记账:1,99
       prm_is_end_os       integer, --显示有余额的项目:0,1
       prm_cur_code        varchar2, --币种
       prm_obj_select_flag integer, --项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_obj_code        varchar2, --项目条件多个值用逗号分隔。参数格式：1='，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       prm_subj_select_flag integer, --科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_subj_code        varchar2, --科目条件多个值用逗号分隔。参数格式：1='，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       prm_rela_code        varchar2,--集团化  用于多账套查询
       cur_objdata         OUT ACT_BOOKS.balancecursor)
      
       IS
      
        ddl_sql      varchar2(4000);
        obj_wheresql varchar2(4000);
        emp_wheresql varchar2(100);
        endOsWhere   varchar2(100);
        subj_wheresql varchar2(4000);
        subj_code_begin varchar2(200);--开始科目编码
        subj_code_end varchar2(200);--结束科目编码
        subj_id varchar2(4000) ;
        num NUMBER;
      
      BEGIN
       
      
        /*项目查询方式*/
        if prm_obj_select_flag = 2 then
          --2直接选择查询,
          obj_wheresql := ' and obj_code like ''' || prm_obj_code || '%'' ';
      
        elsif prm_obj_select_flag = 3 then
          --3按范围查询,
          obj_wheresql := ' and obj_code between ' ||
                          regexp_substr(prm_obj_code, '[^,]+', 1, 1, 'i') ||
                          ' and ' ||
                          regexp_substr(prm_obj_code, '[^,]+', 1, 2, 'i') || ' ';
        elsif prm_obj_select_flag = 4 then
          --4弹出页面筛选查询
          obj_wheresql := ' and obj_id in(' || prm_obj_code || ') ';
        else
          --1查询全部
          obj_wheresql := '';
        end if;
      
      /*科目查询方式*/
          if prm_subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and subj_code like '''||prm_subj_code||'%'' ';
          elsif prm_subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(prm_subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(prm_subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif prm_subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||prm_group_id||' and a.hos_id  = '||prm_hos_id||' and a.copy_code= '''||prm_copy_code||''' 
                         and a.subj_code in('||prm_subj_code||') ';  
             subj_wheresql:=' and subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;
      
              /*是否显示余额项目*/
              if prm_is_end_os = 1 then
                --2直接选择查询,
                endOsWhere := ' and nvl(end_debit,0) - nvl(end_credit,0) != 0 ';
              else
                endOsWhere := '';
              end if;
      
        insert into t_groupbalancedetail_result_kh (
               idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,
               end_credit,is_check,subj_id,subj_code
            )
            select 1 as idx,
                tempa1.check5_id, tempe1.cus_code, tempe1.cus_name,
                nvl(tempb1.nc_debit,0),   --年初余额 借
                nvl(tempb1.nc_credit,0),   --年初余额 贷
                nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0),  --期初余额 借
                nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0), --期初余额 贷
                nvl(tempd1.bq_debit,0),  --本期发生 借
                nvl(tempd1.bq_credit,0),   --本期发生 贷
                nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0),  --累计发生 借
                nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0),  --累计发生 贷
                nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0),  --期末余额 借
                nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0), --期末余额 贷
                tempb1.is_check, 
                tempa1.subj_id,
                tempa1.subj_code
                 
            from (
                 ----有数据的科目
                 select a.check5_id,a.check5_no,a.group_id,a.hos_id,a.copy_code,a.acc_year,a.subj_id,b.subj_code,b.subj_dire  
                 from acc_leder_check a 
                 left join acc_subj b on a.group_id = b.group_id and a.hos_id = b.hos_id and a.copy_code = b.copy_code
                                         and a.subj_id = b.subj_id
                 left join hos_copy_rela hcr on a.group_id = hcr.group_id and a.hos_id = hcr.hos_id and a.copy_code = hcr.copy_code                        
                                         
                 where a.group_id=prm_group_id
                       and hcr.rela_code in (prm_rela_code)
                       and a.acc_year = prm_acc_year_b
                       and nvl(a.check5_id,0)!=0
                       and TO_NUMBER(a.acc_year||''||a.acc_month) between TO_NUMBER(prm_acc_year_b||'00') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
                       and nvl(a.end_os,0)!=0
                  union
                  select a1.check5_id,a1.check5_no,a1.group_id,a1.hos_id,a1.copy_code,a1.acc_year,a1.subj_id,c1.subj_code,c1.subj_dire  
                  from acc_vouch_check a1
                  left join acc_vouch b1 on a1.group_id= b1.group_id and a1.hos_id=b1.hos_id and a1.copy_code=b1.copy_code
                       and a1.acc_year = b1.acc_year and a1.vouch_id=b1.vouch_id 
                  left join acc_subj c1 on a1.group_id = c1.group_id and a1.hos_id = c1.hos_id and a1.copy_code = c1.copy_code
                                           and a1.subj_id = c1.subj_id
                  left join hos_copy_rela hcr on a1.group_id = hcr.group_id and a1.hos_id = hcr.hos_id and a1.copy_code = hcr.copy_code                         
                  where a1.group_id=prm_group_id and hcr.rela_code in (prm_rela_code)
                        and a1.acc_year = prm_acc_year_b
                        and b1.state>=prm_is_state
                        and nvl(a1.check5_id,0)!=0
                        and TO_NUMBER(b1.acc_year||''||b1.acc_month) between TO_NUMBER(prm_acc_year_b||'01') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
            ) tempa1  left join(
             ---年初余额
             select a2.check5_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,a2.subj_id,
                    sum(case when b2.subj_dire=0 then nvl(a2.end_os,0) else 0 end) nc_debit,
                    sum(case when b2.subj_dire=1 then  nvl(a2.end_os,0) else 0 end) nc_credit,
                    b2.is_check
              from acc_leder_check a2
              left join acc_subj b2 on a2.group_id =b2.group_id and a2.hos_id=b2.hos_id  and a2.copy_code=b2.copy_code 
                   and a2.acc_year = b2.acc_year  and a2.subj_id=b2.subj_id 
              left join hos_copy_rela hcr on a2.group_id = hcr.group_id and a2.hos_id = hcr.hos_id and a2.copy_code = hcr.copy_code     
              where a2.group_id=prm_group_id  and hcr.rela_code in (prm_rela_code)
                    and a2.acc_year=prm_acc_year_b and a2.acc_month='00'
                    and nvl(a2.check5_id,0)!=0
              group by a2.check5_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,b2.is_check,a2.subj_id
            ) tempb1 on tempa1.group_id =tempb1.group_id and tempa1.hos_id =tempb1.hos_id 
              and tempa1.copy_code =tempb1.copy_code and tempa1.acc_year =tempb1.acc_year
              and tempa1.check5_id =tempb1.check5_id and tempa1.subj_id =tempb1.subj_id  
            left join (
            --年初到开始日间中间数据
                select a.check5_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id,
                       sum(nvl(a.debit,0)) bfs_debit,
                       sum(nvl(a.credit,0)) bfs_credit
                from  acc_vouch b
                left join  acc_vouch_check a on b.group_id = a.group_id and  b.hos_id = a.hos_id 
                     and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id 
                left join hos_copy_rela hcr on b.group_id = hcr.group_id and b.hos_id = hcr.hos_id and b.copy_code = hcr.copy_code     
                where a.group_id=prm_group_id and hcr.rela_code in (prm_rela_code) 
                      and b.acc_year = prm_acc_year_b
                      and b.state>=prm_is_state
                      and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||'01'
                      and TO_NUMBER(b.acc_year||''||b.acc_month) < prm_acc_year_b||''||prm_acc_month_b
                      and nvl(a.check5_id,0)!=0
                 group by a.check5_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id
            ) tempc1 on tempa1.group_id =tempc1.group_id and tempa1.hos_id =tempc1.hos_id 
              and tempa1.copy_code =tempc1.copy_code and tempa1.acc_year =tempc1.acc_year
              and tempa1.check5_id =tempc1.check5_id  and tempa1.subj_id =tempc1.subj_id   
            left join(
            -- 本期发生数据
                  select a.check5_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id,
                         sum(nvl(a.debit,0)) bq_debit,
                         sum(nvl(a.credit,0)) bq_credit
                  from   acc_vouch b
                  left join acc_vouch_check a  on b.group_id=a.group_id and b.hos_id=a.hos_id 
                       and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id 
                  left join hos_copy_rela hcr on b.group_id = hcr.group_id and b.hos_id = hcr.hos_id and b.copy_code = hcr.copy_code     
                  where a.group_id=prm_group_id and hcr.rela_code in (prm_rela_code)
                        and a.acc_year =prm_acc_year_b  and b.state>=prm_is_state
                        and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||''||prm_acc_month_b
                        and TO_NUMBER(b.acc_year||''||b.acc_month) <= prm_acc_year_e||''||prm_acc_month_e
                        and nvl(a.check5_id,0)!=0
                  group by a.check5_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id
            ) tempd1 on tempa1.group_id =tempd1.group_id and tempa1.hos_id =tempd1.hos_id 
              and tempa1.copy_code =tempd1.copy_code and tempa1.acc_year =tempd1.acc_year
              and tempa1.check5_id =tempd1.check5_id and tempa1.subj_id =tempd1.subj_id
            left join hos_cus_dict  tempe1 on  tempa1.group_id =tempe1.group_id and tempa1.hos_id = tempe1.hos_id
                 and  tempa1.check5_id =tempe1.cus_id  and  tempa1.check5_no =tempe1.cus_no ;
            
            execute immediate '
             insert into t_groupbalancedetail_resultskh(
               idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit,is_check  
             ) select  idx,obj_id ,obj_code ,obj_name ,sum(nc_debit) ,sum(nc_credit ),sum(qc_debit) ,sum(qc_credit) ,sum(bq_debit) ,sum(bq_credit),
             sum(lj_debit ), sum(lj_credit) ,sum(end_debit ),sum(end_credit),is_check
                     from t_groupbalancedetail_result_kh
                     where idx =1  '||obj_wheresql||' '||subj_wheresql||'
                     group by  idx,obj_id ,obj_code ,obj_name ,is_check
            ';
            
                     --求总合计
                    insert into t_groupbalancedetail_resultskh(
                         idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit,is_check
                    )
                    select 2 as idx,'' obj_id,'总合计' as obj_code,'' as obj_name,
                       sum(nvl(nc_debit,0)) as nc_debit,
                       sum(nvl(nc_credit,0)) as nc_credit,
                       sum(nvl(qc_debit,0)) as qc_debit,
                       sum(nvl(qc_credit,0)) as qc_credit,
                       sum(nvl(bq_debit,0)) as bq_debit,
                       sum(nvl(bq_credit,0)) as bq_credit,
                       sum(nvl(lj_debit,0)) as lj_debit,
                       sum(nvl(lj_credit,0)) as lj_credit,
                       sum(nvl(end_debit,0)) as end_debit,
                       sum(nvl(end_credit,0)) as end_credit,
                       '' as is_check
                    from t_groupbalancedetail_resultskh
                    where idx = 1;
            
            
                ddl_sql := '
                    select
                        obj_code  ,obj_name , 
                        sum(nvl(nc_debit,0)) as nc_debit ,sum(nvl(nc_credit,0)) as nc_credit,sum(nvl(qc_debit,0)) as qc_debit ,sum(nvl(qc_credit,0)) as qc_credit ,
                        sum(nvl(bq_debit,0)) as bq_debit ,sum(nvl(bq_credit,0)) as bq_credit,sum(nvl(lj_debit,0)) as lj_debit ,sum(nvl(lj_credit,0)) as lj_credit,
                        case when sum(end_debit-end_credit) >=0 then sum(end_debit-end_credit) else 0 end as end_debit ,
                        case when sum(end_credit-end_debit) >0 then  sum(end_credit-end_debit) else 0 end as end_credit 
                    from  t_groupbalancedetail_resultskh
                    where  (nvl(nc_debit,0)!=0 or  nvl(nc_credit,0)!=0 or  nvl(qc_debit,0)!=0 or  nvl(qc_credit,0)!=0
                        or  nvl(bq_debit,0)!=0  or  nvl(bq_credit,0)!=0 or  nvl(lj_debit,0)!=0 or  nvl(lj_credit,0)!=0
                        or  nvl(end_debit,0)!=0 or  nvl(end_credit,0)!=0 )
                    and obj_code is not null
                    '||endOsWhere||'
                    group by obj_code  ,obj_name 
                order by  obj_code';
            
              open cur_objdata for ddl_sql;
      
      END group_balancedetail_kh;
  
	
  
	]]></sql>
	
	<sql id="group_objsubjgeneralled_ck" type="proc"><![CDATA[
		
		CREATE OR REPLACE PROCEDURE group_objsubjgeneralled_ck

      /*集团====仓库科目总账*/
      (
       prm_group_id number,
       prm_hos_id number,
       prm_copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       objdata OUT ACT_BOOKS.objsubjgeneralcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
              subj_id varchar2(4000) ;
          num NUMBER;
      BEGIN

          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;


          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          else
             table_name := '';
             obj_where_field := '';
          end if;

          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||prm_subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(prm_subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(prm_subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||prm_group_id||' and a.hos_id  = '||prm_hos_id||' and a.copy_code= '''||prm_copy_code||'''
                         and a.subj_code in('||prm_subj_code||') ';
             subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:='  and ((hs.check1= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
              and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
               and   act.check_type_id = hs.check1 and act.check_type_name=''库房'')) or
          (hs.check2= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check2 and act.check_type_name=''库房'')) or
          (hs.check3= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check3 and act.check_type_name=''库房'')) or
          (hs.check4= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check4 and act.check_type_name=''库房'' ))
                         ) ';
          end if;


          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;

          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          /*条件处理end*/


          if acc_month_b='01' then

            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',c.subj_id,hs.subj_code,hs.subj_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os),hs.is_check
            from acc_leder_check c
            inner join acc_subj hs on c.group_id =hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and hs.subj_id=c.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
            where c.group_id=:prm_group_id and c.hos_id=:prm_hos_id and c.copy_code=:prm_copy_code
                  and c.acc_year=:acc_year_b and c.acc_month=''00''
                  '||subj_wheresql||'
                  '||obj_wheresql||'
                  '||source_wheresql||'
            group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check'
            using prm_group_id,prm_hos_id,prm_copy_code,acc_year_b;

          else

            /*期初余额*/
            summary:='期初余额';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',t1.subj_id,t1.subj_code,t1.subj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os),t1.is_check  from
            (
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(c.end_os) end_os,hs.is_check from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
              where c.group_id=:prm_group_id and c.hos_id=:prm_hos_id and c.copy_code=:prm_copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
              union all
              select c.subj_id,hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
                     sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              where v.group_id=:prm_group_id and v.hos_id=:prm_hos_id and v.copy_code=:prm_copy_code and v.state>=:state
                    and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
             ) t1 group by t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check'
             using prm_group_id,prm_hos_id,prm_copy_code,acc_year_b,
            prm_group_id,prm_hos_id,prm_copy_code,state,acc_year_b,acc_month_b;

          end if;

          /*本月合计数据*/
          execute immediate 'insert into t_groupaccobjsubjledger_result
          (xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 2,v.acc_year,v.acc_month,hs.subj_id,hs.subj_code,hs.subj_name,''本月合计'',sum(c.debit),sum(c.credit),hs.subj_dire,
                 case when subj_dire=1 then sum(c.credit)-sum(c.debit) else sum(c.debit)-sum(c.credit) end   end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code
          inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
          where v.group_id=:prm_group_id and v.hos_id=:prm_hos_id and v.copy_code=:prm_copy_code and v.state>=:state
                and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
                '||subj_wheresql||'
                '||obj_wheresql||'
                '||source_wheresql||'
          group by v.acc_year,v.acc_month,hs.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
          ' using prm_group_id,prm_hos_id,prm_copy_code,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;



          /*计算本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            subj_id numeric(18);
            xh integer;
            i number;
          begin
            i:=1;
            subj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.subj_id,r.subj_code,r.subj_name,r.end_os,r.acc_year,r.acc_month,subj_dire from t_groupaccobjsubjledger_result r
              where r.xh<3
              order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop

              /*新的科目从0开始计算*/
              if subj_id<>cr.subj_id then
                end_os_sum:=0;

              if (cr.xh=2 ) or (i=1 and cr.xh>1) then
                     if cr.acc_month = ''01'' then
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''上年结转'',0);

                     else
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''期初余额'',0);

                     end if;

                end if;

              end if;

               if subj_id=cr.subj_id and cr.xh=2 and xh!=1 then
                      --dbms_output.put_line(cr.subj_code);
                      --dbms_output.put_line(cr.acc_month);
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.subj_id,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);

              end if;

              end_os_sum:=end_os_sum+cr.end_os;

              /*本月合计余额*/
              if cr.xh=2 then
                 update t_groupaccobjsubjledger_result set end_os=end_os_sum where xh=2 and subj_id=cr.subj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;

              i:=i+1;
              subj_id:=cr.subj_id;
              xh:=cr.xh;
            end loop;
          end;
          ';

          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 3,t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,''本年累计'',
                 t1.debit+nvl((select r1.debit from t_groupaccobjsubjledger_result r1 where r1.xh=1 and r1.debit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
                 t1.credit+nvl((select r1.credit from t_groupaccobjsubjledger_result r1 where r1.xh=1 and r1.credit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
                 t1.subj_dire,t1.end_os ,t1.is_check
          from(
                 select 3,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,
                     sum(r.debit) over(partition by r.acc_year,r.subj_id order by r.acc_month) debit,
                     sum(r.credit) over(partition by r.acc_year,r.subj_id order by r.acc_month) credit,
                     r.subj_dire,r.end_os,r.is_check
                 from t_groupaccobjsubjledger_result r
                 where r.xh=2
           ) t1';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;

          select count(1) into num from acc_subj a5 where a5.group_id = prm_group_id
                    and a5.hos_id = prm_hos_id
                    and a5.copy_code = prm_copy_code
                    and a5.acc_year = acc_year_b
                    and a5.subj_code like ''||prm_subj_code||'%' ;

         if num>1 then

           --逐级汇总
          insert into t_groupaccobjsubjledger_result
                          (xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
                 select b.xh as xh,
                        a.acc_year,
                      '00' as acc_month,
                      a.subj_id,
                      a.subj_code,
                      a.subj_name,
                      b.summary,
                      sum(nvl(b.debit, 0)) as debit,
                      sum(nvl(b.credit, 0)) as credit,
                      a.subj_dire,
                      sum(nvl(b.end_os, 0)) as end_os,
                      b.is_check
                 from (select distinct a5.acc_year,
                          a5.subj_id,
                          a5.subj_code,
                          a5.subj_name,
                          a5.subj_level,
                          a5.is_check,
                          a5.is_last,
                          a5.subj_dire
                    from acc_subj a5
                    where a5.group_id = prm_group_id
                    and a5.hos_id = prm_hos_id
                    and a5.copy_code = prm_copy_code
                    and a5.acc_year = acc_year_b
                    and a5.is_last = 0
                    and a5.is_stop = 0
                    and a5.subj_code like ''||prm_subj_code||'%'
                    ) a
               right join t_groupaccobjsubjledger_result b
               on b.subj_code like (a.subj_code || '%')
               group by a.acc_year,
                        a.subj_id,
                        a.subj_code,
                        a.subj_name,
                        b.summary,
                        a.subj_dire,
                        b.is_check,
                         b.xh ;
          end if;

          ddl_sql:='select
                case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
                case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
                t.subj_code||'' ''||t.subj_name subj_name,
                t.summary,
                t.debit debit,
                t.credit credit,
                case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,
                t.end_os
          from t_groupaccobjsubjledger_result t
          order by t.subj_code asc,t.acc_year asc,t.acc_month asc';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql;

  END group_objsubjgeneralled_ck;
		
	]]></sql>
	
	<sql id="group_objsubjdetail_ck" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_objsubjdetail_ck
    /*集团====仓库科目明细账*/
    (
     group_id number,
     hos_id number,
     copy_code varchar2,
     acc_year_b varchar2,
     acc_month_b varchar2,
     acc_year_e varchar2,
     acc_month_e varchar2,
     state integer,--包含未记账:1,99
     is_happend integer,--无发生不显示期初余额0,1
     subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
     subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
     obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
     obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
     source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
     table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
     objdata OUT ACT_BOOKS.objsubjcursor
     )
    IS
        ddl_sql varchar2(4000);
        obj_sql varchar2(200);
        table_name varchar2(200);--动态表名称
        obj_code_where_field varchar2(200);--查询所用的动态字段名称
        obj_id_where_field varchar2(200);--查询所用的动态字段名称
        obj_history_where_field varchar2(200);--历史记录动态条件
        obj_show_field varchar2(200);--要显示的动态字段
        obj_where_field varchar2(200);--id关联动态条件
        subj_code_begin varchar2(200);--开始科目编码
        subj_code_end varchar2(200);--结束科目编码
        obj_code_begin varchar2(200);--开始项目编码
        obj_code_end varchar2(200);--结束项目编码
        check_insertsql varchar2(500);--辅助核算添加动态字段
        check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
        check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
        --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
        source_wheresql varchar2(200);
        subj_wheresql varchar2(4000);
        obj_wheresql varchar2(4000);
        summary varchar2(20);
            subj_id varchar2(4000) ;
        num NUMBER;
        happen_where varchar2(4000);
    BEGIN
  
        /*结果集临时表*/
        --EXECUTE IMMEDIATE 'drop Table t_groupaccobjsubj_result';
        SELECT COUNT(1) INTO num FROM USER_TABLES WHERE TABLE_NAME = UPPER('t_groupaccobjsubj_result') ;
        IF num = 0 THEN
             ddl_sql:='Create Global Temporary Table t_groupaccobjsubj_result(
              check_id numeric(19,0),
              xh integer,
              vouch_date date,
              acc_year varchar2(20),
              acc_month varchar2(2),
              vouch_no varchar2(50),
              subj_id numeric(18,0),
              subj_code varchar2(50),
              subj_name varchar2(200),
              obj_code varchar2(50),
              obj_name varchar2(200),        
              check1 varchar2(200),--核算1         
              check2 varchar2(200),--核算2
              check3 varchar2(200),--核算3
              check4 varchar2(200),--核算4
              summary varchar2(200),
              debit numeric(19,2),
              credit numeric(19,2),
              subj_dire integer,
              end_os numeric(19,2),
                 is_check numeric(2)
              )On COMMIT Delete ROWS';
              /*
              On COMMIT PRESERVE ROWS 会话性临时表
              On Commit Delete Rows 事务性临时表
              */
              execute immediate ddl_sql;
        END IF;
  
        /*条件处理begin*/
        if source_id='0' then
             source_wheresql:='';--资源来源ID
        else
             source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
        end if;
        
        
        if table_flag  = 1 then
           table_name := 'hos_dept_dict';
           obj_code_where_field := 'dept_code';
           obj_id_where_field := 'dept_id';
           obj_history_where_field := 'c.check1_no=hd.dept_no';
           obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
           obj_show_field := 'hd.dept_code obj_code,hd.dept_name obj_name';
           
        elsif table_flag = 2 then
           table_name := 'hos_emp_dict';
           obj_code_where_field := 'emp_code';
           obj_id_where_field := 'emp_id';
           obj_history_where_field := 'c.check2_no=hd.emp_no';
           obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
           obj_show_field := 'hd.emp_code obj_code,hd.emp_name obj_name';
           
        elsif table_flag = 3 then
           table_name := 'hos_proj_dict';
           obj_code_where_field := 'proj_code';
           obj_id_where_field := 'proj_id';
           obj_history_where_field := 'c.check3_no=hd.proj_no';
           obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
           obj_show_field := 'hd.proj_code obj_code,hd.proj_name obj_name';
          
        elsif table_flag = 6 then
           table_name := 'hos_sup_dict';
           obj_code_where_field := 'sup_code';
           obj_id_where_field := 'sup_id';
           obj_history_where_field := 'c.check6_no=hd.sup_no';
           obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
           obj_show_field := 'hd.sup_code obj_code,hd.sup_name obj_name';
           
        elsif table_flag = 5 then
           table_name := 'hos_cus_dict';
           obj_code_where_field := 'cus_code';
           obj_id_where_field := 'cus_id';
           obj_history_where_field := 'c.check5_no=hd.cus_no';
           obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
           obj_show_field := 'hd.cus_code obj_code,hd.cus_name obj_name';
           
        elsif table_flag = 4 then
           table_name := 'hos_store_dict';
           obj_code_where_field := 'store_code';
           obj_id_where_field := 'store_id';
           obj_history_where_field := 'c.check4_no=hd.store_no';
           obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
           obj_show_field := 'hd.store_code obj_code,hd.store_name obj_name';
           
        else
           table_name := '';
           obj_where_field := '';
        end if;
  
        /*科目查询方式*/
        if subj_select_flag=2 then
            --2直接选择查询,
            subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
        elsif subj_select_flag=3 then
            --3按范围查询,
            subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
            subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
            subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
        elsif subj_select_flag=4 then
           --4弹出页面筛选查询
           --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
           subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
                         and a.subj_code in('||subj_code||') ';   
           subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
        else
          --1查询全部
           subj_wheresql:=' ';
        end if;
  
  
        /*项目查询方式*/
        if obj_select_flag=2 then
            --2直接选择查询,
            obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
        elsif obj_select_flag=3 then
            --3按范围查询,
            obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
            obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
            obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
        elsif obj_select_flag=4 then
           --4弹出页面筛选查询
           obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
        else
          --1查询全部
           obj_wheresql:=' ';
        end if;
  
        --项目显示方式:0历史数据，1最新数据
        SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
        IF num = 0 THEN
             obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
        else
             obj_sql:=' and hd.is_stop=0 ';--显示最新数据
        end if;
        
        if is_happend = 1 then
             happen_where:='where (exists(
                                  select 1 from t_groupaccobjsubj_result t1
                                  where t1.subj_id=t.subj_id 
                                        and TO_NUMBER(t1.acc_year||''''||t1.acc_month) 
                                        between TO_NUMBER('||acc_year_b||''||acc_month_b||') 
                                        and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                        ))';
           else
             happen_where:='';
        end if;
        /*条件处理end*/
  
        /*明细账需要拼辅助核算字段*/
        check_insertsql:='';
        check_selectsql:='';
        check_joinsql:='';
        --check_resultsql:='';
        declare
            check_i integer;
            dict_show_para integer;
            dict_show_sql varchar2(100);
            TYPE ref_type IS REF CURSOR;--定义游标指针
            v_cursor ref_type;--定义游标变量
            check_type_id numeric(18);
            check_table varchar2(50);
            is_sys integer;
            column_id varchar2(50);
            column_no varchar2(50);
            column_code varchar2(50);
            column_name varchar2(50);
            column_check varchar2(50);
            is_change integer;
        begin
          check_i:=0;
          --dbms_output.put_line(ddl_sql);
          OPEN v_cursor FOR '
              select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
              where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
              and exists(
                select 1 from ACC_SUBJ hs
                where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
                 '||subj_wheresql||'
                --and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
                and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
              ) and b.check_type_id<>3
              order by b.sort_code' 
              using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
          LOOP
          FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中
  
            EXIT WHEN v_cursor%NOTFOUND;    
            check_i:=check_i+1;
  
            --系统核算
            if is_sys=1 then
              
                --有变更表需要取显示方式的参数
                dict_show_sql:='';
                if is_change=1 then
                    SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                    IF dict_show_para = 0 THEN
                         dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check4_no ';--显示历史数据
                    else
                         dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                    end if;
                   --要拼成的结果语句
                   --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                   --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
                end if;
  
                check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
                check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check4_id '||dict_show_sql;
                --要拼成的结果语句
                --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
                --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;
  
            --自定义核算
            elsif is_sys=0 then
                  check_selectsql:=check_selectsql||','||column_check;
                /*check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
                where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id 
                and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;  */         
               --要拼成的结果语句 
               /* ,(select check_item_code||' '||check_item_name from acc_check_item item
                where exists(
                select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id 
                and item.check_item_id=avz.check_item_id and avz.check_type_id=29
                )) check_name2*/
              
  
            end if;
            check_insertsql:=check_insertsql||',check'||check_i;
  
          /*只支持同时挂4个辅助核算*/
          if check_i=4 then
            exit;
          end if;     
          end loop;
          CLOSE v_cursor;--关闭游标
        end;
  
        if acc_month_b='01' then
  
          /*年初余额*/
          summary:='上年结转';
          --dbms_output.put_line(ddl_sql);
          execute immediate 'insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 1,''0000'',''00'',c.subj_id,hs.subj_code,hs.subj_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os) ,hs.is_check
          from acc_leder_check c
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
          where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check' 
          using group_id,hos_id,copy_code,acc_year_b;
  
        else
  
          /*期初余额*/
          summary:='期初余额';
          --dbms_output.put_line(ddl_sql);
          execute immediate 'insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 1,''0000'',''00'',t1.subj_id,t1.subj_code,t1.subj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os) ,t1.is_check from
          (
            select c.subj_id,hs.subj_code,hs.subj_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(c.end_os) end_os ,hs.is_check
            from acc_leder_check c
            inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
            where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
            '||subj_wheresql||'
            '||obj_wheresql||'
            '||source_wheresql||'
            group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
            union all
            select c.subj_id,hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
            sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
            from acc_vouch_check c
            inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                  and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
            where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
            and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
            '||subj_wheresql||'
            '||obj_wheresql||'
            '||source_wheresql||'
            group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
           ) t1 group by t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check' 
           using group_id,hos_id,copy_code,acc_year_b,
          group_id,hos_id,copy_code,state,acc_year_b,acc_month_b;
  
        end if;
  
        /*本期发生凭证数据*/
        execute immediate 'insert into t_groupaccobjsubj_result(check_id,xh,acc_year,acc_month,vouch_date,vouch_no,obj_code,obj_name
        '||check_insertsql||'
        ,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select c.vouch_check_id,2,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no||''-''||v.vouch_id vouch_no,'||obj_show_field||'
        '||check_selectsql||'
        ,hs.subj_id,hs.subj_code,hs.subj_name,c.summary,c.debit,c.credit,hs.subj_dire,
        (case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
        from acc_vouch_check c
        inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                  and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
        inner join acc_vouch_type t on v.group_id=t.group_id 
              and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
        inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
        inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
        '||check_joinsql||'
        where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
        and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
        '||subj_wheresql||'
        '||obj_wheresql||'
        '||source_wheresql||'
        order by v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date,hs.is_check
        ' using group_id,hos_id,copy_code,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;
  
        /*本月合计数据*/
        ddl_sql:='insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select 3,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,''本月合计'',sum(r.debit),sum(r.credit),r.subj_dire,0 end_os,r.is_check
        from t_groupaccobjsubj_result r
        where r.xh=2
        group by r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,r.subj_dire,r.is_check
        ';
        --dbms_output.put_line(ddl_sql);
        execute immediate ddl_sql;
  
  
        /*计算本期发生凭证、本月合计余额*/
        --dbms_output.put_line(ddl_sql);
        execute immediate '
        declare
          end_os_sum numeric(19,2);
          end_os_month numeric(19,2);
          subj_id numeric(18);
          acc_month_y varchar2(2);
          xh integer;
          i number;
        begin
          i:=1;
          subj_id:=0;
          end_os_month:=0;
          for cr in (select r.xh,r.subj_id,r.subj_code,r.subj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccobjsubj_result r
            where r.xh<4
            order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.vouch_no asc,r.check_id asc) loop
  
            /*新的科目从0开始计算*/
            if subj_id<>cr.subj_id then
              end_os_sum:=0;
  
              /*有发生数据没有期初余额新增加一条期初余额*/
              if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then
                    
                    
                  if cr.acc_month = ''01'' then    
               insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                    values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''上年结转'',0);
              else
                 insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                    values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''期初余额'',0);
                end if;
                
                
              end if;
            end if;
            
              if subj_id=cr.subj_id and cr.xh=2 and xh!=1 then
  
              if (acc_month_y!=cr.acc_month) then
                    insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,subj_dire,summary,end_os)
                    values( 1,cr.acc_year,cr.acc_month,cr.subj_id,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);
              end if;
            end if;
  
            end_os_sum:=end_os_sum+cr.end_os;
  
            /*本期发生凭证余额*/
            if cr.xh=2 then
               update t_groupaccobjsubj_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
            end if;
            /*本月合计余额*/
            if cr.xh=3 then
               update t_groupaccobjsubj_result set end_os=end_os_sum where xh=3 and subj_id=cr.subj_id
               and acc_year = cr.acc_year and acc_month=cr.acc_month;
            end if;
  
            i:=i+1;
            subj_id:=cr.subj_id;
            acc_month_y:=cr.acc_month;
            xh:=cr.xh;
          end loop;
        end;
        ';
  
        /*本年累计数据*/
        ddl_sql:='insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select 4,t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,''本年累计'',
        t1.debit+nvl((select r1.debit from t_groupaccobjsubj_result r1 where r1.xh=1 and r1.debit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
        t1.credit+nvl((select r1.credit from t_groupaccobjsubj_result r1 where r1.xh=1 and r1.credit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
        t1.subj_dire,t1.end_os ,t1.is_check from
          (select 4,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,
          sum(r.debit) over(partition by r.acc_year,r.subj_id order by r.acc_month) debit,
          sum(r.credit) over(partition by r.acc_year,r.subj_id order by r.acc_month) credit,
          r.subj_dire,r.end_os,r.is_check
          from t_groupaccobjsubj_result r
          where r.xh=3
         ) t1
  
        ';
        --dbms_output.put_line(ddl_sql);
        execute immediate ddl_sql;
  
        /*返回结果集游标*/
        ddl_sql:='select 
         case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
        case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
        to_char(t.vouch_date,''dd'') day,t.vouch_no,
        t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||'
        ,t.subj_code||'' ''||t.subj_name subj_name,t.summary,
        case when t.xh=1 then NULL else t.debit end debit,
        case when t.xh=1 then NULL else t.credit end credit,
        case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
        from t_groupaccobjsubj_result t
        '||happen_where||'
        order by t.subj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date asc,t.vouch_no asc,t.check_id asc,t.is_check
        ';
        --dbms_output.put_line(ddl_sql);
        open objdata for ddl_sql; --using acc_year_b,acc_month_b,acc_year_e,acc_month_e;
  
    END group_objsubjdetail_ck;
	]]></sql>
	
	<sql id="group_subjobjgeneralled_ck" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_subjobjgeneralled_ck

   /*集团====科目库房总账*/
  (
   group_id number,
   hos_id number,
   copy_code varchar2,
   acc_year_b varchar2,
   acc_month_b varchar2,
   acc_year_e varchar2,
   acc_month_e varchar2,
   state integer,--包含未记账:1,99
   subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
   obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
   source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
   table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
   is_happend integer,
   objdata OUT ACT_BOOKS.subjobjgeneralcursor
   )
  IS
      ddl_sql varchar2(4000);
      obj_sql varchar2(200);
      table_name varchar2(200);--动态表名称
      obj_code_where_field varchar2(200);--查询所用的动态字段名称
      obj_id_where_field varchar2(200);--查询所用的动态字段名称
      obj_history_where_field varchar2(200);--历史记录动态条件
      obj_show_field varchar2(200);--要显示的动态字段
      obj_group_field varchar2(200);--要分组的动态字段
      obj_group_field1 varchar2(200);--要分组的动态字段
      obj_where_field varchar2(200);--id关联动态条件
      subj_code_begin varchar2(200);--开始科目编码
      subj_code_end varchar2(200);--结束科目编码
      obj_code_begin varchar2(200);--开始项目编码
      obj_code_end varchar2(200);--结束项目编码
      check_insertsql varchar2(500);--辅助核算添加动态字段
      check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
      check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
      --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
      source_wheresql varchar2(200);
      subj_wheresql varchar2(4000);
      obj_wheresql varchar2(4000);
      summary varchar2(20);
      subj_id varchar2(4000) ;
      num NUMBER;
      happen_where varchar2(4000);
  BEGIN

      /*结果集临时表*/
      --EXECUTE IMMEDIATE 'drop Table t_groupaccsubjobjledger_result';
      SELECT COUNT(1) INTO num FROM USER_TABLES WHERE TABLE_NAME = UPPER('t_groupaccsubjobjledger_result') ;
      IF num = 0 THEN
           ddl_sql:='Create Global Temporary Table t_groupaccsubjobjledger_result(
            xh integer,
            acc_year varchar2(20),
            acc_month varchar2(2),
            obj_id numeric(18,0),
            obj_code varchar2(50),
            obj_name varchar2(200),
            subj_code varchar2(200),
            subj_name varchar2(200),
            check1 varchar2(200),--核算1
            check2 varchar2(200),--核算2
            check3 varchar2(200),--核算3
            check4 varchar2(200),--核算4
            summary varchar2(200),
            debit numeric(19,2),
            credit numeric(19,2),
            subj_dire integer,
            end_os numeric(19,2),
               is_check numeric(2)
            )On COMMIT Delete ROWS';
            /*
            On COMMIT PRESERVE ROWS 会话性临时表
            On Commit Delete Rows 事务性临时表
            */
            execute immediate ddl_sql;
      END IF;

      /*条件处理begin*/
      if source_id='0' then
           source_wheresql:='';--资源来源ID
      else
           source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
      end if;

      obj_group_field1 := 'r1.obj_id,r1.obj_code,r1.obj_name';
      if table_flag  = 1 then
         table_name := 'hos_dept_dict';
         obj_code_where_field := 'dept_code';
         obj_id_where_field := 'dept_id';
         obj_history_where_field := 'c.check1_no=hd.dept_no';
         obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.dept_id obj_id,hd.dept_code obj_code,hd.dept_name obj_name';
         obj_group_field := 'hd.dept_id,hd.dept_code,hd.dept_name';
      elsif table_flag = 2 then
         table_name := 'hos_emp_dict';
         obj_code_where_field := 'emp_code';
         obj_id_where_field := 'emp_id';
         obj_history_where_field := 'c.check2_no=hd.emp_no';
         obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.emp_id obj_id,hd.emp_code obj_code,hd.emp_name obj_name';
         obj_group_field := 'hd.emp_id,hd.emp_code,hd.emp_name';
      elsif table_flag = 3 then
         table_name := 'hos_proj_dict';
         obj_code_where_field := 'proj_code';
         obj_id_where_field := 'proj_id';
         obj_history_where_field := 'c.check3_no=hd.proj_no';
         obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.proj_id obj_id,hd.proj_code obj_code,hd.proj_name obj_name';
         obj_group_field := 'hd.proj_id,hd.proj_code,hd.proj_name';
      elsif table_flag = 6 then
         table_name := 'hos_sup_dict';
         obj_code_where_field := 'sup_code';
         obj_id_where_field := 'sup_id';
         obj_history_where_field := 'c.check6_no=hd.sup_no';
         obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.sup_id obj_id,hd.sup_code obj_code,hd.sup_name obj_name';
         obj_group_field := 'hd.sup_id,hd.sup_code,hd.sup_name';
      elsif table_flag = 5 then
         table_name := 'hos_cus_dict';
         obj_code_where_field := 'cus_code';
         obj_id_where_field := 'cus_id';
         obj_history_where_field := 'c.check5_no=hd.cus_no';
         obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.cus_id obj_id,hd.cus_code obj_code,hd.cus_name obj_name';
         obj_group_field := 'hd.cus_id,hd.cus_code,hd.cus_name';
      elsif table_flag = 4 then
         table_name := 'hos_store_dict';
         obj_code_where_field := 'store_code';
         obj_id_where_field := 'store_id';
         obj_history_where_field := 'c.check4_no=hd.store_no';
         obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.store_id obj_id,hd.store_code obj_code,hd.store_name obj_name';
         obj_group_field := 'hd.store_id,hd.store_code,hd.store_name';
      else
         table_name := '';
         obj_where_field := '';
      end if;

      /*科目查询方式*/
      if subj_select_flag=2 then
          --2直接选择查询,
          subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
      elsif subj_select_flag=3 then
          --3按范围查询,
          subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
          subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
          subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
      elsif subj_select_flag=4 then
         --4弹出页面筛选查询
        -- subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
        subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
            and a.subj_code in('||subj_code||') ';   
    subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
      else
        --1查询全部
         subj_wheresql:=' ';
      end if;


      /*项目查询方式*/
      if obj_select_flag=2 then
          --2直接选择查询,
          obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
      elsif obj_select_flag=3 then
          --3按范围查询,
          obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
          obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
          obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
      elsif obj_select_flag=4 then
         --4弹出页面筛选查询
         obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
      else
        --1查询全部
         obj_wheresql:=' ';
      end if;

      --项目显示方式:0历史数据，1最新数据
      SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
      IF num = 0 THEN
           obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
      else
           obj_sql:=' and hd.is_stop=0 ';--显示最新数据
      end if;
      
      if is_happend = 1 then
           happen_where:='where (exists(
                                select 1 from t_groupaccsubjobjledger_result t1
                                where t1.subj_code=t.subj_code 
                                      and TO_NUMBER(t1.acc_year||''''||t1.acc_month) 
                                      between TO_NUMBER('||acc_year_b||''||acc_month_b||') 
                                      and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                      ))';
         else
           happen_where:='';
      end if;
      /*条件处理end*/

      /*明细账需要拼辅助核算字段*/
      check_insertsql:='';
      check_selectsql:='';
      check_joinsql:='';
      --check_resultsql:='';
      declare
          check_i integer;
          dict_show_para integer;
          dict_show_sql varchar2(100);
          TYPE ref_type IS REF CURSOR;--定义游标指针
          v_cursor ref_type;--定义游标变量
          check_type_id numeric(18);
          check_table varchar2(50);
          is_sys integer;
          column_id varchar2(50);
          column_no varchar2(50);
          column_code varchar2(50);
          column_name varchar2(50);
          column_check varchar2(50);
          is_change integer;
      begin
        check_i:=0;
        --dbms_output.put_line(ddl_sql);
        OPEN v_cursor FOR '
            select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
            where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
            and exists(
              select 1 from ACC_SUBJ hs
              where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
               '||subj_wheresql||'
              and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
              and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
            ) and b.check_type_id<>3
            order by b.sort_code'
            using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
        LOOP
        FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中

          EXIT WHEN v_cursor%NOTFOUND;
          check_i:=check_i+1;

          --系统核算
          if is_sys=1 then

              --有变更表需要取显示方式的参数
              dict_show_sql:='';
              if is_change=1 then
                  SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                  IF dict_show_para = 0 THEN
                       dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check'||check_type_id||'_no ';--显示历史数据
                  else
                       dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                  end if;
                 --要拼成的结果语句
                 --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                 --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
              end if;

              check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
              check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check'||check_type_id||'_id '||dict_show_sql;
              --要拼成的结果语句
              --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
              --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;

          --自定义核算
          elsif is_sys=0 then
                check_selectsql:=check_selectsql||','||column_check;
              --check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
              --where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
              --and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;
             --要拼成的结果语句
             /* ,(select check_item_code||' '||check_item_name from acc_check_item item
              where exists(
              select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
              and item.check_item_id=avz.check_item_id and avz.check_type_id=29
              )) check_name2*/


          end if;
          check_insertsql:=check_insertsql||',check'||check_i;

        /*只支持同时挂4个辅助核算*/
        if check_i=4 then
          exit;
        end if;
        end loop;
        CLOSE v_cursor;--关闭游标
      end;

      if acc_month_b='01' then

        /*年初余额*/
        summary:='上年结转';
        --dbms_output.put_line(ddl_sql);
        execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month'||check_insertsql||',
        obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select 1,''0000'',''00'''||check_insertsql||','||obj_show_field||',''上年结转'',sum(c.sum_od),sum(c.sum_oc),0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end),hs.is_check 
        from acc_leder_check c
        inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
        inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
         '||check_joinsql||'
        where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
        '||subj_wheresql||'
        '||obj_wheresql||'
        '||source_wheresql||'
        group by '||obj_group_field||''||check_insertsql||',hs.is_check'
        using group_id,hos_id,copy_code,acc_year_b;

      else

        /*期初余额*/
        summary:='期初余额';
        --dbms_output.put_line(ddl_sql);
        execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month'||check_insertsql||',obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select 1,''0000'',''00'''||check_insertsql||',t1.obj_id,t1.obj_code,t1.obj_name,''期初余额'',sum(t1.debit),sum(t1.credit),0,sum(t1.end_os),t1.is_check from
        (
          select '||obj_show_field||''||check_insertsql||',sum(c.sum_od) debit,sum(c.sum_oc) credit,0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) end_os ,hs.is_check
          from acc_leder_check c
          inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
           '||check_joinsql||'
          where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          group by '||obj_group_field||',hs.subj_dire'||check_insertsql||',hs.is_check
          union all
          select '||obj_show_field||''||check_insertsql||',sum(c.debit) debit,sum(c.credit) credit,0,
          sum(c.debit-c.credit) end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
           '||check_joinsql||'
          where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
          and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          group by '||obj_group_field||',hs.subj_dire'||check_insertsql||',hs.is_check
         ) t1 group by t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',t1.is_check'
         using group_id,hos_id,copy_code,acc_year_b,
        group_id,hos_id,copy_code,state,acc_year_b,acc_month_b;

      end if;

      /*本月合计数据*/
      execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month
      '||check_insertsql||'
      ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
      select 2,v.acc_year,v.acc_month
      '||check_insertsql||'
      ,'||obj_show_field||',''本月合计'',sum(c.debit),sum(c.credit),0,
       sum(c.debit)-sum(c.credit)  end_os,hs.is_check
      from acc_vouch_check c
      left join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
      inner join acc_vouch_type t on v.group_id=t.group_id 
            and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
      inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
      inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
       '||check_joinsql||'
      where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
      and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
      '||subj_wheresql||'
      '||obj_wheresql||'
      '||source_wheresql||'
      group by v.acc_year,v.acc_month,'||obj_group_field||' '||check_insertsql||',hs.is_check
      ' using group_id,hos_id,copy_code,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;


      /*计算本月合计余额*/
      --dbms_output.put_line(ddl_sql);
      execute immediate '
      declare
        end_os_sum numeric(19,2);
        end_os_month numeric(19,2);
        obj_id numeric(18);
        xh integer;
        i number;
      begin
        i:=1;
        obj_id:=0;
        end_os_month:=0;
        for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccsubjobjledger_result r
          where r.xh<3
          order by r.obj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop

          /*新的项目从0开始计算*/
          if obj_id<>cr.obj_id then
            end_os_sum:=0;
             if (cr.xh=2 ) or (i=1 and cr.xh>1) then
                  
                   
               if cr.acc_month = ''01'' then
                       insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''上年结转'',0);
           
                 else
                   
                        insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''期初余额'',0);
           
                 end if;
            
            end if;     

          end if;
          
           if obj_id=cr.obj_id and cr.xh=2 and xh!=1 then
    
           insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_dire,summary,end_os)
                  values( 1,cr.acc_year,cr.acc_month,cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_dire,''期初余额'',end_os_sum);
            
            end if;

          end_os_sum:=end_os_sum+cr.end_os;

          /*本月合计余额*/
          if cr.xh=2 then
             update t_groupaccsubjobjledger_result set end_os=end_os_sum where xh=2 and obj_id=cr.obj_id
             and acc_year = cr.acc_year and acc_month=cr.acc_month;
          end if;

          i:=i+1;
          obj_id:=cr.obj_id;
          xh:=cr.xh;
        end loop;
      end;
      ';

      /*本年累计数据*/
      ddl_sql:='insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name'||check_insertsql||',summary,debit,credit,subj_dire,end_os,is_check)
      select 3,t1.acc_year,t1.acc_month,t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',''本年累计'',
      t1.debit+nvl((select sum(r1.debit) from t_groupaccsubjobjledger_result r1 where r1.xh=1 and r1.debit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||''' ),0),
      t1.credit+nvl((select sum(r1.credit) from t_groupaccsubjobjledger_result r1 where r1.xh=1 and r1.credit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
      0,t1.end_os,t1.is_check  from
        (select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name'||check_insertsql||',
        sum(r.debit) over(partition by r.acc_year,r.obj_id order by r.acc_month) debit,
        sum(r.credit) over(partition by r.acc_year,r.obj_id order by r.acc_month) credit,
        r.subj_dire,r.end_os,r.is_check
        from t_groupaccsubjobjledger_result r
        where r.xh=2
       ) t1

      ';
      --dbms_output.put_line(ddl_sql);
      execute immediate ddl_sql;

      /*返回结果集游标*/
      ddl_sql:='select 
      case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
      case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
      t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||'
      ,t.summary,
      case when t.xh=1 then NULL else t.debit end debit,
      case when t.xh=1 then NULL else t.credit end credit,
      case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
      from t_groupaccsubjobjledger_result t
      
      order by t.obj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.is_check
      ';
      --dbms_output.put_line(ddl_sql);
      open objdata for ddl_sql;

  END group_subjobjgeneralled_ck;
	]]></sql>
	<sql id="group_subjobjdetail_ck" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_subjobjdetail_ck
       /*集团===科目库房明细账 */
       (
   group_id number,
   hos_id number,
   copy_code varchar2,
   acc_year_b varchar2,
   acc_month_b varchar2,
   acc_year_e varchar2,
   acc_month_e varchar2,
   state integer,--包含未记账:1,99
   is_happend integer,--无发生不显示期初余额0,1
   subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
   obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
   source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
   table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
   objdata OUT ACT_BOOKS.subjobjcursor
   )
  IS
      ddl_sql varchar2(4000);
      obj_sql varchar2(200);
      table_name varchar2(200);--动态表名称
      obj_code_where_field varchar2(200);--查询所用的动态字段名称
      obj_id_where_field varchar2(200);--查询所用的动态字段名称
      obj_history_where_field varchar2(200);--历史记录动态条件
      obj_show_field varchar2(200);--要显示的动态字段
      obj_group_field varchar2(200);--要分组的动态字段
      obj_where_field varchar2(200);--id关联动态条件
      subj_code_begin varchar2(200);--开始科目编码
      subj_code_end varchar2(200);--结束科目编码
      obj_code_begin varchar2(200);--开始项目编码
      obj_code_end varchar2(200);--结束项目编码
      check_insertsql varchar2(500);--辅助核算添加动态字段
      check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
      check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
      --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
      source_wheresql varchar2(200);
      subj_wheresql varchar2(4000);
      obj_wheresql varchar2(4000);
      summary varchar2(20);
      subj_id varchar2(4000) ;
      num NUMBER;
      happen_where varchar2(4000);
  BEGIN

      /*结果集临时表*/
      --EXECUTE IMMEDIATE 'drop Table t_groupaccsubjobj_result';
      SELECT COUNT(1) INTO num FROM USER_TABLES WHERE TABLE_NAME = UPPER('t_groupaccsubjobj_result') ;
      IF num = 0 THEN
           ddl_sql:='Create Global Temporary Table t_groupaccsubjobj_result(
            check_id numeric(19,0),
            xh integer,
            vouch_date date,
            acc_year varchar2(20),
            acc_month varchar2(2),
            vouch_no varchar2(50),
            obj_id numeric(18,0),
            obj_code varchar2(50),
            obj_name varchar2(200),
            subj_code varchar2(200),
            subj_name varchar2(200),
            check1 varchar2(200),--核算1
            check2 varchar2(200),--核算2
            check3 varchar2(200),--核算3
            check4 varchar2(200),--核算4
            summary varchar2(200),
            debit numeric(19,2),
            credit numeric(19,2),
            subj_dire integer,
            end_os numeric(19,2),
               is_check numeric(2)
            )On COMMIT Delete ROWS';
            /*
            On COMMIT PRESERVE ROWS 会话性临时表
            On Commit Delete Rows 事务性临时表
            */
            execute immediate ddl_sql;
      END IF;

      /*条件处理begin*/
      if source_id='0' then
           source_wheresql:='';--资源来源ID
      else
           source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
      end if;


      if table_flag  = 1 then
         table_name := 'hos_dept_dict';
         obj_code_where_field := 'dept_code';
         obj_id_where_field := 'dept_id';
         obj_history_where_field := 'c.check1_no=hd.dept_no';
         obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.dept_id obj_id,hd.dept_code obj_code,hd.dept_name obj_name';
         obj_group_field := 'hd.dept_id,hd.dept_code,hd.dept_name';
      elsif table_flag = 2 then
         table_name := 'hos_emp_dict';
         obj_code_where_field := 'emp_code';
         obj_id_where_field := 'emp_id';
         obj_history_where_field := 'c.check2_no=hd.emp_no';
         obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.emp_id obj_id,hd.emp_code obj_code,hd.emp_name obj_name';
         obj_group_field := 'hd.emp_id,hd.emp_code,hd.emp_name';
      elsif table_flag = 3 then
         table_name := 'hos_proj_dict';
         obj_code_where_field := 'proj_code';
         obj_id_where_field := 'proj_id';
         obj_history_where_field := 'c.check3_no=hd.proj_no';
         obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.proj_id obj_id,hd.proj_code obj_code,hd.proj_name obj_name';
         obj_group_field := 'hd.proj_id,hd.proj_code,hd.proj_name';
      elsif table_flag = 6 then
         table_name := 'hos_sup_dict';
         obj_code_where_field := 'sup_code';
         obj_id_where_field := 'sup_id';
         obj_history_where_field := 'c.check6_no=hd.sup_no';
         obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.sup_id obj_id,hd.sup_code obj_code,hd.sup_name obj_name';
         obj_group_field := 'hd.sup_id,hd.sup_code,hd.sup_name';
      elsif table_flag = 5 then
         table_name := 'hos_cus_dict';
         obj_code_where_field := 'cus_code';
         obj_id_where_field := 'cus_id';
         obj_history_where_field := 'c.check5_no=hd.cus_no';
         obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.cus_id obj_id,hd.cus_code obj_code,hd.cus_name obj_name';
         obj_group_field := 'hd.cus_id,hd.cus_code,hd.cus_name';
      elsif table_flag = 4 then
         table_name := 'hos_store_dict';
         obj_code_where_field := 'store_code';
         obj_id_where_field := 'store_id';
         obj_history_where_field := 'c.check4_no=hd.store_no';
         obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
         obj_show_field := 'hd.store_id obj_id,hd.store_code obj_code,hd.store_name obj_name';
         obj_group_field := 'hd.store_id,hd.store_code,hd.store_name';
      else
         table_name := '';
         obj_where_field := '';
      end if;

      /*科目查询方式*/
      if subj_select_flag=2 then
          --2直接选择查询,
          subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
      elsif subj_select_flag=3 then
          --3按范围查询,
          subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
          subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
          subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
      elsif subj_select_flag=4 then
         --4弹出页面筛选查询
         --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
         subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
             and a.subj_code in('||subj_code||') ';   
     subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
      else
        --1查询全部
         subj_wheresql:=' ';
      end if;


      /*项目查询方式*/
      if obj_select_flag=2 then
          --2直接选择查询,
          obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
      elsif obj_select_flag=3 then
          --3按范围查询,
          obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
          obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
          obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
      elsif obj_select_flag=4 then
         --4弹出页面筛选查询
         obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
      else
        --1查询全部
         obj_wheresql:=' ';
      end if;

      --项目显示方式:0历史数据，1最新数据
      SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
      IF num = 0 THEN
           obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
      else
           obj_sql:=' and hd.is_stop=0 ';--显示最新数据
      end if;
      
      if is_happend = 1 then  
               happen_where:='where (exists(
                                    select 1 from t_groupaccsubjobj_result  t1
                                    where t1.obj_id=t.obj_id 
                                          and TO_NUMBER(t1.acc_year||''''||t1.acc_month) 
                                          between TO_NUMBER('||acc_year_b||''||acc_month_b||') 
                                          and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                          ))';
      else
            happen_where:='';
      end if;
      /*条件处理end*/

      /*明细账需要拼辅助核算字段*/
      check_insertsql:='';
      check_selectsql:='';
      check_joinsql:='';
      --check_resultsql:='';
      declare
          check_i integer;
          dict_show_para integer;
          dict_show_sql varchar2(100);
          TYPE ref_type IS REF CURSOR;--定义游标指针
          v_cursor ref_type;--定义游标变量
          check_type_id numeric(18);
          check_table varchar2(50);
          is_sys integer;
          column_id varchar2(50);
          column_no varchar2(50);
          column_code varchar2(50);
          column_name varchar2(50);
          column_check varchar2(50);
          is_change integer;
      begin
        check_i:=0;
        --dbms_output.put_line(ddl_sql);
        OPEN v_cursor FOR '
            select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
            where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
            and exists(
              select 1 from ACC_SUBJ hs
              where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
               '||subj_wheresql||'
              --and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
              and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
            ) and b.check_table=''HOS_STORE_DICT''
            order by b.sort_code'
            using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
        LOOP
        FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中

          EXIT WHEN v_cursor%NOTFOUND;
          check_i:=check_i+1;

          --系统核算
          if is_sys=1 then

              --有变更表需要取显示方式的参数
              dict_show_sql:='';
              if is_change=1 then
                  SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                  IF dict_show_para = 0 THEN
                       dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check4_no ';--显示历史数据
                  else
                       dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                  end if;
                 --要拼成的结果语句
                 --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                 --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
              end if;

              check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
              check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check4_id '||dict_show_sql;
              --要拼成的结果语句
              --check_selectsql:=check_selectsql||',hos_dept_dict.dept_code||' '||hos_dept_dict.dept_name ';
              --check_joinsql:=check_joinsql||' left join hos_dept_dict hos_dept_dict on hos_dept_dict.dept_id=c.check1_id '||dict_show_sql;

          --自定义核算
          elsif is_sys=0 then
                check_selectsql:=check_selectsql||','||column_check;
              --check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
              --where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
              --and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;
             --要拼成的结果语句
             /* ,(select check_item_code||' '||check_item_name from acc_check_item item
              where exists(
              select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
              and item.check_item_id=avz.check_item_id and avz.check_type_id=29
              )) check_name2*/


          end if;
          check_insertsql:=check_insertsql||',check'||check_i;

        /*只支持同时挂4个辅助核算*/
        if check_i=4 then
          exit;
        end if;
        end loop;
        CLOSE v_cursor;--关闭游标
      end;

      if acc_month_b='01' then

        /*年初余额*/
        summary:='上年结转';
        --dbms_output.put_line(ddl_sql);
        execute immediate 'insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
        select 1,''0000'',''00'','||obj_show_field||',''上年结转'',sum(c.sum_od),sum(c.sum_oc),0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) '||check_insertsql||',hs.is_check from acc_leder_check c
        inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
        inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
        '||check_joinsql||'
        where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
        '||subj_wheresql||'
        '||obj_wheresql||'
        '||source_wheresql||'
        group by '||obj_group_field||''||check_insertsql||',hs.is_check'
        using group_id,hos_id,copy_code,acc_year_b;

      else

        /*期初余额*/
        summary:='期初余额';
        --dbms_output.put_line(ddl_sql);
        execute immediate 'insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
        select 1,''0000'',''00'',t1.obj_id,t1.obj_code,t1.obj_name,''期初余额'',sum(t1.debit),sum(t1.credit),0,sum(t1.end_os)'||check_insertsql||',t1.is_check from
        (
          select '||obj_show_field||',sum(c.sum_od) debit,sum(c.sum_oc) credit,0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) end_os '||check_insertsql||',hs.is_check from acc_leder_check c
          inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
          '||check_joinsql||'
          where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          group by '||obj_group_field||''||check_insertsql||',is_check
          union all
          select '||obj_show_field||',sum(c.debit) debit,sum(c.credit) credit,0,
          sum(c.debit-c.credit) end_os
          '||check_insertsql||',hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                  and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
          '||check_joinsql||'
          where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
          and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          group by '||obj_group_field||''||check_insertsql||',hs.is_check
         ) t1 group by t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',t1.is_check'
         using group_id,hos_id,copy_code,acc_year_b,
        group_id,hos_id,copy_code,state,acc_year_b,acc_month_b;

      end if;
      
      
      /*本期发生凭证数据*/
      execute immediate 'insert into t_groupaccsubjobj_result(check_id,xh,acc_year,acc_month,vouch_date,vouch_no
      '||check_insertsql||'
      ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
      select c.vouch_check_id,2,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no||''-''||v.vouch_id vouch_no
      '||check_selectsql||'
      ,'||obj_show_field||',c.summary,c.debit,c.credit,0,
      ( c.debit-c.credit) end_os,hs.is_check
      from acc_vouch_check c
      inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                  and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
      inner join acc_vouch_type t on v.group_id=t.group_id 
              and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
      inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
      inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
      '||check_joinsql||'
      where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
      and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
      '||subj_wheresql||'
      '||obj_wheresql||'
      '||source_wheresql||'
      order by v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date,hs.is_check
      ' using group_id,hos_id,copy_code,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;
      
      /*本月合计数据*/
      ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
      select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本月合计'',sum(r.debit),sum(r.credit),0,0 end_os'||check_insertsql||',r.is_check
      from t_groupaccsubjobj_result r
      where r.xh=2
      group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name'||check_insertsql||',r.is_check
      ';
      --dbms_output.put_line(ddl_sql);
      execute immediate ddl_sql;

       /*本年累计数据*/
      ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
      select 4,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本年累计'',sum(r.debit),sum(r.credit),0,0 end_os,r.is_check
      from t_groupaccsubjobj_result r
      where r.xh=3
      group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,r.is_check
      ';
      --dbms_output.put_line(ddl_sql);
      execute immediate ddl_sql;
      
      /*计算本期发生凭证、本月合计余额*/
      --dbms_output.put_line(ddl_sql);
      execute immediate '
      declare
        end_os_sum numeric(19,2);
        end_os_month numeric(19,2);
        acc_month_y varchar2(2);
        obj_id numeric(18);
        xh integer;
        i number;
      begin
        i:=1;
        obj_id:=0;
        end_os_month:=0;
        for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.subj_code,r.subj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccsubjobj_result r
          where r.xh<4
          order by r.obj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.vouch_no asc,r.check_id asc) loop

          /*新的项目从0开始计算*/
          if obj_id<>cr.obj_id then
            end_os_sum:=0;

            /*有发生数据没有期初余额新增加一条期初余额*/
            if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then
                  
                  
                  if cr.acc_month = ''01'' then    
            insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,''上年结转'',0);
            
            else
              insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,''期初余额'',0);
            
             end if;
           
            end if;
          end if;
          
           if obj_id=cr.obj_id and cr.xh=2 and xh!=1 then

            if (acc_month_y!=cr.acc_month) then
                insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,subj_dire,summary,end_os)
                  values( 1,cr.acc_year,cr.acc_month,cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);
             
          
           end if;
          end if;

          end_os_sum:=end_os_sum+cr.end_os;

          /*本期发生凭证余额*/
          if cr.xh=2 then
             update t_groupaccsubjobj_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
          end if;
          /*本月合计余额*/
          if cr.xh=3 then
             update t_groupaccsubjobj_result set end_os=end_os_sum where xh=3 and obj_id=cr.obj_id
             and acc_year = cr.acc_year and acc_month=cr.acc_month;
          end if;
          
          /*本年累计余额*/
            if cr.xh=4 then
               update t_groupaccsubjobj_result set end_os=end_os_sum 
               where xh=4 and obj_id=cr.obj_id and acc_year = cr.acc_year and acc_month=cr.acc_month;
            end if;
            
          i:=i+1;
          obj_id:=cr.obj_id;
           acc_month_y:=cr.acc_month;
          xh:=cr.xh;
        end loop;
      end;
      ';

      /*本年累计数据*/
      /*ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||')
      select 4,t1.acc_year,t1.acc_month,t1.obj_id,t1.obj_code,t1.obj_name,''本年累计'',
      t1.debit+nvl((select r1.debit from t_groupaccsubjobj_result r1 where r1.xh=1 and r1.debit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
      t1.credit+nvl((select r1.credit from t_groupaccsubjobj_result r1 where r1.xh=1 and r1.credit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
      0,t1.end_os'||check_insertsql||' from
        (select 4,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,r.subj_code,r.subj_name,
        sum(r.debit) over(partition by r.acc_year,r.obj_id order by r.acc_month) debit,
        sum(r.credit) over(partition by r.acc_year,r.obj_id order by r.acc_month) credit,
        r.subj_dire,r.end_os'||check_insertsql||'
        from t_groupaccsubjobj_result r
        where r.xh=3
       ) t1

      ';
      --dbms_output.put_line(ddl_sql);
      execute immediate ddl_sql;*/

      /*返回结果集游标*/
      ddl_sql:='select 
        case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
        case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
        to_char(t.vouch_date,''dd'') day,t.vouch_no,t.obj_id,
        t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||',
        t.subj_code||'' ''||t.subj_name subj_name,t.summary,
        case when t.xh=1 then NULL else t.debit end debit,
        case when t.xh=1 then NULL else t.credit end credit,
        case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
      from t_groupaccsubjobj_result t
      '||happen_where||'
      order by t.obj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date asc ,t.vouch_no asc,t.check_id asc,t.is_check
      ';
      --dbms_output.put_line(ddl_sql);
      open objdata for ddl_sql ;--using acc_year_b,acc_month_b,acc_year_e,acc_month_e;

    END group_subjobjdetail_ck;
  
	]]></sql>
	
	<sql id="group_balancedetail_kf" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_balancedetail_kf
      /*集团====库房余额表*/
    (prm_group_id        number,
     prm_hos_id          number,
     prm_copy_code       varchar2,
     prm_acc_year_b      varchar2,
     prm_acc_month_b     varchar2,
     prm_acc_year_e      varchar2,
     prm_acc_month_e     varchar2,
     prm_is_state        integer, --包含未记账:1,99
     prm_is_end_os       integer, --显示有余额的项目:0,1
     prm_cur_code        varchar2, --币种
     prm_obj_select_flag integer, --项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
     prm_obj_code        varchar2, --项目条件多个值用逗号分隔。参数格式：1='，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
     prm_subj_select_flag integer, --科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
     prm_subj_code        varchar2, --科目条件多个值用逗号分隔。参数格式：1='，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
     cur_objdata         OUT ACT_BOOKS.balancecursor)
    
    
     IS
    
      ddl_sql      varchar2(4000);
      obj_wheresql varchar2(4000);
      emp_wheresql varchar2(100);
      endOsWhere   varchar2(100);
      subj_wheresql varchar2(4000);
      subj_code_begin varchar2(200);--开始科目编码
      subj_code_end varchar2(200);--结束科目编码
      subj_id varchar2(4000) ;
      num NUMBER;
    
    BEGIN
    
    
      /*结果集临时表*/
      --EXECUTE IMMEDIATE 'drop Table t_accbooksobjsubjledger_result';
      SELECT COUNT(1)
              INTO num
              FROM USER_TABLES
             WHERE TABLE_NAME = UPPER('t_groupbalancedetail_result_kf');
             IF num = 0 THEN
              execute immediate 'Create Global Temporary Table t_groupbalancedetail_result_kf(
                      idx numeric(2,0),
                      obj_id numeric(18,0),
                      obj_no numeric(18,0),
                      subj_level numeric(18,0),
                      obj_code varchar2(20),
                      obj_name varchar2(200),
                      nc_debit numeric(19,2),
                      nc_credit numeric(19,2),
                      qc_debit numeric(19,2),
                      qc_credit numeric(19,2),
                      bq_debit numeric(19,2),
                      bq_credit numeric(19,2),
                      lj_debit numeric(19,2),
                      lj_credit numeric(19,2),
                      end_debit numeric(19,2),
                      end_credit numeric(19,2),
                      is_check numeric(2),
                      subj_id numeric(18,0),
                      subj_code varchar2(20)
                      )On COMMIT Delete ROWS';
                    /*
                    On COMMIT PRESERVE ROWS 会话性临时表
                    On Commit Delete Rows 事务性临时表
                    */
            END IF;
           
            SELECT COUNT(1)
              INTO num
              FROM USER_TABLES
             WHERE TABLE_NAME = UPPER('t_groupbalancedetail_resultskf');
             IF num = 0 THEN
              execute immediate 'Create Global Temporary Table t_groupbalancedetail_resultskf(
                      idx numeric(2,0),
                      obj_id numeric(18,0),
                      obj_no numeric(18,0),
                      subj_level numeric(18,0),
                      obj_code varchar2(20),
                      obj_name varchar2(200),
                      nc_debit numeric(19,2),
                      nc_credit numeric(19,2),
                      qc_debit numeric(19,2),
                      qc_credit numeric(19,2),
                      bq_debit numeric(19,2),
                      bq_credit numeric(19,2),
                      lj_debit numeric(19,2),
                      lj_credit numeric(19,2),
                      end_debit numeric(19,2),
                      end_credit numeric(19,2),
                      is_check numeric(2),
                      subj_id numeric(18,0),
                      subj_code varchar2(20)
                      )On COMMIT Delete ROWS';
                    /*
                    On COMMIT PRESERVE ROWS 会话性临时表
                    On Commit Delete Rows 事务性临时表
                    */
            END IF;
    
      /*项目查询方式*/
      if prm_obj_select_flag = 2 then
        --2直接选择查询,
        obj_wheresql := ' and obj_code like ''' || prm_obj_code || '%'' ';
    
      elsif prm_obj_select_flag = 3 then
        --3按范围查询,
        obj_wheresql := ' and obj_code between ' ||
                        regexp_substr(prm_obj_code, '[^,]+', 1, 1, 'i') ||
                        ' and ' ||
                        regexp_substr(prm_obj_code, '[^,]+', 1, 2, 'i') || ' ';
      elsif prm_obj_select_flag = 4 then
        --4弹出页面筛选查询
        obj_wheresql := ' and obj_id in(' || prm_obj_code || ') ';
      else
        --1查询全部
        obj_wheresql := '';
      end if;
     
     /*科目查询方式*/
          if prm_subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and subj_code like '''||prm_subj_code||'%'' ';
          elsif prm_subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(prm_subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(prm_subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif prm_subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||prm_group_id||' and a.hos_id  = '||prm_hos_id||' and a.copy_code= '''||prm_copy_code||''' 
                         and a.subj_code in('||prm_subj_code||') ';  
             subj_wheresql:=' and subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;
    
    
            /*是否显示余额项目*/
            if prm_is_end_os = 1 then
              --2直接选择查询,
              endOsWhere := ' and nvl(end_debit,0) - nvl(end_credit,0) != 0 ';
            else
              endOsWhere := '';
            end if;
    
      insert into t_groupbalancedetail_result_kf (
             idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit,
             is_check,subj_id,subj_code
          )
          select 1 as idx,
              tempa1.check4_id, tempe1.store_code, tempe1.store_name,
              case when tempa1.subj_dire = 0 then nvl(tempb1.nc_debit,0)-nvl(tempb1.nc_credit,0) end as nc_debit,   --年初余额 借
              case when tempa1.subj_dire = 1 then nvl(tempb1.nc_credit,0)-nvl(tempb1.nc_debit,0) end as nc_credit,   --年初余额 贷
              case when tempa1.subj_dire = 0 then (nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0))-(nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)) end as qc_debit,  --期初余额 借
              case when tempa1.subj_dire = 1 then (nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0))-(nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)) end as qc_credit, --期初余额 贷
              nvl(tempd1.bq_debit,0),  --本期发生 借
              nvl(tempd1.bq_credit,0),   --本期发生 贷
              nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0),  --累计发生 借
              nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0),  --累计发生 贷
              case when tempa1.subj_dire = 0 then (nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0))-(nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0)) end as end_debit,  --期末余额 借
              case when tempa1.subj_dire = 1 then (nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0))-(nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0)) end as end_credit, --期末余额 贷
              tempb1.is_check,
              tempa1.subj_id,
              tempa1.subj_code
          from (
               ----有数据的科目
               select a.check4_id,a.check4_no,a.group_id,a.hos_id,a.copy_code,a.acc_year ,a.subj_id,b.subj_code,b.subj_dire 
               from acc_leder_check a
               left join acc_subj b on a.group_id = b.group_id and a.hos_id = b.hos_id 
                         and a.copy_code = b.copy_code and a.subj_id = b.subj_id  
               where a.group_id=prm_group_id
                     and a.hos_id=prm_hos_id
                     and a.copy_code=prm_copy_code
                     and a.acc_year = prm_acc_year_b
                     and nvl(a.check4_id,0)!=0
                     and TO_NUMBER(a.acc_year||''||a.acc_month) between TO_NUMBER(prm_acc_year_b||'00') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
                     and nvl(a.end_os,0)!=0
                union
                select a1.check4_id,a1.check4_no,a1.group_id,a1.hos_id,a1.copy_code,a1.acc_year,a1.subj_id,c1.subj_code,c1.subj_dire  
                from acc_vouch_check a1
                left join acc_vouch b1 on a1.group_id= b1.group_id and a1.hos_id=b1.hos_id and a1.copy_code=b1.copy_code
                     and a1.acc_year = b1.acc_year and a1.vouch_id=b1.vouch_id 
                left join acc_subj c1 on a1.group_id = c1.group_id and a1.hos_id = c1.hos_id
                          and a1.copy_code = c1.copy_code and a1.subj_id = c1.subj_id  
                where a1.group_id=prm_group_id and a1.hos_id=prm_hos_id and a1.copy_code=prm_copy_code
                      and a1.acc_year = prm_acc_year_b
                      and b1.state>=prm_is_state
                      and nvl(a1.check4_id,0)!=0
                      and TO_NUMBER(b1.acc_year||''||b1.acc_month) between TO_NUMBER(prm_acc_year_b||'01') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
          ) tempa1  left join(
           ---年初余额
           select a2.check4_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,a2.subj_id,
                  sum(case when b2.subj_dire=0 then nvl(a2.end_os,0) else 0 end) nc_debit,
                  sum(case when b2.subj_dire=1 then  nvl(a2.end_os,0) else 0 end) nc_credit,
                  b2.is_check
            from acc_leder_check a2
            left join acc_subj b2 on a2.group_id =b2.group_id and a2.hos_id=b2.hos_id  and a2.copy_code=b2.copy_code 
                 and a2.acc_year = b2.acc_year  and a2.subj_id=b2.subj_id 
            where a2.group_id=prm_group_id  and a2.hos_id=prm_hos_id and a2.copy_code=prm_copy_code
                  and a2.acc_year=prm_acc_year_b and a2.acc_month='00'
                  and nvl(a2.check4_id,0)!=0
            group by a2.check4_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,b2.is_check,a2.subj_id
          ) tempb1 on tempa1.group_id =tempb1.group_id and tempa1.hos_id =tempb1.hos_id 
            and tempa1.copy_code =tempb1.copy_code and tempa1.acc_year =tempb1.acc_year
            and tempa1.check4_id =tempb1.check4_id  and tempa1.subj_id =tempb1.subj_id  
          left join (
          --年初到开始日间中间数据
              select a.check4_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id,
                     sum(nvl(a.debit,0)) bfs_debit,
                     sum(nvl(a.credit,0)) bfs_credit
              from  acc_vouch b
              left join  acc_vouch_check a on b.group_id = a.group_id and  b.hos_id = a.hos_id 
                   and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id 
              where a.group_id=prm_group_id and a.hos_id=prm_hos_id 
                    and a.copy_code=prm_copy_code 
                    and b.acc_year = prm_acc_year_b
                    and b.state>=prm_is_state
                    and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||'01'
                    and TO_NUMBER(b.acc_year||''||b.acc_month) < prm_acc_year_b||''||prm_acc_month_b
                    and nvl(a.check4_id,0)!=0
               group by a.check4_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id
          ) tempc1 on tempa1.group_id =tempc1.group_id and tempa1.hos_id =tempc1.hos_id 
            and tempa1.copy_code =tempc1.copy_code and tempa1.acc_year =tempc1.acc_year
            and tempa1.check4_id =tempc1.check4_id   and tempa1.subj_id =tempc1.subj_id 
          left join(
          -- 本期发生数据
                select a.check4_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id,
                       sum(nvl(a.debit,0)) bq_debit,
                       sum(nvl(a.credit,0)) bq_credit
                from   acc_vouch b
                left join acc_vouch_check a  on b.group_id=a.group_id and b.hos_id=a.hos_id 
                     and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id 
                where a.group_id=prm_group_id and a.hos_id=prm_hos_id and a.copy_code=prm_copy_code
                      and a.acc_year =prm_acc_year_b  and b.state>=prm_is_state
                      and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||''||prm_acc_month_b
                      and TO_NUMBER(b.acc_year||''||b.acc_month) <= prm_acc_year_e||''||prm_acc_month_e
                      and nvl(a.check4_id,0)!=0
                group by a.check4_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id
          ) tempd1 on tempa1.group_id =tempd1.group_id and tempa1.hos_id =tempd1.hos_id 
            and tempa1.copy_code =tempd1.copy_code and tempa1.acc_year =tempd1.acc_year
            and tempa1.check4_id =tempd1.check4_id and tempa1.subj_id =tempd1.subj_id
          left join hos_store_dict  tempe1 on  tempa1.group_id =tempe1.group_id and tempa1.hos_id = tempe1.hos_id
               and  tempa1.check4_id =tempe1.store_id  and  tempa1.check4_no =tempe1.store_no;
          
          execute immediate '
           insert into t_groupbalancedetail_resultskf(
             idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit ,is_check
           ) select  idx,obj_id ,obj_code ,obj_name ,sum(nc_debit ),sum(nc_credit) ,sum(qc_debit) ,sum(qc_credit) ,sum(bq_debit ),sum(bq_credit),
           sum(lj_debit) , sum(lj_credit) ,sum(end_debit) ,sum(end_credit),is_check
                   from t_groupbalancedetail_result_kf
                   where idx =1  '||obj_wheresql||''||subj_wheresql||'
                   group by  idx,obj_id ,obj_code,obj_name ,is_check
          ';
          
                   --求总合计
                  insert into t_groupbalancedetail_resultskf(
                       idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit ,is_check 
                  )
                  select 2 as idx,'' obj_id,'总合计' as obj_code,'' as obj_name,
                     sum(nvl(nc_debit,0)) as nc_debit,
                     sum(nvl(nc_credit,0)) as nc_credit,
                     sum(nvl(qc_debit,0)) as qc_debit,
                     sum(nvl(qc_credit,0)) as qc_credit,
                     sum(nvl(bq_debit,0)) as bq_debit,
                     sum(nvl(bq_credit,0)) as bq_credit,
                     sum(nvl(lj_debit,0)) as lj_debit,
                     sum(nvl(lj_credit,0)) as lj_credit,
                     sum(nvl(end_debit,0)) as end_debit,
                     sum(nvl(end_credit,0)) as end_credit,
                     '' as is_check
                  from t_groupbalancedetail_resultskf
                  where idx = 1;
          if prm_subj_select_flag != '1'  then   
            
             ddl_sql := '
                  select
                      obj_code  ,obj_name , 
                      sum(nvl(nc_debit,0) ) as nc_debit,
                      sum(nvl(nc_credit,0)) as nc_credit,
                      sum(nvl(qc_debit,0) ) as qc_debit,
                      sum(nvl(qc_credit,0)) as qc_credit ,
                      sum(nvl(bq_debit,0)) as bq_debit ,
                      sum(nvl(bq_credit,0)) as bq_credit,
                      sum(nvl(lj_debit,0)) as lj_debit ,
                      sum(nvl(lj_credit,0)) as lj_credit ,
                      sum(nvl(end_debit,0)) as end_debit ,
                      sum(nvl(end_credit,0)) as end_credit 
                  from  t_groupbalancedetail_resultskf
                  where  (nvl(nc_debit,0)!=0 or  nvl(nc_credit,0)!=0 or  nvl(qc_debit,0)!=0 or  nvl(qc_credit,0)!=0
                      or  nvl(bq_debit,0)!=0  or  nvl(bq_credit,0)!=0 or  nvl(lj_debit,0)!=0 or  nvl(lj_credit,0)!=0
                      or  nvl(end_debit,0)!=0 or  nvl(end_credit,0)!=0 )
                  and obj_code is not null
                  '||endOsWhere||'
                  group by obj_code  ,obj_name 
              order by  obj_code';
          
          else 
            
           ddl_sql := 'select
                obj_code  ,obj_name , 
                sum(nvl(nc_debit,0)-nvl(nc_credit,0)) as nc_debit ,0 as nc_credit ,
                sum(nvl(qc_debit,0)-nvl(qc_credit ,0)) as qc_debit,0 as qc_credit,
                sum(nvl(bq_debit,0)) as bq_debit ,
                sum(nvl(bq_credit,0)) as bq_credit,sum(nvl(lj_debit,0)) as lj_debit ,
                sum(nvl(lj_credit ,0)) as lj_credit,
                sum(nvl(end_debit,0)-nvl(end_credit,0)) as  end_debit,
                0 as  end_credit
                 from  t_groupbalancedetail_resultskf
            where  (nvl(nc_debit,0)!=0 
                    or  nvl(nc_credit,0)!=0 
                    or  nvl(qc_debit,0)!=0 
                    or  nvl(qc_credit,0)!=0
                    or  nvl(bq_debit,0)!=0  
                    or  nvl(bq_credit,0)!=0 
                    or  nvl(lj_debit,0)!=0 or  nvl(lj_credit,0)!=0
                    or  nvl(end_debit,0)!=0 or  nvl(end_credit,0)!=0 )
                    and obj_code is not null
                    '||endOsWhere||'
                     group by obj_code  ,obj_name 
                     order by  obj_code';
         
          end if ; 
            open cur_objdata for ddl_sql;
    
    END group_balancedetail_kf;
  
	]]></sql>
	
	<sql id="group_objsubjgeneralled_dw" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_objsubjgeneralled_dw

      /*集团====单位科目总账*/
      (
       prm_group_id number,
       prm_hos_id number,
       prm_copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       objdata OUT ACT_BOOKS.objsubjgeneralcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
          subj_id varchar2(4000) ;
          num NUMBER;
      BEGIN

          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;


          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
          elsif table_flag = 8 then
             table_name := 'hos_info_dict';
             obj_code_where_field := 'hos_code';
             obj_id_where_field := 'hos_id';
             --obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check8_id=hd.hos_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';


          else
             table_name := '';
             obj_where_field := '';
          end if;

          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||prm_subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(prm_subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(prm_subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||prm_group_id||' and a.hos_id  = '||prm_hos_id||' and a.copy_code= '''||prm_copy_code||'''
                         and a.subj_code in('||prm_subj_code||') ';
             subj_wheresql:=' and hs.subj_id in('||prm_subj_code||') ';
          else
            --1查询全部
           -- subj_wheresql:='';
           subj_wheresql:='  and ((hs.check1= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
              and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
               and   act.check_type_id = hs.check1 and act.check_type_name=''单位'')) or
          (hs.check2= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check2 and act.check_type_name=''单位'')) or
          (hs.check3= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check3 and act.check_type_name=''单位'')) or
          (hs.check4= (select act.CHECK_TYPE_ID from ACC_CHECK_TYPE act where act.group_id='||prm_group_id||'
                        and act.hos_id='||prm_hos_id||' and act.copy_code='''||prm_copy_code||'''
                         and   act.check_type_id = hs.check4 and act.check_type_name=''单位'' ))
                         )';
          end if;


          /*单位查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;

          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=prm_group_id and hos_id=prm_hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          /*条件处理end*/


          if acc_month_b='01' then

            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',c.subj_id,hs.subj_code,hs.subj_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os),hs.is_check from acc_leder_check c
            inner join acc_subj hs on c.group_id =hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and hs.subj_id=c.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
            where c.group_id=:prm_group_id and c.hos_id=:prm_hos_id and c.copy_code=:prm_copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
            '||subj_wheresql||'
            '||obj_wheresql||'
            '||source_wheresql||'
            group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check'
            using prm_group_id,prm_hos_id,prm_copy_code,acc_year_b;

          else

            /*期初余额*/
            summary:='期初余额';
            execute immediate 'insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',t1.subj_id,t1.subj_code,t1.subj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os),t1.is_check from
            (
              select c.acc_year,c.acc_month,c.subj_id,hs.subj_code,hs.subj_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(c.end_os) end_os,hs.is_check
                from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
              where c.group_id=:prm_group_id and c.hos_id=:prm_hos_id and c.copy_code=:prm_copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by c.acc_year,c.acc_month,c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
              union all
              select c.acc_year,null as acc_month,c.subj_id,hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
                     sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              where v.group_id=:prm_group_id and v.hos_id=:prm_hos_id and v.copy_code=:prm_copy_code and v.state>=:state
                    and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
                    '||subj_wheresql||'
                    '||obj_wheresql||'
                    '||source_wheresql||'
              group by c.acc_year,v.acc_month,c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
             ) t1 group by t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check'
             using prm_group_id,prm_hos_id,prm_copy_code,acc_year_b,
            prm_group_id,prm_hos_id,prm_copy_code,state,acc_year_b,acc_month_b;

          end if;

          /*本月合计数据*/
          execute immediate 'insert into t_groupaccobjsubjledger_result(
          xh,acc_year,acc_month ,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 2,v.acc_year,v.acc_month,hs.subj_id,hs.subj_code,hs.subj_name,''本月合计'',sum(c.debit),sum(c.credit),hs.subj_dire,
                 case when subj_dire=1 then sum(c.credit)-sum(c.debit) else sum(c.debit)-sum(c.credit) end   end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code
          inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id =hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
          where v.group_id=:prm_group_id and v.hos_id=:prm_hos_id and v.copy_code=:prm_copy_code and v.state>=:state
                and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
                '||subj_wheresql||'
                '||obj_wheresql||'
                '||source_wheresql||'
          group by v.acc_year,v.acc_month,hs.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
          ' using prm_group_id,prm_hos_id,prm_copy_code,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;

          /*计算本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            subj_id numeric(18);
            xh integer;
            i number;
            begin
              i:=1;
              subj_id:=0;
              end_os_month:=0;
            for cr in (select r.xh,r.subj_id,r.subj_code,r.subj_name,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccobjsubjledger_result r
              where r.xh<3
              order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop

              /*新的科目从0开始计算*/
              if subj_id<>cr.subj_id then
                end_os_sum:=0;
                 if (cr.xh=2 ) or (i=1 and cr.xh>1) then
                    if cr.acc_month = ''01'' then
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''上年结转'',0);
                     else
                      insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''期初余额'',0);
                     end if;
                end if;
               end if;

                if subj_id=cr.subj_id and cr.xh=2 and xh!=1 then
                   --dbms_output.put_line(cr.subj_code);
                   --dbms_output.put_line(cr.acc_month);
                   insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,subj_dire,summary,end_os)
                   values( 1,cr.acc_year,cr.acc_month,cr.subj_id,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);

              end if;
              end_os_sum:=end_os_sum+cr.end_os;

              /*本月合计余额*/
              if cr.xh=2 then
                 update t_groupaccobjsubjledger_result set end_os=end_os_sum where xh=2 and subj_id=cr.subj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;

              i:=i+1;
              subj_id:=cr.subj_id;
              xh:=cr.xh;
            end loop;
          end; ';

          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccobjsubjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 3,t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,''本年累计'',
          t1.debit+nvl((select r1.debit from t_groupaccobjsubjledger_result r1 where r1.xh=1 and r1.debit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.credit+nvl((select r1.credit from t_groupaccobjsubjledger_result r1 where r1.xh=1 and r1.credit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.subj_dire,t1.end_os,t1.is_check from
            (select 3,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,
            sum(r.debit) over(partition by r.acc_year,r.subj_id order by r.acc_month) debit,
            sum(r.credit) over(partition by r.acc_year,r.subj_id order by r.acc_month) credit,
            r.subj_dire,r.end_os,r.is_check
            from t_groupaccobjsubjledger_result r
            where r.xh=2
           ) t1
          ';


          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;

      select count(1) into num from acc_subj a5 where a5.group_id = prm_group_id
                    and a5.hos_id = prm_hos_id
                    and a5.copy_code = prm_copy_code
                    and a5.acc_year = acc_year_b
                    and a5.subj_code like ''||prm_subj_code||'%' ;

         if num>1 then

               --逐级汇总
           insert into t_groupaccobjsubjledger_result
                          (xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit, end_os,
                     subj_dire )
                 select b.xh as xh,
                        a.acc_year,
                      '00' as acc_month  ,
                      a.subj_id,
                      a.subj_code,
                      a.subj_name,
                      b.summary,
                      sum(nvl(b.debit, 0)) as debit,
                      sum(nvl(b.credit, 0)) as credit ,
                    sum(nvl(b.end_os, 0)) as end_os ,
                   a.subj_dire
                 from (select distinct a5.acc_year,
                          a5.subj_id,
                          a5.subj_code,
                          a5.subj_name,
                          a5.subj_level,
                          a5.is_check,
                          a5.is_last,
                          a5.subj_dire
                    from acc_subj a5
                    where a5.group_id = prm_group_id
                    and a5.hos_id = prm_hos_id
                    and a5.copy_code = prm_copy_code
                    and a5.acc_year = acc_year_b
                    and a5.is_last = 0
                    and a5.is_stop = 0
                    and a5.subj_code like ''||prm_subj_code||'%'
                    ) a
               right join t_groupaccobjsubjledger_result b
               on b.subj_code like (a.subj_code || '%')
               group by a.acc_year,
                        a.subj_id,
                        a.subj_code,
                        a.subj_name,
                        b.summary,
                        b.xh,
                    a.subj_dire ;

               end if;
          ddl_sql:='
          select
                 case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
                  case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
                  t.subj_code||'' ''||t.subj_name subj_name,
                  t.summary,
                    t.debit   debit,
                   t.credit   credit,
                  case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,
                  t.end_os
          from t_groupaccobjsubjledger_result t

          order by t.subj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc';
          open objdata for ddl_sql;

  END group_objsubjgeneralled_dw;
		
	]]></sql>
	
	<sql id="group_objsubjdetail_dw" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_objsubjdetail_dw

  /*集团======单位科目明细账*/
      (
       group_id number,
       hos_id number,
       copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       is_happend integer,--无发生不显示期初余额0,1
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       objdata OUT ACT_BOOKS.objsubjcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_name_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_show_field varchar2(200);--要显示的动态字段
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          check_insertsql varchar2(500);--辅助核算添加动态字段
          check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
          check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
           subj_id varchar2(4000) ;
          num NUMBER;
          happen_where varchar2(4000);
      BEGIN
     
          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;
          
          
          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_name_where_field:='dept_name';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.dept_code obj_code,hd.dept_name obj_name';
             
          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_name_where_field:='emp_name';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.emp_code obj_code,hd.emp_name obj_name';
             
          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_name_where_field:='proj_name';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.proj_code obj_code,hd.proj_name obj_name';
            
          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_name_where_field:='sup_name';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.sup_code obj_code,hd.sup_name obj_name';
             
          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_name_where_field:='cus_name';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.cus_code obj_code,hd.cus_name obj_name';
             
          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_name_where_field:='store_name';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.store_code obj_code,hd.store_name obj_name';
         elsif table_flag = 8 then
             table_name := 'hos_info_dict';
             obj_code_where_field := 'hos_code';
             obj_name_where_field:='hos_name';
             obj_id_where_field := 'hos_id';
             --obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check8_id=hd.hos_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.hos_code obj_code,hd.hos_name obj_name';             
          else
             table_name := '';
             obj_where_field := '';
          end if;
    
          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
            -- subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
              subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
                         and a.subj_code in('||subj_code||') ';  
              
             subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;
    
    
          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;
    
          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
              -- obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
               obj_sql:=' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          
          if is_happend = 1 then
               happen_where:='where (exists(
                                    select 1 from t_groupaccobjsubj_result t1
                                    where t1.subj_id=t.subj_id 
                                          and TO_NUMBER(t1.acc_year||''''||t1.acc_month) 
                                          between TO_NUMBER('||acc_year_b||''||acc_month_b||') 
                                          and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                          ))';
             else
               happen_where:='';
          end if;
          
          /*条件处理end*/
    
          /*明细账需要拼辅助核算字段*/
          check_insertsql:='';
          check_selectsql:='';
          check_joinsql:='';
          --check_resultsql:='';
          declare
              check_i integer;
              dict_show_para integer;
              dict_show_sql varchar2(100);
              TYPE ref_type IS REF CURSOR;--定义游标指针
              v_cursor ref_type;--定义游标变量
              check_type_id numeric(18);
              check_table varchar2(50);
              is_sys integer;
              column_id varchar2(50);
              column_no varchar2(50);
              column_code varchar2(50);
              column_name varchar2(50);
              column_check varchar2(50);
              is_change integer;
          begin
            check_i:=0;
            --dbms_output.put_line(ddl_sql);
            OPEN v_cursor FOR '
                select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
                where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
                and exists(
                  select 1 from ACC_SUBJ hs
                  where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
                   '||subj_wheresql||'
                  --and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
                  and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
                ) and b.check_type_id<>3
                order by b.sort_code' 
                using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
            LOOP
            FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中
    
              EXIT WHEN v_cursor%NOTFOUND;    
              check_i:=check_i+1;
    
              --系统核算
              if is_sys=1 then
                
                  --有变更表需要取显示方式的参数
                  dict_show_sql:='';
                  if is_change=1 then
                      SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                      IF dict_show_para = 0 THEN
                           dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check1_no ';--显示历史数据
                      else
                           dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                      end if;
                      
                  end if;
    
                  check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
                  check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check1_id '||dict_show_sql;
                   
              --自定义核算
              elsif is_sys=0 then
                    check_selectsql:=check_selectsql||','||column_check;
            
              end if;
              check_insertsql:=check_insertsql||',check'||check_i;
    
            /*只支持同时挂4个辅助核算*/
            if check_i=4 then
              exit;
            end if;     
            end loop;
            CLOSE v_cursor;--关闭游标
          end;
    
          if acc_month_b='01' then
    
            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',c.subj_id,hs.subj_code,hs.subj_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os),hs.is_check 
            from acc_leder_check c
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
            where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
            '||subj_wheresql||'
            '||obj_wheresql||'
            '||source_wheresql||'
            group by c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check ' 
            using group_id,hos_id,copy_code,acc_year_b;
    
          else
    
            /*期初余额*/
            summary:='期初余额';
            ddl_sql:='select c.subj_id,'||obj_show_field||',hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
              sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check 
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
              and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by hd.'||obj_code_where_field||',hd.'||obj_name_where_field||',c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check 
             ) t1 group by t1.obj_code,t1.obj_name,t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check ';
              
            dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,obj_code,obj_name,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check )
            select 1,''0000'',''00'',obj_code,obj_name,t1.subj_id,t1.subj_code,t1.subj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os),t1.is_check  from
            (
              select c.subj_id,'||obj_show_field||',hs.subj_code,hs.subj_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(c.end_os) end_os,hs.is_check  
              from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
              where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by hd.'||obj_code_where_field||',hd.'||obj_name_where_field||',c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check 
              union all
              select c.subj_id,'||obj_show_field||',hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
              sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check 
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
              and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by hd.'||obj_code_where_field||',hd.'||obj_name_where_field||',c.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check 
             ) t1 group by t1.obj_code,t1.obj_name,t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check ' 
             using group_id,hos_id,copy_code,acc_year_b,
            group_id,hos_id,copy_code,state,acc_year_b,acc_month_b;
    
          end if;
    
          /*本期发生凭证数据*/
          execute immediate 'insert into t_groupaccobjsubj_result(check_id,xh,acc_year,acc_month,vouch_date,vouch_no,obj_code,obj_name
          '||check_insertsql||'
          ,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check )
          select c.vouch_check_id,2,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no||''-''||v.vouch_id vouch_no,'||obj_show_field||'
          '||check_selectsql||'
          ,hs.subj_id,hs.subj_code,hs.subj_name,c.summary,c.debit,c.credit,hs.subj_dire,
          (case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check 
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id 
                and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
          '||check_joinsql||'
          where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
          and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          order by v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date
          ' using group_id,hos_id,copy_code,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;
    
          /*本月合计数据*/
          ddl_sql:='insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check )
          select 3,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,''本月合计'',sum(r.debit),sum(r.credit),r.subj_dire,0 end_os,r.is_check 
          from t_groupaccobjsubj_result r
          where r.xh=2
          group by r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,r.subj_dire,r.is_check 
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
    
    
          /*计算本期发生凭证、本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            acc_month_y varchar2(2);
            subj_id numeric(18);
            xh integer;
            i number;
          begin
            i:=1;
            subj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.subj_id,r.subj_code,r.subj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccobjsubj_result r
              where r.xh<4
              order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.vouch_no asc,r.check_id asc) loop
    
              /*新的科目从0开始计算*/
              if subj_id<>cr.subj_id then
                end_os_sum:=0;
    
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then
                     
                     
                         if cr.acc_month = ''01'' then    
                 insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''上年结转'',0);
                else
                   insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''期初余额'',0);
                  end if;
                
                end if;
              end if;
    
               if subj_id=cr.subj_id and cr.xh=2 and xh!=1 then
                
    
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (acc_month_y!=cr.acc_month) then
                      insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.subj_id,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);
                end if;
              end if;
    
    
              end_os_sum:=end_os_sum+cr.end_os;
    
              /*本期发生凭证余额*/
              if cr.xh=2 then
                 update t_groupaccobjsubj_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
              end if;
              /*本月合计余额*/
              if cr.xh=3 then
                 update t_groupaccobjsubj_result set end_os=end_os_sum where xh=3 and subj_id=cr.subj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;
    
              i:=i+1;
              subj_id:=cr.subj_id;
              acc_month_y:=cr.acc_month;
              xh:=cr.xh;
            end loop;
          end;
          ';
    
          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccobjsubj_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check )
          select 4,t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,''本年累计'',
          t1.debit+nvl((select r1.debit from t_groupaccobjsubj_result r1 where r1.xh=1 and r1.debit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.credit+nvl((select r1.credit from t_groupaccobjsubj_result r1 where r1.xh=1 and r1.credit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||acc_year_b||'''),0),
          t1.subj_dire,t1.end_os,t1.is_check  from
            (select 4,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,
            sum(r.debit) over(partition by r.acc_year,r.subj_id order by r.acc_month) debit,
            sum(r.credit) over(partition by r.acc_year,r.subj_id order by r.acc_month) credit,
            r.subj_dire,r.end_os,r.is_check 
            from t_groupaccobjsubj_result r
            where r.xh=3
           ) t1
    
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
    
          /*返回结果集游标*/
          ddl_sql:='select 
          case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
          case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
          to_char(t.vouch_date,''dd'') day,t.vouch_no,
          t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||'
          ,t.subj_code||'' ''||t.subj_name subj_name,t.summary,
          case when t.xh=1 then NULL else t.debit end debit,
          case when t.xh=1 then NULL else t.credit end credit,
          case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check 
          from t_groupaccobjsubj_result t
          '||happen_where||'
          order by t.subj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date asc,t.vouch_no asc,t.check_id asc
          ';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql ;--using acc_year_b,acc_month_b,acc_year_e,acc_month_e;

  END group_objsubjdetail_dw;
  
	]]></sql>
	
	<sql id="group_subjobjgeneralled_dw" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_subjobjgeneralled_dw
      /*集团========科目单位总账*/
      (
       group_id number,
       hos_id number,
       copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       is_happend integer,
       objdata OUT ACT_BOOKS.subjobjgeneralcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_show_field varchar2(200);--要显示的动态字段
          obj_group_field varchar2(200);--要分组的动态字段
          obj_group_field1 varchar2(200);--要分组的动态字段
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          check_insertsql varchar2(500);--辅助核算添加动态字段
          check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
          check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
          subj_id varchar2(4000) ;
          num NUMBER;
          happen_where varchar2(4000);
      BEGIN
     
          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;
    
          obj_group_field1 := 'r1.obj_id,r1.obj_code,r1.obj_name';
          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.dept_id obj_id,hd.dept_code obj_code,hd.dept_name obj_name';
             obj_group_field := 'hd.dept_id,hd.dept_code,hd.dept_name';
          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.emp_id obj_id,hd.emp_code obj_code,hd.emp_name obj_name';
             obj_group_field := 'hd.emp_id,hd.emp_code,hd.emp_name';
          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.proj_id obj_id,hd.proj_code obj_code,hd.proj_name obj_name';
             obj_group_field := 'hd.proj_id,hd.proj_code,hd.proj_name';
          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.sup_id obj_id,hd.sup_code obj_code,hd.sup_name obj_name';
             obj_group_field := 'hd.sup_id,hd.sup_code,hd.sup_name';
          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.cus_id obj_id,hd.cus_code obj_code,hd.cus_name obj_name';
             obj_group_field := 'hd.cus_id,hd.cus_code,hd.cus_name';
          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.store_id obj_id,hd.store_code obj_code,hd.store_name obj_name';
             obj_group_field := 'hd.store_id,hd.store_code,hd.store_name';
          elsif table_flag = 8 then
             table_name := 'hos_info_dict';
             obj_code_where_field := 'hos_code';
             obj_id_where_field := 'hos_id';
             --obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check8_id=hd.hos_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.hos_id obj_id,hd.hos_code obj_code,hd.hos_name obj_name';
             obj_group_field := 'hd.hos_id,hd.hos_code,hd.hos_name';    
          else
             table_name := '';
             obj_where_field := '';
          end if;
    
          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
               subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
                         and a.subj_code in('||subj_code||') ';   
               subj_wheresql:=' and hs.subj_id in('||subj_id||') '; 
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;
    
    
          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;
    
          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               --obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
               obj_sql:=' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          
          if is_happend = 1 then
               happen_where:='where (exists(
                                    select 1 from t_groupaccsubjobjledger_result t1
                                    where t1.obj_id=t.obj_id 
                                          and TO_NUMBER(t1.acc_year||''''||t1.acc_month) 
                                          between TO_NUMBER('||acc_year_b||''||acc_month_b||') 
                                          and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                          ))';
             else
               happen_where:='';
          end if;
          /*条件处理end*/
    
          /*明细账需要拼辅助核算字段*/
          check_insertsql:='';
          check_selectsql:='';
          check_joinsql:='';
          --check_resultsql:='';
          declare
              check_i integer;
              dict_show_para integer;
              dict_show_sql varchar2(100);
              TYPE ref_type IS REF CURSOR;--定义游标指针
              v_cursor ref_type;--定义游标变量
              check_type_id numeric(18);
              check_table varchar2(50);
              is_sys integer;
              column_id varchar2(50);
              column_no varchar2(50);
              column_code varchar2(50);
              column_name varchar2(50);
              column_check varchar2(50);
              is_change integer;
          begin
            check_i:=0;
            --dbms_output.put_line(ddl_sql);
            OPEN v_cursor FOR '
                select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check from ACC_CHECK_TYPE b
                where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
                and exists(
                  select 1 from ACC_SUBJ hs
                  where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
                   '||subj_wheresql||'
                  --and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
                  and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
                ) and b.check_type_id<>3
                order by b.sort_code'
                using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
            LOOP
            FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中
    
              EXIT WHEN v_cursor%NOTFOUND;
              check_i:=check_i+1;
    
              --系统核算
              if is_sys=1 then
    
                  --有变更表需要取显示方式的参数
                  dict_show_sql:='';
                  if is_change=1 then
                      SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                      IF dict_show_para = 0 THEN
                           dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check1_no ';--显示历史数据
                      else
                           dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                      end if;
                     --要拼成的结果语句
                     --dict_show_sql:=' and hos_dept_dict.dept_no=c.check1_no ';--显示历史数据
                     --dict_show_sql:=' and hos_dept_dict.is_stop=0 ';--显示最新数据
                  end if;
    
                  check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
                  check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check1_id '||dict_show_sql;
                   
              --自定义核算
              elsif is_sys=0 then
                    check_selectsql:=check_selectsql||','||column_check;
               
              end if;
              check_insertsql:=check_insertsql||',check'||check_i;
    
            /*只支持同时挂4个辅助核算*/
            if check_i=4 then
              exit;
            end if;
            end loop;
            CLOSE v_cursor;--关闭游标
          end;
    
          if acc_month_b='01' then
    
            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month'||check_insertsql||',
            obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'''||check_insertsql||','||obj_show_field||',''上年结转'',sum(c.sum_od),sum(c.sum_oc),0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) 
            ,hs.is_check
            from acc_leder_check c
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
             '||check_joinsql||'
            where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
            '||subj_wheresql||'
            '||obj_wheresql||'
            '||source_wheresql||'
            group by '||obj_group_field||''||check_insertsql||',hs.is_check'
            using group_id,hos_id,copy_code,acc_year_b;
    
          else
            
            /*期初余额*/
            summary:='期初余额';
           ddl_sql:='insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month'||check_insertsql||',obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'''||check_insertsql||',t1.obj_id,t1.obj_code,t1.obj_name,''期初余额'',sum(t1.debit),sum(t1.credit),1,sum(t1.end_os),t1.is_check from
            (
              select '||obj_show_field||''||check_insertsql||',sum(c.sum_od) debit,sum(c.sum_oc) credit,0 subj_dire ,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) end_os 
              ,hs.is_check
              from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
               '||check_joinsql||'
              where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by '||obj_group_field||''||check_insertsql||',hs.is_check
              union all';
              dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month'||check_insertsql||',obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'''||check_insertsql||',t1.obj_id,t1.obj_code,t1.obj_name,''期初余额'',sum(t1.debit),sum(t1.credit),1,sum(t1.end_os),t1.is_check from
            (
              select '||obj_show_field||''||check_insertsql||',sum(c.sum_od) debit,sum(c.sum_oc) credit,0 subj_dire ,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) end_os 
              ,hs.is_check
              from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
               '||check_joinsql||'
              where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by '||obj_group_field||''||check_insertsql||',hs.is_check
              union all
              select '||obj_show_field||''||check_insertsql||',sum(c.debit) debit,sum(c.credit) credit,0 subj_dire ,
              sum(c.debit-c.credit) end_os,hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
               '||check_joinsql||'
              where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
              and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by '||obj_group_field||''||check_insertsql||',hs.is_check
             ) t1 group by t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',t1.is_check'
             using group_id,hos_id,copy_code,acc_year_b,
            group_id,hos_id,copy_code,state,acc_year_b,acc_month_b;
    
          end if;
    
    --dbms_output.put_line(obj_show_field);
    
          /*本月合计数据*/
          execute immediate 'insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month
          '||check_insertsql||'
          ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 2,v.acc_year,v.acc_month
          '||check_insertsql||'
          ,'||obj_show_field||',''本月合计'',sum(c.debit),sum(c.credit),0 subj_dire,
           sum(c.debit)-sum(c.credit)   end_os,hs.is_check      
          from acc_vouch_check c
          left join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_vouch_type t on v.group_id=t.group_id 
                and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
           '||check_joinsql||'
          where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
          and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          group by v.acc_year,v.acc_month,'||obj_group_field||' '||check_insertsql||',hs.is_check
          ' using group_id,hos_id,copy_code,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;
    
          /*计算本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            obj_id numeric(18);
            xh integer;
            i number;
          begin
            i:=1;
            obj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.end_os,r.acc_year,r.acc_month,subj_dire from t_groupaccsubjobjledger_result r
              where r.xh<3
              order by r.obj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop
    
              /*新的项目从0开始计算*/
              if obj_id<>cr.obj_id then
                end_os_sum:=0;
                   
                   if (cr.xh=2 ) or (i=1 and cr.xh>1) then
                     if cr.acc_month = ''01'' then
                           insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''上年结转'',0);
               
                     else
                            insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''期初余额'',0);
               
                     end if;
                end if; 
              end if;
              
               if obj_id=cr.obj_id and cr.xh=2 and xh!=1 then
        
               insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_dire,''期初余额'',end_os_sum);
                
                end if;
    
              end_os_sum:=end_os_sum+cr.end_os;
    
              /*本月合计余额*/
              if cr.xh=2 then
                 update t_groupaccsubjobjledger_result set end_os=end_os_sum where xh=2 and obj_id=cr.obj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;
    
              i:=i+1;
              obj_id:=cr.obj_id;
              xh:=cr.xh;
            end loop;
          end;
          ';
    
          /*本年累计数据*/
          ddl_sql:='insert into t_groupaccsubjobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name'||check_insertsql||',summary,debit,credit,subj_dire,end_os,is_check)
          select 3,t1.acc_year,t1.acc_month,t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',''本年累计'',
          t1.debit+nvl((select sum(r1.debit) from t_groupaccsubjobjledger_result r1 where r1.xh=1 and r1.debit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||''' ),0),
          t1.credit+nvl((select sum(r1.credit) from t_groupaccsubjobjledger_result r1 where r1.xh=1 and r1.credit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||acc_year_b||'''),0),
          0 subj_dire,t1.end_os,t1.is_check from
            (select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name'||check_insertsql||',
            sum(r.debit) over(partition by r.acc_year,r.obj_id order by r.acc_month) debit,
            sum(r.credit) over(partition by r.acc_year,r.obj_id order by r.acc_month) credit,
            r.subj_dire,r.end_os,r.is_check
            from t_groupaccsubjobjledger_result r
            where r.xh=2
           ) t1
    
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
    
          /*返回结果集游标*/
          ddl_sql:='select 
          case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
          case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
          t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||'
          ,subj_code||'' ''||subj_name subj_name,t.summary,
          case when t.xh=1 then NULL else t.debit end debit,
          case when t.xh=1 then NULL else t.credit end credit,
          case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,
          t.xh,t.is_check
          from t_groupaccsubjobjledger_result t
         
          order by  obj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc
          ';
          --ddl_sql:='select * from t_groupaccsubjobjledger_result ';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql;
  END group_subjobjgeneralled_dw;
	]]></sql>
	
	<sql id="group_subjobjdetail_dw" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_subjobjdetail_dw

/*集团===========科目单位明细账*/
  (  group_id number,
       hos_id number,
       copy_code varchar2,
       acc_year_b varchar2,
       acc_month_b varchar2,
       acc_year_e varchar2,
       acc_month_e varchar2,
       state integer,--包含未记账:1,99
       is_happend integer,--无发生不显示期初余额0,1
       subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       obj_select_flag integer,--项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       obj_code varchar2,--项目条件多个值用逗号分隔。参数格式：1=''，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
       source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       objdata OUT ACT_BOOKS.subjobjcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          table_name varchar2(200);--动态表名称
          obj_code_where_field varchar2(200);--查询所用的动态字段名称
          obj_id_where_field varchar2(200);--查询所用的动态字段名称
          obj_history_where_field varchar2(200);--历史记录动态条件
          obj_show_field varchar2(200);--要显示的动态字段
          obj_group_field varchar2(200);--要分组的动态字段
          obj_where_field varchar2(200);--id关联动态条件
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          check_insertsql varchar2(500);--辅助核算添加动态字段
          check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
          check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
          subj_id varchar2(4000) ;
          num NUMBER;
          happen_where varchar2(4000);
      BEGIN
     
          /*条件处理begin*/
          if source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||source_id||') ';--资金来源ID
          end if;
    
    
          if table_flag  = 1 then
             table_name := 'hos_dept_dict';
             obj_code_where_field := 'dept_code';
             obj_id_where_field := 'dept_id';
             obj_history_where_field := 'c.check1_no=hd.dept_no';
             obj_where_field := 'c.check1_id=hd.dept_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.dept_id obj_id,hd.dept_code obj_code,hd.dept_name obj_name';
             obj_group_field := 'hd.dept_id,hd.dept_code,hd.dept_name';
          elsif table_flag = 2 then
             table_name := 'hos_emp_dict';
             obj_code_where_field := 'emp_code';
             obj_id_where_field := 'emp_id';
             obj_history_where_field := 'c.check2_no=hd.emp_no';
             obj_where_field := 'c.check2_id=hd.emp_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.emp_id obj_id,hd.emp_code obj_code,hd.emp_name obj_name';
             obj_group_field := 'hd.emp_id,hd.emp_code,hd.emp_name';
          elsif table_flag = 3 then
             table_name := 'hos_proj_dict';
             obj_code_where_field := 'proj_code';
             obj_id_where_field := 'proj_id';
             obj_history_where_field := 'c.check3_no=hd.proj_no';
             obj_where_field := 'c.check3_id=hd.proj_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.proj_id obj_id,hd.proj_code obj_code,hd.proj_name obj_name';
             obj_group_field := 'hd.proj_id,hd.proj_code,hd.proj_name';
          elsif table_flag = 6 then
             table_name := 'hos_sup_dict';
             obj_code_where_field := 'sup_code';
             obj_id_where_field := 'sup_id';
             obj_history_where_field := 'c.check6_no=hd.sup_no';
             obj_where_field := 'c.check6_id=hd.sup_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.sup_id obj_id,hd.sup_code obj_code,hd.sup_name obj_name';
             obj_group_field := 'hd.sup_id,hd.sup_code,hd.sup_name';
          elsif table_flag = 5 then
             table_name := 'hos_cus_dict';
             obj_code_where_field := 'cus_code';
             obj_id_where_field := 'cus_id';
             obj_history_where_field := 'c.check5_no=hd.cus_no';
             obj_where_field := 'c.check5_id=hd.cus_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.cus_id obj_id,hd.cus_code obj_code,hd.cus_name obj_name';
             obj_group_field := 'hd.cus_id,hd.cus_code,hd.cus_name';
          elsif table_flag = 4 then
             table_name := 'hos_store_dict';
             obj_code_where_field := 'store_code';
             obj_id_where_field := 'store_id';
             obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check4_id=hd.store_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.store_id obj_id,hd.store_code obj_code,hd.store_name obj_name';
             obj_group_field := 'hd.store_id,hd.store_code,hd.store_name';
           elsif table_flag = 8 then
             table_name := 'hos_info_dict';
             obj_code_where_field := 'hos_code';
             obj_id_where_field := 'hos_id';
             --obj_history_where_field := 'c.check4_no=hd.store_no';
             obj_where_field := 'c.check8_id=hd.hos_id and c.hos_id=hd.hos_id and c.group_id =hd.group_id';
             obj_show_field := 'hd.hos_id obj_id,hd.hos_code obj_code,hd.hos_name obj_name';
             obj_group_field := 'hd.hos_id,hd.hos_code,hd.hos_name';
          else
             table_name := '';
             obj_where_field := '';
          end if;
    
          /*科目查询方式*/
          if subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||subj_code||'%'' ';
          elsif subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif subj_select_flag=4 then
             --4弹出页面筛选查询
            -- subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
            subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||group_id||' and a.hos_id  = '||hos_id||' and a.copy_code= '''||copy_code||''' 
                         and a.subj_code in('||subj_code||') ';   
           subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;
    
    
          /*项目查询方式*/
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
             
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;
    
          --项目显示方式:0历史数据，1最新数据
          SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
             --  obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
               obj_sql:=' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;
          
          if is_happend = 1 then  
                   happen_where:='where (exists(
                                        select 1 from t_groupaccsubjobj_result  t1
                                        where t1.obj_id=t.obj_id 
                                              and TO_NUMBER(t1.acc_year||''''||t1.acc_month) 
                                              between TO_NUMBER('||acc_year_b||''||acc_month_b||') 
                                              and TO_NUMBER('||acc_year_e||''||acc_month_e||')
                                              ))';
          else
                happen_where:='';
          end if;
          --happen_where
          
          /*条件处理end*/
    
          /*明细账需要拼辅助核算字段*/
          check_insertsql:='';
          check_selectsql:='';
          check_joinsql:='';
          --check_resultsql:='';
          declare
              check_i integer;
              dict_show_para integer;
              dict_show_sql varchar2(100);
              TYPE ref_type IS REF CURSOR;--定义游标指针
              v_cursor ref_type;--定义游标变量
              check_type_id numeric(18);
              check_table varchar2(50);
              is_sys integer;
              column_id varchar2(50);
              column_no varchar2(50);
              column_code varchar2(50);
              column_name varchar2(50);
              column_check varchar2(50);
              is_change integer;
          begin
            check_i:=0;
            --dbms_output.put_line(ddl_sql);
            OPEN v_cursor FOR '
                select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change,b.column_check 
                from ACC_CHECK_TYPE b
                where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
                and exists(
                  select 1 from ACC_SUBJ hs
                  where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code 
                        and hs.acc_year=:acc_year_b
                   '||subj_wheresql||' 
                    --and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
                  and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
                ) and b.check_table =''HOS_DEPT_DICT''
                order by b.sort_code'
                using group_id,hos_id,copy_code,acc_year_b; --打开游标（执行动态SQL）
            LOOP
            FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change,column_check;--从游标中取一条记录，存放到变量v_record中
    
              EXIT WHEN v_cursor%NOTFOUND;
              check_i:=check_i+1;
    
              --系统核算
              if is_sys=1 then
    
                  --有变更表需要取显示方式的参数
                  dict_show_sql:='';
                  if is_change=1 then
                      SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                      IF dict_show_para = 0 THEN
                           dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check1_no ';--显示历史数据
                      else
                           dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                      end if;
                      
                  end if;
    
                  check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
                  check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check1_id '||dict_show_sql;
                  
              --自定义核算
              elsif is_sys=0 then
                    check_selectsql:=check_selectsql||','||column_check;
                 
    
              end if;
              check_insertsql:=check_insertsql||',check'||check_i;
    
            /*只支持同时挂4个辅助核算*/
            if check_i=4 then
              exit;
            end if;
            end loop;
            CLOSE v_cursor;--关闭游标
          end;
    
    
          if acc_month_b='01' then
    
            /*年初余额*/
            summary:='上年结转';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
            select 1,''0000'',''00'','||obj_show_field||',''上年结转'',sum(c.sum_od),sum(c.sum_oc),0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) '||check_insertsql||',hs.is_check 
            from acc_leder_check c
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
            '||check_joinsql||'
            where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
            '||subj_wheresql||'
            '||obj_wheresql||'
            '||source_wheresql||'
            group by '||obj_group_field||''||check_insertsql||',hs.is_check'
            using group_id,hos_id,copy_code,acc_year_b;
    
          else
    
            /*期初余额*/
            summary:='期初余额';
            ddl_sql:=' select '||obj_show_field||',sum(c.debit) debit,sum(c.credit) credit,0,
              sum(c.debit-c.credit) end_os
              '||check_insertsql||',hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                      and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
                inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              '||check_joinsql||'
              where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
              and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by '||obj_group_field||''||check_insertsql||',hs.is_check
             ) t1 group by t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',t1.is_check';
            dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||',is_check)
            select 1,''0000'',''00'',t1.obj_id,t1.obj_code,t1.obj_name,''期初余额'',sum(t1.debit),sum(t1.credit),0,sum(t1.end_os)'||check_insertsql||',t1.is_check from
            (
              select '||obj_show_field||',sum(c.sum_od) debit,sum(c.sum_oc) credit,0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) end_os '||check_insertsql||' ,hs.is_check
              from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                      and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||' '||obj_sql||'
              '||check_joinsql||'
              where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by '||obj_group_field||''||check_insertsql||',hs.is_check
              union all
              select '||obj_show_field||',sum(c.debit) debit,sum(c.credit) credit,0,
              sum(c.debit-c.credit) end_os
              '||check_insertsql||',hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                      and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
                inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
              '||check_joinsql||'
              where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
              and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
              '||subj_wheresql||'
              '||obj_wheresql||'
              '||source_wheresql||'
              group by '||obj_group_field||''||check_insertsql||',hs.is_check
             ) t1 group by t1.obj_id,t1.obj_code,t1.obj_name'||check_insertsql||',t1.is_check'
             using group_id,hos_id,copy_code,acc_year_b,
            group_id,hos_id,copy_code,state,acc_year_b,acc_month_b;
          end if;
          
          /*本期发生凭证数据*/
          execute immediate 'insert into t_groupaccsubjobj_result(check_id,xh,acc_year,acc_month,vouch_date,vouch_no
          '||check_insertsql||'
          ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select c.vouch_check_id,2,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no||''-''||v.vouch_id vouch_no
          '||check_selectsql||'
          ,'||obj_show_field||',c.summary,c.debit,c.credit,0,
          ( c.debit-c.credit) end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                      and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
            inner join acc_vouch_type t on v.group_id=t.group_id 
                  and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          inner join '||table_name||' hd on '||obj_where_field||'  '||obj_sql||'
          '||check_joinsql||'
          where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
          and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
          '||subj_wheresql||'
          '||obj_wheresql||'
          '||source_wheresql||'
          order by v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date
          ' using group_id,hos_id,copy_code,state,acc_year_b,acc_month_b,acc_year_e,acc_month_e;
          
          /*本月合计数据*/
          ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本月合计'',sum(r.debit),sum(r.credit),0,0 end_os,r.is_check
          from t_groupaccsubjobj_result r
          where r.xh=2
          group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,r.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
           
           /*本年累计数据*/
          ddl_sql:='insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 4,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本年累计'',sum(r.debit),sum(r.credit),0,0 end_os,r.is_check
          from t_groupaccsubjobj_result r
          where r.xh=3
          group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,r.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
          
          /*计算本期发生凭证、本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_credit numeric(19,2);
            end_os_debit numeric(19,2);
            end_os_month numeric(19,2);
            obj_id numeric(18);
             acc_month_y varchar2(2);
            xh integer;
            i number;
          begin
            i:=1;
            obj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.subj_code,r.subj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupaccsubjobj_result r
              where r.xh<4
              order by r.obj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.vouch_no asc,r.check_id asc) loop
    
              /*新的项目从0开始计算*/
              if obj_id<>cr.obj_id then
                end_os_sum:=0;
    
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then
                       if cr.acc_month = ''01'' then    
                insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,''上年结转'',0);
                
                else
                  insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,''期初余额'',0);
                
                 end if;
                end if;
              end if;
              
                if obj_id=cr.obj_id and cr.xh=2 and xh!=1 then
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (acc_month_y!=cr.acc_month) then
                    insert into t_groupaccsubjobj_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);
                 
               end if;
              end if;
    
              end_os_sum:=end_os_sum+cr.end_os;
    
              /*本期发生凭证余额*/
              if cr.xh=2 then
                 update t_groupaccsubjobj_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
              end if;
              
              /*本月合计余额*/
              if cr.xh=3 then
                 update t_groupaccsubjobj_result set end_os=end_os_sum 
                 where xh=3 and obj_id=cr.obj_id and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;
              
             if cr.xh=4 then
                 update t_groupaccsubjobj_result set end_os=end_os_sum 
                 where xh=4 and obj_id=cr.obj_id and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;
              
              i:=i+1;
              obj_id:=cr.obj_id;
              acc_month_y:=cr.acc_month;
              xh:=cr.xh;
            end loop;
          end;
          '; 
    
          /*返回结果集游标*/
          ddl_sql:='select 
            case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
            case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
            to_char(t.vouch_date,''dd'') day,t.vouch_no,t.obj_id,
            t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||',
            t.subj_code||'' ''||t.subj_name subj_name,t.summary,
            case when t.xh=1 then NULL else t.debit end debit,
            case when t.xh=1 then NULL else t.credit end credit,
            case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
          from t_groupaccsubjobj_result t
          '||happen_where||'
          order by t.obj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date asc ,t.vouch_no asc,t.check_id asc
          ';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql ; 
  END group_subjobjdetail_dw;
  
	]]></sql>
	
	<sql id="group_balancedetail_dw" type="proc"><![CDATA[
		 CREATE OR REPLACE PROCEDURE group_balancedetail_dw
         /*集团=======单位余额表*/
      (prm_group_id        number,
       prm_hos_id          number,
       prm_copy_code       varchar2,
       prm_acc_year_b      varchar2,
       prm_acc_month_b     varchar2,
       prm_acc_year_e      varchar2,
       prm_acc_month_e     varchar2,
       prm_is_state        integer, --包含未记账:1,99
       prm_is_end_os       integer, --显示有余额的项目:0,1
       prm_cur_code        varchar2, --币种
       prm_obj_select_flag integer, --项目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_obj_code        varchar2, --项目条件多个值用逗号分隔。参数格式：1='，2='选择的项目编码'，3='开始项目编码,结束项目编码'，4='项目ID1,项目ID2,...‘
         prm_subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       prm_subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
             cur_objdata         OUT ACT_BOOKS.balancecursor)

       IS

        ddl_sql      varchar2(4000);
        obj_wheresql varchar2(4000);
        emp_wheresql varchar2(100);
        endOsWhere   varchar2(100);
        subj_wheresql varchar2(4000);
        subj_code_begin varchar2(200);--开始科目编码
        subj_code_end varchar2(200);--结束科目编码
        subj_id varchar2(4000) ;--通过科目编码返回的科目ID
        num NUMBER;

      BEGIN




        /*项目查询方式*/
        if prm_obj_select_flag = 2 then
          --2直接选择查询,
          obj_wheresql:=' and ( obj_code like ''%'||  prm_obj_code||'%'' or
                               obj_name like ''%'||prm_obj_code||'%'' or
                               spell_code like ''%'|| UPPER (prm_obj_code)||'%'' or
                               wbx_code like ''%'|| UPPER (prm_obj_code) ||'%''
                                   ) ';

        else
          --1查询全部
          obj_wheresql := '';
        end if;

           /*科目查询方式*/
          if prm_subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and subj_code like '''||prm_subj_code||'%'' ';
          elsif prm_subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(prm_subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(prm_subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif prm_subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||prm_group_id||' and a.hos_id  = '||prm_hos_id||' and a.copy_code= '''||prm_copy_code||'''
                         and a.subj_code in('||prm_subj_code||') ';
             subj_wheresql:=' and subj_id in('||subj_id||') ';
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;


        /*是否显示余额项目*/
        if prm_is_end_os = 1 then
          --2直接选择查询,
          endOsWhere := ' and nvl(end_credit,0)-nvl(end_debit,0) !=0 ';
        else
          endOsWhere := '';
        end if;

        insert into t_groupbalancedetail_result_dw (
           idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit,
           is_check,subj_id,subj_code 
        )
      select 1 as idx,
          tempa1.check8_id,
          tempe1.hos_code,
          tempe1.hos_name,
          nvl(tempb1.nc_debit,0),   --年初余额 借
          nvl(tempb1.nc_credit,0),   --年初余额 贷
         case when tempa1.subj_dire=0 then nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)-nvl(tempc1.bfs_credit,0) else 0 end,  --期初余额 借
         case when tempa1.subj_dire=1 then nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)-nvl(tempc1.bfs_debit,0) else 0 end, --期初余额 贷
          nvl(tempd1.bq_debit,0),  --本期发生 借
          nvl(tempd1.bq_credit,0),   --本期发生 贷
          nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0),  --累计发生 借
          nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0),  --累计发生 贷
          nvl(tempb1.nc_debit,0)+nvl(tempc1.bfs_debit,0)+nvl(tempd1.bq_debit,0),  --期末余额 借
          nvl(tempb1.nc_credit,0)+nvl(tempc1.bfs_credit,0)+nvl(tempd1.bq_credit,0), --期末余额 贷
              tempb1.is_check,
              tempa1.subj_id,
              tempa1.subj_code 
       from (
            --有数据的科目
             select a.check8_id,a.group_id,a.hos_id,a.copy_code,a.acc_year,a.subj_id,b.subj_code,b.subj_dire
            from acc_leder_check a
                    left join  acc_subj  b  on a.group_id = b.group_id and a.hos_id = b.hos_id and a.copy_code = b.copy_code and a.subj_id = b.subj_id
            where a.group_id=prm_group_id
                  and a.hos_id=prm_hos_id
                  and a.copy_code=prm_copy_code
                  and a.acc_year = prm_acc_year_b
                  and nvl(a.check8_id,0)!=0
                  and TO_NUMBER(a.acc_year||''||a.acc_month) between TO_NUMBER(prm_acc_year_b||'00') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
                  and nvl(a.end_os,0)!=0
            union
                 select a1.check8_id, a1.group_id,a1.hos_id,a1.copy_code,a1.acc_year,a1.subj_id,c1.subj_code,c1.subj_dire
                from acc_vouch_check a1
                  left join acc_vouch b1 on a1.group_id= b1.group_id and a1.hos_id=b1.hos_id and a1.copy_code=b1.copy_code
                      and a1.acc_year = b1.acc_year and a1.vouch_id=b1.vouch_id
                      left join acc_subj c1  on a1.group_id = c1.group_id and a1.hos_id = c1.hos_id and a1.copy_code = c1.copy_code and a1.subj_id = c1.subj_id
             where a1.group_id=prm_group_id and a1.hos_id=prm_hos_id and a1.copy_code=prm_copy_code
                  and a1.acc_year = prm_acc_year_b
                  and b1.state>=prm_is_state
                  and nvl(a1.check8_id,0)!=0
                  and TO_NUMBER(b1.acc_year||''||b1.acc_month) between TO_NUMBER(prm_acc_year_b||'01') and  TO_NUMBER(prm_acc_year_e||''||prm_acc_month_e)
       ) tempa1  left join (
         --年初余额
         select a2.check8_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,a2.subj_id,
              sum(case when b2.subj_dire=0 then nvl(a2.end_os,0) else 0 end) nc_debit,
              sum(case when b2.subj_dire=1 then  nvl(a2.end_os,0) else 0 end) nc_credit,b2.is_check
        from acc_leder_check a2
        left join acc_subj b2 on a2.group_id =b2.group_id and a2.hos_id=b2.hos_id  and a2.copy_code=b2.copy_code
             and a2.acc_year = b2.acc_year  and a2.subj_id=b2.subj_id
        where a2.group_id=prm_group_id  and a2.hos_id=prm_hos_id and a2.copy_code=prm_copy_code
              and a2.acc_year=prm_acc_year_b and a2.acc_month='00'
              and nvl(a2.check8_id,0)!=0
       group by a2.check8_id,a2.group_id,a2.hos_id,a2.copy_code,a2.acc_year,b2.is_check,a2.subj_id
      ) tempb1 on tempa1.group_id =tempb1.group_id  and
      tempa1.hos_id =tempb1.hos_id   and tempa1.copy_code =tempb1.copy_code
      and tempa1.check8_id = tempb1.check8_id  and tempa1.subj_id =tempb1.subj_id
      left join(
           --年初到开始日间中间数据
           select a.check8_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id,
             sum(nvl(a.debit,0)) bfs_debit,
             sum(nvl(a.credit,0)) bfs_credit
          from  acc_vouch b
          left join  acc_vouch_check a on b.group_id = a.group_id and  b.hos_id = a.hos_id
               and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id
          where a.group_id=prm_group_id and a.hos_id=prm_hos_id
                and a.copy_code=prm_copy_code
                and b.acc_year = prm_acc_year_b
                and b.state>=prm_is_state
                and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||'01'
                and TO_NUMBER(b.acc_year||''||b.acc_month) < prm_acc_year_b||''||prm_acc_month_b
                and nvl(a.check8_id,0)!=0
           group by a.check8_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id
      ) tempc1 on tempa1.group_id =tempc1.group_id and tempa1.hos_id =tempc1.hos_id
        and tempa1.copy_code =tempc1.copy_code and tempa1.acc_year =tempc1.acc_year
        and tempa1.check8_id =tempc1.check8_id  and tempa1.subj_id =tempc1.subj_id
      left join (
          -- 本期发生数据
          select a.check8_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id,
                 sum(nvl(a.debit,0)) bq_debit,
                 sum(nvl(a.credit,0)) bq_credit
          from   acc_vouch b
          left join acc_vouch_check a  on b.group_id=a.group_id and b.hos_id=a.hos_id
                 and b.copy_code=a.copy_code and b.acc_year = a.acc_year and b.vouch_id=a.vouch_id
          where a.group_id=prm_group_id and a.hos_id=prm_hos_id and a.copy_code=prm_copy_code
                  and a.acc_year =prm_acc_year_b  and b.state>=prm_is_state
                  and TO_NUMBER(b.acc_year||''||b.acc_month) >= prm_acc_year_b||''||prm_acc_month_b
                  and TO_NUMBER(b.acc_year||''||b.acc_month) <= prm_acc_year_e||''||prm_acc_month_e
                  and nvl(a.check8_id,0)!=0
          group by a.check8_id,b.group_id,b.hos_id,b.copy_code,b.acc_year,a.subj_id
      ) tempd1 on tempa1.group_id =tempd1.group_id and tempa1.hos_id =tempd1.hos_id
        and tempa1.copy_code =tempd1.copy_code and tempa1.acc_year =tempd1.acc_year
        and  tempa1.check8_id = tempd1.check8_id  and  tempa1.subj_id =tempd1.subj_id
      left join hos_info_dict  tempe1 on  tempa1.group_id =tempe1.group_id and tempa1.hos_id = tempe1.hos_id
        and  tempa1.check8_id =tempe1.hos_id   ;

           execute immediate '
           insert into t_groupbalancedetail_resultsdw(
             idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,
             bq_credit,lj_debit , lj_credit ,end_debit ,end_credit ,is_check  
           ) select  idx,obj_id ,obj_code ,obj_name ,sum(nc_debit) ,sum(nc_credit ),sum(qc_debit ),
           sum(qc_credit) ,sum(bq_debit ),sum(bq_credit),sum(lj_debit ), sum(lj_credit) ,sum(end_debit ),
           sum(end_credit),is_check   
                   from t_groupbalancedetail_result_dw
                   where idx =1  '||obj_wheresql||''||subj_wheresql||'
                   group by idx,obj_id ,obj_code ,obj_name ,is_check 
          ';

               --求总合计
              insert into t_groupbalancedetail_resultsdw(
                   idx,obj_id ,obj_code ,obj_name ,nc_debit ,nc_credit ,qc_debit ,qc_credit ,bq_debit ,bq_credit,lj_debit , lj_credit ,end_debit ,end_credit ,is_check
              )
              select 2 as idx,'' obj_id,'总合计' as obj_code,'' as obj_name,
                 sum(nvl(nc_debit,0)) as nc_debit,
                 sum(nvl(nc_credit,0)) as nc_credit,
                 sum(nvl(qc_debit,0)) as qc_debit,
                 sum(nvl(qc_credit,0)) as qc_credit,
                 sum(nvl(bq_debit,0)) as bq_debit,
                 sum(nvl(bq_credit,0)) as bq_credit,
                 sum(nvl(lj_debit,0)) as lj_debit,
                 sum(nvl(lj_credit,0)) as lj_credit,
                 sum(nvl(end_debit,0)) as end_debit,
                 sum(nvl(end_credit,0)) as end_credit,
                 '' as is_check
              from t_groupbalancedetail_resultsdw
              where idx = 1;

         ddl_sql := 'select
                  obj_code  ,obj_name ,
                  sum(nc_debit) nc_debit,sum(nc_credit) nc_credit,sum(qc_debit) qc_debit,sum(qc_credit) qc_credit,
                  sum(bq_debit) bq_debit,sum(bq_credit) bq_credit,sum(lj_debit) lj_debit,sum(lj_credit) lj_credit,
                  case when sum(end_debit-end_credit)>=0 then sum(end_debit-end_credit) else 0 end as end_debit ,
                  case when sum(end_credit-end_debit)>0 then  sum(end_credit-end_debit) else 0 end as end_credit
                   from  t_groupbalancedetail_resultsdw
        where     (nvl(nc_debit,0)!=0
                  or  nvl(nc_credit,0)!=0
                  or  nvl(qc_debit,0)!=0
                  or  nvl(qc_credit,0)!=0
                  or  nvl(bq_debit,0)!=0
                  or  nvl(bq_credit,0)!=0
                  or  nvl(lj_debit,0)!=0
                  or  nvl(lj_credit,0)!=0
                  or  nvl(end_debit,0)!=0
                  or  nvl(end_credit,0)!=0 )
                  '||endOsWhere||'
            group by  obj_code  ,obj_name
          order by obj_code';
          --dbms_output.put_line(ddl_sql);
        open cur_objdata for ddl_sql;

      END group_balancedetail_dw;
      
	]]></sql>
	
	<sql id="group_subjzcheckgeneral" type="proc"><![CDATA[
		
		CREATE OR REPLACE PROCEDURE group_subjzcheckgeneral

  /*集团======科目核算项总账*/
  (
   p_group_id number,
   p_hos_id number,
   p_copy_code varchar2,
   p_acc_year_b varchar2,
   p_acc_month_b varchar2,
   p_acc_year_e varchar2,
   p_acc_month_e varchar2,
   p_state integer,--包含未记账:1,99
   p_subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   p_subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
   p_check_item_type integer, --辅助核算类ID
   p_check_item_code varchar2,  --辅助核算项
   p_source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
  /* table_flag varchar2,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
   dynamic_column varchar2,--根据用户选择显示列
   dynamic_where varchar2,--根据用户选择拼接查询语句*/
   objdata OUT ACT_BOOKS.objsubjgeneralcursor
   )
  IS
      ddl_sql varchar2(4000);
      
   
      subj_code_begin varchar2(200);--开始科目编码
      subj_code_end varchar2(200);--结束科目编码
      check_typeid varchar2(20);
      check_typeid_str varchar2(20);--用于区分是否自定义辅助核算
      check_wheresql varchar2(2000);
  
      check_insertsql varchar2(500);--辅助核算添加动态字段
      check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
      check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
      source_wheresql varchar2(200);
      subj_wheresql varchar2(4000);
     /* obj_wheresql varchar2(4000);*/
      summary varchar2(20);
        subj_id varchar2(4000) ;
      num NUMBER;
  BEGIN
 
      /*条件处理begin*/
      if p_source_id='0' then
           source_wheresql:='';--资源来源ID
      else
           source_wheresql:=' and c.check7_id in('||p_source_id||') ';--资金来源ID
      end if;

      /*辅助核算类id*/
     select column_check into check_typeid from acc_check_type 
      where group_id=p_group_id and hos_id=p_hos_id
      and copy_code=p_copy_code and check_type_id=p_check_item_type;
     select is_sys into check_typeid_str from acc_check_type
      where group_id=p_group_id and hos_id=p_hos_id
      and copy_code=p_copy_code and check_type_id=p_check_item_type;
     
      
       if(p_check_item_code is null) then
         if(check_typeid_str=0) then
          check_wheresql:=' and c.'||check_typeid||' is not null';
         else
           check_wheresql:=' and c.'||check_typeid||'_id is not null';
         end if;
       else 
          dbms_output.put_line(2222);
          dbms_output.put_line(check_typeid);
          dbms_output.put_line(check_typeid_str);
         if (check_typeid_str = 0) then
          check_wheresql:=' and nvl(c.'||check_typeid||',0)!=0  and c.'||check_typeid||' in ('||p_check_item_code||')';
          dbms_output.put_line(check_wheresql);
          else 
             check_wheresql:=' and nvl(c.'||check_typeid||'_id,0)!=0  and c.'||check_typeid||'_no in ('||p_check_item_code||')';
             dbms_output.put_line(check_wheresql);
          end if ;
        end if;
      
      
      
      /*科目查询方式*/
      if p_subj_select_flag=2 then
          --2直接选择查询,
          subj_wheresql:=' and hs.subj_code like '''||p_subj_code||'%'' ';
      elsif p_subj_select_flag=3 then
          --3按范围查询,
          subj_code_begin:=regexp_substr(p_subj_code,'[^,]+',1,1,'i');
          subj_code_end:=regexp_substr(p_subj_code,'[^,]+',1,2,'i');
          subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
      elsif p_subj_select_flag=4 then
         --4弹出页面筛选查询
         --subj_wheresql:=' and hs.subj_id in('||p_subj_code||') ';
         subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||p_group_id||' and a.hos_id  = '||p_hos_id||' and a.copy_code= '''||p_copy_code||''' 
                         and a.subj_code in('||p_subj_code||') ';   
       subj_wheresql:=' and hs.subj_id in('||subj_id||') '; 
      else
        --1查询全部
         subj_wheresql:=' ';
      end if;


      if p_acc_month_b='01' then
        /*年初余额*/
        summary:='上年结转';
        execute immediate 'insert into t_groupzcheckobjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select 1,''0000'',''00'',hs.subj_id,hs.subj_code,hs.subj_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os),hs.is_check 
        from acc_leder_check c
        inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id 
        where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
        '||subj_wheresql||'
        '||source_wheresql||'
        '||check_wheresql||'
        group by hs.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check'
        using p_group_id,p_hos_id,p_copy_code,p_acc_year_b;

      else

        /*期初余额*/
        summary:='期初余额';
        --dbms_output.put_line('');
        execute immediate 'insert into t_groupzcheckobjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
         select 1,''0000'',''00'',t1.subj_id,t1.subj_code,t1.subj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os),t1.is_check from
        (
          select hs.subj_id,hs.subj_code,hs.subj_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(c.end_os) end_os  ,hs.is_check
          from acc_leder_check c
          inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          '||check_joinsql||'
          where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
          '||subj_wheresql||'
          '||source_wheresql||'
          '||check_wheresql||'
          group by hs.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
          union all
           select hs.subj_id,hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
          sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          '||check_joinsql||'
          where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
          and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
          '||subj_wheresql||'
          '||source_wheresql||'
          '||check_wheresql||'
          group by hs.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
         ) t1 group by t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check'
         using p_group_id,p_hos_id,p_copy_code,p_acc_year_b,
        p_group_id,p_hos_id,p_copy_code,p_state,p_acc_year_b,p_acc_month_b;

      end if;
      /*本月合计数据*/
      execute immediate 'insert into t_groupzcheckobjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
      select 2,v.acc_year,v.acc_month,hs.subj_id,hs.subj_code,hs.subj_name,''本月合计'',sum(c.debit),sum(c.credit),hs.subj_dire,   
       case when subj_dire=1 then sum(c.credit)-sum(c.debit) else sum(c.debit)-sum(c.credit) end   end_os,hs.is_check
      from acc_vouch_check c
      left join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
      inner join acc_vouch_type t on v.group_id=t.group_id 
            and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
      inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
              and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
      '||check_joinsql||'
      where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
      and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
      '||subj_wheresql||'
      '||source_wheresql||'
      '||check_wheresql||'
      group by v.acc_year,v.acc_month,hs.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
      ' using p_group_id,p_hos_id,p_copy_code,p_state,p_acc_year_b,p_acc_month_b,p_acc_year_e,p_acc_month_e;

       /*本月合计数据*/
      /*ddl_sql:='insert into t_groupzcheckobjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os'||check_insertsql||')
      select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本月合计'',sum(r.debit),sum(r.credit),r.subj_dire,0 end_os'||check_insertsql||'
      from t_groupzcheckobjledger_result r
      where r.xh=2
      group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,r.subj_dire'||check_insertsql||'
      ';
      --dbms_output.put_line(ddl_sql);
      execute immediate ddl_sql;*/


      /*计算本期发生凭证、本月合计余额*/
      --dbms_output.put_line(ddl_sql);
     execute immediate '
      declare
        end_os_sum numeric(19,2);
        end_os_month numeric(19,2);
        subj_id numeric(18);
        xh integer;
        i number;
      begin
        i:=1;
        subj_id:=0;
        end_os_month:=0;
        for cr in (select r.xh,r.subj_id,r.subj_code,r.subj_name,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupzcheckobjledger_result r
          where r.xh<3
          order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop

          if subj_id<>cr.subj_id then
            end_os_sum:=0;

            /*没有期初余额新增加一条期初余额*/
                 
        
                if cr.acc_month = ''01'' then
                 /* insert into t_groupzcheckobjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''上年结转'',0);
         
                 else*/
                   
                  insert into t_groupzcheckobjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''期初余额'',0);
         
                 end if;
        
         end if;
         
         
          if subj_id=cr.subj_id and cr.xh=2 and xh!=1 then
            
          
                  insert into t_groupzcheckobjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,subj_dire,summary,end_os)
                  values( 1,cr.acc_year,cr.acc_month,cr.subj_id,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);
            
          end if;
         
         

          end_os_sum:=end_os_sum+cr.end_os;

    
          if cr.xh=2 then
             update t_groupzcheckobjledger_result set end_os=end_os_sum where xh=2 and subj_id=cr.subj_id
             and acc_year = cr.acc_year and acc_month=cr.acc_month;
          end if;

          i:=i+1;
          subj_id:=cr.subj_id;
          xh:=cr.xh;
        end loop;
      end;
      ';
      --dbms_output.put_line(ddl_sql);
      /*本年累计数据*/
      ddl_sql:='insert into t_groupzcheckobjledger_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
      select 3,t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,''本年累计'',
      t1.debit+nvl((select r1.debit from t_groupzcheckobjledger_result r1 where r1.xh=1 and r1.debit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||p_acc_year_b||'''),0),
      t1.credit+nvl((select r1.credit from t_groupzcheckobjledger_result r1 where r1.xh=1 and r1.credit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||p_acc_year_b||'''),0),
      t1.subj_dire,t1.end_os,t1.is_check  from
        (select 4,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,
        sum(r.debit) over(partition by r.acc_year,r.subj_id order by r.acc_month) debit,
        sum(r.credit) over(partition by r.acc_year,r.subj_id order by r.acc_month) credit,
        r.subj_dire,r.end_os,r.is_check
        from t_groupzcheckobjledger_result r
        where r.xh=2
       ) t1
      ';
      
      execute immediate ddl_sql;

      /*返回结果集游标*/
      ddl_sql:='select t.xh,
      case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
      case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
      t.subj_id,t.subj_code||'' ''||t.subj_name subj_name 
      ,t.summary,
      case when t.xh=1 then NULL else t.debit end debit,
      case when t.xh=1 then NULL else t.credit end credit,
      case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
      from t_groupzcheckobjledger_result t
      where
      (exists(select 1 from t_groupzcheckobjledger_result t1
      where  TO_NUMBER(t1.acc_year||''''||t1.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
      ))--无发生不显示期初余额0,1
      order by t.subj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.is_check
      ';
      --dbms_output.put_line(ddl_sql);
      open objdata for ddl_sql using p_acc_year_b,p_acc_month_b,p_acc_year_e,p_acc_month_e;

  END group_subjzcheckgeneral;
  
	]]></sql>
	
	<sql id="group_subjobjzcheckdetail" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_subjobjzcheckdetail
      /*集团==========自定义核算项科目明细账*/
      (
       p_group_id number,
       p_hos_id number,
       p_copy_code varchar2,
       p_acc_year_b varchar2,
       p_acc_month_b varchar2,
       p_acc_year_e varchar2,
       p_acc_month_e varchar2,
       p_state integer,--包含未记账:1,99
       ---is_happend integer,--无发生不显示期初余额0,1
       p_subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
       p_subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
       p_check_item_type integer, --辅助核算类ID
       p_check_item_code varchar2,  --辅助核算项
       p_source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
       --table_flag integer,--1.部门 2.职工 3.项目 4.供应商 5.客户 6.库房 7.z自定义
       objdata OUT ACT_BOOKS.subjobjcursor
       )
      IS
          ddl_sql varchar2(4000);
          obj_sql varchar2(200);
          
          obj_history_where_field varchar2(200);--历史记录动态条件
          
          check_typeid varchar2(20);
          check_typeid_str varchar2(20);
          check_wheresql varchar2(2000);
          
          subj_code_begin varchar2(200);--开始科目编码
          subj_code_end varchar2(200);--结束科目编码
          obj_code_begin varchar2(200);--开始项目编码
          obj_code_end varchar2(200);--结束项目编码
          check_insertsql varchar2(500);--辅助核算添加动态字段
          check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
          check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
          --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
          source_wheresql varchar2(200);
          subj_wheresql varchar2(4000);
          obj_wheresql varchar2(4000);
          summary varchar2(20);
          subj_id varchar2(4000) ;
          num NUMBER;
      BEGIN
     
    
          /*条件处理begin*/
          if p_source_id='0' then
               source_wheresql:='';--资源来源ID
          else
               source_wheresql:=' and c.check7_id in('||p_source_id||') ';--资金来源ID
          end if;
          
          /*辅助核算类id*/
         select column_check into check_typeid from acc_check_type 
          where group_id=p_group_id and hos_id=p_hos_id
          and copy_code=p_copy_code and check_type_id=p_check_item_type;
         select is_sys into check_typeid_str from acc_check_type 
          where group_id=p_group_id and hos_id=p_hos_id
          and copy_code=p_copy_code and check_type_id=p_check_item_type;
          
           if(p_check_item_code is null) then
            if (check_typeid_str=0) then
              check_wheresql:=' and nvl(c.'||check_typeid||',0)!=0';
              check_typeid:=check_typeid;
            else
              check_wheresql:=' and nvl(c.'||check_typeid||'_id,0)!=0';
              check_typeid:=check_typeid||'_id';
            end if;
           else 
             dbms_output.put_line(check_typeid);
             dbms_output.put_line(check_typeid_str);
             if(check_typeid_str=0) then
              check_wheresql:=' and nvl(c.'||check_typeid||',0)!=0  and c.'||check_typeid||' in ('||p_check_item_code||')';
              check_typeid:=check_typeid; 
            else
               check_wheresql:=' and nvl(c.'||check_typeid||'_id,0)!=0  and c.'||check_typeid||'_no in ('||p_check_item_code||')';
               check_typeid:=check_typeid||'_id';
             end if;
           end if;
    
          /*科目查询方式*/
          if p_subj_select_flag=2 then
              --2直接选择查询,
              subj_wheresql:=' and hs.subj_code like '''||p_subj_code||'%'' ';
          elsif p_subj_select_flag=3 then
              --3按范围查询,
              subj_code_begin:=regexp_substr(p_subj_code,'[^,]+',1,1,'i');
              subj_code_end:=regexp_substr(p_subj_code,'[^,]+',1,2,'i');
              subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
          elsif p_subj_select_flag=4 then
             --4弹出页面筛选查询
             --subj_wheresql:=' and hs.subj_id in('||p_subj_code||') ';
             subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||p_group_id||' and a.hos_id  = '||p_hos_id||' and a.copy_code= '''||p_copy_code||''' 
                         and a.subj_code in('||p_subj_code||') ';  
             
             subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
             
          else
            --1查询全部
             subj_wheresql:=' ';
          end if;
    
    
          /*项目查询方式
          if obj_select_flag=2 then
              --2直接选择查询,
              obj_wheresql:=' and hd.'||obj_code_where_field||' like '''||obj_code||'%'' ';
          elsif obj_select_flag=3 then
              --3按范围查询,
              obj_code_begin:=regexp_substr(obj_code,'[^,]+',1,1,'i');
              obj_code_end:=regexp_substr(obj_code,'[^,]+',1,2,'i');
              obj_wheresql:=' and hd.'||obj_code_where_field||' between '||obj_code_begin||' and '||obj_code_end||' ';
          elsif obj_select_flag=4 then
             --4弹出页面筛选查询
             obj_wheresql:=' and hd.'||obj_id_where_field||' in('||obj_code||') ';
          else
            --1查询全部
             obj_wheresql:=' ';
          end if;*/
    
          --项目显示方式:0历史数据，1最新数据
         /* SELECT COUNT(1) INTO num FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(''||table_name||'') and is_new=0;
          IF num = 0 THEN
               obj_sql:=' and '||obj_history_where_field||' ';--显示历史数据
          else
               obj_sql:=' and hd.is_stop=0 ';--显示最新数据
          end if;*/
          /*条件处理end*/
    
          /*明细账需要拼辅助核算字段*/
          check_insertsql:='';
          check_selectsql:='';
          check_joinsql:='';
          --check_resultsql:='';
          declare
              check_i integer;
              dict_show_para integer;
              dict_show_sql varchar2(100);
              TYPE ref_type IS REF CURSOR;--定义游标指针
              v_cursor ref_type;--定义游标变量
              check_type_id numeric(18);
              check_table varchar2(50);
              is_sys integer;
              column_id varchar2(50);
              column_no varchar2(50);
              column_code varchar2(50);
              column_name varchar2(50);
              is_change integer;
          begin
            check_i:=0;
            --dbms_output.put_line(ddl_sql);
            OPEN v_cursor FOR '
                select b.check_type_id,b.check_table,b.is_sys,b.column_id,b.column_no,b.column_code,b.column_name,b.is_change from ACC_CHECK_TYPE b
                where b.group_id=:group_id and b.hos_id=:hos_id and b.copy_code=:copy_code
                and exists(
                  select 1 from ACC_SUBJ hs
                  where b.group_id=hs.group_id and b.hos_id=hs.hos_id and b.copy_code=hs.copy_code and hs.acc_year=:acc_year_b
                   '||subj_wheresql||'
                   
                  and (hs.check1=3 or hs.check2=3 or hs.check3=3  or hs.check4=3)
                  and (hs.check1=b.check_type_id or hs.check2=b.check_type_id or hs.check3=b.check_type_id  or hs.check4=b.check_type_id)
                ) and b.check_type_id<>3
                order by b.sort_code'
                using p_group_id,p_hos_id,p_copy_code,p_acc_year_b; --打开游标（执行动态SQL）
            LOOP
            FETCH v_cursor INTO check_type_id,check_table,is_sys,column_id,column_no,column_code,column_name,is_change;--从游标中取一条记录，存放到变量v_record中
    
              EXIT WHEN v_cursor%NOTFOUND;
              check_i:=check_i+1;
    
              --系统核算
              if is_sys=1 then
    
                  --有变更表需要取显示方式的参数
                  dict_show_sql:='';
                  if is_change=1 then
                      SELECT COUNT(1) INTO dict_show_para FROM HOS_DICT_PARA WHERE group_id=group_id and hos_id=hos_id and table_code=UPPER(check_table) and is_new=0;
                      IF dict_show_para = 0 THEN
                           dict_show_sql:=' and '||check_table||'.'||column_no||'=c.check'||check_type_id||'_no ';--显示历史数据
                      else
                           dict_show_sql:=' and '||check_table||'.is_stop=0 ';--显示最新数据
                      end if;
    
                  end if;
    
                  check_selectsql:=check_selectsql||','||check_table||'.'||column_code||'||'' ''||'||check_table||'.'||column_name;
                  check_joinsql:=check_joinsql||' left join '||check_table||' '||check_table||' on '||check_table||'.'||column_id||'=c.check'||check_type_id||'_id '||dict_show_sql;
    
    
              --自定义核算
              elsif is_sys=0 then
                  check_selectsql:=check_selectsql||',(select check_item_code'||'||'' ''||'||'check_item_name from acc_check_item item
                  where exists(select 1 from acc_vouch_zcheck avz where avz.vouch_check_id=c.vouch_check_id
                  and item.check_item_id=avz.check_item_id and avz.check_type_id='||check_type_id||')) check'||check_i;
    
    
              end if;
              check_insertsql:=check_insertsql||',check'||check_i;
    
            /*只支持同时挂4个辅助核算*/
            if check_i=4 then
              exit;
            end if;
            end loop;
            CLOSE v_cursor;--关闭游标
          end;
    
          if p_acc_month_b='01' then
    
            /*年初余额*/
            summary:='上年结转';
           -- dbms_output.put_line();
            execute immediate 'insert into t_groupzcheckobjdetail_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',hs.subj_id,hs.subj_code,hs.subj_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),hs.subj_dire,sum(c.end_os),hs.is_check  
            from acc_leder_check c
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            '||check_joinsql||'
            where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
            '||subj_wheresql||'
            '||source_wheresql||'
             '||check_wheresql||'
            group by hs.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check'
            using p_group_id,p_hos_id,p_copy_code,p_acc_year_b;
    
          else
    
            /*期初余额*/
            summary:='期初余额';
            --dbms_output.put_line(ddl_sql);
            execute immediate 'insert into t_groupzcheckobjdetail_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 1,''0000'',''00'',t1.subj_id,t1.subj_code,t1.subj_name,''期初余额'',sum(t1.debit),sum(t1.credit),t1.subj_dire,sum(t1.end_os),t1.is_check from
            (
              select hs.subj_id,hs.subj_code,hs.subj_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,hs.subj_dire,sum(c.end_os) end_os,hs.is_check  
              from acc_leder_check c
              inner join acc_subj hs on c.group_id = hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                    and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              '||check_joinsql||'
              where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
              '||subj_wheresql||'
              '||source_wheresql||'
               '||check_wheresql||'
              group by hs.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
              union all
              select hs.subj_id,hs.subj_code,hs.subj_name,sum(c.debit) debit,sum(c.credit) credit,hs.subj_dire,
              sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
              from acc_vouch_check c
              inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              '||check_joinsql||'
              where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
              and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
              '||subj_wheresql||'
              '||source_wheresql||'
               '||check_wheresql||'
              group by hs.subj_id,hs.subj_code,hs.subj_name,hs.subj_dire,hs.is_check
             ) t1 group by t1.subj_id,t1.subj_code,t1.subj_name,t1.subj_dire,t1.is_check'
             using p_group_id,p_hos_id,p_copy_code,p_acc_year_b,
            p_group_id,p_hos_id,p_copy_code,p_state,p_acc_year_b,p_acc_month_b;
    
          end if;
    
    
          /*本期发生凭证数据*/
          execute immediate 'insert into t_groupzcheckobjdetail_result(check_id,xh,check1,acc_year,acc_month,vouch_date,vouch_no
         
          ,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select c.vouch_check_id,2,act.check_item_name,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no||''-''||v.vouch_id vouch_no
         
          ,hs.subj_id,hs.subj_code,hs.subj_name,c.summary,c.debit,c.credit,hs.subj_dire,
          (case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os,hs.is_check
          from acc_vouch_check c
          left join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                    and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
          left join ACC_CHECK_ITEM act on c.'||check_typeid||' =act.check_item_id and check_type_id=:p_check_item_type
               and c.group_id=act.group_id and c.hos_id=act.hos_id and c.copy_code=act.copy_code
          inner join acc_vouch_type t on v.group_id=t.group_id 
                and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code  
          inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                  and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
          '||check_joinsql||'
          where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
          and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
          '||subj_wheresql||'
          '||source_wheresql||'
           '||check_wheresql||'
          order by hs.subj_id,hs.subj_code,hs.subj_name,v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date,hs.is_check
          ' using p_check_item_type,p_group_id,p_hos_id,p_copy_code,p_state,p_acc_year_b,p_acc_month_b,p_acc_year_e,p_acc_month_e;
    
          /*本月合计数据*/
          ddl_sql:='insert into t_groupzcheckobjdetail_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 3,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,''本月合计'',sum(r.debit),sum(r.credit),r.subj_dire,
          
          0 end_os,r.is_check
          from t_groupzcheckobjdetail_result r
          where r.xh=2
          group by r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,r.subj_dire,r.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
    
    
          /*计算本期发生凭证、本月合计余额*/
          --dbms_output.put_line(ddl_sql);
          execute immediate '
          declare
            end_os_sum numeric(19,2);
            end_os_month numeric(19,2);
            subj_id numeric(18);
            acc_month_y varchar2(2);
            xh integer;
            i number;
          begin
            i:=1;
            subj_id:=0;
            end_os_month:=0;
            for cr in (select r.xh,r.subj_id,r.subj_code,r.subj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupzcheckobjdetail_result r
              where r.xh<4
              order by r.subj_code asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.vouch_no asc,r.check_id asc) loop
    
              /*新的项目从0开始计算*/
              if subj_id<>cr.subj_id then
                end_os_sum:=0;
    
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then
    
                      if cr.acc_month = ''01'' then    
                 insert into t_groupzcheckobjdetail_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''上年结转'',0);
                else
                   insert into t_groupzcheckobjdetail_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,end_os)
                      values( 1,''0000'',''00'',cr.subj_id,cr.subj_code,cr.subj_name,''期初余额'',0);
                  end if;
                
                end if;
              end if;
              
               if subj_id=cr.subj_id and cr.xh=2 and xh!=1 then
                /*有发生数据没有期初余额新增加一条期初余额*/
                if (acc_month_y!=cr.acc_month) then
                      insert into t_groupzcheckobjdetail_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,subj_dire,summary,end_os)
                      values( 1,cr.acc_year,cr.acc_month,cr.subj_id,cr.subj_code,cr.subj_name,cr.subj_dire,''期初余额'',end_os_sum);
                end if;
              end if;
    
              end_os_sum:=end_os_sum+cr.end_os;
    
              /*本期发生凭证余额*/
              if cr.xh=2 then
                 update t_groupzcheckobjdetail_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
              end if;
              /*本月合计余额*/
              if cr.xh=3 then
                 update t_groupzcheckobjdetail_result set end_os=end_os_sum where xh=3 and subj_id=cr.subj_id
                 and acc_year = cr.acc_year and acc_month=cr.acc_month;
              end if;
    
              i:=i+1;
              subj_id:=cr.subj_id;
              acc_month_y:=cr.acc_month;
              xh:=cr.xh;
            end loop;
          end;
          ';
    
          /*本年累计数据*/
          ddl_sql:='insert into t_groupzcheckobjdetail_result(xh,acc_year,acc_month,subj_id,subj_code,subj_name,summary,debit,credit,subj_dire,end_os,is_check)
          select 4,t1.acc_year,t1.acc_month,t1.subj_id,t1.subj_code,t1.subj_name,''本年累计'',
          t1.debit+nvl((select r1.debit from t_groupzcheckobjdetail_result r1 where r1.xh=1 and r1.debit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||p_acc_year_b||'''),0),
          t1.credit+nvl((select r1.credit from t_groupzcheckobjdetail_result r1 where r1.xh=1 and r1.credit<>0 and r1.subj_id=t1.subj_id and t1.acc_year='''||p_acc_year_b||'''),0),
          t1.subj_dire,t1.end_os ,t1.is_check from
            (select 4,r.acc_year,r.acc_month,r.subj_id,r.subj_code,r.subj_name,
            sum(r.debit) over(partition by r.acc_year,r.subj_id order by r.acc_month) debit,
            sum(r.credit) over(partition by r.acc_year,r.subj_id order by r.acc_month) credit,
            r.subj_dire,r.end_os,r.is_check
            from t_groupzcheckobjdetail_result r
            where r.xh=3
           ) t1
    
          ';
          --dbms_output.put_line(ddl_sql);
          execute immediate ddl_sql;
    
          /*返回结果集游标*/
          ddl_sql:='select 
          case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
          case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
          check1 as obj_name, 
          to_char(t.vouch_date,''dd'') acc_day,t.vouch_no,
          t.subj_code||'' ''||t.subj_name subj_name 
          ,t.summary,
          case when t.xh=1 then NULL else t.debit end debit,
          case when t.xh=1 then NULL else t.credit end credit,
          case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
          from t_groupzcheckobjdetail_result t
          where
          (exists(select 1 from t_groupzcheckobjdetail_result t1
          where t1.subj_id=t.subj_id
          and TO_NUMBER(t1.acc_year||''''||t1.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
          ))--无发生不显示期初余额0,1
          order by t.subj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date asc,t.vouch_no asc,t.check_id asc,t.is_check
          ';
          --dbms_output.put_line(ddl_sql);
          open objdata for ddl_sql using p_acc_year_b,p_acc_month_b,p_acc_year_e,p_acc_month_e;
    
      END group_subjobjzcheckdetail;
  
  
	]]></sql>
	
	<sql id="group_zchecksubjobjledger" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_zchecksubjobjledger
                        
  /*集团===========科目核算项总账*/
  (
   p_group_id number,
   p_hos_id number,
   p_copy_code varchar2,
   p_acc_year_b varchar2,
   p_acc_month_b varchar2,
   p_acc_year_e varchar2,
   p_acc_month_e varchar2,
   p_state integer,--包含未记账:1,99
   p_subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
   p_subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
   p_check_item_type integer, --辅助核算类ID
   p_check_item_code varchar2,  --辅助核算项
   p_source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
  
   objdata OUT ACT_BOOKS.subjobjgeneralcursor
   )
  IS
      ddl_sql varchar2(4000);
     
      subj_code_begin varchar2(200);--开始科目编码
      subj_code_end varchar2(200);--结束科目编码
      
      check_insertsql varchar2(500);--辅助核算添加动态字段
    
       check_typeid_str varchar2(20);
       check_typeid varchar2(20);
      check_wheresql varchar2(2000);
      
      source_wheresql varchar2(200);
      subj_wheresql varchar2(4000);
      obj_wheresql varchar2(4000);
      summary varchar2(20);
    subj_id varchar2(4000) ;
      num NUMBER;
  BEGIN
 
      /*条件处理begin*/
      if p_source_id='0' then
           source_wheresql:='';--资源来源ID
      else
           source_wheresql:=' and c.check7_id in('||p_source_id||') ';--资金来源ID
      end if;
      
       /*辅助核算类id*/
     select column_check into check_typeid from acc_check_type 
      where group_id=p_group_id and hos_id=p_hos_id
      and copy_code=p_copy_code and check_type_id=p_check_item_type;
     select is_sys into check_typeid_str from acc_check_type 
       where group_id=p_group_id and hos_id=p_hos_id
       and copy_code=p_copy_code and check_type_id=p_check_item_type;
      
        if(p_check_item_code is null) then
           dbms_output.put_line(1111);
           dbms_output.put_line(check_typeid);
           dbms_output.put_line(check_typeid_str);
          if(check_typeid_str=0) then 
            check_wheresql:=' and nvl(c.'||check_typeid||',0)!=0';
            check_typeid:=check_typeid;
          else 
            check_wheresql:=' and nvl(c.'||check_typeid||'_id,0)!=0';
            check_typeid:=check_typeid||'_id';
            dbms_output.put_line(check_wheresql);
         
          end if;
        
       else 
         dbms_output.put_line(check_typeid);
         dbms_output.put_line(check_typeid_str);
         if(check_typeid_str=0) then
            check_wheresql:=' and nvl(c.'||check_typeid||',0)!=0  and c.'||check_typeid||' in ('||p_check_item_code||')';
            check_typeid:=check_typeid;
         else
            check_wheresql:=' and nvl(c.'||check_typeid||'_id,0)!=0  and c.'||check_typeid||'_no in ('||p_check_item_code||')';
            check_typeid:=check_typeid||'_id';
            dbms_output.put_line(check_wheresql);
         end if;
       end if;

     

      /*科目查询方式*/
      if p_subj_select_flag=2 then
          --2直接选择查询,
          subj_wheresql:=' and hs.subj_code like '''||p_subj_code||'%'' ';
      elsif p_subj_select_flag=3 then
          --3按范围查询,
          subj_code_begin:=regexp_substr(p_subj_code,'[^,]+',1,1,'i');
          subj_code_end:=regexp_substr(p_subj_code,'[^,]+',1,2,'i');
          subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
      elsif p_subj_select_flag=4 then
         --4弹出页面筛选查询
         --subj_wheresql:=' and hs.subj_id in('||p_subj_code||') ';
         subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||p_group_id||' and a.hos_id  = '||p_hos_id||' and a.copy_code= '''||p_copy_code||''' 
                         and a.subj_code in('||p_subj_code||') ';  
             
         subj_wheresql:=' and hs.subj_id in('||subj_id||') ';
         
      else
        --1查询全部
         subj_wheresql:=' ';
      end if;


      if p_acc_month_b='01' then

        /*年初余额*/
        summary:='上年结转';
        execute immediate 'insert into t_groupzchecksubjledger_result(xh,acc_year,acc_month,
        obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select 1,''0000'',''00'','||check_typeid||',aci.check_item_code,aci.check_item_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end),hs.is_check from acc_leder_check c
        inner join acc_subj hs on hs.subj_id=c.subj_id
        left join acc_check_item aci on c.'||check_typeid||'  = aci.check_item_id and aci.check_type_id=:p_check_item_type
         and aci.group_id=:group_id and aci.hos_id=:hos_id and aci.copy_code=:copy_code
        where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
        '||subj_wheresql||'
        '||source_wheresql||'
        '||check_wheresql||'
        
        group by '||check_typeid||',aci.check_item_code,aci.check_item_name,hs.subj_dire,hs.is_check'
        using p_check_item_type,p_group_id,p_hos_id,p_copy_code,p_group_id,p_hos_id,p_copy_code,p_acc_year_b;

      else
  /*期初余额*/
        summary:='期初余额';
        execute immediate 'insert into t_groupzchecksubjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
        select 1,''0000'',''00'','||check_typeid||',t1.check_item_code,t1.check_item_name,''期初余额'',sum(t1.debit),sum(t1.credit),0,sum(t1.end_os),t1.is_check  from
        (
          select '||check_typeid||',aci.check_item_code,aci.check_item_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,0,sum(case when hs.subj_dire=0 then c.end_os else c.end_os*(-1) end) end_os,hs.is_check from acc_leder_check c
          inner join acc_subj hs on hs.subj_id=c.subj_id
          left join acc_check_item aci on c.'||check_typeid||'  = aci.check_item_id and aci.check_type_id=:p_check_item_type
          and aci.group_id=:group_id and aci.hos_id=:hos_id and aci.copy_code=:copy_code
          where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
          '||subj_wheresql||'
          '||source_wheresql||'
            '||check_wheresql||'
          group by '||check_typeid||',aci.check_item_code,aci.check_item_name,hs.is_check
          union all
          select '||check_typeid||',aci.check_item_code,aci.check_item_name,sum(c.debit) debit,sum(c.credit) credit,0,
          sum(c.debit-c.credit) end_os,hs.is_check
          from acc_vouch_check c
          inner join acc_vouch v on v.vouch_id=c.vouch_id
          inner join acc_subj hs on hs.subj_id=c.subj_id
          left join acc_check_item aci on c.'||check_typeid||'  = aci.check_item_id and aci.check_type_id=:p_check_item_type
          and aci.group_id=:group_id and aci.hos_id=:hos_id and aci.copy_code=:copy_code 
         where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
          and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
          '||subj_wheresql||'
          '||source_wheresql||'
           '||check_wheresql||'
          group by '||check_typeid||',aci.check_item_code,aci.check_item_name,hs.is_check
         ) t1 group by '||check_typeid||',t1.check_item_code,t1.check_item_name,t1.is_check'
         using p_check_item_type,p_group_id,p_hos_id,p_copy_code,p_group_id,p_hos_id,p_copy_code,p_acc_year_b,
        p_check_item_type,p_group_id,p_hos_id,p_copy_code,p_group_id,p_hos_id,p_copy_code,p_state,p_acc_year_b,p_acc_month_b;

      end if;

      /*本月合计数据*/
      execute immediate 'insert into t_groupzchecksubjledger_result(xh,acc_year,acc_month
      ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
      select 2,v.acc_year,v.acc_month
      ,'||check_typeid||',aci.check_item_code,aci.check_item_name,''本月合计'',sum(c.debit),sum(c.credit),0,
      sum(c.debit)-sum(c.credit) end_os,hs.is_check
      from acc_vouch_check c
      inner join acc_vouch v on v.vouch_id=c.vouch_id
      inner join acc_vouch_type t on t.vouch_type_code=v.vouch_type_code and t.group_id=v.group_id and t.hos_id=v.hos_id and t.copy_code=v.copy_code
      inner join acc_subj hs on hs.subj_id=c.subj_id
      left join acc_check_item aci on c.'||check_typeid||'  = aci.check_item_id and aci.check_type_id=:p_check_item_type
      and aci.group_id=:group_id and aci.hos_id=:hos_id and aci.copy_code=:copy_code
      where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
      and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
      '||subj_wheresql||'
      '||source_wheresql||'
        '||check_wheresql||'
      group by v.acc_year,v.acc_month,'||check_typeid||',aci.check_item_code,aci.check_item_name,hs.is_check '
      using p_check_item_type,p_group_id,p_hos_id,p_copy_code,p_group_id,p_hos_id,p_copy_code,p_state,p_acc_year_b,p_acc_month_b,p_acc_year_e,p_acc_month_e;


      /*计算本月合计余额*/
      --dbms_output.put_line(ddl_sql);
      execute immediate '
      declare
        end_os_sum numeric(19,2);
        end_os_month numeric(19,2);
        obj_id numeric(18);
        xh integer;
        i number;
      begin
        i:=1;
        obj_id:=0;
        end_os_month:=0;
        for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupzchecksubjledger_result r
          where r.xh<3
          order by r.obj_id asc,r.acc_year asc,r.acc_month asc,r.xh asc) loop

          /*新的项目从0开始计算*/
          if obj_id<>cr.obj_id then
            end_os_sum:=0;
             if (cr.xh=2 ) or (i=1 and cr.xh>1) then
              
             if cr.acc_month = ''01'' then
                    insert into t_groupzchecksubjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''上年结转'',0);
            
                 else
                   
                    insert into t_groupzchecksubjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                  values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''期初余额'',0);
            
                 end if;
            
            end if; 

          end if;
          
          
           if obj_id=cr.obj_id and cr.xh=2 and xh!=1 then
    
         
              insert into t_groupzchecksubjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_dire,summary,end_os)
                  values( 1,cr.acc_year,cr.acc_month,cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_dire,''期初余额'',end_os_sum);
            
            end if;

          end_os_sum:=end_os_sum+cr.end_os;

          /*本月合计余额*/
          if cr.xh=2 then
             update t_groupzchecksubjledger_result set end_os=end_os_sum where xh=2 and obj_id=cr.obj_id
             and acc_year = cr.acc_year and acc_month=cr.acc_month;
          end if;

          i:=i+1;
          obj_id:=cr.obj_id;
          xh:=cr.xh;
        end loop;
      end;
      ';

      /*本年累计数据*/
      ddl_sql:='insert into t_groupzchecksubjledger_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
      select 3,t1.acc_year,t1.acc_month,t1.obj_id,t1.obj_code,t1.obj_name,''本年累计'',
      t1.debit+nvl((select sum(r1.debit) from t_groupzchecksubjledger_result r1 where r1.xh=1 and r1.debit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||p_acc_year_b||''' ),0),
      t1.credit+nvl((select sum(r1.credit) from t_groupzchecksubjledger_result r1 where r1.xh=1 and r1.credit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||p_acc_year_b||'''),0),
      t1.subj_dire,t1.end_os,t1.is_check from
        (select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,
        sum(r.debit) over(partition by r.acc_year,r.obj_id order by r.acc_month) debit,
        sum(r.credit) over(partition by r.acc_year,r.obj_id order by r.acc_month) credit,
        r.subj_dire,r.end_os,r.is_check
        from t_groupzchecksubjledger_result r
        where r.xh=2
        
       ) t1

      ';
      --dbms_output.put_line(ddl_sql);
      execute immediate ddl_sql;

      /*返回结果集游标*/
      ddl_sql:='select 
      case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
      case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
      t.obj_id,t.obj_code,t.obj_name
      ,t.summary,
      case when t.xh=1 then NULL else t.debit end debit,
      case when t.xh=1 then NULL else t.credit end credit,
      case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
      from t_groupzchecksubjledger_result t
      order by t.obj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.is_check
      ';
      --dbms_output.put_line(ddl_sql);
      open objdata for ddl_sql;

  END group_zchecksubjobjledger;
  
	]]></sql>
	
	<sql id="group_zchecksubjobjdetail" type="proc"><![CDATA[
		CREATE OR REPLACE PROCEDURE group_zchecksubjobjdetail
        (
         p_group_id number,
         p_hos_id number,
         p_copy_code varchar2,
         p_acc_year_b varchar2,
         p_acc_month_b varchar2,
         p_acc_year_e varchar2,
         p_acc_month_e varchar2,
         p_state integer,--包含未记账:1,99
         p_subj_select_flag integer,--科目查询方式:1查询全部,2直接下拉查询,3弹出页面按范围查询,4弹出页面筛选查询
         p_subj_code varchar2,--科目条件多个值用逗号分隔。参数格式：1=''，2='选择的科目编码'，3='开始科目编码,结束科目编码'，4='科目ID1,科目ID2,...‘
         p_check_item_type integer, --辅助核算类ID
         p_check_item_code varchar2,  --辅助核算项
         p_source_id varchar2,--资金来源ID字符串，逗号分隔。参数格式：查询全部='0'或者='1,2,3...'
         is_happend integer,--无发生不显示期初余额0,1
         objdata OUT ACT_BOOKS.zcheckledercursor
         )
        IS
            ddl_sql varchar2(4000);
            obj_sql varchar2(200);

            subj_code_begin varchar2(200);--开始科目编码
            subj_code_end varchar2(200);--结束科目编码
            obj_code_begin varchar2(200);--开始项目编码
            obj_code_end varchar2(200);--结束项目编码
            check_insertsql varchar2(500);--辅助核算添加动态字段
            check_selectsql varchar2(4000);--辅助核算添加时查询动态字段
            check_joinsql varchar2(4000);--辅助核算添加关联表动态字段
            --check_resultsql varchar2(500); --辅助核算返回结果集动态字段
            check_typeid varchar2(20);
            check_typeid_str varchar2(20);--用于区分是否自定义辅助核算
            check_wheresql varchar2(2000);
            source_wheresql varchar2(200);
            subj_wheresql varchar2(4000);
            obj_wheresql varchar2(4000);
            summary varchar2(20);
            subj_id varchar2(4000) ;
            num NUMBER;
            happen_where varchar2(4000);
        BEGIN
          
            /*条件处理begin*/
            if p_source_id='0' then
                 source_wheresql:='';--资源来源ID
            else
                 source_wheresql:=' and c.check7_id in('||p_source_id||') ';--资金来源ID
            end if;

               /*辅助核算类id*/
           select column_check into check_typeid from acc_check_type
            where group_id=p_group_id and hos_id=p_hos_id
            and copy_code=p_copy_code and check_type_id=p_check_item_type;
           select is_sys into check_typeid_str from acc_check_type
            where group_id=p_group_id and hos_id=p_hos_id
            and copy_code=p_copy_code and check_type_id=p_check_item_type;

             if(p_check_item_code is null) then
               if(check_typeid_str=0) then
                 check_wheresql:=' and nvl(c.'||check_typeid||',0)!=0';
                  check_typeid:=check_typeid;
               else
                 check_wheresql:=' and nvl(c.'||check_typeid||'_id,0)!=0';
                  check_typeid:=check_typeid||'_id';
               end if;
             else

               if(check_typeid_str=0) then

                 check_wheresql:=' and nvl(c.'||check_typeid||',0)!=0  and c.'||check_typeid||' in ('||p_check_item_code||')';
                 check_typeid:=check_typeid;

               else
                check_wheresql:=' and nvl(c.'||check_typeid||'_id,0)!=0  and c.'||check_typeid||'_id in ('||p_check_item_code||')';
                 -- check_wheresql:=' and nvl(c.'||check_typeid||'_id,0)!=0  ';
                 check_typeid:=check_typeid||'_id';

               end if;
              end if;



            /*科目查询方式*/
            if p_subj_select_flag=2 then
                --2直接选择查询,
                subj_wheresql:=' and hs.subj_code like '''||p_subj_code||'%'' ';
            elsif p_subj_select_flag=3 then
                --3按范围查询,
                subj_code_begin:=regexp_substr(p_subj_code,'[^,]+',1,1,'i');
                subj_code_end:=regexp_substr(p_subj_code,'[^,]+',1,2,'i');
                subj_wheresql:=' and hs.subj_code between '''||subj_code_begin||''' and '''||subj_code_end||''' ';
            elsif p_subj_select_flag=4 then
               --4弹出页面筛选查询
               --subj_wheresql:=' and hs.subj_id in('||p_subj_code||') ';
              subj_id:= ' select a.subj_id from acc_subj a where a.group_id ='||p_group_id||' and a.hos_id  = '||p_hos_id||' and a.copy_code= '''||p_copy_code||'''
                         and a.subj_code in('||p_subj_code||') ';

              subj_wheresql:=' and hs.subj_id in('||subj_id||') ';

            else
              --1查询全部
               subj_wheresql:=' ';
            end if;

            if is_happend = 1 then
                     happen_where:='where (exists(
                                          select 1 from t_groupzchecksubjdetail_result  t1
                                          where t1.obj_id=t.obj_id
                                                and TO_NUMBER(t1.acc_year||''''||t1.acc_month)
                                                between TO_NUMBER('||p_acc_year_b||''||p_acc_month_b||')
                                                and TO_NUMBER('||p_acc_year_e||''||p_acc_month_e||')
                                                ))';
            else
                  happen_where:='';
            end if;

            if p_acc_month_b='01' then

              /*年初余额*/
              summary:='上年结转';

              execute immediate 'insert into t_groupzchecksubjdetail_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,vouch_id,is_check)
              select 1,''0000'',''00'','||check_typeid||',aci.check_item_code,aci.check_item_name,''上年结转'',sum(c.sum_od),sum(c.sum_oc),0,sum(c.end_os) ,0 ,hs.is_check
              from acc_leder_check c
              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                      and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
              left join acc_check_item aci on c.'||check_typeid||'  = aci.check_item_id and aci.check_type_id=:p_check_item_type
               and aci.group_id=:group_id and aci.hos_id=:hos_id and aci.copy_code=:copy_code
              where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
              '||subj_wheresql||'
              '||source_wheresql||'
              '||check_wheresql||'
               group by '||check_typeid||',aci.check_item_code,aci.check_item_name,hs.is_check'
              using p_check_item_type,p_group_id,p_hos_id,p_copy_code,p_group_id,p_hos_id,p_copy_code,p_acc_year_b;

            else
              /*期初余额*/
              summary:='期初余额';
              execute immediate 'insert into t_groupzchecksubjdetail_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,vouch_id,is_check)
              select 1,''0000'',''00'','||check_typeid||',t1.check_item_code,t1.check_item_name,''期初余额'',sum(t1.debit),sum(t1.credit), t1.subj_dire,sum(t1.end_os),0 vouch_id,t1.is_check  from
              (
                select '||check_typeid||',aci.check_item_code,aci.check_item_name,sum(c.sum_od) debit,sum(c.sum_oc) credit,
               hs.subj_dire,sum(c.end_os) end_os ,hs.is_check
                from acc_leder_check c
                inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                      and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
                left join acc_check_item aci on c.'||check_typeid||'  = aci.check_item_id and aci.check_type_id=:p_check_item_type
                     and aci.group_id=:group_id and aci.hos_id=:hos_id and aci.copy_code=:copy_code
                where c.group_id=:group_id and c.hos_id=:hos_id and c.copy_code=:copy_code and c.acc_year=:acc_year_b and c.acc_month=''00''
                '||subj_wheresql||'
                '||source_wheresql||'
                  '||check_wheresql||'
                group by '||check_typeid||',aci.check_item_code,aci.check_item_name,hs.is_check, hs.subj_dire
                union all
                select '||check_typeid||',aci.check_item_code,aci.check_item_name,sum(c.debit) debit,sum(c.credit) credit, hs.subj_dire,
                case when hs.subj_dire = 0 then  sum(c.debit - c.credit)
                    when hs.subj_dire = 1 then  sum(c.credit - c.debit) end as  end_os,
                      hs.is_check
                from acc_vouch_check c
                inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                        and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
                inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                      and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
                left join acc_check_item aci on c.'||check_typeid||'  = aci.check_item_id and aci.check_type_id=:p_check_item_type
                     and aci.group_id=:group_id and aci.hos_id=:hos_id and aci.copy_code=:copy_code
                where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
                      and v.acc_year=:acc_year_b and v.acc_month<:acc_month_b
                      '||subj_wheresql||'
                      '||source_wheresql||'
                      '||check_wheresql||'
                group by '||check_typeid||',aci.check_item_code,aci.check_item_name,hs.is_check,hs.subj_dire
               ) t1 group by '||check_typeid||',t1.check_item_code,t1.check_item_name,t1.is_check, t1.subj_dire'
               using p_check_item_type,p_group_id,p_hos_id,p_copy_code,p_group_id,p_hos_id,p_copy_code,p_acc_year_b,
              p_check_item_type,p_group_id,p_hos_id,p_copy_code,p_group_id,p_hos_id,p_copy_code,p_state,p_acc_year_b,p_acc_month_b;

            end if;


            /*本期发生凭证数据*/
            execute immediate 'insert into t_groupzchecksubjdetail_result(check_id,xh,acc_year,acc_month,vouch_date,vouch_no
            '||check_insertsql||'
            ,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,vouch_id,is_check)
            select c.vouch_check_id,2,v.acc_year,v.acc_month,v.vouch_date,t.vouch_type_short||''-''||v.vouch_no vouch_no
            '||check_selectsql||'
            ,'||check_typeid||',aci.check_item_code,aci.check_item_name,c.summary,c.debit,c.credit,0,
            case when subj_dire = 0  then (c.debit-c.credit)
              when subj_dire = 1  then  (c.credit-c.debit) end   end_os
              ,v.vouch_id vouch_id,hs.is_check
            from acc_vouch_check c
            inner join acc_vouch v on c.group_id = v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
                        and c.acc_year = v.acc_year and c.vouch_id=v.vouch_id
            inner join acc_vouch_type t on v.group_id=t.group_id
                    and v.hos_id=t.hos_id and v.copy_code=t.copy_code and v.vouch_type_code=t.vouch_type_code
            inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
                      and c.acc_year = hs.acc_year and c.subj_id=hs.subj_id
            left join acc_check_item aci on c.'||check_typeid||'  = aci.check_item_id and aci.check_type_id=:p_check_item_type
             and aci.group_id=:group_id and aci.hos_id=:hos_id and aci.copy_code=:copy_code
            '||check_joinsql||'
            where v.group_id=:group_id and v.hos_id=:hos_id and v.copy_code=:copy_code and v.state>=:state
            and TO_NUMBER(v.acc_year||''''||v.acc_month) between TO_NUMBER(:acc_year_b||''''||:acc_month_b) and TO_NUMBER(:acc_year_e||''''||:acc_month_e)
            '||subj_wheresql||'
            '||source_wheresql||'
             '||check_wheresql||'
            order by v.acc_year,v.acc_month,v.vouch_no,v.vouch_date,v.create_date,hs.is_check
            ' using p_check_item_type,p_group_id,p_hos_id,p_copy_code,p_group_id,p_hos_id,p_copy_code,p_state,p_acc_year_b,p_acc_month_b,p_acc_year_e,p_acc_month_e;

            /*本月合计数据*/
            ddl_sql:='insert into t_groupzchecksubjdetail_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,vouch_id,is_check)
            select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本月合计'',sum(r.debit),sum(r.credit),r.subj_dire,0 end_os,0 vouch_id,r.is_check
            from t_groupzchecksubjdetail_result r
            where r.xh=2
            group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,r.subj_dire,r.is_check
            ';

            execute immediate ddl_sql;

            /*本年累计数据*/
            ddl_sql:='insert into t_groupzchecksubjdetail_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os,is_check)
            select 3,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,''本月累计'',sum(r.debit),sum(r.credit),r.subj_dire,0 end_os,r.is_check
            from t_groupzchecksubjdetail_result r
            where r.xh=3
            group by r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,r.subj_dire,r.is_check
            ';
            --dbms_output.put_line(ddl_sql);
            execute immediate ddl_sql;

            /*计算本期发生凭证、本月合计余额*/
            --dbms_output.put_line(ddl_sql);
            execute immediate '
            declare
              end_os_sum numeric(19,2);
              end_os_month numeric(19,2);
              obj_id numeric(18);
              acc_month_y varchar2(2);
              xh integer;
              i number;
            begin
              i:=1;
              obj_id:=0;
              end_os_month:=0;
              for cr in (select r.xh,r.obj_id,r.obj_code,r.obj_name,r.check_id,r.end_os,r.acc_year,r.acc_month,r.subj_dire from t_groupzchecksubjdetail_result r
                where r.xh<4
                order by r.obj_id asc,r.acc_year asc,r.acc_month asc,r.xh asc,r.vouch_date asc,r.check_id asc) loop

                /*新的项目从0开始计算*/
                if obj_id<>cr.obj_id then
                  end_os_sum:=0;

                  /*有发生数据没有期初余额新增加一条期初余额*/
                  if (cr.xh=2 and cr.xh<>xh) or (i=1 and cr.xh>1) then

                       if cr.acc_month = ''01'' then
                  insert into t_groupzchecksubjdetail_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                        values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''上年结转'',0);

                  else
                    insert into t_groupzchecksubjdetail_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,end_os)
                        values( 1,''0000'',''00'',cr.obj_id,cr.obj_code,cr.obj_name,''期初余额'',0);

                   end if;

                 end if;
                end if;

                if obj_id=cr.obj_id and cr.xh=2 and xh!=1 then


                  /*有发生数据没有期初余额新增加一条期初余额*/
                  if (acc_month_y!=cr.acc_month) then
                      insert into t_groupzchecksubjdetail_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,subj_dire,summary,end_os)
                        values( 1,cr.acc_year,cr.acc_month,cr.obj_id,cr.obj_code,cr.obj_name,cr.subj_dire,''期初余额'',end_os_sum);


                 end if;
                end if;


                end_os_sum:=end_os_sum+cr.end_os;

                /*本期发生凭证余额*/
                if cr.xh=2 then
                   update t_groupzchecksubjdetail_result set end_os=end_os_sum where check_id = cr.check_id and xh=2;
                end if;
                /*本月合计余额*/
                if cr.xh=3 then
                   update t_groupzchecksubjdetail_result set end_os=end_os_sum where xh=3 and obj_id=cr.obj_id
                   and acc_year = cr.acc_year and acc_month=cr.acc_month;
                end if;

                /*本年累计余额*/
                  if cr.xh=4 then
                     update t_accbookssubjobj_result set end_os=end_os_sum
                     where xh=4 and obj_id=cr.obj_id and acc_year = cr.acc_year and acc_month=cr.acc_month;
                  end if;

                i:=i+1;
                obj_id:=cr.obj_id;
                acc_month_y:=cr.acc_month;
                xh:=cr.xh;
              end loop;
            end;
            ';

            /*本年累计数据*/
            /*ddl_sql:='insert into t_groupzchecksubjdetail_result(xh,acc_year,acc_month,obj_id,obj_code,obj_name,summary,debit,credit,subj_dire,end_os)
            select 4,t1.acc_year,t1.acc_month,t1.obj_id,t1.obj_code,t1.obj_name,''本年累计'',
            t1.debit+nvl((select r1.debit from t_groupzchecksubjdetail_result r1 where r1.xh=1 and r1.debit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||p_acc_year_b||'''),0),
            t1.credit+nvl((select r1.credit from t_groupzchecksubjdetail_result r1 where r1.xh=1 and r1.credit<>0 and r1.obj_id=t1.obj_id and t1.acc_year='''||p_acc_year_b||'''),0),
            t1.subj_dire,t1.end_os from
              (select 4,r.acc_year,r.acc_month,r.obj_id,r.obj_code,r.obj_name,
              sum(r.debit) over(partition by r.acc_year,r.obj_id order by r.acc_month) debit,
              sum(r.credit) over(partition by r.acc_year,r.obj_id order by r.acc_month) credit,
              r.subj_dire,r.end_os
              from t_groupzchecksubjdetail_result r
              where r.xh=3
             ) t1';
            --dbms_output.put_line(ddl_sql);
            execute immediate ddl_sql;*/

            /*返回结果集游标*/
            ddl_sql:='select
                    case when t.xh=1 then '''' else replace(t.acc_year,''0000'','''') end  acc_year,
                    case when t.xh=1 then '''' else replace(t.acc_month,''00'','''') end   acc_month,
                    to_char(t.vouch_date,''dd'') acc_day,t.vouch_no,
                    t.obj_code||'' ''||t.obj_name obj_name '||check_insertsql||'
                    ,t.summary,t.vouch_id,
                    case when t.xh=1 then NULL else t.debit end debit,
                    case when t.xh=1 then NULL else t.credit end credit,
                    case when t.end_os=0 then ''平'' when t.subj_dire=0 then ''借'' else ''贷'' end subj_dire,t.end_os,t.is_check
            from t_groupzchecksubjdetail_result t
           '||happen_where||'
            order by t.obj_code asc,t.acc_year asc,t.acc_month asc,t.xh asc,t.vouch_date,t.check_id asc,t.is_check
            ';
            --dbms_output.put_line(ddl_sql);
            open objdata for ddl_sql ;--using p_acc_year_b,p_acc_month_b,p_acc_year_e,p_acc_month_e;

        END group_zchecksubjobjdetail;
		
	]]></sql>
	
</root>



