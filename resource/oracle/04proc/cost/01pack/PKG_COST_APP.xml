<?xml version="1.0" encoding="UTF-8" ?>
<root>
	<!-- 成本分摊存储过程 -->
	<sql id="PKG_COST_APP" type="proc"><![CDATA[
	CREATE OR REPLACE PACKAGE pkg_cost_app AS

  /*-------------------------------------------------------------------------*/
  /* 变量声明区                                                              */
  /*-------------------------------------------------------------------------*/
  def_OK      CONSTANT NUMBER := 0; -- 成功
  def_ERR     CONSTANT NUMBER := -1; -- 系统错误
  def_WARNING CONSTANT NUMBER := 100; -- 系统警告

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_dept_dir_data
  || 功能描述 ：分摊年月的科室直接成本
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_dept_dir_data(prm_group_id  IN NUMBER --集团
                             ,
                              prm_hos_id    IN NUMBER --医院
                             ,
                              prm_copy_code IN VARCHAR2 --账套
                             ,
                              prm_acc_year  IN VARCHAR2 --年度
                             ,
                              prm_acc_month IN VARCHAR2 --月份
                              );

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_para_set
  || 功能描述 ：按照分摊类别统计分摊参数
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_para_set(prm_group_id  IN NUMBER --集团
                        ,
                         prm_hos_id    IN NUMBER --医院
                        ,
                         prm_copy_code IN VARCHAR2 --账套
                        ,
                         prm_acc_year  IN VARCHAR2 --年度
                        ,
                         prm_acc_month IN VARCHAR2 --月份
                         );

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_para_set
  || 功能描述 ：按照分摊类别统计分摊参数
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_para_dept(prm_group_id  IN NUMBER --集团
                         ,
                          prm_hos_id    IN NUMBER --医院
                         ,
                          prm_copy_code IN VARCHAR2 --账套
                         ,
                          prm_acc_year  IN VARCHAR2 --年度
                         ,
                          prm_acc_month IN VARCHAR2 --月份
                          );

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_para_server_dept
  || 功能描述 ：按照分摊类别统计分摊参数
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_para_server_dept(prm_group_id  IN NUMBER --集团
                                ,
                                 prm_hos_id    IN NUMBER --医院
                                ,
                                 prm_copy_code IN VARCHAR2 --账套
                                ,
                                 prm_acc_year  IN VARCHAR2 --年度
                                ,
                                 prm_acc_month IN VARCHAR2 --月份
                                 );

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value
  || 功能描述 ：按照分摊类别统计分摊参数
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_server_para_value(prm_group_id  IN NUMBER --集团
                                 ,
                                  prm_hos_id    IN NUMBER --医院
                                 ,
                                  prm_copy_code IN VARCHAR2 --账套
                                 ,
                                  prm_acc_year  IN VARCHAR2 --年度
                                 ,
                                  prm_acc_month IN VARCHAR2 --月份
                                  );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value_01
  || 功能描述 ：按照分摊类别统计分摊参数 人员
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_server_para_value_01(prm_group_id  IN NUMBER --集团
                                    ,
                                     prm_hos_id    IN NUMBER --医院
                                    ,
                                     prm_copy_code IN VARCHAR2 --账套
                                    ,
                                     prm_acc_year  IN VARCHAR2 --年度
                                    ,
                                     prm_acc_month IN VARCHAR2 --月份
                                     );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value_02
  || 功能描述 ：按照分摊类别统计分摊参数 面积
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_server_para_value_02(prm_group_id  IN NUMBER --集团
                                    ,
                                     prm_hos_id    IN NUMBER --医院
                                    ,
                                     prm_copy_code IN VARCHAR2 --账套
                                    ,
                                     prm_acc_year  IN VARCHAR2 --年度
                                    ,
                                     prm_acc_month IN VARCHAR2 --月份
                                     );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value_03
  || 功能描述 ：按照分摊类别统计分摊参数 工作量
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_server_para_value_03(prm_group_id  IN NUMBER --集团
                                    ,
                                     prm_hos_id    IN NUMBER --医院
                                    ,
                                     prm_copy_code IN VARCHAR2 --账套
                                    ,
                                     prm_acc_year  IN VARCHAR2 --年度
                                    ,
                                     prm_acc_month IN VARCHAR2 --月份
                                     );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value_04
  || 功能描述 ：按照分摊类别统计分摊参数 工时
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  /*PROCEDURE prc_server_para_value_04(prm_group_id  IN NUMBER --集团
  ,prm_hos_id    IN NUMBER --医院
  ,prm_copy_code IN VARCHAR2 --账套
  ,prm_acc_year  IN VARCHAR2 --年度
  ,prm_acc_month IN VARCHAR2 --月份
   );*/
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value_05
  || 功能描述 ：按照分摊类别统计分摊参数 服务量
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_server_para_value_05(prm_group_id  IN NUMBER --集团
                                    ,
                                     prm_hos_id    IN NUMBER --医院
                                    ,
                                     prm_copy_code IN VARCHAR2 --账套
                                    ,
                                     prm_acc_year  IN VARCHAR2 --年度
                                    ,
                                     prm_acc_month IN VARCHAR2 --月份
                                     );

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value_06
  || 功能描述 ：按照分摊类别统计分摊参数  收入
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_server_para_value_06(prm_group_id  IN NUMBER --集团
                                    ,
                                     prm_hos_id    IN NUMBER --医院
                                    ,
                                     prm_copy_code IN VARCHAR2 --账套
                                    ,
                                     prm_acc_year  IN VARCHAR2 --年度
                                    ,
                                     prm_acc_month IN VARCHAR2 --月份
                                     );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value_custom
  || 功能描述 ：按照分摊类别统计分摊参数 自定义部分
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_server_para_value_custom(prm_group_id  IN NUMBER --集团
                                        ,
                                         prm_hos_id    IN NUMBER --医院
                                        ,
                                         prm_copy_code IN VARCHAR2 --账套
                                        ,
                                         prm_acc_year  IN VARCHAR2 --年度
                                        ,
                                         prm_acc_month IN VARCHAR2 --月份
                                         );

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_type_para
  || 功能描述 ：构建分摊性质和分摊类型对应的访问当量总和
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_type_para_load(prm_group_id  IN NUMBER --集团
                                   ,
                                    prm_hos_id    IN NUMBER --医院
                                   ,
                                    prm_copy_code IN VARCHAR2 --账套
                                    );

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_dept_man_peers
  || 功能描述 ：分摊管理成本 平级
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_dept_man_peers(prm_group_id  IN NUMBER --集团
                                   ,
                                    prm_hos_id    IN NUMBER --医院
                                   ,
                                    prm_copy_code IN VARCHAR2 --账套
                                   ,
                                    prm_acc_year  IN VARCHAR2 --年度
                                   ,
                                    prm_acc_month IN VARCHAR2 --月份
                                    );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_dept_man
  || 功能描述 ：分摊管理成本
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_dept_man(prm_group_id  IN NUMBER --集团
                             ,
                              prm_hos_id    IN NUMBER --医院
                             ,
                              prm_copy_code IN VARCHAR2 --账套
                             ,
                              prm_acc_year  IN VARCHAR2 --年度
                             ,
                              prm_acc_month IN VARCHAR2 --月份
                              );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_dept_ass_peers
  || 功能描述 ：分摊医辅成本 平级
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_dept_ass_peers(prm_group_id  IN NUMBER --集团
                                   ,
                                    prm_hos_id    IN NUMBER --医院
                                   ,
                                    prm_copy_code IN VARCHAR2 --账套
                                   ,
                                    prm_acc_year  IN VARCHAR2 --年度
                                   ,
                                    prm_acc_month IN VARCHAR2 --月份
                                    );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_dept_med
  || 功能描述 ：分摊医辅成本
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_dept_ass(prm_group_id  IN NUMBER --集团
                             ,
                              prm_hos_id    IN NUMBER --医院
                             ,
                              prm_copy_code IN VARCHAR2 --账套
                             ,
                              prm_acc_year  IN VARCHAR2 --年度
                             ,
                              prm_acc_month IN VARCHAR2 --月份
                              );

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_dept_med_peers
  || 功能描述 ：分摊医技成本 平级
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_dept_med_peers(prm_group_id  IN NUMBER --集团
                                   ,
                                    prm_hos_id    IN NUMBER --医院
                                   ,
                                    prm_copy_code IN VARCHAR2 --账套
                                   ,
                                    prm_acc_year  IN VARCHAR2 --年度
                                   ,
                                    prm_acc_month IN VARCHAR2 --月份
                                    );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_dept_med
  || 功能描述 ：分摊医技成本
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_dept_med(prm_group_id  IN NUMBER --集团
                             ,
                              prm_hos_id    IN NUMBER --医院
                             ,
                              prm_copy_code IN VARCHAR2 --账套
                             ,
                              prm_acc_year  IN VARCHAR2 --年度
                             ,
                              prm_acc_month IN VARCHAR2 --月份
                              );

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_dept_cost
  || 功能描述 ：按照分摊类别统计分摊参数
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_dept_cost(prm_group_id  IN NUMBER --集团
                              ,
                               prm_hos_id    IN NUMBER --医院
                              ,
                               prm_copy_code IN VARCHAR2 --账套
                              ,
                               prm_acc_year  IN VARCHAR2 --年度
                              ,
                               prm_acc_month IN VARCHAR2 --月份
                              ,
                               prm_AppCode   Out Number --执行代码
                              ,
                               prm_ErrTxt    Out Varchar2 --错误信息
                               );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_check_data
  || 功能描述 ：校验分摊前相关数据是否配置正确
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_check_data(prm_group_id  IN NUMBER --集团
                          ,
                           prm_hos_id    IN NUMBER --医院
                          ,
                           prm_copy_code IN VARCHAR2 --账套
                          ,
                           prm_acc_year  IN VARCHAR2 --年度
                          ,
                           prm_acc_month IN VARCHAR2 --月份
                          ,
                           prm_AppCode   Out Number --执行代码
                          ,
                           prm_ErrTxt    Out Varchar2 --错误信息
                           );

END pkg_cost_app;

	]]></sql>
	<sql id="PKG_COST_APP_BODY" type="proc"><![CDATA[
	CREATE OR REPLACE PACKAGE BODY pkg_cost_app AS

  /*-------------------------------------------------------------------------*/
  /* 私有全局常量声明                                                        */
  /*-------------------------------------------------------------------------*/

  error_i    INTEGER; --信息提示 下标
  is_exists  INTEGER; --是否存在要处理的数据
  is_default INTEGER; --系統默认分摊参数 人员

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_dept_dir_data
  || 功能描述 ：分摊年月的科室直接成本
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_dept_dir_data(prm_group_id  IN NUMBER --集团
                             ,
                              prm_hos_id    IN NUMBER --医院
                             ,
                              prm_copy_code IN VARCHAR2 --账套
                             ,
                              prm_acc_year  IN VARCHAR2 --年度
                             ,
                              prm_acc_month IN VARCHAR2 --月份
                              ) IS
  BEGIN
  
    --删除当前数据
    DELETE FROM cost_dept_dri_share
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code;
  
    --重新添加数据
    INSERT INTO cost_dept_dri_share
      (group_id,
       hos_id,
       copy_code,
       dept_id,
       cost_item_id,
       source_id,
       dir_amount,
       type_code,
       natur_code,
       para_code,
       para_type_code,
       dept_name,
       cost_item_name,
       para_name,
       para_type_name,
       bill_code,
       dept_code,
       cost_item_code)
      SELECT t1.group_id,
             t1.hos_id,
             t1.copy_code,
             t1.dept_id,
             t1.cost_item_id,
             t1.source_id,
             t1.dir_amount,
             t3.type_code,
             t3.natur_code,
             t3.para_code,
             t4.para_type_code --分摊类型
            ,
             t5.dept_name,
             t4.cost_item_name,
             t6.para_name,
             t7.type_name para_type_name,
             t8.bill_code --单据类型
            ,
             t5.dept_code --科室编码
            ,
             t4.cost_item_code --成本项目编码
        FROM cost_dept_dri_data t1 --科室直接成本表
        LEFT JOIN acc_dept_attr t3
          ON t3.group_id = t1.group_id
         AND t3.hos_id = t1.hos_id
         AND t1.dept_id = t3.dept_id
         AND t3.natur_code != '06' --科研 不参加分摊
        LEFT JOIN hos_dept t5
          ON t1.group_id = t5.group_id
         AND t1.hos_id = t5.hos_id
         AND t1.dept_id = t5.dept_id
      
        LEFT JOIN cost_item_dict t4
          ON t4.group_id = t1.group_id
         AND t4.hos_id = t1.hos_id
         AND t4.copy_code = t1.copy_code
         AND t1.cost_item_id = t4.cost_item_id
        LEFT JOIN cost_para_natur t6
          ON t6.group_id = t3.group_id
         AND t6.hos_id = t3.hos_id
         AND t6.para_code = t3.para_code
        LEFT JOIN cost_para_type t7
          ON t7.group_id = t4.group_id
         AND t7.hos_id = t4.hos_id
         AND t7.copy_code = t4.copy_code
         AND t7.type_code = t4.para_type_code
        LEFT JOIN cost_para_dept t8
          ON t1.group_id = t8.group_id
         AND t1.hos_id = t8.hos_id
         AND t1.copy_code = t8.copy_code
         AND t1.dept_id = t8.dept_id
         AND t1.dept_no = t8.dept_no
         AND t1.acc_year = t8.acc_year
         AND t1.acc_month = t8.acc_month
       WHERE t1.group_id = prm_group_id --集团
         AND t1.hos_id = prm_hos_id --医院
         AND t1.copy_code = prm_copy_code --帐套
         AND t1.acc_year = prm_acc_year --分摊年份
         AND t1.acc_month = prm_acc_month --分摊月份
      ;
    RETURN;
  
  END prc_dept_dir_data;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_para_set
  || 功能描述 ：按照分摊类别统计分摊参数
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_para_set(prm_group_id  IN NUMBER --集团
                        ,
                         prm_hos_id    IN NUMBER --医院
                        ,
                         prm_copy_code IN VARCHAR2 --账套
                        ,
                         prm_acc_year  IN VARCHAR2 --年度
                        ,
                         prm_acc_month IN VARCHAR2 --月份
                         ) IS
  BEGIN
  
    --删除当前分摊类型数据
    DELETE FROM cost_para_set_share
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code;
  
    --查询 当月数据是否配置 分摊参数
    INSERT INTO cost_para_set_share
      SELECT t1.group_id,
             t1.hos_id,
             t1.copy_code,
             t1.natur_code para_code,
             t1.type_code  para_type_code,
             t1.para_value,
             t1.bill_type,
             t1.bill_name
        FROM cost_para_set t1
       WHERE t1.group_id = prm_group_id --集团
         AND t1.hos_id = prm_hos_id --医院
         AND t1.copy_code = prm_copy_code --帐套
         AND t1.acc_year = prm_acc_year --分摊年份
         AND t1.acc_month = prm_acc_month; --分摊月份
  
    RETURN;
  
  EXCEPTION
  
    WHEN OTHERS THEN
      ROLLBACK;
    
  END prc_para_set;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_para_dept
  || 功能描述 ：按照分摊类别统计分摊参数
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_para_dept(prm_group_id  IN NUMBER --集团
                         ,
                          prm_hos_id    IN NUMBER --医院
                         ,
                          prm_copy_code IN VARCHAR2 --账套
                         ,
                          prm_acc_year  IN VARCHAR2 --年度
                         ,
                          prm_acc_month IN VARCHAR2 --月份
                          ) IS
  BEGIN
  
    DELETE FROM cost_para_dept_share
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code;
  
    INSERT INTO cost_para_dept_share
      SELECT DISTINCT t1.group_id,
                      t1.hos_id,
                      t1.copy_code,
                      t1.bill_code,
                      t1.dept_id,
                      t1.type_code,
                      t1.natur_code,
                      t3.para_code
        FROM cost_para_dept t1
        LEFT JOIN acc_dept_attr t3
          ON t1.group_id = t3.group_id
         AND t1.hos_id = t3.hos_id
         AND t1.dept_id = t3.dept_id
       WHERE t1.group_id = prm_group_id --集团
         AND t1.hos_id = prm_hos_id --医院
         AND t1.copy_code = prm_copy_code --帐套
         AND t1.acc_year = prm_acc_year --分摊年份
         AND t1.acc_month = prm_acc_month; --分摊月份
  
    RETURN;
  
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
    
  END prc_para_dept;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_para_server_dept
  || 功能描述 ：按照分摊类别统计分摊参数
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_para_server_dept(prm_group_id  IN NUMBER --集团
                                ,
                                 prm_hos_id    IN NUMBER --医院
                                ,
                                 prm_copy_code IN VARCHAR2 --账套
                                ,
                                 prm_acc_year  IN VARCHAR2 --年度
                                ,
                                 prm_acc_month IN VARCHAR2 --月份
                                 ) IS
  BEGIN
  
    DELETE FROM cost_para_server_dept_share
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code;
  
    INSERT INTO cost_para_server_dept_share
      SELECT DISTINCT t1.group_id,
                      t1.hos_id,
                      t1.copy_code,
                      t1.bill_code,
                      t1.dept_id,
                      t1.type_code,
                      t1.natur_code,
                      t3.para_code --分摊性质
        FROM cost_para_server_dept t1
        LEFT JOIN acc_dept_attr t3
          ON t1.group_id = t3.group_id
         AND t1.hos_id = t3.hos_id
         AND t1.dept_id = t3.dept_id
       WHERE t1.group_id = prm_group_id --集团
         AND t1.hos_id = prm_hos_id --医院
         AND t1.copy_code = prm_copy_code --帐套
         AND t1.acc_year = prm_acc_year --分摊年份
         AND t1.acc_month = prm_acc_month; --分摊月份
  
    RETURN;
  
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
    
  END prc_para_server_dept;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value
  || 功能描述 ：按照分摊类别统计分摊参数
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_server_para_value(prm_group_id  IN NUMBER --集团
                                 ,
                                  prm_hos_id    IN NUMBER --医院
                                 ,
                                  prm_copy_code IN VARCHAR2 --账套
                                 ,
                                  prm_acc_year  IN VARCHAR2 --年度
                                 ,
                                  prm_acc_month IN VARCHAR2 --月份
                                  ) IS
  BEGIN
  
    prc_server_para_value_01(prm_group_id,
                             prm_hos_id,
                             prm_copy_code,
                             prm_acc_year,
                             prm_acc_month);
  
    prc_server_para_value_02(prm_group_id,
                             prm_hos_id,
                             prm_copy_code,
                             prm_acc_year,
                             prm_acc_month);
    prc_server_para_value_03(prm_group_id,
                             prm_hos_id,
                             prm_copy_code,
                             prm_acc_year,
                             prm_acc_month);
    /* prc_server_para_value_04(prm_group_id
    ,prm_hos_id
    ,prm_copy_code
    ,prm_acc_year
    ,prm_acc_month);*/
    prc_server_para_value_05(prm_group_id,
                             prm_hos_id,
                             prm_copy_code,
                             prm_acc_year,
                             prm_acc_month);
    prc_server_para_value_06(prm_group_id,
                             prm_hos_id,
                             prm_copy_code,
                             prm_acc_year,
                             prm_acc_month);
    prc_server_para_value_custom(prm_group_id,
                                 prm_hos_id,
                                 prm_copy_code,
                                 prm_acc_year,
                                 prm_acc_month);
    RETURN;
  END prc_server_para_value;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value_01
  || 功能描述 ：按照分摊类别统计分摊参数 人员
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_server_para_value_01(prm_group_id  IN NUMBER --集团
                                    ,
                                     prm_hos_id    IN NUMBER --医院
                                    ,
                                     prm_copy_code IN VARCHAR2 --账套
                                    ,
                                     prm_acc_year  IN VARCHAR2 --年度
                                    ,
                                     prm_acc_month IN VARCHAR2 --月份
                                     ) IS
  
  BEGIN
    --人员
    DELETE FROM cost_para_value_data
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code
       AND para_value = '01';
  
    INSERT INTO cost_para_value_data
      (group_id,
       hos_id,
       copy_code,
       dept_id,
       server_dept_id,
       para_value,
       para_amount)
    
      SELECT group_id,
             hos_id,
             copy_code,
             dept_id,
             dept_id server_dept_id,
             '01' para_code,
             SUM(nvl(alldept_num, 0)) num_amount
        FROM COST_DEPT_PEOPLE a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND EXISTS (SELECT 1
                FROM cost_para_server_dept_share t1
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.dept_id = t1.dept_id)
       GROUP BY group_id, hos_id, copy_code, dept_id;
  
    RETURN;
  END prc_server_para_value_01;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value_02
  || 功能描述 ：按照分摊类别统计分摊参数 面积
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_server_para_value_02(prm_group_id  IN NUMBER --集团
                                    ,
                                     prm_hos_id    IN NUMBER --医院
                                    ,
                                     prm_copy_code IN VARCHAR2 --账套
                                    ,
                                     prm_acc_year  IN VARCHAR2 --年度
                                    ,
                                     prm_acc_month IN VARCHAR2 --月份
                                     ) IS
  
  BEGIN
  
    --面积
    DELETE FROM cost_para_value_data
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code
       AND para_value = '02';
  
    INSERT INTO cost_para_value_data
      (group_id,
       hos_id,
       copy_code,
       dept_id,
       server_dept_id,
       para_value,
       para_amount)
      SELECT group_id,
             hos_id,
             copy_code,
             dept_id,
             dept_id server_dept_id,
             '02' para_code,
             SUM(nvl(arear, 0)) num_amount
        FROM COST_DEPT_AREA a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND EXISTS (SELECT 1
                FROM cost_para_server_dept_share t1
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.dept_id = t1.dept_id)
       GROUP BY group_id, hos_id, copy_code, dept_id;
  
    RETURN;
  END prc_server_para_value_02;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value_03
  || 功能描述 ：按照分摊类别统计分摊参数 工作量
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_server_para_value_03(prm_group_id  IN NUMBER --集团
                                    ,
                                     prm_hos_id    IN NUMBER --医院
                                    ,
                                     prm_copy_code IN VARCHAR2 --账套
                                    ,
                                     prm_acc_year  IN VARCHAR2 --年度
                                    ,
                                     prm_acc_month IN VARCHAR2 --月份
                                     ) IS
  
  BEGIN
  
    --工作量 门诊  住院
    DELETE FROM cost_para_value_data
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code
       AND para_value like  '03%';
  
    INSERT INTO cost_para_value_data
      (group_id,
       hos_id,
       copy_code,
       dept_id,
       server_dept_id,
       para_value,
       para_amount)
    
      SELECT group_id,
             hos_id,
             copy_code,
             dept_id,
             dept_id server_dept_id,
             '030101' para_code,
             SUM(nvl(clinic_num, 0)) num_amount
        FROM COST_CLINIC_WORK a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND EXISTS (SELECT 1
                FROM cost_para_server_dept_share t1
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.dept_id = t1.dept_id)
       GROUP BY group_id, hos_id, copy_code, dept_id
       UNION ALL
      SELECT group_id,
             hos_id,
             copy_code,
             dept_id,
             dept_id server_dept_id,
             '030102' para_code,
             SUM(nvl(a.operation_num, 0)) num_amount
        FROM COST_CLINIC_WORK a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND EXISTS (SELECT 1
                FROM cost_para_server_dept_share t1
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.dept_id = t1.dept_id)
       GROUP BY group_id, hos_id, copy_code, dept_id
      UNION ALL
      SELECT group_id,
             hos_id,
             copy_code,
             dept_id,
             dept_id server_dept_id,
             '030201' para_code,
             SUM(nvl(IN_HOS_NUM, 0)) num_amount
        FROM COST_INHOS_WORK a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND EXISTS (SELECT 1
                FROM cost_para_server_dept_share t1
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.dept_id = t1.dept_id)
       GROUP BY group_id, hos_id, copy_code, dept_id
        UNION ALL
      SELECT group_id,
             hos_id,
             copy_code,
             dept_id,
             dept_id server_dept_id,
             '030202' para_code,
             SUM(nvl(OUT_HOS_NUM, 0)) num_amount
        FROM COST_INHOS_WORK a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND EXISTS (SELECT 1
                FROM cost_para_server_dept_share t1
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.dept_id = t1.dept_id)
       GROUP BY group_id, hos_id, copy_code, dept_id
        UNION ALL
      SELECT group_id,
             hos_id,
             copy_code,
             dept_id,
             dept_id server_dept_id,
             '030203' para_code,
             SUM(nvl(SET_BED_NUM, 0)) num_amount
        FROM COST_INHOS_WORK a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND EXISTS (SELECT 1
                FROM cost_para_server_dept_share t1
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.dept_id = t1.dept_id)
       GROUP BY group_id, hos_id, copy_code, dept_id
        UNION ALL
      SELECT group_id,
             hos_id,
             copy_code,
             dept_id,
             dept_id server_dept_id,
             '030204' para_code,
             SUM(nvl(OPEN_BED_NUM, 0)) num_amount
        FROM COST_INHOS_WORK a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND EXISTS (SELECT 1
                FROM cost_para_server_dept_share t1
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.dept_id = t1.dept_id)
       GROUP BY group_id, hos_id, copy_code, dept_id
        UNION ALL
      SELECT group_id,
             hos_id,
             copy_code,
             dept_id,
             dept_id server_dept_id,
             '030205' para_code,
             SUM(nvl(BED_USE_RATE, 0)) num_amount
        FROM COST_INHOS_WORK a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND EXISTS (SELECT 1
                FROM cost_para_server_dept_share t1
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.dept_id = t1.dept_id)
       GROUP BY group_id, hos_id, copy_code, dept_id
        UNION ALL
      SELECT group_id,
             hos_id,
             copy_code,
             dept_id,
             dept_id server_dept_id,
             '030206' para_code,
             SUM(nvl(BED_USE_DAY_NUM, 0)) num_amount
        FROM COST_INHOS_WORK a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND EXISTS (SELECT 1
                FROM cost_para_server_dept_share t1
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.dept_id = t1.dept_id)
       GROUP BY group_id, hos_id, copy_code, dept_id
        UNION ALL
      SELECT group_id,
             hos_id,
             copy_code,
             dept_id,
             dept_id server_dept_id,
             '030207' para_code,
             SUM(nvl(BED_OUT_DAY_NUM, 0)) num_amount
        FROM COST_INHOS_WORK a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND EXISTS (SELECT 1
                FROM cost_para_server_dept_share t1
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.dept_id = t1.dept_id)
       GROUP BY group_id, hos_id, copy_code, dept_id
       UNION ALL
      SELECT group_id,
             hos_id,
             copy_code,
             dept_id,
             dept_id server_dept_id,
             '030301' para_code,
             SUM(nvl(medical_num, 0)) num_amount
        FROM cost_medical_technology_work a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND EXISTS (SELECT 1
                FROM cost_para_server_dept_share t1
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.dept_id = t1.dept_id)
       GROUP BY group_id, hos_id, copy_code, dept_id
       UNION ALL
      SELECT group_id,
             hos_id,
             copy_code,
             dept_id,
             dept_id server_dept_id,
             '030401' para_code,
             SUM(nvl(doctor_num, 0)) num_amount
        FROM cost_doctor_work a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND EXISTS (SELECT 1
                FROM cost_para_server_dept_share t1
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.dept_id = t1.dept_id)
       GROUP BY group_id, hos_id, copy_code, dept_id;
    RETURN;
  END prc_server_para_value_03;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value_04
  || 功能描述 ：按照分摊类别统计分摊参数 工时
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  /* PROCEDURE prc_server_para_value_04(prm_group_id  IN NUMBER --集团
                                    ,prm_hos_id    IN NUMBER --医院
                                    ,prm_copy_code IN VARCHAR2 --账套
                                    ,prm_acc_year  IN VARCHAR2 --年度
                                    ,prm_acc_month IN VARCHAR2 --月份
                                     ) IS
  
  BEGIN
    RETURN;
  END prc_server_para_value_04;*/
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value_05
  || 功能描述 ：按照分摊类别统计分摊参数 服务量
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_server_para_value_05(prm_group_id  IN NUMBER --集团
                                    ,
                                     prm_hos_id    IN NUMBER --医院
                                    ,
                                     prm_copy_code IN VARCHAR2 --账套
                                    ,
                                     prm_acc_year  IN VARCHAR2 --年度
                                    ,
                                     prm_acc_month IN VARCHAR2 --月份
                                     ) IS
  
  BEGIN
    --服务量
    DELETE FROM cost_para_value_data
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code
       AND para_value = '05';
  
    INSERT INTO cost_para_value_data
      (group_id,
       hos_id,
       copy_code,
       dept_id,
       server_dept_id,
       para_value,
       para_amount)
      SELECT group_id,
             hos_id,
             copy_code,
             server_dept_id dept_id,
             server_by_dept_id server_dept_id,
             '05' para_code,
             SUM(nvl(server_num, 0)) num_amount
        FROM cost_inner_server a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND EXISTS (SELECT 1
                FROM cost_para_server_dept_share t1
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.server_by_dept_id = t1.dept_id)
       GROUP BY group_id,
                hos_id,
                copy_code,
                server_dept_id,
                server_by_dept_id;
    RETURN;
  END prc_server_para_value_05;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value_06
  || 功能描述 ：按照分摊类别统计分摊参数  收入
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_server_para_value_06(prm_group_id  IN NUMBER --集团
                                    ,
                                     prm_hos_id    IN NUMBER --医院
                                    ,
                                     prm_copy_code IN VARCHAR2 --账套
                                    ,
                                     prm_acc_year  IN VARCHAR2 --年度
                                    ,
                                     prm_acc_month IN VARCHAR2 --月份
                                     ) IS
  
  BEGIN
    --收入 不包含药品收入     
    DELETE FROM cost_para_value_data
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code
       AND para_value = '06';
  
    INSERT INTO cost_para_value_data
      (group_id,
       hos_id,
       copy_code,
       dept_id,
       server_dept_id,
       para_value,
       para_amount)
    
      SELECT group_id,
             hos_id,
             copy_code,
             exec_dept_id dept_id,
             appl_dept_id server_dept_id,
             '06' para_code,
             SUM(nvl(money, 0)) num_amount
        FROM cost_income a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND EXISTS
       (SELECT 1
                FROM cost_para_server_dept_share t1
               INNER JOIN acc_dept_attr c
                  ON t1.group_id = c.group_id
                 AND t1.hos_id = c.hos_id
                 AND t1.dept_id = c.dept_id
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.appl_dept_id = t1.dept_id
                 AND c.natur_code NOT IN ('03', '04', '05'))
       GROUP BY group_id, hos_id, copy_code, exec_dept_id, appl_dept_id;
  
    --药品收入        
    INSERT INTO cost_para_value_data
      (group_id,
       hos_id,
       copy_code,
       dept_id,
       server_dept_id,
       para_value,
       para_amount)
      SELECT a.group_id,
             a.hos_id,
             a.copy_code,
             a.exec_dept_id dept_id,
             a.appl_dept_id server_dept_id,
             '06' para_code,
             SUM(nvl(money, 0)) num_amount
        FROM cost_income a
       WHERE a.group_id = prm_group_id
         AND a.hos_id = prm_hos_id
         AND a.copy_code = prm_copy_code
         AND a.acc_year = prm_acc_year
         AND a.acc_month = prm_acc_month
         AND EXISTS (SELECT 1
                FROM cost_para_server_dept_share t1
               INNER JOIN acc_dept_attr c
                  ON t1.group_id = c.group_id
                 AND t1.hos_id = c.hos_id
                 AND t1.dept_id = c.dept_id
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.appl_dept_id = t1.dept_id
                 AND c.natur_code IN ('04', '05'))
       GROUP BY group_id, hos_id, copy_code, exec_dept_id, appl_dept_id;
  
    RETURN;
  END prc_server_para_value_06;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_server_para_value_custom
  || 功能描述 ：按照分摊类别统计分摊参数 自定义部分
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_server_para_value_custom(prm_group_id  IN NUMBER --集团
                                        ,
                                         prm_hos_id    IN NUMBER --医院
                                        ,
                                         prm_copy_code IN VARCHAR2 --账套
                                        ,
                                         prm_acc_year  IN VARCHAR2 --年度
                                        ,
                                         prm_acc_month IN VARCHAR2 --月份
                                         ) IS
  
  BEGIN
    --自定义 参数
    DELETE FROM cost_para_value_data
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code
       AND para_value NOT IN ('01', '02', '03', '04', '05', '06');
  
    INSERT INTO cost_para_value_data
      (group_id,
       hos_id,
       copy_code,
       dept_id,
       server_dept_id,
       para_value,
       para_amount)
    
      SELECT group_id,
             hos_id,
             copy_code,
             dept_id,
             dept_id server_dept_id,
             para_code,
             SUM(nvl(para_value, 0)) num_amount
        FROM COST_USER_DEFINED_PARA a
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND para_value != 0
         AND EXISTS
       (SELECT 1
                FROM cost_para_server_dept_share t1
               WHERE a.group_id = t1.group_id
                 AND a.hos_id = t1.hos_id
                 AND a.copy_code = t1.copy_code
                 AND a.dept_id = t1.dept_id)
         AND a.para_code NOT IN ('01', '02', '03', '04', '05', '06')
      
       GROUP BY group_id, hos_id, copy_code, dept_id, para_code;
  
    RETURN;
  END prc_server_para_value_custom;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_add_process
  || 功能描述 ：加载分摊过程数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_add_process(PRM_GROUP_ID                 IN NUMBER --集团
                           ,
                            PRM_HOS_ID                   IN NUMBER --医院
                           ,
                            PRM_COPY_CODE                IN VARCHAR2 --账套
                           ,
                            PRM_ACC_YEAR                 IN VARCHAR2 --年度
                           ,
                            PRM_ACC_MONTH                IN VARCHAR2 --月份
                           ,
                            PRM_DEPT_ID                  IN NUMBER --服务科室
                           ,
                            PRM_SERVER_DEPT_ID           IN NUMBER --受益科室
                           ,
                            PRM_COST_ITEM_ID             IN NUMBER --成本项目
                           ,
                            PRM_SOURCE_ID                IN NUMBER --资金来源
                           ,
                            PRM_DIR_AMOUNT               IN NUMBER --直接成本
                           ,
                            PRM_DIR_MAN_AMOUNT           IN NUMBER --分摊管理成本
                           ,
                            PRM_DIR_ASS_AMOUNT           IN NUMBER --直接分摊医辅成本
                           ,
                            PRM_DIR_MED_AMOUNT           IN NUMBER --直接分摊医技成本
                           ,
                            PRM_INDIR_ASS_MAN_AMOUNT     IN NUMBER --间接分摊医辅管理成本
                           ,
                            PRM_INDIR_MED_MAN_AMOUNT     IN NUMBER --间接分摊医技管理成本
                           ,
                            PRM_INDIR_ASS_MED_MAN_AMOUNT IN NUMBER --间接分摊医辅医技管理成本
                           ,
                            PRM_INDIR_MED_ASS_AMOUNT     IN NUMBER --间接分摊医辅医技成本
                            
                            ) IS
  
  BEGIN
    --构建分摊过程明细表 记录分摊过程
  
    insert into cost_allocation_process
      (GROUP_ID,
       HOS_ID,
       COPY_CODE,
       ACC_YEAR,
       ACC_MONTH,
       DEPT_ID,
       SERVER_DEPT_ID,
       COST_ITEM_ID,
       SOURCE_ID,
       DIR_AMOUNT,
       DIR_MAN_AMOUNT,
       DIR_ASS_AMOUNT,
       DIR_MED_AMOUNT,
       INDIR_ASS_MAN_AMOUNT,
       INDIR_MED_MAN_AMOUNT,
       INDIR_ASS_MED_MAN_AMOUNT,
       INDIR_MED_ASS_AMOUNT)
      SELECT PRM_GROUP_ID,
             PRM_HOS_ID,
             PRM_COPY_CODE,
             PRM_ACC_YEAR,
             PRM_ACC_MONTH,
             PRM_DEPT_ID,
             PRM_SERVER_DEPT_ID,
             PRM_COST_ITEM_ID,
             PRM_SOURCE_ID,
             PRM_DIR_AMOUNT,
             PRM_DIR_MAN_AMOUNT,
             PRM_DIR_ASS_AMOUNT,
             PRM_DIR_MED_AMOUNT,
             PRM_INDIR_ASS_MAN_AMOUNT,
             PRM_INDIR_MED_MAN_AMOUNT,
             PRM_INDIR_ASS_MED_MAN_AMOUNT,
             PRM_INDIR_MED_ASS_AMOUNT
        FROM dual;
  
  end prc_add_process;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_type_para_load
  || 功能描述 ：构建分摊性质和分摊类型对应的访问当量总和
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_type_para_load(prm_group_id  IN NUMBER --集团
                                   ,
                                    prm_hos_id    IN NUMBER --医院
                                   ,
                                    prm_copy_code IN VARCHAR2 --账套
                                    ) IS
  BEGIN
  
    delete from COST_DEPT_DIR_CHECK_SHARE
     where group_id = prm_group_id
       and hos_id = prm_hos_id
       and copy_code = prm_copy_code;
    delete from COST_DEPT_EMP_CHECK_SHARE
     where group_id = prm_group_id
       and hos_id = prm_hos_id
       and copy_code = prm_copy_code;
  
    --管理
    insert into COST_DEPT_DIR_CHECK_SHARE
      (GROUP_ID,
       HOS_ID,
       COPY_CODE,
       DEPT_ID,
       PARA_TYPE_CODE,
       TYPE_CODE,
       PARA_CODE,
       PARA_VALUE,
       PARA_AMOUNT)
      SELECT t.group_id,
             t.hos_id,
             t.copy_code,
             t.dept_id,
             t.para_type_code,
             t.type_code,
             t.para_code,
             t.para_value,
             SUM(nvl(t4.para_amount, 0)) para_amount
        FROM (SELECT t.group_id,
                     t.hos_id,
                     t.copy_code,
                     t.dept_id,
                     t1.dept_id server_dept_id,
                     t.type_code,
                     t.para_code,
                     t3.para_type_code,
                     t3.para_value
                FROM cost_para_dept_share t
                LEFT JOIN cost_para_server_dept_share t1
                  ON t1.group_id = t.group_id
                 AND t1.hos_id = t.hos_id
                 AND t1.copy_code = t.copy_code
                 AND t1.bill_code = t.bill_code
                LEFT JOIN cost_para_set_share t3
                  ON t3.group_id = t.group_id
                 AND t3.hos_id = t.hos_id
                 AND t3.copy_code = t.copy_code
                 AND t3.para_code = t.para_code
               WHERE t.type_code = '04'
                 AND t3.bill_type = '01'
              
              ) t
        LEFT JOIN cost_para_value_data t4
          ON t4.group_id = t.group_id
         AND t4.hos_id = t.hos_id
         AND t4.copy_code = t.copy_code
         AND t4.server_dept_id = t.server_dept_id
         AND t4.dept_id = t4.server_dept_id
         AND t4.para_value = t.para_value
       WHERE t.group_id = prm_group_id
         AND t.hos_id = prm_hos_id
         AND t.copy_code = prm_copy_code
       GROUP BY t.group_id,
                t.hos_id,
                t.copy_code,
                t.dept_id,
                t.para_type_code,
                t.type_code,
                t.para_code,
                t.para_value;
  
    --医疗辅助
    insert into COST_DEPT_DIR_CHECK_SHARE
      (GROUP_ID,
       HOS_ID,
       COPY_CODE,
       DEPT_ID,
       PARA_TYPE_CODE,
       TYPE_CODE,
       PARA_CODE,
       PARA_VALUE,
       PARA_AMOUNT)
      SELECT t.group_id,
             t.hos_id,
             t.copy_code,
             t.dept_id,
             t.para_type_code,
             t.type_code,
             t.para_code,
             t.para_value,
             SUM(nvl(t4.para_amount, 0)) para_amount
        FROM (SELECT t.group_id,
                     t.hos_id,
                     t.copy_code,
                     t.dept_id,
                     t1.dept_id server_dept_id,
                     t.type_code,
                     t.para_code,
                     t3.para_type_code,
                     t3.para_value
                FROM cost_para_dept_share t
                LEFT JOIN cost_para_server_dept_share t1
                  ON t1.group_id = t.group_id
                 AND t1.hos_id = t.hos_id
                 AND t1.copy_code = t.copy_code
                 AND t1.bill_code = t.bill_code
                LEFT JOIN cost_para_set_share t3
                  ON t3.group_id = t.group_id
                 AND t3.hos_id = t.hos_id
                 AND t3.copy_code = t.copy_code
                 AND t3.para_code = t.para_code
               WHERE t.type_code = '03'
                 AND t3.bill_type = '02'
              
              ) t
        LEFT JOIN cost_para_value_data t4
          ON t4.group_id = t.group_id
         AND t4.hos_id = t.hos_id
         AND t4.copy_code = t.copy_code
         AND t4.server_dept_id = t.server_dept_id
         AND t4.dept_id = t4.server_dept_id
         AND t4.para_value = t.para_value
       WHERE t.group_id = prm_group_id
         AND t.hos_id = prm_hos_id
         AND t.copy_code = prm_copy_code
       GROUP BY t.group_id,
                t.hos_id,
                t.copy_code,
                t.dept_id,
                t.para_type_code,
                t.type_code,
                t.para_code,
                t.para_value;
    --医技
    insert into COST_DEPT_DIR_CHECK_SHARE
      (GROUP_ID,
       HOS_ID,
       COPY_CODE,
       DEPT_ID,
       PARA_TYPE_CODE,
       TYPE_CODE,
       PARA_CODE,
       PARA_VALUE,
       PARA_AMOUNT)
      SELECT t.group_id,
             t.hos_id,
             t.copy_code,
             t.dept_id,
             t.para_type_code,
             t.type_code,
             t.para_code,
             
             t.para_value,
             SUM(nvl(t4.para_amount, 0)) para_amount
        FROM (SELECT t.group_id,
                     t.hos_id,
                     t.copy_code,
                     t.dept_id,
                     t1.dept_id server_dept_id,
                     t.type_code,
                     t.para_code,
                     t3.para_type_code,
                     t3.para_value
                FROM cost_para_dept_share t
                LEFT JOIN cost_para_server_dept_share t1
                  ON t1.group_id = t.group_id
                 AND t1.hos_id = t.hos_id
                 AND t1.copy_code = t.copy_code
                 AND t1.bill_code = t.bill_code
                LEFT JOIN cost_para_set_share t3
                  ON t3.group_id = t.group_id
                 AND t3.hos_id = t.hos_id
                 AND t3.copy_code = t.copy_code
                 AND t3.para_code = t.para_code
               WHERE t.type_code = '02'
                 AND t3.bill_type = '03'
              
              ) t
        LEFT JOIN cost_para_value_data t4
          ON t4.group_id = t.group_id
         AND t4.hos_id = t.hos_id
         AND t4.copy_code = t.copy_code
         AND t4.server_dept_id = t.server_dept_id
         AND t4.para_value = t.para_value
       WHERE t.group_id = prm_group_id
         AND t.hos_id = prm_hos_id
         AND t.copy_code = prm_copy_code
         AND t4.dept_id = t4.server_dept_id
         AND t.para_value NOT IN ('05', '06')
       GROUP BY t.group_id,
                t.hos_id,
                t.copy_code,
                t.dept_id,
                t.para_type_code,
                t.type_code,
                t.para_code,
                t.para_value
      
      UNION ALL
      SELECT t.group_id,
             t.hos_id,
             t.copy_code,
             t.dept_id,
             t.para_type_code,
             t.type_code,
             t.para_code,
             t.para_value,
             SUM(nvl(t4.para_amount, 0)) para_amount
        FROM (SELECT t.group_id,
                     t.hos_id,
                     t.copy_code,
                     t.dept_id,
                     t1.dept_id server_dept_id,
                     t.type_code,
                     t.para_code,
                     t3.para_type_code,
                     t3.para_value
                FROM cost_para_dept_share t
                LEFT JOIN cost_para_server_dept_share t1
                  ON t1.group_id = t.group_id
                 AND t1.hos_id = t.hos_id
                 AND t1.copy_code = t.copy_code
                 AND t1.bill_code = t.bill_code
                LEFT JOIN cost_para_set_share t3
                  ON t3.group_id = t.group_id
                 AND t3.hos_id = t.hos_id
                 AND t3.copy_code = t.copy_code
                 AND t3.para_code = t.para_code
               WHERE t.type_code = '02'
                 AND t3.bill_type = '03'
              
              ) t
        LEFT JOIN cost_para_value_data t4
          ON t4.group_id = t.group_id
         AND t4.hos_id = t.hos_id
         AND t4.copy_code = t.copy_code
         AND t4.dept_id = t.dept_id
         AND t4.server_dept_id = t.server_dept_id
         AND t4.para_value = t.para_value
       WHERE t.para_value IN ('05', '06')
       GROUP BY t.group_id,
                t.hos_id,
                t.copy_code,
                t.dept_id,
                t.para_type_code,
                t.type_code,
                t.para_code,
                t.para_value;
    --默认按人员统计总数
    insert into COST_DEPT_EMP_CHECK_SHARE
      (GROUP_ID,
       HOS_ID,
       COPY_CODE,
       DEPT_ID,
       PARA_TYPE_CODE,
       TYPE_CODE,
       PARA_CODE,
       PARA_VALUE,
       PARA_AMOUNT)
      SELECT t.group_id,
             t.hos_id,
             t.copy_code,
             t.dept_id,
             t.para_type_code,
             t.type_code,
             t.para_code,
             t.para_value,
             SUM(nvl(t4.para_amount, 0)) para_amount
        FROM (SELECT distinct t.group_id,
                              t.hos_id,
                              t.copy_code,
                              t.dept_id,
                              t1.dept_id server_dept_id,
                              t.type_code,
                              t.para_code,
                              t3.para_type_code,
                              '01' para_value
                FROM cost_para_dept_share t
                LEFT JOIN cost_para_server_dept_share t1
                  ON t1.group_id = t.group_id
                 AND t1.hos_id = t.hos_id
                 AND t1.copy_code = t.copy_code
                 AND t1.bill_code = t.bill_code
                LEFT JOIN cost_para_set_share t3
                  ON t3.group_id = t.group_id
                 AND t3.hos_id = t.hos_id
                 AND t3.copy_code = t.copy_code
                 AND t3.para_code = t.para_code) t
        LEFT JOIN cost_para_value_data t4
          ON t4.group_id = t.group_id
         AND t4.hos_id = t.hos_id
         AND t4.copy_code = t.copy_code
         AND t4.server_dept_id = t.server_dept_id
         AND t4.para_value = t.para_value
       WHERE t.group_id = prm_group_id
         AND t.hos_id = prm_hos_id
         AND t.copy_code = prm_copy_code
         AND t4.dept_id = t4.server_dept_id
         AND t.para_value = '01'
       GROUP BY t.group_id,
                t.hos_id,
                t.copy_code,
                t.dept_id,
                t.type_code,
                t.para_type_code,
                t.para_code,
                t.para_value;
  END prc_cost_type_para_load;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_save_man
  || 功能描述 ：更新分摊结果
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团                  IN           NUMBER
  ||            prm_hos_id          医院                  IN           NUMBER
  ||            prm_copy_code       账套                  IN           VARCHAR2
  ||            prm_acc_year        年度                  IN           VARCHAR2
  ||            prm_acc_month       月份                  IN           VARCHAR2
  ||            prm_dept_id         服务科室ID            IN           NUMBER
  ||            prm_dept_no         服务科室NO            IN           NUMBER
  ||            prm_cost_item_id    成本项目ID            IN           NUMBER
  ||            prm_cost_item_no    成本项目NO            IN           NUMBER
  ||            prm_source_id      资金来源ID             IN           NUMBER
  ||            prm_dir_amount      服务科室直接成本       IN           NUMBER
  ||            prm_sum_amount      服务科室当量总和       IN           NUMBER
  ||            prm_para_value      分摊参数               IN           VARCHAR2
  ||            prm_bill_code       科室对应关系单据编号    IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_save_man(prm_group_id     IN NUMBER --集团
                             ,
                              prm_hos_id       IN NUMBER --医院
                             ,
                              prm_copy_code    IN VARCHAR2 --账套
                             ,
                              prm_acc_year     IN VARCHAR2 --年度
                             ,
                              prm_acc_month    IN VARCHAR2 --月份
                             ,
                              prm_dept_id      IN NUMBER --服务科室ID
                             ,
                              prm_cost_item_id IN NUMBER --成本项目ID
                             ,
                              prm_source_id    IN NUMBER --资金来源NO
                             ,
                              prm_dir_amount   IN NUMBER --服务科室直接成本
                             ,
                              prm_sum_amount   IN NUMBER --服务科室当量总和
                             ,
                              prm_para_value   IN VARCHAR2 --分摊参数
                             ,
                              prm_bill_code    IN NUMBER --科室对应关系单据编号
                              ) IS
  BEGIN
  
    --采用游标的方式 批量更新 效率会高一些
    DECLARE
      CURSOR man_job IS
      
        SELECT t1.dept_id,
               divide(SUM(nvl(t2.para_amount, 0)) * prm_dir_amount,
                      prm_sum_amount) para_amount
          FROM cost_para_server_dept_share t1
          LEFT JOIN cost_para_value_data t2
            ON t1.group_id = t2.group_id
           AND t1.hos_id = t2.hos_id
           AND t1.copy_code = t2.copy_code
           AND t1.dept_id = t2.dept_id
         inner join cost_para_dept_share t3
            on t1.group_id = t3.group_id
           and t1.hos_id = t3.hos_id
           and t1.copy_code = t3.copy_code
           and t1.bill_code = t3.bill_code
         WHERE t2.para_value = prm_para_value
           AND t1.bill_code = prm_bill_code
           AND t2.dept_id = t2.server_dept_id
           and t3.dept_id = prm_dept_id
           and t1.group_id = prm_group_id
           AND t1.hos_id = prm_hos_id
           AND t1.copy_code = prm_copy_code
         GROUP BY t1.dept_id;
    
      man_row man_job%ROWTYPE;
      v_count INTEGER;
    BEGIN
    
      FOR man_row IN man_job LOOP
      
        v_count := 0;
      
        SELECT COUNT(*)
          INTO v_count
          FROM cost_dept_cost
         WHERE group_id = prm_group_id
           AND hos_id = prm_hos_id
           AND copy_code = prm_copy_code
           AND cost_item_id = prm_cost_item_id
           AND source_id = prm_source_id
           AND dept_id = man_row.dept_id
           AND acc_year = prm_acc_year
           AND acc_month = prm_acc_month;
      
        IF (v_count > 0) THEN
          UPDATE cost_dept_cost
             SET dir_man_amount = nvl(dir_man_amount, 0) +
                                  man_row.para_amount
           WHERE group_id = prm_group_id
             AND hos_id = prm_hos_id
             AND copy_code = prm_copy_code
             AND cost_item_id = prm_cost_item_id
             AND source_id = prm_source_id
             AND dept_id = man_row.dept_id
             AND acc_year = prm_acc_year
             AND acc_month = prm_acc_month;
        ELSE
          INSERT INTO cost_dept_cost
            (group_id --集团ID
            ,
             hos_id --医院ID
            ,
             copy_code --账套编码
            ,
             acc_year --统计年份
            ,
             acc_month --统计月份
            ,
             dept_id --科室ID
            ,
             cost_item_id --成本项目ID
            ,
             source_id --资金来源
            ,
             dir_amount --直接成本
            ,
             dir_man_amount --分摊管理直接成本
            ,
             dir_ass_amount --分摊医辅直接成本
            ,
             dir_med_amount --分摊医技直接成本
            ,
             indir_ass_man_amount --间接分摊医辅管理成本
            ,
             indir_med_man_amount --间接分摊医技管理成本
            ,
             indir_ass_med_man_amount --间接分摊医技医辅管理成本
            ,
             indir_med_ass_amount --间接分摊医技医辅成本
             )
          
            SELECT prm_group_id,
                   prm_hos_id,
                   prm_copy_code,
                   prm_acc_year,
                   prm_acc_month,
                   man_row.dept_id,
                   prm_cost_item_id,
                   prm_source_id,
                   0,
                   man_row.para_amount,
                   0,
                   0,
                   0,
                   0,
                   0,
                   0
              FROM dual;
        END IF;
        --添加分摊过程数据
        prc_add_process(PRM_GROUP_ID,
                        PRM_HOS_ID,
                        PRM_COPY_CODE,
                        PRM_ACC_YEAR,
                        PRM_ACC_MONTH,
                        PRM_DEPT_ID,
                        man_row.dept_id,
                        PRM_COST_ITEM_ID,
                        PRM_SOURCE_ID,
                        PRM_DIR_AMOUNT,
                        man_row.para_amount,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0);
      
      END LOOP;
    
    END;
  
    RETURN;
  
  END prc_cost_save_man;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_save_ass
  || 功能描述 ：更新分摊结果
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团                  IN           NUMBER
  ||            prm_hos_id          医院                  IN           NUMBER
  ||            prm_copy_code       账套                  IN           VARCHAR2
  ||            prm_acc_year        年度                  IN           VARCHAR2
  ||            prm_acc_month       月份                  IN           VARCHAR2
  ||            prm_dept_id         服务科室ID            IN           NUMBER
  ||            prm_dept_no         服务科室NO            IN           NUMBER
  ||            prm_cost_item_id    成本项目ID            IN           NUMBER
  ||            prm_cost_item_no    成本项目NO            IN           NUMBER
  ||            prm_source_id      资金来源ID             IN           NUMBER
  ||            prm_dir_amount      服务科室直接成本       IN           NUMBER
  ||            prm_sum_amount      服务科室当量总和       IN           NUMBER
  ||            prm_para_value      分摊参数               IN           VARCHAR2
  ||            prm_bill_code       科室对应关系单据编号    IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_save_ass(prm_group_id             IN NUMBER --集团
                             ,
                              prm_hos_id               IN NUMBER --医院
                             ,
                              prm_copy_code            IN VARCHAR2 --账套
                             ,
                              prm_acc_year             IN VARCHAR2 --年度
                             ,
                              prm_acc_month            IN VARCHAR2 --月份
                             ,
                              prm_dept_id              IN NUMBER --服务科室ID
                             ,
                              prm_cost_item_id         IN NUMBER --成本项目ID
                             ,
                              prm_source_id            IN NUMBER --资金来源NO
                             ,
                              prm_dir_amount           IN NUMBER --服务科室直接成本
                             ,
                              prm_sum_amount           IN NUMBER --服务科室当量总和
                             ,
                              prm_para_value           IN VARCHAR2 --分摊参数
                             ,
                              prm_bill_code            IN NUMBER --科室对应关系单据编号
                             ,
                              prm_indir_ass_man_amount IN NUMBER --间接分摊医辅管理成本
                              ) IS
  
  BEGIN
  
    --采用游标的方式 批量更新 效率会高一些
    DECLARE
      CURSOR man_job IS
      
        SELECT t1.dept_id,
               divide(SUM(nvl(t2.para_amount, 0)) * prm_dir_amount,
                      prm_sum_amount) para_amount,
               divide(SUM(nvl(t2.para_amount, 0)) *
                      prm_indir_ass_man_amount,
                      prm_sum_amount) para_amount_indir
          FROM cost_para_server_dept_share t1
          LEFT JOIN cost_para_value_data t2
            ON t1.group_id = t2.group_id
           AND t1.hos_id = t2.hos_id
           AND t1.copy_code = t2.copy_code
           AND t1.dept_id = t2.dept_id
         inner join cost_para_dept_share t3
            on t1.group_id = t3.group_id
           and t1.hos_id = t3.hos_id
           and t1.copy_code = t3.copy_code
           and t1.bill_code = t3.bill_code
         WHERE t2.para_value = prm_para_value
           AND t1.bill_code = prm_bill_code
           AND t2.dept_id = t2.server_dept_id
           and t3.dept_id = prm_dept_id
           and t1.group_id = prm_group_id
           AND t1.hos_id = prm_hos_id
           AND t1.copy_code = prm_copy_code
         GROUP BY t1.dept_id;
    
      man_row man_job%ROWTYPE;
      v_count INTEGER;
    BEGIN
    
      FOR man_row IN man_job LOOP
      
        v_count := 0;
      
        SELECT COUNT(*)
          INTO v_count
          FROM cost_dept_cost
         WHERE group_id = prm_group_id
           AND hos_id = prm_hos_id
           AND copy_code = prm_copy_code
           AND cost_item_id = prm_cost_item_id
           AND source_id = prm_source_id
           AND dept_id = man_row.dept_id
           AND acc_year = prm_acc_year
           AND acc_month = prm_acc_month;
      
        IF (v_count > 0) THEN
          UPDATE cost_dept_cost
             SET dir_ass_amount       = nvl(dir_ass_amount, 0) +
                                        man_row.para_amount,
                 indir_ass_man_amount = nvl(indir_ass_man_amount, 0) +
                                        man_row.para_amount_indir
          
           WHERE group_id = prm_group_id
             AND hos_id = prm_hos_id
             AND copy_code = prm_copy_code
             AND cost_item_id = prm_cost_item_id
             AND source_id = prm_source_id
             AND dept_id = man_row.dept_id
             AND acc_year = prm_acc_year
             AND acc_month = prm_acc_month;
        ELSE
          INSERT INTO cost_dept_cost
            (group_id --集团ID
            ,
             hos_id --医院ID
            ,
             copy_code --账套编码
            ,
             acc_year --统计年份
            ,
             acc_month --统计月份
            ,
             dept_id --科室ID
            ,
             cost_item_id --成本项目ID
            ,
             source_id --资金来源
            ,
             dir_amount --直接成本
            ,
             dir_man_amount --分摊管理直接成本
            ,
             dir_ass_amount --分摊医辅直接成本
            ,
             dir_med_amount --分摊医技直接成本
            ,
             indir_ass_man_amount --间接分摊医辅管理成本
            ,
             indir_med_man_amount --间接分摊医技管理成本
            ,
             indir_ass_med_man_amount --间接分摊医技医辅管理成本
            ,
             indir_med_ass_amount --间接分摊医技医辅成本
             )
          
            SELECT prm_group_id,
                   prm_hos_id,
                   prm_copy_code,
                   prm_acc_year,
                   prm_acc_month,
                   man_row.dept_id,
                   prm_cost_item_id,
                   prm_source_id,
                   0,
                   0,
                   man_row.para_amount,
                   0,
                   man_row.para_amount_indir,
                   0,
                   0,
                   0
              FROM dual;
        END IF;
        --添加分摊过程数据
        prc_add_process(PRM_GROUP_ID,
                        PRM_HOS_ID,
                        PRM_COPY_CODE,
                        PRM_ACC_YEAR,
                        PRM_ACC_MONTH,
                        PRM_DEPT_ID,
                        man_row.dept_id,
                        PRM_COST_ITEM_ID,
                        PRM_SOURCE_ID,
                        PRM_DIR_AMOUNT,
                        0,
                        man_row.para_amount,
                        0,
                        man_row.para_amount_indir,
                        0,
                        0,
                        0);
      END LOOP;
    END;
  
    RETURN;
  
  END prc_cost_save_ass;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_save_med
  || 功能描述 ：更新分摊结果
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团                  IN           NUMBER
  ||            prm_hos_id          医院                  IN           NUMBER
  ||            prm_copy_code       账套                  IN           VARCHAR2
  ||            prm_acc_year        年度                  IN           VARCHAR2
  ||            prm_acc_month       月份                  IN           VARCHAR2
  ||            prm_dept_id         服务科室ID            IN           NUMBER
  ||            prm_dept_no         服务科室NO            IN           NUMBER
  ||            prm_cost_item_id    成本项目ID            IN           NUMBER
  ||            prm_cost_item_no    成本项目NO            IN           NUMBER
  ||            prm_source_id      资金来源ID             IN           NUMBER
  ||            prm_dir_amount      服务科室直接成本       IN           NUMBER
  ||            prm_sum_amount      服务科室当量总和       IN           NUMBER
  ||            prm_para_value      分摊参数               IN           VARCHAR2
  ||            prm_bill_code       科室对应关系单据编号    IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_save_med(prm_group_id                 IN NUMBER --集团
                             ,
                              prm_hos_id                   IN NUMBER --医院
                             ,
                              prm_copy_code                IN VARCHAR2 --账套
                             ,
                              prm_acc_year                 IN VARCHAR2 --年度
                             ,
                              prm_acc_month                IN VARCHAR2 --月份
                             ,
                              prm_dept_id                  IN NUMBER --服务科室ID
                             ,
                              prm_cost_item_id             IN NUMBER --成本项目ID
                             ,
                              prm_source_id                IN NUMBER --资金来源NO
                             ,
                              prm_dir_amount               IN NUMBER --服务科室直接成本
                             ,
                              prm_sum_amount               IN NUMBER --服务科室当量总和
                             ,
                              prm_para_value               IN VARCHAR2 --分摊参数
                             ,
                              prm_bill_code                IN NUMBER --科室对应关系单据编号
                             ,
                              prm_indir_med_man_amount     IN NUMBER --
                             ,
                              prm_indir_med_ass_amount     IN NUMBER,
                              prm_indir_ass_med_man_amount IN NUMBER) IS
  
  BEGIN
  
    IF (prm_para_value = '05' OR prm_para_value = '06') THEN
      --采用游标的方式 批量更新 效率会高一些
      DECLARE
        CURSOR man_job IS
        
          SELECT t1.dept_id,
                 divide(SUM(nvl(t2.para_amount, 0)) * prm_dir_amount,
                        prm_sum_amount) para_amount,
                 divide(SUM(nvl(t2.para_amount, 0)) *
                        prm_indir_med_man_amount,
                        prm_sum_amount) para_amount_indir_med_man,
                 divide(SUM(nvl(t2.para_amount, 0)) *
                        prm_indir_med_ass_amount,
                        prm_sum_amount) para_amount_indir_med_ass,
                 divide(SUM(nvl(t2.para_amount, 0)) *
                        prm_indir_ass_med_man_amount,
                        prm_sum_amount) para_amount_indir_ass_med_man
            FROM cost_para_server_dept_share t1
           inner join cost_para_dept_share t3
              on t1.group_id = t3.group_id
             and t1.hos_id = t3.hos_id
             and t1.copy_code = t3.copy_code
             and t1.bill_code = t3.bill_code
            LEFT JOIN cost_para_value_data t2
              ON t1.group_id = t2.group_id
             AND t1.hos_id = t2.hos_id
             AND t1.copy_code = t2.copy_code
             AND t1.dept_id = t2.server_dept_id
             and t3.dept_id = t2.dept_id
           WHERE t2.para_value = prm_para_value
             AND t1.bill_code = prm_bill_code
             AND t3.dept_id = prm_dept_id
             and t1.group_id = prm_group_id
             AND t1.hos_id = prm_hos_id
             AND t1.copy_code = prm_copy_code
           GROUP BY t1.dept_id;
      
        man_row man_job%ROWTYPE;
        v_count INTEGER;
      BEGIN
      
        FOR man_row IN man_job LOOP
        
          v_count := 0;
        
          SELECT COUNT(*)
            INTO v_count
            FROM cost_dept_cost
           WHERE group_id = prm_group_id
             AND hos_id = prm_hos_id
             AND copy_code = prm_copy_code
             AND cost_item_id = prm_cost_item_id
             AND source_id = prm_source_id
             AND dept_id = man_row.dept_id
             AND acc_year = prm_acc_year
             AND acc_month = prm_acc_month;
        
          IF (v_count > 0) THEN
            UPDATE cost_dept_cost
               SET dir_med_amount           = nvl(dir_med_amount, 0) +
                                              man_row.para_amount,
                   indir_med_man_amount     = nvl(indir_med_man_amount, 0) +
                                              man_row.para_amount_indir_med_man,
                   indir_med_ass_amount     = nvl(indir_med_ass_amount, 0) +
                                              man_row.para_amount_indir_med_ass,
                   indir_ass_med_man_amount = nvl(indir_ass_med_man_amount,
                                                  0) +
                                              man_row.para_amount_indir_ass_med_man
            
             WHERE group_id = prm_group_id
               AND hos_id = prm_hos_id
               AND copy_code = prm_copy_code
               AND cost_item_id = prm_cost_item_id
               AND source_id = prm_source_id
               AND dept_id = man_row.dept_id
                  
               AND acc_year = prm_acc_year
               AND acc_month = prm_acc_month;
          ELSE
            INSERT INTO cost_dept_cost
              (group_id --集团ID
              ,
               hos_id --医院ID
              ,
               copy_code --账套编码
              ,
               acc_year --统计年份
              ,
               acc_month --统计月份
              ,
               dept_id --科室ID
               
              ,
               cost_item_id --成本项目ID
               
              ,
               source_id --资金来源
              ,
               dir_amount --直接成本
              ,
               dir_man_amount --分摊管理直接成本
              ,
               dir_ass_amount --分摊医辅直接成本
              ,
               dir_med_amount --分摊医技直接成本
              ,
               indir_ass_man_amount --间接分摊医辅管理成本
              ,
               indir_med_man_amount --间接分摊医技管理成本
              ,
               indir_ass_med_man_amount --间接分摊医技医辅管理成本
              ,
               indir_med_ass_amount --间接分摊医技医辅成本
               )
            
              SELECT prm_group_id,
                     prm_hos_id,
                     prm_copy_code,
                     prm_acc_year,
                     prm_acc_month,
                     man_row.dept_id
                     
                    ,
                     prm_cost_item_id
                     
                    ,
                     prm_source_id,
                     0,
                     0,
                     0,
                     man_row.para_amount,
                     0,
                     man_row.para_amount_indir_med_man,
                     man_row.para_amount_indir_med_ass,
                     man_row.para_amount_indir_ass_med_man
                FROM dual;
          END IF;
        
          --添加分摊过程数据
          prc_add_process(PRM_GROUP_ID,
                          PRM_HOS_ID,
                          PRM_COPY_CODE,
                          PRM_ACC_YEAR,
                          PRM_ACC_MONTH,
                          PRM_DEPT_ID,
                          man_row.dept_id,
                          PRM_COST_ITEM_ID,
                          PRM_SOURCE_ID,
                          PRM_DIR_AMOUNT,
                          0,
                          0,
                          man_row.para_amount,
                          0,
                          man_row.para_amount_indir_med_man,
                          man_row.para_amount_indir_med_ass,
                          man_row.para_amount_indir_ass_med_man);
        END LOOP;
      END;
    ELSE
      --采用游标的方式 批量更新 效率会高一些
      DECLARE
        CURSOR man_job IS
        
          SELECT t1.dept_id,
                 divide(SUM(nvl(t2.para_amount, 0)) * prm_dir_amount,
                        prm_sum_amount) para_amount,
                 divide(SUM(nvl(t2.para_amount, 0)) *
                        prm_indir_med_man_amount,
                        prm_sum_amount) para_amount_indir_med_man,
                 divide(SUM(nvl(t2.para_amount, 0)) *
                        prm_indir_med_ass_amount,
                        prm_sum_amount) para_amount_indir_med_ass,
                 divide(SUM(nvl(t2.para_amount, 0)) *
                        prm_indir_ass_med_man_amount,
                        prm_sum_amount) para_amount_indir_ass_med_man
            FROM cost_para_server_dept_share t1
           inner join cost_para_dept_share t3
              on t1.group_id = t3.group_id
             and t1.hos_id = t3.hos_id
             and t1.copy_code = t3.copy_code
             and t1.bill_code = t3.bill_code
            LEFT JOIN cost_para_value_data t2
              ON t1.group_id = t2.group_id
             AND t1.hos_id = t2.hos_id
             AND t1.copy_code = t2.copy_code
             AND t1.dept_id = t2.dept_id
           WHERE t2.para_value = prm_para_value
             AND t1.bill_code = prm_bill_code
             AND t2.dept_id = t2.server_dept_id
             and t3.dept_id = prm_dept_id
           GROUP BY t1.dept_id;
      
        man_row man_job%ROWTYPE;
        v_count INTEGER;
      BEGIN
      
        FOR man_row IN man_job LOOP
        
          v_count := 0;
        
          SELECT COUNT(*)
            INTO v_count
            FROM cost_dept_cost
           WHERE group_id = prm_group_id
             AND hos_id = prm_hos_id
             AND copy_code = prm_copy_code
             AND cost_item_id = prm_cost_item_id
             AND source_id = prm_source_id
             AND dept_id = man_row.dept_id
                
             AND acc_year = prm_acc_year
             AND acc_month = prm_acc_month;
        
          IF (v_count > 0) THEN
            UPDATE cost_dept_cost
               SET dir_med_amount           = nvl(dir_med_amount, 0) +
                                              man_row.para_amount,
                   indir_med_man_amount     = nvl(indir_med_man_amount, 0) +
                                              man_row.para_amount_indir_med_man,
                   indir_med_ass_amount     = nvl(indir_med_ass_amount, 0) +
                                              man_row.para_amount_indir_med_ass,
                   indir_ass_med_man_amount = nvl(indir_ass_med_man_amount,
                                                  0) +
                                              man_row.para_amount_indir_ass_med_man
            
             WHERE group_id = prm_group_id
               AND hos_id = prm_hos_id
               AND copy_code = prm_copy_code
               AND cost_item_id = prm_cost_item_id
               AND source_id = prm_source_id
               AND dept_id = man_row.dept_id
                  
               AND acc_year = prm_acc_year
               AND acc_month = prm_acc_month;
          ELSE
            INSERT INTO cost_dept_cost
              (group_id --集团ID
              ,
               hos_id --医院ID
              ,
               copy_code --账套编码
              ,
               acc_year --统计年份
              ,
               acc_month --统计月份
              ,
               dept_id --科室ID
              ,
               cost_item_id --成本项目ID
              ,
               source_id --资金来源
              ,
               dir_amount --直接成本
              ,
               dir_man_amount --分摊管理直接成本
              ,
               dir_ass_amount --分摊医辅直接成本
              ,
               dir_med_amount --分摊医技直接成本
              ,
               indir_ass_man_amount --间接分摊医辅管理成本
              ,
               indir_med_man_amount --间接分摊医技管理成本
              ,
               indir_ass_med_man_amount --间接分摊医技医辅管理成本
              ,
               indir_med_ass_amount --间接分摊医技医辅成本
               )
            
              SELECT prm_group_id,
                     prm_hos_id,
                     prm_copy_code,
                     prm_acc_year,
                     prm_acc_month,
                     man_row.dept_id
                     
                    ,
                     prm_cost_item_id
                     
                    ,
                     prm_source_id,
                     0,
                     0,
                     0,
                     man_row.para_amount,
                     0,
                     man_row.para_amount_indir_med_man,
                     man_row.para_amount_indir_med_ass,
                     man_row.para_amount_indir_ass_med_man
                FROM dual;
          END IF;
        
          --添加分摊过程数据
          prc_add_process(PRM_GROUP_ID,
                          PRM_HOS_ID,
                          PRM_COPY_CODE,
                          PRM_ACC_YEAR,
                          PRM_ACC_MONTH,
                          PRM_DEPT_ID,
                          man_row.dept_id,
                          PRM_COST_ITEM_ID,
                          PRM_SOURCE_ID,
                          PRM_DIR_AMOUNT,
                          0,
                          0,
                          man_row.para_amount,
                          0,
                          man_row.para_amount_indir_med_man,
                          man_row.para_amount_indir_med_ass,
                          man_row.para_amount_indir_ass_med_man);
        
        END LOOP;
      END;
    END IF;
  
    RETURN;
  
  END prc_cost_save_med;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_dept_man_peers
  || 功能描述 ：分摊管理成本 平级
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_dept_man_peers(prm_group_id  IN NUMBER --集团
                                   ,
                                    prm_hos_id    IN NUMBER --医院
                                   ,
                                    prm_copy_code IN VARCHAR2 --账套
                                   ,
                                    prm_acc_year  IN VARCHAR2 --年度
                                   ,
                                    prm_acc_month IN VARCHAR2 --月份
                                    ) IS
  BEGIN
  
    --分摊管理成本
    DECLARE
      --类型定义
      CURSOR man_job IS
        SELECT t1.group_id,
               t1.hos_id,
               t1.copy_code,
               t1.acc_year,
               t1.acc_month,
               t1.dept_id,
               t1.cost_item_id,
               t1.source_id,
               dir_amount,
               dir_man_amount,
               dir_ass_amount,
               dir_med_amount,
               indir_ass_man_amount,
               indir_med_man_amount,
               indir_ass_med_man_amount,
               indir_med_ass_amount,
               t1.para_code,
               t1.para_name,
               t1.para_type_code,
               t1.para_type_name,
               t3.para_value,
               t4.bill_code,
               t1.dept_code,
               t1.dept_name,
               t1.cost_item_code,
               t1.cost_item_name
        
          FROM (
                
                SELECT t1.group_id,
                        t1.hos_id,
                        t1.copy_code,
                        t1.acc_year,
                        t1.acc_month,
                        t1.dept_id,
                        t1.cost_item_id,
                        t1.source_id,
                        dir_amount,
                        dir_man_amount,
                        dir_ass_amount,
                        dir_med_amount,
                        indir_ass_man_amount,
                        indir_med_man_amount,
                        indir_ass_med_man_amount,
                        indir_med_ass_amount,
                        t2.para_code,
                        t4.para_type_code,
                        t3.dept_code,
                        t3.dept_name,
                        t4.cost_item_code,
                        t4.cost_item_name,
                        t2.type_code,
                        t5.para_name,
                        t6.type_name para_type_name
                  FROM cost_dept_cost t1
                 INNER JOIN acc_dept_attr t2
                    ON t1.group_id = t2.group_id
                   AND t1.hos_id = t2.hos_id
                   AND t1.dept_id = t2.dept_id
                  LEFT JOIN hos_dept t3
                    ON t3.group_id = t1.group_id
                   AND t3.hos_id = t1.hos_id
                   AND t3.dept_id = t1.dept_id
                  LEFT JOIN cost_item_dict t4
                    ON t4.group_id = t1.group_id
                   AND t4.hos_id = t1.hos_id
                   AND t4.copy_code = t1.copy_code
                   AND t4.cost_item_id = t1.cost_item_id
                  LEFT JOIN cost_para_natur t5
                    ON t5.group_id = t2.group_id
                   AND t5.hos_id = t2.hos_id
                   AND t5.para_code = t2.para_code
                  LEFT JOIN cost_para_type t6
                    ON t6.group_id = t4.group_id
                   AND t6.hos_id = t4.hos_id
                   AND t6.copy_code = t4.copy_code
                   AND t6.type_code = t4.para_type_code
                 WHERE t1.group_id = prm_group_id
                   AND t1.hos_id = prm_hos_id
                   AND t1.copy_code = prm_copy_code
                   AND t1.acc_year = prm_acc_year
                   AND t1.acc_month = prm_acc_month
                   AND t2.type_code = '04') t1
          LEFT JOIN cost_para_set_share t3
            ON t1.group_id = t3.group_id
           AND t1.hos_id = t3.hos_id
           AND t1.copy_code = t3.copy_code
           AND t1.para_code = t3.para_code
           AND t1.para_type_code = t3.para_type_code
          LEFT JOIN (SELECT DISTINCT a.group_id,
                                     a.hos_id,
                                     a.copy_code,
                                     a.dept_id,
                                     a.bill_code,
                                     CASE
                                       WHEN a.type_code = b.type_code THEN
                                        1
                                       ELSE
                                        0
                                     END is_flag
                       FROM cost_para_dept_share a
                       LEFT JOIN cost_para_server_dept_share b
                         ON a.group_id = b.group_id
                        AND a.hos_id = b.hos_id
                        AND a.copy_code = b.copy_code
                        AND a.bill_code = b.bill_code
                      WHERE a.type_code = '04') t4
            ON t1.group_id = t4.group_id
           AND t1.hos_id = t4.hos_id
           AND t1.copy_code = t4.copy_code
           AND t1.dept_id = t4.dept_id
         WHERE t1.type_code = '04'
           AND t4.is_flag = 1
         ORDER BY dept_id;
    
      man_row    man_job%ROWTYPE;
      sum_amount NUMERIC(19, 9); --服务科室总量
    
    BEGIN
    
      FOR man_row IN man_job
      
       LOOP
        is_default := 0;
        --获取分母总数
        select sum(para_amount)
          into sum_amount
          from COST_DEPT_DIR_CHECK_SHARE
         where group_id = prm_group_id
           and hos_id = prm_hos_id
           and copy_code = prm_copy_code
           and dept_id = man_row.dept_id
           and para_code = man_row.para_code
           and para_type_code = man_row.para_type_code
           and para_value = man_row.para_value;
      
        IF (nvl(sum_amount, 0) = 0)
        
         THEN
          --获取分母总数 默认人员
          select sum(para_amount)
            into sum_amount
            from COST_DEPT_EMP_CHECK_SHARE
           where group_id = prm_group_id
             and hos_id = prm_hos_id
             and copy_code = prm_copy_code
             and dept_id = man_row.dept_id
             and para_code = man_row.para_code
             and para_type_code = man_row.para_type_code
             and para_value = '01';
          is_default := 1;
        END IF;
      
        IF (nvl(sum_amount, 0) = 0)
        
         THEN
          --默认的分摊参数总和为0 跳出循环
          continue;
        
        END IF;
        IF (is_default = 0) THEN
          prc_cost_save_man(prm_group_id,
                            prm_hos_id,
                            prm_copy_code,
                            prm_acc_year,
                            prm_acc_month,
                            man_row.dept_id,
                            man_row.cost_item_id,
                            man_row.source_id,
                            man_row.dir_amount,
                            sum_amount,
                            man_row.para_value,
                            man_row.bill_code);
        ELSE
          prc_cost_save_man(prm_group_id,
                            prm_hos_id,
                            prm_copy_code,
                            prm_acc_year,
                            prm_acc_month,
                            man_row.dept_id,
                            man_row.cost_item_id,
                            man_row.source_id,
                            man_row.dir_amount,
                            sum_amount,
                            '01',
                            man_row.bill_code);
        END IF;
      
      END LOOP;
    
    END;
  
  END prc_cost_dept_man_peers;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_dept_man
  || 功能描述 ：分摊管理成本
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_dept_man(prm_group_id  IN NUMBER --集团
                             ,
                              prm_hos_id    IN NUMBER --医院
                             ,
                              prm_copy_code IN VARCHAR2 --账套
                             ,
                              prm_acc_year  IN VARCHAR2 --年度
                             ,
                              prm_acc_month IN VARCHAR2 --月份
                              ) IS
  BEGIN
  
    --分摊管理成本
    DECLARE
      --类型定义
      CURSOR man_job IS
        SELECT t1.group_id,
               t1.hos_id,
               t1.copy_code,
               t1.acc_year,
               t1.acc_month,
               t1.dept_id,
               t1.cost_item_id,
               t1.source_id,
               dir_amount,
               dir_man_amount,
               dir_ass_amount,
               dir_med_amount,
               indir_ass_man_amount,
               indir_med_man_amount,
               indir_ass_med_man_amount,
               indir_med_ass_amount,
               t1.para_code,
               t1.para_name,
               t1.para_type_code,
               t1.para_type_name,
               t3.para_value,
               t4.bill_code,
               t1.dept_code,
               t1.dept_name,
               t1.cost_item_code,
               t1.cost_item_name
        
          FROM (
                
                SELECT t1.group_id,
                        t1.hos_id,
                        t1.copy_code,
                        t1.acc_year,
                        t1.acc_month,
                        t1.dept_id,
                        t1.cost_item_id,
                        t1.source_id,
                        dir_amount,
                        dir_man_amount,
                        dir_ass_amount,
                        dir_med_amount,
                        indir_ass_man_amount,
                        indir_med_man_amount,
                        indir_ass_med_man_amount,
                        indir_med_ass_amount,
                        t2.para_code,
                        t4.para_type_code,
                        t3.dept_code,
                        t3.dept_name,
                        t4.cost_item_code,
                        t4.cost_item_name,
                        t2.type_code,
                        t5.para_name,
                        t6.type_name para_type_name
                  FROM cost_dept_cost t1
                 INNER JOIN acc_dept_attr t2
                    ON t1.group_id = t2.group_id
                   AND t1.hos_id = t2.hos_id
                   AND t1.dept_id = t2.dept_id
                  LEFT JOIN hos_dept t3
                    ON t3.group_id = t1.group_id
                   AND t3.hos_id = t1.hos_id
                   AND t3.dept_id = t1.dept_id
                  LEFT JOIN cost_item_dict t4
                    ON t4.group_id = t1.group_id
                   AND t4.hos_id = t1.hos_id
                   AND t4.copy_code = t1.copy_code
                   AND t4.cost_item_id = t1.cost_item_id
                  LEFT JOIN cost_para_natur t5
                    ON t5.group_id = t2.group_id
                   AND t5.hos_id = t2.hos_id
                   AND t5.para_code = t2.para_code
                  LEFT JOIN cost_para_type t6
                    ON t6.group_id = t4.group_id
                   AND t6.hos_id = t4.hos_id
                   AND t6.copy_code = t4.copy_code
                   AND t6.type_code = t4.para_type_code
                 WHERE t1.group_id = prm_group_id
                   AND t1.hos_id = prm_hos_id
                   AND t1.copy_code = prm_copy_code
                   AND t1.acc_year = prm_acc_year
                   AND t1.acc_month = prm_acc_month
                   AND t2.type_code = '04') t1
          LEFT JOIN cost_para_set_share t3
            ON t1.group_id = t3.group_id
           AND t1.hos_id = t3.hos_id
           AND t1.copy_code = t3.copy_code
           AND t1.para_code = t3.para_code
           AND t1.para_type_code = t3.para_type_code
          LEFT JOIN (SELECT DISTINCT a.group_id,
                                     a.hos_id,
                                     a.copy_code,
                                     a.dept_id,
                                     a.bill_code,
                                     CASE
                                       WHEN a.type_code = b.type_code THEN
                                        1
                                       ELSE
                                        0
                                     END is_flag
                       FROM cost_para_dept_share a
                       LEFT JOIN cost_para_server_dept_share b
                         ON a.group_id = b.group_id
                        AND a.hos_id = b.hos_id
                        AND a.copy_code = b.copy_code
                        AND a.bill_code = b.bill_code
                      WHERE a.type_code = '04') t4
            ON t1.group_id = t4.group_id
           AND t1.hos_id = t4.hos_id
           AND t1.copy_code = t4.copy_code
           AND t1.dept_id = t4.dept_id
         WHERE t1.type_code = '04'
           AND t4.is_flag = 0
         ORDER BY dept_id;
    
      man_row man_job%ROWTYPE;
    
      sum_amount NUMERIC(19, 9); --服务科室总量
    
    BEGIN
      FOR man_row IN man_job LOOP
        is_default := 0;
        --获取分母总数
        select sum(para_amount)
          into sum_amount
          from COST_DEPT_DIR_CHECK_SHARE
         where group_id = prm_group_id
           and hos_id = prm_hos_id
           and copy_code = prm_copy_code
           and dept_id = man_row.dept_id
           and para_code = man_row.para_code
           and para_type_code = man_row.para_type_code
           and para_value = man_row.para_value;
      
        IF (nvl(sum_amount, 0) = 0)
        
         THEN
          --获取分母总数 默认人员
          select sum(para_amount)
            into sum_amount
            from COST_DEPT_EMP_CHECK_SHARE
           where group_id = prm_group_id
             and hos_id = prm_hos_id
             and copy_code = prm_copy_code
             and dept_id = man_row.dept_id
             and para_code = man_row.para_code
             and para_type_code = man_row.para_type_code
             and para_value = '01';
          is_default := 1;
        END IF;
      
        IF (nvl(sum_amount, 0) = 0)
        
         THEN
          --默认的分摊参数总和为0 跳出循环
          continue;
        
        END IF;
      
        IF (is_default = 0) THEN
          prc_cost_save_man(prm_group_id,
                            prm_hos_id,
                            prm_copy_code,
                            prm_acc_year,
                            prm_acc_month,
                            man_row.dept_id,
                            man_row.cost_item_id,
                            man_row.source_id,
                            man_row.dir_amount + man_row.dir_man_amount,
                            sum_amount,
                            man_row.para_value,
                            man_row.bill_code);
        ELSE
          prc_cost_save_man(prm_group_id,
                            prm_hos_id,
                            prm_copy_code,
                            prm_acc_year,
                            prm_acc_month,
                            man_row.dept_id,
                            man_row.cost_item_id,
                            man_row.source_id,
                            man_row.dir_amount + man_row.dir_man_amount,
                            sum_amount,
                            '01',
                            man_row.bill_code);
        END IF;
      
      END LOOP;
    
    END;
  END prc_cost_dept_man;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_dept_ass_peers
  || 功能描述 ：分摊医辅成本 平级
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_dept_ass_peers(prm_group_id  IN NUMBER --集团
                                   ,
                                    prm_hos_id    IN NUMBER --医院
                                   ,
                                    prm_copy_code IN VARCHAR2 --账套
                                   ,
                                    prm_acc_year  IN VARCHAR2 --年度
                                   ,
                                    prm_acc_month IN VARCHAR2 --月份
                                    ) IS
  BEGIN
  
    --分摊管理成本
    DECLARE
      --类型定义
      CURSOR man_job IS
      --统计管理平级分摊
        SELECT t1.group_id,
               t1.hos_id,
               t1.copy_code,
               t1.acc_year,
               t1.acc_month,
               t1.dept_id,
               t1.cost_item_id,
               t1.source_id,
               dir_amount,
               dir_man_amount,
               dir_ass_amount,
               dir_med_amount,
               indir_ass_man_amount,
               indir_med_man_amount,
               indir_ass_med_man_amount,
               indir_med_ass_amount,
               t1.para_code,
               t1.para_name,
               t1.para_type_code,
               t1.para_type_name,
               t3.para_value,
               t4.bill_code,
               t1.dept_code,
               t1.dept_name,
               t1.cost_item_code,
               t1.cost_item_name
        
          FROM (
                
                SELECT t1.group_id,
                        t1.hos_id,
                        t1.copy_code,
                        t1.acc_year,
                        t1.acc_month,
                        t1.dept_id,
                        t1.cost_item_id,
                        t1.source_id,
                        dir_amount,
                        dir_man_amount,
                        dir_ass_amount,
                        dir_med_amount,
                        indir_ass_man_amount,
                        indir_med_man_amount,
                        indir_ass_med_man_amount,
                        indir_med_ass_amount,
                        t2.para_code,
                        t4.para_type_code,
                        t3.dept_code,
                        t3.dept_name,
                        t4.cost_item_code,
                        t4.cost_item_name,
                        t2.type_code,
                        t5.para_name,
                        t6.type_name para_type_name
                  FROM cost_dept_cost t1
                 INNER JOIN acc_dept_attr t2
                    ON t1.group_id = t2.group_id
                   AND t1.hos_id = t2.hos_id
                   AND t1.dept_id = t2.dept_id
                  LEFT JOIN hos_dept t3
                    ON t3.group_id = t1.group_id
                   AND t3.hos_id = t1.hos_id
                   AND t3.dept_id = t1.dept_id
                  LEFT JOIN cost_item_dict t4
                    ON t4.group_id = t1.group_id
                   AND t4.hos_id = t1.hos_id
                   AND t4.copy_code = t1.copy_code
                   AND t4.cost_item_id = t1.cost_item_id
                  LEFT JOIN cost_para_natur t5
                    ON t5.group_id = t2.group_id
                   AND t5.hos_id = t2.hos_id
                   AND t5.para_code = t2.para_code
                  LEFT JOIN cost_para_type t6
                    ON t6.group_id = t4.group_id
                   AND t6.hos_id = t4.hos_id
                   AND t6.copy_code = t4.copy_code
                   AND t6.type_code = t4.para_type_code
                 WHERE t1.group_id = prm_group_id
                   AND t1.hos_id = prm_hos_id
                   AND t1.copy_code = prm_copy_code
                   AND t1.acc_year = prm_acc_year
                   AND t1.acc_month = prm_acc_month
                   AND t2.type_code = '03') t1
          LEFT JOIN cost_para_set_share t3
            ON t1.group_id = t3.group_id
           AND t1.hos_id = t3.hos_id
           AND t1.copy_code = t3.copy_code
           AND t1.para_code = t3.para_code
           AND t1.para_type_code = t3.para_type_code
          LEFT JOIN (SELECT DISTINCT a.group_id,
                                     a.hos_id,
                                     a.copy_code,
                                     a.dept_id,
                                     a.bill_code,
                                     CASE
                                       WHEN a.type_code = b.type_code THEN
                                        1
                                       ELSE
                                        0
                                     END is_flag
                       FROM cost_para_dept_share a
                       LEFT JOIN cost_para_server_dept_share b
                         ON a.group_id = b.group_id
                        AND a.hos_id = b.hos_id
                        AND a.copy_code = b.copy_code
                        AND a.bill_code = b.bill_code
                      WHERE a.type_code = '03') t4
            ON t1.group_id = t4.group_id
           AND t1.hos_id = t4.hos_id
           AND t1.copy_code = t4.copy_code
           AND t1.dept_id = t4.dept_id
         WHERE t1.type_code = '03'
           AND t4.is_flag = 1
         ORDER BY dept_id;
    
      man_row    man_job%ROWTYPE;
      sum_amount NUMERIC(19, 9); --服务科室总量
    
    BEGIN
    
      FOR man_row IN man_job
      
       LOOP
      
        is_default := 0;
        --获取分母总数
        select sum(para_amount)
          into sum_amount
          from COST_DEPT_DIR_CHECK_SHARE
         where group_id = prm_group_id
           and hos_id = prm_hos_id
           and copy_code = prm_copy_code
           and dept_id = man_row.dept_id
           and para_code = man_row.para_code
           and para_type_code = man_row.para_type_code
           and para_value = man_row.para_value;
      
        IF (nvl(sum_amount, 0) = 0)
        
         THEN
          --获取分母总数 默认人员
          select sum(para_amount)
            into sum_amount
            from COST_DEPT_EMP_CHECK_SHARE
           where group_id = prm_group_id
             and hos_id = prm_hos_id
             and copy_code = prm_copy_code
             and dept_id = man_row.dept_id
             and para_code = man_row.para_code
             and para_type_code = man_row.para_type_code
             and para_value = '01';
          is_default := 1;
        END IF;
      
        IF (nvl(sum_amount, 0) = 0)
        
         THEN
          --默认的分摊参数总和为0 跳出循环
          continue;
        
        END IF;
        IF (is_default = 0) THEN
          prc_cost_save_ass(prm_group_id,
                            prm_hos_id,
                            prm_copy_code,
                            prm_acc_year,
                            prm_acc_month,
                            man_row.dept_id,
                            man_row.cost_item_id,
                            man_row.source_id,
                            man_row.dir_amount,
                            sum_amount,
                            man_row.para_value,
                            man_row.bill_code,
                            man_row.dir_man_amount);
        ELSE
          prc_cost_save_ass(prm_group_id,
                            prm_hos_id,
                            prm_copy_code,
                            prm_acc_year,
                            prm_acc_month,
                            man_row.dept_id,
                            man_row.cost_item_id,
                            man_row.source_id,
                            man_row.dir_amount,
                            sum_amount,
                            '01',
                            man_row.bill_code,
                            man_row.dir_man_amount);
        END IF;
      
      END LOOP;
    
    END;
  
    RETURN;
  
  END prc_cost_dept_ass_peers;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_dept_med
  || 功能描述 ：分摊医辅成本
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_dept_ass(prm_group_id  IN NUMBER --集团
                             ,
                              prm_hos_id    IN NUMBER --医院
                             ,
                              prm_copy_code IN VARCHAR2 --账套
                             ,
                              prm_acc_year  IN VARCHAR2 --年度
                             ,
                              prm_acc_month IN VARCHAR2 --月份
                              ) IS
  BEGIN
  
    --分摊管理成本
    DECLARE
      --类型定义
      CURSOR man_job IS
      --统计管理平级分摊
        SELECT t1.group_id,
               t1.hos_id,
               t1.copy_code,
               t1.acc_year,
               t1.acc_month,
               t1.dept_id,
               t1.cost_item_id,
               t1.source_id,
               dir_amount,
               dir_man_amount,
               dir_ass_amount,
               dir_med_amount,
               indir_ass_man_amount,
               indir_med_man_amount,
               indir_ass_med_man_amount,
               indir_med_ass_amount,
               t1.para_code,
               t1.para_name,
               t1.para_type_code,
               t1.para_type_name,
               t3.para_value,
               t4.bill_code,
               t1.dept_code,
               t1.dept_name,
               t1.cost_item_code,
               t1.cost_item_name
        
          FROM (
                
                SELECT t1.group_id,
                        t1.hos_id,
                        t1.copy_code,
                        t1.acc_year,
                        t1.acc_month,
                        t1.dept_id,
                        t1.cost_item_id,
                        t1.source_id,
                        dir_amount,
                        dir_man_amount,
                        dir_ass_amount,
                        dir_med_amount,
                        indir_ass_man_amount,
                        indir_med_man_amount,
                        indir_ass_med_man_amount,
                        indir_med_ass_amount,
                        t2.para_code,
                        t4.para_type_code,
                        t3.dept_code,
                        t3.dept_name,
                        t4.cost_item_code,
                        t4.cost_item_name,
                        t2.type_code,
                        t5.para_name,
                        t6.type_name para_type_name
                  FROM cost_dept_cost t1
                 INNER JOIN acc_dept_attr t2
                    ON t1.group_id = t2.group_id
                   AND t1.hos_id = t2.hos_id
                   AND t1.dept_id = t2.dept_id
                  LEFT JOIN hos_dept t3
                    ON t3.group_id = t1.group_id
                   AND t3.hos_id = t1.hos_id
                   AND t3.dept_id = t1.dept_id
                  LEFT JOIN cost_item_dict t4
                    ON t4.group_id = t1.group_id
                   AND t4.hos_id = t1.hos_id
                   AND t4.copy_code = t1.copy_code
                   AND t4.cost_item_id = t1.cost_item_id
                  LEFT JOIN cost_para_natur t5
                    ON t5.group_id = t2.group_id
                   AND t5.hos_id = t2.hos_id
                   AND t5.para_code = t2.para_code
                  LEFT JOIN cost_para_type t6
                    ON t6.group_id = t4.group_id
                   AND t6.hos_id = t4.hos_id
                   AND t6.copy_code = t4.copy_code
                   AND t6.type_code = t4.para_type_code
                 WHERE t1.group_id = prm_group_id
                   AND t1.hos_id = prm_hos_id
                   AND t1.copy_code = prm_copy_code
                   AND t1.acc_year = prm_acc_year
                   AND t1.acc_month = prm_acc_month
                   AND t2.type_code = '03') t1
          LEFT JOIN cost_para_set_share t3
            ON t1.group_id = t3.group_id
           AND t1.hos_id = t3.hos_id
           AND t1.copy_code = t3.copy_code
           AND t1.para_code = t3.para_code
           AND t1.para_type_code = t3.para_type_code
          LEFT JOIN (SELECT DISTINCT a.group_id,
                                     a.hos_id,
                                     a.copy_code,
                                     a.dept_id,
                                     a.bill_code,
                                     CASE
                                       WHEN a.type_code = b.type_code THEN
                                        1
                                       ELSE
                                        0
                                     END is_flag
                       FROM cost_para_dept_share a
                       LEFT JOIN cost_para_server_dept_share b
                         ON a.group_id = b.group_id
                        AND a.hos_id = b.hos_id
                        AND a.copy_code = b.copy_code
                        AND a.bill_code = b.bill_code
                      WHERE a.type_code = '03') t4
            ON t1.group_id = t4.group_id
           AND t1.hos_id = t4.hos_id
           AND t1.copy_code = t4.copy_code
           AND t1.dept_id = t4.dept_id
         WHERE t1.type_code = '03'
           AND t4.is_flag = 0
         ORDER BY dept_id;
    
      man_row    man_job%ROWTYPE;
      sum_amount NUMERIC(19, 9); --服务科室总量
    
    BEGIN
    
      FOR man_row IN man_job LOOP
        is_default := 0;
        --获取分母总数
        select sum(para_amount)
          into sum_amount
          from COST_DEPT_DIR_CHECK_SHARE
         where group_id = prm_group_id
           and hos_id = prm_hos_id
           and copy_code = prm_copy_code
           and dept_id = man_row.dept_id
           and para_code = man_row.para_code
           and para_type_code = man_row.para_type_code
           and para_value = man_row.para_value;
      
        IF (nvl(sum_amount, 0) = 0)
        
         THEN
          --获取分母总数 默认人员
          select sum(para_amount)
            into sum_amount
            from COST_DEPT_EMP_CHECK_SHARE
           where group_id = prm_group_id
             and hos_id = prm_hos_id
             and copy_code = prm_copy_code
             and dept_id = man_row.dept_id
             and para_code = man_row.para_code
             and para_type_code = man_row.para_type_code
             and para_value = '01';
          is_default := 1;
        END IF;
      
        IF (nvl(sum_amount, 0) = 0)
        
         THEN
          --默认的分摊参数总和为0 跳出循环
          continue;
        
        END IF;
      
        IF (is_default = 0) THEN
        
          prc_cost_save_ass(prm_group_id,
                            prm_hos_id,
                            prm_copy_code,
                            prm_acc_year,
                            prm_acc_month,
                            man_row.dept_id,
                            man_row.cost_item_id,
                            man_row.source_id,
                            man_row.dir_amount + man_row.dir_ass_amount,
                            sum_amount,
                            man_row.para_value,
                            man_row.bill_code,
                            man_row.dir_man_amount +
                            man_row.indir_ass_man_amount);
        ELSE
        
          prc_cost_save_ass(prm_group_id,
                            prm_hos_id,
                            prm_copy_code,
                            prm_acc_year,
                            prm_acc_month,
                            man_row.dept_id,
                            man_row.cost_item_id,
                            man_row.source_id,
                            man_row.dir_amount + man_row.dir_ass_amount,
                            sum_amount,
                            '01',
                            man_row.bill_code,
                            man_row.dir_man_amount +
                            man_row.indir_ass_man_amount);
        END IF;
      
      END LOOP;
    
    END;
  
    RETURN;
  
  END prc_cost_dept_ass;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_dept_med_peers
  || 功能描述 ：分摊医技成本 平级
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_dept_med_peers(prm_group_id  IN NUMBER --集团
                                   ,
                                    prm_hos_id    IN NUMBER --医院
                                   ,
                                    prm_copy_code IN VARCHAR2 --账套
                                   ,
                                    prm_acc_year  IN VARCHAR2 --年度
                                   ,
                                    prm_acc_month IN VARCHAR2 --月份
                                    ) IS
  BEGIN
  
    --分摊管理成本
    DECLARE
      --类型定义
      CURSOR man_job IS
      --统计管理平级分摊
        SELECT t1.group_id,
               t1.hos_id,
               t1.copy_code,
               t1.acc_year,
               t1.acc_month,
               t1.dept_id,
               t1.cost_item_id,
               t1.source_id,
               dir_amount,
               dir_man_amount,
               dir_ass_amount,
               dir_med_amount,
               indir_ass_man_amount,
               indir_med_man_amount,
               indir_ass_med_man_amount,
               indir_med_ass_amount,
               t1.para_code,
               t1.para_name,
               t1.para_type_code,
               t1.para_type_name,
               t3.para_value,
               t4.bill_code,
               t1.dept_code,
               t1.dept_name,
               t1.cost_item_code,
               t1.cost_item_name
        
          FROM (
                
                SELECT t1.group_id,
                        t1.hos_id,
                        t1.copy_code,
                        t1.acc_year,
                        t1.acc_month,
                        t1.dept_id,
                        t1.cost_item_id,
                        t1.source_id,
                        dir_amount,
                        dir_man_amount,
                        dir_ass_amount,
                        dir_med_amount,
                        indir_ass_man_amount,
                        indir_med_man_amount,
                        indir_ass_med_man_amount,
                        indir_med_ass_amount,
                        t2.para_code,
                        t4.para_type_code,
                        t3.dept_code,
                        t3.dept_name,
                        t4.cost_item_code,
                        t4.cost_item_name,
                        t2.type_code,
                        t5.para_name,
                        t6.type_name para_type_name
                  FROM cost_dept_cost t1
                 INNER JOIN acc_dept_attr t2
                    ON t1.group_id = t2.group_id
                   AND t1.hos_id = t2.hos_id
                   AND t1.dept_id = t2.dept_id
                  LEFT JOIN hos_dept t3
                    ON t3.group_id = t1.group_id
                   AND t3.hos_id = t1.hos_id
                   AND t3.dept_id = t1.dept_id
                  LEFT JOIN cost_item_dict t4
                    ON t4.group_id = t1.group_id
                   AND t4.hos_id = t1.hos_id
                   AND t4.copy_code = t1.copy_code
                   AND t4.cost_item_id = t1.cost_item_id
                  LEFT JOIN cost_para_natur t5
                    ON t5.group_id = t2.group_id
                   AND t5.hos_id = t2.hos_id
                   AND t5.para_code = t2.para_code
                  LEFT JOIN cost_para_type t6
                    ON t6.group_id = t4.group_id
                   AND t6.hos_id = t4.hos_id
                   AND t6.copy_code = t4.copy_code
                   AND t6.type_code = t4.para_type_code
                 WHERE t1.group_id = prm_group_id
                   AND t1.hos_id = prm_hos_id
                   AND t1.copy_code = prm_copy_code
                   AND t1.acc_year = prm_acc_year
                   AND t1.acc_month = prm_acc_month
                   AND t2.type_code = '02') t1
          LEFT JOIN cost_para_set_share t3
            ON t1.group_id = t3.group_id
           AND t1.hos_id = t3.hos_id
           AND t1.copy_code = t3.copy_code
           AND t1.para_code = t3.para_code
           AND t1.para_type_code = t3.para_type_code
          LEFT JOIN (SELECT DISTINCT a.group_id,
                                     a.hos_id,
                                     a.copy_code,
                                     a.dept_id,
                                     a.bill_code,
                                     CASE
                                       WHEN a.type_code = b.type_code THEN
                                        1
                                       ELSE
                                        0
                                     END is_flag
                       FROM cost_para_dept_share a
                       LEFT JOIN cost_para_server_dept_share b
                         ON a.group_id = b.group_id
                        AND a.hos_id = b.hos_id
                        AND a.copy_code = b.copy_code
                        AND a.bill_code = b.bill_code
                      WHERE a.type_code = '02') t4
            ON t1.group_id = t4.group_id
           AND t1.hos_id = t4.hos_id
           AND t1.copy_code = t4.copy_code
           AND t1.dept_id = t4.dept_id
         WHERE t1.type_code = '02'
           AND t4.is_flag = 1
         ORDER BY dept_id;
    
      man_row man_job%ROWTYPE;
    
      sum_amount NUMERIC(19, 9); --服务科室总量
    
    BEGIN
      FOR man_row IN man_job LOOP
      
        is_default := 0;
        --获取分母总数
        select sum(para_amount)
          into sum_amount
          from COST_DEPT_DIR_CHECK_SHARE
         where group_id = prm_group_id
           and hos_id = prm_hos_id
           and copy_code = prm_copy_code
           and dept_id = man_row.dept_id
           and para_code = man_row.para_code
           and para_type_code = man_row.para_type_code
           and para_value = man_row.para_value;
      
        IF (nvl(sum_amount, 0) = 0)
        
         THEN
          --获取分母总数 默认人员
          select sum(para_amount)
            into sum_amount
            from COST_DEPT_EMP_CHECK_SHARE
           where group_id = prm_group_id
             and hos_id = prm_hos_id
             and copy_code = prm_copy_code
             and dept_id = man_row.dept_id
             and para_code = man_row.para_code
             and para_type_code = man_row.para_type_code
             and para_value = '01';
          is_default := 1;
        END IF;
      
        IF (nvl(sum_amount, 0) = 0)
        
         THEN
          --默认的分摊参数总和为0 跳出循环
          continue;
        
        END IF;
        IF (is_default = 0) THEN
          prc_cost_save_med(prm_group_id,
                            prm_hos_id,
                            prm_copy_code,
                            prm_acc_year,
                            prm_acc_month,
                            man_row.dept_id
                            
                           ,
                            man_row.cost_item_id
                            
                           ,
                            man_row.source_id,
                            man_row.dir_amount,
                            sum_amount,
                            man_row.para_value,
                            man_row.bill_code,
                            man_row.dir_man_amount,
                            man_row.dir_ass_amount,
                            man_row.indir_ass_man_amount);
        ELSE
          prc_cost_save_med(prm_group_id,
                            prm_hos_id,
                            prm_copy_code,
                            prm_acc_year,
                            prm_acc_month,
                            man_row.dept_id,
                            man_row.cost_item_id,
                            man_row.source_id,
                            man_row.dir_amount,
                            sum_amount,
                            '01',
                            man_row.bill_code,
                            man_row.dir_man_amount,
                            man_row.dir_ass_amount,
                            man_row.indir_ass_man_amount);
        END IF;
      
      END LOOP;
    
    END;
  
    RETURN;
  
  END prc_cost_dept_med_peers;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_dept_med
  || 功能描述 ：分摊医技成本
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_dept_med(prm_group_id  IN NUMBER --集团
                             ,
                              prm_hos_id    IN NUMBER --医院
                             ,
                              prm_copy_code IN VARCHAR2 --账套
                             ,
                              prm_acc_year  IN VARCHAR2 --年度
                             ,
                              prm_acc_month IN VARCHAR2 --月份
                              ) IS
  BEGIN
  
    --分摊管理成本
    DECLARE
      --类型定义
      CURSOR man_job IS
      --统计管理平级分摊
        SELECT t1.group_id,
               t1.hos_id,
               t1.copy_code,
               t1.acc_year,
               t1.acc_month,
               t1.dept_id,
               t1.cost_item_id,
               t1.source_id,
               dir_amount,
               dir_man_amount,
               dir_ass_amount,
               dir_med_amount,
               indir_ass_man_amount,
               indir_med_man_amount,
               indir_ass_med_man_amount,
               indir_med_ass_amount,
               t1.para_code,
               t1.para_name,
               t1.para_type_code,
               t1.para_type_name,
               t3.para_value,
               t4.bill_code,
               t1.dept_code,
               t1.dept_name,
               t1.cost_item_code,
               t1.cost_item_name
        
          FROM (
                
                SELECT t1.group_id,
                        t1.hos_id,
                        t1.copy_code,
                        t1.acc_year,
                        t1.acc_month,
                        t1.dept_id,
                        t1.cost_item_id,
                        t1.source_id,
                        dir_amount,
                        dir_man_amount,
                        dir_ass_amount,
                        dir_med_amount,
                        indir_ass_man_amount,
                        indir_med_man_amount,
                        indir_ass_med_man_amount,
                        indir_med_ass_amount,
                        t2.para_code,
                        t4.para_type_code,
                        t3.dept_code,
                        t3.dept_name,
                        t4.cost_item_code,
                        t4.cost_item_name,
                        t2.type_code,
                        t5.para_name,
                        t6.type_name para_type_name
                  FROM cost_dept_cost t1
                 INNER JOIN acc_dept_attr t2
                    ON t1.group_id = t2.group_id
                   AND t1.hos_id = t2.hos_id
                   AND t1.dept_id = t2.dept_id
                  LEFT JOIN hos_dept t3
                    ON t3.group_id = t1.group_id
                   AND t3.hos_id = t1.hos_id
                   AND t3.dept_id = t1.dept_id
                  LEFT JOIN cost_item_dict t4
                    ON t4.group_id = t1.group_id
                   AND t4.hos_id = t1.hos_id
                   AND t4.copy_code = t1.copy_code
                   AND t4.cost_item_id = t1.cost_item_id
                  LEFT JOIN cost_para_natur t5
                    ON t5.group_id = t2.group_id
                   AND t5.hos_id = t2.hos_id
                   AND t5.para_code = t2.para_code
                  LEFT JOIN cost_para_type t6
                    ON t6.group_id = t4.group_id
                   AND t6.hos_id = t4.hos_id
                   AND t6.copy_code = t4.copy_code
                   AND t6.type_code = t4.para_type_code
                 WHERE t1.group_id = prm_group_id
                   AND t1.hos_id = prm_hos_id
                   AND t1.copy_code = prm_copy_code
                   AND t1.acc_year = prm_acc_year
                   AND t1.acc_month = prm_acc_month
                   AND t2.type_code = '02') t1
          LEFT JOIN cost_para_set_share t3
            ON t1.group_id = t3.group_id
           AND t1.hos_id = t3.hos_id
           AND t1.copy_code = t3.copy_code
           AND t1.para_code = t3.para_code
           AND t1.para_type_code = t3.para_type_code
          LEFT JOIN (SELECT DISTINCT a.group_id,
                                     a.hos_id,
                                     a.copy_code,
                                     a.dept_id,
                                     a.bill_code,
                                     CASE
                                       WHEN a.type_code = b.type_code THEN
                                        1
                                       ELSE
                                        0
                                     END is_flag
                       FROM cost_para_dept_share a
                       LEFT JOIN cost_para_server_dept_share b
                         ON a.group_id = b.group_id
                        AND a.hos_id = b.hos_id
                        AND a.copy_code = b.copy_code
                        AND a.bill_code = b.bill_code
                      WHERE a.type_code = '02') t4
            ON t1.group_id = t4.group_id
           AND t1.hos_id = t4.hos_id
           AND t1.copy_code = t4.copy_code
           AND t1.dept_id = t4.dept_id
         WHERE t1.type_code = '02'
           AND t4.is_flag = 0
         ORDER BY dept_id;
    
      man_row    man_job%ROWTYPE;
      sum_amount NUMERIC(19, 9);
    
    BEGIN
    
      FOR man_row IN man_job LOOP
        is_default := 0;
        --获取分母总数
        select sum(para_amount)
          into sum_amount
          from COST_DEPT_DIR_CHECK_SHARE
         where group_id = prm_group_id
           and hos_id = prm_hos_id
           and copy_code = prm_copy_code
           and dept_id = man_row.dept_id
           and para_code = man_row.para_code
           and para_type_code = man_row.para_type_code
           and para_value = man_row.para_value;
      
        IF (nvl(sum_amount, 0) = 0)
        
         THEN
          --获取分母总数 默认人员
          select sum(para_amount)
            into sum_amount
            from COST_DEPT_EMP_CHECK_SHARE
           where group_id = prm_group_id
             and hos_id = prm_hos_id
             and copy_code = prm_copy_code
             and dept_id = man_row.dept_id
             and para_code = man_row.para_code
             and para_type_code = man_row.para_type_code
             and para_value = '01';
          is_default := 1;
        END IF;
      
        IF (nvl(sum_amount, 0) = 0)
        
         THEN
          --默认的分摊参数总和为0 跳出循环
          continue;
        
        END IF;
      
        IF (is_default = 0) THEN
          prc_cost_save_med(prm_group_id,
                            prm_hos_id,
                            prm_copy_code,
                            prm_acc_year,
                            prm_acc_month,
                            man_row.dept_id,
                            man_row.cost_item_id,
                            man_row.source_id,
                            man_row.dir_amount + man_row.dir_med_amount,
                            sum_amount,
                            man_row.para_value,
                            man_row.bill_code,
                            man_row.dir_man_amount +
                            man_row.indir_med_man_amount,
                            man_row.dir_ass_amount +
                            man_row.indir_med_ass_amount,
                            man_row.indir_ass_man_amount +
                            man_row.indir_ass_med_man_amount);
        ELSE
          prc_cost_save_med(prm_group_id,
                            prm_hos_id,
                            prm_copy_code,
                            prm_acc_year,
                            prm_acc_month,
                            man_row.dept_id,
                            man_row.cost_item_id
                            
                           ,
                            man_row.source_id,
                            man_row.dir_amount + man_row.dir_med_amount,
                            sum_amount,
                            '01',
                            man_row.bill_code,
                            man_row.dir_man_amount +
                            man_row.indir_med_man_amount,
                            man_row.dir_ass_amount +
                            man_row.indir_med_ass_amount,
                            man_row.indir_ass_man_amount +
                            man_row.indir_ass_med_man_amount);
        END IF;
      
      END LOOP;
    
    END;
  
    RETURN;
  
  END prc_cost_dept_med;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_load_data
  || 功能描述 ：加载初始数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_load_data(prm_group_id  IN NUMBER --集团
                         ,
                          prm_hos_id    IN NUMBER --医院
                         ,
                          prm_copy_code IN VARCHAR2 --账套
                         ,
                          prm_acc_year  IN VARCHAR2 --年度
                         ,
                          prm_acc_month IN VARCHAR2 --月份
                          ) IS
  
  BEGIN
    delete from cost_allocation_process
     where group_id = prm_group_id
       and hos_id = prm_hos_id
       and copy_code = prm_copy_code
       and acc_year = prm_acc_year
       and acc_month = prm_acc_month;
  
    --直接成本
    prc_dept_dir_data(prm_group_id,
                      prm_hos_id,
                      prm_copy_code,
                      prm_acc_year,
                      prm_acc_month);
    --   commit;
    --分摊类型分摊参数统计
    prc_para_set(prm_group_id,
                 prm_hos_id,
                 prm_copy_code,
                 prm_acc_year,
                 prm_acc_month);
    --  commit;
    --服务科室
    prc_para_dept(prm_group_id,
                  prm_hos_id,
                  prm_copy_code,
                  prm_acc_year,
                  prm_acc_month);
    --  commit;
    --受益科室
    prc_para_server_dept(prm_group_id,
                         prm_hos_id,
                         prm_copy_code,
                         prm_acc_year,
                         prm_acc_month);
    --  commit;
    --分摊参数当量
    prc_server_para_value(prm_group_id,
                          prm_hos_id,
                          prm_copy_code,
                          prm_acc_year,
                          prm_acc_month);
  END prc_load_data;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_cost_dept_cost
  || 功能描述 ：按照分摊类别统计分摊参数
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_cost_dept_cost(prm_group_id  IN NUMBER --集团
                              ,
                               prm_hos_id    IN NUMBER --医院
                              ,
                               prm_copy_code IN VARCHAR2 --账套
                              ,
                               prm_acc_year  IN VARCHAR2 --年度
                              ,
                               prm_acc_month IN VARCHAR2 --月份
                              ,
                               prm_AppCode   Out Number --执行代码
                              ,
                               prm_ErrTxt    Out Varchar2 --错误信息
                               ) IS
    --初始化 信息数组下标
  BEGIN
  
    error_i     := 1;
    is_exists   := 0;
    is_default  := 0;
    prm_AppCode := def_OK;
    prm_ErrTxt  := '分摊成功!';
    --加载初始数据
    prc_load_data(prm_group_id,
                  prm_hos_id,
                  prm_copy_code,
                  prm_acc_year,
                  prm_acc_month);
  
    --初始化当月科室的直接成本
    DELETE cost_dept_cost
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code
       AND acc_year = prm_acc_year
       AND acc_month = prm_acc_month;
    --初始化当月科室的分摊成本过程表
    delete cost_allocation_process
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code
       AND acc_year = prm_acc_year
       AND acc_month = prm_acc_month;
    INSERT INTO cost_dept_cost
      (group_id --集团ID
      ,
       hos_id --医院ID
      ,
       copy_code --账套编码
      ,
       acc_year --统计年份
      ,
       acc_month --统计月份
      ,
       dept_id --科室ID
       
      ,
       cost_item_id --成本项目ID
       
      ,
       source_id --资金来源
      ,
       dir_amount --直接成本
      ,
       dir_man_amount --分摊管理直接成本
      ,
       dir_ass_amount --分摊医辅直接成本
      ,
       dir_med_amount --分摊医技直接成本
      ,
       indir_ass_man_amount --间接分摊医辅管理成本
      ,
       indir_med_man_amount --间接分摊医技管理成本
      ,
       indir_ass_med_man_amount --间接分摊医技医辅管理成本
      ,
       indir_med_ass_amount --间接分摊医技医辅成本
       )
      SELECT group_id --集团ID
            ,
             hos_id --医院ID
            ,
             copy_code --账套
            ,
             prm_acc_year --年份
            ,
             prm_acc_month --月份
            ,
             dept_id --科室ID
             
            ,
             cost_item_id --成本项目ID
             
            ,
             source_id --资金来源
            ,
             dir_amount --直接成本
            ,
             0 --分摊管理直接成本
            ,
             0 --分摊医辅直接成本
            ,
             0 --分摊医技直接成本
            ,
             0 --间接分摊医辅管理成本
            ,
             0 --间接分摊医技管理成本
            ,
             0 --间接分摊医技医辅管理成本
            ,
             0 --间接分摊医技医辅成本
        FROM cost_dept_dri_share
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code;
  
    --加载数据
    prc_cost_type_para_load(prm_group_id, prm_hos_id, prm_copy_code);
  
    --管理分摊
  
    prc_cost_dept_man_peers(prm_group_id,
                            prm_hos_id,
                            prm_copy_code,
                            prm_acc_year,
                            prm_acc_month);
  
    --管理分摊
  
    prc_cost_dept_man(prm_group_id,
                      prm_hos_id,
                      prm_copy_code,
                      prm_acc_year,
                      prm_acc_month);
  
    --医辅分摊
  
    prc_cost_dept_ass_peers(prm_group_id,
                            prm_hos_id,
                            prm_copy_code,
                            prm_acc_year,
                            prm_acc_month);
  
    --医辅分摊
  
    prc_cost_dept_ass(prm_group_id,
                      prm_hos_id,
                      prm_copy_code,
                      prm_acc_year,
                      prm_acc_month);
  
    --医技分摊
  
    prc_cost_dept_med_peers(prm_group_id,
                            prm_hos_id,
                            prm_copy_code,
                            prm_acc_year,
                            prm_acc_month);
  
    --医技分摊
  
    prc_cost_dept_med(prm_group_id,
                      prm_hos_id,
                      prm_copy_code,
                      prm_acc_year,
                      prm_acc_month);
  
  EXCEPTION
    WHEN OTHERS THEN
      prm_AppCode := def_ERR;
      prm_ErrTxt  := '分摊失败！' || SQLERRM;
    
  END prc_cost_dept_cost;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_check_data
  || 功能描述 ：校验分摊前相关数据是否配置正确
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_check_data(prm_group_id  IN NUMBER --集团
                          ,
                           prm_hos_id    IN NUMBER --医院
                          ,
                           prm_copy_code IN VARCHAR2 --账套
                          ,
                           prm_acc_year  IN VARCHAR2 --年度
                          ,
                           prm_acc_month IN VARCHAR2 --月份
                          ,
                           prm_AppCode   Out Number --执行代码
                          ,
                           prm_ErrTxt    Out Varchar2 --错误信息
                           ) IS
  
  BEGIN
  
    delete from COST_MESSAGE_CHECK_SHARE
     where group_id = prm_group_id
       and hos_id = prm_hos_id
       and copy_code = prm_copy_code;
  
    --加载初始数据
    prc_load_data(prm_group_id,
                  prm_hos_id,
                  prm_copy_code,
                  prm_acc_year,
                  prm_acc_month);
  
    --科室不是末级科室
    insert into COST_MESSAGE_CHECK_SHARE
      (GROUP_ID,
       HOS_ID,
       COPY_CODE,
       MESSAGE_CODE,
       MESSAGE_NAME,
       MESSAGE_NOTE)
      select t.GROUP_ID,
             t.HOS_ID,
             t.COPY_CODE,
             t5.dept_code,
             t5.dept_name,
             '科室不是末级科室'
        from hos_dept t5
       inner JOIN cost_dept_dri_share t
          ON t.group_id = t5.group_id
         AND t.hos_id = t5.hos_id
         AND t.dept_id = t5.dept_id
       where t.group_id = prm_group_id
         and t.hos_id = prm_hos_id
         and t.copy_code = prm_copy_code
         and t.type_code <> '01'
         and t5.is_last != 1;
  
    --检查科室字典中是否配置分摊性质
    insert into COST_MESSAGE_CHECK_SHARE
      (GROUP_ID,
       HOS_ID,
       COPY_CODE,
       MESSAGE_CODE,
       MESSAGE_NAME,
       MESSAGE_NOTE)
      select GROUP_ID,
             HOS_ID,
             COPY_CODE,
             t.dept_code,
             t.dept_name,
             '科室字典中没有配置分摊性质:'
        from cost_dept_dri_share t
       where t.group_id = prm_group_id
         and t.hos_id = prm_hos_id
         and t.copy_code = prm_copy_code
         and t.type_code <> '01'
         and nvl(t.para_code, '9999999') = '9999999';
    --检查科室字典中配置的分摊性质在分摊性质字典中不存在
    insert into COST_MESSAGE_CHECK_SHARE
      (GROUP_ID,
       HOS_ID,
       COPY_CODE,
       MESSAGE_CODE,
       MESSAGE_NAME,
       MESSAGE_NOTE)
      select GROUP_ID,
             HOS_ID,
             COPY_CODE,
             t.dept_code,
             t.dept_name,
             '科室字典中配置的分摊性质在分摊性质字典中不存在:'
        from cost_dept_dri_share t
       where t.group_id = prm_group_id
         and t.hos_id = prm_hos_id
         and t.copy_code = prm_copy_code
         and t.type_code <> '01'
         and nvl(t.para_name, '9999999') = '9999999';
    --成本项目不是末级项目
    insert into COST_MESSAGE_CHECK_SHARE
      (GROUP_ID,
       HOS_ID,
       COPY_CODE,
       MESSAGE_CODE,
       MESSAGE_NAME,
       MESSAGE_NOTE)
      select t4.GROUP_ID,
             t4.HOS_ID,
             t4.COPY_CODE,
             t4.cost_item_code,
             t4.cost_item_name,
             '成本项目不是末级项目'
        from cost_dept_dri_share t
       inner JOIN cost_item_dict t4
          ON t4.group_id = t.group_id
         AND t4.hos_id = t.hos_id
         AND t4.copy_code = t.copy_code
         AND t.cost_item_id = t4.cost_item_id
       where t.group_id = prm_group_id
         and t.hos_id = prm_hos_id
         and t.copy_code = prm_copy_code
         and t.type_code <> '01'
         AND t4.is_last != 1;
  
    --检查成本项目字典是否配置分摊类型
    insert into COST_MESSAGE_CHECK_SHARE
      (GROUP_ID,
       HOS_ID,
       COPY_CODE,
       MESSAGE_CODE,
       MESSAGE_NAME,
       MESSAGE_NOTE)
      select GROUP_ID,
             HOS_ID,
             COPY_CODE,
             t.cost_item_code,
             t.cost_item_name,
             '成本项目字典中没有配置分摊类型'
        from cost_dept_dri_share t
       where t.group_id = prm_group_id
         and t.hos_id = prm_hos_id
         and t.copy_code = prm_copy_code
         and t.type_code <> '01'
         and nvl(t.para_type_code, '9999999') = '9999999';
    --检查成本项目字典是否配置分摊类型
    insert into COST_MESSAGE_CHECK_SHARE
      (GROUP_ID,
       HOS_ID,
       COPY_CODE,
       MESSAGE_CODE,
       MESSAGE_NAME,
       MESSAGE_NOTE)
      select GROUP_ID,
             HOS_ID,
             COPY_CODE,
             t.cost_item_code,
             t.cost_item_name,
             '成本项目字典中配置的分摊类型在分摊类型字典中不存在'
        from cost_dept_dri_share t
       where t.group_id = prm_group_id
         and t.hos_id = prm_hos_id
         and t.copy_code = prm_copy_code
         and t.type_code <> '01'
         and nvl(t.para_type_name, '9999999') = '9999999';
  
    select count(*)
      into is_exists
      from COST_MESSAGE_CHECK_SHARE t
     where t.group_id = prm_group_id
       and t.hos_id = prm_hos_id
       and t.copy_code = prm_copy_code;
  
    IF (nvl(is_exists, 0) <> 0) THEN
      prm_AppCode := def_ERR;
      prm_ErrTxt  := '相关配置信息不全!';
      return;
    END IF;
  
    --加载数据
    prc_cost_type_para_load(prm_group_id, prm_hos_id, prm_copy_code);
  
    select count(*)
      into is_exists
      from cost_para_set_share t
     where t.group_id = prm_group_id
       and t.hos_id = prm_hos_id
       and t.copy_code = prm_copy_code;
  
    IF (nvl(is_exists, 0) = 0)
    
     THEN
    
      insert into COST_MESSAGE_CHECK_SHARE
        (GROUP_ID,
         HOS_ID,
         COPY_CODE,
         MESSAGE_CODE,
         MESSAGE_NAME,
         MESSAGE_NOTE)
      values
        (prm_group_id,
         prm_hos_id,
         prm_copy_code,
         '01',
         '分摊参数设置',
         '没有配置分摊参数设置 核算区间:' || prm_acc_year || prm_acc_month);
    
    else
      insert into COST_MESSAGE_CHECK_SHARE
        (GROUP_ID,
         HOS_ID,
         COPY_CODE,
         MESSAGE_CODE,
         MESSAGE_NAME,
         MESSAGE_NOTE)
        select GROUP_ID,
               HOS_ID,
               COPY_CODE,
               t.para_code,
               t.para_name,
               '分摊参数设置中没有配置分摊性质核算区间:' || prm_acc_year || prm_acc_month
          from cost_dept_dri_share t
         where t.group_id = prm_group_id
           and t.hos_id = prm_hos_id
           and t.copy_code = prm_copy_code
           and t.type_code <> '01'
           and not exists (select 1
                  from cost_para_set_share a
                 where a.group_id = t.group_id
                   and a.hos_id = t.hos_id
                   and a.copy_code = t.copy_code
                   and a.para_code = t.para_code);
    
      insert into COST_MESSAGE_CHECK_SHARE
        (GROUP_ID,
         HOS_ID,
         COPY_CODE,
         MESSAGE_CODE,
         MESSAGE_NAME,
         MESSAGE_NOTE)
        select GROUP_ID,
               HOS_ID,
               COPY_CODE,
               t.para_type_code,
               t.para_type_name,
               '分摊参数设置中没有配置分摊类型核算区间:' || prm_acc_year || prm_acc_month
          from cost_dept_dri_share t
         where t.group_id = prm_group_id
           and t.hos_id = prm_hos_id
           and t.copy_code = prm_copy_code
           and t.type_code <> '01'
           and not exists
         (select 1
                  from cost_para_set_share a
                 where a.group_id = t.group_id
                   and a.hos_id = t.hos_id
                   and a.copy_code = t.copy_code
                   and a.para_type_code = t.para_type_code);
      insert into COST_MESSAGE_CHECK_SHARE
        (GROUP_ID,
         HOS_ID,
         COPY_CODE,
         MESSAGE_CODE,
         MESSAGE_NAME,
         MESSAGE_NOTE)
        select GROUP_ID,
               HOS_ID,
               COPY_CODE,
               t.para_type_code,
               t.para_type_name,
               '分摊参数设置中没有配置分摊参数核算区间:' || prm_acc_year || prm_acc_month
          from cost_dept_dri_share t
         where t.group_id = prm_group_id
           and t.hos_id = prm_hos_id
           and t.copy_code = prm_copy_code
           and t.type_code <> '01'
           and not exists
         (select 1
                  from cost_para_set_share a
                 where a.group_id = t.group_id
                   and a.hos_id = t.hos_id
                   and a.copy_code = t.copy_code
                   and a.para_code = t.para_code
                   and a.para_type_code = t.para_type_code
                   and nvl(a.para_value, '9999999') != '9999999');
    
    END IF;
  
    select count(*)
      into is_exists
      from cost_para_dept_share t1
     where t1.group_id = prm_group_id
       and t1.hos_id = prm_hos_id
       and t1.copy_code = prm_copy_code;
  
    if (nvl(is_exists, 0) = 0) then
      insert into COST_MESSAGE_CHECK_SHARE
        (GROUP_ID,
         HOS_ID,
         COPY_CODE,
         MESSAGE_CODE,
         MESSAGE_NAME,
         MESSAGE_NOTE)
      values
        (prm_group_id,
         prm_hos_id,
         prm_copy_code,
         '02',
         '科室分摊设置',
         '没有配置服务科室分摊设置 核算区间:' || prm_acc_year || prm_acc_month);
    else
      insert into COST_MESSAGE_CHECK_SHARE
        (GROUP_ID,
         HOS_ID,
         COPY_CODE,
         MESSAGE_CODE,
         MESSAGE_NAME,
         MESSAGE_NOTE)
        select GROUP_ID,
               HOS_ID,
               COPY_CODE,
               t.dept_code,
               t.dept_name,
               '科室分摊设置中没有配置该服务科室核算区间:' || prm_acc_year || prm_acc_month
          from cost_dept_dri_share t
         where t.group_id = prm_group_id
           and t.hos_id = prm_hos_id
           and t.copy_code = prm_copy_code
           and t.type_code <> '01'
           and not exists (select 1
                  from cost_para_dept_share a
                 where a.group_id = t.group_id
                   and a.hos_id = t.hos_id
                   and a.copy_code = t.copy_code
                   and a.dept_id = t.dept_id)
           and t.dept_code is not null;
    end if;
    insert into COST_MESSAGE_CHECK_SHARE
      (GROUP_ID,
       HOS_ID,
       COPY_CODE,
       MESSAGE_CODE,
       MESSAGE_NAME,
       MESSAGE_NOTE)
      select GROUP_ID,
             HOS_ID,
             COPY_CODE,
             t.dept_code,
             t.dept_name,
             '科室分摊设置中没有配置该服务科室核算区间:' || prm_acc_year || prm_acc_month
        from cost_dept_dri_share t
       where t.group_id = prm_group_id
         and t.hos_id = prm_hos_id
         and t.copy_code = prm_copy_code
         and t.type_code <> '01'
         and not exists
       (select 1
                from (select a.group_id,
                             a.hos_id,
                             a.copy_code,
                             a.dept_id,
                             count(b.dept_id) v_amount
                        from cost_para_dept_share a
                        left join cost_para_server_dept_share b
                          on a.group_id = b.group_id
                         and a.hos_id = b.hos_id
                         and a.copy_code = b.copy_code
                         and a.bill_code = b.bill_code
                       group by a.group_id, a.hos_id, a.copy_code, a.dept_id) tt
               where tt.group_id = t.group_id
                 and tt.hos_id = t.hos_id
                 and tt.copy_code = t.copy_code
                 and tt.dept_id = t.dept_id
                 and tt.v_amount > 0)
         and t.dept_code is not null;
  
    --科室分摊参数总和为0 
    insert into COST_MESSAGE_CHECK_SHARE
      (GROUP_ID,
       HOS_ID,
       COPY_CODE,
       MESSAGE_CODE,
       MESSAGE_NAME,
       MESSAGE_NOTE)
      select t1.GROUP_ID,
             t1.HOS_ID,
             t1.COPY_CODE,
             t2.dept_code,
             t2.dept_name || ' ' || t2.para_type_name,
             '按' || t4.para_name || '分摊总和为0' || '按人员总和为0 直接成本无法向下分摊'
        from COST_DEPT_DIR_CHECK_SHARE t1
       inner join cost_dept_dri_share t2
          on t1.group_id = t2.group_id
         and t1.hos_id = t2.hos_id
         and t1.copy_code = t2.copy_code
         and t1.dept_id = t2.dept_id
        left join cost_dept_emp_check_share t3
          on t1.group_id = t3.group_id
         and t1.hos_id = t3.hos_id
         and t1.copy_code = t3.copy_code
         and t1.dept_id = t3.dept_id
        left join COST_DEPT_PARA_DICT t4
          on t1.group_id = t4.group_id
         and t1.hos_id = t4.hos_id
         and t1.copy_code = t4.copy_code
         and t1.para_value = t4.para_code
       where t1.group_id = prm_group_id
         and t1.hos_id = prm_hos_id
         and t1.copy_code = prm_copy_code
         and t2.type_code <> '01'
         and t2.dir_amount <> 0
         and t1.para_amount = 0
         and t3.para_amount = 0
         and t2.dept_code is not null;
  
    insert into COST_MESSAGE_CHECK_SHARE
      (GROUP_ID,
       HOS_ID,
       COPY_CODE,
       MESSAGE_CODE,
       MESSAGE_NAME,
       MESSAGE_NOTE)
      select t1.GROUP_ID,
             t1.HOS_ID,
             t1.COPY_CODE,
             t2.dept_code,
             t2.dept_name || ' ' || t2.para_type_name,
             '按' || t4.para_name || '分摊总和为0' || '默认按人员分摊 成本可分摊'
        from COST_DEPT_DIR_CHECK_SHARE t1
       inner join cost_dept_dri_share t2
          on t1.group_id = t2.group_id
         and t1.hos_id = t2.hos_id
         and t1.copy_code = t2.copy_code
         and t1.dept_id = t2.dept_id
        left join cost_dept_emp_check_share t3
          on t1.group_id = t3.group_id
         and t1.hos_id = t3.hos_id
         and t1.copy_code = t3.copy_code
         and t1.dept_id = t3.dept_id
        left join COST_DEPT_PARA_DICT t4
          on t1.group_id = t4.group_id
         and t1.hos_id = t4.hos_id
         and t1.copy_code = t4.copy_code
         and t1.para_value = t4.para_code
       where t1.group_id = prm_group_id
         and t1.hos_id = prm_hos_id
         and t1.copy_code = prm_copy_code
         and t2.type_code <> '01'
         and t2.dir_amount <> 0
         and t1.para_amount = 0
         and t3.para_amount <> 0
         and t2.dept_code is not null;
  
    select count(*)
      into is_exists
      from COST_MESSAGE_CHECK_SHARE t1
     where t1.group_id = prm_group_id
       and t1.hos_id = prm_hos_id
       and t1.copy_code = prm_copy_code;
  
    if (nvl(is_exists, 0) > 0) then
      prm_AppCode := def_ERR;
      prm_ErrTxt  := '相关配置信息不全!';
    else
      prm_AppCode := def_OK;
      prm_ErrTxt  := '验证成功!';
    end if;
  
  EXCEPTION
    WHEN OTHERS THEN
      prm_AppCode := def_ERR;
      prm_ErrTxt  := '验证分摊失败！' || SQLERRM;
  END prc_check_data;
END pkg_cost_app;
					
	]]></sql>

</root>

