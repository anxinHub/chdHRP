<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.budg.dao.common.BudgControlPlanExecMapper">
	
	<!-- 查询环节操作日期对应的月启始，结束日期，对应年启始日期，结束日期，预算年，预算月-->
	<select id="queryOperDateBeginEndDate" resultType="java.util.Map" parameterType="java.util.Map" >
	
	select to_char(aym.begin_date,'yyyy-MM-dd')  month_begin_date ,to_char(aym.end_date,'yyyy-MM-dd')  month_end_date, 
       ay.begin_date year_begin_date,ay.end_date year_end_date,
       aym.acc_year budg_year,aym.acc_month budg_month
      from ACC_YEAR_MONTH aym
      left join acc_year ay on aym.group_id = ay.group_id and aym.hos_id=ay.hos_id 
        and aym.copy_code = ay.copy_code
        and aym.acc_year = ay.acc_year	
			where aym.group_id =#{group_id,jdbcType=INTEGER}
			and aym.hos_id= #{hos_id,jdbcType=INTEGER}
			and aym.copy_code=#{copy_code,jdbcType=VARCHAR}
			--and to_date('2019-12-19','yyyy/MM/dd') between begin_date and end_date
			and to_date(#{oper_date,jdbcType=VARCHAR},'yyyy/MM/dd') between aym.begin_date and aym.end_date
		
	</select>
	<!-- 查询环节编码和控制节点是否在方案-->
	<select id="queryLinkCodeIsExists" resultType="java.lang.Integer" parameterType="java.util.Map" >
		select count(1)
			from BUDG_C_MAIN bcm
			where bcm.group_id = #{group_id,jdbcType=INTEGER}
			AND bcm.hos_id = #{hos_id,jdbcType=INTEGER}
			AND bcm.copy_code = #{copy_code,jdbcType=VARCHAR}
			AND bcm.budg_year = #{budg_year,jdbcType=VARCHAR}
			and Link_code = #{work_link_code,jdbcType=VARCHAR}
			
			and #{work_note_code,jdbcType=VARCHAR} in (
         	SELECT REGEXP_SUBSTR (CONT_NOTE, '[^,]+', 1,rownum) out_id
                from dual connect by rownum &lt;=LENGTH (CONT_NOTE) - LENGTH (regexp_replace(CONT_NOTE, ',', ''))+1
       		)
       		and bcm.is_start=1
	</select>
	<select id="queryLinkCodeMap" resultType="java.util.Map" parameterType="java.util.Map" >
		
		 select bcm.group_id,
         bcm.hos_id,
         bcm.copy_code,
         bcm.budg_year,
         bcm.plan_code,
         bcp.plan_name,
         bcm.mod_code,
         bcm.link_code,
         bcl.link_name,
         bcm.tab_code,
         bcm.cont_m,
         bcm.cont_l,
         bcm.cont_p,
         bcm.cont_w,
         bcm.cont_note,
         bcm.use_state,
         bcm.re_link ,
         (select use_state from BUDG_C_MAIN bcm2 
         	where bcm2.group_id=bcm.group_id
         	  and bcm2.hos_id=bcm.hos_id
         	  and bcm2.copy_code=bcm.copy_code
         	  and bcm2.budg_year=bcm.budg_year
         	  and bcm2.mod_code =bcm.mod_code
         	  and bcm2.plan_code = bcm.re_link
          ) re_state
          
      from BUDG_C_MAIN bcm
      left join BUDG_C_PLAN bcp 
        on bcm.group_id =bcp.group_id
        and bcm.hos_id =bcp.hos_id
        and bcm.copy_code =bcp.copy_code
        and bcm.budg_year =bcp.budg_year
        and bcm.plan_code =bcp.plan_code
      left join BUDG_C_LINK bcl
        on bcm.group_id =bcl.group_id
        and bcm.hos_id =bcl.hos_id
        and bcm.copy_code =bcl.copy_code
        and bcm.budg_year =bcl.budg_year
        and bcm.link_code =bcl.link_code
				
			where bcm.group_id = #{group_id,jdbcType=INTEGER}
			AND bcm.hos_id = #{hos_id,jdbcType=INTEGER}
			AND bcm.copy_code = #{copy_code,jdbcType=VARCHAR}
			AND bcm.budg_year = #{budg_year,jdbcType=VARCHAR}
			and bcm.link_code = #{work_link_code,jdbcType=VARCHAR}
			and bcm.is_start = 1
			and #{work_note_code,jdbcType=VARCHAR} in (
         	SELECT REGEXP_SUBSTR (CONT_NOTE, '[^,]+', 1,rownum) out_id
                from dual connect by rownum &lt;=LENGTH (CONT_NOTE) - LENGTH (regexp_replace(CONT_NOTE, ',', ''))+1
       		)
	</select>
	<select id="queryWorkBudgList" resultType="java.util.Map" parameterType="java.util.Map" >
		select hdd.dept_name, mtd.mat_type_name,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
  from 
  (
    select dept_id, mat_type_id,cont_l,cont_p,cont_w,
       occur_value,
        fun_budg_mat_matoutplan( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  mat_type_id,
                  #{tab_code,jdbcType=VARCHAR}
       ) plan_value,                         
       fun_budg_mat_matoutexec( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  mat_type_id,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      (
      select dept_id, mat_type_id,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select case when budg_type_table.cont_l ='01' then 0
                   WHEN budg_type_table.cont_l ='02' THEN 0
                   WHEN budg_type_table.cont_l ='03' THEN budg_dept_table.dept_id else 0 END dept_id ,
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    budg_type_table.mat_type_id ,mod.AMOUNT_MONEY
         from MAT_OUT_MAIN mom
         left join mat_out_detail mod 
              on mom.group_id=mod.group_id 
              and mom.hos_id=mod.hos_id 
              and mom.copy_code=mod.copy_code 
              and mom.out_id=mod.out_id
          left join mat_inv_dict mi 
              on mod.group_id=mi.group_id 
              and mod.hos_id=mi.hos_id 
              and mod.copy_code=mi.copy_code 
              and mod.inv_id=mi.inv_id
              and mi.is_stop =0
          left join mat_type_dict  mt2 
             on mi.group_id =mt2.group_id
             and mi.hos_id =mt2.hos_id
             and mi.copy_code=mt2.copy_code
             and mi.mat_type_id = mt2.mat_type_id
             and mt2.is_stop =0
          left join hos_dept_dict hdd
               on mom.group_id =hdd.group_id
               and mom.hos_id =hdd.hos_id
               and mom.dept_id = hdd.dept_id
               and hdd.is_stop = 0
          left join
             (
             select mt.mat_type_code,mt.mat_type_id, bcd.cont_l,bcd.cont_p,bcd.cont_w
               from  BUDG_C_DET bcd 
               left join mat_type_dict mt 
                 on bcd.group_id = mt.group_id
                 and bcd.hos_id = mt.hos_id
                 and bcd.copy_code=mt.copy_code
                 and bcd.item_code = mt.mat_type_id
                 and mt.is_stop =0
                 where bcd.group_id =#{group_id,jdbcType=INTEGER}
                   and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                   and bcd.copy_code =#{copy_code,jdbcType=VARCHAR}
                   and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                   and bcd.plan_code = #{plan_code,jdbcType=VARCHAR}
                   and bcd.link_code =#{work_link_code,jdbcType=VARCHAR}
                   and bcd.cont_w in ('02','03')
                   and bcd.cont_l is not null
                   and bcd.cont_p is not null
              ) budg_type_table on mt2.mat_type_code like budg_type_table.mat_type_code ||'%'
              left join (
                 select ada.dept_id, hd.dept_code from ACC_DEPT_ATTR ada
                   left join hos_dept_dict hd on ada.group_id=hd.group_id
                        and ada.hos_id =hd.hos_id
                        and ada.dept_id = hd.dept_id
                        and hd.is_stop =0
                     where ada.group_id =#{group_id,jdbcType=INTEGER}
                     and ada.hos_id=#{hos_id,jdbcType=INTEGER}
                     and ada.is_budg =1        
              ) budg_dept_table on hdd.dept_code like budg_dept_table.dept_code||'%'
           
           where mom.group_id=#{group_id,jdbcType=INTEGER}
           and mom.hos_id=#{hos_id,jdbcType=INTEGER}
           and mom.copy_code=#{copy_code,jdbcType=VARCHAR}
           and mom.out_id in (
         	  SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) out_id
                from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
           )
           and (mom.bus_type_code!=15 or mom.bus_type_code!=32)
           and budg_type_table.mat_type_code is not null
           and budg_dept_table.dept_id is not null
           
       ) basic_data
       
       group by dept_id,mat_type_id,cont_l,cont_p,cont_w
    ) budg_data 
 ) basic_data
 left join hos_dept_dict hdd on hdd.dept_id =basic_data.dept_id and hdd.is_stop=0 
 	and hdd.group_id = #{group_id,jdbcType=INTEGER} 
 	and hdd.hos_id =#{hos_id,jdbcType=INTEGER}
 left join mat_type_dict mtd on mtd.mat_type_id= basic_data.mat_type_id and mtd.is_stop=0 
 	and mtd.group_id = #{group_id,jdbcType=INTEGER} 
 	and mtd.hos_id =#{hos_id,jdbcType=INTEGER}
 	and mtd.copy_code=#{copy_code,jdbcType=VARCHAR}
 where basic_data.plan_value != -1 and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
	</select>
	<select id="queryWorkBudgListOne" resultType="java.util.Map" parameterType="java.util.Map" >
		select hdd.dept_name, -1 mat_type_name,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
  from 
  (
    select dept_id, mat_type_id,cont_l,cont_p,cont_w,
       occur_value,
        fun_budg_mat_matoutplan( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  -1,
                  #{tab_code,jdbcType=VARCHAR}
       ) plan_value,                         
       fun_budg_mat_matoutexec(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  -1,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      (
      select dept_id, mat_type_id,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select case when budg_type_table.cont_l ='01' then 0
                   WHEN budg_type_table.cont_l ='02' THEN 0
                   WHEN budg_type_table.cont_l ='03' THEN budg_dept_table.dept_id else 0 END dept_id ,
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    -1 mat_type_id ,mod.AMOUNT_MONEY
         from MAT_OUT_MAIN mom
         left join mat_out_detail mod 
              on mom.group_id=mod.group_id 
              and mom.hos_id=mod.hos_id 
              and mom.copy_code=mod.copy_code 
              and mom.out_id=mod.out_id     
          left join hos_dept_dict hdd
               on mom.group_id =hdd.group_id
               and mom.hos_id =hdd.hos_id
               and mom.dept_id = hdd.dept_id
               and hdd.is_stop = 0
          left join
             (
             select bcd.cont_l,bcd.cont_p,bcd.cont_w
               from  BUDG_C_MAIN bcd 
                 where bcd.group_id =#{group_id,jdbcType=INTEGER}
                   and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                   and bcd.copy_code =#{copy_code,jdbcType=VARCHAR}
                   and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                   and bcd.plan_code = #{plan_code,jdbcType=VARCHAR}
                   and bcd.link_code =#{work_link_code,jdbcType=VARCHAR}
                   and bcd.cont_w in ('02','03')
                   and bcd.cont_l is not null
                   and bcd.cont_p is not null
              ) budg_type_table on 1=1
              left join (
                 select ada.dept_id, hd.dept_code from ACC_DEPT_ATTR ada
                   left join hos_dept_dict hd on ada.group_id=hd.group_id
                        and ada.hos_id =hd.hos_id
                        and ada.dept_id = hd.dept_id
                        and hd.is_stop =0
                        
                     where ada.group_id =#{group_id,jdbcType=INTEGER}
                     and ada.hos_id=#{hos_id,jdbcType=INTEGER}
                     and ada.is_budg =1        
              ) budg_dept_table on hdd.dept_code like budg_dept_table.dept_code||'%'
           
           where mom.group_id=#{group_id,jdbcType=INTEGER}
           and mom.hos_id=#{hos_id,jdbcType=INTEGER}
           and mom.copy_code=#{copy_code,jdbcType=VARCHAR}
           and mom.out_id in (
             SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) out_id
                from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
           )
     
           and budg_dept_table.dept_id is not null
           
       ) basic_data
       
       group by dept_id,mat_type_id,cont_l,cont_p,cont_w
    ) budg_data 
 ) basic_data
 left join hos_dept_dict hdd on hdd.dept_id =basic_data.dept_id and hdd.is_stop=0 
 	and hdd.group_id = #{group_id,jdbcType=INTEGER} 
 	and hdd.hos_id =#{hos_id,jdbcType=INTEGER}
 where basic_data.plan_value != -1 and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
	</select>   
	<select id="queryWorkBudgListThree" resultType="java.util.Map" parameterType="java.util.Map" >
		select hdd.dept_name,-1 mat_type_name,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
  from 
  (
    select dept_id,-1 mat_type_id,cont_l,cont_p,cont_w,
       occur_value,
        fun_budg_mat_matoutplan( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  -1,
                  #{tab_code,jdbcType=VARCHAR}
       ) plan_value,                         
       fun_budg_mat_matoutexec( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  -2,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      (
      select dept_id,-1 mat_type_id,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select case when budg_type_table.cont_l ='01' then 0
                   WHEN budg_type_table.cont_l ='02' THEN 0
                   WHEN budg_type_table.cont_l ='03' THEN budg_dept_table.dept_id else 0 END dept_id ,
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    budg_type_table.mat_type_id ,mod.AMOUNT_MONEY
         from MAT_OUT_MAIN mom
         left join mat_out_detail mod 
              on mom.group_id=mod.group_id 
              and mom.hos_id=mod.hos_id 
              and mom.copy_code=mod.copy_code 
              and mom.out_id=mod.out_id
          left join mat_inv_dict mi 
              on mod.group_id=mi.group_id 
              and mod.hos_id=mi.hos_id 
              and mod.copy_code=mi.copy_code 
              and mod.inv_id=mi.inv_id
              and mi.is_stop =0
          left join mat_type_dict  mt2 
             on mi.group_id =mt2.group_id
             and mi.hos_id =mt2.hos_id
             and mi.copy_code=mt2.copy_code
             and mi.mat_type_id = mt2.mat_type_id
             and mt2.is_stop = 0
          left join hos_dept_dict hdd
               on mom.group_id =hdd.group_id
               and mom.hos_id =hdd.hos_id
               and mom.dept_id = hdd.dept_id
               and hdd.is_stop = 0
          left join
             (              
                select mt.mat_type_code,mt.mat_type_id, bcm.cont_l,bcm.cont_p,bcm.cont_w
                from  BUDG_C_DET bcd 
                 join Budg_C_Main bcm
                  on bcd.group_id = bcm.group_id
                   and bcd.hos_id = bcm.hos_id
                   and bcd.copy_code=bcm.copy_code
                   and bcd.plan_code =bcm.plan_code
                   and bcd.link_code =bcm.link_code
                   and bcd.MOD_CODE  =bcm.MOD_CODE
                   and bcd.budg_year =bcm.budg_year
                 left join mat_type_dict mt 
                   on bcd.group_id = mt.group_id
                   and bcd.hos_id = mt.hos_id
                   and bcd.copy_code=mt.copy_code
                   and bcd.item_code = mt.mat_type_id
                   and mt.is_stop=0
                   where bcd.group_id =#{group_id,jdbcType=INTEGER}
                     and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                     and bcd.copy_code =#{copy_code,jdbcType=VARCHAR}
                     and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                     and bcd.plan_code =#{plan_code,jdbcType=VARCHAR}
                     and bcd.link_code =#{work_link_code,jdbcType=VARCHAR}
                     and bcm.cont_w in ('02','03')
                     and bcm.cont_l is not null
                     and bcm.cont_p is not null
         
              ) budg_type_table on mt2.mat_type_code like budg_type_table.mat_type_code ||'%'
              left join (
                 select ada.dept_id, hd.dept_code 
                   from ACC_DEPT_ATTR ada
                   left join hos_dept_dict hd on ada.group_id=hd.group_id
                        and ada.hos_id =hd.hos_id
                        and ada.dept_id = hd.dept_id
                        and hd.is_stop =0   
                     where ada.group_id =#{group_id,jdbcType=INTEGER}
                     and ada.hos_id=#{hos_id,jdbcType=INTEGER}
                     and ada.is_budg =1        
              ) budg_dept_table on hdd.dept_code like budg_dept_table.dept_code||'%'
           
           where mom.group_id=#{group_id,jdbcType=INTEGER}
           and mom.hos_id=#{hos_id,jdbcType=INTEGER}
           and mom.copy_code=#{copy_code,jdbcType=VARCHAR}
           and mom.out_id in (
             SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) out_id
                from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
           )
     
           and budg_type_table.mat_type_code is not null
           and budg_dept_table.dept_id is not null
           
       ) basic_data
       
       group by dept_id,cont_l,cont_p,cont_w
    ) budg_data 
 ) basic_data
 left join hos_dept_dict hdd on hdd.dept_id =basic_data.dept_id and hdd.is_stop=0
 	and hdd.group_id = #{group_id,jdbcType=INTEGER} 
 	and hdd.hos_id =#{hos_id,jdbcType=INTEGER}
 where basic_data.plan_value != -1 and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
 
	</select>
	<select id="queryBudgMatOutMedCostTwo" resultType="java.util.Map" parameterType="java.util.Map" >
		select hdd.dept_name, mtd.subj_name,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
  from 
  (
    select dept_id, cost_subj_code,cont_l,cont_p,cont_w,
       occur_value,
        fun_budg_medcost_matoutplan(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  cost_subj_code,
                  #{tab_code,jdbcType=VARCHAR},
                  'MAT_OUT'
       ) plan_value,
       fun_budg_medcost_matoutexec( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  cost_subj_code,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      (
      select dept_id,cost_subj_code,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select case when budg_type_table.cont_l ='01' then 0
                   WHEN budg_type_table.cont_l ='02' THEN duty_dept_table.duty_dept_id
                   WHEN budg_type_table.cont_l ='03' THEN budg_dept_table.dept_id else 0 END dept_id ,
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    budg_type_table.cost_subj_code ,mod.AMOUNT_MONEY
         from MAT_OUT_MAIN mom
         left join mat_out_detail mod 
              on mom.group_id=mod.group_id 
              and mom.hos_id=mod.hos_id 
              and mom.copy_code=mod.copy_code 
              and mom.out_id=mod.out_id
          left join mat_inv_dict mi 
              on mod.group_id=mi.group_id 
              and mod.hos_id=mi.hos_id 
              and mod.copy_code=mi.copy_code 
              and mod.inv_id=mi.inv_id
              and mi.is_stop =0
          left join mat_type_dict  mt2 
             on mi.group_id =mt2.group_id
             and mi.hos_id =mt2.hos_id
             and mi.copy_code=mt2.copy_code
             and mi.mat_type_id = mt2.mat_type_id
             and mt2.is_stop =0 
          left join
             ( 
             select bmts.mat_type_id,mtd.mat_type_code,cost_subj_code 
               from BUDG_MAT_TYPE_SUBJ bmts
               left join mat_type_dict mtd 
              on mtd.group_id= bmts.group_id
              and mtd.hos_id = bmts.hos_id
              and mtd.copy_code =bmts.copy_code
              and mtd.mat_type_id = bmts.mat_type_id
              and mtd.is_stop =0
              where bmts.group_id =#{group_id,jdbcType=INTEGER}
              and bmts.hos_id = #{hos_id,jdbcType=INTEGER}
              and bmts.copy_code= #{copy_code,jdbcType=VARCHAR}
              and bmts.budg_year =#{budg_year,jdbcType=VARCHAR}
            ) budg_subj on mt2.mat_type_code like budg_subj.mat_type_code ||'%'
          left join hos_dept_dict hdd 
               on mom.group_id =hdd.group_id
               and mom.hos_id =hdd.hos_id
               and mom.dept_id = hdd.dept_id
               and hdd.is_stop = 0
          left join 
             (
        
             select bcd.item_code cost_subj_code , bcd.cont_l,bcd.cont_p,bcd.cont_w
               from  BUDG_C_DET bcd 
                 where bcd.group_id =#{group_id,jdbcType=INTEGER}
                   and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                   and bcd.copy_code =#{copy_code,jdbcType=VARCHAR}
                   and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                   and bcd.plan_code = #{plan_code,jdbcType=VARCHAR}
                   and bcd.link_code =#{work_link_code,jdbcType=VARCHAR}
                   and bcd.cont_w in ('02','03')
                   and bcd.cont_l is not null
                   and bcd.cont_p is not null
              ) budg_type_table on budg_subj.cost_subj_code=budg_type_table.cost_subj_code
              left join (
                 select ada.dept_id, hd.dept_code from ACC_DEPT_ATTR ada
                   left join hos_dept_dict hd on ada.group_id=hd.group_id
                        and ada.hos_id =hd.hos_id
                        and ada.dept_id = hd.dept_id
                        and hd.is_stop =0            
                     where ada.group_id =#{group_id,jdbcType=INTEGER}
                     and ada.hos_id=#{hos_id,jdbcType=INTEGER}
                     and ada.is_budg =1        
              ) budg_dept_table on hdd.dept_code like budg_dept_table.dept_code||'%'
           left join (  
              select duty_dept_id ,dept_id,subj_code
              from BUDG_COST_DUTY_DEPT bcdd
              where bcdd.group_id =#{group_id,jdbcType=INTEGER} 
              and bcdd.hos_id =#{hos_id,jdbcType=INTEGER} 
              and bcdd.copy_code =#{copy_code,jdbcType=VARCHAR} 
              and bcdd.budg_year =#{budg_year,jdbcType=VARCHAR} 
           )  duty_dept_table on budg_dept_table.dept_id = duty_dept_table.dept_id
              and budg_type_table.cost_subj_code = duty_dept_table.subj_code
           where mom.group_id=#{group_id,jdbcType=INTEGER}
           and mom.hos_id=#{hos_id,jdbcType=INTEGER}
           and mom.copy_code=#{copy_code,jdbcType=VARCHAR}
           and mom.out_id in (
             SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) out_id
                from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
           )
           and (mom.bus_type_code!=15 or mom.bus_type_code!=32)
           and budg_type_table.cost_subj_code is not null
           and budg_dept_table.dept_id is not null 
           and ((budg_type_table.cont_l = '02'
            and duty_dept_id is not null)
          or budg_type_table.cont_l != '02')
       ) basic_data
       
       group by dept_id,cost_subj_code,cont_l,cont_p,cont_w
    ) budg_data 
 ) basic_data
 left join hos_dept_dict hdd on hdd.dept_id =basic_data.dept_id and hdd.is_stop=0 
 	  and hdd.group_id = #{group_id,jdbcType=INTEGER}
      and hdd.hos_id = #{hos_id,jdbcType=INTEGER}
 left join budg_cost_subj mtd on mtd.subj_code = basic_data.cost_subj_code 
      and mtd.group_id = #{group_id,jdbcType=INTEGER}
      and mtd.hos_id = #{hos_id,jdbcType=INTEGER}
      and mtd.copy_code = #{copy_code,jdbcType=VARCHAR}
      and mtd.budg_year =#{budg_year,jdbcType=VARCHAR}    
 where basic_data.plan_value != -1 and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
	</select>
	<select id="queryBudgMatOutMedCostOne" resultType="java.util.Map" parameterType="java.util.Map" >
		select hdd.dept_name,-1 subj_name,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
  from 
  (
    select dept_id, -1,cont_l,cont_p,cont_w,
       occur_value,
        fun_budg_medcost_matoutplan(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  -1,
                  #{tab_code,jdbcType=VARCHAR},
                  'MAT_OUT'
       ) plan_value,
       fun_budg_medcost_matoutexec( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  -1,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      (
      select dept_id,-1,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select case when budg_type_table.cont_l ='01' then 0
                   WHEN budg_type_table.cont_l ='02' THEN 0
                   WHEN budg_type_table.cont_l ='03' THEN budg_dept_table.dept_id else 0 END dept_id ,
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    -1 cost_subj_code ,mod.AMOUNT_MONEY
         from MAT_OUT_MAIN mom
         left join mat_out_detail mod 
              on mom.group_id=mod.group_id 
              and mom.hos_id=mod.hos_id 
              and mom.copy_code=mod.copy_code 
              and mom.out_id=mod.out_id
          left join mat_inv_dict mi 
              on mod.group_id=mi.group_id 
              and mod.hos_id=mi.hos_id 
              and mod.copy_code=mi.copy_code 
              and mod.inv_id=mi.inv_id
              and mi.is_stop =0
          left join mat_type_dict  mt2 
             on mi.group_id =mt2.group_id
             and mi.hos_id =mt2.hos_id
             and mi.copy_code=mt2.copy_code
             and mi.mat_type_id = mt2.mat_type_id
             and mt2.is_stop =0 
          left join
             ( 
             select bmts.mat_type_id,mtd.mat_type_code,cost_subj_code 
               from BUDG_MAT_TYPE_SUBJ bmts
               left join mat_type_dict mtd 
              on mtd.group_id= bmts.group_id
              and mtd.hos_id = bmts.hos_id
              and mtd.copy_code =bmts.copy_code
              and mtd.mat_type_id = bmts.mat_type_id
              and mtd.is_stop =0
              where bmts.group_id =#{group_id,jdbcType=INTEGER}
              and bmts.hos_id = #{hos_id,jdbcType=INTEGER}
              and bmts.copy_code= #{copy_code,jdbcType=VARCHAR}
              and bmts.budg_year =#{budg_year,jdbcType=VARCHAR}
            ) budg_subj on mt2.mat_type_code like budg_subj.mat_type_code ||'%'
          left join hos_dept_dict hdd 
               on mom.group_id =hdd.group_id
               and mom.hos_id =hdd.hos_id
               and mom.dept_id = hdd.dept_id
               and hdd.is_stop = 0
          left join 
              (
             select bcd.cont_l,bcd.cont_p,bcd.cont_w
               from  BUDG_C_MAIN bcd 
                 where bcd.group_id =#{group_id,jdbcType=INTEGER}
                   and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                   and bcd.copy_code =#{copy_code,jdbcType=VARCHAR}
                   and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                   and bcd.plan_code = #{plan_code,jdbcType=VARCHAR}
                   and bcd.link_code =#{work_link_code,jdbcType=VARCHAR}
                   and bcd.cont_w in ('02','03')
                   and bcd.cont_l is not null
                   and bcd.cont_p is not null
              ) budg_type_table on 1=1
              
              left join (
                 select ada.dept_id, hd.dept_code from ACC_DEPT_ATTR ada
                   left join hos_dept_dict hd on ada.group_id=hd.group_id
                        and ada.hos_id =hd.hos_id
                        and ada.dept_id = hd.dept_id
                        and hd.is_stop =0            
                     where ada.group_id =#{group_id,jdbcType=INTEGER}
                     and ada.hos_id=#{hos_id,jdbcType=INTEGER}
                     and ada.is_budg =1        
              ) budg_dept_table on hdd.dept_code like budg_dept_table.dept_code||'%'
           
           where mom.group_id=#{group_id,jdbcType=INTEGER}
           and mom.hos_id=#{hos_id,jdbcType=INTEGER}
           and mom.copy_code=#{copy_code,jdbcType=VARCHAR}
           and mom.out_id in (
             SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) out_id
                from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
           )
           and (mom.bus_type_code!=15 or mom.bus_type_code!=32)
           
           and budg_dept_table.dept_id is not null 
           
       ) basic_data
       
       group by dept_id,cont_l,cont_p,cont_w
    ) budg_data 
 ) basic_data
 left join hos_dept_dict hdd on hdd.dept_id =basic_data.dept_id and hdd.is_stop=0 
 	and hdd.group_id = #{group_id,jdbcType=INTEGER}
    and hdd.hos_id = #{hos_id,jdbcType=INTEGER}
 where basic_data.plan_value != -1 and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
	</select>
	<select id="queryBudgMatOutMedCostThree" resultType="java.util.Map" parameterType="java.util.Map" >
		select hdd.dept_name, -1 subj_name,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
  from 
  (
    select dept_id, -1 cost_subj_code,cont_l,cont_p,cont_w,
       occur_value,
        fun_budg_medcost_matoutplan(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  -2,
                  #{tab_code,jdbcType=VARCHAR},
                  'MAT_OUT'
       ) plan_value,
       fun_budg_medcost_matoutexec(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  -2,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      (
      select dept_id,-1 cost_subj_code,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select case when budg_type_table.cont_l ='01' then 0
                   WHEN budg_type_table.cont_l ='02' THEN 0
                   WHEN budg_type_table.cont_l ='03' THEN budg_dept_table.dept_id else 0 END dept_id ,
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    budg_type_table.cost_subj_code ,mod.AMOUNT_MONEY
         from MAT_OUT_MAIN mom
         left join mat_out_detail mod 
              on mom.group_id=mod.group_id 
              and mom.hos_id=mod.hos_id 
              and mom.copy_code=mod.copy_code 
              and mom.out_id=mod.out_id
          left join mat_inv_dict mi 
              on mod.group_id=mi.group_id 
              and mod.hos_id=mi.hos_id 
              and mod.copy_code=mi.copy_code 
              and mod.inv_id=mi.inv_id
              and mi.is_stop =0
          left join mat_type_dict  mt2 
             on mi.group_id =mt2.group_id
             and mi.hos_id =mt2.hos_id
             and mi.copy_code=mt2.copy_code
             and mi.mat_type_id = mt2.mat_type_id
             and mt2.is_stop =0 
          left join
             ( 
             select bmts.mat_type_id,mtd.mat_type_code,cost_subj_code 
               from BUDG_MAT_TYPE_SUBJ bmts
               left join mat_type_dict mtd 
              on mtd.group_id= bmts.group_id
              and mtd.hos_id = bmts.hos_id
              and mtd.copy_code =bmts.copy_code
              and mtd.mat_type_id = bmts.mat_type_id
              and mtd.is_stop =0
              where bmts.group_id =#{group_id,jdbcType=INTEGER}
              and bmts.hos_id = #{hos_id,jdbcType=INTEGER}
              and bmts.copy_code= #{copy_code,jdbcType=VARCHAR}
              and bmts.budg_year =#{budg_year,jdbcType=VARCHAR}
            ) budg_subj on mt2.mat_type_code like budg_subj.mat_type_code ||'%'
          left join hos_dept_dict hdd 
               on mom.group_id =hdd.group_id
               and mom.hos_id =hdd.hos_id
               and mom.dept_id = hdd.dept_id
               and hdd.is_stop = 0
          left join 
             (                   
              select bcd.item_code cost_subj_code, bcm.cont_l,bcm.cont_p,bcm.cont_w
                from  BUDG_C_DET bcd 
                 join Budg_C_Main bcm
                  on bcd.group_id = bcm.group_id
                   and bcd.hos_id = bcm.hos_id
                   and bcd.copy_code=bcm.copy_code
                   and bcd.plan_code =bcm.plan_code
                   and bcd.link_code =bcm.link_code
                   and bcd.MOD_CODE  =bcm.MOD_CODE
                   and bcd.budg_year =bcm.budg_year
                   where bcd.group_id =#{group_id,jdbcType=INTEGER}
                     and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                     and bcd.copy_code =#{copy_code,jdbcType=VARCHAR}
                     and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                     and bcd.plan_code =#{plan_code,jdbcType=VARCHAR}
                     and bcd.link_code =#{work_link_code,jdbcType=VARCHAR}
                     and bcm.cont_w in ('02','03')
                     and bcm.cont_l is not null
                     and bcm.cont_p is not null
                     
              ) budg_type_table on budg_subj.cost_subj_code=budg_type_table.cost_subj_code
              left join (
                 select ada.dept_id, hd.dept_code from ACC_DEPT_ATTR ada
                   left join hos_dept_dict hd on ada.group_id=hd.group_id
                        and ada.hos_id =hd.hos_id
                        and ada.dept_id = hd.dept_id
                        and hd.is_stop =0            
                     where ada.group_id =#{group_id,jdbcType=INTEGER}
                     and ada.hos_id=#{hos_id,jdbcType=INTEGER}
                     and ada.is_budg =1        
              ) budg_dept_table on hdd.dept_code like budg_dept_table.dept_code||'%'
           
           where mom.group_id=#{group_id,jdbcType=INTEGER}
           and mom.hos_id=#{hos_id,jdbcType=INTEGER}
           and mom.copy_code=#{copy_code,jdbcType=VARCHAR}
           and mom.out_id in (
             SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) out_id
                from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
           )
           and (mom.bus_type_code!=15 or mom.bus_type_code!=32)
           and budg_type_table.cost_subj_code is not null
           and budg_dept_table.dept_id is not null 
           
       ) basic_data
       
       group by dept_id,cont_l,cont_p,cont_w
    ) budg_data 
 ) basic_data
 left join hos_dept_dict hdd on hdd.dept_id =basic_data.dept_id and hdd.is_stop=0 
 	and hdd.group_id = #{group_id,jdbcType=INTEGER}
    and hdd.hos_id = #{hos_id,jdbcType=INTEGER}   
 where basic_data.plan_value != -1 and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
	</select>

	
	<select id="queryWorkBudgAssInList" resultType="java.util.Map" parameterType="java.util.Map" >
	select bcs.subj_name,occur_value, plan_value, exec_value, cont_l, cont_p, cont_w
   from (select  SUBJ_CODE,ass_type_id,
                cont_l,
                cont_p,
                cont_w,
                occur_value,
	 fun_budgcont_budgassinplan(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  cont_l,
                  cont_p,
                  ass_type_id
       ) plan_value,
       fun_budgcont_budgassinoexec(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  cont_l,
                  cont_p,
                  ass_type_id,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR},
                  #{naturs_code,jdbcType=VARCHAR}
                  
       ) exec_value
	 from (select  ass_type_id,
                        cont_l,
                        cont_p,
                        cont_w,
                        sum(in_money) occur_value
                   from (
                         
                         select  typ.ass_type_id,
                                 aim.in_money in_money,
                                 budg_type_table.cont_l,
                                 budg_type_table.cont_p,
                                 budg_type_table.cont_w
                           from ${ass_in_main} aim
                           left join ${ass_in_detail} adh
                             on aim.group_id = adh.group_id
                            and aim.hos_id = adh.hos_id
                            and aim.copy_code = adh.copy_code
                            and aim.ass_in_no = adh.ass_in_no
                           left join (select atd.ass_type_id, adi.ass_id
                                        from ASS_TYPE_DICT atd
                                        left join ass_dict adi
                                          on adi.group_id = atd.group_id
                                         and adi.hos_id = atd.hos_id
                                         and adi.copy_code = atd.copy_code
                                         and adi.ass_type_id = atd.ass_type_id
                                       where atd.group_id = #{group_id,jdbcType=INTEGER}
                                         and atd.hos_id =    #{hos_id,jdbcType=INTEGER}
                                         and atd.copy_code = #{copy_code,jdbcType=VARCHAR}
                                         and atd.ass_type_id in(
                                        select ad.ass_type_id
                                                from ass_dict ad
                                               where ad.ass_id in
                                                     (select ass_id
                                                        from ${ass_in_detail}
                                                        where group_id = #{group_id,jdbcType=INTEGER}
                                         and hos_id =    #{hos_id,jdbcType=INTEGER}
                                         and copy_code = #{copy_code,jdbcType=VARCHAR}) )
                                      ) typ
                             on adh.ass_id = typ.ass_id
                           left join （
                         select bcd.cont_l, bcd.cont_p, bcd.cont_w
                           from BUDG_C_DET bcd
                          where   bcd.group_id = #{group_id,jdbcType=INTEGER}
                            and bcd.hos_id =    #{hos_id,jdbcType=INTEGER}
                            and bcd.copy_code = #{copy_code,jdbcType=VARCHAR}
                            and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                            and bcd.plan_code = '04'
                            and bcd.link_code = 'ASS_IN'
                            and bcd.cont_w in ('02', '03')
                            and bcd.cont_l is not null
                            and bcd.cont_p is not null 
                             and bcd.item_code in ( select ad.ass_type_id
                                                from ass_dict ad
                                               where ad.ass_id in
                                                     (select ass_id
                                                        from ${ass_in_detail}
                                                        where group_id = #{group_id,jdbcType=INTEGER}
                                         and hos_id =    #{hos_id,jdbcType=INTEGER}
                                         and copy_code = #{copy_code,jdbcType=VARCHAR}) )              
                            
                            ）budg_type_table on
                          1 = 1
                            
           where aim.group_id=#{group_id,jdbcType=INTEGER}
           and aim.hos_id=#{hos_id,jdbcType=INTEGER}
           and aim.copy_code=#{copy_code,jdbcType=VARCHAR}
           and aim.ass_in_no in (
             SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) out_id
                from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
           )
                         ) basic_data
                  group by ass_type_id, cont_l, cont_p, cont_w) a   left join BUDG_ASSET_TYPY_COST_SHIP batc on a.ass_type_id=batc.asset_type_id) b
                       left join budg_cost_subj bcs on b.subj_code = bcs.subj_code
                       and  bcs.group_id = #{group_id,jdbcType=INTEGER}
                            and bcs.hos_id =    #{hos_id,jdbcType=INTEGER}
                            and bcs.copy_code = #{copy_code,jdbcType=VARCHAR}
                            and bcs.budg_year = #{budg_year,jdbcType=VARCHAR}
 where plan_value != -1 and plan_value - exec_value &lt; occur_value
	</select>

	<select id="queryBudgMatInMatPurTwo" resultType="java.util.Map" parameterType="java.util.Map" >
		select 0 dept_name, mtd.mat_type_name,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
  from 
  (
    select dept_id, mat_type_id,cont_l,cont_p,cont_w,
       occur_value,
        fun_budg_matpur_matinplan( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  mat_type_id,
                  #{tab_code,jdbcType=VARCHAR}
       ) plan_value,                         
       fun_budg_matpur_matinexec( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  mat_type_id,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      (
      select dept_id, mat_type_id,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select       0 dept_id , --只按全院处理
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    budg_type_table.mat_type_id,mod.AMOUNT_MONEY
         from mat_in_main mom
         left join mat_in_detail mod 
              on mom.group_id=mod.group_id 
              and mom.hos_id=mod.hos_id 
              and mom.copy_code=mod.copy_code 
              and mom.in_id=mod.in_id
          left join mat_inv_dict mi 
              on mod.group_id=mi.group_id 
              and mod.hos_id=mi.hos_id 
              and mod.copy_code=mi.copy_code 
              and mod.inv_id=mi.inv_id
              and mi.is_stop =0
          left join mat_type_dict  mt2 
             on mi.group_id =mt2.group_id
             and mi.hos_id =mt2.hos_id
             and mi.copy_code=mt2.copy_code
             and mi.mat_type_id = mt2.mat_type_id
             and mt2.is_stop =0
          left join
             (
             select mt.mat_type_code,mt.mat_type_id, bcd.cont_l,bcd.cont_p,bcd.cont_w
               from  BUDG_C_DET bcd 
               left join mat_type_dict mt 
                 on bcd.group_id = mt.group_id
                 and bcd.hos_id = mt.hos_id
                 and bcd.copy_code=mt.copy_code
                 and bcd.item_code = mt.mat_type_id
                 and mt.is_stop =0
                 where bcd.group_id =#{group_id,jdbcType=INTEGER}
                   and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                   and bcd.copy_code =#{copy_code,jdbcType=VARCHAR}
                   and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                   and bcd.plan_code = #{plan_code,jdbcType=VARCHAR}
                   and bcd.link_code =#{work_link_code,jdbcType=VARCHAR}
                   and bcd.cont_w in ('02','03')
                   and bcd.cont_l is not null
                   and bcd.cont_p is not null
              ) budg_type_table on mt2.mat_type_code like budg_type_table.mat_type_code ||'%'
                 
           where mom.group_id=#{group_id,jdbcType=INTEGER}
           and mom.hos_id=#{hos_id,jdbcType=INTEGER}
           and mom.copy_code=#{copy_code,jdbcType=VARCHAR}
           and mom.in_id in (
             SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) in_id
                from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
           )
           and mom.bus_type_code in (2,12,27,29,47,48) 
           and budg_type_table.mat_type_code is not null
       ) basic_data   
       group by dept_id,mat_type_id,cont_l,cont_p,cont_w
    ) budg_data 
 ) basic_data
 left join mat_type_dict mtd on mtd.mat_type_id= basic_data.mat_type_id and mtd.is_stop=0 
   and mtd.group_id = #{group_id,jdbcType=INTEGER} 
   and mtd.hos_id =#{hos_id,jdbcType=INTEGER}
   and mtd.copy_code=#{copy_code,jdbcType=VARCHAR}
   
 where basic_data.plan_value != -1 and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
	</select>

	<select id="queryBudgMatApplyMatInvTwo" resultType="java.util.Map" parameterType="java.util.Map" >
		--fun_budg_mat_matoutplan 
		--fun_budg_mat_matapplyplan 未写 共用占用同一预算值 0103
		select hdd.dept_name, mtd.mat_type_name,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
  from 
  (
    select dept_id, mat_type_id,cont_l,cont_p,cont_w,
       occur_value,
        fun_budg_mat_matoutplan(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  mat_type_id,
                  #{tab_code,jdbcType=VARCHAR}
       ) plan_value,                         
       fun_budg_mat_matapplyexec(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  mat_type_id,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      (
      select dept_id, mat_type_id,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select case when budg_type_table.cont_l ='01' then 0
                   WHEN budg_type_table.cont_l ='02' THEN 0
                   WHEN budg_type_table.cont_l ='03' THEN budg_dept_table.dept_id else 0 END dept_id ,
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    budg_type_table.mat_type_id ,mod.app_amount * mi.plan_price AMOUNT_MONEY
         from mat_apply_main mom
         left join mat_apply_detail mod 
              on mom.group_id=mod.group_id 
              and mom.hos_id=mod.hos_id 
              and mom.copy_code=mod.copy_code 
              and mom.apply_id=mod.apply_id
          left join mat_inv_dict mi 
              on mod.group_id=mi.group_id 
              and mod.hos_id=mi.hos_id 
              and mod.copy_code=mi.copy_code 
              and mod.inv_id=mi.inv_id
              and mi.is_stop =0
          left join mat_type_dict  mt2 
             on mi.group_id =mt2.group_id
             and mi.hos_id =mt2.hos_id
             and mi.copy_code=mt2.copy_code
             and mi.mat_type_id = mt2.mat_type_id
             and mt2.is_stop =0
          left join hos_dept_dict hdd
               on mom.group_id =hdd.group_id
               and mom.hos_id =hdd.hos_id
               and mom.dept_id = hdd.dept_id
               and hdd.is_stop = 0
          left join
             (
             select mt.mat_type_code,mt.mat_type_id, bcd.cont_l,bcd.cont_p,bcd.cont_w
               from  BUDG_C_DET bcd 
               left join mat_type_dict mt 
                 on bcd.group_id = mt.group_id
                 and bcd.hos_id = mt.hos_id
                 and bcd.copy_code=mt.copy_code
                 and bcd.item_code = mt.mat_type_id
                 and mt.is_stop =0
                 where bcd.group_id =#{group_id,jdbcType=INTEGER}
                   and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                   and bcd.copy_code =#{copy_code,jdbcType=VARCHAR}
                   and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                   and bcd.plan_code = #{plan_code,jdbcType=VARCHAR}
                   and bcd.link_code =#{work_link_code,jdbcType=VARCHAR}
                   and bcd.cont_w in ('02','03')
                   and bcd.cont_l is not null
                   and bcd.cont_p is not null
              ) budg_type_table on mt2.mat_type_code like budg_type_table.mat_type_code ||'%'
              left join (
                 select ada.dept_id, hd.dept_code from ACC_DEPT_ATTR ada
                   left join hos_dept_dict hd on ada.group_id=hd.group_id
                        and ada.hos_id =hd.hos_id
                        and ada.dept_id = hd.dept_id
                        and hd.is_stop =0
                     where ada.group_id =#{group_id,jdbcType=INTEGER}
                     and ada.hos_id=#{hos_id,jdbcType=INTEGER}
                     and ada.is_budg =1 
              ) budg_dept_table on hdd.dept_code like budg_dept_table.dept_code||'%'
           
           where mom.group_id=#{group_id,jdbcType=INTEGER}
           and mom.hos_id=#{hos_id,jdbcType=INTEGER}
           and mom.copy_code=#{copy_code,jdbcType=VARCHAR}
           and mom.apply_id in (
             SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) apply_id
                from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
           )
           and budg_type_table.mat_type_code is not null
           and budg_dept_table.dept_id is not null    
       ) basic_data
       
       group by dept_id,mat_type_id,cont_l,cont_p,cont_w
    ) budg_data 
 ) basic_data
 left join hos_dept_dict hdd on hdd.dept_id =basic_data.dept_id and hdd.is_stop=0 
   and hdd.group_id = #{group_id,jdbcType=INTEGER} 
   and hdd.hos_id =#{hos_id,jdbcType=INTEGER}
 left join mat_type_dict mtd on mtd.mat_type_id= basic_data.mat_type_id and mtd.is_stop=0 
   and mtd.group_id = #{group_id,jdbcType=INTEGER} 
   and mtd.hos_id =#{hos_id,jdbcType=INTEGER}
   and mtd.copy_code=#{copy_code,jdbcType=VARCHAR}
 where basic_data.plan_value != -1 and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
	</select>
	<select id="queryBudgMatApplyMedCostTwo" resultType="java.util.Map" parameterType="java.util.Map" >
		select hdd.dept_name, mtd.subj_name,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
  from 
  (
    select dept_id, cost_subj_code,cont_l,cont_p,cont_w,
       occur_value,
        fun_budg_medcost_matoutplan(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  cost_subj_code,
                  #{tab_code,jdbcType=VARCHAR},
                  'MAT_APPLY'
       ) plan_value,
       fun_budg_medcost_matapplyexec(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  cost_subj_code,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      (
      select dept_id,cost_subj_code,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select case when budg_type_table.cont_l ='01' then 0
                   WHEN budg_type_table.cont_l ='02' THEN duty_dept_table.duty_dept_id
                   WHEN budg_type_table.cont_l ='03' THEN budg_dept_table.dept_id else 0 END dept_id ,
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    budg_type_table.cost_subj_code ,mod.app_amount*mi.plan_price  AMOUNT_MONEY
         from MAT_APPLY_MAIN mom
         left join mat_apply_detail mod 
              on mom.group_id=mod.group_id 
              and mom.hos_id=mod.hos_id 
              and mom.copy_code=mod.copy_code 
              and mom.apply_id=mod.apply_id
          left join mat_inv_dict mi 
              on mod.group_id=mi.group_id 
              and mod.hos_id=mi.hos_id 
              and mod.copy_code=mi.copy_code 
              and mod.inv_id=mi.inv_id
              and mi.is_stop =0
          left join mat_type_dict  mt2 
             on mi.group_id =mt2.group_id
             and mi.hos_id =mt2.hos_id
             and mi.copy_code=mt2.copy_code
             and mi.mat_type_id = mt2.mat_type_id
             and mt2.is_stop =0 
          left join
             ( 
             select bmts.mat_type_id,mtd.mat_type_code,cost_subj_code 
               from BUDG_MAT_TYPE_SUBJ bmts
               left join mat_type_dict mtd 
              on mtd.group_id= bmts.group_id
              and mtd.hos_id = bmts.hos_id
              and mtd.copy_code =bmts.copy_code
              and mtd.mat_type_id = bmts.mat_type_id
              and mtd.is_stop =0
              where bmts.group_id =#{group_id,jdbcType=INTEGER}
              and bmts.hos_id = #{hos_id,jdbcType=INTEGER}
              and bmts.copy_code= #{copy_code,jdbcType=VARCHAR}
              and bmts.budg_year =#{budg_year,jdbcType=VARCHAR}
            ) budg_subj on mt2.mat_type_code like budg_subj.mat_type_code ||'%'
          left join hos_dept_dict hdd 
               on mom.group_id =hdd.group_id
               and mom.hos_id =hdd.hos_id
               and mom.dept_id = hdd.dept_id
               and hdd.is_stop = 0
          left join 
             (
        
             select bcd.item_code cost_subj_code , bcd.cont_l,bcd.cont_p,bcd.cont_w
               from  BUDG_C_DET bcd 
                 where bcd.group_id =#{group_id,jdbcType=INTEGER}
                   and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                   and bcd.copy_code =#{copy_code,jdbcType=VARCHAR}
                   and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                   and bcd.plan_code = #{plan_code,jdbcType=VARCHAR}
                   and bcd.link_code =#{work_link_code,jdbcType=VARCHAR}
                   and bcd.cont_w in ('02','03')
                   and bcd.cont_l is not null
                   and bcd.cont_p is not null
              ) budg_type_table on budg_subj.cost_subj_code=budg_type_table.cost_subj_code
              left join (
                 select ada.dept_id, hd.dept_code from ACC_DEPT_ATTR ada
                   left join hos_dept_dict hd on ada.group_id=hd.group_id
                        and ada.hos_id =hd.hos_id
                        and ada.dept_id = hd.dept_id
                        and hd.is_stop =0            
                     where ada.group_id =#{group_id,jdbcType=INTEGER}
                     and ada.hos_id=#{hos_id,jdbcType=INTEGER}
                     and ada.is_budg =1        
              ) budg_dept_table on hdd.dept_code like budg_dept_table.dept_code||'%'
           left join (  
              select duty_dept_id ,dept_id,subj_code
              from BUDG_COST_DUTY_DEPT bcdd
              where bcdd.group_id =#{group_id,jdbcType=INTEGER} 
              and bcdd.hos_id =#{hos_id,jdbcType=INTEGER} 
              and bcdd.copy_code =#{copy_code,jdbcType=VARCHAR} 
              and bcdd.budg_year =#{budg_year,jdbcType=VARCHAR} 
           )  duty_dept_table on budg_dept_table.dept_id = duty_dept_table.dept_id
              and budg_type_table.cost_subj_code = duty_dept_table.subj_code
           where mom.group_id=#{group_id,jdbcType=INTEGER}
           and mom.hos_id=#{hos_id,jdbcType=INTEGER}
           and mom.copy_code=#{copy_code,jdbcType=VARCHAR}
           and mom.apply_id in (
             SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) apply_id
                from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
           )
          
           and budg_type_table.cost_subj_code is not null
           and budg_dept_table.dept_id is not null 
           and ((budg_type_table.cont_l ='02' and duty_dept_id is not null) or budg_type_table.cont_l !='02')
       ) basic_data
       
       group by dept_id,cost_subj_code,cont_l,cont_p,cont_w
    ) budg_data 
 ) basic_data
 left join hos_dept_dict hdd on hdd.dept_id =basic_data.dept_id and hdd.is_stop=0 
     and hdd.group_id = #{group_id,jdbcType=INTEGER}
      and hdd.hos_id = #{hos_id,jdbcType=INTEGER}
 left join budg_cost_subj mtd on mtd.subj_code = basic_data.cost_subj_code 
      and mtd.group_id = #{group_id,jdbcType=INTEGER}
      and mtd.hos_id = #{hos_id,jdbcType=INTEGER}
      and mtd.copy_code = #{copy_code,jdbcType=VARCHAR}
      and mtd.budg_year =#{budg_year,jdbcType=VARCHAR}    
 where basic_data.plan_value != -1 and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
	</select>
	<select id="queryBudgMatApplyMedCostOne" resultType="java.util.Map" parameterType="java.util.Map" >
		select hdd.dept_name, mtd.subj_name,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
  from 
  (
    select dept_id, cost_subj_code,cont_l,cont_p,cont_w,
       occur_value,
        fun_budg_medcost_matoutplan(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  cost_subj_code,
                  #{tab_code,jdbcType=VARCHAR},
                  'MAT_APPLY'
       ) plan_value,
       fun_budg_medcost_matapplyexec(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  cost_subj_code,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      (
      select dept_id,cost_subj_code,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select case when budg_type_table.cont_l ='01' then 0
                   WHEN budg_type_table.cont_l ='02' THEN 0
                   WHEN budg_type_table.cont_l ='03' THEN budg_dept_table.dept_id else 0 END dept_id ,
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    -1 cost_subj_code,mod.app_amount*mi.plan_price  AMOUNT_MONEY
         from MAT_APPLY_MAIN mom
         left join mat_apply_detail mod 
              on mom.group_id=mod.group_id 
              and mom.hos_id=mod.hos_id 
              and mom.copy_code=mod.copy_code 
              and mom.apply_id=mod.apply_id
          left join mat_inv_dict mi 
              on mod.group_id=mi.group_id 
              and mod.hos_id=mi.hos_id 
              and mod.copy_code=mi.copy_code 
              and mod.inv_id=mi.inv_id
              and mi.is_stop =0
          left join mat_type_dict  mt2 
             on mi.group_id =mt2.group_id
             and mi.hos_id =mt2.hos_id
             and mi.copy_code=mt2.copy_code
             and mi.mat_type_id = mt2.mat_type_id
             and mt2.is_stop =0 
          left join
             ( 
             select bmts.mat_type_id,mtd.mat_type_code,cost_subj_code 
               from BUDG_MAT_TYPE_SUBJ bmts
               left join mat_type_dict mtd 
              on mtd.group_id= bmts.group_id
              and mtd.hos_id = bmts.hos_id
              and mtd.copy_code =bmts.copy_code
              and mtd.mat_type_id = bmts.mat_type_id
              and mtd.is_stop =0
              where bmts.group_id =#{group_id,jdbcType=INTEGER}
              and bmts.hos_id = #{hos_id,jdbcType=INTEGER}
              and bmts.copy_code= #{copy_code,jdbcType=VARCHAR}
              and bmts.budg_year =#{budg_year,jdbcType=VARCHAR}
            ) budg_subj on mt2.mat_type_code like budg_subj.mat_type_code ||'%'
          left join hos_dept_dict hdd 
               on mom.group_id =hdd.group_id
               and mom.hos_id =hdd.hos_id
               and mom.dept_id = hdd.dept_id
               and hdd.is_stop = 0
          left join 
             (
        
             select bcd.cont_l,bcd.cont_p,bcd.cont_w
               from  BUDG_C_MAIN bcd 
                 where bcd.group_id =#{group_id,jdbcType=INTEGER}
                   and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                   and bcd.copy_code =#{copy_code,jdbcType=VARCHAR}
                   and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                   and bcd.plan_code = #{plan_code,jdbcType=VARCHAR}
                   and bcd.link_code =#{work_link_code,jdbcType=VARCHAR}
                   and bcd.cont_w in ('02','03')
                   and bcd.cont_l is not null
                   and bcd.cont_p is not null
              ) budg_type_table on 1=1
              left join (
                 select ada.dept_id, hd.dept_code from ACC_DEPT_ATTR ada
                   left join hos_dept_dict hd on ada.group_id=hd.group_id
                        and ada.hos_id =hd.hos_id
                        and ada.dept_id = hd.dept_id
                        and hd.is_stop =0            
                     where ada.group_id =#{group_id,jdbcType=INTEGER}
                     and ada.hos_id=#{hos_id,jdbcType=INTEGER}
                     and ada.is_budg =1        
              ) budg_dept_table on hdd.dept_code like budg_dept_table.dept_code||'%'
           
           where mom.group_id=#{group_id,jdbcType=INTEGER}
           and mom.hos_id=#{hos_id,jdbcType=INTEGER}
           and mom.copy_code=#{copy_code,jdbcType=VARCHAR}
           and mom.apply_id in (
             SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) apply_id
                from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
           )                 
           and budg_dept_table.dept_id is not null 
           
       ) basic_data
       
       group by dept_id,cost_subj_code,cont_l,cont_p,cont_w
    ) budg_data 
 ) basic_data
 left join hos_dept_dict hdd on hdd.dept_id =basic_data.dept_id and hdd.is_stop=0 
     and hdd.group_id = #{group_id,jdbcType=INTEGER}
      and hdd.hos_id = #{hos_id,jdbcType=INTEGER}
 left join budg_cost_subj mtd on mtd.subj_code = basic_data.cost_subj_code 
      and mtd.group_id = #{group_id,jdbcType=INTEGER}
      and mtd.hos_id = #{hos_id,jdbcType=INTEGER}
      and mtd.copy_code = #{copy_code,jdbcType=VARCHAR}
      and mtd.budg_year =#{budg_year,jdbcType=VARCHAR}    
 where basic_data.plan_value != -1 and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
	</select>
	<select id="queryBudgMatApplyMedCostThree" resultType="java.util.Map" parameterType="java.util.Map" >
		select hdd.dept_name, 0 subj_name,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
  from 
  (
    select dept_id, cost_subj_code,cont_l,cont_p,cont_w,
       occur_value,
        fun_budg_medcost_matoutplan(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  cost_subj_code,
                  #{tab_code,jdbcType=VARCHAR},
                  'MAT_APPLY'
       ) plan_value,
       fun_budg_medcost_matapplyexec(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  cost_subj_code,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      (
      select dept_id,cost_subj_code,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select case when budg_type_table.cont_l ='01' then 0
                   WHEN budg_type_table.cont_l ='02' THEN 0
                   WHEN budg_type_table.cont_l ='03' THEN budg_dept_table.dept_id else 0 END dept_id ,
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    -2 cost_subj_code ,mod.app_amount*mi.plan_price  AMOUNT_MONEY
         from MAT_APPLY_MAIN mom
         left join mat_apply_detail mod 
              on mom.group_id=mod.group_id 
              and mom.hos_id=mod.hos_id 
              and mom.copy_code=mod.copy_code 
              and mom.apply_id=mod.apply_id
          left join mat_inv_dict mi 
              on mod.group_id=mi.group_id 
              and mod.hos_id=mi.hos_id 
              and mod.copy_code=mi.copy_code 
              and mod.inv_id=mi.inv_id
              and mi.is_stop =0
          left join mat_type_dict  mt2 
             on mi.group_id =mt2.group_id
             and mi.hos_id =mt2.hos_id
             and mi.copy_code=mt2.copy_code
             and mi.mat_type_id = mt2.mat_type_id
             and mt2.is_stop =0 
          left join
             ( 
             select bmts.mat_type_id,mtd.mat_type_code,cost_subj_code 
               from BUDG_MAT_TYPE_SUBJ bmts
               left join mat_type_dict mtd 
              on mtd.group_id= bmts.group_id
              and mtd.hos_id = bmts.hos_id
              and mtd.copy_code =bmts.copy_code
              and mtd.mat_type_id = bmts.mat_type_id
              and mtd.is_stop =0
              where bmts.group_id =#{group_id,jdbcType=INTEGER}
              and bmts.hos_id = #{hos_id,jdbcType=INTEGER}
              and bmts.copy_code= #{copy_code,jdbcType=VARCHAR}
              and bmts.budg_year =#{budg_year,jdbcType=VARCHAR}
            ) budg_subj on mt2.mat_type_code like budg_subj.mat_type_code ||'%'
          left join hos_dept_dict hdd 
               on mom.group_id =hdd.group_id
               and mom.hos_id =hdd.hos_id
               and mom.dept_id = hdd.dept_id
               and hdd.is_stop = 0
           join 
             (    
             select bcd.item_code cost_subj_code , bcm.cont_l,bcm.cont_p,bcm.cont_w
               from  BUDG_C_DET bcd 
                join BUDG_C_MAIN bcm on bcd.group_id =bcm.group_id
                	and bcd.hos_id =bcm.hos_id
                	and bcd.copy_code =bcm.copy_code
                	and bcd.budg_year =bcm.budg_year
                	and bcd.plan_code =bcm.plan_code
                	and bcd.link_code =bcm.link_code
                 where bcd.group_id =#{group_id,jdbcType=INTEGER}
                   and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                   and bcd.copy_code =#{copy_code,jdbcType=VARCHAR}
                   and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                   and bcd.plan_code = #{plan_code,jdbcType=VARCHAR}
                   and bcd.link_code =#{work_link_code,jdbcType=VARCHAR}
                   and bcm.cont_w in ('02','03')
                   and bcm.cont_l is not null
                   and bcm.cont_p is not null
              ) budg_type_table on budg_subj.cost_subj_code=budg_type_table.cost_subj_code
              left join (
                 select ada.dept_id, hd.dept_code from ACC_DEPT_ATTR ada
                   left join hos_dept_dict hd on ada.group_id=hd.group_id
                        and ada.hos_id =hd.hos_id
                        and ada.dept_id = hd.dept_id
                        and hd.is_stop =0            
                     where ada.group_id =#{group_id,jdbcType=INTEGER}
                     and ada.hos_id=#{hos_id,jdbcType=INTEGER}
                     and ada.is_budg =1        
              ) budg_dept_table on hdd.dept_code like budg_dept_table.dept_code||'%'
           
           where mom.group_id=#{group_id,jdbcType=INTEGER}
           and mom.hos_id=#{hos_id,jdbcType=INTEGER}
           and mom.copy_code=#{copy_code,jdbcType=VARCHAR}
           and mom.apply_id in (
             SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) apply_id
                from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
           )
          
           and budg_type_table.cost_subj_code is not null
           and budg_dept_table.dept_id is not null 
           
       ) basic_data
       
       group by dept_id,cost_subj_code,cont_l,cont_p,cont_w
    ) budg_data 
 ) basic_data
 left join hos_dept_dict hdd on hdd.dept_id =basic_data.dept_id and hdd.is_stop=0 
     and hdd.group_id = #{group_id,jdbcType=INTEGER}
      and hdd.hos_id = #{hos_id,jdbcType=INTEGER}
  
 where basic_data.plan_value != -1 and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
	</select>
	<select id="queryBudgMatPurMatPurTwo" resultType="java.util.Map" parameterType="java.util.Map" >
	--fun_budg_matpur_matinplan
	--fun_budg_matpur_matpurplan 与材料入库 采用同一预算方案 未写
		select 0 dept_name, mtd.mat_type_name,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
  from 
  (
    select dept_id, mat_type_id,cont_l,cont_p,cont_w,
       occur_value,
        fun_budg_matpur_matinplan( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  mat_type_id,
                  #{tab_code,jdbcType=VARCHAR}
       ) plan_value,                         
       fun_budg_matpur_matpurexec( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  mat_type_id,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      (
      select dept_id, mat_type_id,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select       0 dept_id , --只按全院处理
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    budg_type_table.mat_type_id,mod.amount*mod.price AMOUNT_MONEY
         from MAT_PUR_MAIN mom
         left join mat_pur_detail mod 
              on mom.group_id=mod.group_id 
              and mom.hos_id=mod.hos_id 
              and mom.copy_code=mod.copy_code 
              and mom.pur_id=mod.pur_id
          left join mat_inv_dict mi 
              on mod.group_id=mi.group_id 
              and mod.hos_id=mi.hos_id 
              and mod.copy_code=mi.copy_code 
              and mod.inv_id=mi.inv_id
              and mi.is_stop =0
          left join mat_type_dict  mt2 
             on mi.group_id =mt2.group_id
             and mi.hos_id =mt2.hos_id
             and mi.copy_code=mt2.copy_code
             and mi.mat_type_id = mt2.mat_type_id
             and mt2.is_stop =0
          left join
             (
             select mt.mat_type_code,mt.mat_type_id, bcd.cont_l,bcd.cont_p,bcd.cont_w
               from  BUDG_C_DET bcd 
               left join mat_type_dict mt 
                 on bcd.group_id = mt.group_id
                 and bcd.hos_id = mt.hos_id
                 and bcd.copy_code=mt.copy_code
                 and bcd.item_code = mt.mat_type_id
                 and mt.is_stop =0
                 where bcd.group_id =#{group_id,jdbcType=INTEGER}
                   and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                   and bcd.copy_code =#{copy_code,jdbcType=VARCHAR}
                   and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                   and bcd.plan_code = #{plan_code,jdbcType=VARCHAR}
                   and bcd.link_code =#{work_link_code,jdbcType=VARCHAR}
                   and bcd.cont_w in ('02','03')
                   and bcd.cont_l is not null
                   and bcd.cont_p is not null
              ) budg_type_table on mt2.mat_type_code like budg_type_table.mat_type_code ||'%'
                 
           where mom.group_id=#{group_id,jdbcType=INTEGER}
           and mom.hos_id=#{hos_id,jdbcType=INTEGER}
           and mom.copy_code=#{copy_code,jdbcType=VARCHAR}
           and mom.pur_id in (
             SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) pur_id
                from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
           )
           and budg_type_table.mat_type_code is not null
       ) basic_data   
       group by dept_id,mat_type_id,cont_l,cont_p,cont_w
    ) budg_data 
 ) basic_data
 left join mat_type_dict mtd on mtd.mat_type_id= basic_data.mat_type_id and mtd.is_stop=0 
   and mtd.group_id = #{group_id,jdbcType=INTEGER} 
   and mtd.hos_id =#{hos_id,jdbcType=INTEGER}
   and mtd.copy_code=#{copy_code,jdbcType=VARCHAR} 
 where basic_data.plan_value != -1 and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
	</select>
	<select id="queryBudgMatOrderMatPurTwo" resultType="java.util.Map" parameterType="java.util.Map" >
	--fun_budg_matpur_matinplan
	--fun_budg_matpur_matorderplan 与材料入库 采用同一预算方案 未写
	select 0 dept_name, mtd.mat_type_name,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
    from 
    (
    select dept_id, mat_type_id,cont_l,cont_p,cont_w,
       occur_value,
       fun_budg_matpur_matinplan( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  mat_type_id,
                  #{tab_code,jdbcType=VARCHAR}
       ) plan_value,                         
       fun_budg_matpur_matorderexec( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  mat_type_id,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      (
      select dept_id, mat_type_id,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select       0 dept_id , --只按全院处理
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    budg_type_table.mat_type_id,mod.amount*mod.price AMOUNT_MONEY
         from MAT_ORDER_MAIN mom
         left join MAT_ORDER_detail mod 
              on mom.group_id=mod.group_id 
              and mom.hos_id=mod.hos_id 
              and mom.copy_code=mod.copy_code
              and mom.order_id=mod.order_id
          left join mat_inv_dict mi 
              on mod.group_id=mi.group_id 
              and mod.hos_id=mi.hos_id 
              and mod.copy_code=mi.copy_code 
              and mod.inv_id=mi.inv_id
              and mi.is_stop =0
          left join mat_type_dict  mt2 
             on mi.group_id =mt2.group_id
             and mi.hos_id =mt2.hos_id
             and mi.copy_code=mt2.copy_code
             and mi.mat_type_id = mt2.mat_type_id
             and mt2.is_stop =0
          left join
             (
             select mt.mat_type_code,mt.mat_type_id, bcd.cont_l,bcd.cont_p,bcd.cont_w
               from  BUDG_C_DET bcd 
               left join mat_type_dict mt 
                 on bcd.group_id = mt.group_id
                 and bcd.hos_id = mt.hos_id
                 and bcd.copy_code=mt.copy_code
                 and bcd.item_code = mt.mat_type_id
                 and mt.is_stop =0
                 where bcd.group_id =#{group_id,jdbcType=INTEGER}
                   and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                   and bcd.copy_code =#{copy_code,jdbcType=VARCHAR}
                   and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                   and bcd.plan_code = #{plan_code,jdbcType=VARCHAR}
                   and bcd.link_code =#{work_link_code,jdbcType=VARCHAR}
                   and bcd.cont_w in ('02','03')
                   and bcd.cont_l is not null
                   and bcd.cont_p is not null
              ) budg_type_table on mt2.mat_type_code like budg_type_table.mat_type_code ||'%'
                 
           where mom.group_id=#{group_id,jdbcType=INTEGER}
           and mom.hos_id=#{hos_id,jdbcType=INTEGER}
           and mom.copy_code=#{copy_code,jdbcType=VARCHAR}
           and mom.order_id in (
             SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) order_id
                from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
           )
           and budg_type_table.mat_type_code is not null
       ) basic_data   
       group by dept_id,mat_type_id,cont_l,cont_p,cont_w
    ) budg_data 
 ) basic_data
 left join mat_type_dict mtd on mtd.mat_type_id= basic_data.mat_type_id and mtd.is_stop=0 
   and mtd.group_id = #{group_id,jdbcType=INTEGER} 
   and mtd.hos_id =#{hos_id,jdbcType=INTEGER}
   and mtd.copy_code=#{copy_code,jdbcType=VARCHAR} 
 where basic_data.plan_value != -1 and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
	</select>
	<select id="queryBudgAccVouchMedCostTwo" resultType="java.util.Map" parameterType="java.util.Map" >
	--fun_budg_matpur_matinplan
	--fun_budg_matpur_matorderplan 与材料入库 采用同一预算方案 未写
	--fun_budg_medcost_matoutplan 会计凭证 01 医疗支出预算
	select hdd.dept_name, mtd.subj_name ,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
    from 
    (
    select dept_id, subj_code,cont_l,cont_p,cont_w,
       occur_value,
       fun_budg_medcost_matoutplan( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  subj_code,
                  #{tab_code,jdbcType=VARCHAR},
                  'ACC_VOUCH'
       ) plan_value,                         
       fun_budg_medcost_accvouchexec( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  subj_code,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      ( 
      select dept_id, subj_code,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select       case when budg_type_table.cont_l ='01' then 0
                    WHEN budg_type_table.cont_l ='02' THEN duty_dept_table.duty_dept_id
                    WHEN budg_type_table.cont_l ='03' THEN budg_dept_table.dept_id else 0 END dept_id ,
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    budg_type_table.subj_code,occur_value AMOUNT_MONEY
            from
            (         
            select avc.check1_id,avc.subj_code,(nvl(DEBIT,0)) occur_value
                   from acc_vouch_check avc
                   left join acc_subj on  acc_subj.group_id=#{group_id,jdbcType=INTEGER} 
                   and acc_subj.hos_id=#{hos_id,jdbcType=INTEGER}
                   and acc_subj.copy_code=#{copy_code,jdbcType=VARCHAR} 
                   and acc_subj.acc_year =avc.acc_year
                   and acc_subj.subj_code = avc.subj_code
                   where  avc.group_id=#{group_id,jdbcType=INTEGER} 
                   and avc.hos_id=#{hos_id,jdbcType=INTEGER}
                   and avc.copy_code=#{copy_code,jdbcType=VARCHAR} 
                   and nvl(avc.DEBIT,0) !=0
                   and acc_subj.subj_type_code='05' 
                   and avc.check1_id is not null      
                   and avc.vouch_id in (
                   SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) vouch_id
                     from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
                   )                   
             ) vouch_data
             left join BUDG_ACC_SUBJ_SHIP bass 
                  on bass.group_id=#{group_id,jdbcType=INTEGER} 
                  and  bass.hos_id=#{hos_id,jdbcType=INTEGER}
                  and  bass.copy_code=#{copy_code,jdbcType=VARCHAR} 
                  and  bass.budg_year=#{budg_year,jdbcType=VARCHAR} 
                  and  vouch_data.subj_code= bass.ACC_SUBJ_CODE2
          left join
             (
             select bcd.item_code subj_code, bcd.cont_l,bcd.cont_p,bcd.cont_w
               from  BUDG_C_DET bcd 
                 where bcd.group_id =#{group_id,jdbcType=INTEGER} 
                   and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                   and bcd.copy_code =#{copy_code,jdbcType=VARCHAR} 
                   and bcd.budg_year = #{budg_year,jdbcType=VARCHAR} 
                   and bcd.plan_code = #{plan_code,jdbcType=VARCHAR}
                   and bcd.link_code = #{work_link_code,jdbcType=VARCHAR}
                   and bcd.cont_w in ('02','03')
                   and bcd.cont_l is not null
                   and bcd.cont_p is not null
              ) budg_type_table on bass.subj_code = budg_type_table.subj_code 
           left join hos_dept_dict hdd 
               on hdd.group_id =#{group_id,jdbcType=INTEGER} 
               and hdd.hos_id =#{hos_id,jdbcType=INTEGER}
               and vouch_data.check1_id = hdd.dept_id
               and hdd.is_stop = 0
           left join (
                 select ada.dept_id, hd.dept_code from ACC_DEPT_ATTR ada
                   left join hos_dept_dict hd on ada.group_id=hd.group_id
                        and ada.hos_id =hd.hos_id
                        and ada.dept_id = hd.dept_id
                        and hd.is_stop =0            
                     where ada.group_id =#{group_id,jdbcType=INTEGER} 
                     and ada.hos_id=#{hos_id,jdbcType=INTEGER} 
                     and ada.is_budg =1 
              ) budg_dept_table on hdd.dept_code like budg_dept_table.dept_code||'%'
           left join (  
              select duty_dept_id ,dept_id,subj_code
              from BUDG_COST_DUTY_DEPT bcdd
              where bcdd.group_id =#{group_id,jdbcType=INTEGER} 
              and bcdd.hos_id =#{hos_id,jdbcType=INTEGER} 
              and bcdd.copy_code =#{copy_code,jdbcType=VARCHAR} 
              and bcdd.budg_year =#{budg_year,jdbcType=VARCHAR} 
           )  duty_dept_table on budg_dept_table.dept_id = duty_dept_table.dept_id
              and budg_type_table.subj_code = duty_dept_table.subj_code
           where budg_type_table.subj_code is not null
            and budg_dept_table.dept_id is not null
            and ((budg_type_table.cont_l ='02' and duty_dept_id is not null) or budg_type_table.cont_l !='02')
         ) basic_data   
       group by dept_id,subj_code,cont_l,cont_p,cont_w
      ) budg_data 
   ) basic_data
   left join budg_cost_subj mtd on mtd.subj_code= basic_data.subj_code 
     and mtd.group_id = #{group_id,jdbcType=INTEGER} 
     and mtd.hos_id =#{hos_id,jdbcType=INTEGER}
     and mtd.copy_code=#{copy_code,jdbcType=VARCHAR} 
     and mtd.budg_year =#{budg_year,jdbcType=VARCHAR} 
   left join hos_dept_dict hdd on hdd.dept_id= basic_data.dept_id and hdd.is_stop=0 
    and hdd.group_id =#{group_id,jdbcType=INTEGER} 
    and hdd.hos_id =#{hos_id,jdbcType=INTEGER}
    
   where basic_data.plan_value != -1 
   and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
	</select>
	<select id="queryBudgAccVouchMedCostOne" resultType="java.util.Map" parameterType="java.util.Map" >
	--fun_budg_matpur_matinplan
	--fun_budg_matpur_matorderplan 与材料入库 采用同一预算方案 未写
	--fun_budg_medcost_matoutplan 会计凭证 01 医疗支出预算
	select hdd.dept_name, mtd.subj_name ,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
    from 
    (
    select dept_id, subj_code,cont_l,cont_p,cont_w,
       occur_value,
       fun_budg_medcost_matoutplan( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  subj_code,
                  #{tab_code,jdbcType=VARCHAR},
                  'ACC_VOUCH'
       ) plan_value,                         
       fun_budg_medcost_accvouchexec( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  subj_code,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      ( 
      select dept_id, subj_code,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select       case when budg_type_table.cont_l ='01' then 0
                    WHEN budg_type_table.cont_l ='02' THEN 0
                    WHEN budg_type_table.cont_l ='03' THEN budg_dept_table.dept_id else 0 END dept_id ,
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    -1 subj_code,
                    occur_value AMOUNT_MONEY
            from
            (         
            select avc.check1_id,avc.subj_code,(nvl(DEBIT,0)) occur_value
                   from acc_vouch_check avc
                   left join acc_subj on  acc_subj.group_id=#{group_id,jdbcType=INTEGER} 
                   and acc_subj.hos_id=#{hos_id,jdbcType=INTEGER}
                   and acc_subj.copy_code=#{copy_code,jdbcType=VARCHAR} 
                   and acc_subj.acc_year =avc.acc_year
                   and acc_subj.subj_code = avc.subj_code
                   where  avc.group_id=#{group_id,jdbcType=INTEGER} 
                   and avc.hos_id=#{hos_id,jdbcType=INTEGER}
                   and avc.copy_code=#{copy_code,jdbcType=VARCHAR} 
                   and nvl(avc.DEBIT,0) !=0
                   and acc_subj.subj_type_code='05' 
                   and avc.check1_id is not null      
                   and avc.vouch_id in (
                   SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) vouch_id
                     from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
                   )                   
             ) vouch_data
             left join BUDG_ACC_SUBJ_SHIP bass 
                  on bass.group_id=#{group_id,jdbcType=INTEGER} 
                  and  bass.hos_id=#{hos_id,jdbcType=INTEGER}
                  and  bass.copy_code=#{copy_code,jdbcType=VARCHAR} 
                  and  bass.budg_year=#{budg_year,jdbcType=VARCHAR} 
                  and  vouch_data.subj_code= bass.ACC_SUBJ_CODE2
          left join
             (
              select bcd.cont_l,bcd.cont_p,bcd.cont_w
               from  BUDG_C_MAIN bcd 
                 where bcd.group_id =#{group_id,jdbcType=INTEGER}
                   and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                   and bcd.copy_code =#{copy_code,jdbcType=VARCHAR}
                   and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                   and bcd.plan_code = #{plan_code,jdbcType=VARCHAR}
                   and bcd.link_code =#{work_link_code,jdbcType=VARCHAR}
                   and bcd.cont_w in ('02','03')
                   and bcd.cont_l is not null
                   and bcd.cont_p is not null
                   
              ) budg_type_table on 1=1
           left join hos_dept_dict hdd 
               on hdd.group_id =#{group_id,jdbcType=INTEGER} 
               and hdd.hos_id =#{hos_id,jdbcType=INTEGER}
               and vouch_data.check1_id = hdd.dept_id
               and hdd.is_stop = 0
           left join (
                 select ada.dept_id, hd.dept_code from ACC_DEPT_ATTR ada
                   left join hos_dept_dict hd on ada.group_id=hd.group_id
                        and ada.hos_id =hd.hos_id
                        and ada.dept_id = hd.dept_id
                        and hd.is_stop =0            
                     where ada.group_id =#{group_id,jdbcType=INTEGER} 
                     and ada.hos_id=#{hos_id,jdbcType=INTEGER} 
                     and ada.is_budg =1 
              ) budg_dept_table on hdd.dept_code like budg_dept_table.dept_code||'%'
                  
           where budg_dept_table.dept_id is not null
           
         ) basic_data   
       group by dept_id,subj_code,cont_l,cont_p,cont_w
      ) budg_data 
 	) basic_data
 	left join budg_cost_subj mtd on mtd.subj_code= basic_data.subj_code 
   	and mtd.group_id = #{group_id,jdbcType=INTEGER} 
   	and mtd.hos_id =#{hos_id,jdbcType=INTEGER}
   	and mtd.copy_code=#{copy_code,jdbcType=VARCHAR} 
   	and mtd.budg_year =#{budg_year,jdbcType=VARCHAR} 
 	left join hos_dept_dict hdd on hdd.dept_id= basic_data.dept_id and hdd.is_stop=0 
    and hdd.group_id =#{group_id,jdbcType=INTEGER} 
    and hdd.hos_id =#{hos_id,jdbcType=INTEGER}
    
 	where basic_data.plan_value != -1 
 	and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
	</select>
	<select id="queryBudgAccVouchMedCostThree" resultType="java.util.Map" parameterType="java.util.Map" >
	--fun_budg_matpur_matinplan
	--fun_budg_matpur_matorderplan 与材料入库 采用同一预算方案 未写
	--fun_budg_medcost_matoutplan 会计凭证 01 医疗支出预算
	select hdd.dept_name, mtd.subj_name ,occur_value,plan_value,exec_value,cont_l,cont_p,cont_w
    from 
    (
    select dept_id, subj_code,cont_l,cont_p,cont_w,
       occur_value,
       fun_budg_medcost_matoutplan( 
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  -2,
                  #{tab_code,jdbcType=VARCHAR},
                  'ACC_VOUCH'
       ) plan_value,                         
       fun_budg_medcost_accvouchexec(
                  #{group_id,jdbcType=INTEGER},
                  #{hos_id,jdbcType=INTEGER},
                  #{copy_code,jdbcType=VARCHAR},
                  #{budg_year,jdbcType=VARCHAR},
                  #{budg_month,jdbcType=VARCHAR},
                  dept_id,
                  cont_l,
                  cont_p,
                  -2,
                  #{tab_code,jdbcType=VARCHAR},
                  #{use_state,jdbcType=VARCHAR},
                  #{re_link,jdbcType=VARCHAR},
                  #{re_state,jdbcType=VARCHAR},
                  #{work_select_id,jdbcType=VARCHAR},
                  #{year_begin_date,jdbcType=VARCHAR},
                  #{year_end_date,jdbcType=VARCHAR},
                  #{month_begin_date,jdbcType=VARCHAR},
                  #{month_end_date,jdbcType=VARCHAR}
       ) exec_value
      from 
      ( 
      select dept_id, subj_code,cont_l,cont_p,cont_w,sum(AMOUNT_MONEY) occur_value
          from (
       select       case when budg_type_table.cont_l ='01' then 0
                    WHEN budg_type_table.cont_l ='02' THEN 0
                    WHEN budg_type_table.cont_l ='03' THEN budg_dept_table.dept_id else 0 END dept_id ,
                    budg_type_table.cont_l,
                    budg_type_table.cont_p,
                    budg_type_table.cont_w,
                    -2 subj_code,
                    occur_value AMOUNT_MONEY
            from
            (         
            select avc.check1_id,avc.subj_code,(nvl(DEBIT,0)) occur_value
                   from acc_vouch_check avc
                   left join acc_subj on  acc_subj.group_id=#{group_id,jdbcType=INTEGER} 
                   and acc_subj.hos_id=#{hos_id,jdbcType=INTEGER}
                   and acc_subj.copy_code=#{copy_code,jdbcType=VARCHAR} 
                   and acc_subj.acc_year =avc.acc_year
                   and acc_subj.subj_code = avc.subj_code
                   where  avc.group_id=#{group_id,jdbcType=INTEGER} 
                   and avc.hos_id=#{hos_id,jdbcType=INTEGER}
                   and avc.copy_code=#{copy_code,jdbcType=VARCHAR} 
                   and nvl(avc.DEBIT,0) !=0
                   and acc_subj.subj_type_code='05' 
                   and avc.check1_id is not null      
                   and avc.vouch_id in (
                   SELECT REGEXP_SUBSTR ( #{work_select_id,jdbcType=VARCHAR} , '[^,]+', 1,rownum) vouch_id
                     from dual connect by rownum &lt;=LENGTH (#{work_select_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{work_select_id,jdbcType=VARCHAR}, ',', ''))+1
                   )                   
             ) vouch_data
             left join BUDG_ACC_SUBJ_SHIP bass 
                  on bass.group_id=#{group_id,jdbcType=INTEGER} 
                  and  bass.hos_id=#{hos_id,jdbcType=INTEGER}
                  and  bass.copy_code=#{copy_code,jdbcType=VARCHAR} 
                  and  bass.budg_year=#{budg_year,jdbcType=VARCHAR} 
                  and  vouch_data.subj_code= bass.ACC_SUBJ_CODE2
          
           left join
             (              
                select bcd.item_code subj_code, bcm.cont_l,bcm.cont_p,bcm.cont_w
                from  BUDG_C_DET bcd 
                 join Budg_C_Main bcm
                  on bcd.group_id = bcm.group_id
                   and bcd.hos_id = bcm.hos_id
                   and bcd.copy_code=bcm.copy_code
                   and bcd.plan_code =bcm.plan_code
                   and bcd.link_code =bcm.link_code
                   and bcd.MOD_CODE  =bcm.MOD_CODE
                   and bcd.budg_year =bcm.budg_year
                 left join mat_type_dict mt 
                   on bcd.group_id = mt.group_id
                   and bcd.hos_id = mt.hos_id
                   and bcd.copy_code=mt.copy_code
                   and bcd.item_code = mt.mat_type_id
                   and mt.is_stop=0
                   where bcd.group_id =#{group_id,jdbcType=INTEGER}
                     and bcd.hos_id =#{hos_id,jdbcType=INTEGER}
                     and bcd.copy_code =#{copy_code,jdbcType=VARCHAR}
                     and bcd.budg_year = #{budg_year,jdbcType=VARCHAR}
                     and bcd.plan_code =#{plan_code,jdbcType=VARCHAR}
                     and bcd.link_code =#{work_link_code,jdbcType=VARCHAR}
                     and bcm.cont_w in ('02','03')
                     and bcm.cont_l is not null
                     and bcm.cont_p is not null
         
              ) budg_type_table on budg_type_table.subj_code = bass.subj_code
              
           left join hos_dept_dict hdd 
               on hdd.group_id =#{group_id,jdbcType=INTEGER} 
               and hdd.hos_id =#{hos_id,jdbcType=INTEGER}
               and vouch_data.check1_id = hdd.dept_id
               and hdd.is_stop = 0
           left join (
                 select ada.dept_id, hd.dept_code from ACC_DEPT_ATTR ada
                   left join hos_dept_dict hd on ada.group_id=hd.group_id
                        and ada.hos_id =hd.hos_id
                        and ada.dept_id = hd.dept_id
                        and hd.is_stop =0
                     where ada.group_id =#{group_id,jdbcType=INTEGER} 
                     and ada.hos_id=#{hos_id,jdbcType=INTEGER} 
                     and ada.is_budg =1 
              ) budg_dept_table on hdd.dept_code like budg_dept_table.dept_code||'%'
                  
           where budg_dept_table.dept_id is not null
             and budg_type_table.subj_code is not null
         ) basic_data   
       group by dept_id,subj_code,cont_l,cont_p,cont_w
      ) budg_data 
 	) basic_data
 	left join budg_cost_subj mtd on mtd.subj_code= basic_data.subj_code 
   	and mtd.group_id = #{group_id,jdbcType=INTEGER} 
   	and mtd.hos_id =#{hos_id,jdbcType=INTEGER}
   	and mtd.copy_code=#{copy_code,jdbcType=VARCHAR} 
   	and mtd.budg_year =#{budg_year,jdbcType=VARCHAR} 
 	left join hos_dept_dict hdd on hdd.dept_id= basic_data.dept_id and hdd.is_stop=0 
    and hdd.group_id =#{group_id,jdbcType=INTEGER} 
    and hdd.hos_id =#{hos_id,jdbcType=INTEGER}
    
 	where basic_data.plan_value != -1 
 	and basic_data.plan_value - basic_data.exec_value &lt; basic_data.occur_value
	</select>
</mapper>

