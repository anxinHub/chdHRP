<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.hpm.dao.AphiEmpBonusDataMapper">

	<resultMap id="empBonusData" type="com.chd.hrp.hpm.entity.AphiEmpBonusData">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />   
		<result property="copy_code" column="copy_code" />
		<result property="acct_year" column="acct_year" />
		<result property="acct_month" column="acct_month" />
		<result property="emp_id" column="emp_id" />
		<result property="emp_no" column="emp_no" />
		<result property="emp_code" column="emp_code" />
		<result property="emp_name" column="emp_name" />
		<result property="duty_name" column="duty_name" />
		<result property="dept_id" column="dept_id" />
		<result property="dept_no" column="dept_no" />
		<result property="dept_code" column="dept_code" />
		<result property="dept_kind_code" column="dept_kind_code" />
		<result property="dept_name" column="dept_name" />
		<result property="bonus_money" column="bonus_money" />
		<result property="formula_code" column="formula_code" />
		<result property="method_code" column="method_code" />
		<result property="grant_money" column="grant_money" />
		<result property="item_code" column="item_code" />
		<result property="item_name" column="item_name"/>
		
		<result property="is_audit" column="is_audit" />
		<result property="bonus_money_dept" column="bonus_money_dept" />
		<result property="emp_duty_amount" column="emp_duty_amount" />
		<result property="dept_duty_amount" column="dept_duty_amount" />
		
		<result property="is_grant" column="is_grant" />
		<result property="grant_date" column="grant_date" />
		<result property="grant_code" column="grant_code" />
		
		<result property="is_two_audit" column="is_two_audit" />
	</resultMap>

	<resultMap id="emp" type="com.chd.hrp.hpm.entity.AphiEmp">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="emp_id" column="emp_id" />
		<result property="emp_no" column="emp_no" />
		<result property="dept_id" column="dept_id" />
		<result property="dept_no" column="dept_no" />
		<result property="emp_code" column="emp_code" />
		<result property="emp_name" column="emp_name" />
	</resultMap>

	<!-- useGeneratedKeys="true" keyProperty="xxx" for sqlserver and mysql -->
	<insert id="addEmpBonusData" useGeneratedKeys="true">

		INSERT INTO aphi_emp_bonus_data (
		group_id ,
		hos_id,
		copy_code ,
		acct_year ,
		acct_month ,
		emp_id ,
		emp_no ,
		dept_id,
		dept_no,
		is_audit,
		item_code,
		bonus_money
		) VALUES (
		#{group_id} ,
		#{hos_id},
		#{copy_code} ,
		#{acct_year} ,
		#{acct_month} ,
		#{emp_id} ,
		#{emp_no} ,
		#{dept_id} ,
		#{dept_no} ,
		#{is_audit} ,
		#{item_code},
		#{bonus_money}
		)

	</insert>
	
	<insert id="addBatchEmpBonusData" parameterType="java.util.List">

		INSERT INTO aphi_emp_bonus_data (group_id ,
		hos_id,
		copy_code ,
		acct_year ,
		acct_month ,
		dept_id,
		dept_no,
		emp_id ,
		emp_no ,
		is_audit,
		item_code,
		bonus_money,
		is_grant,
		is_two_audit)
		<foreach  collection="list" item="item" index="index" 
			separator="union all">
			select
			#{item.group_id} ,
			#{item.hos_id},
			#{item.copy_code} ,
			#{item.acct_year} ,
			#{item.acct_month} ,
			#{item.dept_id} ,
			#{item.dept_no} ,
			#{item.emp_id} ,
			#{item.emp_no} ,
			#{item.is_audit} ,
			#{item.item_code} ,
			round(#{item.bonus_money},2),
			#{item.is_grant} ,
			#{item.is_two_audit} 
			from dual
		</foreach>
	</insert>

	<update id="updateEmpBonusData" parameterType="java.util.Map">
		UPDATE aphi_emp_bonus_data
			<trim prefix="SET" suffixOverrides=",">
				<if test="bonus_money != null">
					bonus_money = #{bonus_money},
				</if>
				<if test="is_audit != null">
					is_audit = #{is_audit},
				</if>
				<if test="user_code != null">
					user_code = #{user_code},
				</if>
				<if test="audit_date != null">
					audit_date = #{audit_date},
				</if>
				<if test="is_two_audit != null">
					is_two_audit = #{is_two_audit},
				</if>
				<if test="two_user_code != null">
					two_user_code = #{two_user_code},
				</if>
				<if test="two_audit_date != null">
					two_audit_date = #{two_audit_date},
				</if>
			</trim>
			<where>
				<if test="group_id != null and group_id != ''">
					AND group_id = #{group_id}
				</if>
				<if test="hos_id != null and hos_id != ''">
					AND hos_id = #{hos_id}
				</if>
				<if test="copy_code != null and copy_code != ''">
					AND copy_code = #{copy_code}
				</if>
				<if test="acct_month != null and acct_month != ''">
					AND acct_month = #{acct_month}
				</if>
				<if test="acc_year != null and acc_year != ''">
					AND acc_year = #{acc_year}
				</if>
				<if test="dept_id != null and dept_id != ''">
					AND dept_id = #{dept_id}
				</if>
				<if test="dept_no != null and dept_no != ''">
					AND dept_no = #{dept_no}
				</if>
				<if test="emp_id != null and emp_id != ''">
					AND emp_id = #{emp_id}
				</if>
				<if test="emp_no != null and emp_no != ''">
					AND emp_no = #{emp_no}
				</if>
				<if test="item_code != null and item_code != '' ">
					AND item_code = #{item_code}
				</if>
				<!-- and bonus_money ! = 0 -->
			</where>
	</update>

	<delete id="deleteEmpBonusData" parameterType="java.util.Map">

		DELETE FROM APHI_EMP_BONUS_DATA
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND acct_month = #{acct_month}
			</if>
			<if test="emp_id != null and emp_id != ''">
				AND emp_id = #{emp_id}
			</if>
			<if test="emp_no != null and emp_no != ''">
				AND emp_no = #{emp_no}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND emp_id = #{emp_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				AND dept_no = #{dept_no}
			</if>
			<if test="item_code != null and item_code != ''">
				AND item_code = #{item_code}
			</if>
		</where>

	</delete>
	
	<delete id="deleteEmpBonusDataByPerm" parameterType="java.util.Map">

		DELETE FROM APHI_EMP_BONUS_DATA
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND acct_month = #{acct_month}
			</if>
			<if test="item_code != null and item_code != ''">
				AND item_code = #{item_code}
			</if>
			<if test="emp_id != null and emp_id != ''">
				AND emp_id = #{emp_id}
			</if>
			<if test="emp_no != null and emp_no != ''">
				AND emp_no = #{emp_no}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				AND dept_no = #{dept_no}
			</if>
			and exists(
				select 1 from v_user_data_perm a where a.group_id = #{group_id}
				and a.hos_id = #{hos_id} and a.copy_code = #{copy_code}
				and a.user_id = #{user_id}
				and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
				and a.perm_code = dept_id and a.is_read = 1 and a.is_write = 1
			)
		</where>

	</delete>
	
	<delete id="deleteBatchEmpBonusData" parameterType="java.util.List">
		 
		<foreach item="item" index="index" collection="list" open="begin" separator=";" close=";end;">
			DELETE FROM APHI_EMP_BONUS_DATA
			<where>
			<if test="item.group_id != null and item.group_id != ''">
				AND group_id = #{item.group_id}
			</if>
			<if test="item.hos_id != null and item.hos_id != ''">
				and hos_id = #{item.hos_id}
			</if>
			<if test="item.copy_code != null and item.copy_code != ''">
				AND copy_code = #{item.copy_code}
			</if>
			<if test="item.acct_year != null and item.acct_year != ''">
				AND acct_year = #{item.acct_year}
			</if>
			<if test="item.acct_month != null and item.acct_month != ''">
				AND acct_month = #{item.acct_month}
			</if>
			<if test="item.emp_id != null and item.emp_id != ''">
				AND emp_id = #{item.emp_id}
			</if>
			<if test="item.emp_no != null and item.emp_no != ''">
				AND emp_no = #{item.emp_no}
			</if>
			<if test="item.dept_id != null and item.dept_id != ''">
				AND emp_id = #{item.emp_id}
			</if>
			<if test="item.dept_no != null and item.dept_no != ''">
				AND dept_no = #{item.dept_no}
			</if>
			</where>
		</foreach>
	</delete>

	<select id="queryEmpBonusDataByCode" resultType="com.chd.hrp.hpm.entity.AphiEmpBonusData"
		parameterType="string">

		select group_id, hos_id, copy_code, acct_year, acct_month, emp_id, emp_no, dept_id, dept_no, item_code, bonus_money, is_audit from aphi_emp_bonus_data
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND acct_month = #{acct_month}
			</if>
			<if test="emp_id != null and emp_id != ''">
				AND emp_id = #{emp_id}
			</if>
			<if test="emp_no != null and emp_no != ''">
				AND emp_no = #{emp_no}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				AND dept_no = #{dept_no}
			</if>
			<if test="item_code != null and item_code != ''">
				AND item_code = #{item_code}
			</if>
		</where>

	</select>
	
	<select id="queryEmpBonusDataByKey" resultMap="empBonusData" parameterType="java.util.Map">

		select group_id, hos_id, copy_code, acct_year, acct_month, emp_id, emp_no, dept_id, dept_no, item_code, bonus_money, is_audit ,is_two_audit from aphi_emp_bonus_data
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND acct_month = #{acct_month}
			</if>
			<if test="emp_id != null and emp_id != ''">
				AND emp_id = #{emp_id}
			</if>
			<if test="emp_no != null and emp_no != ''">
				AND emp_no = #{emp_no}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				AND dept_no = #{dept_no}
			</if>
			<if test="item_code != null and item_code != ''">
				AND item_code = #{item_code}
			</if>
			<if test="is_two_audit != null and is_two_audit != ''">
				AND is_two_audit = #{is_two_audit}
			</if>
			<if test="list !=null and list.size >0">
	     	 	AND 
	     	 	<foreach collection="list" index="index" item="item"  open="(" separator="OR" close=")">
				<if test="item.dept_id != null and item.dept_id != ''">
					 dept_id = #{item.dept_id} 
				</if>
				<if test="item.dept_no != null and item.dept_no != ''">
					AND dept_no = #{item.dept_no}  
				</if>
				<if test="item.item_codes != null and item.item_codes != ''">
					AND item_code = #{item.item_codes}  
				</if>
			</foreach>
	     	 </if>
		</where>

	</select>


	<select id="queryEmpBonusData" parameterType="java.util.Map" resultMap="empBonusData">

		select aebd.group_id,
	       aebd.hos_id,
	       aebd.copy_code,
	       aebd.acct_year,
	       aebd.acct_month,
	       aebd.emp_id,
	       aed.emp_no,
	       aed.emp_code,
	       aed.emp_name,
	       aebd.dept_id,
	       aebd.dept_no,
	       ad.dept_code,
	       ad.dept_name,
	       nvl(aebd.bonus_money, 0) as bonus_money,
	       aebd.is_audit,
	       aed.duty_code,
	       duty.duty_name,
	       aebd.item_code,
           aei.item_name
	  from aphi_emp_bonus_data aebd
	  
	  <if test="para_value == 0">
		  left join aphi_emp_dict aed
		    on aebd.emp_id = aed.emp_id
		   and aebd.group_id = aed.group_id
		   and aebd.copy_code = aed.copy_code
		   and aebd.hos_id = aed.hos_id
		   and aed.is_stop = 0
		   left join aphi_emp_duty duty
		    on aed.duty_code = duty.duty_code
		   and aebd.group_id = duty.group_id
		   and aebd.copy_code = duty.copy_code
		   and aebd.hos_id = duty.hos_id
	  </if>
	  
	  <if test="para_value == 1">
	  		left join V_APHI_EMP_DICT aed
		    on aebd.emp_id = aed.emp_id
		   and aebd.group_id = aed.group_id
		   and aebd.copy_code = aed.copy_code
		   and aebd.hos_id = aed.hos_id
		   and aed.is_stop = 0
		   left join V_APHI_EMP_DUTY duty
		    on aed.duty_code = duty.duty_code
		   and aebd.group_id = duty.group_id
		   and aebd.hos_id = duty.hos_id
	  </if>
	  
	  left join aphi_dept_dict ad
	    on aebd.dept_id = ad.dept_id
	   and aebd.dept_no = ad.dept_no
	   and aebd.group_id = ad.group_id
	   and aebd.copy_code = ad.copy_code
	   and aebd.hos_id = ad.hos_id
	  
	  left join aphi_emp_item aei
     	on
          aebd.group_id = aei.group_id
          and aebd.hos_id = aei.hos_id
          and aebd.copy_code = aei.copy_code
          and aebd.item_code = aei.item_code
          and aei.is_stop = 0
		<where>
			<if test="group_id != null and group_id != ''">
				AND aebd.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and aebd.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND aebd.copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND aebd.acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND aebd.acct_month = #{acct_month}
			</if>
			<if test="emp_id != null and emp_id != ''">
				AND aebd.emp_id = #{emp_id}
			</if>
			<if test="emp_no != null and emp_no != ''">
				AND aed.emp_no = #{emp_no}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND ad.dept_id = #{dept_id}
			</if>
			
			<if test="dept_no != null and dept_no != '' ">
				AND ad.dept_no = #{dept_no}
			</if>
			
			<if test="duty_code != null and duty_code != ''">
				AND aed.duty_code = #{duty_code}
			</if>
			
			<if test="emp_name != null and emp_name != ''">
				and (
			        aed.emp_name like '${emp_name}%'
			        or aed.spell_code like '${emp_name}%'
			        or aed.wbx_code like '${emp_name}%'
			    )
			</if>
			
			and exists(
				select 1 from v_user_data_perm a where a.group_id = #{group_id}
				and a.hos_id = #{hos_id} and a.copy_code = #{copy_code}
				and a.user_id = #{user_id}
				and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
				and a.perm_code = ad.dept_id and a.is_read = 1 and a.is_write = 1
			)
		</where>
		order by aebd.acct_year,aebd.acct_month,ad.dept_code,aed.emp_code asc
	</select>
	
	<select id="queryEmpBonusDataPrint" parameterType="java.util.Map" resultType="java.util.TreeMap">

		select aebd.group_id,
	       aebd.hos_id,
	       aebd.copy_code,
	       aebd.acct_year || aebd.acct_month AS acct_year_month,
	       aebd.emp_id,
	       aed.emp_no,
	       aed.emp_code,
	       aed.emp_name,
	       aebd.dept_id,
	       aebd.dept_no,
	       ad.dept_code,
	       ad.dept_name,
	       nvl(aebd.bonus_money, 0) as bonus_money,
	       aebd.is_audit,
	       aed.duty_code,
	       duty.duty_name,
	       aebd.item_code,
           aei.item_name
	  from aphi_emp_bonus_data aebd
	  
	  <if test="para_value == 0">
		  left join aphi_emp_dict aed
		    on aebd.emp_id = aed.emp_id
		   and aebd.group_id = aed.group_id
		   and aebd.copy_code = aed.copy_code
		   and aebd.hos_id = aed.hos_id
		   and aed.is_stop = 0
		    left join aphi_emp_duty duty
		    on aed.duty_code = duty.duty_code
		   and aebd.group_id = duty.group_id
		   and aebd.copy_code = duty.copy_code
		   and aebd.hos_id = duty.hos_id
	  </if>
	  
	  <if test="para_value == 1">
	  	  left join V_APHI_EMP_DICT aed
		    on aebd.emp_id = aed.emp_id
		   and aebd.group_id = aed.group_id
		   and aebd.copy_code = aed.copy_code
		   and aebd.hos_id = aed.hos_id
		   and aed.is_stop = 0
		    left join aphi_emp_duty duty
		    on aed.duty_code = duty.duty_code
		   and aebd.group_id = duty.group_id
		   and aebd.hos_id = duty.hos_id
	  </if>
	  
	  left join aphi_dept_dict ad
	    on aebd.dept_id = ad.dept_id
	   and aebd.dept_no = ad.dept_no
	   and aebd.group_id = ad.group_id
	   and aebd.copy_code = ad.copy_code
	   and aebd.hos_id = ad.hos_id
	 
	  left join aphi_emp_item aei
     	on
          aebd.group_id = aei.group_id
          and aebd.hos_id = aei.hos_id
          and aebd.copy_code = aei.copy_code
          and aebd.item_code = aei.item_code
          and aei.is_stop = 0
		<where>
			<if test="group_id != null and group_id != ''">
				AND aebd.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and aebd.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND aebd.copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND aebd.acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND aebd.acct_month = #{acct_month}
			</if>
			<if test="emp_id != null and emp_id != ''">
				AND aebd.emp_id = #{emp_id}
			</if>
			<if test="emp_no != null and emp_no != ''">
				AND aed.emp_no = #{emp_no}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND ad.dept_id = #{dept_id}
			</if>
			
			<if test="dept_no != null and dept_no != '' ">
				AND ad.dept_no = #{dept_no}
			</if>
			
			<if test="duty_code != null and duty_code != ''">
				AND aed.duty_code = #{duty_code}
			</if>
			
			<if test="emp_name != null and emp_name != ''">
				and (
			        aed.emp_name like '${emp_name}%'
			        or aed.spell_code like '${emp_name}%'
			        or aed.wbx_code like '${emp_name}%'
			    )
			</if>
			
			and exists(
				select 1 from v_user_data_perm a where a.group_id = #{group_id}
				and a.hos_id = #{hos_id} and a.copy_code = #{copy_code}
				and a.user_id = #{user_id}
				and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
				and a.perm_code = ad.dept_id and a.is_read = 1 and a.is_write = 1
			)
		</where>
		order by aebd.acct_year,aebd.acct_month,ad.dept_code,aed.emp_code asc
	</select>

	<select id="getEmpBonusData" parameterType="java.util.Map"
		resultMap="empBonusData">

		select
		aebd.group_id as group_id,
		aebd.hos_id as hos_id,
		aebd.copy_code as copy_code,
		aebd.acct_year as acct_year,
		aebd.acct_month as acct_month,
		aebd.emp_code as emp_code,
		aebd.dept_id as dept_id,
		aebd.dept_no as dept_no,
		ad.dept_kind_code as dept_kind_code,
		aess.formula_code as formula_code,
		aess.method_code as method_code
		from aphi_emp_bonus_data aebd
		
		<if test="para_value == 0">
			left join APHI_EMP ae 
			ON 
				aebd.emp_code = ae.emp_code and aebd.group_id = ae.group_id 
				and aebd.copy_code = ae.copy_code and aebd.hos_id = ae.hos_id
		</if>
		
		<if test="para_value == 1">
			left join v_aphi_emp_dict ae 
			ON 
				aebd.emp_code = ae.emp_code and aebd.group_id = ae.group_id 
				and aebd.copy_code = ae.copy_code and aebd.hos_id = ae.hos_id
		</if>
		
		
		left join APHI_DEPT ad on ae.dept_id = ad.dept_id and ae.group_id =
		ad.group_id and ae.copy_code = ad.copy_code and ae.hos_id = ad.hos_id
		left join aphi_emp_scheme_seq aess on ae.duty_code = aess.duty_code
		and ae.dept_id = aess.dept_id and ae.group_id = aess.group_id and
		ae.copy_code = aess.copy_code and ae.hos_id = aess.hos_id
		<where>
			<if test="group_id != null and group_id != ''">
				AND aebd.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and aebd.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND aebd.copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND aebd.acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND aebd.acct_month = #{acct_month}
			</if>
			<if test="emp_code != null and emp_code != ''">
				AND aebd.emp_code = #{emp_code}
			</if>
			<if test="duty_code != null and duty_code != ''">
				AND aebd.duty_code = #{duty_code}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND ae.dept_id = #{dept_id}
			</if>
		</where>
		order by aebd.emp_code asc
	</select>

	<!-- <select id="getEmpBonusDataValue" parameterType="java.util.Map"
		resultMap="empBonusData">
		select acct_year,acct_month from aphi_emp_bonus_audit
		<where>
			IS_GRANT ='1'
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND acct_month = #{acct_month}
			</if>

		</where>
		order by acct_year asc
	</select> -->

	<!-- 查询已审核方案科室职工 -->
	<select id="queryAphiEmpByaphiSubSchemeConf" parameterType="java.util.Map"
		resultMap="emp">
		SELECT
		aed.emp_id,aed.emp_no,aess.dept_id,aess.dept_no
		FROM APHI_SUB_SCHEME_CONF assc
		LEFT JOIN APHI_EMP_SCHEME_SEQ aess
		ON
		assc.group_id = aess.group_id
		AND assc.hos_id = aess.hos_id
		AND assc.copy_code = aess.copy_code
		AND assc.sub_scheme_seq_no = aess.sub_scheme_seq_no
		
		<if test="para_value == 0">
			LEFT JOIN APHI_EMP_DICT aed
			ON
			aess.group_id = aed.group_id
			AND aess.hos_id = aed.hos_id
			AND aess.copy_code = aed.copy_code
			AND aess.dept_id = aed.dept_id
			AND aess.dept_no = aed.dept_no
		</if>
		
		<if test="para_value ==  1">
			LEFT JOIN V_APHI_EMP_DICT aed
			ON
			aess.group_id = aed.group_id
			AND aess.hos_id = aed.hos_id
			AND aess.copy_code = aed.copy_code
			AND aess.dept_id = aed.dept_id
			AND aess.dept_no = aed.dept_no
		</if>
		
		<where>
			assc.group_id = #{group_id}
			AND assc.hos_id = #{hos_id}
			AND
			assc.copy_code = #{copy_code}
			<if test="acct_year != null and acct_year != '' ">
				AND assc.acct_year = #{acct_year}
			</if>

			<if test="acct_month != null and acct_month != '' ">
				AND assc.acct_month = #{acct_month}
			</if>

			<if test="sub_scheme_seq_no != null and sub_scheme_seq_no != '' ">
				AND assc.sub_scheme_seq_no = #{sub_scheme_seq_no}
			</if>

			<if test="dept_id != null and dept_id != ''">
				AND aed.dept_id = #{dept_id}
			</if>

			<if test="dept_no != null and dept_no != ''">
				AND aed.dept_no = #{dept_no}
			</if>

			<if test="duty_code != null and duty_code != '' ">
				AND aed.duty_code = #{duty_code}
			</if>
			AND aed.is_acc = 1
		</where>
	</select>
	
	<!-- 二次分配上报 主查询 -->
	<select id="queryHpmEmpBonusDataForUpReport" parameterType="java.util.Map" resultType="java.util.TreeMap">
	
		WITH 
			<!-- 查询业务数据 -->
			a_table AS (
				SELECT 
					ad.dept_code || '1' as ob_num,aebd.group_id, aebd.hos_id, aebd.copy_code, aebd.acct_year, aebd.acct_month
					, aebd.emp_id, aed.emp_no, aed.emp_code, aed.emp_name, aebd.dept_id,aebd.dept_no, ad.dept_code,  
					<if test="sql != null and sql != '' ">
		       			${sql}
		       		</if>
		       		ad.dept_name
		       		<if test="item_code != null and item_code != '' ">
		       			 ,aebd.is_audit, aed.duty_code, duty.duty_name,aebd.user_code,su1.user_name,aebd.audit_date,
         				 aebd.is_two_audit,aebd.Two_User_Code,su2.user_name as two_user_name,aebd.Two_Audit_Date 
		  			</if>
        
				FROM APHI_EMP_BONUS_DATA aebd
				
				<if test="para_value == 0">
				    LEFT JOIN APHI_EMP_DICT aed ON 
					    aebd.emp_id = aed.emp_id
					    AND aebd.group_id = aed.group_id
					    AND aebd.copy_code = aed.copy_code
					    AND aebd.hos_id = aed.hos_id 
					    and aed.is_stop = 0
					    
					 LEFT JOIN APHI_EMP_DUTY duty 
				    ON 
				    	aed.duty_code = duty.duty_code
					    AND aebd.group_id = duty.group_id
					    AND aebd.copy_code = duty.copy_code
					    AND aebd.hos_id = duty.hos_id 
				</if>
				
				<if test="para_value == 1">
				    LEFT JOIN V_APHI_EMP_DICT aed ON 
					    aebd.emp_id = aed.emp_id
					    AND aebd.group_id = aed.group_id
					   <!--  AND aebd.copy_code = aed.copy_code -->
					    AND aebd.hos_id = aed.hos_id 
					    and aed.is_stop = 0
					LEFT JOIN V_APHI_EMP_DUTY duty 
			    	ON 
			    	aed.duty_code = duty.duty_code
				    AND aebd.group_id = duty.group_id
				    AND aebd.hos_id = duty.hos_id 
				</if>
				
			    LEFT JOIN APHI_DEPT_DICT ad 
			    ON 
				    aebd.dept_id = ad.dept_id
				    AND aebd.dept_no = ad.dept_no
				    AND aebd.group_id = ad.group_id
				    AND aebd.copy_code = ad.copy_code
				    AND aebd.hos_id = ad.hos_id 
			   left join sys_user su1 on aebd.user_code = su1.user_id
		        and aebd.group_id= su1.group_id
		        and aebd.hos_id = su1.hos_id
		        left join sys_user su2 on aebd.two_user_code = su2.user_id
		        and aebd.group_id= su2.group_id
		        and aebd.hos_id = su2.hos_id
			   <where>
					aebd.group_id = #{group_id}
					AND aebd.hos_id = #{hos_id}
					AND aebd.copy_code = #{copy_code}
					
				<if test="acct_year != null and acct_year != ''">
					AND aebd.acct_year = #{acct_year}
				</if>
				<if test="acct_month != null and acct_month != ''">
					AND aebd.acct_month = #{acct_month}
				</if>
				<if test="emp_id != null and emp_id != ''">
					AND aebd.emp_id = #{emp_id}
				</if>
				<if test="emp_no != null and emp_no != ''">
					AND aed.emp_no = #{emp_no}
				</if>
				<if test="dept_id != null and dept_id != ''">
					AND aebd.dept_id = #{dept_id}
				</if>
				<if test="dept_no != null and dept_no != ''">
					AND aebd.dept_no = #{dept_no}
				</if>
				<if test="duty_code != null and duty_code != ''">
					AND aed.duty_code = #{duty_code}
				</if>
				<if test="is_audit != null and is_audit != ''">
					AND aebd.is_audit = #{is_audit}
				</if>
				<if test="item_code != null and item_code != ''">
					AND aebd.item_code = #{item_code}
				</if>
				<if test="is_audits != null and is_audits  != ''">
					AND aebd.is_audit = #{is_audits}
				</if>
				<if test="is_two_audits != null and is_two_audits != ''">
					AND aebd.is_two_audit = #{is_two_audits}
				</if>
				<if test="is_grant != null and is_grant != ''">
					AND aebd.is_grant = #{is_grant}
				</if>
				and exists(
					select 1 from v_user_data_perm a where a.group_id = #{group_id}
					and a.hos_id = #{hos_id} and a.copy_code = #{copy_code}
					and a.user_id = #{user_id}
					and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
					and a.perm_code = aebd.dept_id and a.is_read = 1 and a.is_write = 1
				)
				<!-- AND AEBD.BONUS_MONEY != 0 -->
			</where>
			<if test="is_group != null and is_group != '' ">
				 group by aebd.group_id, aebd.hos_id, aebd.copy_code, aebd.acct_year, aebd.acct_month, 
              aebd.emp_id, aed.emp_no, aed.emp_code, aed.emp_name, aebd.dept_id, aebd.dept_no, 
              ad.dept_code, ad.dept_name
              <if test="item_code != null and item_code != '' ">
	               , aebd.is_audit, aed.duty_code, duty.duty_name,aebd.user_code,aebd.audit_date,
	              aebd.is_two_audit,aebd.two_user_code,aebd.two_audit_date,su1.user_name,su2.user_name
              </if>
			</if>
		),
		<!-- 合计各科室 -->
		b_table AS (
		     SELECT 
		     	dept_code || '2' as ob_num,group_id,hos_id,copy_code,acct_year,acct_month,
		     	NULL emp_id,NULL emp_no,NULL emp_code,NULL emp_name,dept_id,
		     	dept_no,NULL dept_code,
		     	<if test="sql_columns != null and sql_columns != ''">
		      		${sql_columns}
		      	</if>
			    SUM(sum_money) AS sum_money,
			    dept_name || '合计'
			    <if test="item_code != null and item_code != ''">
			     ,
		      	 null as is_audit, null as duty_code, null as duty_name,
          null as user_code,null as user_name,null as audit_date,
          null as is_two_audit,null as two_user_code,null as two_user_name,null as two_audit_date 
          </if>
		    FROM a_table  
		            group by group_id, hos_id, copy_code, acct_year, acct_month, dept_id, dept_no, dept_code, 
        dept_name
        <if test="item_code != null and item_code != '' "> 
        	,user_code,audit_date,is_two_audit,two_user_code,two_user_name,Two_Audit_Date
        </if>
		),
		<!-- 总计 -->
		c_table AS(
		    SELECT 
		       '99' as ob_num,NULL group_id,NULL hos_id,NULL copy_code,NULL acct_year,NULL acct_month,
		       NULL emp_id,NULL emp_no,NULL emp_code,NULL emp_name,NULL dept_id,
		       NULL dept_no,NULL dept_code,
		       
		      <if test="sql_columns != null and sql_columns != ''">
		      		${sql_columns}
		      </if>
		       
		       sum(sum_money) as sum_money,'总计' as dept_name
		       <if test="item_code != null and item_code != '' ">
			        ,
			        null as is_audit, null as duty_code
	          		, null as duty_name,null as user_code,null as user_name,null as audit_date,
	          		null as is_two_audit,null as two_user_code,null as two_user_name,null as two_audit_date
	          	</if>
		    FROM b_table
		)
		
		SELECT temp.* FROM(
			SELECT a.* from a_table a
		    UNION ALL
		    SELECT b.* from b_table b
		    UNION ALL 
		    SELECT c.* from c_table c	
		) temp ORDER BY ob_num DESC,emp_code ASC
	
	</select>
	
	
	<!-- 二次分配上报 主查询  打印-->
	<select id="queryHpmEmpBonusDataForUpReportPrint" parameterType="java.util.Map" resultType="java.util.TreeMap">
	
		<!-- WITH 
			查询业务数据
			a_table AS (
				SELECT 
					ad.dept_code || '1' as ob_num,aebd.group_id, aebd.hos_id, aebd.copy_code, aebd.acct_year, aebd.acct_month
					, aebd.emp_id, aebd.emp_no, aed.emp_code, aed.emp_name, aebd.dept_id,aebd.dept_no, ad.dept_code, ad.dept_name, 
					<if test="sql != null and sql != '' ">
		       			${sql}
		       		</if>
					CASE WHEN aebd.is_audit = 1 then '是' else '否' END is_audit, aed.duty_code, duty.duty_name
				FROM APHI_EMP_BONUS_DATA aebd
				
				<if test="para_value == 0">
				    LEFT JOIN APHI_EMP_DICT aed ON 
					    aebd.emp_id = aed.emp_id
					    AND aebd.emp_no = aed.emp_no
					    AND aebd.group_id = aed.group_id
					    AND aebd.copy_code = aed.copy_code
					    AND aebd.hos_id = aed.hos_id 
					    
					LEFT JOIN APHI_EMP_DUTY duty 
			    	ON 
				    	aed.duty_code = duty.duty_code
					    AND aebd.group_id = duty.group_id
					    AND aebd.copy_code = duty.copy_code
					    AND aebd.hos_id = duty.hos_id 
				</if>
				
				<if test="para_value == 1">
				    LEFT JOIN APHI_EMP_DICT aed ON 
					    aebd.emp_id = aed.emp_id
					    AND aebd.emp_no = aed.emp_no
					    AND aebd.group_id = aed.group_id
					    AND aebd.copy_code = aed.copy_code
					    AND aebd.hos_id = aed.hos_id 
					    
					LEFT JOIN APHI_EMP_DUTY duty 
			    	ON 
				    	aed.duty_code = duty.duty_code
					    AND aebd.group_id = duty.group_id
					    AND aebd.hos_id = duty.hos_id 
				</if>
				
			    LEFT JOIN APHI_DEPT_DICT ad 
			    ON 
				    aebd.dept_id = ad.dept_id
				    AND aebd.dept_no = ad.dept_no
				    AND aebd.group_id = ad.group_id
				    AND aebd.copy_code = ad.copy_code
				    AND aebd.hos_id = ad.hos_id 
			   
			   <where>
					aebd.group_id = #{group_id}
					AND aebd.hos_id = #{hos_id}
					AND aebd.copy_code = #{copy_code}
					
				<if test="acct_year != null and acct_year != ''">
					AND aebd.acct_year = #{acct_year}
				</if>
				<if test="acct_month != null and acct_month != ''">
					AND aebd.acct_month = #{acct_month}
				</if>
				<if test="emp_id != null and emp_id != ''">
					AND aebd.emp_id = #{emp_id}
				</if>
				<if test="emp_no != null and emp_no != ''">
					AND aebd.emp_no = #{emp_no}
				</if>
				<if test="dept_id != null and dept_id != ''">
					AND aebd.dept_id = #{dept_id}
				</if>
				<if test="dept_no != null and dept_no != ''">
					AND aebd.dept_no = #{dept_no}
				</if>
				<if test="duty_code != null and duty_code != ''">
					AND aed.duty_code = #{duty_code}
				</if>
				<if test="is_audit != null and is_audit != ''">
					AND aebd.is_audit = #{is_audit}
				</if>
				and exists(
					select 1 from v_user_data_perm a where a.group_id = #{group_id}
					and a.hos_id = #{hos_id} and a.copy_code = #{copy_code}
					and a.user_id = #{user_id}
					and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
					and a.perm_code = aebd.dept_id and a.is_read = 1 and a.is_write = 1
				)
			</where>
			<if test="is_group != null and is_group != '' ">
				group by 
				   aebd.group_id,
			       aebd.hos_id,
			       aebd.copy_code,
			       aebd.acct_year,
			       aebd.acct_month,
			       aebd.emp_id,
			       aebd.emp_no,
			       aed.emp_code,
			       aed.emp_name,
			       aebd.dept_id,
			       aebd.dept_no,
			       ad.dept_code,
			       ad.dept_name,
			       aebd.is_audit,
			       aed.duty_code,
			       duty.duty_name
			</if>
		),
		合计各科室
		b_table AS (
		     SELECT 
		     	dept_code || '2' as ob_num,group_id,hos_id,copy_code,acct_year,acct_month,
		     	NULL emp_id,NULL emp_no,NULL emp_code,NULL emp_name,dept_id,
		     	dept_no,NULL dept_code,dept_name || '合计', 
		     	
		      	<if test="sql_columns != null and sql_columns != ''">
		      		${sql_columns}
		      	</if>
			    SUM(sum_money) AS sum_money,
		      	NULL is_audit,NULL duty_code,NULL duty_name
		    FROM a_table  
		    GROUP BY group_id,hos_id,copy_code,acct_year,acct_month,dept_id,dept_no,dept_code,dept_name
		),
		总计
		c_table AS(
		    SELECT 
		       '99' as ob_num,NULL group_id,NULL hos_id,NULL copy_code,NULL acct_year,NULL acct_month,
		       NULL emp_id,NULL emp_no,NULL emp_code,NULL emp_name,NULL dept_id,
		       NULL dept_no,NULL dept_code,'总计' as dept_name,
		       
		      <if test="sql_columns != null and sql_columns != ''">
		      		${sql_columns}
		      </if>
		       
		       sum(sum_money) as sum_money,
		       NULL is_audit,NULL duty_code,NULL duty_name
		    FROM b_table
		)
		
		SELECT temp.* FROM(
			SELECT a.* from a_table a
		    UNION ALL
		    SELECT b.* from b_table b
		    UNION ALL 
		    SELECT c.* from c_table c	
		) temp ORDER BY ob_num DESC,emp_code ASC -->
		WITH 
			<!-- 查询业务数据 -->
			a_table AS (
				SELECT 
					ad.dept_code || '1' as ob_num,aebd.group_id, aebd.hos_id, aebd.copy_code, aebd.acct_year, aebd.acct_month
					, aebd.emp_id, aed.emp_no, aed.emp_code, aed.emp_name, aebd.dept_id,aebd.dept_no, ad.dept_code,  
					<if test="sql != null and sql != '' ">
		       			${sql}
		       		</if>
		       		ad.dept_name
		       		<if test="item_code != null and item_code != '' ">
		       			 ,aebd.is_audit, aed.duty_code, duty.duty_name,aebd.user_code,su1.user_name,aebd.audit_date,
         				 aebd.is_two_audit,aebd.Two_User_Code,su2.user_name as two_user_name,aebd.Two_Audit_Date 
		  			</if>
        
				FROM APHI_EMP_BONUS_DATA aebd
				
				<if test="para_value == 0">
				    LEFT JOIN APHI_EMP_DICT aed ON 
					    aebd.emp_id = aed.emp_id
					    AND aebd.group_id = aed.group_id
					    AND aebd.copy_code = aed.copy_code
					    AND aebd.hos_id = aed.hos_id 
					    and aed.is_stop = 0
					 LEFT JOIN APHI_EMP_DUTY duty 
				    ON 
				    	aed.duty_code = duty.duty_code
					    AND aebd.group_id = duty.group_id
					    AND aebd.copy_code = duty.copy_code
					    AND aebd.hos_id = duty.hos_id 
				</if>
				
				<if test="para_value == 1">
				    LEFT JOIN V_APHI_EMP_DICT aed ON 
					    aebd.emp_id = aed.emp_id
					    <!-- AND aebd.emp_no = aed.emp_no -->
					    AND aebd.group_id = aed.group_id
					   <!--  AND aebd.copy_code = aed.copy_code -->
					    AND aebd.hos_id = aed.hos_id 
					    <!-- AND aebd.dept_id = aed.dept_id -->
					    and aed.is_stop = 0
					LEFT JOIN V_APHI_EMP_DUTY duty 
			    	ON 
			    	aed.duty_code = duty.duty_code
				    AND aebd.group_id = duty.group_id
				    AND aebd.hos_id = duty.hos_id 
				</if>
				
			    LEFT JOIN APHI_DEPT_DICT ad 
			    ON 
				    aebd.dept_id = ad.dept_id
				    AND aebd.dept_no = ad.dept_no
				    AND aebd.group_id = ad.group_id
				    AND aebd.copy_code = ad.copy_code
				    AND aebd.hos_id = ad.hos_id 
			   left join sys_user su1 on aebd.user_code = su1.user_id
		        and aebd.group_id= su1.group_id
		        and aebd.hos_id = su1.hos_id
		        left join sys_user su2 on aebd.two_user_code = su2.user_id
		        and aebd.group_id= su2.group_id
		        and aebd.hos_id = su2.hos_id
			   <where>
					aebd.group_id = #{group_id}
					AND aebd.hos_id = #{hos_id}
					AND aebd.copy_code = #{copy_code}
					
				<if test="acct_year != null and acct_year != ''">
					AND aebd.acct_year = #{acct_year}
				</if>
				<if test="acct_month != null and acct_month != ''">
					AND aebd.acct_month = #{acct_month}
				</if>
				<if test="emp_id != null and emp_id != ''">
					AND aebd.emp_id = #{emp_id}
				</if>
				<if test="emp_no != null and emp_no != ''">
					AND aed.emp_no = #{emp_no}
				</if>
				<if test="dept_id != null and dept_id != ''">
					AND aebd.dept_id = #{dept_id}
				</if>
				<if test="dept_no != null and dept_no != ''">
					AND aebd.dept_no = #{dept_no}
				</if>
				<if test="duty_code != null and duty_code != ''">
					AND aed.duty_code = #{duty_code}
				</if>
				<if test="is_audit != null and is_audit != ''">
					AND aebd.is_audit = #{is_audit}
				</if>
				<if test="item_code != null and item_code != ''">
					AND aebd.item_code = #{item_code}
				</if>
				<if test="is_audits != null and is_audits  != ''">
					AND aebd.is_audit = #{is_audits}
				</if>
				<if test="is_two_audits != null and is_two_audits != ''">
					AND aebd.is_two_audit = #{is_two_audits}
				</if>
				<if test="is_grant != null and is_grant != ''">
					AND aebd.is_grant = #{is_grant}
				</if>
				and exists(
					select 1 from v_user_data_perm a where a.group_id = #{group_id}
					and a.hos_id = #{hos_id} and a.copy_code = #{copy_code}
					and a.user_id = #{user_id}
					and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
					and a.perm_code = aebd.dept_id and a.is_read = 1 and a.is_write = 1
				)
				<!-- AND AEBD.BONUS_MONEY != 0 -->
			</where>
			<if test="is_group != null and is_group != '' ">
				 group by aebd.group_id, aebd.hos_id, aebd.copy_code, aebd.acct_year, aebd.acct_month, 
              aebd.emp_id, aed.emp_no, aed.emp_code, aed.emp_name, aebd.dept_id, aebd.dept_no, 
              ad.dept_code, ad.dept_name
              <if test="item_code != null and item_code != '' ">
	               , aebd.is_audit, aed.duty_code, duty.duty_name,aebd.user_code,aebd.audit_date,
	              aebd.is_two_audit,aebd.two_user_code,aebd.two_audit_date,su1.user_name,su2.user_name
              </if>
			</if>
		),
		<!-- 合计各科室 -->
		b_table AS (
		     SELECT 
		     	dept_code || '2' as ob_num,group_id,hos_id,copy_code,acct_year,acct_month,
		     	NULL emp_id,NULL emp_no,NULL emp_code,NULL emp_name,dept_id,
		     	dept_no,NULL dept_code,
		     	<if test="sql_columns != null and sql_columns != ''">
		      		${sql_columns}
		      	</if>
			    SUM(sum_money) AS sum_money,
			    dept_name || '合计'
			    <if test="item_code != null and item_code != ''">
			     ,
		      	 null as is_audit, null as duty_code, null as duty_name,
          null as user_code,null as user_name,null as audit_date,
          null as is_two_audit,null as two_user_code,null as two_user_name,null as two_audit_date 
          </if>
		    FROM a_table  
		            group by group_id, hos_id, copy_code, acct_year, acct_month, dept_id, dept_no, dept_code, 
        dept_name
        <if test="item_code != null and item_code != '' "> 
        	,user_code,audit_date,is_two_audit,two_user_code,two_user_name,Two_Audit_Date
        </if>
		),
		<!-- 总计 -->
		c_table AS(
		    SELECT 
		       '99' as ob_num,NULL group_id,NULL hos_id,NULL copy_code,NULL acct_year,NULL acct_month,
		       NULL emp_id,NULL emp_no,NULL emp_code,NULL emp_name,NULL dept_id,
		       NULL dept_no,NULL dept_code,
		       
		      <if test="sql_columns != null and sql_columns != ''">
		      		${sql_columns}
		      </if>
		       
		       sum(sum_money) as sum_money,'总计' as dept_name
		       <if test="item_code != null and item_code != '' ">
			        ,
			        null as is_audit, null as duty_code
	          		, null as duty_name,null as user_code,null as user_name,null as audit_date,
	          		null as is_two_audit,null as two_user_code,null as two_user_name,null as two_audit_date
	          	</if>
		    FROM b_table
		)
		
		SELECT temp.* FROM(
			SELECT a.* from a_table a
		    UNION ALL
		    SELECT b.* from b_table b
		    UNION ALL 
		    SELECT c.* from c_table c	
		) temp ORDER BY ob_num DESC,emp_code ASC
	
	</select>
	
	
	<select id="queryHpmEmpBonusDataForReport" parameterType="java.util.Map" resultType="java.util.TreeMap">
	
		select aebd.group_id,
	       aebd.hos_id,
	       aebd.copy_code,
	       aebd.acct_year,
	       aebd.acct_month,
	       aebd.emp_id,
	       aed.emp_no,
	       aed.emp_code,
	       aed.emp_name,
	       aebd.dept_id,
	       aebd.dept_no,
	       ad.dept_code,
	       ad.dept_name,
	       <if test="sql != null and sql != '' ">
	       		${sql}
	       </if>
	       aebd.is_audit,
	       aed.duty_code,
	       duty.duty_name
	  from aphi_emp_bonus_data aebd
	  
	  <if test="para_value == 0">
		  left join aphi_emp_dict aed
		    on aebd.emp_id = aed.emp_id
		   <!-- and aebd.emp_no = aed.emp_no -->
		   and aebd.group_id = aed.group_id
		   and aebd.copy_code = aed.copy_code
		   and aebd.hos_id = aed.hos_id
		   and aed.is_stop = 0
		   left join aphi_emp_duty duty
		    on aed.duty_code = duty.duty_code
		   and aebd.group_id = duty.group_id
		   and aebd.copy_code = duty.copy_code
		   and aebd.hos_id = duty.hos_id
	  </if>
	  
	  <if test="para_value == 1">
		  left join V_APHI_EMP_DICT aed
		    on aebd.emp_id = aed.emp_id
		   <!-- and aebd.emp_no = aed.emp_no -->
		   and aebd.group_id = aed.group_id
		   and aebd.copy_code = aed.copy_code
		   and aebd.hos_id = aed.hos_id
		   <!-- and aebd.dept_id = aed.dept_id -->
		   and aed.is_stop = 0
		   left join v_aphi_emp_duty duty
		    on aed.duty_code = duty.duty_code
		   and aebd.group_id = duty.group_id
		   and aebd.hos_id = duty.hos_id
	  </if>
	  
	  left join aphi_dept_dict ad
	    on aebd.dept_id = ad.dept_id
	   and aebd.dept_no = ad.dept_no
	   and aebd.group_id = ad.group_id
	   and aebd.copy_code = ad.copy_code
	   and aebd.hos_id = ad.hos_id
	  
		<where>
			<if test="group_id != null and group_id != ''">
				AND aebd.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and aebd.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND aebd.copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND aebd.acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND aebd.acct_month = #{acct_month}
			</if>
			<if test="emp_id != null and emp_id != ''">
				AND aebd.emp_id = #{emp_id}
			</if>
			<if test="emp_no != null and emp_no != ''">
				AND aed.emp_no = #{emp_no}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND aebd.dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				AND aebd.dept_no = #{dept_no}
			</if>
			<if test="duty_code != null and duty_code != ''">
				AND aed.duty_code = #{duty_code}
			</if>
			<if test="is_audit != null and is_audit != ''">
				AND aebd.is_audit = #{is_audit}
			</if>
			<if test="item_code != null and item_code != ''">
				AND aebd.item_code = #{item_code}
			</if>
			 <if test="list !=null and list.size >0">
	     	 	AND 
	     	 	<foreach collection="list" index="index" item="item"  open="(" separator="OR" close=")">
				<if test="item.dept_id != null and item.dept_id != ''">
					 aebd.dept_id = #{item.dept_id} 
				</if>
				<if test="item.dept_no != null and item.dept_no != ''">
					AND aebd.dept_no = #{item.dept_no}  
				</if>
				<if test="item.item_codes != null and item.item_codes != ''">
					AND aebd.item_code = #{item.item_codes}  
				</if>
			</foreach>
	     	 </if>
			and exists(
				select 1 from v_user_data_perm a where a.group_id = #{group_id}
				and a.hos_id = #{hos_id} and a.copy_code = #{copy_code}
				and a.user_id = #{user_id}
				and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
				and a.perm_code = aebd.dept_id and a.is_read = 1 and a.is_write = 1
			)
		</where>
		<if test="is_group != null and is_group != '' ">
			group by 
				aebd.group_id,
		       aebd.hos_id,
		       aebd.copy_code,
		       aebd.acct_year,
		       aebd.acct_month,
		       aebd.emp_id,
		       aed.emp_no,
		       aed.emp_code,
		       aed.emp_name,
		       aebd.dept_id,
		       aebd.dept_no,
		       ad.dept_code,
		       ad.dept_name,
		       aebd.is_audit,
		       aed.duty_code,
		       duty.duty_name
		</if>
			order by ad.dept_code asc
	</select>
	
	
	<select id="queryEmpBonusDataByDeptSumMoney" parameterType="java.util.Map" resultMap="empBonusData">
		with temp as (
		     select aebd.group_id,
		            aebd.hos_id,
		            aebd.copy_code,
		            aebd.dept_id,
		            aebd.dept_no,
		            aebd.item_code,
		            SUM(CASE WHEN aebd.IS_GRANT = 0 THEN aebd.BONUS_MONEY 
		                     WHEN aebd.IS_GRANT = 1 THEN 0 END ) history_bonus_money
		     FROM aphi_emp_bonus_data aebd
		     where aebd.group_id = #{group_id,jdbcType=INTEGER}
		     and aebd.hos_id = #{hos_id,jdbcType=INTEGER}
		     and aebd.copy_code = #{copy_code,jdbcType=VARCHAR}
		     and aebd.acct_year||aebd.acct_month = to_char(add_months(to_date(#{acct_year,jdbcType=VARCHAR}||#{acct_month,jdbcType=VARCHAR},'yyyymm'),-1),'yyyymm')
		     <if test="dept_id != null and dept_id !=''">
		         AND aebd.dept_id =  #{dept_id,jdbcType=INTEGER}
		     </if>
		     <if test="dept_no != null and dept_no !=''">
		         AND aebd.dept_no =  #{dept_no,jdbcType=INTEGER}
		     </if>
		     <if test="item_code != null and item_code !=''">
		          AND aebd.item_code =  #{item_code,jdbcType=VARCHAR}
		     </if>
		     GROUP BY aebd.group_id,aebd.hos_id,aebd.copy_code,aebd.dept_id,aebd.dept_no,aebd.item_code
		)
		SELECT
			aebd.group_id,
			aebd.copy_code,
			aebd.copy_code,
			aebd.acct_year,
			aebd.acct_month,
			aebd.dept_id,
			aebd.dept_no,
			aed.dept_name,
			sum(nvl(bonus_money,0)) as bonus_money,
          	aebd.item_code
	    FROM aphi_emp_bonus_data aebd
	    LEFT JOIN APHI_DEPT_DICT aed
	    ON
	    	aebd.group_id = aed.group_id
		and aebd.hos_id = aed.hos_id
	    and aebd.copy_code = aed.copy_code
	    and aebd.dept_id = aed.dept_id
	    and aebd.dept_no = aed.dept_no
	    and aed.is_stop = 0 
	    LEFT JOIN temp t
	    on
	    	aebd.group_id = t.group_id
	    and aebd.hos_id = t.hos_id
	    and aebd.copy_code = t.copy_code
	    and aebd.dept_id = t.dept_id
	    and aebd.dept_no = t.dept_no
	    and aebd.item_code = t.item_code		
	    WHERE
	    	aebd.group_id = #{group_id}
	    and aebd.hos_id = #{hos_id}
	    and aebd.copy_code = #{copy_code}
	    and aebd.acct_year = #{acct_year}
	    and aebd.acct_month = #{acct_month}
		<if test="dept_id != null and dept_id != '' ">
			and aebd.dept_id = #{dept_id}
		</if>
		<if test="dept_no != null and dept_no != '' ">
			and aebd.dept_no = #{dept_no} 
		</if>
		<if test="item_code != null and item_code != '' ">
			and aebd.item_code = #{item_code} 
		</if>
		and aebd.bonus_money ! = 0
		and exists(
				select 1 from v_user_data_perm a where a.group_id = #{group_id}
				and a.hos_id = #{hos_id} and a.copy_code = #{copy_code}
				and a.user_id = #{user_id}
				and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
				and a.perm_code = aebd.dept_id and a.is_read = 1 and a.is_write = 1
			)
	    GROUP BY 
	          aebd.group_id,
	          aebd.copy_code,
	          aebd.copy_code,
	          aebd.acct_year,
	          aebd.acct_month,
	         aebd.dept_id,aebd.dept_no,aed.dept_name ,aebd.item_code,t.history_bonus_money
	</select>

	<!-- <update id="auditAphiEmpBonusData" parameterType="java.util.Map"> <foreach 
		collection="list" index="index" item="item" open="begin" separator=";" close=";end;"> 
		UPDATE APHI_EMP_BONUS_DATA SET is_audit = #{item.is_audit} WHERE group_id 
		= #{item.group_id} AND hos_id = #{item.hos_id} AND copy_code = #{item.copy_code} 
		AND acct_year = #{item.acct_year} AND acct_month = #{item.acct_month} AND 
		emp_id = #{item.emp_id} AND emp_no = #{item.emp_no} </foreach> </update> -->
		
		
	<!-- 二次分配查询:查询科室奖金上报状态-->
	<select id="queryAphiEmpBonusDataDeptState" parameterType="java.util.Map" resultMap="empBonusData">
		<!-- SELECT 
			t.*
		FROM (
			SELECT
		    	dept.group_id, dept.hos_id, dept.copy_code, temp.acct_year, temp.acct_month,dept.dept_code,temp.item_name,
		    	dept.dept_name,dept.dept_id, dept.dept_no ,nvl(temp.bonus_money,0) bonus_money, nvl(temp.is_audit,0)  is_audit
		FROM APHI_DEPT_DICT dept
		left JOIN(
			SELECT 
		       aebd.group_id, aebd.hos_id, aebd.copy_code, aebd.acct_year, 
		       aebd.acct_month, aebd.is_audit, aebd.dept_id, aebd.dept_no ,
		       sum(aebd.bonus_money) as bonus_money,aebd.item_code,ai.item_name
			FROM APHI_EMP_BONUS_DATA aebd
			 left join aphi_item ai 
	          on aebd.group_id = ai.group_id
	          and aebd.hos_id = ai.hos_id
	          and aebd.copy_code = ai.copy_code
	          and ai.item_code = aebd.item_code
			WHERE 
				aebd.group_id = #{group_id}
		      	AND aebd.hos_id = #{hos_id}
		      	AND aebd.copy_code = #{copy_code}  
		      	AND aebd.acct_year = #{acct_year}
		      	AND aebd.acct_month = #{acct_month}
		      	AND aebd.item_code = #{item_code}
		    GROUP BY 
		    	aebd.group_id, 
		    	aebd.hos_id, 
		    	aebd.copy_code, 
		    	aebd.acct_year, 
		    	aebd.acct_month, 
		    	aebd.is_audit, 
		    	aebd.dept_id, 
		    	aebd.dept_no,
		    	aebd.item_code,
				ai.item_name
		) temp
		ON
			dept.group_id = temp.group_id
		  	AND dept.hos_id = temp.hos_id
		  	AND dept.copy_code = temp.copy_code
		  	AND dept.dept_id = temp.dept_id
		  	AND dept.dept_no = temp.dept_no
		WHERE
			dept.group_id = #{group_id}
		    AND dept.hos_id = #{hos_id}
		    AND dept.copy_code = #{copy_code}
		    AND dept.is_stop = 0
		) t
		
		<where>
			<if test="is_audit != null and is_audit != '' ">
		     	AND t.is_audit = #{is_audit}
	     	</if>
	     	
	     	<if test="dept_id != null and dept_id != '' ">
		    	AND t.dept_id = #{dept_id}
	     	</if>
			
			<if test="dept_no != null and dept_no != '' ">
		    	AND t.dept_no= #{dept_no}
			</if>
			
			AND exists (  
				SELECT 1
					FROM v_user_data_perm a 
				WHERE a.group_id = #{group_id}
				AND a.hos_id = #{hos_id}
				AND a.copy_code = #{copy_code}
				AND a.user_id = #{user_id}
				AND a.mod_code = '09'
				AND a.table_code = 'APHI_DEPT_DICT'
				AND a.perm_code = t.dept_id
				AND a.is_read = 1
				AND a.is_write = 1
			)
			and exists (select 1
		          from aphi_dept_bonus_grant adbg
		         where adbg.group_id = #{group_id}
						AND adbg.hos_id = #{hos_id}
						AND adbg.copy_code = #{copy_code}
						and adbg.is_grant = 1
		           		AND adbg.acct_year = #{acct_year}
		      			AND adbg.acct_month = #{acct_month})
		</where>
			ORDER BY t.dept_code ASC -->
			 with temp as (
		       select distinct aebd.dept_id,aebd.dept_no, aebd.item_code,aebd.group_id,aebd.hos_id,aebd.copy_code,aebd.acct_year,aebd.acct_month, aebd.is_audit from APHI_EMP_BONUS_DATA aebd
		       where aebd.group_id = #{group_id}
		      and aebd.hos_id = #{hos_id}
		      and aebd.copy_code =  #{copy_code}
		      and aebd.acct_year = #{acct_year}
		      and aebd.acct_month = #{acct_month}
		      and aebd.item_code = #{item_code}
		  
		  ) 
			 select adbg.group_id, adbg.hos_id, adbg.copy_code, adbg.acct_year, adbg.acct_month
		        ,  adbg.dept_id, adbg.dept_no, sum(adbg.bonus_money) as bonus_money
		        , adbg.item_code, ai.item_name ,addd.dept_name, addd.dept_code,t.is_audit
		      from aphi_dept_bonus_grant adbg
		        left join aphi_item ai on adbg.group_id = ai.group_id
		      and adbg.hos_id = ai.hos_id
		      and adbg.copy_code = ai.copy_code
		      and ai.item_code = adbg.item_code 
		      left join APHI_DEPT_DICT addd
		       on addd.group_id = adbg.group_id
		      and addd.hos_id = adbg.hos_id
		      and addd.copy_code = adbg.copy_code
		      and addd.dept_id = adbg.dept_id
		      and addd.dept_no = adbg.dept_no
		      and addd.is_stop = 0
		       left join APHI_EMP_BONUS_DATA aebd
		      on aebd.group_id = adbg.group_id
		      and aebd.hos_id = adbg.hos_id
		      and aebd.copy_code = adbg.copy_code
		      and aebd.acct_year = adbg.acct_year
		      and aebd.acct_month = adbg.acct_month
		      and aebd.dept_id = adbg.dept_id
		      and aebd.dept_no = adbg.dept_no 
		       left join temp t on t.group_id = adbg.group_id
			    and  t.hos_id = adbg.hos_id
			    and t.copy_code = adbg.copy_code
			    and t.acct_year = #{acct_year}
			    and t.acct_month = #{acct_month}
			    and t.dept_id = adbg.dept_id
			      and t.dept_no = adbg.dept_no
			      and t.item_code = adbg.item_code
		      where adbg.group_id =#{group_id}
		        and adbg.hos_id = #{hos_id}
		        and adbg.copy_code =  #{copy_code}
		        and adbg.acct_year = #{acct_year}
		        and adbg.acct_month = #{acct_month}
		        and adbg.item_code = #{item_code}
		        <if test="is_audit != null and is_audit != '' ">
		     		AND adbg.is_audit = #{is_audit}
	     		</if>
	     	
	     		<if test="dept_id != null and dept_id != '' ">
		    		AND adbg.dept_id = #{dept_id}
	     		</if>
			
				<if test="dept_no != null and dept_no != '' ">
		    		AND adbg.dept_no= #{dept_no}
				</if>
			AND exists (  
				SELECT 1
					FROM v_user_data_perm a
				WHERE a.group_id = #{group_id}
				AND a.hos_id = #{hos_id}
				AND a.copy_code = #{copy_code}
				AND a.user_id = #{user_id}
				AND a.mod_code = '09'
				AND a.table_code = 'APHI_DEPT_DICT'
				AND a.perm_code = adbg.dept_id
				AND a.is_read = 1
				AND a.is_write = 1
			)
		      group by adbg.group_id, adbg.hos_id, adbg.copy_code, adbg.acct_year, adbg.acct_month, adbg.dept_id, adbg.dept_no, adbg.item_code, ai.item_name,addd.dept_name,addd.dept_code,t.is_audit
			
			
			
			
			
			
	</select>	
	
	<select id="queryEmpBonusAuditByCode" resultMap="empBonusData"   
		parameterType="java.util.Map">
			select group_id,
		       hos_id,
		       copy_code,
		       acct_year,
		       acct_month,
		       emp_id,
		       emp_no,
		       dept_id,
		       dept_no,
		       item_code,
		       bonus_money,
		       is_audit,
		       is_grant,
		       is_two_audit
		  from aphi_emp_bonus_data 
		  where group_id = #{group_id}
	         and hos_id = #{hos_id}
	         and copy_code = #{copy_code}
	         and acct_year = #{acct_year}
	         and acct_month = #{acct_month}
	         <if test="item_code != null and item_code != '' ">
		    	AND item_code = #{item_code}
	     	 </if>
	     	 <if test="dept_id != null and dept_id != '' ">
		    	AND dept_id = #{dept_id}
	     	 </if>
	     	 <if test="dept_no != null and dept_no != '' ">
		    	AND dept_no = #{dept_no}
	     	 </if>
	     	 <if test="list !=null and list.size >0">
	     	 	AND 
	     	 	<foreach collection="list" index="index" item="item"  open="(" separator="OR" close=")">
				<if test="item.dept_id != null and item.dept_id != ''">
					 dept_id = #{item.dept_id} 
				</if>
				<if test="item.dept_no != null and item.dept_no != ''">
					AND dept_no = #{item.dept_no}  
				</if>
				<if test="item.item_codes != null and item.item_codes != ''">
					AND item_code = #{item.item_codes}  
				</if>
			</foreach>
	     	 </if>
	
	</select>
	
	
	<update id="updateEmpBonusData_grant" parameterType="java.util.Map">
		UPDATE aphi_emp_bonus_data
			<trim prefix="SET" suffixOverrides=",">
				<if test="is_grant != null">
					is_grant = #{is_grant}
				</if>
			<!-- 	<if test="grant_code != null">
					grant_code = #{grant_code},
				</if>
				<if test="grant_date != null">
					grant_date = #{grant_date},
				</if> -->
			</trim>
			<where>
				<if test="group_id != null and group_id != ''">
					AND group_id = #{group_id}
				</if>
				<if test="hos_id != null and hos_id != ''">
					AND hos_id = #{hos_id}
				</if>
				<if test="copy_code != null and copy_code != ''">
					AND copy_code = #{copy_code}
				</if>
				<if test="acct_month != null and acct_month != ''">
					AND acct_month = #{acct_month}
				</if>
				<if test="acc_year != null and acc_year != ''">
					AND acc_year = #{acc_year}
				</if>
				<if test="dept_id != null and dept_id != ''">
					AND dept_id = #{dept_id}
				</if>
				<if test="dept_no != null and dept_no != ''">
					AND dept_no = #{dept_no}
				</if>
				<if test="emp_id != null and emp_id != ''">
					AND emp_id = #{emp_id}
				</if>
				<if test="emp_no != null and emp_no != ''">
					AND emp_no = #{emp_no}
				</if>
				<if test="item_code != null and item_code != '' ">
					AND item_code = #{item_code}
				</if>
				<if test="list !=null and list.size >0">
	     	 	AND 
	     	 	<foreach collection="list" index="index" item="item"  open="(" separator="OR" close=")">
				<if test="item.dept_id != null and item.dept_id != ''">
					 dept_id = #{item.dept_id} 
				</if>
				<if test="item.dept_no != null and item.dept_no != ''">
					AND dept_no = #{item.dept_no}  
				</if>
				<if test="item.item_codes != null and item.item_codes != ''">
					AND item_code = #{item.item_codes}  
				</if>
			</foreach>
	     	 </if>
			</where>
	
	</update>
	
	<insert id="addEmpBonusData_grant" useGeneratedKeys="true">
		INSERT INTO aphi_emp_bonus_data (
			group_id ,
			hos_id,
			copy_code ,
			acct_year ,
			acct_month ,
			emp_id ,
			emp_no ,
			dept_id,
			dept_no,
			item_code,
			is_grant,
			grant_date,
			grant_code
			) VALUES (
			#{group_id,jdbcType = INTEGER} ,
			#{hos_id,jdbcType = INTEGER},
			#{copy_code,jdbcType = VARCHAR} ,
			#{acct_year,jdbcType = VARCHAR} ,
			#{acct_month,jdbcType = VARCHAR} ,
			#{emp_id,jdbcType = INTEGER} ,
			#{emp_no,jdbcType = INTEGER} ,
			#{dept_id,jdbcType = INTEGER} ,
			#{dept_no,jdbcType = INTEGER} ,
			#{item_code,jdbcType = VARCHAR},
			#{is_grant,jdbcType = INTEGER},
			#{grant_date,jdbcType = DATE},
			#{grant_code,jdbcType = INTEGER}
			)
	
	</insert>
	
	
	<!-- 删除职工的时候查询有没有被占用 -->
	<select id="queryDeleteEmpList"  parameterType="java.util.List" resultType="int">
		
	select  count(*)
		  from empBonusDataempBonusData
		  
		 where
		<foreach collection="list" index="index" item="item"  open="(" separator="OR" close=")">
		 	 group_id = #{item.group_id}
	         and hos_id = #{item.hos_id}
	         and copy_code = #{item.copy_code}
	         and emp_id = #{item.emp_id}
      	 </foreach>
		  
	</select>
	
	<!-- 审核是查看状态变化颜色 -->
	<select id="queryEmpBonusDataAdult" resultMap="empBonusData"
		parameterType="string">
		select 
        max( aebd.is_audit ) is_audit
    from aphi_emp_bonus_data aebd
	 	<where>
				<if test="group_id != null and group_id != ''">
					AND aebd.group_id = #{group_id}
				</if>
				<if test="hos_id != null and hos_id != ''">
					AND aebd.hos_id = #{hos_id}
				</if>
				<if test="copy_code != null and copy_code != ''">
					AND aebd.copy_code = #{copy_code}
				</if>
				<if test="acct_year != null and acct_year != ''">
					AND aebd.acct_year = #{acct_year}
				</if>
				<if test="acct_month != null and acct_month != ''">
					AND aebd.acct_month = #{acct_month}
				</if>
				<if test="item_code != null and item_code != ''">  
					AND aebd.item_code = #{item_code}
				</if>
				<if test="dept_id != null and dept_id != ''">
					AND aebd.dept_id = #{dept_id}
				</if>
				<if test="dept_no != null and dept_no != ''">
					AND aebd.dept_no = #{dept_no}
				</if>
			</where>
	
	</select>
	
	
	<select id="queryEmpBonusAuditByCode_dept" resultMap="empBonusData"
		parameterType="java.util.Map">
			select distinct dept_id, group_id, hos_id, copy_code, acct_year, acct_month, 
	  		dept_no, item_code,is_audit
	  		from aphi_emp_bonus_data
		  where group_id = #{group_id}
	         and hos_id = #{hos_id}
	         and copy_code = #{copy_code}
	         and acct_year = #{acct_year}
	         and acct_month = #{acct_month}
	         <if test="item_code != null and item_code != '' ">
		    	AND item_code = #{item_code}
	     	 </if>
	     	 <if test="item_codes != null and item_codes != '' ">
		    	AND item_code = #{item_codes}
	     	 </if>
	     	 <if test="dept_id != null and dept_id != '' ">
		    	AND dept_id = #{dept_id}
	     	 </if>
	     	 <if test="dept_no != null and dept_no != '' "> 
		    	AND dept_no = #{dept_no}
	     	 </if>
	     	 <if test="list !=null and list.size >0">
	     	 	AND 
	     	 	<foreach collection="list" index="index" item="item"  open="(" separator="OR" close=")">
				<if test="item.dept_id != null and item.dept_id != ''">
					 dept_id = #{item.dept_id} 
				</if>
				<if test="item.dept_no != null and item.dept_no != ''">
					AND dept_no = #{item.dept_no}  
				</if>
				<if test="item.item_codes != null and item.item_codes != ''">
					AND item_code = #{item.item_codes}  
				</if>
				<if test="item.item_code != null and item.item_code != ''">
					AND item_code = #{item.item_code}  
				</if>
			</foreach>
	     	 </if>
	
	</select>
	
	<select id="querySumHpmEmpBonusData" parameterType="java.util.Map" resultType="java.lang.String">
		select to_char(round(nvl(sum(nvl(bonus_money,0)),0),2)) 
		from aphi_emp_bonus_data 
		where group_id = #{group_id}
		and hos_id = #{hos_id}
		and copy_code = #{copy_code}
		and acct_year = #{acct_year}
		and acct_month = #{acct_month}
		<if test="item_code != null and item_code != ''">
			and item_code = #{item_code}
		</if>
		<if test="list != null and list.size >0">
			and dept_id in
			<foreach collection="list" index="index" item="item"  open="(" separator="," close=")">
				<if test="item.dept_id != null and item.dept_id != ''">
					#{item.dept_id} 
				</if>
			</foreach>
		</if>
	</select>
</mapper>

