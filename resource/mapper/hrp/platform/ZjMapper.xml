<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.platform.dao.ZjMapper">
	
	<resultMap type="java.util.Map" id="platformOrderDetail">   
		<result column="inv_code" property="inv_code"/>
		<result column="inv_name" property="inv_name"/>
		<result column="sup_code" property="sup_code"/>
		<result column="sup_name" property="sup_name"/>
		<result column="hospitalOrderDetailId" property="hospitalOrderDetailId"/>     
		<result column="goodsID" property="goodsID"/>      
		<result column="companyIdPs" property="companyIdPs"/>
		<result column="purchaseCount" property="purchaseCount"/>
		<result column="outlookc" property="outlookc"/>
		<result column="goodsType" property="goodsType"/>
		<result column="orderDetailRemark" property="orderDetailRemark"/>
		<result column="orderCustomInfo" property="orderCustomInfo"/>
	</resultMap>
	<resultMap type="java.util.Map" id="matInvRelaSelect">
		<result property="id" column="id" />
		<result property="text" column="text" />
		<result property="code" column="code"/>
		<result property="name" column="name"/> 
		
	</resultMap>
	
	<resultMap type="java.util.Map" id="hospitalProcurecata">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="inv_id" column="inv_id" />
		<result property="inv_code" column="inv_code" />
		<result property="inv_name" column="inv_name" />
		<result property="inv_model" column="inv_model" />
		<result property="unit_code" column="unit_code" />
		<result property="hospitalid" column="hospitalid" />
		<result property="departmentid" column="departmentid" />
		<result property="goodsid" column="goodsid"/>
		<result property="sortname" column="sortname"/> 
		<result property="productnamefirst" column="productnamefirst"/> 
		<result property="productnamesecond" column="productnamesecond"/> 
		<result property="goodsname" column="goodsname"/> 
		<result property="outlookc" column="outlookc"/> 
		<result property="goodstype" column="goodstype"/> 
		<result property="unit" column="unit"/> 
		<result property="regcodename" column="regcodename"/> 
		<result property="brand" column="brand"/> 
		<result property="source" column="source"/> 
		<result property="purchaseprice" column="purchaseprice"/> 
		<result property="companyidtb" column="companyidtb"/> 
		<result property="companynametb" column="companynametb"/> 
		<result property="companyidps" column="companyidps"/> 
		<result property="companynameps" column="companynameps"/> 
		<result property="purchasetype" column="purchasetype"/> 
		<result property="addtime" column="addtime"/> 
		<result property="lastupdatetime" column="lastupdatetime"/>  
		
	</resultMap>
	
	<resultMap type="java.util.Map" id="zjOrderMap">
		<result property="order_id" column="order_id"/>
		<result property="order_detail_id" column="order_detail_id"/>
		<result property="platform_order_id" column="platform_order_id"/>
		<result property="platform_detail_id" column="platform_detail_id"/>
		<result property="batchrecordid" column="batchrecordid"/>
		<result property="distributionserialid" column="distributionserialid"/>
		<result property="warehousetime" column="warehousetime"/>
		<result property="warehousecount" column="warehousecount"/>
		<result property="invoiceid" column="invoiceid"/>
		<result property="distributetime" column="distributetime"/>
		<result property="distributecount" column="distributecount"/>
		<result property="distribution_id" column="distribution_id"/>
		<result property="batchrecord_id" column="batchrecord_id"/>
		<result property="invoice_id" column="invoice_id"/>
		<result property="distribution_count" column="distribution_count"/>
		<result property="distribution_time" column="distribution_time"/>
		<result property="warehouse_count" column="warehouse_count"/>
		<result property="warehouse_time" column="warehouse_time"/>
		<result property="inv_name" column="inv_name"/>
		<result property="inv_model" column="inv_model"/>
		<result property="line_state" column="line_state"/>
	</resultMap>
	
	<resultMap type="java.util.Map" id="zjMatBackMap">
		<result property="in_detail_id" column="in_detail_id"/>
		<result property="state" column="state"/>
		<result property="inv_code" column="inv_code"/>
		<result property="inv_name" column="inv_name"/>
		<result property="distributionserialid" column="distributionserialid"/>
		<result property="amount" column="amount"/>
		<result property="brief" column="brief"/>
		<result property="note" column="note"/>
		<result property="goodsid" column="goodsid"/>
	</resultMap>
	<resultMap type="java.util.Map" id="inDetail">
		<result property="group_id" column="group_id"/>
		<result property="hos_id" column="hos_id"/>
		<result property="copy_code" column="copy_code"/>
		<result property="order_id" column="order_id"/>
		<result property="order_detail_id" column="order_detail_id"/>
		<result property="order_code" column="order_code"/>
		<result property="brif" column="brif"/>
		<result property="order_date" column="order_date"/>
		<result property="maker" column="maker"/>
		<result property="sup_id" column="sup_id"/>
		<result property="sup_no" column="sup_no"/>
		<result property="sup_code" column="sup_code"/>
		<result property="sup_name" column="sup_name"/>
		<result property="maker_name" column="maker_name"/>
		<result property="inv_id" column="inv_id"/>
		<result property="inv_no" column="inv_no"/>
		<result property="inv_code" column="inv_code"/>
		<result property="inv_name" column="inv_name"/>
		<result property="inv_model" column="inv_model"/>
		<result property="unit_code" column="unit_code"/>
		<result property="unit_name" column="unit_name"/>
		<result property="price" column="price"/>
		<result property="order_amount" column="order_amount"/>
		<result property="already_amount" column="already_amount"/>
		<result property="amount" column="amount"/>
		<result property="amount_money" column="amount_money"/>
		<result property="fac_id" column="fac_id"/>
		<result property="fac_no" column="fac_no"/>
		<result property="fac_code" column="fac_code"/>
		<result property="fac_name" column="fac_name"/>
		<result property="cert_code" column="cert_code"/>
		<result property="cert_id" column="cert_id"/>
		<result property="is_bar" column="is_bar"/>
		<result property="is_batch" column="is_batch"/>
		<result property="is_per_bar" column="is_per_bar"/>
		<result property="is_quality" column="is_quality"/>
		<result property="is_disinfect" column="is_disinfect"/>
		<result property="is_highvalue" column="is_highvalue"/>
		<result property="sell_price" column="sell_price"/>
		<result property="store_id" column="store_id"/>
		<result property="store_no" column="store_no"/> 
		<result property="store_code" column="store_code"/> 
		<result property="store_name" column="store_name"/>
		<result property="stock_emp" column="stock_emp"/>
		<result property="emp_code" column="emp_code"/>
		<result property="emp_name" column="emp_name"/>
		<result property="manager" column="manager"/>
		<result property="manager_code" column="manager_code"/>
		<result property="manager_name" column="manager_name"/>
		<result property="invoiceid" column="invoiceid"/>
		<result property="batchrecordid" column="batchrecordid"/>
		<result property="distributecount" column="distributecount"/>
		<result property="batch_no" column="batch_no"/>
		<result property="purchaseprice" column="purchaseprice"/>
		<result property="distributionserialid" column="distributionserialid"/>
		<result property="warehouse_count" column="warehouse_count"/>
		<result property="invoice_id" column="invoice_id"/>
		<result property="batchrecord_id" column="batchrecord_id"/>
		<result property="distribution_count" column="distribution_count"/>
		<result property="distribution_id" column="distribution_id"/>
	</resultMap>
	
	
	<resultMap type="java.util.Map" id="matPay">
		<result property="pay_id" column="pay_id"/> 
		<result property="pay_bill_no" column="pay_bill_no"/>
		<result property="orderCustomInfo" column="orderCustomInfo"/>
		<result property="storageId" column="storageId"/>
		<result property="companyIdPs" column="companyIdPs"/>
		<result property="companyId" column="companyId"/>
		<result property="companyNamePs" column="companyNamePs"/>
	</resultMap>
	
	<!-- 添加省平台采购目录 -->
	<insert id="insertProcureCatalog">
	begin
		<foreach collection="list" item="item"  separator=";" >
			insert into zj_hospital_procurecata_log
			  (
			  goodsid
			  <if test="item.hospitalId != null and item.hospitalId !=''">,hospitalid</if>
			  <if test="item.departmentID != null and item.departmentID !=''">,departmentid</if>
			  <if test="item.sortName!= null and  item.sortName!=''">,sortname</if>
			  <if test="item.productNameFirst!= null and  item.productNameFirst!=''">,productnamefirst</if>
			  <if test="item.productNameSecond!= null and  item.productNameSecond!=''">,productnamesecond</if>
			  <if test="item.goodsName!= null and  item.goodsName!=''">,goodsname</if>
			  <if test="item.outlookc!= null and  item.outlookc!=''">,outlookc</if>
			 <!--  <if test="item.goodsType!= null and  item.goodsType!=''">,goodstype</if> -->
			  <if test="item.unit!= null and  item.unit!=''">,unit</if>
			  <if test="item.regcodeName!= null and  item.regcodeName!=''">,regcodename</if>
			  <if test="item.brand!= null and  item.brand!=''">,brand</if>
			  <if test="item.source!= null and  item.source!=''">,source</if>
			  <if test="item.purchasePrice!= null and  item.purchasePrice!=''">,purchaseprice</if>
			  <if test="item.companyIdTb!= null and  item.companyIdTb!=''">,companyidtb</if>
			  <if test="item.companyNameTb!= null and  item.companyNameTb!=''">,companynametb</if>
			  <if test="item.companyIdPs!= null and  item.companyIdPs!=''">,companyidps</if>
			  <if test="item.companyNamePs!= null and  item.companyNamePs!=''">,companynameps</if>
			  <if test="item.purchaseType!= null and  item.purchaseType!=''">,purchasetype</if>
			  <if test="item.addTime!= null and  item.addTime!=''">,addtime</if>
			  <if test="item.lastUpdateTime!= null and  item.lastUpdateTime!=''">,lastupdatetime</if>
			   )
			select
			   #{item.goodsID,jdbcType=VARCHAR}
			  <if test="item.hospitalId != null and item.hospitalId !=''">,#{item.hospitalId,jdbcType=VARCHAR}</if>
			  <if test="item.departmentID != null and item.departmentID !=''">,#{item.departmentID,jdbcType=VARCHAR}</if>
			  <if test="item.sortName!= null and  item.sortName!=''">,#{item.sortName,jdbcType=VARCHAR}</if>
			  <if test="item.productNameFirst!= null and  item.productNameFirst!=''">,#{item.productNameFirst,jdbcType=VARCHAR}</if>
			  <if test="item.productNameSecond!= null and  item.productNameSecond!=''">,#{item.productNameSecond,jdbcType=VARCHAR}</if>
			  <if test="item.goodsName!= null and  item.goodsName!=''">,#{item.goodsName,jdbcType=VARCHAR}</if>
			  <if test="item.outlookc!= null and  item.outlookc!=''">,#{item.outlookc,jdbcType=VARCHAR}</if>
			  <!-- <if test="item.goodsType!= null and  item.goodsType!=''">,#{item.goodsType,jdbcType=CLOB}</if> -->
			  <if test="item.unit!= null and  item.unit!=''">,#{item.unit,jdbcType=VARCHAR}</if>
			  <if test="item.regcodeName!= null and  item.regcodeName!=''">,#{item.regcodeName,jdbcType=VARCHAR}</if>
			  <if test="item.brand!= null and  item.brand!=''">,#{item.brand,jdbcType=VARCHAR}</if>
			  <if test="item.source!= null and  item.source!=''">,#{item.source,jdbcType=VARCHAR}</if>
			  <if test="item.purchasePrice!= null and  item.purchasePrice!=''">,#{item.purchasePrice,jdbcType=VARCHAR}</if>
			  <if test="item.companyIdTb!= null and  item.companyIdTb!=''">,#{item.companyIdTb,jdbcType=VARCHAR}</if>
			  <if test="item.companyNameTb!= null and  item.companyNameTb!=''">,#{item.companyNameTb,jdbcType=VARCHAR}</if>
			  <if test="item.companyIdPs!= null and  item.companyIdPs!=''">,#{item.companyIdPs,jdbcType=VARCHAR}</if>
			  <if test="item.companyNamePs!= null and  item.companyNamePs!=''">,#{item.companyNamePs,jdbcType=VARCHAR}</if>
			  <if test="item.purchaseType!= null and  item.purchaseType!=''">,#{item.purchaseType,jdbcType=VARCHAR}</if>
			  <if test="item.addTime!= null and  item.addTime!=''">,#{item.addTime,jdbcType=VARCHAR}</if>
			  <if test="item.lastUpdateTime!= null and  item.lastUpdateTime!=''">,#{item.lastUpdateTime,jdbcType=VARCHAR}</if>
			from dual
						
		</foreach>
	;end;
	</insert>
	
	
	<delete id="deleteProcureCatalog" parameterType="java.util.List">
	begin
		<foreach collection="list" item="item"  separator=";" >
			delete from  zj_hospital_procurecata_log
			where goodsid=#{item.goodsID,jdbcType=VARCHAR}
	    </foreach>
	;end;
	</delete>
	
	<delete id="deleteDistribution" parameterType="java.util.List">
	begin
		<foreach collection="list" item="item"  separator=";" >
			delete from  MAT_DISTRIBUTION_ORDER
			where distribution_id=#{item.distributionSerialID,jdbcType=VARCHAR}
			and platform_detail_id = #{item.orderDetailID,jdbcType=VARCHAR}
	    </foreach>
	;end;
	</delete>
	
	<insert id="insertOrderRela" parameterType="java.util.List">
		<foreach collection="list" item="item" open="begin " separator=";" close=";end;">
			insert into zj_order_map
			  (group_id,hos_id,copy_code,order_id, order_detail_id, platform_order_id, platform_detail_id)
			select
			   #{item.group_id,jdbcType=INTEGER},
			   #{item.hos_id,jdbcType=INTEGER},
			   #{item.copy_code,jdbcType=VARCHAR},
			   #{item.order_id,jdbcType=INTEGER},
			   #{item.hospitalOrderDetailId,jdbcType=INTEGER},
			   #{item.platform_order_id,jdbcType=VARCHAR},
			   #{item.orderDetailId,jdbcType=VARCHAR}
			from dual
						
		</foreach>
	</insert>
	
	<!-- 组装省平台订单明细,用于提交省平台生成订单明细 -->
	<select id="getPlatformOrderDetailsByHrpOrderId" parameterType="java.util.Map" resultMap="platformOrderDetail">
		select zim.goodsid  goodsID,
		 mid.inv_code,mid.inv_name,hs.sup_code,hs.sup_name,
		 mord.order_detail_id  hospitalOrderDetailId,
		 zim.companyIdPs  companyIdPs,
		 mord.amount  purchaseCount,
		 mid.inv_model outlookc,
		 mid.inv_model  goodsType,
		 mid.inv_code||'|'||mid.inv_name||'|'||mid.inv_model||'|'  orderDetailRemark,
		 '无'  orderCustomInfo
		from  mat_order_detail mord
		left join mat_order_main mom
		on mom.group_id=mord.group_id
		and mom.hos_id=mord.hos_id
		and mom.copy_code=mord.copy_code
		and mom.order_id=mord.order_id
		left join mat_inv_dict mid 
		on mid.group_id=mord.group_id
		and mid.hos_id=mord.hos_id
		and mid.copy_code=mord.copy_code
		and mid.inv_id=mord.inv_id
		and mid.is_stop=0
		left join zj_inv_map zim
		on zim.group_id=mid.group_id
		and zim.hos_id=mid.hos_id
		and zim.copy_code=mid.copy_code
		and zim.inv_id=mid.inv_id
		left join zj_ps_map zpm
		on zpm.group_id=mom.group_id
		and zpm.hos_id=mom.hos_id
		and zpm.copy_code=mom.copy_code
		and zpm.sup_id=mom.sup_id
		left join hos_sup hs
		on hs.group_id=mom.group_id
		and hs.hos_id=mom.hos_id
		and hs.sup_id=mom.sup_id
		<where>
			    mom.group_id=#{group_id,jdbcType=INTEGER}
		  	and mom.hos_id=#{hos_id,jdbcType=INTEGER}
		  	and mom.copy_code=#{copy_code,jdbcType=VARCHAR}
		  	and mom.order_id=#{order_id,jdbcType=INTEGER}     
		</where>
	</select>
	 
	<select id="queryMatInvRela" parameterType="java.util.Map" resultMap="hospitalProcurecata">

		SELECT  zim.group_id,
				zim.hos_id,
				zim.copy_code,
				zim.inv_id,
				mid.inv_code,
				mid.inv_name,
				mid.inv_model,
				mid.unit_code,
				zim.hospitalid, 
		        zim.departmentid, 
		        zim.goodsid, 
		        zim.sortname,
		        zim.productnamefirst,
		        zim.productnamesecond,
		        zim.goodsname,
		        zim.outlookc,
		        zim.goodstype,
		        zim.unit,
		        zim.regcodename,
		        zim.brand,
		        zim.source,
		        zim.purchaseprice, 
		        zim.companyidps,
		        zim.companynameps,
		        zim.addtime,
		        zim.lastupdatetime 
             
        FROM ZJ_INV_MAP zim
        LEFT JOIN MAT_INV_DICT mid ON zim.group_id = mid.group_id
        		and zim.hos_id = mid.hos_id and zim.copy_code = mid.copy_code
        		and zim.inv_id = mid.inv_id and mid.is_stop = 0
        
		<where>
			   zim.group_id = #{group_id,jdbcType=INTEGER}  
	    	   and zim.hos_id = #{hos_id,jdbcType=INTEGER} 
		       and zim.copy_code = #{copy_code,jdbcType=VARCHAR}  
 
				<if test="inv_code != null and inv_code != ''">
					AND (mid.inv_code like '%${inv_code}%'
						 or mid.inv_name  like '%${inv_code}%'
						 or mid.spell_code like '%${inv_code}%'
						 or mid.wbx_code like '%${inv_code}%'
					)
				</if>
				<if test="goodsid != null and goodsid != ''">
					AND (zim.goodsid like '%${goodsid}%'
						 or zim.goodsname  like '%${goodsid}%' 
					)
				</if>
 
		</where>
		order by mid.inv_code  asc
	</select>
	<select id="queryMatInvRelaByCode" parameterType="java.util.Map" resultMap="hospitalProcurecata" >
 		SELECT  zim.group_id,
				zim.hos_id,
				zim.copy_code,
				zim.inv_id,
				mid.inv_code,
				mid.inv_name,
				mid.inv_model,
				mid.unit_code,
				zim.hospitalid, 
		        zim.departmentid, 
		        zim.goodsid, 
		        zim.sortname,
		        zim.productnamefirst,
		        zim.productnamesecond,
		        zim.goodsname,
		        zim.outlookc,
		        zim.goodstype,
		        zim.unit,
		        zim.regcodename,
		        zim.brand,
		        zim.source,
		        zim.purchaseprice, 
		        zim.companyidps,
		        zim.companynameps,
		        zim.addtime,
		        zim.lastupdatetime 
             
        FROM ZJ_INV_MAP zim
        LEFT JOIN MAT_INV_DICT mid ON zim.group_id = mid.group_id
        		and zim.hos_id = mid.hos_id and zim.copy_code = mid.copy_code
        		and zim.inv_id = mid.inv_id and mid.is_stop = 0
        
		<where>
			   zim.group_id = #{group_id,jdbcType=INTEGER}  
	    	   and zim.hos_id = #{hos_id,jdbcType=INTEGER} 
		       and zim.copy_code = #{copy_code,jdbcType=VARCHAR}  
 			   and zim.inv_id = #{inv_id}
 			   and zim.goodsid = #{goodsid}
		</where>
		order by mid.inv_code  asc
	</select>
	<select id="queryMatInvRelaSptByGoodsId" parameterType="java.util.Map" resultMap="hospitalProcurecata">
 		select  zhpl.hospitalid, 
	        zhpl.departmentid, 
	        zhpl.goodsid, 
	        zhpl.sortname,
	        zhpl.productnamefirst,
	        zhpl.productnamesecond,
	        zhpl.goodsname,
	        zhpl.outlookc,
	        zhpl.goodstype,
	        zhpl.unit,
	        zhpl.regcodename,
	        zhpl.brand,
	        zhpl.source,
	        zhpl.purchaseprice,
	        zhpl.companyidtb,
	        zhpl.companynametb,
	        zhpl.companyidps,
	        zhpl.companynameps,
	        zhpl.purchasetype,
	        zhpl.addtime,
	        zhpl.lastupdatetime 
  		from ZJ_HOSPITAL_PROCURECATA_LOG zhpl
  		<where>
  			<if test="goodsid != null and goodsid != ''">
  				and zhpl.goodsid = #{goodsid}
  			</if>
  		</where>

	</select>
	<insert id="addMatInvRela" useGeneratedKeys="false">

	   INSERT INTO ZJ_INV_MAP (
			group_id ,
			hos_id ,
			copy_code ,
			inv_id ,
			hospitalid ,
			departmentid ,
			goodsid ,
			sortname,
			productnamefirst,
			productnamesecond,
			goodsname,
			outlookc,
			goodstype,
			unit,
			regcodename,
			brand,
			source,
			purchaseprice,
			addtime,
			lastupdatetime,
			companyidps,
			companynameps
		) VALUES (
			#{group_id,jdbcType=INTEGER} ,
			#{hos_id,jdbcType=INTEGER} ,
			#{copy_code,jdbcType=VARCHAR} ,
			#{inv_id,jdbcType=INTEGER} ,
			#{hospitalid,jdbcType=VARCHAR} ,
			#{departmentid,jdbcType=VARCHAR} ,
			#{goodsid,jdbcType=VARCHAR} ,
			#{sortname,jdbcType=VARCHAR},
			#{productnamefirst,jdbcType=VARCHAR},
			#{productnamesecond,jdbcType=VARCHAR},
			#{goodsname,jdbcType=VARCHAR},
			#{outlookc,jdbcType=VARCHAR},
			#{goodstype,jdbcType=VARCHAR},
			#{unit,jdbcType=VARCHAR},
			#{regcodename,jdbcType=VARCHAR},
			#{brand,jdbcType=VARCHAR},
			#{source,jdbcType=VARCHAR},
			#{purchaseprice,jdbcType=VARCHAR},
			#{addtime,jdbcType=VARCHAR},
			#{lastupdatetime,jdbcType=VARCHAR},
			#{companyidps,jdbcType=VARCHAR},
			#{companynameps,jdbcType=VARCHAR}
		)
 
	</insert>
	
	<update id="updateMatInvRela" parameterType="java.util.Map">

		UPDATE ZJ_INV_MAP SET
			inv_id = #{inv_id,jdbcType=INTEGER} ,
			hospitalid = #{hospitalid,jdbcType=VARCHAR} ,
			departmentid = #{departmentid,jdbcType=VARCHAR} ,
			goodsid = #{goodsid,jdbcType=VARCHAR} ,
			sortname = #{sortname,jdbcType=VARCHAR} ,
			productnamefirst = #{productnamefirst,jdbcType=VARCHAR} ,
			productnamesecond = #{productnamesecond,jdbcType=VARCHAR} ,
			goodsname = #{goodsname,jdbcType=VARCHAR} ,
			outlookc = #{outlookc,jdbcType=VARCHAR} ,
			goodstype = #{goodstype,jdbcType=VARCHAR} ,
			unit = #{unit,jdbcType=VARCHAR} ,
			regcodename = #{regcodename,jdbcType=VARCHAR} ,
			brand = #{brand,jdbcType=VARCHAR} ,
			source = #{source,jdbcType=VARCHAR} ,
			purchaseprice = #{purchaseprice,jdbcType=VARCHAR} ,
			addtime = #{addtime,jdbcType=VARCHAR} ,
			lastupdatetime = #{lastupdatetime,jdbcType=VARCHAR} ,
			companyidps = #{companyidps,jdbcType=VARCHAR} ,
			companynameps = #{companynameps,jdbcType=VARCHAR} 
		WHERE group_id = #{group_id,jdbcType=INTEGER} 
		and  hos_id = #{hos_id,jdbcType=INTEGER} 
		and  copy_code = #{copy_code,jdbcType=VARCHAR} 
		and  inv_id = #{old_inv_id,jdbcType=INTEGER} 
		and  goodsid = #{old_goodsid,jdbcType=VARCHAR}

	</update>
	
	<delete id="deleteBatchMatInvRela" parameterType="java.util.List">

		DELETE FROM ZJ_INV_MAP WHERE 
		<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
			  group_id = #{item.group_id,jdbcType=INTEGER}
			  and hos_id = #{item.hos_id,jdbcType=INTEGER}
			  and copy_code= #{item.copy_code,jdbcType=VARCHAR}
			  and inv_id = #{item.inv_id,jdbcType=INTEGER}
			  and goodsid = #{item.goodsid,jdbcType=VARCHAR}
			
		</foreach> 

	</delete>
	<select id="queryMatInvHrpBySelect" parameterType="java.util.Map" resultMap="matInvRelaSelect">
		select  mid.inv_id || ',' || mid.inv_no as id , 
				mid.inv_code || ' ' || mid.inv_name || '(' || mid.inv_model || ')' as text
		from MAT_INV_DICT mid
		<where>
			 	mid.group_id = #{group_id}
				and mid.hos_id = #{hos_id}
				and mid.copy_code = #{copy_code}
			 
			<if test="inv_id != null  and inv_id != ''">
				and mid.inv_id = #{inv_id}
			</if>
			<if test="mat_type_id != null  and mat_type_id != ''">
				and mid.mat_type_id = #{mat_type_id}
			</if>
			and mid.is_stop = 0
			and not exists (
			    select zim.inv_id from  ZJ_INV_MAP zim where mid.group_id = zim.group_id
			      and mid.hos_id = zim.hos_id and mid.copy_code = zim.copy_code
			      and mid.inv_id = zim.inv_id
			)
			<if test="key != null and key != ''">
				and ( mid.inv_code like '${key}%' 
					or mid.inv_name like '%${key}%'
					or mid.spell_code like '%${key}%' 
					or mid.wbx_code like '%${key}%'
				)
			</if>
		</where>
		order by mid.inv_code 
	</select>
	<select id="queryMatInvSptBySelect" parameterType="java.util.Map" resultMap="matInvRelaSelect">
		select 
			a.goodsid id, a.goodsname||'||'||a.outlookc text
		from ZJ_HOSPITAL_PROCURECATA_LOG a
		<where>
			<if test="key != null and key != ''">
				and (a.goodsname like '%${key}%'
				 	or a.goodsid = #{key}
				 )
			</if>
		</where>

	</select>
	
	<select id="getPlatformOrderDetailId" parameterType="java.util.Map" resultType="string">
		select platform_detail_id 
		from zj_order_map 
		where order_id=#{order_id,jdbcType=INTEGER} 
		and group_id=#{group_id,jdbcType=INTEGER}
		and hos_id=#{hos_id,jdbcType=INTEGER}
		and copy_code=#{copy_code,jdbcType=VARCHAR}
	</select>
	
	
	<update id="updateDeliveryMsg" parameterType="list">
		<foreach collection="list" item="item" open="begin" separator=";" close=";end;">
		update zj_order_map
		   set distributionserialid = #{item.distributionSerialID,jdbcType=VARCHAR}
		   <if test='item.batchRecordID != null and item.batchRecordID !=""'>
		   	   ,batchrecordid = #{item.batchRecordID,jdbcType=VARCHAR}
		   </if>
		   <if test='item.warehouseTime != null and item.warehouseTime !=""'>
		       ,warehousetime = #{item.warehouseTime,jdbcType=VARCHAR}
		   </if>
		   <if test='item.warehouseCount != null and item.warehouseCount !=""'>
		       ,warehousecount = #{item.warehouseCount,jdbcType=VARCHAR}
		   </if>
		   <if test='item.invoiceID != null and item.invoiceID !=""'>
		       ,invoiceid = #{item.invoiceID,jdbcType=VARCHAR}
		   </if>
		   <if test='item.distributeTime != null and item.distributeTime !=""'>
		       ,distributetime = #{item.distributeTime,jdbcType=VARCHAR}
		   </if>
		   <if test='item.distributeCount != null and item.distributeCount !=""'>
		       ,distributecount = #{item.distributeCount,jdbcType=VARCHAR}
		   </if>
		 where platform_detail_id = #{item.orderDetailID,jdbcType=VARCHAR}
		</foreach>
	</update>
	
	
	<insert id="insertDistribution" parameterType="java.util.List">
		<foreach collection="list" item="item" open="begin " separator=";" close=";end;">
			insert into MAT_DISTRIBUTION_ORDER
			  (group_id,hos_id,copy_code, platform_detail_id, distribution_id, batchrecord_id,invoice_id,distribution_count,distribution_time,warehouse_count,warehouse_time)
			select
			   #{item.group_id,jdbcType=INTEGER},
			   #{item.hos_id,jdbcType=INTEGER},
			   #{item.copy_code,jdbcType=VARCHAR},
			   #{item.orderDetailID,jdbcType=INTEGER},
			   #{item.distributionSerialID,jdbcType=VARCHAR},
			   #{item.batchRecordID,jdbcType=VARCHAR},
			   #{item.invoiceID,jdbcType=VARCHAR},
			   #{item.distributeCount,jdbcType=VARCHAR},
			   #{item.distributeTime,jdbcType=VARCHAR},
			   #{item.warehouseCount,jdbcType=VARCHAR},
			   #{item.warehouseTime,jdbcType=VARCHAR}
			from dual
						
		</foreach>
	
	</insert>
	
	
	<select id="queryPlatformDelivery" parameterType="java.util.Map" resultMap="zjOrderMap">
		<!-- select order_id,
		       order_detail_id,
		       platform_order_id,
		       platform_detail_id,
		       batchrecordid,
		       distributionserialid,
		       warehousetime,
		       warehousecount,
		       invoiceid,
		       distributetime,
		       distributecount
		  from zj_order_map
		  where order_id = #{order_id,jdbcType=INTEGER}
		  and group_id = #{group_id,jdbcType=INTEGER}
		  and hos_id = #{hos_id,jdbcType=INTEGER}
		  and copy_code=#{copy_code,jdbcType=VARCHAR} -->
		  select zom.order_id,
           zom.order_detail_id,
           zom.platform_order_id,
           zom.platform_detail_id,
           zom.batchrecordid,
           zom.distributionserialid,
           zom.warehousetime,
           zom.warehousecount,
           zom.invoiceid,
           zom.distributetime,
           zom.distributecount,
           modd.line_state
      from zj_order_map zom
      left join mat_order_detail  modd 
      on modd.order_id =zom.order_id
      and modd.order_detail_id = zom.order_detail_id
      and modd.group_id = zom.group_id
      and modd.hos_id = zom.hos_id
      and modd.copy_code = zom.copy_code
		  where zom.order_id = #{order_id,jdbcType=INTEGER}
		  and zom.group_id = #{group_id,jdbcType=INTEGER}
		  and zom.hos_id = #{hos_id,jdbcType=INTEGER}
		  and zom.copy_code=#{copy_code,jdbcType=VARCHAR}
		  and not exists (
         select * from mat_in_order_rela mior 
         where mior.order_id=#{order_id,jdbcType=INTEGER}
  		and mior.group_id = #{group_id,jdbcType=INTEGER}
		  and mior.hos_id = #{hos_id,jdbcType=INTEGER}
		  and mior.copy_code=#{copy_code,jdbcType=VARCHAR}
		  <if test="list != null and list !=''">
		  	and <foreach collection="list" item="item" index="index" open="(" separator="or" close=")">
		  		zom.order_detail_id = #{item.ORDER_DETAIL_ID,jdbcType=VARCHAR}
		  	</foreach>
		  </if>
		  
  )
	</select>
	
	<select id="queryPlatformDeliveryDis" parameterType="java.util.Map" resultMap="zjOrderMap">
		<!-- select order_id,
		       order_detail_id,
		       platform_order_id,
		       platform_detail_id,
		       batchrecordid,
		       distributionserialid,
		       warehousetime,
		       warehousecount,
		       invoiceid,
		       distributetime,
		       distributecount
		  from zj_order_map
		  where order_id = #{order_id,jdbcType=INTEGER}
		  and group_id = #{group_id,jdbcType=INTEGER}
		  and hos_id = #{hos_id,jdbcType=INTEGER}
		  and copy_code=#{copy_code,jdbcType=VARCHAR} -->
		  with temp as
			 (select mdo.group_id,
			         mdo.hos_id,
			         mdo.copy_code,
			         mdo.platform_detail_id,
			         mdo.distribution_id,
			         mdo.batchrecord_id,
			         mdo.invoice_id,
			         mdo.distribution_count,
			         mdo.distribution_time,
			         mdo.warehouse_count,
			         mdo.warehouse_time
			    from MAT_DISTRIBUTION_ORDER mdo
			    
			    ),
			temp1 as
			 (select zom.group_id,
			         zom.hos_id,
			         zom.copy_code,
			         zom.order_id,
			         zom.order_detail_id,
			         zom.platform_order_id,
			         zom.platform_detail_id,
			         zom.distributionserialid,
			         mid.inv_name,
			         mid.inv_model,
			         modd.line_state
			    from zj_order_map zom
			    left join mat_order_detail modd
			      on modd.order_id = zom.order_id
			     and modd.order_detail_id = zom.order_detail_id
			     and modd.group_id = zom.group_id
			     and modd.hos_id = zom.hos_id
			     and modd.copy_code = zom.copy_code
			    left join mat_inv_dict mid
			      on modd.inv_id = mid.inv_id
			     and modd.inv_no = mid.inv_no
			     and modd.group_id = mid.group_id
			     and modd.hos_id = mid.hos_id
			     and modd.copy_code = mid.copy_code
			     where zom.order_id = '5179'
			  
			  )
			 select  t.group_id,t.hos_id,t.copy_code,t.platform_detail_id,t.distribution_id, t.batchrecord_id, t.invoice_id, t.distribution_count, t.distribution_time, t.warehouse_count
				, t.warehouse_time,t1.order_id,t1.order_detail_id,t1.platform_order_id,t1.inv_name, t1.inv_model
      			, t1.line_state from temp t
			 right join temp1 t1 on t.PLATFORM_DETAIL_ID = t1.PLATFORM_DETAIL_ID 
			 left join zj_delivery_in_rela t2 on t.distribution_id=t2.distributionserialid
  				
		  where t1.order_id = #{order_id,jdbcType=INTEGER}
		  and t1.group_id = #{group_id,jdbcType=INTEGER}
		  and t1.hos_id = #{hos_id,jdbcType=INTEGER}
		  and t1.copy_code=#{copy_code,jdbcType=VARCHAR}
		  and t2.distributionserialid is  null
		  <!-- and t.distribution_id not in (
		         select zdir.distributionserialid
				from zj_delivery_in_rela zdir
         <where>
  			 
		  <if test="list != null and list !=''">
		  	<foreach collection="list" item="item" index="index" open="(" separator="or" close=")">
		  		zdir.distributionserialid = #{item.DISTRIBUTIONSERIALID,jdbcType=VARCHAR}
		  	</foreach>
		  </if>
		  </where>  
		  
  )-->
  or t.distribution_id is null 
  
  
	</select>
 
	<!--获取所有配送单明细  -->
	<select id="getPlatformDistributionByAll" parameterType="java.util.Map" resultType="string">
		select distributionserialid
		from zj_order_map
		where   group_id=#{group_id,jdbcType=INTEGER}
				and hos_id=#{hos_id,jdbcType=INTEGER}
				and copy_code=#{copy_code,jdbcType=VARCHAR}
				and distributionserialid is not  null
				and not exists(
					  select distributionSerialID from ZJ_BACK_ORDER_MAP
					  )
	</select>
	
	<!-- 添加退货信息返回的值 -->
	<insert id="insertMatBackResult">
		<foreach collection="list" item="item" open="begin" separator=";" close=";end;">
			insert into ZJ_BACK_ORDER_MAP
			
			  (
			   returnID
			   ,distributionSerialID
			   ,returnType
			   <if test="item.returnResponseTime!=null and item.returnResponseTime!=''">
			   ,returnResponseTime
			    </if>
			   <if test="item.isResponse!=null and item.isResponse!=''">
			   ,isResponse
			    </if>
			   <if test="item.refuseReason!=null and item.refuseReason!=''">
			   ,refuseReason
			   </if>
			   <if test="item.returnInvoiceId!=null and item.returnInvoiceId!=''">
			   ,returnInvoiceId
			    </if>
			   <if test="item.returnMaintenanceInvoiceTime!=null and item.returnMaintenanceInvoiceTime!=''">
			   ,returnMaintenanceInvoiceTime 
			   </if>
			   )
			select
				
			   #{item.returnID,jdbcType=VARCHAR}
			   ,#{item.distributionSerialID,jdbcType=VARCHAR}
			   ,#{item.returnType,jdbcType=VARCHAR}
			   <if test="item.returnResponseTime!=null and item.returnResponseTime!=''">
			   ,#{item.returnResponseTime,jdbcType=VARCHAR}
			   </if>
			   <if test="item.isResponse!=null and item.isResponse!=''">
			   ,#{item.isResponse,jdbcType=VARCHAR}
			   </if>
			   <if test="item.refuseReason!=null and item.refuseReason!=''">
			 	  ,#{item.refuseReason,jdbcType=VARCHAR}
			   </if>
			   <if test="item.returnInvoiceId!=null and item.returnInvoiceId!=''">
			   ,#{item.returnInvoiceId,jdbcType=VARCHAR}
			   </if>
			   <if test="item.returnMaintenanceInvoiceTime!=null and item.returnMaintenanceInvoiceTime!=''">
			   ,#{item.returnMaintenanceInvoiceTime,jdbcType=VARCHAR} 
			   </if>
			from dual
						
		</foreach>
	</insert>
	
 
	<select id = "queryMatStorageBackDetailById" parameterType="java.util.Map" resultMap="zjMatBackMap">
					     with back_temp as (
				select mim.group_id, mim.hos_id, mim.copy_code, mim.in_id, mid.in_detail_id
					, mid.note, mim.state,midd.inv_code,midd.inv_name,mid.inv_id, mid.inv_no, mid.batch_sn, mid.batch_no
					, mid.bar_code, mid.price, mid.amount, zim.goodsid
				from mat_in_detail mid
				left join mat_in_main mim on mid.group_id = mim.group_id
				and mid.hos_id = mim.hos_id
				and mid.copy_code = mim.copy_code
				and mid.in_id = mim.in_id 
					left join zj_inv_map zim on zim.group_id = mid.group_id
				and zim.hos_id = mid.hos_id
				and zim.copy_code = mid.copy_code
				and zim.inv_id = mid.inv_id
				left join mat_inv_dict midd
				on midd.group_id = mid.group_id
				and midd.hos_id = mid.hos_id
				and midd.copy_code = mid.copy_code
				and midd.inv_no = mid.inv_no
				and midd.inv_id = mid.inv_id
				where mim.group_id = #{group_id}
					and mim.hos_id = #{hos_id}
					and mim.copy_code = #{copy_code}
					and mim.in_id = #{in_id}
			), 
			in_temp as (
				select mim.group_id, mim.hos_id, mim.copy_code, mim.in_id, mid.in_detail_id
					, mim.bus_type_code, mim.brief, mid.inv_id, mid.inv_no, mid.batch_sn
					, mid.batch_no, mid.bar_code, mid.price, mid.amount, zdir.distributionserialid
				from mat_in_detail mid
				left join mat_in_main mim on mid.group_id = mim.group_id
				and mid.hos_id = mim.hos_id
				and mid.copy_code = mim.copy_code
				and mid.in_id = mim.in_id 
				left join mat_bus_type mby on mby.bus_type_code = mim.bus_type_code 
					left join zj_delivery_in_rela zdir on zdir.in_detail_id = mid.in_detail_id 
				where mim.group_id = #{group_id}
					and mim.hos_id = #{hos_id}
					and mim.copy_code = #{copy_code}
					and mby.in_out_type = '1'
					and mby.sel_flag = 'in'
			)
		select  a.in_detail_id,a.state,a.inv_code,a.inv_name,
		 b.distributionserialid, a.amount * -1 amount, a.note, goodsid
		from back_temp a
			left join in_temp b on a.group_id = b.group_id
		and a.hos_id = b.hos_id
		and a.copy_code = b.copy_code
		and a.inv_id = b.inv_id
		and a.inv_no = b.inv_no
		and a.batch_sn = b.batch_sn
		and a.batch_no = b.batch_no
		and a.bar_code = b.bar_code
		and a.price = b.price 
	</select>
	
	
	<select id="queryOrderDetailForIn" parameterType="java.util.Map" resultMap="inDetail">
		<!-- select md.group_id, md.hos_id, md.copy_code, md.order_id, md.order_detail_id
		      , md.order_code, mom.brif, mom.order_date, mom.maker, mom.sup_id
		      , mom.sup_no, hsd.sup_code, hsd.sup_name, su.user_name as maker_name, md.inv_id
		      , md.inv_no, mid.inv_code, mid.inv_name, mid.inv_model, mid.unit_code
		      , hu.unit_name, nvl(zim.purchaseprice, 0) as price
		      , nvl(md.amount, 0) - nvl(a_in.in_amount, 0) as order_amount
		      , nvl(a_in.in_amount, 0) as already_amount
		      , nvl(zom.distributecount, 0) as amount
		      , nvl(zom.distributecount, 0) * nvl(zim.purchaseprice, 0)  as amount_money
		      , hfd.fac_id, hfd.fac_no, hfd.fac_code, hfd.fac_name, mic.cert_code
		      , mic.cert_id, mid.is_bar, mid.is_batch, mid.is_per_bar, mid.is_quality
		      , mid.is_disinfect, mid.is_highvalue, mid.sell_price, hsdd.store_id, hsdd.store_no
		      , hsdd.store_code, hsdd.store_name, ms.stock_emp, t1.emp_code, t1.emp_name
		      , ms.manager, t2.emp_code as manager_code, t2.emp_name as manager_name
		      , zom.invoiceid,zom.batchrecordid batch_no ,zom.distributecount,zim.purchaseprice
		      , zom.distributionserialid,zom.batchrecordid
		from mat_order_detail md
		left join zj_order_map zom
		on zom.group_id=md.group_id
		and zom.hos_id=md.hos_id
		and zom.copy_code=md.copy_code
		and zom.order_detail_id=md.order_detail_id
		left join zj_inv_map zim
		on zim.group_id=md.group_id
		and zim.hos_id=md.hos_id
		and zim.copy_code=md.copy_code
		and zim.inv_id=md.inv_id
		left join mat_order_main mom on md.group_id = mom.group_id
		    and md.hos_id = mom.hos_id
		    and md.copy_code = mom.copy_code
		    and md.order_id = mom.order_id 
		left join mat_inv_dict mid on md.group_id = mid.group_id
		    and md.hos_id = mid.hos_id
		    and md.copy_code = mid.copy_code
		    and md.inv_id = mid.inv_id
		    and md.inv_no = mid.inv_no 
		left join hos_unit hu on mid.group_id = hu.group_id and mid.hos_id=hu.hos_id 
		     and mid.unit_code = hu.unit_code and hu.is_stop = 0
		left join sys_user su on mom.group_id=su.group_id and mom.hos_id=su.hos_id
			 and su.user_id = mom.maker and su.is_stop=0
		left join(
         	select group_id,hos_id,copy_code,order_id,order_detail_id,sum(nvl(in_amount,0)) in_amount 
         	from mat_in_order_rela 
         	<where>
         		<if test="group_id != null and group_id != ''">
					 group_id =#{group_id,jdbcType=INTEGER}
				</if>
				<if test="hos_id != null and hos_id != ''">
					and hos_id =#{hos_id,jdbcType=INTEGER}
				</if>
				<if test="copy_code != null and copy_code != ''">
					and copy_code =#{copy_code,jdbcType=VARCHAR}
				</if>
         	</where> 
         	group by group_id,hos_id,copy_code,order_id,order_detail_id
    	) a_in on md.group_id = a_in.group_id and md.hos_id=a_in.hos_id 
    		and md.copy_code= a_in.copy_code and md.order_id = a_in.order_id 
    		and md.order_detail_id = a_in.order_detail_id
		left join hos_sup_dict hsd on mom.group_id=hsd.group_id and mom.hos_id=hsd.hos_id 
		     and mom.sup_id = hsd.sup_id and hsd.is_stop = 0
		 left join hos_fac_dict hfd on mid.group_id = hfd.group_id and mid.hos_id = hfd.hos_id and mid.fac_id = hfd.fac_id 
			 and mid.fac_no = hfd.fac_no
		 left join (
		     select max(a.cert_id) AS cert_id,  a.inv_id, a.group_id, a.hos_id, a.copy_code
  			 from mat_prod_cert  b
    		 LEFT JOIN mat_prod_cert_inv a ON a.group_id = b.group_id
			 	AND a.hos_id = b.hos_id
			  	AND a.copy_code = b.copy_code
			  	AND a.cert_id = b.cert_id 
  			 WHERE a.group_id = #{group_id,jdbcType=INTEGER} 
			    AND a.hos_id = #{hos_id,jdbcType=INTEGER}
			    AND a.copy_code = #{copy_code,jdbcType=VARCHAR}
			    AND b.check_state = 2
			 GROUP BY a.inv_id, a.group_id, a.hos_id, a.copy_code
			 ORDER BY a.inv_id
		) mcr on mid.group_id = mcr.group_id 
			and mid.hos_id = mcr.hos_id 
			and mid.copy_code = mcr.copy_code and mid.inv_id = mcr.inv_id
		left join mat_prod_cert mic on  mcr.group_id = mic.group_id 
			and mcr.hos_id=mic.hos_id
     		and mcr.copy_code= mic.copy_code 
     		and mcr.cert_id=mic.cert_id  
     	left join mat_store_inv  msi on mid.group_id = msi.group_id
         	and mid.hos_id= msi.hos_id and mid.copy_code=msi.copy_code 
         	and mid.inv_id=msi.inv_id and msi.is_apply=1
        left join mat_store ms on msi.group_id = ms.group_id
			and msi.hos_id = ms.hos_id and msi.store_id = ms.store_id 
		left join hos_store_dict hsdd 
			on msi.group_id = hsdd.group_id and ms.hos_id = hsdd.hos_id 
			and(
				(mom.store_id is null and ms.store_id = hsdd.store_id and hsdd.is_stop = 0)
				or
				(mom.store_id is not null and mom.store_id = hsdd.store_id and mom.store_no = hsdd.store_no)
			) 
		left join hos_emp_dict t1 on t1.group_id = ms.group_id
			and t1.hos_id = ms.hos_id and t1.emp_id = ms.stock_emp and t1.is_stop = 0
		left join hos_emp_dict t2 on t2.group_id = ms.group_id
			and t2.hos_id = ms.hos_id and t2.emp_id = ms.manager and t2.is_stop = 0  
		<where>
			<if test="group_id != null and group_id != ''">
				 mom.group_id =#{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND mom.hos_id =#{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND mom.copy_code =#{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="order_id != null and order_id != ''">
				AND mom.order_id = #{order_id,jdbcType=INTEGER}
			</if>
			<if test="list != null and list !=''">
			 	and	
			 	<foreach collection="list" item="item" index="index" open="(" separator="or" close=")">
					md.order_detail_id = #{item.order_detail_id,jdbcType=VARCHAR}
				</foreach>
			
			</if>
			and mid.is_com = 0
			and mom.state = 2
			 and (nvl(md.amount,0)-nvl(a_in.in_amount,0)) > 0  
		</where>
		order by mid.inv_code -->
		with temp as
			 (select mdo.group_id,
			         mdo.hos_id,
			         mdo.copy_code,
			         mdo.platform_detail_id,
			         mdo.distribution_id,
			         mdo.batchrecord_id,
			         mdo.invoice_id,
			         mdo.distribution_count,
			         mdo.distribution_time,
			         mdo.warehouse_count,
			         mdo.warehouse_time
			    from MAT_DISTRIBUTION_ORDER mdo
			   
			  )
		
		select md.group_id, md.hos_id, md.copy_code, md.order_id, md.order_detail_id
		      , md.order_code, mom.brif, mom.order_date, mom.maker, mom.sup_id
		      , mom.sup_no, hsd.sup_code, hsd.sup_name, su.user_name as maker_name, md.inv_id
		      , md.inv_no, mid.inv_code, mid.inv_name, mid.inv_model, mid.unit_code
		      , hu.unit_name, nvl(zim.purchaseprice, 0) as price
		      , nvl(md.amount, 0) - nvl(a_in.in_amount, 0) as order_amount
		      , nvl(a_in.in_amount, 0) as already_amount
		      , nvl(t.warehouse_count, 0) as amount
		      , nvl(t.warehouse_count, 0) * nvl(zim.purchaseprice, 0)  as amount_money
		      , hfd.fac_id, hfd.fac_no, hfd.fac_code, hfd.fac_name, mic.cert_code
		      , mic.cert_id, mid.is_bar, mid.is_batch, mid.is_per_bar, mid.is_quality
		      , mid.is_disinfect, mid.is_highvalue, mid.sell_price, hsdd.store_id, hsdd.store_no
		      , hsdd.store_code, hsdd.store_name, ms.stock_emp, t1.emp_code, t1.emp_name
		      , ms.manager, t2.emp_code as manager_code, t2.emp_name as manager_name
		      , t.invoice_id, t.batchrecord_id batch_no,t.distribution_count,zim.purchaseprice
		      ,t.distribution_id, t.batchrecord_id
		from mat_order_detail md
		left join zj_order_map zom
		on zom.group_id=md.group_id
		and zom.hos_id=md.hos_id
		and zom.copy_code=md.copy_code
		and zom.order_detail_id=md.order_detail_id
		left join temp t on 
		t.platform_detail_id = zom.platform_detail_id
	   and zom.group_id = t.group_id
	   and zom.hos_id = t.hos_id
	   and zom.copy_code = t.copy_code
		left join zj_inv_map zim
		on zim.group_id=md.group_id
		and zim.hos_id=md.hos_id
		and zim.copy_code=md.copy_code
		and zim.inv_id=md.inv_id
		left join mat_order_main mom on md.group_id = mom.group_id
		    and md.hos_id = mom.hos_id
		    and md.copy_code = mom.copy_code
		    and md.order_id = mom.order_id 
		left join mat_inv_dict mid on md.group_id = mid.group_id
		    and md.hos_id = mid.hos_id
		    and md.copy_code = mid.copy_code
		    and md.inv_id = mid.inv_id
		    and md.inv_no = mid.inv_no 
		left join hos_unit hu on mid.group_id = hu.group_id and mid.hos_id=hu.hos_id 
		     and mid.unit_code = hu.unit_code and hu.is_stop = 0
		left join sys_user su on mom.group_id=su.group_id and mom.hos_id=su.hos_id
			 and su.user_id = mom.maker and su.is_stop=0
		left join(
         	select group_id,hos_id,copy_code,order_id,order_detail_id,sum(nvl(in_amount,0)) in_amount 
         	from mat_in_order_rela 
         	<where>
         		<if test="group_id != null and group_id != ''">
					 group_id =#{group_id,jdbcType=INTEGER}
				</if>
				<if test="hos_id != null and hos_id != ''">
					and hos_id =#{hos_id,jdbcType=INTEGER}
				</if>
				<if test="copy_code != null and copy_code != ''">
					and copy_code =#{copy_code,jdbcType=VARCHAR}
				</if>
         	</where> 
         	group by group_id,hos_id,copy_code,order_id,order_detail_id
    	) a_in on md.group_id = a_in.group_id and md.hos_id=a_in.hos_id 
    		and md.copy_code= a_in.copy_code and md.order_id = a_in.order_id 
    		and md.order_detail_id = a_in.order_detail_id
		left join hos_sup_dict hsd on mom.group_id=hsd.group_id and mom.hos_id=hsd.hos_id 
		     and mom.sup_id = hsd.sup_id and hsd.is_stop = 0
		 left join hos_fac_dict hfd on mid.group_id = hfd.group_id and mid.hos_id = hfd.hos_id and mid.fac_id = hfd.fac_id 
			 and mid.fac_no = hfd.fac_no
		 left join (
		     select max(a.cert_id) AS cert_id,  a.inv_id, a.group_id, a.hos_id, a.copy_code
  			 from mat_prod_cert  b
    		 LEFT JOIN mat_prod_cert_inv a ON a.group_id = b.group_id
			 	AND a.hos_id = b.hos_id
			  	AND a.copy_code = b.copy_code
			  	AND a.cert_id = b.cert_id 
  			 WHERE a.group_id = #{group_id,jdbcType=INTEGER} 
			    AND a.hos_id = #{hos_id,jdbcType=INTEGER}
			    AND a.copy_code = #{copy_code,jdbcType=VARCHAR}
			    AND b.check_state = 2
			 GROUP BY a.inv_id, a.group_id, a.hos_id, a.copy_code
			 ORDER BY a.inv_id
		) mcr on mid.group_id = mcr.group_id 
			and mid.hos_id = mcr.hos_id 
			and mid.copy_code = mcr.copy_code and mid.inv_id = mcr.inv_id
		left join mat_prod_cert mic on  mcr.group_id = mic.group_id 
			and mcr.hos_id=mic.hos_id
     		and mcr.copy_code= mic.copy_code 
     		and mcr.cert_id=mic.cert_id  
     	left join mat_store_inv  msi on mid.group_id = msi.group_id
         	and mid.hos_id= msi.hos_id and mid.copy_code=msi.copy_code 
         	and mid.inv_id=msi.inv_id and msi.is_apply=1
        left join mat_store ms on msi.group_id = ms.group_id
			and msi.hos_id = ms.hos_id and msi.store_id = ms.store_id 
		left join hos_store_dict hsdd 
			on msi.group_id = hsdd.group_id and ms.hos_id = hsdd.hos_id 
			and(
				(mom.store_id is null and ms.store_id = hsdd.store_id and hsdd.is_stop = 0)
				or
				(mom.store_id is not null and mom.store_id = hsdd.store_id and mom.store_no = hsdd.store_no)
			) 
		left join hos_emp_dict t1 on t1.group_id = ms.group_id
			and t1.hos_id = ms.hos_id and t1.emp_id = ms.stock_emp and t1.is_stop = 0
		left join hos_emp_dict t2 on t2.group_id = ms.group_id
			and t2.hos_id = ms.hos_id and t2.emp_id = ms.manager and t2.is_stop = 0  
		<where>
			<if test="group_id != null and group_id != ''">
				 mom.group_id =#{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND mom.hos_id =#{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND mom.copy_code =#{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="order_id != null and order_id != ''">
				AND mom.order_id = #{order_id,jdbcType=INTEGER}
			</if>
			<if test="list != null and list !=''">
			 	and	
			 	<foreach collection="list" item="item" index="index" open="(" separator="or" close=")">
					t.platform_detail_id = #{item.platform_detail_id,jdbcType=VARCHAR}
					and t.distribution_id = #{item.distribution_id,jdbcType=VARCHAR}
				</foreach>
			
			</if>
			and mid.is_com = 0
			and mom.state = 2
			 and (nvl(md.amount,0)-nvl(a_in.in_amount,0)) > 0  
		</where>
		order by mid.inv_code
		
	</select>
	
	
	<insert id="insertInDeliveryRela" parameterType="java.util.Map">
		<foreach collection="list" item="item" open="begin" separator=";" close=";end;">
			insert into zj_delivery_in_rela
			  (in_detail_id, distributionserialid)
			select 
				#{item.in_detail_id,jdbcType=INTEGER}, 
				#{item.distributionserialid ,jdbcType=VARCHAR}
			from dual
		</foreach>
	</insert>
	
	
	
	<select id="queryMatPayMainByCodeP" resultMap="matPay" parameterType="java.util.Map" >
	
		select 
		    mpd.pay_id,mpd.pay_bill_no,
			zim.companyIdPs companyId,
		    zim.companyNamePs
		from mat_pay_detail mpd
		left join mat_bill_detail mbd
		on mpd.group_id=mbd.group_id
		and mpd.hos_id=mbd.hos_id
		and mpd.copy_code=mbd.copy_code
		and mpd.bill_detail_id=mbd.bill_detail_id
		left join mat_in_detail mid
		on mid.group_id=mbd.group_id
		and mid.hos_id=mbd.hos_id
		and mid.copy_code=mbd.copy_code
		and mid.in_detail_id=mbd.in_detail_id
		left join zj_inv_map zim
		on zim.group_id=mid.group_id
		and zim.hos_id=mid.hos_id
		and zim.copy_code=mid.copy_code
		and zim.inv_id=mid.inv_id
		WHERE mpd.group_id = #{group_id,jdbcType=INTEGER}   
		  and mpd.hos_id = #{hos_id,jdbcType=INTEGER}   
		  and mpd.copy_code = #{copy_code,jdbcType=VARCHAR}   
		  and mpd.pay_id = #{pay_id,jdbcType=INTEGER} 
	      and zim.companyidps is not null
	</select>
	
	<select id="queryMatPaydetailByCodeP" resultMap="matPay" parameterType="java.util.Map" >
	
		select distinct c.distributionserialid storageId,
		       '无' as orderCustomInfo 
		    from mat_pay_detail a 
			left join mat_bill_detail b on a.bill_id=b.bill_id
			and a.bill_detail_id=b.bill_detail_id
			left join zj_delivery_in_rela c on b.in_detail_id=c.in_detail_id
			where a.pay_id=#{pay_id,jdbcType=INTEGER} 
			and nvl(distributionserialid,0)  &lt;&gt;  0
		
	
	</select>
	
	<select id="queryExistsInvRelaByGoodsId" parameterType="java.util.Map" resultMap="hospitalProcurecata">
		select 
			zim.group_id, zim.hos_id, zim.copy_code, zim.inv_id, zim.hospitalid, 
			zim.departmentid, zim.goodsid, zim.sortname, zim.productnamefirst, 
			zim.productnamesecond, zim.goodsname, zim.unit, zim.regcodename, 
			zim.brand, zim.source, zim.purchaseprice, zim.addtime, zim.lastupdatetime, 
			zim.companyidps, zim.companynameps, zim.goodstype, zim.outlookc 
		from zj_inv_map zim
    left join mat_inv_dict mid
    on zim.group_id= mid.group_id
    and zim.hos_id = mid.hos_id
    and zim.copy_code = mid.copy_code
    and zim.inv_id = mid.inv_id
		<where>
			<if test="group_id !=null and group_id !=''">
				 zim.group_id=#{group_id,jdbcType=VARCHAR}
			</if>
			<if test="hos_id !=null and hos_id !=''">
				and zim.hos_id=#{hos_id,jdbcType=VARCHAR}
			</if>
			<if test="copy_code !=null and copy_code !=''">
				and zim.copy_code=#{copy_code,jdbcType=VARCHAR}  
			</if>
			<if test="inv_id !=null and inv_id !=''">
				and zim.inv_id=#{inv_id,jdbcType=VARCHAR}
			</if>
			<if test="inv_code !=null and inv_code !=''">
				and mid.inv_code=#{inv_code,jdbcType=VARCHAR}
			</if>
			<if test="goodsid !=null and goodsid !=''">
				and zim.goodsid=#{goodsid,jdbcType=VARCHAR}
			</if>
		</where>
	</select>
 
 	<select id="queryOrderDetail"  parameterType="java.util.Map" resultType="string"> 
 		select order_detail_id
 			from zj_order_map  
 		  where platform_order_id  = #{orderId,jdbcType=VARCHAR}
 		  and platform_detail_id = #{orderDetailID,jdbcType=VARCHAR}
 	</select>
 	
 	<select id="queryInOrder" parameterType="java.util.Map" resultType="java.util.Map">
 	select zdir.distributionserialid
		from mat_in_order_rela mior
		left join zj_delivery_in_rela zdir
		 on mior.in_detail_id = zdir.in_detail_id where mior.order_id =#{order_id,jdbcType=VARCHAR} 
 	
 	
 	</select>
 	
 	<select id="queryMatInvRelaByCodes" parameterType="java.util.Map" resultType="int" >
	   SELECT  count(*)
	             
	        FROM ZJ_INV_MAP zim
	        LEFT JOIN MAT_INV_DICT mid ON zim.group_id = mid.group_id
	          and zim.hos_id = mid.hos_id and zim.copy_code = mid.copy_code
	          and zim.inv_id = mid.inv_id and mid.is_stop = 0
	        
	  <where>
	      zim.group_id = #{group_id,jdbcType=INTEGER}  
	         and zim.hos_id = #{hos_id,jdbcType=INTEGER} 
	         and zim.copy_code = #{copy_code,jdbcType=INTEGER}  
	         <if test="inv_id != null and inv_id != ''">
	           and zim.inv_id = #{inv_id,jdbcType=INTEGER}
	         </if>
	         <if test="inv_code != null and inv_code != ''">
	           and mid.inv_code = #{inv_code,jdbcType=VARCHAR}
	         </if>
	         <if test="goodsid != null and goodsid != ''">
	        and zim.goodsid = #{goodsid,jdbcType=VARCHAR}
	       </if>  
	  </where>
	  order by mid.inv_code  asc
 </select>
 
 
 <select id="queryInvCode" parameterType="java.util.Map" resultMap="hospitalProcurecata">
  select  mid.inv_id , mid.inv_code ,mid.inv_name|| '(' || mid.inv_model || ')' inv_name
  from MAT_INV_DICT mid
  <where>
     mid.group_id = #{group_id}
    and mid.hos_id = #{hos_id}
    and mid.copy_code = #{copy_code}
    
   <if test="inv_id != null  and inv_id != ''">
    and mid.inv_id = #{inv_id}
   </if>
   <if test="mat_type_id != null  and mat_type_id != ''">
    and mid.mat_type_id = #{mat_type_id}
   </if>
   <if test="inv_code != null  and inv_code != ''">
    and mid.inv_code = #{inv_code}
   </if>
   and mid.is_stop = 0
   and not exists (
       select zim.inv_id from  ZJ_INV_MAP zim where mid.group_id = zim.group_id
         and mid.hos_id = zim.hos_id and mid.copy_code = zim.copy_code
         and mid.inv_id = zim.inv_id
   )
   <if test="key != null and key != ''">
    and ( mid.inv_code like '${key}%' 
     or mid.inv_name like '%${key}%'
     or mid.spell_code like '%${key}%' 
     or mid.wbx_code like '%${key}%'
    )
   </if>
  </where>
  order by mid.inv_code 
 
 
 </select>
 
 
  <select id="queryGoodsid" parameterType="java.util.Map" resultMap="hospitalProcurecata">
  select 
   a.goodsid , a.goodsname||'||'||a.outlookc goodsname
  from ZJ_HOSPITAL_PROCURECATA_LOG a
  <where>
   
   <if test="key != null and key != ''">
    and a.goodsname like '%${key}%'
   </if>
   <if test="goodsid != null and goodsid != ''">
    and a.goodsid =#{goodsid,jdbcType=VARCHAR}
   </if>
   <if test="goodsname != null and goodsname != ''">
    and a.goodsname =#{goodsname,jdbcType=VARCHAR}
   </if>
  </where>
 
 </select>
 
  <select id="queryExistsInvRelaByGoodsIdBatch" parameterType="java.util.Map" resultMap="hospitalProcurecata">
  select 
   zim.group_id, zim.hos_id, zim.copy_code, zim.inv_id, zim.hospitalid, 
   zim.departmentid, zim.goodsid, zim.sortname, zim.productnamefirst, 
   zim.productnamesecond, zim.goodsname, zim.unit, zim.regcodename, 
   zim.brand, zim.source, zim.purchaseprice, zim.addtime, zim.lastupdatetime, 
   zim.companyidps, zim.companynameps, zim.goodstype, zim.outlookc 
  from zj_inv_map zim
  LEFT JOIN MAT_INV_DICT mid ON zim.group_id = mid.group_id
          and zim.hos_id = mid.hos_id and zim.copy_code = mid.copy_code
          and zim.inv_id = mid.inv_id and mid.is_stop = 0
  <where>
  <foreach collection="list" item="item" open="(" separator="or"  close=")">
   <if test="item.group_id !=null and item.group_id !=''">
    zim.group_id=#{item.group_id,jdbcType=VARCHAR}
   </if>
   <if test="item.hos_id !=null and item.hos_id !=''">
    and zim.hos_id=#{item.hos_id,jdbcType=VARCHAR}
   </if>
   <if test="item.copy_code !=null and item.copy_code !=''">
    and zim.copy_code=#{item.copy_code,jdbcType=VARCHAR}
   </if>
   <if test="item.inv_id !=null and item.inv_id !=''">
    and zim.inv_id=#{item.inv_id,jdbcType=VARCHAR}
   </if>
   <if test="item.inv_code !=null and item.inv_code !=''">
    and mid.inv_code=#{item.inv_code,jdbcType=VARCHAR}
   </if>
   <if test="item.goodsid !=null and item.goodsid !=''">
    and zim.goodsid=#{item.goodsid,jdbcType=VARCHAR}
   </if>
   </foreach>
  </where>
 
 </select>
 
 
  <select id="queryMatInvRelaSptByGoodsIdBatch" parameterType="java.util.Map" resultMap="hospitalProcurecata">
  select  zhpl.hospitalid, 
         zhpl.departmentid, 
         zhpl.goodsid, 
         zhpl.sortname,
         zhpl.productnamefirst,
         zhpl.productnamesecond,
         zhpl.goodsname,
         zhpl.outlookc,
         zhpl.goodstype,
         zhpl.unit,
         zhpl.regcodename,
         zhpl.brand,
         zhpl.source,
         zhpl.purchaseprice,
         zhpl.companyidtb,
         zhpl.companynametb,
         zhpl.companyidps,
         zhpl.companynameps,
         zhpl.purchasetype,
         zhpl.addtime,
         zhpl.lastupdatetime 
    from ZJ_HOSPITAL_PROCURECATA_LOG zhpl
    <where>
     <foreach collection="list" item="item" open="(" separator="or"  close=")">
      <if test="item.goodsid != null and item.goodsid != ''">
        zhpl.goodsid = #{item.goodsid,jdbcType=VARCHAR}
      </if>
     </foreach>
    </where>
 
 </select>
 
</mapper>