<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.sys.dao.baseData.SysAccSubjMapper">
	
	
	<resultMap id="sysAccSubj"  type="java.util.Map">
        <result property="subj_id" column="subj_id"/>
        <result property="group_id" column="group_id"/>
        <result property="hos_id" column="hos_id"/>
        <result property="copy_code" column="copy_code"/>
        <result property="acc_year" column="acc_year"/>
        <result property="subj_code" column="subj_code"/>
        <result property="cur_code" column="cur_code"/>
        <result property="subj_type_code" column="subj_type_code"/>
        <result property="subj_nature_code" column="subj_nature_code"/>
        <result property="subj_nature_name" column="subj_nature_name"/>
        <result property="vouch_type_code" column="vouch_type_code"/>
        <result property="super_code" column="super_code"/>
        <result property="subj_name" column="subj_name"/>
        <result property="subj_name_all" column="subj_name_all"/>
        <result property="subj_name_en" column="subj_name_en"/>
        <result property="is_cash" column="is_cash"/>
        <result property="is_bill" column="is_bill"/>
        <result property="subj_dire" column="subj_dire"/>
        <result property="subj_level" column="subj_level"/>
        <result property="is_last" column="is_last"/>
        <result property="spell_code" column="spell_code"/>
        <result property="wbx_code" column="wbx_code"/>
        <result property="is_stop" column="is_stop"/>
        <result property="is_remit" column="is_remit"/>
        <result property="is_check" column="is_check"/>
        <result property="check1" column="check1"/>
        <result property="check2" column="check2"/>
        <result property="check3" column="check3"/>
        <result property="check4" column="check4"/>
        <result property="check5" column="check5"/>
        <result property="check6" column="check6"/>
        <result property="check7" column="check7"/>
        <result property="check8" column="check8"/>
        <result property="check9" column="check9"/>
        <result property="check10" column="check10"/>
		<result property="debit" column="debit"/>	
		<result property="bal_os" column="bal_os"/>
		<result property="end_os" column="end_os"/>
		<result property="check1_str" column="check1_str"/>
        <result property="check2_str" column="check2_str"/>
        <result property="check3_str" column="check3_str"/>
        <result property="check4_str" column="check4_str"/>
        <result property="check5_str" column="check5_str"/>
        <result property="check6_str" column="check6_str"/>
        <result property="check7_str" column="check7_str"/>
        
        <!-- 以下用于返回科目挂的辅助核算信息 add by alfred-->
        <result property="check_type_name" column="check_type_name"/>
        <result property="column_id" column="column_id"/>
        <result property="column_no" column="column_no"/>
        <result property="column_code" column="column_code"/>
        <result property="column_name" column="column_name"/>
        <result property="column_check" column="column_check"/>
        <!-- 以下用于返回科目挂的辅助核算类型信息 -->
        <result property="check_type_code1" column="check_type_code1"/>
        <result property="check_type_code2" column="check_type_code2"/>
        <result property="check_type_code3" column="check_type_code3"/>
        <result property="check_type_code4" column="check_type_code4"/>
        <!-- 会计科目所挂部门支出性质 -->
        <result property="out_code" column="out_code"/>
        <result property="out_name" column="out_name"/>
        <result property="judge_subj_code" column="judge_subj_code"/>
        <result property="error_type" column="error_type"/>
        
        <result property="check1_name" column="check1_name"/>
        <result property="check2_name" column="check2_name"/>
        <result property="check3_name" column="check3_name"/>
        <result property="check4_name" column="check4_name"/>
	</resultMap>
	
	<resultMap id="accSubj1"  type="java.util.Map">
        <result property="subj_id" column="subj_id"/>
        <result property="group_id" column="group_id"/>
        <result property="hos_id" column="hos_id"/>
        <result property="copy_code" column="copy_code"/>
        <result property="acc_year" column="acc_year"/>
        <result property="subj_code" column="subj_code"/>
        <result property="cur_code" column="cur_code"/>
        <result property="subj_type_code" column="subj_type_code"/>
        <result property="subj_nature_code" column="subj_nature_code"/>
        <result property="subj_nature_name" column="subj_nature_name"/>
        <result property="vouch_type_code" column="vouch_type_code"/>
        <result property="super_code" column="super_code"/>
        <result property="subj_name" column="subj_name"/>
        <result property="subj_name_all" column="subj_name_all"/>
        <result property="subj_name_en" column="subj_name_en"/>
        <result property="is_cash" column="is_cash"/>
        <result property="is_bill" column="is_bill"/>
       <!--  <result property="is_pact" column="is_pact"/> -->
        <result property="subj_dire" column="subj_dire"/>
        <result property="subj_level" column="subj_level"/>
        <result property="is_last" column="is_last"/>
        <result property="spell_code" column="spell_code"/>
        <result property="wbx_code" column="wbx_code"/>
        <result property="is_stop" column="is_stop"/>
        <result property="is_remit" column="is_remit"/>
        <result property="is_check" column="is_check"/>
        <result property="check1" column="check1"/>
        <result property="check2" column="check2"/>
        <result property="check3" column="check3"/>
        <result property="check4" column="check4"/>
        <result property="check5" column="check5"/>
        <result property="check6" column="check6"/>
        <result property="check7" column="check7"/>
        <result property="check8" column="check8"/>
        <result property="check9" column="check9"/>
        <result property="check10" column="check10"/>
		<result property="debit" column="debit"/>	
		<result property="bal_os" column="bal_os"/>
		<result property="end_os" column="end_os"/>
		<result property="check1_str" column="check1_str"/>
        <result property="check2_str" column="check2_str"/>
        <result property="check3_str" column="check3_str"/>
        <result property="check4_str" column="check4_str"/>
        <result property="check5_str" column="check5_str"/>
        <result property="check6_str" column="check6_str"/>
        <result property="check7_str" column="check7_str"/>
        
        <!-- 以下用于返回科目挂的辅助核算信息 add by alfred-->
        <result property="check_type_name" column="check_type_name"/>
        <result property="column_id" column="column_id"/>
        <result property="column_no" column="column_no"/>
        <result property="column_code" column="column_code"/>
        <result property="column_name" column="column_name"/>
        <result property="column_check" column="column_check"/>
        <!-- 以下用于返回科目挂的辅助核算类型信息 -->
        <result property="check_type_code1" column="check_type_code1"/>
        <result property="check_type_code2" column="check_type_code2"/>
        <result property="check_type_code3" column="check_type_code3"/>
        <result property="check_type_code4" column="check_type_code4"/>
        <!-- 会计科目所挂部门支出性质 -->
        <result property="out_code" column="out_code"/>
        <result property="out_name" column="out_name"/>
        
        <result property="error_type" column="error_type"/>
	</resultMap>
	<resultMap id="sysAccSubjRules" type="com.chd.hrp.sys.entity.Rules">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="mod_code" column="mod_code" />
		<result property="mod_name" column="mod_name" />
		<result property="copy_code" column="copy_code" />
		<result property="copy_name" column="copy_name" />
		<result property="proj_code" column="proj_code" />
		<result property="proj_name" column="proj_name" />
		<result property="max_level" column="max_level" />
		<result property="max_length" column="max_length" />
		<result property="level1" column="level1" />
		<result property="level2" column="level2" />
		<result property="level3" column="level3" />
		<result property="level4" column="level4" />
		<result property="level5" column="level5" />
		<result property="level6" column="level6" />
		<result property="level7" column="level7" />
		<result property="level8" column="level8" />
		<result property="level9" column="level9" />
		<result property="level10" column="level10" />
		<result property="is_auto" column="is_auto" />
	</resultMap>
	
	<resultMap id="accCheckType" type="com.chd.hrp.acc.entity.AccCheckType">
		<result property="check_type_id" column="check_type_id" />
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="check_table" column="check_table" />
		<result property="check_type_name" column="check_type_name" />
		<result property="check_type_code" column="check_type_code" />
		<result property="sort_code" column="sort_code" />
		<result property="spell_code" column="spell_code" />
		<result property="wbx_code" column="wbx_code" />
		<result property="is_stop" column="is_stop" />
		<result property="is_sys" column="is_sys" />
		<result property="column_id" column="column_id" />
		<result property="column_no" column="column_no" />
		<result property="column_code" column="column_code" />
		<result property="column_name" column="column_name" />
		<result property="column_check" column="column_check" />
		<result property="is_change" column="is_change" />
		<result property="z_code" column="z_code" />
	</resultMap>
	<!--用于集团科目选择器 为什么新增加resultMap 1、查询科目返回的是实体类2、mapper中有返回map的 不知道在哪使用  -->
	<resultMap id="accSubj"  type="com.chd.hrp.acc.entity.AccSubj">
        <result property="subj_id" column="subj_id"/>
        <result property="group_id" column="group_id"/>
        <result property="hos_id" column="hos_id"/>
        <result property="copy_code" column="copy_code"/>
        <result property="acc_year" column="acc_year"/>
        <result property="subj_code" column="subj_code"/>
        <result property="cur_code" column="cur_code"/>
        <result property="subj_type_code" column="subj_type_code"/>
        <result property="subj_nature_code" column="subj_nature_code"/>
        <result property="subj_nature_name" column="subj_nature_name"/>
        <result property="vouch_type_code" column="vouch_type_code"/>
        <result property="super_code" column="super_code"/>
        <result property="subj_name" column="subj_name"/>
        <result property="subj_name_all" column="subj_name_all"/>
        <result property="subj_name_en" column="subj_name_en"/>
        <result property="is_cash" column="is_cash"/>
        <result property="is_bill" column="is_bill"/>
       <!--  <result property="is_pact" column="is_pact"/> -->
        <result property="subj_dire" column="subj_dire"/>
        <result property="subj_level" column="subj_level"/>
        <result property="is_last" column="is_last"/>
        <result property="spell_code" column="spell_code"/>
        <result property="wbx_code" column="wbx_code"/>
        <result property="is_stop" column="is_stop"/>
        <result property="is_remit" column="is_remit"/>
        <result property="is_check" column="is_check"/>
        <result property="check1" column="check1"/>
        <result property="check2" column="check2"/>
        <result property="check3" column="check3"/>
        <result property="check4" column="check4"/>
        <result property="check5" column="check5"/>
        <result property="check6" column="check6"/>
        <result property="check7" column="check7"/>
        <result property="check8" column="check8"/>
        <result property="check9" column="check9"/>
        <result property="check10" column="check10"/>
		<result property="debit" column="debit"/>	
		<result property="bal_os" column="bal_os"/>
		<result property="end_os" column="end_os"/>
		<result property="check1_str" column="check1_str"/>
        <result property="check2_str" column="check2_str"/>
        <result property="check3_str" column="check3_str"/>
        <result property="check4_str" column="check4_str"/>
        <result property="check5_str" column="check5_str"/>
        <result property="check6_str" column="check6_str"/>
        <result property="check7_str" column="check7_str"/>
        
        <!-- 以下用于返回科目挂的辅助核算信息 add by alfred-->
        <result property="check_type_name" column="check_type_name"/>
        <result property="column_id" column="column_id"/>
        <result property="column_no" column="column_no"/>
        <result property="column_code" column="column_code"/>
        <result property="column_name" column="column_name"/>
        <result property="column_check" column="column_check"/>
        <!-- 以下用于返回科目挂的辅助核算类型信息 -->
        <result property="check_type_code1" column="check_type_code1"/>
        <result property="check_type_code2" column="check_type_code2"/>
        <result property="check_type_code3" column="check_type_code3"/>
        <result property="check_type_code4" column="check_type_code4"/>
        <!-- 会计科目所挂部门支出性质 -->
        <result property="out_code" column="out_code"/>
        <result property="out_name" column="out_name"/>
        <result property="judge_subj_code" column="judge_subj_code"/>
        
        <result property="error_type" column="error_type"/>
	</resultMap>
	
	
	
	
    <select id="queryAccSubj" parameterType="java.util.Map" resultMap="sysAccSubj">
		SELECT
		asubj.subj_id,
		asubj.group_id,
		asubj.hos_id,
		asubj.copy_code,
		asubj.acc_year,
		asubj.subj_code,
		asubj.cur_code,
		asubj.subj_type_code,
		asubj.subj_nature_code,
		asn.subj_nature_name,
		asubj.vouch_type_code,
		asubj.super_code,
		asubj.subj_name,
		asubj.subj_name_all,
		asubj.subj_name_en,
		asubj.is_cash,
		asubj.is_bill,
		<!-- asubj.is_pact, -->
		asubj.is_remit,
		asubj.subj_dire,
		asubj.subj_level,
		asubj.is_last,
		asubj.spell_code,
		asubj.wbx_code,
		asubj.is_stop,
		asubj.is_check,
		act1.check_type_name check1_name,
		act2.check_type_name check2_name,
		act3.check_type_name check3_name,
		act4.check_type_name check4_name
		FROM ACC_SUBJ asubj
		left join ACC_SUBJ_NATURE asn ON
		asubj.GROUP_ID = asn.GROUP_ID and
		asubj.HOS_ID = asn.HOS_ID and
		asubj.COPY_CODE = asn.COPY_CODE and
		asubj.SUBJ_NATURE_CODE = asn.SUBJ_NATURE_CODE
		left join ACC_CHECK_TYPE act1 on asubj.GROUP_ID = act1.GROUP_ID AND
		asubj.HOS_ID = act1.HOS_ID AND asubj.COPY_CODE = act1.COPY_CODE AND
		asubj.check1 = act1.CHECK_TYPE_ID
		left join ACC_CHECK_TYPE act2 on asubj.GROUP_ID = act2.GROUP_ID AND
		asubj.HOS_ID = act2.HOS_ID AND asubj.COPY_CODE = act2.COPY_CODE AND
		asubj.check2 = act2.CHECK_TYPE_ID
		left join ACC_CHECK_TYPE act3 on asubj.GROUP_ID = act3.GROUP_ID AND
		asubj.HOS_ID = act3.HOS_ID AND asubj.COPY_CODE = act3.COPY_CODE AND
		asubj.check3 = act3.CHECK_TYPE_ID
		left join ACC_CHECK_TYPE act4 on asubj.GROUP_ID = act4.GROUP_ID AND
		asubj.HOS_ID = act4.HOS_ID AND asubj.COPY_CODE = act4.COPY_CODE AND
		asubj.check4 = act4.CHECK_TYPE_ID
		<where>
			<if test="subj_id != null and subj_id != ''">
				AND asubj.subj_id = #{subj_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND asubj.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND asubj.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND asubj.copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND asubj.acc_year = #{acc_year}
			</if>
			<if test="subj_code != null and subj_code != ''">
				AND asubj.subj_code like #{subj_code}||'%'
			</if>
			<if test="cur_code != null and cur_code != ''">
				AND asubj.cur_code = #{cur_code}
			</if>
			<if test="subj_type_code != null and subj_type_code != ''">
				AND asubj.subj_type_code = #{subj_type_code}
			</if>
			<if test="subj_nature_code != null and subj_nature_code != ''">
				AND asubj.subj_nature_code = #{subj_nature_code}
			</if>
			<!-- <if test="vouch_type_code != null and vouch_type_code != ''"> AND 
				asubj.vouch_type_code = #{vouch_type_code} </if> -->
			<if test="super_code != null and super_code != ''">
				AND asubj.super_code = #{super_code}
			</if>
			<if test="subj_name != null and subj_name != ''">
				and ( asubj.subj_name like '%${subj_name}%' or
				asubj.subj_name_all like '%${subj_name}%' or
				upper(asubj.spell_code) like '%${subj_name}%' or
				lower(asubj.spell_code) like '%${subj_name}%' or
				upper(asubj.wbx_code) like '%${subj_name}%' or
				lower(asubj.wbx_code) like '%${subj_name}%'
				)
			</if>
			<if test="subj_name_all != null and subj_name_all != ''">
				AND asubj.subj_name_all = #{subj_name_all}
			</if>
			<if test="subj_name_en != null and subj_name_en != ''">
				AND asubj.subj_name_en = #{subj_name_en}
			</if>
			<if test="is_cash != null and is_cash != ''">
				AND asubj.is_cash = #{is_cash}
			</if>
			<if test="subj_dire != null and subj_dire != ''">
				AND asubj.subj_dire = #{subj_dire}
			</if>
			<if test="subj_level != null and subj_level != ''">
				AND asubj.subj_level = #{subj_level}
			</if>
			<if test="is_last != null and is_last != ''">
				AND asubj.is_last = #{is_last}
			</if>
			<if test="spell_code != null and spell_code != ''">
				AND asubj.spell_code = #{spell_code}
			</if>
			<if test="wbx_code != null and wbx_code != ''">
				AND asubj.wbx_code = #{wbx_code}
			</if>
			<if test="is_stop != null and is_stop != ''">
				AND asubj.is_stop = #{is_stop}
			</if>
			<if test="is_check != null and is_check != ''">
				AND asubj.is_check = #{is_check}
			</if>
			<if test="check1 != null and check1 != ''">
				AND asubj.check1 = #{check1}
			</if>
			<if test="check2 != null and check2 != ''">
				AND asubj.check2 = #{check2}
			</if>
			<if test="check3 != null and check3 != ''">
				AND asubj.check3 = #{check3}
			</if>
			<if test="check4 != null and check4 != ''">
				AND asubj.check4 = #{check4}
			</if>
			<if test="check5 != null and check5 != ''">
				AND asubj.check5 = #{check5}
			</if>
			<if test="check6 != null and check6 != ''">
				AND asubj.check6 = #{check6}
			</if>
			<if test="check7 != null and check7 != ''">
				AND asubj.check7 = #{check7}
			</if>
			<if test="check8 != null and check8 != ''">
				AND asubj.check8 = #{check8}
			</if>
			<if test="check9 != null and check9 != ''">
				AND asubj.check9 = #{check9}
			</if>
			<if test="check10 != null and check10 != ''">
				AND asubj.check10 = #{check10}
			</if>
		</where>
		order by asubj.subj_code asc
    </select>
    <!-- 删除字典时，判断业务表是否使用 -->
	<select id="querySysDictDelCheck" statementType="CALLABLE" parameterType="java.util.Map" >
		<![CDATA[
		{call sys_dict_del_check(
	        #{dict_id_str},#{dict_code},#{group_id},#{hos_id},#{copy_code},#{acc_year},#{p_flag},
	        #{reNote,mode=OUT,jdbcType=VARCHAR}
		)}
		]]>
   </select>
   <!-- 批量删除 会计科目 -->
   <delete id="deleteBatchAccSubj" parameterType="java.util.List">
		DELETE FROM acc_subj WHERE
		<foreach collection="list" index="index" item="item" open="("
			separator="or" close=")">
			<!-- subj_id = #{item.subj_id}
			and -->
			group_id = #{item.group_id}
			and
			hos_id = #{item.hos_id}
			and
			copy_code = #{item.copy_code}
			and
			acc_year = #{item.acc_year}
			and 
			subj_code like '${item.subj_code}%'
		</foreach>
    </delete>
    <!-- 删除操作，根据父科目查询是否有子科目，没有就修改为末级
		  修改编码操作，根据父科目查询是否有子科目，老的父科目没有就修改为末级
	 -->
	<update id="updateSubjIsLastBySuperSubjCode" parameterType="java.util.Map" >
		  
	     update acc_subj set is_last=1 where 
	     subj_id in(
		     select subj_id from acc_subj where subj_code not in(    
			     select super_code from acc_subj 
			     where super_code in(${super_code}) 
			     and group_id = #{group_id} and hos_id = #{hos_id} and copy_code = #{copy_code} and acc_year = #{acc_year}
			     group by super_code
			 ) 
		     and subj_code in(${super_code})
		     and group_id = #{group_id} and hos_id = #{hos_id} and copy_code = #{copy_code} and acc_year = #{acc_year}
	     )
   </update>
   <!-- 查询编码规则 -->
   <select id="queryRulesByCode" resultMap="sysAccSubjRules" parameterType="java.util.Map">

		SELECT
		group_id,
		hos_id,
		mod_code,
		copy_code,
		proj_code,
		proj_name,
		max_level,
		max_length,
		level1,
		level2,
		level3,
		level4,
		level5,
		level6,
		level7,
		level8,
		level9,
		level10,
		is_auto
		FROM hos_rules
		WHERE
		group_id = #{group_id} and
		hos_id = #{hos_id} 
<!-- 		<if test="copy_code != null and copy_code !='' and  mod_code != '00'"> -->
<!-- 			and copy_code = #{copy_code} -->
<!-- 		</if> -->
		 and mod_code = #{mod_code}
		 and proj_code = #{proj_code}
	</select>
	
	<!--添加判断编码名称重复 -->
	<select id="existsSysCodeNameByAdd" resultType="java.lang.Integer" parameterType="java.util.Map">

		SELECT count(1) FROM ${field_table} 
		WHERE 1=1
		<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
		</if>
		<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
		</if>
		<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
		</if>
		<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year}
		</if>
		<if test="field_key1 != null and field_key1 != ''">
				AND ${field_key1}=#{field_value1}
		</if>
		<if test="field_key2 != null and field_key2 != ''">
				AND ${field_key2}=#{field_value2}
		</if>
		<if test="field_key3 != null and field_key3 != ''">
				AND ${field_key3}=#{field_value3}
		</if>
		<if test="field_key4 != null and field_key4 != ''">
				AND ${field_key4}=#{field_value4}
		</if>
		
	</select>
	
	<select id="queryAccSubjByCode" resultType="com.chd.hrp.acc.entity.AccSubj"
		parameterType="java.util.Map">
		SELECT
		asubj.subj_id,
		asubj.group_id,
		asubj.hos_id,
		asubj.copy_code,
		asubj.acc_year,
		asubj.subj_code,
		asubj.cur_code,
		ac.cur_name,
		asubj.subj_type_code,
		ast.subj_type_name,
		asubj.subj_nature_code,
		asn.subj_nature_name,
		asubj.vouch_type_code,
		(select vouch_type_name from acc_vouch_type avt where asubj.GROUP_ID = avt.GROUP_ID AND asubj.HOS_ID = avt.HOS_ID AND asubj.COPY_CODE = avt.COPY_CODE AND asubj.vouch_type_code = avt.vouch_type_code) vouch_type_name, 
		asubj.super_code,
		asubj.subj_name,
		asubj.subj_name_all,
		asubj.subj_name_en,
		asubj.is_cash,
		asubj.is_bill,
		<!-- asubj.is_pact, -->
		asubj.subj_dire,
		asubj.subj_level,
		asubj.is_last,
		asubj.is_remit,
		asubj.spell_code,
		asubj.wbx_code,
		asubj.is_stop,
		asubj.is_check,
		asubj.check1,
		act1.check_type_name check1_name,
		act1.column_check column1_check,
		asubj.check2,
		act2.check_type_name check2_name,
		act2.column_check column2_check,
		asubj.check3,
		act3.check_type_name check3_name,
		act3.column_check column3_check,
		asubj.check4,
		act4.check_type_name check4_name,
		act4.column_check column4_check,
		asubj.check_type_code1,asubj.check_type_code2,
		asubj.check_type_code3,asubj.check_type_code4,
		ado.out_code,ado.out_name
		FROM ACC_SUBJ asubj
		left join ACC_SUBJ_NATURE asn on 
				asubj.GROUP_ID = asn.GROUP_ID and
				asubj.HOS_ID = asn.HOS_ID and
				asubj.COPY_CODE = asn.COPY_CODE and
				asubj.SUBJ_NATURE_CODE = asn.SUBJ_NATURE_CODE 
		left join ACC_SUBJ_TYPE ast on 
				asubj.GROUP_ID = ast.GROUP_ID and
				asubj.HOS_ID = ast.HOS_ID and
				asubj.COPY_CODE = ast.COPY_CODE and
				asubj.subj_type_code = ast.subj_type_code
		left join ACC_CUR ac on 
				asubj.GROUP_ID = ac.GROUP_ID and
				asubj.HOS_ID = ac.HOS_ID and
				asubj.COPY_CODE = ac.COPY_CODE and
				asubj.acc_year = ac.acc_year and
				asubj.cur_code = ac.cur_code
		left join ACC_CHECK_TYPE act1 on asubj.GROUP_ID = act1.GROUP_ID AND asubj.HOS_ID = act1.HOS_ID AND asubj.COPY_CODE = act1.COPY_CODE AND asubj.check1 = act1.CHECK_TYPE_ID
		left join ACC_CHECK_TYPE act2 on asubj.GROUP_ID = act2.GROUP_ID AND asubj.HOS_ID = act2.HOS_ID AND asubj.COPY_CODE = act2.COPY_CODE AND asubj.check2 = act2.CHECK_TYPE_ID
		left join ACC_CHECK_TYPE act3 on asubj.GROUP_ID = act3.GROUP_ID AND asubj.HOS_ID = act3.HOS_ID AND asubj.COPY_CODE = act3.COPY_CODE AND asubj.check3 = act3.CHECK_TYPE_ID
		left join ACC_CHECK_TYPE act4 on asubj.GROUP_ID = act4.GROUP_ID AND asubj.HOS_ID = act4.HOS_ID AND asubj.COPY_CODE = act4.COPY_CODE AND asubj.check4 = act4.CHECK_TYPE_ID
		left join acc_dept_out ado on ado.out_code = asubj.out_code
		WHERE
				asubj.group_id = #{group_id} and
				asubj.hos_id = #{hos_id} and
				asubj.copy_code = #{copy_code} and
				asubj.acc_year = #{acc_year} and
				<!-- asubj.subj_id = #{subj_id} -->
				asubj.subj_code=#{subj_code}

	</select>
	
	 <insert id="addAccSubj" useGeneratedKeys="true" >
    
        INSERT INTO ACC_SUBJ (
                    subj_id
			 ,
                    group_id
			 ,
                    hos_id
			 ,
                    copy_code
			 ,
                    acc_year
			 ,
                    subj_code
			 ,
                    cur_code
			 ,
                    subj_type_code
			 ,
                    subj_nature_code
			 ,
                    vouch_type_code
			 ,
                    super_code
			 ,
                    subj_name
			 ,
                    subj_name_all
			 ,
                    subj_name_en
			 ,
                    is_cash
             ,       
             		is_bill
             ,       
                    is_remit
			 ,
                    subj_dire
			 ,
                    subj_level
			 ,
                    is_last
			 ,
                    spell_code
			 ,
                    wbx_code
			 ,
                    is_stop
			 ,
                    is_check
			 ,
                    check1
			 ,
                    check2
			 ,
                    check3
			 ,
                    check4
			 ,
                    check5
			 ,
                    check6
			 ,
                    check7
			 ,
                    check8
			 ,
                    check9
			 ,
                    check10
             ,
             		check_type_code1
             ,		
                    check_type_code2
             ,
                    check_type_code3
             ,
                    check_type_code4
             ,
             		out_code
			 
        ) VALUES (
		ACC_SUBJ_SEQ.nextval			 ,
		#{group_id}			 ,
		#{hos_id}			 ,
		#{copy_code}			 ,
		#{acc_year}			 ,
		#{subj_code}			 ,
		#{cur_code}			 ,
		#{subj_type_code}			 ,
		#{subj_nature_code ,jdbcType=VARCHAR}			 ,
		#{vouch_type_code ,jdbcType=VARCHAR}			 ,
		#{super_code}			 ,
		#{subj_name}			 ,
		#{subj_name_all}			 ,
		#{subj_name_en ,jdbcType=NVARCHAR}			 ,
		#{is_cash}			 ,
		#{is_bill}			 ,
		#{is_remit ,jdbcType=INTEGER}          ,
		#{subj_dire}			 ,
		#{subj_level}			 ,
		#{is_last}			 ,
		#{spell_code}			 ,
		#{wbx_code}			 ,
		#{is_stop}			 ,
		#{is_check}			 ,
		#{check1 ,jdbcType=INTEGER}			 ,
		#{check2 ,jdbcType=INTEGER}			 ,
		#{check3 ,jdbcType=INTEGER}			 ,
		#{check4 ,jdbcType=INTEGER}			 ,
		#{check5 ,jdbcType=INTEGER}			 ,
		#{check6 ,jdbcType=INTEGER}			 ,
		#{check7 ,jdbcType=INTEGER}			 ,
		#{check8 ,jdbcType=INTEGER}			 ,
		#{check9 ,jdbcType=INTEGER}			 ,
		#{check10 ,jdbcType=INTEGER}		 ,
		#{check_type_code1 ,jdbcType=VARCHAR}		 ,
		#{check_type_code2 ,jdbcType=VARCHAR}		 ,
		#{check_type_code3 ,jdbcType=VARCHAR}		 ,
		#{check_type_code4 ,jdbcType=VARCHAR}		 , 
		#{out_code ,jdbcType=VARCHAR}
        )
    
    </insert>
    
    <select id="prcUpdateSubjInfoSigle" statementType="CALLABLE" parameterType="java.util.Map" >
	
	<![CDATA[ {call PKG_COMM.prc_UpdateSubjInfoSigle(
			#{group_id,jdbcType=INTEGER, mode=IN},  
	        #{hos_id,jdbcType=INTEGER, mode=IN},  
	        #{copy_code,jdbcType=VARCHAR, mode=IN},  
	        #{acc_year,jdbcType=VARCHAR, mode=IN},
	        #{subj_code,jdbcType=VARCHAR, mode=IN},
	        #{prm_AppCode,jdbcType=INTEGER,mode=OUT},
	        #{prm_ErrTxt,jdbcType=VARCHAR,mode=OUT}
        )} 
		 ]]>
	
	</select>
	
	<!-- 添加操作，更新父级是否末级
		修改编码操作，新的父科目没有就修改为非末级 -->
	<update id="updateSubjIsLastBySubjCode" parameterType="java.util.Map">
	
		update acc_subj set is_last=#{is_last}
		where group_id = #{group_id} and hos_id = #{hos_id} and copy_code = #{copy_code} 
		and acc_year = #{acc_year} and subj_code =#{super_code}
	</update>
	
	<!--根据父级编码查询科目全称 -->
	<select id="querySubjBySuperCode" resultType="java.lang.String" parameterType="java.util.Map">
		SELECT subj_name_all FROM ACC_SUBJ 
		where group_id = #{group_id} and hos_id = #{hos_id} and copy_code = #{copy_code} 
		and acc_year = #{acc_year} and subj_code=#{super_code}
	</select>
	
	<!-- 检查辅助核算是否使用 -->
	<select id="existsVouchLederBySubjCheck" resultType="java.lang.Integer" parameterType="java.util.Map">
		select sum(cnt) from
		(
			select nvl(count(v.${check_filed}),0) cnt from acc_vouch_check v
			where v.group_id = #{group_id} and v.hos_id=#{hos_id} and v.copy_code=#{copy_code}
			and v.subj_id=#{subj_id} and v.${check_filed} is not null 
			union all
			select nvl(count(l.${check_filed}),0) cnt from acc_leder_check l
			where l.group_id = #{group_id} and l.hos_id=#{hos_id} and l.copy_code=#{copy_code} 
			and l.subj_id=#{subj_id} and l.${check_filed} is not null 
		) 
	</select>
	<select id="queryCheckTypeBySubjId" parameterType="java.util.Map"
		resultMap="accCheckType">
		select check_table||' '||check_type_id as check_table,check_type_name from acc_check_type 
		where check_type_id in (
			select check1 from acc_subj where subj_id = #{subj_id} 
		)
		UNION ALL
		select check_table||' '||check_type_id as  check_table,check_type_name from acc_check_type 
		where check_type_id in (
			select check2 from acc_subj where subj_id = #{subj_id} 
		)
		UNION ALL
		select check_table||' '||check_type_id as  check_table,check_type_name from acc_check_type 
		where check_type_id in ( select check3 from acc_subj where subj_id = #{subj_id} 
		)
		UNION ALL
		select check_table||' '||check_type_id as  check_table,check_type_name from acc_check_type 
		where check_type_id in (
			select check4 from acc_subj where subj_id = #{subj_id} 
		)
	</select>
	
	<select id="queryCheckType" parameterType="java.util.Map"
		resultType="com.chd.hrp.acc.entity.AccCheckType">
		select column_id,column_no,column_code,column_name,check_table
		from acc_check_type
		where  copy_code = #{copy_code}  
			and group_id = #{group_id}  
			and hos_id = #{hos_id}
			and check_type_id = #{check_type_id}
	</select>
	
	<select id="queryCheckColumn" parameterType="java.util.Map"
		resultType="com.chd.hrp.acc.entity.AccCheckType">
		select to_char(wm_concat(${column_name})) as column_name
		from ${check_table}
		where 
			<if test=" check_table != 'ACC_DEPT_TYPE' and check_table != 'HOS_SOURCE_NATURE'">
				group_id = #{group_id}  and 
				hos_id = #{hos_id}  and 
			</if>
			${column_id} in (${check_type_code})
	</select>
	<!--修改判断编码名称重复 -->
	<select id="existsSysCodeNameByUpdate" resultType="java.lang.Integer" parameterType="java.util.Map">
		
		SELECT count(1) FROM ${field_table} 
		WHERE ${field_id}!=#{field_id_value}
		<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
		</if>
		<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
		</if>
		<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
		</if>
		<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year}
		</if>
		<if test="field_key1 != null and field_key1 != ''">
				AND ${field_key1}=#{field_value1}
		</if>
		<if test="field_key2 != null and field_key2 != ''">
				AND ${field_key2}=#{field_value2}
		</if>
		<if test="field_key3 != null and field_key3 != ''">
				AND ${field_key3}=#{field_value3}
		</if>
		
	</select>
	
	<update id="updateAccSubj" parameterType="java.util.Map">
    
        UPDATE acc_subj SET
        	  subj_code=#{subj_code},
			 cur_code = #{cur_code}
			 ,
			 subj_type_code = #{subj_type_code}
			 ,
			 subj_nature_code = #{subj_nature_code}
			 ,
			 vouch_type_code = #{vouch_type_code}
			 ,
			 super_code = #{super_code_new}
			 ,
			 subj_name = #{subj_name}
			 ,
			 subj_name_all = #{subj_name_all}
			 ,
			 subj_name_en = #{subj_name_en}
			 ,
			 is_cash = #{is_cash}
			 ,
			 is_bill = #{is_bill}
			 ,
			<!--  is_pact = #{is_pact}
			 , -->
			 is_remit = #{is_remit}
			 ,
			 subj_dire = #{subj_dire}
			 ,
			 subj_level = #{subj_level}
			 ,
			 spell_code = #{spell_code}
			 ,
			 wbx_code = #{wbx_code}
			 ,
			 is_stop = #{is_stop}
			 ,
			 is_check = #{is_check}
			 ,
			 check1 = #{check1}
			 ,
			 check2 = #{check2}
			 ,
			 check3 = #{check3}
			 ,
			 check4 = #{check4}
			 ,
			 check5 = #{check5}
			 ,
			 check6 = #{check6}
			 ,
			 check7 = #{check7}
			 ,
			 check8 = #{check8}
			 ,
			 check9 = #{check9}
			 ,
			 check10 = #{check10}
			 ,
			 check_type_code1 = #{check_type_code1}
			 ,
			 check_type_code2 = #{check_type_code2}
			 ,
			 check_type_code3 = #{check_type_code3}
			 ,
			 check_type_code4 = #{check_type_code4}
			 ,
			 out_code = #{out_code}
			 
        WHERE 
		 subj_id = #{subj_id}  and  group_id = #{group_id} and 
		 hos_id = #{hos_id} and  copy_code = #{copy_code} and  acc_year = #{acc_year}
			

	</update>
	
	<select id="prcUpdateSubjInfoALL" statementType="CALLABLE" parameterType="java.util.Map" >
	
	<![CDATA[ {call PKG_COMM.prc_UpdateSubjInfoALL(
			#{group_id,jdbcType=INTEGER, mode=IN},  
	        #{hos_id,jdbcType=INTEGER, mode=IN},  
	        #{copy_code,jdbcType=VARCHAR, mode=IN},  
	        #{acc_year,jdbcType=VARCHAR, mode=IN},
	        #{prm_AppCode,jdbcType=INTEGER,mode=OUT},
	        #{prm_ErrTxt,jdbcType=VARCHAR,mode=OUT}
        )} 
		 ]]>
	
	</select>
	
	<select id="prcUpdateSubjInfo" statementType="CALLABLE" parameterType="java.util.Map" >
	
	<![CDATA[ {call PKG_COMM.prc_UpdateSubjInfo(
			#{group_id,jdbcType=INTEGER, mode=IN},  
	        #{hos_id,jdbcType=INTEGER, mode=IN},  
	        #{copy_code,jdbcType=VARCHAR, mode=IN},  
	        #{acc_year,jdbcType=VARCHAR, mode=IN},
	        #{subj_code,jdbcType=VARCHAR, mode=IN},
	        #{prm_AppCode,jdbcType=INTEGER,mode=OUT},
	        #{prm_ErrTxt,jdbcType=VARCHAR,mode=OUT}
        )} 
		 ]]>
	
	</select>
	
	<!--     打印用 -->
<select id="queryAccSubjPrint" parameterType="java.util.Map" resultMap="accSubj1" >
      
        SELECT 
            asubj.subj_id,
            asubj.group_id,
            asubj.hos_id,
            asubj.copy_code,
            asubj.acc_year,
            asubj.subj_code,
            asubj.cur_code,
            asubj.subj_type_code,
            asubj.subj_nature_code,
            asn.subj_nature_name,
            asubj.vouch_type_code,
            asubj.super_code,
            asubj.subj_name,
            asubj.subj_name_all,
            asubj.subj_name_en,
            asubj.is_cash,
            asubj.is_bill,
            <!-- asubj.is_pact, -->
            asubj.is_remit,
            asubj.subj_dire,
            asubj.subj_level,
            asubj.is_last,
            asubj.spell_code,
            asubj.wbx_code,
            asubj.is_stop,
            asubj.is_check,
            act1.check_type_name check1_name,
            act2.check_type_name check2_name,
            act3.check_type_name check3_name,
            act4.check_type_name check4_name        
        FROM ACC_SUBJ asubj 
        left join ACC_SUBJ_NATURE asn  ON
	        		asubj.GROUP_ID = asn.GROUP_ID and
	            	asubj.HOS_ID = asn.HOS_ID and
	            	asubj.COPY_CODE = asn.COPY_CODE and
	            	asubj.SUBJ_NATURE_CODE = asn.SUBJ_NATURE_CODE
	    left join ACC_CHECK_TYPE act1 on asubj.GROUP_ID = act1.GROUP_ID AND asubj.HOS_ID = act1.HOS_ID AND asubj.COPY_CODE = act1.COPY_CODE AND asubj.check1 = act1.CHECK_TYPE_ID
		left join ACC_CHECK_TYPE act2 on asubj.GROUP_ID = act2.GROUP_ID AND asubj.HOS_ID = act2.HOS_ID AND asubj.COPY_CODE = act2.COPY_CODE AND asubj.check2 = act2.CHECK_TYPE_ID
		left join ACC_CHECK_TYPE act3 on asubj.GROUP_ID = act3.GROUP_ID AND asubj.HOS_ID = act3.HOS_ID AND asubj.COPY_CODE = act3.COPY_CODE AND asubj.check3 = act3.CHECK_TYPE_ID
		left join ACC_CHECK_TYPE act4 on asubj.GROUP_ID = act4.GROUP_ID AND asubj.HOS_ID = act4.HOS_ID AND asubj.COPY_CODE = act4.COPY_CODE AND asubj.check4 = act4.CHECK_TYPE_ID        	
            <where>                     
			    <if test="subj_id != null and subj_id != ''">
                    AND asubj.subj_id = #{subj_id}
               </if>
			    <if test="group_id != null and group_id != ''">
                    AND asubj.group_id = #{group_id}
               </if>
			    <if test="hos_id != null and hos_id != ''">
                    AND asubj.hos_id = #{hos_id}
               </if>
			    <if test="copy_code != null and copy_code != ''">
                    AND asubj.copy_code = #{copy_code}
               </if>
			    <if test="acc_year != null and acc_year != ''">
                    AND asubj.acc_year = #{acc_year}
               </if>
			    <if test="subj_code != null and subj_code != ''">
                    AND asubj.subj_code like #{subj_code}||'%'
               </if>
			    <if test="cur_code != null and cur_code != ''">
                    AND asubj.cur_code = #{cur_code}
               </if>
			    <if test="subj_type_code != null and subj_type_code != ''">
                    AND asubj.subj_type_code = #{subj_type_code}
               </if>
			    <if test="subj_nature_code != null and subj_nature_code != ''">
                    AND asubj.subj_nature_code = #{subj_nature_code}
               </if>
			    <!-- <if test="vouch_type_code != null and vouch_type_code != ''">
                    AND asubj.vouch_type_code = #{vouch_type_code}
               </if> -->
			    <if test="super_code != null and super_code != ''">
                    AND asubj.super_code = #{super_code}
               </if>
			    <if test="subj_name != null and subj_name != ''">
                    and ( asubj.subj_name like '%${subj_name}%' or
                    asubj.subj_name_all like '%${subj_name}%' or
                    asubj.spell_code like '%${subj_name}%' or
                    asubj.wbx_code like '%${subj_name}%'
                    ) 
               </if>
			    <if test="subj_name_all != null and subj_name_all != ''">
                    AND asubj.subj_name_all = #{subj_name_all}
               </if>
			    <if test="subj_name_en != null and subj_name_en != ''">
                    AND asubj.subj_name_en = #{subj_name_en}
               </if>
			    <if test="is_cash != null and is_cash != ''">
                    AND asubj.is_cash = #{is_cash}
               </if>
			    <if test="subj_dire != null and subj_dire != ''">
                    AND asubj.subj_dire = #{subj_dire}
               </if>
			    <if test="subj_level != null and subj_level != ''">
                    AND asubj.subj_level = #{subj_level}
               </if>
			    <if test="is_last != null and is_last != ''">
                    AND asubj.is_last = #{is_last}
               </if>
			    <if test="spell_code != null and spell_code != ''">
                    AND asubj.spell_code = #{spell_code}
               </if>
			    <if test="wbx_code != null and wbx_code != ''">
                    AND asubj.wbx_code = #{wbx_code}
               </if>
			    <if test="is_stop != null and is_stop != ''">
                    AND asubj.is_stop = #{is_stop}
               </if>
			    <if test="is_check != null and is_check != ''">
                    AND asubj.is_check = #{is_check}
               </if>
			    <if test="check1 != null and check1 != ''">
                    AND asubj.check1 = #{check1}
               </if>
			    <if test="check2 != null and check2 != ''">
                    AND asubj.check2 = #{check2}
               </if>
			    <if test="check3 != null and check3 != ''">
                    AND asubj.check3 = #{check3}
               </if>
			    <if test="check4 != null and check4 != ''">
                    AND asubj.check4 = #{check4}
               </if>
			    <if test="check5 != null and check5 != ''">
                    AND asubj.check5 = #{check5}
               </if>
			    <if test="check6 != null and check6 != ''">
                    AND asubj.check6 = #{check6}
               </if>
			    <if test="check7 != null and check7 != ''">
                    AND asubj.check7 = #{check7}
               </if>
			    <if test="check8 != null and check8 != ''">
                    AND asubj.check8 = #{check8}
               </if>
			    <if test="check9 != null and check9 != ''">
                    AND asubj.check9 = #{check9}
               </if>
			    <if test="check10 != null and check10 != ''">
                    AND asubj.check10 = #{check10}
               </if>
        </where>   
				order by asubj.subj_code asc
    </select>
    
    <select id="queryAccSubjCode" resultType="com.chd.hrp.acc.entity.AccSubj"
		parameterType="java.util.Map">
		SELECT
		asubj.subj_code,
		asubj.subj_id,asubj.is_last
		FROM ACC_SUBJ asubj
		WHERE
		asubj.group_id = #{group_id} and
		asubj.hos_id = #{hos_id} and
		asubj.copy_code = #{copy_code} and
		asubj.acc_year = #{acc_year} and
		<if test="is_last!= null and is_last !='' ">
		asubj.is_last=#{is_last}  and
		</if>
		asubj.subj_code = #{subj_code}

	</select>
	
	  <select id="queryAccCurByCode" resultType="com.chd.hrp.acc.entity.AccCur" parameterType="String" >
	  
        SELECT 
            cur_code as cur_code,
            group_id,
            hos_id,
            copy_code,
            acc_year,
            cur_name,
            cur_num,
            cur_rate,
            cur_plan,
            is_self,
            spell_code,
            wbx_code,
            is_stop
		FROM acc_cur 
	    <where>
	    	<if test="cur_code != null and cur_code != ''">
		         cur_code = #{cur_code,jdbcType=VARCHAR}
	    	</if>
	    	<if test="cur_name != null and cur_name != ''">
		      and   cur_name = #{cur_name,jdbcType=VARCHAR}  
	    	</if>
	    	<if test="group_id != null and group_id != ''">
	    	 and group_id = #{group_id,jdbcType=INTEGER} 
	    	</if>
	    	<if test="hos_id != null and hos_id != ''">
	    	  and hos_id = #{hos_id,jdbcType=INTEGER} 
	    	</if>
	    	<if test="copy_code != null and copy_code != ''">
	    	  and copy_code = #{copy_code,jdbcType=VARCHAR} 
	    	</if>
	    	<if test="acc_year != null and acc_year != ''">
	    	 and acc_year = #{acc_year,jdbcType=VARCHAR}
	    	</if>
	    </where>
        
	</select>
	<select id="queryAccSubjTypeByCode" resultType="com.chd.hrp.acc.entity.AccSubjType" parameterType="string" >
	  
        SELECT 
            subj_type_code,
            group_id,
            hos_id,
            copy_code,
            subj_type_name
		FROM acc_subj_type 
	       <where>
	    	<if test="group_id != null and group_id != ''">
	    	  and group_id = #{group_id,jdbcType=INTEGER}
	    	</if>
	    	<if test="hos_id != null and hos_id != ''">
	    	   and hos_id = #{hos_id,jdbcType=INTEGER}  
	    	</if>
	    	<if test="copy_code != null and copy_code != ''">
	    	   and  copy_code = #{copy_code,jdbcType=VARCHAR} 
	    	</if>
	    	<if test="subj_type_name != null and subj_type_name != ''">
		         and subj_type_name = #{subj_type_name,jdbcType=VARCHAR}  
	    	</if>
	    	<if test="subj_type_code != null and subj_type_code != ''">
		         and subj_type_code = #{subj_type_code,jdbcType=VARCHAR}  
	    	</if>
	    </where>
	    
	</select>
	
	 <select id="queryAccSubjNatureByCode" resultType="com.chd.hrp.acc.entity.AccSubjNature" parameterType="string" >
	  
        SELECT 
            subj_nature_code,
            group_id,
            hos_id,
            copy_code,
            subj_nature_name
		FROM acc_subj_nature 
	        <where>
	    	<if test="subj_nature_code != null and subj_nature_code != ''">
		       and  subj_nature_code = #{subj_nature_code,jdbcType=VARCHAR} 
	    	</if>
	    	<if test="subj_nature_name != null and subj_nature_name != ''">
		       and  subj_nature_name = #{subj_nature_name,jdbcType=VARCHAR} 
	    	</if>
	    	<if test="group_id != null and group_id != ''">
	    	 and group_id = #{group_id,jdbcType=INTEGER} 
	    	</if>
	    	<if test="hos_id != null and hos_id != ''">
	    	  and hos_id = #{hos_id,jdbcType=INTEGER}  
	    	</if>
	    	<if test="copy_code != null and copy_code != ''">
	    	 and  copy_code = #{copy_code,jdbcType=VARCHAR}  
	    	</if>
	    </where>
	        
	</select>
	
	  <select id="queryAccVouchTypeByCode" resultType="com.chd.hrp.acc.entity.AccVouchType" parameterType="string" >
	  
        SELECT 
            vouch_type_code,
            group_id,
            hos_id,
            copy_code,
            vouch_type_name,
            vouch_type_short,
            spell_code,
            wbx_code,
            is_stop
		FROM acc_vouch_type 
	        <where>
	    	<if test="vouch_type_code != null and vouch_type_code != ''">
		        and vouch_type_code = #{vouch_type_code,jdbcType=VARCHAR}
	    	</if>
	    	<if test="vouch_type_name != null and vouch_type_name != ''">
		       and  vouch_type_name = #{vouch_type_name,jdbcType=VARCHAR} 
	    	</if>
	    	<if test="group_id != null and group_id != ''">
	    	 and   group_id = #{group_id,jdbcType=INTEGER} 
	    	</if>
	    	<if test="hos_id != null and hos_id != ''">
	    	     and hos_id = #{hos_id,jdbcType=INTEGER} 
	    	</if>
	    	<if test="copy_code != null and copy_code != ''">
	    	 and copy_code = #{copy_code,jdbcType=VARCHAR}  
	    	</if>
	    </where>
        
	</select>
	
	<select id="queryAccOutDeptByName" resultType="com.chd.hrp.acc.entity.AccDeptAttr"
		parameterType="java.util.Map">

		SELECT
		out_code,
		out_name
		FROM acc_dept_out
		WHERE
		out_name =
		#{out_name}
	</select>
	
	<!-- 添加、修改验证核算类名称重复 -->
	<select id="queryAccCheckTypeByName" resultType="com.chd.hrp.acc.entity.AccCheckType"
		parameterType="string">

		SELECT
		check_type_id,
		group_id,
		hos_id,
		copy_code,
		check_type_name,
		check_type_code,
		sort_code,
		spell_code,
		wbx_code,
		is_stop,
		is_sys,
		column_id ,
  		column_no,
 		column_code,
 		column_name,
  		is_change  
		FROM acc_check_type
		WHERE
			check_type_name = #{check_type_name}
			and
			group_id = #{group_id}
			and
			hos_id = #{hos_id}
			and
			copy_code = #{copy_code}
			<if test="check_type_id != null and check_type_id != ''">
				AND check_type_id != #{check_type_id}
			</if>
	</select>
	
	 <insert id="addBatchAccSubj" parameterType="java.util.List">
    
        INSERT INTO ACC_SUBJ (
                    
                    subj_id
			 ,
                    group_id
			 ,
                    hos_id
			 ,
                    copy_code
			 ,
                    acc_year
			 ,
                    subj_code
			 ,
                    cur_code
			 ,
                    subj_type_code
			 ,
                    subj_nature_code
			 ,
                    vouch_type_code
			 ,
                    super_code
			 ,
                    subj_name
			 ,
                    subj_name_all
			 ,
                    subj_name_en
			 ,
                    is_cash
             ,       
                    is_bill
             ,
                    is_remit
			 ,
                    subj_dire
			 ,
                    subj_level
			 ,
                    is_last
			 ,
                    spell_code
			 ,
                    wbx_code
			 ,
                    is_stop
             ,		
             		out_code
			 ,
                    is_check
			 ,
                    check1
			 ,
                    check2
			 ,
                    check3
			 ,
                    check4
             <!-- ,
             		check_type_code1
             ,		
                    check_type_code2
             ,
                    check_type_code3
             ,
                    check_type_code4 -->
			 
        )
        select ACC_SUBJ_SEQ.nextval,a.* from (
         <foreach collection="list" item="item" index="index" separator=" union all " >
        select 
			#{item.group_id}			 ,
			#{item.hos_id}			 ,
			#{item.copy_code}			 ,
			#{item.acc_year}			 ,
			#{item.subj_code}			 ,
			#{item.cur_code}			 ,
			#{item.subj_type_code}			 ,
			#{item.subj_nature_code ,jdbcType=VARCHAR}			 ,
			#{item.vouch_type_code ,jdbcType=VARCHAR}			 ,
			#{item.super_code}			 ,
			#{item.subj_name}			 ,
			#{item.subj_name_all}			 ,
			#{item.subj_name_en ,jdbcType=NVARCHAR}			 ,
			#{item.is_cash}			 ,
			#{item.is_bill}			 ,
			#{item.is_remit ,jdbcType=INTEGER}          ,
			#{item.subj_dire}			 ,
			#{item.subj_level}			 ,
			#{item.is_last}			 ,
			#{item.spell_code}			 ,
			#{item.wbx_code}			 ,
			#{item.is_stop}			 ,
			#{item.out_code}			 ,
			#{item.is_check}			 ,
			#{item.check1 ,jdbcType=INTEGER}			 ,
			#{item.check2 ,jdbcType=INTEGER}			 ,
			#{item.check3 ,jdbcType=INTEGER}			 ,
			#{item.check4 ,jdbcType=INTEGER}			 <!-- ,
			#{check_type_code1 ,jdbcType=VARCHAR}		 ,
			#{check_type_code2 ,jdbcType=VARCHAR}		 ,
			#{check_type_code3 ,jdbcType=VARCHAR}		 ,
			#{check_type_code4 ,jdbcType=VARCHAR} -->
			from dual	 
    </foreach>
    ) a
    </insert>
    
    <select id="queryDistinctAccSubjList" parameterType="java.util.Map" resultMap="sysAccSubj">
    	select  asubj.subj_code,asubj.subj_name,asubj.subj_name_en,ac.cur_name,ast.subj_type_name,asn.subj_nature_name,
		avt.vouch_type_name,asubj.subj_dire,asubj.is_remit,asubj.is_cash,act1.check_type_name check1_name,
		act2.check_type_name check2_name,act3.check_type_name check3_name,act4.check_type_name check4_name,
		'导入科目编码重复' error_type from acc_subj asubj
		left join ACC_SUBJ_NATURE asn on asubj.GROUP_ID = asn.GROUP_ID and asubj.HOS_ID = asn.HOS_ID and
		asubj.COPY_CODE = asn.COPY_CODE and asubj.SUBJ_NATURE_CODE = asn.SUBJ_NATURE_CODE 
		left join ACC_SUBJ_TYPE ast on asubj.GROUP_ID = ast.GROUP_ID and asubj.HOS_ID = ast.HOS_ID 
		and asubj.COPY_CODE = ast.COPY_CODE and asubj.subj_type_code = ast.subj_type_code
		left join ACC_CUR ac on asubj.GROUP_ID = ac.GROUP_ID and asubj.HOS_ID = ac.HOS_ID and
		asubj.COPY_CODE = ac.COPY_CODE and asubj.acc_year = ac.acc_year and asubj.cur_code = ac.cur_code
		left join acc_vouch_type avt on asubj.GROUP_ID = avt.GROUP_ID AND asubj.HOS_ID = avt.HOS_ID 
		AND asubj.COPY_CODE = avt.COPY_CODE AND asubj.vouch_type_code = avt.vouch_type_code
		left join ACC_CHECK_TYPE act1 on asubj.GROUP_ID = act1.GROUP_ID AND asubj.HOS_ID = act1.HOS_ID AND asubj.COPY_CODE = act1.COPY_CODE AND asubj.check1 = act1.CHECK_TYPE_ID
		left join ACC_CHECK_TYPE act2 on asubj.GROUP_ID = act2.GROUP_ID AND asubj.HOS_ID = act2.HOS_ID AND asubj.COPY_CODE = act2.COPY_CODE AND asubj.check2 = act2.CHECK_TYPE_ID
		left join ACC_CHECK_TYPE act3 on asubj.GROUP_ID = act3.GROUP_ID AND asubj.HOS_ID = act3.HOS_ID AND asubj.COPY_CODE = act3.COPY_CODE AND asubj.check3 = act3.CHECK_TYPE_ID
		left join ACC_CHECK_TYPE act4 on asubj.GROUP_ID = act4.GROUP_ID AND asubj.HOS_ID = act4.HOS_ID AND asubj.COPY_CODE = act4.COPY_CODE AND asubj.check4 = act4.CHECK_TYPE_ID
		left join acc_dept_out ado on ado.out_code = asubj.out_code    
		where asubj.subj_code in (select subj_code from acc_subj
		where group_id = #{group_id} and hos_id = #{hos_id}
		and copy_code =#{copy_code} and acc_year= #{acc_year}
		group by subj_code having count(1) >= 2)
		group by asubj.subj_code,asubj.subj_name,asubj.subj_name_en,ac.cur_name,ast.subj_type_name,asn.subj_nature_name,
		avt.vouch_type_name,asubj.subj_dire,asubj.is_remit,asubj.is_cash,act1.check_type_name,
		act2.check_type_name,act3.check_type_name,act4.check_type_name	
    	
    </select>
    
    <update id="updateBatchAccSubj" parameterType="java.util.List">
     
	<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
        UPDATE acc_subj SET
			 
			 is_last = 0
			 
        WHERE 
		
		 group_id = #{item.group_id}
			  and 
		 hos_id = #{item.hos_id}
			  and 
		 copy_code = #{item.copy_code}
			  and 
		 acc_year = #{item.acc_year}
			  and 
		 subj_code = #{item.super_code}
			 
    </foreach>
	</update>
	<select id="queryAccSubj_id" parameterType="java.util.Map" resultMap="sysAccSubj">
	
		SELECT * FROM ACC_SUBJ asubj,ACC_SUBJ_NATURE asn 
			<where>
				asubj.GROUP_ID = asn.GROUP_ID and
            	asubj.HOS_ID = asn.HOS_ID and
            	asubj.COPY_CODE = asn.COPY_CODE and
            	asubj.SUBJ_NATURE_CODE = asn.SUBJ_NATURE_CODE
            	<if test="group_id != null and group_id != ''">
                    AND asubj.group_id = #{group_id}
               </if>
			    <if test="hos_id != null and hos_id != ''">
                    AND asubj.hos_id = #{hos_id}
               </if>
			    <if test="copy_code != null and copy_code != ''">
                    AND asubj.copy_code = #{copy_code}
               </if>
			    <if test="acc_year != null and acc_year != ''">
                    AND asubj.acc_year = #{acc_year}
               </if>
			    <if test="subj_code != null and subj_code != ''">
                    AND asubj.subj_code = #{subj_code}
               </if>
			</where>
	</select>
    
    <!-- 按行业性质导会计科目 -->
	<insert id="addBatchAccSubjByNatureCode" parameterType="java.util.Map">
		INSERT INTO acc_subj (subj_id,group_id,hos_id,copy_code,acc_year, SUBJ_CODE, CUR_CODE, SUBJ_TYPE_CODE, SUBJ_NATURE_CODE,
		VOUCH_TYPE_CODE, super_code, SUBJ_NAME, SUBJ_NAME_ALL, SUBJ_NAME_EN, IS_CASH,IS_BILL, SUBJ_DIRE, SUBJ_LEVEL, IS_LAST, SPELL_CODE, 
		WBX_CODE,is_stop,is_check,is_remit)
		select ACC_SUBJ_SEQ.nextval, #{group_id}, #{hos_id}, #{copy_code}, #{acc_year},SUBJ_CODE, CUR_CODE, SUBJ_TYPE_CODE, SUBJ_NATURE_CODE, 
		VOUCH_TYPE_CODE, super_code, SUBJ_NAME, SUBJ_NAME_ALL, SUBJ_NAME_EN, IS_CASH,IS_BILL, SUBJ_DIRE, SUBJ_LEVEL, IS_LAST, SPELL_CODE, 
		WBX_CODE,0,0,0
 		from hos_subj 
 		where nature_code=#{nature_code}
	</insert>
	
	<!-- 按医院历史年度、按集团导会计科目 -->
	<insert id="addBatchAccSubjByAccYear" parameterType="java.util.Map" >
    	INSERT INTO acc_subj (subj_id,group_id,hos_id,copy_code,acc_year, SUBJ_CODE, CUR_CODE, SUBJ_TYPE_CODE, SUBJ_NATURE_CODE, 
    	VOUCH_TYPE_CODE, super_code, SUBJ_NAME, SUBJ_NAME_ALL, SUBJ_NAME_EN, IS_CASH,IS_BILL, SUBJ_DIRE, SUBJ_LEVEL, IS_LAST, SPELL_CODE, 
    	WBX_CODE,is_stop,is_check,is_remit,check1,check2,check3,check4,check5,check6,check7,check8,check9,check10,out_code,check_type_code1,check_type_code2,check_type_code3,check_type_code4)
		select ACC_SUBJ_SEQ.nextval, #{group_id}, #{hos_id}, #{copy_code}, #{acc_year},SUBJ_CODE, CUR_CODE, SUBJ_TYPE_CODE, SUBJ_NATURE_CODE, 
		VOUCH_TYPE_CODE, super_code, SUBJ_NAME, SUBJ_NAME_ALL, SUBJ_NAME_EN, IS_CASH,IS_BILL, SUBJ_DIRE, SUBJ_LEVEL, IS_LAST, SPELL_CODE, 
		WBX_CODE,is_stop,is_check,is_remit,check1,check2,check3,check4,check5,check6,check7,check8,check9,check10,out_code,check_type_code1,check_type_code2,check_type_code3,check_type_code4
 		from acc_subj 
 		where group_id=#{group_id} and hos_id=#{select_hos_id} and copy_code=#{select_copy_code} and acc_year=#{select_acc_year}
       
	</insert> 
	
	<!-- 账簿查询自定义辅助账页面科目选择 -->
	<select id="queryGroupAccSubjByMenu" parameterType="java.util.Map" resultMap="accSubj">
		with subj_tmp as ( select asubj.subj_id, asubj.group_id, asubj.hos_id, asubj.copy_code, asubj.acc_year
	      , asubj.subj_code, asubj.cur_code, asubj.subj_type_code, asubj.subj_nature_code
	      , asubj.vouch_type_code, asubj.super_code, asubj.subj_name, asubj.subj_name_all, asubj.subj_name_en
	      , asubj.is_cash, asubj.is_bill,<!-- asubj.is_pact, --> asubj.is_remit, asubj.subj_dire, asubj.subj_level
	      , asubj.is_last, asubj.spell_code, asubj.wbx_code, asubj.is_stop, asubj.is_check
	      , act1.check_type_name as check1_name
	    from ACC_SUBJ asubj
	    left join ACC_CHECK_TYPE act1 on asubj.GROUP_ID = act1.GROUP_ID
		    and asubj.HOS_ID = act1.HOS_ID
		    and asubj.COPY_CODE = act1.COPY_CODE
		    and (asubj.check1 = act1.CHECK_TYPE_ID or asubj.check2 = act1.CHECK_TYPE_ID or asubj.check3 = act1.CHECK_TYPE_ID or asubj.check4 = act1.CHECK_TYPE_ID  )
	    left join hos_copy_rela hcr on asubj.group_id = hcr.group_id 
   			 and asubj.hos_id = hcr.hos_id and asubj.copy_code = hcr.copy_code    
		<where>
			   asubj.group_id = #{group_id}
			 and hcr.rela_code in (#{rela_code}) 
			<if test="acc_year != null and acc_year != ''">
				and asubj.acc_year = #{acc_year} 
			</if>
			<if test="is_stop != null and is_stop != ''">
				and asubj.is_stop = #{is_stop} 
			</if>
			<if test="is_last != null and is_last != ''">
				and asubj.is_last = #{is_last} 
			</if>
			<if test="subj_type_code != null and subj_type_code != ''">
	            AND asubj.subj_type_code = #{subj_type_code}
	        </if>
	        <if test="subj_code != null and subj_code != ''">
	            AND asubj.subj_code = #{subj_code} 
	        </if>
	        <if test="subj_id != null and subj_id != ''">
	            AND asubj.subj_id = #{subj_id}
	        </if>
	        <if test="queryTree != null and queryTree != ''">
	            and (asubj.${select_code} like '%${queryTree}%'
	             or upper(asubj.spell_code) like '%${queryTree}%'
	             or lower(asubj.spell_code) like '%${queryTree}%'
	            )
	        </if>
	         <if test="subj_level != null and subj_level != ''">
	           <choose>
	           		<when test="subj_level != 99 ">
	           		 	and asubj.subj_level &lt;= #{subj_level}  and asubj.is_last = 1  
	           		</when>
	           		<otherwise>
	           			and asubj.is_last = 1
	           		</otherwise>
	           </choose>
	        </if>
	        <if test="sign ==1">
	        AND act1.check_type_name='部门'
	      	</if>
	      	<if test="sign ==2 ">
	        AND act1.check_type_name='职工'
	      	</if>
	      	 <if test="sign ==3">
	        AND act1.check_type_name='项目'
	      	</if>
	      	     <if test="sign ==4">
	        AND act1.check_type_name='库房' 
	      	</if>
	      	     <if test="sign ==5">
	        AND act1.check_type_name='客户'
	      	</if>
	      	     <if test="sign ==6">
	        AND act1.check_type_name='供应商'
	      	</if>
	      	<if test="sign ==10">
	        AND act1.check_type_name='单位' 
	      	</if>
	      	<if test="sign ==11">
	        AND act1.is_sys=0
	      	</if>
		</where>
		order by subj_code
		)
	select st.*,c.subj_code as judge_subj_code from subj_tmp st
	left join subj_tmp c 
	on st.super_code = c.subj_code
	order by st.subj_code
</select>
    
</mapper>