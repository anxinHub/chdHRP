<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.sup.dao.SupDeliveryDetailMapper">

	<resultMap id="supDeliveryDetail" type="com.chd.hrp.sup.entity.SupDeliveryDetail">
		<result property="detail_id" column="detail_id" />
		<result property="delivery_no" column="delivery_no" /> 
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="acc_year" column="acc_year" />
		<result property="acc_month" column="acc_month" />
		<result property="inv_id" column="inv_id" />
		<result property="inv_no" column="inv_no" />
		<result property="price" column="price" />
		<result property="amount" column="amount" />
		<result property="amount_money" column="amount_money" /> 
		<result property="batch_no" column="batch_no" />
		<result property="fac_date" column="fac_date" />
		<result property="inva_date" column="inva_date" />
		<result property="disinfect_date" column="disinfect_date" />
		<result property="sn" column="sn" />
		<result property="note" column="note" />
		<result property="cert_id" column="cert_id" />
		<result property="cert_code" column="cert_code" />
		<result property="bar_code" column="bar_code" />
		<result property="serial_no" column="serial_no" />
	</resultMap>

	<resultMap id="supDeliveryDetailMap" type="java.util.Map">
		<result property="detail_id" column="detail_id" />
		<result property="delivery_no" column="delivery_no" />
		<result property="delivery_id" column="delivery_id" />
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="acc_year" column="acc_year" />
		<result property="acc_month" column="acc_month" />
		<result property="inv_id" column="inv_id" />
		<result property="inv_no" column="inv_no" />
		<result property="inv_code" column="inv_code" />
		<result property="inv_name" column="inv_name" />
		<result property="inv_model" column="inv_model" />
		<result property="unit_code" column="unit_code" />
		<result property="unit_name" column="unit_name" />
		<result property="batch_no" column="batch_no" />
		<result property="price" column="price" />
		<result property="amount" column="amount" />
		<result property="amount_money" column="amount_money" />
		<result property="fac_date" column="fac_date" />
		<result property="inva_date" column="inva_date" />
		<result property="disinfect_date" column="disinfect_date" />
		<result property="sn" column="sn" />
		<result property="note" column="note" />
		<result property="fac_name" column="fac_name" />
		<result property="create_date" column="create_date" />
		<result property="sup_id" column="sup_id" />
		<result property="sup_no" column="sup_no" />
		<result property="sup_code" column="sup_code" />
		<result property="sup_name" column="sup_name" />
		<result property="already_amount" column="already_amount" />
		<result property="delivery_amount" column="delivery_amount" />
		<result property="bill_type" column="bill_type" />
		<result property="cert_id" column="cert_id" />
		<result property="cert_code" column="cert_code" />
		<result property="bar_code" column="bar_code" />
		<result property="serial_no" column="serial_no" />
		<result property="is_bar" column="is_bar" />
		<result property="is_per_bar" column="is_per_bar" />
		<result property="bid_code" column="bid_code" />
		<result property="disinfect_no" column="disinfect_no" />
		<result property="store_id" column="store_id" />
		<result property="store_no" column="store_no" />
		<result property="store_code" column="store_code" />
		<result property="store_name" column="store_name" />
		<result property="stock_emp" column="stock_emp" />
		<result property="stock_code" column="stock_code" />
		<result property="stock_name" column="stock_name" />
		
		<result property="examiner" column="examiner" />
		<result property="examiner_code" column="examiner_code" />
		<result property="examiner_name" column="examiner_name" />
	</resultMap>

	<resultMap id="matInDetail" type="java.util.Map">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="in_id" column="in_id" />
		<result property="in_no" column="in_no" />
		<result property="in_detail_id" column="in_detail_id" />
		<result property="inv_id" column="inv_id" />
		<result property="inv_no" column="inv_no" />
		<result property="inv_code" column="inv_code" />
		<result property="inv_name" column="inv_name" />
		<result property="inv_model" column="inv_model" />
		<result property="unit_code" column="unit_code" />
		<result property="unit_name" column="unit_name" />
		<result property="pack_code" column="pack_code" />
		<result property="pack_name" column="pack_name" />
		<result property="fac_name" column="fac_name" />
		<result property="amount" column="amount" />
		<result property="price" column="price" />
		<result property="amount_money" column="amount_money" />
		<result property="in_amount" column="in_amount" />
		<result property="num" column="num" />
		<result property="fac_date" column="fac_date" />
		<result property="num_exchange" column="num_exchange" />
		<result property="arrive_date" column="arrive_date" />
		<result property="order_id_new" column="order_id_new" />
		<result property="not_ship_amount" column="not_ship_amount" />
	</resultMap>

	<insert id="add" useGeneratedKeys="true">

		INSERT INTO SUP_DELIVERY_DETAIL (
		<trim suffix="" suffixOverrides=",">
			<if test="detail_id != null and detail_id != ''">
				detail_id
				,
			</if>
			<if test="delivery_no != null and delivery_no != ''">
				delivery_no
				,
			</if>
			<if test="group_id != null and group_id != ''">
				group_id
				,
			</if>
			<if test="hos_id != null and hos_id != ''">
				hos_id
				,
			</if>
			<if test="copy_code != null and copy_code != ''">
				copy_code
				,
			</if>
			<if test="acc_year != null and acc_year != ''">
				acc_year
				,
			</if>
			<if test="acc_month != null and acc_month != ''">
				acc_month
				,
			</if>
			<if test="inv_id != null and inv_id != ''">
				inv_id
				,
			</if>
			<if test="inv_no != null and inv_no != ''">
				inv_no
				,
			</if>
			<if test="price != null and price != ''">
				price
				,
			</if>
			<if test="amount != null and amount != ''">
				amount
				,
			</if>
			<if test="amount_money != null and amount_money != ''">
				amount_money
				,
			</if>
			<if test="batch_no != null and batch_no != ''">
				batch_no
				,
			</if>
			<if test="inva_date != null and inva_date != ''">
				inva_date
				,
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				disinfect_date
				,
			</if>
			<if test="sn != null and sn != ''">
				sn
				,
			</if>
			<if test="note != null and note != ''">
				note
				,
			</if>
		</trim>
		) VALUES (
		<trim suffix="" suffixOverrides=",">
			<if test="detail_id != null and detail_id != ''">
				#{detail_id,jdbcType=INTEGER}
				,
			</if>
			<if test="delivery_no != null and delivery_no != ''">
				#{delivery_no,jdbcType=VARCHAR}
				,
			</if>
			<if test="group_id != null and group_id != ''">
				#{group_id,jdbcType=INTEGER}
				,
			</if>
			<if test="hos_id != null and hos_id != ''">
				#{hos_id,jdbcType=VARCHAR}
				,
			</if>
			<if test="copy_code != null and copy_code != ''">
				#{copy_code,jdbcType=VARCHAR}
				,
			</if>
			<if test="acc_year != null and acc_year != ''">
				#{acc_year,jdbcType=VARCHAR}
				,
			</if>
			<if test="acc_month != null and acc_month != ''">
				#{acc_month,jdbcType=VARCHAR}
				,
			</if>
			<if test="inv_id != null and inv_id != ''">
				#{inv_id,jdbcType=INTEGER}
				,
			</if>
			<if test="inv_no != null and inv_no != ''">
				#{inv_no,jdbcType=INTEGER}
				,
			</if>
			<if test="price != null and price != ''">
				#{price,jdbcType=INTEGER}
				,
			</if>
			<if test="amount != null and amount != ''">
				#{amount,jdbcType=INTEGER}
				,
			</if>
			<if test="amount_money != null and amount_money != ''">
				#{amount_money,jdbcType=INTEGER}
				,
			</if>
			<if test="batch_no != null and batch_no != ''">
				#{batch_no,jdbcType=NVARCHAR}
				,
			</if>
			<if test="inva_date != null and inva_date != ''">
				#{inva_date,jdbcType=DATE}
				,
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				#{disinfect_date,jdbcType=DATE}
				,
			</if>
			<if test="sn != null and sn != ''">
				#{sn,jdbcType=NVARCHAR}
				,
			</if>
			<if test="note != null and note != ''">
				#{note,jdbcType=NVARCHAR}
				,
			</if>
		</trim>
		)

	</insert>
	<insert id="addBatch" parameterType="java.util.List">

		INSERT INTO SUP_DELIVERY_DETAIL (
		detail_id
		,
		delivery_no
		,
		group_id
		,
		hos_id
		,
		copy_code
		,
		acc_year
		,
		acc_month
		,
		inv_id
		,
		inv_no
		,
		price
		,
		amount
		,
		amount_money
		,
		batch_no
		,
		inva_date
		,
		disinfect_date,
		disinfect_no
		,
		sn
		,

		note

		) select
		SUP_DELIVERY_DETAIL_SEQ.nextval , t.* from(
		<foreach collection="list" item="item" index="index"
			separator=" union all ">
			select
			#{item.delivery_no,jdbcType=VARCHAR}
			,
			#{item.group_id,jdbcType=INTEGER}
			,
			#{item.hos_id,jdbcType=VARCHAR}
			,
			#{item.copy_code,jdbcType=VARCHAR}
			,
			#{item.acc_year,jdbcType=VARCHAR}
			,
			#{item.acc_month,jdbcType=VARCHAR}
			,
			#{item.inv_id,jdbcType=INTEGER}
			,
			#{item.inv_no,jdbcType=INTEGER}
			,

			#{item.price,jdbcType=INTEGER}
			,
			#{item.amount,jdbcType=INTEGER}
			,
			#{item.amount_money,jdbcType=INTEGER}
			,
			#{item.batch_no,jdbcType=NVARCHAR}
			,
			#{item.inva_date,jdbcType=DATE}
			,
			#{item.disinfect_date,jdbcType=DATE}
			,
			#{item.disinfect_no,jdbcType=NVARCHAR}
			,
			#{item.sn,jdbcType=NVARCHAR}
			,

			#{item.note,jdbcType=NVARCHAR}

			from dual
		</foreach>
		)t
	</insert>
	<insert id="addRelaBatch" parameterType="java.util.List">

		INSERT INTO Sup_Delivery_In_Rela (

		group_id
		,
		hos_id
		,
		copy_code
		,
		in_id
		,
		delivery_id
		,
		delivery_no
		,
		inv_id
		,

		price
		,
		in_amount
		,
		delivery_amount

		) select
		t.* from(
		<foreach collection="list" item="item" index="index"
			separator=" union all ">
			select
			#{item.group_id,jdbcType=INTEGER}
			,
			#{item.hos_id,jdbcType=VARCHAR}
			,
			#{item.copy_code,jdbcType=VARCHAR}
			,
			#{item.in_id,jdbcType=VARCHAR}
			,
			#{item.delivery_id,jdbcType=VARCHAR}
			,
			#{item.delivery_no,jdbcType=VARCHAR}
			,
			#{item.inv_id,jdbcType=INTEGER}
			,
			#{item.price,jdbcType=INTEGER}
			,
			#{item.in_amount,jdbcType=INTEGER}
			,
			#{item.delivery_amount,jdbcType=INTEGER}

			from dual
		</foreach>
		)t
	</insert>

	<update id="update" parameterType="java.util.Map">

		UPDATE sup_delivery_detail
		<trim prefix="SET" suffixOverrides=",">

			<if test="price != null and price != ''">
				price = #{price,jdbcType=INTEGER}
				,
			</if>
			<if test="amount != null and amount != ''">
				amount = #{amount,jdbcType=INTEGER}
				,
			</if>
			<if test="amount_money != null and amount_money != ''">
				amount_money = #{amount_money,jdbcType=INTEGER}
				,
			</if>
			<if test="batch_no != null and batch_no != ''">
				batch_no = #{batch_no,jdbcType=NVARCHAR}
				,
			</if>
			<if test="inva_date != null and inva_date != ''">
				inva_date = #{inva_date,jdbcType=DATE}
				,
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				disinfect_date = #{disinfect_date,jdbcType=DATE}
				,
			</if>
			<if test="sn != null and sn != ''">
				sn = #{sn,jdbcType=NVARCHAR}
				,
			</if>
			<if test="note != null and note != ''">
				note = #{note,jdbcType=NVARCHAR}
				,
			</if>
		</trim>
		<where>
			<if test="detail_id != null and detail_id != ''">
				detail_id = #{detail_id,jdbcType=INTEGER}
			</if>
			<if test="delivery_no != null and delivery_no != ''">
				AND delivery_no = #{delivery_no,jdbcType=VARCHAR}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=VARCHAR}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year,jdbcType=VARCHAR}
			</if>
			<if test="acc_month != null and acc_month != ''">
				AND acc_month = #{acc_month,jdbcType=VARCHAR}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_no != null and inv_no != ''">
				AND inv_no = #{inv_no,jdbcType=INTEGER}
			</if>

		</where>
	</update>
	<update id="updateBatch" parameterType="java.util.List">

		<foreach collection="list" item="item" index="index" open="begin"
			close=";end;" separator=";">
			UPDATE sup_delivery_detail
			<trim prefix="SET" suffixOverrides=",">

				<if test="item.price != null and item.price != ''">
					price = #{item.price,jdbcType=INTEGER}
					,
				</if>
				<if test="item.amount != null and item.amount != ''">
					amount = #{item.amount,jdbcType=INTEGER}
					,
				</if>
				<if test="item.amount_money != null and item.amount_money != ''">
					amount_money = #{item.amount_money,jdbcType=INTEGER}
					,
				</if>
				<if test="item.batch_no != null and item.batch_no != ''">
					batch_no = #{item.batch_no,jdbcType=NVARCHAR}
					,
				</if>
				<if test="item.inva_date != null and item.inva_date != ''">
					inva_date = #{item.inva_date,jdbcType=DATE}
					,
				</if>
				<if test="item.disinfect_date != null and item.disinfect_date != ''">
					disinfect_date = #{item.disinfect_date,jdbcType=DATE}
					,
				</if>
				<if test="item.sn != null and item.sn != ''">
					sn = #{item.sn,jdbcType=NVARCHAR}
					,
				</if>
				<if test="item.note != null and item.note != ''">
					note = #{item.note,jdbcType=NVARCHAR}
					,
				</if>
			</trim>
			<where>
				<if test="item.detail_id != null and item.detail_id != ''">
					detail_id = #{item.detail_id,jdbcType=INTEGER}
				</if>
				<if test="item.delivery_no != null and item.delivery_no != ''">
					AND delivery_no = #{item.delivery_no,jdbcType=VARCHAR}
				</if>
				<if test="item.group_id != null and item.group_id != ''">
					AND group_id = #{item.group_id,jdbcType=INTEGER}
				</if>
				<if test="item.hos_id != null and item.hos_id != ''">
					AND hos_id = #{item.hos_id,jdbcType=VARCHAR}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
				</if>
				<if test="item.acc_year != null and item.acc_year != ''">
					AND acc_year = #{item.acc_year,jdbcType=VARCHAR}
				</if>
				<if test="item.acc_month != null and item.acc_month != ''">
					AND acc_month = #{item.acc_month,jdbcType=VARCHAR}
				</if>
				<if test="item.inv_id != null and item.inv_id != ''">
					AND inv_id = #{item.inv_id,jdbcType=INTEGER}
				</if>
				<if test="item.inv_no != null and item.inv_no != ''">
					AND inv_no = #{item.inv_no,jdbcType=INTEGER}
				</if>

			</where>
		</foreach>
	</update>
	<update id="updateRelaBatch" parameterType="java.util.List">

		<foreach collection="list" item="item" index="index" open="begin"
			close=";end;" separator=";">
			UPDATE sup_delivery_order_rela set
			delivery_amount = #{item.delivery_amount,jdbcType=INTEGER}
			where
			delivery_no = #{item.delivery_no,jdbcType=VARCHAR}
			AND group_id = #{item.group_id,jdbcType=INTEGER}
			AND hos_id = #{item.hos_id,jdbcType=VARCHAR}
			AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
			AND inv_id = #{item.inv_id,jdbcType=INTEGER}

		</foreach>
	</update>

	<delete id="delete" parameterType="java.util.Map">

		DELETE FROM sup_delivery_detail
		<where>
			<if test="detail_id != null and detail_id != ''">
				detail_id = #{detail_id,jdbcType=INTEGER}
			</if>
			<if test="delivery_no != null and delivery_no != ''">
				AND delivery_no = #{delivery_no,jdbcType=VARCHAR}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=VARCHAR}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year,jdbcType=VARCHAR}
			</if>
			<if test="acc_month != null and acc_month != ''">
				AND acc_month = #{acc_month,jdbcType=VARCHAR}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_no != null and inv_no != ''">
				AND inv_no = #{inv_no,jdbcType=INTEGER}
			</if>

			<if test="price != null and price != ''">
				AND price = #{price,jdbcType=INTEGER}
			</if>
			<if test="amount != null and amount != ''">
				AND amount = #{amount,jdbcType=INTEGER}
			</if>
			<if test="amount_money != null and amount_money != ''">
				AND amount_money = #{amount_money,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null and batch_no != ''">
				AND batch_no = #{batch_no,jdbcType=NVARCHAR}
			</if>
			<if test="inva_date != null and inva_date != ''">
				AND inva_date = #{inva_date,jdbcType=DATE}
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				AND disinfect_date = #{disinfect_date,jdbcType=DATE}
			</if>
			<if test="sn != null and sn != ''">
				AND sn = #{sn,jdbcType=NVARCHAR}
			</if>

			<if test="note != null and note != ''">
				AND note = #{note,jdbcType=NVARCHAR}
			</if>
		</where>
	</delete>
	<delete id="deleteBatch" parameterType="java.util.List">

		<foreach collection="list" item="item" index="index" open="begin"
			close=";end;" separator=";">
			DELETE FROM sup_delivery_detail
			<where>
				group_id = #{item.group_id,jdbcType=INTEGER}
				AND hos_id = #{item.hos_id,jdbcType=VARCHAR}
				AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
				AND delivery_no = #{item.delivery_no,jdbcType=VARCHAR}
				<if test="item.detail_id != null and item.detail_id != ''">
					and detail_id = #{item.detail_id,jdbcType=INTEGER}
				</if>
				<if test="item.acc_year != null and item.acc_year != ''">
					AND acc_year = #{item.acc_year,jdbcType=VARCHAR}
				</if>
				<if test="item.acc_month != null and item.acc_month != ''">
					AND acc_month = #{item.acc_month,jdbcType=VARCHAR}
				</if>
				<if test="item.inv_id != null and item.inv_id != ''">
					AND inv_id = #{item.inv_id,jdbcType=INTEGER}
				</if>
				<if test="item.inv_no != null and item.inv_no != ''">
					AND inv_no = #{item.inv_no,jdbcType=INTEGER}
				</if>

				<if test="item.price != null and item.price != ''">
					AND price = #{item.price,jdbcType=INTEGER}
				</if>
				<if test="item.amount != null and item.amount != ''">
					AND amount = #{item.amount,jdbcType=INTEGER}
				</if>
				<if test="item.amount_money != null and item.amount_money != ''">
					AND amount_money = #{item.amount_money,jdbcType=INTEGER}
				</if>
				<if test="item.batch_no != null and item.batch_no != ''">
					AND batch_no = #{item.batch_no,jdbcType=NVARCHAR}
				</if>
				<if test="item.inva_date != null and item.inva_date != ''">
					AND inva_date = #{item.inva_date,jdbcType=DATE}
				</if>
				<if test="item.disinfect_date != null and item.disinfect_date != ''">
					AND disinfect_date =
					#{item.disinfect_date,jdbcType=DATE}
				</if>
				<if test="item.sn != null and item.sn != ''">
					AND sn = #{item.sn,jdbcType=NVARCHAR}
				</if>

				<if test="item.note != null and item.note != ''">
					AND note = #{item.note,jdbcType=NVARCHAR}
				</if>
			</where>
		</foreach>
	</delete>
	<delete id="deleteRelaBatch" parameterType="java.util.List">

		<foreach collection="list" item="item" index="index" open="begin"
			close=";end;" separator=";">
			DELETE FROM sup_delivery_in_rela
			where
			group_id = #{item.group_id,jdbcType=INTEGER}
			AND hos_id = #{item.hos_id,jdbcType=VARCHAR}
			AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
			AND in_id = #{item.in_id,jdbcType=VARCHAR}
			AND inv_id = #{item.inv_id,jdbcType=INTEGER}
		</foreach>
	</delete>
	<select id="query" parameterType="java.util.Map" resultMap="supDeliveryDetail">

		SELECT
		detail_id,
		delivery_no,
		group_id,
		hos_id,
		copy_code,
		acc_year,
		acc_month,
		inv_id,
		inv_no,
		price,
		amount,
		amount_money,
		batch_no,
		inva_date,
		disinfect_date,
		sn,
		note
		FROM SUP_DELIVERY_DETAIL
		<where>
			<if test="detail_id != null and detail_id != ''">
				detail_id = #{detail_id,jdbcType=INTEGER}
			</if>
			<if test="delivery_no != null and delivery_no != ''">
				AND delivery_no = #{delivery_no,jdbcType=VARCHAR}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=VARCHAR}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year,jdbcType=VARCHAR}
			</if>
			<if test="acc_month != null and acc_month != ''">
				AND acc_month = #{acc_month,jdbcType=VARCHAR}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_no != null and inv_no != ''">
				AND inv_no = #{inv_no,jdbcType=INTEGER}
			</if>
			<if test="price != null and price != ''">
				AND price = #{price,jdbcType=INTEGER}
			</if>
			<if test="amount != null and amount != ''">
				AND amount = #{amount,jdbcType=INTEGER}
			</if>
			<if test="amount_money != null and amount_money != ''">
				AND amount_money = #{amount_money,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null and batch_no != ''">
				AND batch_no = #{batch_no,jdbcType=NVARCHAR}
			</if>
			<if test="inva_date != null and inva_date != ''">
				AND inva_date = #{inva_date,jdbcType=DATE}
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				AND disinfect_date = #{disinfect_date,jdbcType=DATE}
			</if>
			<if test="sn != null and sn != ''">
				AND sn = #{sn,jdbcType=NVARCHAR}
			</if>
			<if test="note != null and note != ''">
				AND note = #{note,jdbcType=NVARCHAR}
			</if>
		</where>
		order by detail_id asc
	</select>
	<select id="queryByCode" resultMap="supDeliveryDetail"
		parameterType="java.util.Map">

		SELECT
		detail_id,
		delivery_no,
		group_id,
		hos_id,
		copy_code,
		acc_year,
		acc_month,
		inv_id,
		inv_no,
		price,
		amount,
		amount_money,
		batch_no,
		inva_date,
		disinfect_date,
		sn,
		note
		FROM sup_delivery_detail
		WHERE
		delivery_no = #{delivery_no,jdbcType=VARCHAR} and
		group_id =
		#{group_id,jdbcType=INTEGER} and
		hos_id = #{hos_id,jdbcType=VARCHAR}
		and
		copy_code = #{copy_code,jdbcType=VARCHAR} and
		acc_year =
		#{acc_year,jdbcType=VARCHAR} and
		acc_month =
		#{acc_month,jdbcType=VARCHAR} and
		inv_id = #{inv_id,jdbcType=INTEGER}
		and
		inv_no = #{inv_no,jdbcType=INTEGER}

	</select>
	<select id="queryByUniqueness" resultMap="supDeliveryDetail"
		parameterType="java.util.Map">

		SELECT
		detail_id,
		delivery_no,
		group_id,
		hos_id,
		copy_code,
		acc_year,
		acc_month,
		inv_id,
		inv_no,
		price,
		amount,
		amount_money,
		batch_no,
		inva_date,
		disinfect_date,
		sn,
		note
		FROM SUP_DELIVERY_DETAIL
		<where>
			<if test="detail_id != null and detail_id != ''">
				detail_id = #{detail_id,jdbcType=INTEGER}
			</if>
			<if test="delivery_no != null and delivery_no != ''">
				AND delivery_no = #{delivery_no,jdbcType=VARCHAR}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=VARCHAR}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year,jdbcType=VARCHAR}
			</if>
			<if test="acc_month != null and acc_month != ''">
				AND acc_month = #{acc_month,jdbcType=VARCHAR}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_no != null and inv_no != ''">
				AND inv_no = #{inv_no,jdbcType=INTEGER}
			</if>
			<if test="price != null and price != ''">
				AND price = #{price,jdbcType=INTEGER}
			</if>
			<if test="amount != null and amount != ''">
				AND amount = #{amount,jdbcType=INTEGER}
			</if>
			<if test="amount_money != null and amount_money != ''">
				AND amount_money = #{amount_money,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null and batch_no != ''">
				AND batch_no = #{batch_no,jdbcType=NVARCHAR}
			</if>
			<if test="inva_date != null and inva_date != ''">
				AND inva_date = #{inva_date,jdbcType=DATE}
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				AND disinfect_date = #{disinfect_date,jdbcType=DATE}
			</if>
			<if test="sn != null and sn != ''">
				AND sn = #{sn,jdbcType=NVARCHAR}
			</if>
			<if test="note != null and note != ''">
				AND note = #{note,jdbcType=NVARCHAR}
			</if>
		</where>
		order by detail_id asc
	</select>
	<select id="queryExists" resultMap="supDeliveryDetail"
		parameterType="java.util.Map">

		SELECT
		detail_id,
		delivery_no,
		group_id,
		hos_id,
		copy_code,
		acc_year,
		acc_month,
		inv_id,
		inv_no,
		price,
		amount,
		amount_money,
		batch_no,
		inva_date,
		disinfect_date,
		sn,
		note
		FROM SUP_DELIVERY_DETAIL
		<where>
			<if test="detail_id != null and detail_id != ''">
				detail_id = #{detail_id,jdbcType=INTEGER}
			</if>
			<if test="delivery_no != null and delivery_no != ''">
				AND delivery_no = #{delivery_no,jdbcType=VARCHAR}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=VARCHAR}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year,jdbcType=VARCHAR}
			</if>
			<if test="acc_month != null and acc_month != ''">
				AND acc_month = #{acc_month,jdbcType=VARCHAR}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_no != null and inv_no != ''">
				AND inv_no = #{inv_no,jdbcType=INTEGER}
			</if>
			<if test="price != null and price != ''">
				AND price = #{price,jdbcType=INTEGER}
			</if>
			<if test="amount != null and amount != ''">
				AND amount = #{amount,jdbcType=INTEGER}
			</if>
			<if test="amount_money != null and amount_money != ''">
				AND amount_money = #{amount_money,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null and batch_no != ''">
				AND batch_no = #{batch_no,jdbcType=NVARCHAR}
			</if>
			<if test="inva_date != null and inva_date != ''">
				AND inva_date = #{inva_date,jdbcType=DATE}
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				AND disinfect_date = #{disinfect_date,jdbcType=DATE}
			</if>
			<if test="sn != null and sn != ''">
				AND sn = #{sn,jdbcType=NVARCHAR}
			</if>
			<if test="note != null and note != ''">
				AND note = #{note,jdbcType=NVARCHAR}
			</if>
		</where>
		order by detail_id asc
	</select>
	<select id="queryDetailIn" resultMap="matInDetail"
		parameterType="java.util.Map">

		SELECT mdd.group_id, mdd.hos_id, mdd.copy_code, mdd.in_id,
		mdd.in_detail_id
		, mdd.in_no, mdd.inv_no, mdd.inv_id, mid.inv_code, mid.inv_name
		, mid.inv_model, mid.unit_code, hu.unit_name, mdd.amount AS in_amount,
		mdd.amount - nvl(t1.IN_AMOUNT, 0) AS not_ship_amount
		, nvl(t5.IN_AMOUNT, 0) AS amount, mdd.price, nvl(mdd.amount, 0) *
		nvl(mdd.price, 0) AS amount_money, mdd.num_exchange, hfd.fac_name

		FROM mat_in_detail mdd
		LEFT JOIN mat_inv_dict mid ON mdd.inv_no = mid.inv_no
		AND mid.inv_id = mdd.inv_id
		AND mdd.group_id = mid.group_id
		AND mdd.hos_id = mid.hos_id
		AND mdd.copy_code = mid.copy_code
		AND mid.is_stop = 0
		LEFT JOIN hos_unit hu ON hu.unit_code = mid.unit_code
		AND hu.group_id = mid.group_id
		AND hu.hos_id = mid.hos_id
		AND hu.is_stop = 0
		LEFT JOIN hos_fac_dict hfd ON mdd.group_id = hfd.group_id
		AND mdd.hos_id = hfd.hos_id
		AND mid.fac_id = hfd.fac_id
		LEFT JOIN (
		SELECT group_id, hos_id, copy_code, in_id, inv_id
		, SUM(in_amount) AS in_amount
		FROM sup_delivery_in_rela
		WHERE group_id = #{group_id,jdbcType=INTEGER}
		AND hos_id = #{hos_id,jdbcType=INTEGER}
		AND copy_code = #{copy_code,jdbcType=VARCHAR}
		GROUP BY group_id, hos_id, copy_code, in_id, inv_id
		) t1 ON t1.inv_id = mdd.inv_id
		AND mdd.group_id = t1.group_id
		AND mdd.hos_id = t1.hos_id
		AND mdd.copy_code = t1.copy_code
		AND t1.in_id = mdd.in_id
		LEFT JOIN sup_delivery_in_rela t5 ON t5.group_id = mdd.group_id
		AND t5.hos_id = mdd.hos_id
		AND t5.copy_code = mdd.copy_code
		AND t5.inv_id = mdd.inv_id
		AND t5.in_id = mdd.in_id
		AND t5.delivery_no = #{delivery_no,jdbcType=INTEGER}
		<where>
			exists(select 1 from mat_in_main a where a.group_id=mdd.group_id
			and
			a.hos_id=mdd.hos_id
			and a.copy_code=mdd.copy_code and
			a.in_id=mdd.in_id and a.sup_id=#{sup_id,jdbcType=INTEGER}
			and
			a.sup_no=#{sup_no,jdbcType=INTEGER}
			<if test="is_dir != null and is_dir != ''">
				and a.is_dir = #{is_dir,jdbcType=INTEGER}
			</if>
			<if test="store_id != null and store_id != ''">
				and a.store_id = #{store_id,jdbcType=INTEGER}
			</if>
			<if test="store_no != null and store_no != ''">
				and a.store_no = #{store_no,jdbcType=INTEGER}
			</if>
			)

			<if test="group_id != null and group_id != ''">
				and mdd.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and mdd.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and mdd.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="in_id != null and in_id != ''">
				and mdd.in_id in ${in_id}
			</if>
			<if test="in_no != null and in_no != ''">
				and mdd.in_no = #{in_no,jdbcType=VARCHAR}
			</if>
			<if test="in_detail_id != null and in_detail_id != ''">
				and mdd.in_detail_id =
				#{in_detail_id,jdbcType=INTEGER}
			</if>
			and mdd.amount-nvl(t1.IN_AMOUNT,0)>0
			and mdd.inv_id =
			#{inv_id,jdbcType=VARCHAR}
		</where>
		ORDER BY mdd.inv_no, mdd.in_id ASC

	</select>

	<select id="queryDetailWithDeliveryView" resultMap="supDeliveryDetailMap"
		parameterType="java.util.Map">
		SELECT
		a.group_id, a.hos_id, a.copy_code, a.delivery_no,
		a.detail_id,
		a.inv_id,a.inv_no,b.inv_code, b.inv_name,
		b.inv_model,
		b.unit_code,
		c.unit_name, a.amount, a.price, a.amount_money,
		a.batch_no,
		a.sn,a.inva_date,a.disinfect_date,a.note,
		b.is_highvalue,
		b.is_batch,
		b.is_bar, b.is_per_bar, b.is_quality, b.is_single_ven,
		b.is_disinfect,hf.fac_name,a.disinfect_date,
		sdm.sup_id,sdm.sup_no,sdm.create_date,sdm.delivery_id,a.fac_date
		FROM
		sup_delivery_detail a
		left join mat_inv_dict b
		on a.group_id =
		b.group_id
		and a.hos_id =
		b.hos_id
		and a.copy_code = b.copy_code
		and
		a.inv_id = b.inv_id
		and
		a.inv_no = b.inv_no
		left join hos_unit c
		on
		b.group_id = c.group_id
		and
		b.hos_id = c.hos_id
		and b.unit_code =
		c.unit_code
		left join hos_fac_dict
		hf
		on hf.group_id = b.group_id
		and
		hf.hos_id = b.hos_id
		and hf.fac_id =
		b.fac_id
		and hf.is_stop = 0
		left join sup_delivery_main sdm on
		a.group_id=sdm.group_id and a.hos_id=sdm.hos_id and a.copy_code=sdm.copy_code
		and a.delivery_no=sdm.delivery_no
		WHERE
		a.group_id = #{group_id,jdbcType=INTEGER}
		AND a.hos_id =
		#{hos_id,jdbcType=INTEGER}
		AND a.copy_code =
		#{copy_code,jdbcType=VARCHAR}
		<if test="begin_order_date != null and begin_order_date != ''">
			AND sdm.create_date
			&gt;=to_date(#{begin_order_date},'yyyy/MM/dd')
		</if>
		<if test="end_order_date != null and end_order_date != ''">
			AND sdm.create_date
			&lt;=to_date(#{end_order_date},'yyyy/MM/dd')
		</if>
		<if test="sup_id != null and sup_id != ''">
			AND sdm.sup_id = #{sup_id,jdbcType=INTEGER}
		</if>
		<if test="sup_no != null and sup_no != ''">
			AND sdm.sup_no = #{sup_no,jdbcType=INTEGER}
		</if>
		<if test="delivery_no != null and delivery_no != ''">
			AND a.delivery_no in (${delivery_no})
		</if>
		<if test="inv_code != null and inv_code != ''">
			AND b.inv_code = #{inv_code,jdbcType=VARCHAR}
		</if>
		<if test="inv_id != null and inv_id != ''">
			AND a.inv_id = #{inv_id,jdbcType=INTEGER}
		</if>

	</select>

	<select id="queryDetailWithDelivery" resultMap="supDeliveryDetailMap"
		parameterType="java.util.Map">
		SELECT mdd.group_id, mdd.hos_id, mdd.copy_code, mdd.delivery_no,
		mdd.detail_id
		, mdd.inv_no, mdd.inv_id, mid.inv_code, mid.inv_name
		, mid.inv_model, mid.unit_code, hu.unit_name, mdd.amount AS
		delivery_amount, nvl(t5.IN_AMOUNT, 0) AS already_amount
		, mdd.amount - nvl(t1.IN_AMOUNT, 0) AS amount, mdd.price,
		nvl(mdd.amount, 0) * nvl(mdd.price, 0) AS amount_money, hfd.fac_name
		,sdm.sup_id,sdm.sup_no,sdm.create_date,sdm.delivery_id,mdd.fac_date
		FROM sup_delivery_detail mdd
		LEFT JOIN mat_inv_dict mid ON mdd.inv_no = mid.inv_no
		AND mid.inv_id = mdd.inv_id
		AND mdd.group_id = mid.group_id
		AND mdd.hos_id = mid.hos_id
		AND mdd.copy_code = mid.copy_code
		AND mid.is_stop = 0
		LEFT JOIN hos_unit hu ON hu.unit_code = mid.unit_code
		AND hu.group_id = mid.group_id
		AND hu.hos_id = mid.hos_id
		AND hu.is_stop = 0
		LEFT JOIN hos_fac_dict hfd ON mdd.group_id = hfd.group_id
		AND mdd.hos_id = hfd.hos_id
		AND mid.fac_id = hfd.fac_id
		LEFT JOIN (
		SELECT group_id, hos_id, copy_code, delivery_no, inv_id
		, SUM(in_amount) AS in_amount
		FROM sup_delivery_in_rela
		WHERE group_id = #{group_id,jdbcType=INTEGER}
		AND hos_id = #{hos_id,jdbcType=INTEGER}
		AND copy_code = #{copy_code,jdbcType=VARCHAR}
		GROUP BY group_id, hos_id, copy_code, delivery_no, inv_id
		) t1 ON t1.inv_id = mdd.inv_id
		AND mdd.group_id = t1.group_id
		AND mdd.hos_id = t1.hos_id
		AND mdd.copy_code = t1.copy_code
		AND t1.delivery_no = mdd.delivery_no
		left join sup_delivery_main sdm on
		mdd.group_id=sdm.group_id and mdd.hos_id=sdm.hos_id and mdd.copy_code=sdm.copy_code
		and mdd.delivery_no=sdm.delivery_no
		left join
		sup_delivery_in_rela t5 on t5.group_id=mdd.group_id and
		t5.hos_id=mdd.hos_id
		and
		t5.copy_code=mdd.copy_code and
		t5.inv_id=mdd.inv_id and
		t5.delivery_no=mdd.delivery_no

		<where>
			exists(select 1 from sup_delivery_main a where
			a.group_id=mdd.group_id
			and a.hos_id=mdd.hos_id
			and
			a.copy_code=mdd.copy_code and
			a.delivery_no=mdd.delivery_no
			<if test="is_dir != null and is_dir != ''">
				and a.is_dir = #{is_dir,jdbcType=INTEGER}
			</if>
			<if test="sup_id != null and sup_id != ''">
				and a.sup_id = #{sup_id,jdbcType=INTEGER}
			</if>
			<if test="sup_no != null and sup_no != ''">
				and a.sup_no = #{sup_no,jdbcType=INTEGER}
			</if>
			)
			and sdm.state=1
			<if test="group_id != null and group_id != ''">
				and mdd.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and mdd.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and mdd.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="delivery_no != null and delivery_no != ''">
				and mdd.delivery_no in ${delivery_no}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND mdd.inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			and mdd.amount-nvl(t1.IN_AMOUNT,0)>0
		</where>
		order by mdd.inv_no, mdd.delivery_no asc
	</select>

	<select id="queryDetail" resultMap="supDeliveryDetailMap"
		parameterType="java.util.Map">
		SELECT mdd.group_id, mdd.hos_id, mdd.copy_code, mdd.delivery_no,
			mdd.detail_id
			, mdd.inv_no, mdd.inv_id, mid.inv_code, mid.inv_name
			, mid.inv_model, mid.unit_code, hu.unit_name, mdd.amount AS
			delivery_amount, nvl(t1.IN_AMOUNT, 0) AS already_amount
			, mdd.amount - nvl(t1.IN_AMOUNT, 0) AS amount, mdd.price,
			nvl(mdd.amount, 0) * nvl(mdd.price, 0) AS amount_money, hfd.fac_name
			,sdm.sup_id,sdm.sup_no,sdm.create_date,sdm.delivery_id,mdd.batch_no,mdd.inva_date,
			mdd.disinfect_date,mdd.sn,sdm.bill_type, mdd.cert_id,mdd.bar_code,mid.is_per_bar,mid.is_bar
			,mdd.serial_no,mic.cert_code,mdd.fac_date,mid.bid_code,mdd.note,mdd.disinfect_no<!-- ,msi.store_id,
			hsd.store_no, hsd.store_code, hsd.store_name -->
		FROM sup_delivery_detail mdd
		LEFT JOIN mat_inv_dict mid ON  mid.inv_id = mdd.inv_id
		AND mdd.group_id = mid.group_id
		AND mdd.hos_id = mid.hos_id
		AND mdd.copy_code = mid.copy_code
		and mid.is_stop=0
		LEFT JOIN hos_unit hu ON hu.unit_code = mid.unit_code
		AND hu.group_id = mid.group_id
		AND hu.hos_id = mid.hos_id
		AND hu.is_stop = 0
		LEFT JOIN hos_fac_dict hfd ON mdd.group_id = hfd.group_id
		AND mdd.hos_id = hfd.hos_id
		AND mid.fac_id = hfd.fac_id
		AND hfd.is_stop = 0
		LEFT JOIN (
			SELECT group_id, hos_id, copy_code, delivery_no, inv_id
				, SUM(in_amount) AS in_amount
			FROM sup_delivery_in_rela
			WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			GROUP BY group_id, hos_id, copy_code, delivery_no, inv_id
		) t1 ON t1.inv_id = mdd.inv_id
			AND mdd.group_id = t1.group_id
			AND mdd.hos_id = t1.hos_id
			AND mdd.copy_code = t1.copy_code
			AND t1.delivery_no = mdd.delivery_no
		left join sup_delivery_main sdm on
			mdd.group_id=sdm.group_id and mdd.hos_id=sdm.hos_id and mdd.copy_code=sdm.copy_code
			and mdd.delivery_no=sdm.delivery_no
		left join mat_prod_cert mic on mdd.group_id = mic.group_id
			and mdd.hos_id = mic.hos_id
			and mdd.copy_code = mic.copy_code
			and mdd.cert_id=mic.cert_id
		left join mat_store_inv msi on
			mid.group_id=msi.group_id
			and mid.hos_id=msi.hos_id
			and mid.copy_code=msi.copy_code
			and mid.inv_id=msi.inv_id
			and mid.is_stop=0
		left join hos_store_dict hsd on
			msi.group_id=hsd.group_id
			and msi.hos_id=hsd.hos_id
			and msi.store_id=hsd.store_id
		<where>
			exists(select 1 from sup_delivery_main a where
			a.group_id=mdd.group_id
			and a.hos_id=mdd.hos_id
			and
			a.copy_code=mdd.copy_code and
			a.delivery_no=mdd.delivery_no
			<if test="is_dir != null and is_dir != ''">
				and a.is_dir = #{is_dir,jdbcType=INTEGER}
			</if>
			<if test="sup_id != null and sup_id != ''">
				and a.sup_id = #{sup_id,jdbcType=INTEGER}
			</if>
			
			)
			and sdm.state=1
			<if test="group_id != null and group_id != ''">
				and mdd.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and mdd.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and mdd.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="delivery_no != null and delivery_no != ''">
				and mdd.delivery_no = #{delivery_no,jdbcType=VARCHAR}
			</if>
			<if test="sn != null and sn != ''">
				and mdd.sn = #{sn,jdbcType=VARCHAR}
			</if>
			<if test="bill_type != null and bill_type != ''">
				and sdm.bill_type = #{bill_type,jdbcType=VARCHAR}
			</if>
			<if test="begin_order_date != null and begin_order_date != ''">
				AND sdm.create_date &gt;=to_date(#{begin_order_date},'yyyy/MM/dd')
			</if>
			<if test="end_order_date != null and end_order_date != ''">
				AND sdm.create_date &lt;=to_date(#{end_order_date},'yyyy/MM/dd')
			</if>
			<if test="sup_id != null and sup_id != ''">
				AND sdm.sup_id = #{sup_id,jdbcType=INTEGER}
			</if>
			
			<if test="inv_id != null and inv_id != ''">
				AND mdd.inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="is_com != null and is_com != ''">
				and mid.is_com = #{is_com,jdbcType=INTEGER}
			</if>
			and mdd.amount-nvl(t1.IN_AMOUNT,0)>0
		</where>
<!-- 		order by mdd.inv_no, mdd.delivery_no asc -->

group  by  mdd.group_id, mdd.hos_id, mdd.copy_code, mdd.delivery_no, mdd.detail_id
  , mdd.inv_no, mdd.inv_id, mid.inv_code, mid.inv_name, mid.inv_model
  , mid.unit_code, hu.unit_name, mdd.amount
  , t1.IN_AMOUNT
  , mdd.amount
  , mdd.price
  , mdd.amount
  , hfd.fac_name, sdm.sup_id, sdm.sup_no, sdm.create_date, sdm.delivery_id
  , mdd.batch_no, mdd.inva_date, mdd.disinfect_date, mdd.sn, sdm.bill_type
  , mdd.cert_id, mdd.bar_code, mid.is_per_bar, mid.is_bar, mdd.serial_no
  , mic.cert_code, mdd.fac_date, mid.bid_code, mdd.note, mdd.disinfect_no
  
   order by mid.inv_code	--mdd.delivery_no,mdd.detail_id
	</select>

	<!-- 查询最大序列号 -->
	<select id="queryDeliveryDetailNextval" resultType="java.lang.Integer">
		select
		SUP_DELIVERY_DETAIL_SEQ.nextval from dual
	</select>


	<select id="queryExistsById" resultMap="supDeliveryDetailMap"
		parameterType="java.util.Map">

		SELECT
		delivery_no,
		inv_id,
		batch_no
		FROM SUP_DELIVERY_DETAIL
		<where>
			<if test="delivery_no != null and delivery_no != ''">
				AND delivery_no = #{delivery_no,jdbcType=VARCHAR}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=VARCHAR}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year,jdbcType=VARCHAR}
			</if>
			<if test="acc_month != null and acc_month != ''">
				AND acc_month = #{acc_month,jdbcType=VARCHAR}
			</if>

		</where>
		order by detail_id asc
	</select>
	
	<select id="queryDetailByStore" resultMap="supDeliveryDetailMap" parameterType="java.util.Map">
		with order_tmp as (
			select  sdd.group_id,sdd.hos_id,sdd.copy_code,a.delivery_id,a.delivery_no,sdd.detail_id,hsd.sup_id,hsd.sup_no,hsd.sup_code,hsd.sup_name,
	             b.store_id,b.store_no,d.store_code,d.store_name,ms.examiner,hdd.emp_code examiner_code,hdd.emp_name examiner_name,
	             ms.stock_emp,hd.emp_code stock_code,hd.emp_name stock_name,
	             mid.bid_code,mid.inv_id,mid.inv_no,mid.inv_code,mid.inv_name,mid.inv_model,hu.unit_code,hu.unit_name,
	             hfd.fac_id,hfd.fac_no,hfd.fac_code,hfd.fac_name,mic.cert_code,mic.cert_id,
	             sdd.bar_code,sdd.batch_no,mid.is_per_bar,mid.is_bar,sdd.disinfect_no,sdd.disinfect_date,sdm.create_date,
	             sdd.inva_date,sdd.sn,sdm.bill_type,sdd.serial_no,sdd.note,
	             sdd.price,sdd.amount as delivery_amount,nvl(t1.in_amount, 0) as already_amount, 
	             sdd.amount - nvl(t1.in_amount, 0) as amount, nvl(sdd.amount, 0) * nvl(sdd.price, 0) as amount_money
		     from sup_delivery_detail sdd
		     left join sup_delivery_main sdm on sdd.group_id=sdm.group_id and sdd.hos_id=sdm.hos_id and sdd.copy_code=sdm.copy_code
		          and sdd.delivery_no=sdm.delivery_no
		     left join hos_sup_dict hsd on sdm.group_id=hsd.group_id and sdm.hos_id=hsd.hos_id and sdm.sup_id=hsd.sup_id and sdm.sup_no=hsd.sup_no
		     left join mat_inv_dict mid on sdd.group_id=mid.group_id and sdd.hos_id=mid.hos_id and sdd.copy_code=mid.copy_code
		          and sdd.inv_id=mid.inv_id and sdd.inv_no=mid.inv_no
		     left join hos_unit hu on mid.group_id=hu.group_id and mid.hos_id=hu.hos_id and mid.unit_code=hu.unit_code and hu.is_stop=0
		     left join hos_fac_dict hfd on mid.group_id=hfd.group_id and mid.hos_id=hfd.hos_id and mid.fac_id=hfd.fac_id and mid.fac_no=hfd.fac_no
		     left join sup_delivery_order_rela a on sdd.group_id=a.group_id and sdd.hos_id=a.hos_id and sdd.copy_code=a.copy_code
		          and sdd.delivery_no=a.delivery_no and sdd.inv_id=a.inv_id
		     join mat_order_detail b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code 
		          and a.order_id=b.order_id and a.inv_id=b.inv_id
		     left join hos_store_dict d on b.group_id=d.group_id and b.hos_id=d.hos_id and b.store_id=d.store_id and b.store_no=d.store_no
		     left join mat_store ms on d.group_id=ms.group_id and d.hos_id=ms.hos_id and d.store_id=ms.store_id   
		     left join hos_emp_dict hd on sdd.group_id=hd.group_id and sdd.hos_id=hd.hos_id and ms.stock_emp=hd.emp_id and hd.is_stop=0
		     left join hos_emp_dict hdd on sdd.group_id=hdd.group_id and sdd.hos_id=hdd.hos_id and ms.examiner=hdd.emp_id and hdd.is_stop=0
		     left join mat_prod_cert mic on sdd.group_id = mic.group_id  and sdd.hos_id = mic.hos_id and sdd.copy_code = mic.copy_code and sdd.cert_id = mic.cert_id 
		     left join (
		          select group_id, hos_id, copy_code, delivery_no, inv_id , sum(in_amount) as in_amount
		          from sup_delivery_in_rela
		          where group_id = #{group_id,jdbcType=INTEGER}
					AND hos_id = #{hos_id,jdbcType=INTEGER}
					AND copy_code = #{copy_code,jdbcType=VARCHAR}
		          group by group_id, hos_id, copy_code, delivery_no, inv_id
		    ) t1 on sdd.inv_id = t1.inv_id and sdd.group_id = t1.group_id and sdd.hos_id = t1.hos_id
		          and sdd.copy_code = t1.copy_code and sdd.delivery_no = t1.delivery_no
			<where>
				exists(
					select 1 from sup_delivery_main aa 
					where aa.group_id=sdd.group_id
						and aa.hos_id=sdd.hos_id
						and aa.copy_code=sdd.copy_code 
						and aa.delivery_no=sdd.delivery_no
						<if test="is_dir != null and is_dir != ''">
							and aa.is_dir = #{is_dir,jdbcType=INTEGER}
						</if>
						<if test="sup_id != null and sup_id != ''">
							and aa.sup_id = #{sup_id,jdbcType=INTEGER}
						</if>
				  )
				and sdm.state=1
				<if test="group_id != null and group_id != ''">
					and sdd.group_id = #{group_id,jdbcType=INTEGER}
				</if>
				<if test="hos_id != null and hos_id != ''">
					and sdd.hos_id = #{hos_id,jdbcType=INTEGER}
				</if>
				<if test="copy_code != null and copy_code != ''">
					and sdd.copy_code = #{copy_code,jdbcType=VARCHAR}
				</if>
				<if test="delivery_no != null and delivery_no != ''">
					and sdd.delivery_no = #{delivery_no,jdbcType=VARCHAR}
				</if>
				<if test="delivery_nos != null and delivery_nos != ''">
					and sdd.delivery_no = #{delivery_nos,jdbcType=VARCHAR}
				</if>
				<if test="sn != null and sn != ''">
					and sdd.sn = #{sn,jdbcType=VARCHAR}
				</if>
				<if test="bill_type != null and bill_type != ''">
					and sdm.bill_type = #{bill_type,jdbcType=VARCHAR}
				</if>
				<if test="begin_order_date != null and begin_order_date != ''">
					AND sdm.create_date &gt;=to_date(#{begin_order_date},'yyyy/MM/dd')
				</if>
				<if test="end_order_date != null and end_order_date != ''">
					AND sdm.create_date &lt;=to_date(#{end_order_date},'yyyy/MM/dd')
				</if>
				<if test="sup_id != null and sup_id != ''">
					AND sdm.sup_id = #{sup_id,jdbcType=INTEGER}
				</if>
				<if test="inv_id != null and inv_id != ''">
					AND mid.inv_id = #{inv_id,jdbcType=INTEGER}
				</if>
				<if test="is_com != null and is_com != ''">
					and mid.is_com = #{is_com,jdbcType=INTEGER}
				</if>
				and sdd.amount-nvl(t1.in_amount,0) &gt; 0
			</where>
			order by mid.inv_code
		),inv_tmp as (
			select  sdd.group_id, sdd.hos_id, sdd.copy_code, sdm.delivery_id, sdd.delivery_no,sdd.detail_id,hsd.sup_id,hsd.sup_no,hsd.sup_code,hsd.sup_name,
	             b.store_id,d.store_no,d.store_code,d.store_name,ms.examiner,hdd.emp_code examiner_code,hdd.emp_name examiner_name,
	             ms.stock_emp,hd.emp_code stock_code,hd.emp_name stock_name,
	             mid.bid_code,mid.inv_id,mid.inv_no,mid.inv_code,mid.inv_name,mid.inv_model,hu.unit_code,hu.unit_name,
	             hfd.fac_id,hfd.fac_no,hfd.fac_code,hfd.fac_name,mic.cert_code,mic.cert_id,
	             sdd.bar_code,sdd.batch_no,mid.is_per_bar,mid.is_bar,sdd.disinfect_no,sdd.disinfect_date,sdm.create_date,
	             sdd.inva_date,sdd.sn,sdm.bill_type,sdd.serial_no,sdd.note,
	             sdd.price,sdd.amount as delivery_amount,nvl(t1.in_amount, 0) as already_amount, 
	             sdd.amount - nvl(t1.in_amount, 0) as amount, nvl(sdd.amount, 0) * nvl(sdd.price, 0) as amount_money
		     from sup_delivery_detail sdd
		     left join sup_delivery_main sdm on sdd.group_id=sdm.group_id and sdd.hos_id=sdm.hos_id and sdd.copy_code=sdm.copy_code
		          and sdd.delivery_no=sdm.delivery_no
		     left join hos_sup_dict hsd on sdm.group_id=hsd.group_id and sdm.hos_id=hsd.hos_id and sdm.sup_id=hsd.sup_id and sdm.sup_no=hsd.sup_no
		     left join mat_inv_dict mid on sdd.group_id=mid.group_id and sdd.hos_id=mid.hos_id and sdd.copy_code=mid.copy_code
		          and sdd.inv_id=mid.inv_id and sdd.inv_no=mid.inv_no
		     left join hos_unit hu on mid.group_id=hu.group_id and mid.hos_id=hu.hos_id and mid.unit_code=hu.unit_code and hu.is_stop=0
		     left join hos_fac_dict hfd on mid.group_id=hfd.group_id and mid.hos_id=hfd.hos_id and mid.fac_id=hfd.fac_id and mid.fac_no=hfd.fac_no
		     left join mat_store_inv b on mid.group_id=b.group_id and  mid.hos_id=b.hos_id and mid.copy_code=b.copy_code and mid.inv_id=b.inv_id and b.is_apply=1
		     left join hos_store_dict d on b.group_id=d.group_id and b.hos_id=d.hos_id and b.store_id=d.store_id and d.is_stop = 0
		     left join mat_store ms on d.group_id=ms.group_id and d.hos_id=ms.hos_id and d.store_id=ms.store_id   
		     left join hos_emp_dict hd on sdd.group_id=hd.group_id and sdd.hos_id=hd.hos_id and ms.stock_emp=hd.emp_id and hd.is_stop=0
		     left join hos_emp_dict hdd on sdd.group_id=hdd.group_id and sdd.hos_id=hdd.hos_id and ms.examiner=hdd.emp_id and hdd.is_stop=0
		     left join mat_prod_cert mic on sdd.group_id = mic.group_id  and sdd.hos_id = mic.hos_id and sdd.copy_code = mic.copy_code and sdd.cert_id = mic.cert_id 
		     left join (
		          select group_id, hos_id, copy_code, delivery_no, inv_id , sum(in_amount) as in_amount
		          from sup_delivery_in_rela
		          where group_id = #{group_id,jdbcType=INTEGER}
					AND hos_id = #{hos_id,jdbcType=INTEGER}
					AND copy_code = #{copy_code,jdbcType=VARCHAR}
		          group by group_id, hos_id, copy_code, delivery_no, inv_id
		    ) t1 on sdd.inv_id = t1.inv_id and sdd.group_id = t1.group_id and sdd.hos_id = t1.hos_id
		          and sdd.copy_code = t1.copy_code and sdd.delivery_no = t1.delivery_no
			<where>
				exists(
					select 1 from sup_delivery_main aa 
					where aa.group_id=sdd.group_id
						and aa.hos_id=sdd.hos_id
						and aa.copy_code=sdd.copy_code 
						and aa.delivery_no=sdd.delivery_no
						<if test="is_dir != null and is_dir != ''">
							and aa.is_dir = #{is_dir,jdbcType=INTEGER}
						</if>
						<if test="sup_id != null and sup_id != ''">
							and aa.sup_id = #{sup_id,jdbcType=INTEGER}
						</if>
				  )
				and sdm.state=1
				<if test="group_id != null and group_id != ''">
					and sdd.group_id = #{group_id,jdbcType=INTEGER}
				</if>
				<if test="hos_id != null and hos_id != ''">
					and sdd.hos_id = #{hos_id,jdbcType=INTEGER}
				</if>
				<if test="copy_code != null and copy_code != ''">
					and sdd.copy_code = #{copy_code,jdbcType=VARCHAR}
				</if>
				<if test="delivery_no != null and delivery_no != ''">
					and sdd.delivery_no = #{delivery_no,jdbcType=VARCHAR}
				</if>
				<if test="delivery_nos != null and delivery_nos != ''">
					and sdd.delivery_no = #{delivery_nos,jdbcType=VARCHAR}
				</if>
				<if test="sn != null and sn != ''">
					and sdd.sn = #{sn,jdbcType=VARCHAR}
				</if>
				<if test="bill_type != null and bill_type != ''">
					and sdm.bill_type = #{bill_type,jdbcType=VARCHAR}
				</if>
				<if test="begin_order_date != null and begin_order_date != ''">
					AND sdm.create_date &gt;=to_date(#{begin_order_date},'yyyy/MM/dd')
				</if>
				<if test="end_order_date != null and end_order_date != ''">
					AND sdm.create_date &lt;=to_date(#{end_order_date},'yyyy/MM/dd')
				</if>
				<if test="sup_id != null and sup_id != ''">
					AND sdm.sup_id = #{sup_id,jdbcType=INTEGER}
				</if>
				<if test="inv_id != null and inv_id != ''">
					AND mid.inv_id = #{inv_id,jdbcType=INTEGER}
				</if>
				<if test="is_com != null and is_com != ''">
					and mid.is_com = #{is_com,jdbcType=INTEGER}
				</if>
				and sdd.amount-nvl(t1.in_amount,0) &gt; 0
			</where>
			order by mid.inv_code
		)
		
		select group_id,hos_id,copy_code,delivery_id,delivery_no,detail_id,sup_id,sup_no,sup_code,sup_name,
             store_id,store_no,store_code,store_name,examiner,examiner_code,examiner_name,
             stock_emp,stock_code,stock_name,bid_code,inv_id,inv_no,inv_code,inv_name,inv_model,unit_code,unit_name,
             fac_id,fac_no,fac_code,fac_name,cert_code,cert_id,
             bar_code,batch_no,is_per_bar,is_bar,disinfect_no,disinfect_date,create_date,
             inva_date,sn,bill_type,serial_no,note,price,delivery_amount,already_amount,amount, amount_money
		from order_tmp
		union
		select group_id,hos_id,copy_code,delivery_id,delivery_no,detail_id,sup_id,sup_no,sup_code,sup_name,
             store_id,store_no,store_code,store_name,examiner,examiner_code,examiner_name,
             stock_emp,stock_code,stock_name,bid_code,inv_id,inv_no,inv_code,inv_name,inv_model,unit_code,unit_name,
             fac_id,fac_no,fac_code,fac_name,cert_code,cert_id,
             bar_code,batch_no,is_per_bar,is_bar,disinfect_no,disinfect_date,create_date,
             inva_date,sn,bill_type,serial_no,note,price,delivery_amount,already_amount,amount, amount_money
		from inv_tmp
		order by inv_code
	</select>
</mapper>

