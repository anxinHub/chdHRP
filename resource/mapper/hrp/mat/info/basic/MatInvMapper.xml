<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.mat.dao.info.basic.MatInvMapper">  
	<resultMap id="matInv" type="java.util.Map">
		<result property="group_id" column="group_id"/>
		<result property="hos_id" column="hos_id"/>
		<result property="copy_code" column="copy_code"/>   
		<result property="inv_id" column="inv_id"/>
		<result property="inv_no" column="inv_no"/> 
		<result property="inv_code" column="inv_code"/>
		<result property="inv_name" column="inv_name"/> 
		<result property="alias" column="alias"/>
		<result property="spell_code" column="spell_code"/>
		<result property="wbx_code" column="wbx_code"/>
		<result property="mat_type_id" column="mat_type_id"/>
		<result property="mat_type_no" column="mat_type_no"/>
		<result property="mat_type_code" column="mat_type_code"/>
		<result property="mat_type_name" column="mat_type_name"/>
		<result property="inv_model" column="inv_model"/>
		<result property="unit_code" column="unit_code"/> 
		<result property="unit_name" column="unit_name"/>
		<result property="fac_id" column="fac_id"/>
		<result property="fac_no" column="fac_no"/>
		<result property="fac_code" column="fac_code"/>
		<result property="fac_name" column="fac_name"/>
		<result property="sup_name" column="sup_name"/>
		<result property="amortize_type" column="amortize_type"/>
		<result property="price_type" column="price_type"/>
		<result property="plan_price" column="plan_price"/>
		<result property="price_rate" column="price_rate"/>
		<result property="sell_price" column="sell_price"/>
		<result property="is_single_ven" column="is_single_ven"/>
		<result property="is_batch" column="is_batch"/>
		<result property="is_bar" column="is_bar"/>
		<result property="is_per_bar" column="is_per_bar"/>
		<result property="is_inv_bar" column="is_inv_bar"/>
		<result property="is_cert" column="is_cert"/>
		<result property="is_quality" column="is_quality"/>
		<result property="is_disinfect" column="is_disinfect"/>
		<result property="is_com" column="is_com"/>
		<result property="is_dura" column="is_dura"/>
		<result property="is_highvalue" column="is_highvalue"/>
		<result property="is_charge" column="is_charge"/>
		<result property="is_sec_whg" column="is_sec_whg"/>
		<result property="is_shel_make" column="is_shel_make"/>
		<result property="sdate" column="sdate"/>
		<result property="edate" column="edate"/>
		<result property="bar_code_new" column="bar_code_new"/>
		<result property="abc_type" column="abc_type"/>
		<result property="per_weight" column="per_weight"/>
		<result property="per_volum" column="per_volum"/>
		<result property="brand_name" column="brand_name"/>
		<result property="agent_name" column="agent_name"/>
		<result property="inv_structure" column="inv_structure"/>
		<result property="inv_usage" column="inv_usage"/>
		<result property="use_state" column="use_state"/>
		<result property="note" column="note"/>
		<result property="state" column="state"/>
		<result property="check_date" column="check_date"/>
		<result property="checker" column="checker"/>
		<result property="checker_name" column="checker_name"/>
		<result property="is_bid" column="is_bid"/>
		<result property="bid_date" column="bid_date"/> 
		<result property="bid_code" column="bid_code"/>
		<result property="is_involved" column="is_involved"/>
		<result property="is_implant" column="is_implant"/>
		<result property="stora_tran_cond" column="stora_tran_cond"/>
		<result property="is_zero_store" column="is_zero_store"/>
		<result property="alias" column="alias"/>
		<result property="alias_spell" column="alias_spell"/>
		<result property="manage_type" column="manage_type"/>
		<result property="cert_code" column="cert_code"/>
		<result property="start_date" column="start_date"/>
		<result property="end_date" column="end_date"/>
		<result property="memory_encoding" column="memory_encoding"/>
		<result property="source_plan" column="source_plan"/>
		<result property="manage_type_name" column="manage_type_name"/>
		<result property="certIds" column="certIds"/>
		<result property="change_date" column="change_date"/>
		<result property="instru_type_id" column="instru_type_id"/>
		<result property="instru_type_text" column="instru_type_text"/>
		<result property="charge_code" column="charge_code"/>
	</resultMap>
	
	
	<resultMap id="certSupMap" type="java.util.Map"> 
		<result property="sup_id" column="sup_id"/>
		<result property="sup_code" column="sup_code"/>
		<result property="sup_name" column="sup_name"/>
		<result property="fac_id" column="fac_id"/>
		<result property="fac_name" column="fac_name"/>
	</resultMap>
	
	<resultMap id="facMap" type="java.util.Map">
		<result property="fac_id" column="fac_id"/>
		<result property="fac_name" column="fac_name"/>
	</resultMap>
	
	<resultMap id="invCert" type="java.util.Map">
    	<result property="group_id" column="group_id"/>
		<result property="hos_id" column="hos_id"/>
		<result property="copy_code" column="copy_code"/>
		<result property="cert_id" column="cert_id"/>
		<result property="cert_code" column="cert_code"/>
		<result property="prod_name" column="prod_name"/>
		<result property="cert_type_code" column="cert_type_code"/>
		<result property="cert_type_name" column="cert_type_name"/>
		<result property="fac_id" column="fac_id"/>
		<result property="cert_date" column="cert_date"/>
		<result property="start_date" column="start_date"/>
		<result property="end_date" column="end_date"/>
		<result property="is_stop" column="is_stop"/>
		<result property="fac_code" column="fac_code"/>
		<result property="fac_name" column="fac_name"/>
		<result property="sup_id" column="sup_id"/>
		<result property="sup_code" column="sup_code"/>
		<result property="sup_name" column="sup_name"/>
	</resultMap>
	
	<resultMap id="hrpMatInvMap" type="java.util.Map" >
		<result property="inv_id" column="inv_id"/>
		<result property="inv_name" column="inv_name"/>
		<result property="inv_model" column="inv_model"/>
		<result property="unit_name" column="unit_name"/>
		<result property="plan_price" column="plan_price"/>
		<result property="sale_price" column="sale_price"/>
		<result property="factory_name" column="factory_name"/>
		<result property="cert_code" column="cert_code"/>
		<result property="inv_state" column="inv_state"/>
	</resultMap>
	
	<select id="queryMatInvSeq"  resultType="java.lang.Integer" useCache="false" flushCache="true">
		SELECT MAT_INV_SEQ.nextval as inv_id FROM DUAL
	</select>
	
	<select id="queryMatInvSeqCur"  resultType="java.lang.Integer" useCache="false" flushCache="true">
		SELECT MAT_INV_SEQ.CURRVAL as inv_id FROM DUAL
	</select>
	
	<!-- 材料添加 -->
	<insert id="add" parameterType="java.util.Map" >
		INSERT INTO MAT_INV (
			group_id, hos_id, copy_code, inv_id, inv_code, inv_name, spell_code,wbx_code, mat_type_id, 
			price_type, amortize_type, inv_model, unit_code, plan_price, price_rate, sell_price, fac_id, 
			agent_name, brand_name, inv_usage, inv_structure, sdate, edate, per_weight, per_volum, 
			
			
			abc_type, use_state, is_single_ven, is_charge, is_highvalue, is_dura, is_com, is_bar, is_per_bar, 
			is_inv_bar, is_quality, is_disinfect, is_cert, is_sec_whg, is_shel_make, is_batch, state, bar_code_new, 
			is_bid, bid_date, bid_code, is_involved, is_implant, stora_tran_cond, is_zero_store,alias,alias_spell,
			manage_type, memory_encoding, source_plan, instru_type_id, charge_code
		) 
		VALUES (
			#{group_id,jdbcType=INTEGER},
			#{hos_id,jdbcType=INTEGER},
			#{copy_code,jdbcType=VARCHAR},
			#{inv_id,jdbcType=INTEGER},
			#{inv_code,jdbcType=VARCHAR},
			#{inv_name,jdbcType=VARCHAR},
			#{spell_code,jdbcType=VARCHAR},
			#{wbx_code,jdbcType=VARCHAR},
			#{mat_type_id,jdbcType=INTEGER},
			#{price_type,jdbcType=INTEGER},
			#{amortize_type,jdbcType=INTEGER},
			#{inv_model,jdbcType=VARCHAR},
			#{unit_code,jdbcType=VARCHAR},
			#{plan_price,jdbcType=INTEGER},
			#{price_rate,jdbcType=INTEGER},
			#{sell_price,jdbcType=INTEGER},
			#{fac_id,jdbcType=INTEGER},
			#{agent_name,jdbcType=VARCHAR},
			#{brand_name,jdbcType=VARCHAR},
			#{inv_usage,jdbcType=VARCHAR},
			#{inv_structure,jdbcType=VARCHAR},
			#{sdate,jdbcType=DATE},
			#{edate,jdbcType=DATE},
			#{per_weight,jdbcType=INTEGER},
			#{per_volum,jdbcType=INTEGER},
			#{abc_type,jdbcType=VARCHAR},
			#{use_state,jdbcType=INTEGER},
			
			#{is_single_ven,jdbcType=INTEGER},
			#{is_charge,jdbcType=INTEGER},
			#{is_highvalue,jdbcType=INTEGER},
			#{is_dura,jdbcType=INTEGER},
			#{is_com,jdbcType=INTEGER},
			#{is_bar,jdbcType=INTEGER},
			#{is_per_bar,jdbcType=INTEGER},
			#{is_inv_bar,jdbcType=INTEGER},
			#{is_quality,jdbcType=INTEGER},
			#{is_disinfect,jdbcType=INTEGER}, 
			#{is_cert,jdbcType=INTEGER},
			#{is_sec_whg,jdbcType=INTEGER},
			#{is_shel_make,jdbcType=INTEGER},
			#{is_batch,jdbcType=INTEGER}, 
			#{state,jdbcType=INTEGER},  
		
			#{bar_code_new,jdbcType=VARCHAR}, <!-- 品种码默认等于材料编码 --> 
			<!-- <if test="barcode == 1">
			#{inv_code,jdbcType=VARCHAR}, 品种码默认等于材料编码
			</if>
			
			<if test="barcode == 0">
			#{bar_code_new,jdbcType=VARCHAR}, 品种码默认等于材料编码
			</if> -->
			#{is_bid,jdbcType=INTEGER},
			#{bid_date,jdbcType=DATE},
			#{bid_code,jdbcType=VARCHAR}, 
			#{is_involved,jdbcType=INTEGER},  
			#{is_implant,jdbcType=INTEGER},
			#{stora_tran_cond,jdbcType=VARCHAR}, 
			#{is_zero_store,jdbcType=INTEGER},
			#{alias,jdbcType=VARCHAR}, 
			#{alias_spell,jdbcType=VARCHAR},
			#{manage_type,jdbcType=VARCHAR},
			#{memory_encoding,jdbcType=VARCHAR},
			#{source_plan,jdbcType=INTEGER},
			#{instru_type_id,jdbcType=INTEGER},
			#{charge_code,jdbcType=VARCHAR}
		)
	</insert>
	
	<!-- 材料批量添加 -->
	<insert id="addBatch" parameterType="java.util.List" >
		INSERT INTO MAT_INV (
			group_id, hos_id, copy_code, inv_id, inv_code, inv_name, alias, alias_spell, spell_code,wbx_code, 
			mat_type_id, price_type, amortize_type, inv_model, unit_code, plan_price, price_rate, sell_price, 
			fac_id, agent_name, brand_name, inv_usage, inv_structure, sdate, edate, per_weight, per_volum, 
			abc_type, use_state, is_single_ven, is_charge, is_highvalue, is_dura, is_com, is_bar, is_per_bar,  
			is_inv_bar, is_quality, is_disinfect, is_cert, is_sec_whg, is_shel_make, is_batch, state, bar_code_new,
			is_bid, bid_date, bid_code, is_involved, is_implant, stora_tran_cond, is_zero_store, manage_type, 
			memory_encoding, source_plan 
		) 
		SELECT * FROM(
		<foreach collection="list" item="item" index="index" separator=" union all " >
			SELECT 	
				#{item.group_id,jdbcType=INTEGER},
				#{item.hos_id,jdbcType=INTEGER},
				#{item.copy_code,jdbcType=VARCHAR},
			    #{item.inv_id,jdbcType=INTEGER},
				#{item.inv_code,jdbcType=VARCHAR},
				#{item.inv_name,jdbcType=VARCHAR},
			    #{item.alias,jdbcType=VARCHAR},
			    #{item.alias_spell,jdbcType=VARCHAR},
				#{item.spell_code,jdbcType=VARCHAR},
				#{item.wbx_code,jdbcType=VARCHAR},
				#{item.mat_type_id,jdbcType=INTEGER},
				#{item.price_type,jdbcType=INTEGER},
				#{item.amortize_type,jdbcType=INTEGER},
				#{item.inv_model,jdbcType=VARCHAR},
				#{item.unit_code,jdbcType=VARCHAR},
				#{item.plan_price,jdbcType=INTEGER},
				#{item.price_rate,jdbcType=INTEGER},
				#{item.sell_price,jdbcType=INTEGER},
				#{item.fac_id,jdbcType=INTEGER},
				#{item.agent_name,jdbcType=VARCHAR},
				#{item.brand_name,jdbcType=VARCHAR},
				#{item.inv_usage,jdbcType=VARCHAR},
				#{item.inv_structure,jdbcType=VARCHAR},
				#{item.sdate,jdbcType=DATE},
				#{item.edate,jdbcType=DATE},
				#{item.per_weight,jdbcType=INTEGER},
				#{item.per_volum,jdbcType=INTEGER},
				#{item.abc_type,jdbcType=VARCHAR},
				#{item.use_state,jdbcType=INTEGER},
				
				#{item.is_single_ven,jdbcType=INTEGER},
				#{item.is_charge,jdbcType=INTEGER},
				#{item.is_highvalue,jdbcType=INTEGER},
				#{item.is_dura,jdbcType=INTEGER},
				#{item.is_com,jdbcType=INTEGER},
				#{item.is_bar,jdbcType=INTEGER},
				#{item.is_per_bar,jdbcType=INTEGER},
				#{item.is_inv_bar,jdbcType=INTEGER},
				#{item.is_quality,jdbcType=INTEGER},
				#{item.is_disinfect,jdbcType=INTEGER}, 
				#{item.is_cert,jdbcType=INTEGER},
				#{item.is_sec_whg,jdbcType=INTEGER},
				#{item.is_shel_make,jdbcType=INTEGER},
				#{item.is_batch,jdbcType=INTEGER}, 
				#{item.state,jdbcType=INTEGER},  
				#{item.bar_code_new,jdbcType=VARCHAR}, <!-- 品种码默认等于材料编码 -->
				#{item.is_bid,jdbcType=INTEGER},
				#{item.bid_date,jdbcType=DATE},
				#{item.bid_code,jdbcType=VARCHAR}, 
				#{item.is_involved,jdbcType=INTEGER},  
				#{item.is_implant,jdbcType=INTEGER},
				#{item.stora_tran_cond,jdbcType=VARCHAR}, 
				#{item.is_zero_store,jdbcType=INTEGER}, 
				#{item.manage_type,jdbcType=VARCHAR}, 
				#{item.memory_encoding,jdbcType=VARCHAR}, 
				#{item.source_plan,jdbcType=INTEGER}
			FROM DUAL
		</foreach>
		)t
	</insert>
	
	<!-- 材料修改 -->
	<update id="update" parameterType="java.util.Map">
		UPDATE mat_inv SET
			inv_code = #{inv_code,jdbcType=VARCHAR},
			bar_code_new = #{bar_code_new,jdbcType=VARCHAR},<!-- 品种码默认等于材料编码 -->
			inv_name = #{inv_name,jdbcType=VARCHAR},
			spell_code = #{spell_code,jdbcType=VARCHAR},
			wbx_code = #{wbx_code,jdbcType=VARCHAR},
			mat_type_id = #{mat_type_id,jdbcType=INTEGER},
			price_type = #{price_type,jdbcType=INTEGER},
			amortize_type = #{amortize_type,jdbcType=INTEGER},
			inv_model = #{inv_model,jdbcType=VARCHAR},
			unit_code = #{unit_code,jdbcType=VARCHAR},
			plan_price = #{plan_price,jdbcType=INTEGER},
			price_rate = #{price_rate,jdbcType=INTEGER},
			sell_price = #{sell_price,jdbcType=INTEGER},
			fac_id = #{fac_id,jdbcType=INTEGER},
			agent_name = #{agent_name,jdbcType=VARCHAR},
			brand_name = #{brand_name,jdbcType=VARCHAR},
			inv_usage = #{inv_usage,jdbcType=VARCHAR},
			inv_structure = #{inv_structure,jdbcType=VARCHAR},
			sdate = #{sdate,jdbcType=DATE},
			edate = #{edate,jdbcType=DATE},
			per_weight = #{per_weight,jdbcType=INTEGER},
			per_volum = #{per_volum,jdbcType=INTEGER},
			abc_type =  #{abc_type,jdbcType=VARCHAR},
			use_state = #{use_state,jdbcType=INTEGER},
			is_single_ven = #{is_single_ven,jdbcType=INTEGER},
			is_charge = #{is_charge,jdbcType=INTEGER},
			is_highvalue = #{is_highvalue,jdbcType=INTEGER},
			is_dura = #{is_dura,jdbcType=INTEGER},
			is_com = #{is_com,jdbcType=INTEGER},
			is_bar = #{is_bar,jdbcType=INTEGER},
			is_per_bar = #{is_per_bar,jdbcType=INTEGER},
			is_inv_bar = #{is_inv_bar,jdbcType=INTEGER},
			is_quality = #{is_quality,jdbcType=INTEGER},
			is_disinfect = #{is_disinfect,jdbcType=INTEGER},
			is_cert = #{is_cert,jdbcType=INTEGER},
			is_sec_whg = #{is_sec_whg,jdbcType=INTEGER},
			is_shel_make = #{is_shel_make,jdbcType=INTEGER},
			note = #{note,jdbcType=VARCHAR},
			is_bid = #{is_bid,jdbcType=INTEGER},
			bid_date = #{bid_date,jdbcType=DATE},
			bid_code = #{bid_code,jdbcType=VARCHAR},
			is_involved = #{is_involved,jdbcType=INTEGER},
			is_implant = #{is_implant,jdbcType=INTEGER},
			stora_tran_cond = #{stora_tran_cond,jdbcType=VARCHAR},
			is_zero_store = #{is_zero_store,jdbcType=INTEGER},
			alias = #{alias,jdbcType=VARCHAR},
			alias_spell = #{alias_spell,jdbcType=INTEGER}, 
			source_plan = #{source_plan,jdbcType=INTEGER}, 
			manage_type = #{manage_type,jdbcType=VARCHAR},
			memory_encoding = #{memory_encoding,jdbcType=VARCHAR},
			instru_type_id = #{instru_type_id,jdbcType=INTEGER}, 
			charge_code = #{charge_code,jdbcType=VARCHAR}
			<!-- 材料全部按批不能修改该属性
			is_batch = #{is_batch,jdbcType=INTEGER},
			-->
		WHERE 
			group_id =#{group_id,jdbcType=INTEGER}
		 	and hos_id =#{hos_id,jdbcType=INTEGER}
		 	and copy_code =#{copy_code,jdbcType=VARCHAR}
		 	and inv_id =#{inv_id,jdbcType=INTEGER}
	</update>
	
	<!-- 材料批量修改 -->
	<update id="updateBatch" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			UPDATE mat_inv SET
			    inv_id = #{item.inv_id,jdbcType=INTEGER}
			<if test="item.inv_code != null and item.inv_code != ''">
			    ,inv_code = #{item.inv_code,jdbcType=VARCHAR}
			</if>
			<if test="item.bar_code_new != null and item.bar_code_new != ''">
			    ,bar_code_new = #{item.bar_code_new,jdbcType=VARCHAR}<!-- 品种码默认等于材料编码 -->
			</if>
			<if test="item.inv_name != null and item.inv_name != ''">
			    ,inv_name = #{item.inv_name,jdbcType=VARCHAR}
			</if>
			<if test="item.spell_code != null and item.spell_code != ''">
			    ,spell_code = #{item.spell_code,jdbcType=VARCHAR}
			</if>
			<if test="item.wbx_code != null and item.wbx_code != ''">
				,wbx_code = #{item.wbx_code,jdbcType=VARCHAR}
			</if>
			<if test="item.mat_type_id != null and item.mat_type_id != ''">
				,mat_type_id = #{item.mat_type_id,jdbcType=INTEGER}
			</if>
			<if test="item.price_type != null and item.price_type != ''">
				,price_type = #{item.price_type,jdbcType=INTEGER}
			</if>
			<if test="item.amortize_type != null and item.amortize_type != ''">
				,amortize_type = #{item.amortize_type,jdbcType=INTEGER}
			</if>
			<if test="item.inv_model != null and item.inv_model != ''">
				,inv_model = #{item.inv_model,jdbcType=VARCHAR}
			</if>
			<if test="item.unit_code != null and item.unit_code != ''">
				,unit_code = #{item.unit_code,jdbcType=VARCHAR}
			</if>
			<if test="item.plan_price != null and item.plan_price != ''">
				,plan_price = #{item.plan_price,jdbcType=NUMERIC}
			</if>
			<if test="item.price_rate != null and item.price_rate != ''">
				,price_rate = #{item.price_rate,jdbcType=NUMERIC}
			</if>
			<if test="item.sell_price != null and item.sell_price != ''">
				,sell_price = #{item.sell_price,jdbcType=NUMERIC}
			</if>
			<if test="item.fac_id != null and item.fac_id != ''">
				,fac_id = #{item.fac_id,jdbcType=INTEGER}
			</if>
			<if test="item.agent_name != null and item.agent_name != ''">
				,agent_name = #{item.agent_name,jdbcType=VARCHAR}
			</if>
			<if test="item.brand_name != null and item.brand_name != ''">
				,brand_name = #{item.brand_name,jdbcType=VARCHAR}
			</if>
			<if test="item.inv_usage != null and item.inv_usage != ''">
				,inv_usage = #{item.inv_usage,jdbcType=VARCHAR}
			</if>
			<if test="item.inv_structure != null and item.inv_structure != ''">
				,inv_structure = #{item.inv_structure,jdbcType=VARCHAR}
			</if>
			<if test="item.sdate != null and item.sdate != ''">
				,sdate = #{item.sdate,jdbcType=DATE}
			</if>
			<if test="item.edate != null and item.edate != ''">
				,edate = #{item.edate,jdbcType=DATE}
			</if>
			<if test="item.per_weight != null and item.per_weight != ''">
				,per_weight = #{item.per_weight,jdbcType=INTEGER}
			</if>
			<if test="item.per_volum != null and item.per_volum != ''">
				,per_volum = #{item.per_volum,jdbcType=INTEGER}
			</if>
			<if test="item.abc_type != null and item.abc_type != ''">
				,abc_type =  #{item.abc_type,jdbcType=VARCHAR}
			</if>
			<if test="item.use_state != null and item.use_state != ''">
				,use_state = #{item.use_state,jdbcType=INTEGER}
			</if>
			<if test="item.is_single_ven != null and item.is_single_ven != ''">
				,is_single_ven = #{item.is_single_ven,jdbcType=INTEGER}
			</if>
			<if test="item.is_charge != null and item.is_charge != ''">
				,is_charge = #{item.is_charge,jdbcType=INTEGER}
			</if>
			<if test="item.is_highvalue != null and item.is_highvalue != ''">
				,is_highvalue = #{item.is_highvalue,jdbcType=INTEGER}
			</if>
			<if test="item.is_dura != null and item.is_dura != ''">
				,is_dura = #{item.is_dura,jdbcType=INTEGER}
			</if>
			<if test="item.is_com != null and item.is_com != ''">
				,is_com = #{item.is_com,jdbcType=INTEGER}
			</if>
			<if test="item.is_bar != null and item.is_bar != ''">
				,is_bar = #{item.is_bar,jdbcType=INTEGER}
			</if>
			<if test="item.is_per_bar != null and item.is_per_bar != ''">
				,is_per_bar = #{item.is_per_bar,jdbcType=INTEGER}
			</if>
			<if test="item.is_inv_bar != null and item.is_inv_bar != ''">
				,is_inv_bar = #{item.is_inv_bar,jdbcType=INTEGER}
			</if>
			<if test="item.is_quality != null and item.is_quality != ''">
				,is_quality = #{item.is_quality,jdbcType=INTEGER}
			</if>
			<if test="item.is_disinfect != null and item.is_disinfect != ''">
				,is_disinfect = #{item.is_disinfect,jdbcType=INTEGER}
			</if>
			<if test="item.is_cert != null and item.is_cert != ''">
				,is_cert = #{item.is_cert,jdbcType=INTEGER}
			</if>
			<if test="item.is_sec_whg != null and item.is_sec_whg != ''">
				,is_sec_whg = #{item.is_sec_whg,jdbcType=INTEGER}
			</if>
			<if test="item.is_shel_make != null and item.is_shel_make != ''">
				,is_shel_make = #{item.is_shel_make,jdbcType=INTEGER}
			</if>
			<if test="item.note != null and item.note != ''">
				,note = #{item.note,jdbcType=VARCHAR}
			</if>
			<if test="item.is_bid != null and item.is_bid != ''">
				,is_bid = #{item.is_bid,jdbcType=INTEGER}
			</if>
			<if test="item.bid_date != null and item.bid_date != ''">
				,bid_date = #{item.bid_date,jdbcType=DATE}
			</if>
			<if test="item.bid_code != null and item.bid_code != ''">
				,bid_code = #{item.bid_code,jdbcType=VARCHAR}
			</if>
			<if test="item.is_involved != null and item.is_involved != ''">
				,is_involved = #{item.is_involved,jdbcType=INTEGER}
			</if>
			<if test="item.is_implant != null and item.is_implant != ''">
				,is_implant = #{item.is_implant,jdbcType=INTEGER}
			</if>
			<if test="item.stora_tran_cond != null and item.stora_tran_cond != ''">
				,stora_tran_cond = #{item.stora_tran_cond,jdbcType=VARCHAR}
			</if>
			<if test="item.is_zero_store != null and item.is_zero_store != ''">
				,is_zero_store = #{item.is_zero_store,jdbcType=INTEGER}
			</if>
			<if test="item.alias != null and item.alias != ''">
				,alias = #{item.alias,jdbcType=VARCHAR}
			</if>
			<if test="item.alias_spell != null and item.alias_spell != ''">
				,alias_spell = #{item.alias_spell,jdbcType=VARCHAR}
			</if>
			<if test="item.manage_type != null and item.manage_type != ''">
				,manage_type = #{item.manage_type,jdbcType=VARCHAR}
			</if>
			<if test="item.memory_encoding != null and item.memory_encoding != ''">
				,memory_encoding = #{item.memory_encoding,jdbcType=VARCHAR}
			</if>
			<if test="item.source_plan != null and item.source_plan != ''">
				,source_plan = #{item.source_plan,jdbcType=INTEGER}
			</if>
			<if test="item.instru_type_id != null and item.instru_type_id != ''">
				,instru_type_id = #{item.instru_type_id,jdbcType=INTEGER}
			</if>
			    
				<!-- 材料全部按批不能修改该属性
				is_batch = #{item.is_batch,jdbcType=INTEGER},
				-->
			WHERE group_id = #{item.group_id,jdbcType=INTEGER}
				 and hos_id = #{item.hos_id,jdbcType=INTEGER}
				 and copy_code = #{item.copy_code,jdbcType=VARCHAR}
				 and inv_id = #{item.inv_id,jdbcType=INTEGER}
		</foreach>
	</update>
	
	<!-- 材料删除 -->
	<delete id="delete" parameterType="java.util.Map">
		DELETE FROM mat_inv 
		WHERE group_id = #{group_id,jdbcType=INTEGER}   
			and hos_id = #{hos_id,jdbcType=INTEGER}  
			and copy_code = #{copy_code,jdbcType=VARCHAR}  
			and inv_id = #{inv_id,jdbcType=INTEGER} 
	</delete>
	
	<!-- 材料批量删除 -->
	<delete id="deleteBatch" parameterType="java.util.List">
		DELETE FROM mat_inv WHERE
			<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
				group_id = #{item.group_id,jdbcType=INTEGER}
				and hos_id = #{item.hos_id,jdbcType=INTEGER}
				and copy_code = #{item.copy_code,jdbcType=VARCHAR}
				and inv_id = #{item.inv_id,jdbcType=INTEGER}
			</foreach>
	</delete>
	
	
	<!-- 材料批量审核 -->
	<update id="auditMatInv" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			UPDATE mat_inv SET
				state = #{item.state,jdbcType=INTEGER},
				checker = #{item.checker,jdbcType=INTEGER},
				check_date = #{item.check_date,jdbcType=DATE},
				use_state = #{item.use_state,jdbcType=INTEGER}
			WHERE group_id = #{item.group_id,jdbcType=INTEGER}
				 and hos_id = #{item.hos_id,jdbcType=INTEGER}
				 and copy_code = #{item.copy_code,jdbcType=VARCHAR}
				 and inv_id = #{item.inv_id,jdbcType=INTEGER}
		</foreach>
	</update>
	
	<!-- 主页面查询 -->
	<select id="query" parameterType="java.util.Map" resultMap="matInv" >
		SELECT 
			a.group_id, a.hos_id, a.copy_code,a.memory_encoding ,a.inv_id, a.inv_code, a.inv_name, a.spell_code, 
			a.mat_type_id,b.mat_type_code,b.mat_type_name, a.inv_model,c.unit_code, c.unit_name, a.plan_price,e.fac_code, e.fac_name, 
			a.is_charge, a.is_highvalue,a.state,a.check_date, a.use_state, a.alias, a.alias_spell, 
			a.is_involved, a.is_implant, a.bid_code, mic.cert_code, mic.start_date, mic.end_date,  hsd.sup_name,
			a.is_com,mm.manage_type_name,a.checker,a.abc_type,su.user_name as checker_name,a.sell_price,a.bar_code_new,a.source_plan,a.is_sec_whg,
			mid.change_date,a.stora_tran_cond,a.charge_code,
			a.instru_type_id, mitt.instru_type_code || ' ' || mitt.instru_type_name instru_type_text
		from mat_inv a
		<!-- 2018/01/17 温州医院  如果通过证件号查询则显示证件下所有材料即可 -->
		<if test="cert_code != null and cert_code != ''">
			left join mat_prod_cert_inv micr
				on micr.group_id = a.group_id 
				and micr.hos_id = a.hos_id 
				and micr.copy_code = a.copy_code 
				and micr.inv_id = micr.inv_id 
		</if>
		<if test="cert_code == null or cert_code == ''">
		<!-- 2017/03/21 温州医院  查询条件增加证件号 证件起始日期 -->
		left join (
			<!-- 如果材料存在多个证件默认显示未停用结束日期最大的证件(对应证件全部停用也一样) -->
			<!-- 只有一种注册证状态（全部停用或者全部在用）的材料显示结束日期最大的证件 -->
			select tmp.*
			from (
				select r.group_id, r.hos_id, r.copy_code, r.inv_id, max(r.cert_id) as cert_id, m.end_date
				from mat_prod_cert_inv r
				left join mat_prod_cert m 
					on r.cert_id = m.cert_id
					and r.group_id = m.group_id
					and r.hos_id = m.hos_id
					and r.copy_code = m.copy_code 
				group by r.group_id, r.hos_id, r.copy_code, r.inv_id, m.end_date
			) tmp
			join (
				<!-- 材料的最大证件到期日期 -->
				select r2.group_id, r2.hos_id, r2.copy_code, r2.inv_id, max(m2.end_date) as end_date
				from mat_prod_cert_inv r2
				left join mat_prod_cert m2 
					on r2.cert_id = m2.cert_id
					and r2.group_id = m2.group_id
					and r2.hos_id = m2.hos_id
					and r2.copy_code = m2.copy_code 
				group by r2.group_id, r2.hos_id, r2.copy_code, r2.inv_id
			) tmp2 
				on tmp.group_id = tmp2.group_id
				and tmp.hos_id = tmp2.hos_id
				and tmp.copy_code = tmp2.copy_code
				and tmp.inv_id = tmp2.inv_id
				and (tmp.end_date = tmp2.end_date or (tmp.end_date is null and tmp2.end_date is null)) 
			join(
				select rm1.group_id, rm1.hos_id, rm1.copy_code, rm1.inv_id, count(1) con
				from (
					select r3.group_id, r3.hos_id, r3.copy_code, r3.inv_id, m3.check_state, count(1) con
					from mat_prod_cert_inv r3
					left join mat_prod_cert m3 
						on r3.cert_id = m3.cert_id
						and r3.group_id = m3.group_id
						and r3.hos_id = m3.hos_id
						and r3.copy_code = m3.copy_code 
					group by r3.group_id, r3.hos_id, r3.copy_code, r3.inv_id, r3.cert_id, m3.check_state 
				)rm1 
				group by rm1.group_id, rm1.hos_id, rm1.copy_code, rm1.inv_id
				having count(1) = 1
			)tmp3
				on tmp.group_id = tmp3.group_id
				and tmp.hos_id = tmp3.hos_id
				and tmp.copy_code = tmp3.copy_code
				and tmp.inv_id = tmp3.inv_id
			
			union all 
			      
			<!-- 存在多种注册证状态的材料显示未停用且结束日期最大的证件 -->
			select tmp4.*
			from (
				select r4.group_id, r4.hos_id, r4.copy_code, r4.inv_id, max(r4.cert_id) as cert_id, m4.end_date
				from mat_prod_cert_inv r4
				left join mat_prod_cert m4 
					on r4.cert_id = m4.cert_id
					and r4.group_id = m4.group_id
					and r4.hos_id = m4.hos_id
					and r4.copy_code = m4.copy_code 
				where m4.check_state = 2 
				group by r4.group_id, r4.hos_id, r4.copy_code, r4.inv_id, m4.end_date
			) tmp4
			join (
				<!-- 材料的最大证件到期日期 -->
				select r5.group_id, r5.hos_id, r5.copy_code, r5.inv_id, max(m5.end_date) as end_date
				from mat_prod_cert_inv r5
				left join mat_prod_cert m5 
					on r5.cert_id = m5.cert_id
					and r5.group_id = m5.group_id
					and r5.hos_id = m5.hos_id
					and r5.copy_code = m5.copy_code 
				where m5.check_state = 2 
				group by r5.group_id, r5.hos_id, r5.copy_code, r5.inv_id
			) tmp5 
				on tmp4.group_id = tmp5.group_id
				and tmp4.hos_id = tmp5.hos_id
				and tmp4.copy_code = tmp5.copy_code
				and tmp4.inv_id = tmp5.inv_id
				and (tmp4.end_date = tmp5.end_date or (tmp4.end_date is null and tmp5.end_date is null)) 
			join(
				select rm2.group_id, rm2.hos_id, rm2.copy_code, rm2.inv_id, count(1) con
				from (
					select r5.group_id, r5.hos_id, r5.copy_code, r5.inv_id, m5.check_state, count(1) con
					from mat_prod_cert_inv r5
					left join mat_prod_cert m5 
						on r5.cert_id = m5.cert_id
						and r5.group_id = m5.group_id
						and r5.hos_id = m5.hos_id
						and r5.copy_code = m5.copy_code 
					group by r5.group_id, r5.hos_id, r5.copy_code, r5.inv_id, r5.cert_id, m5.check_state 
				)rm2 
				group by rm2.group_id, rm2.hos_id, rm2.copy_code, rm2.inv_id
				having count(1) > 1
			)tmp6
				on tmp4.group_id = tmp6.group_id
				and tmp4.hos_id = tmp6.hos_id
				and tmp4.copy_code = tmp6.copy_code
				and tmp4.inv_id = tmp6.inv_id
		) micr 
		</if>
			on a.group_id = micr.group_id 
			and a.hos_id = micr.hos_id 
			and a.copy_code = micr.copy_code 
			and a.inv_id = micr.inv_id
		left join MAT_INV_DICT mid
			on a.group_id = mid.group_id
			and a.hos_id = mid.hos_id
			and a.copy_code = mid.copy_code
			and a.inv_id = mid.inv_id 
			and a.inv_code = mid.inv_code
			and mid.is_stop=0
		left join mat_instru_type mitt
			on a.group_id = mitt.group_id
			and a.hos_id = mitt.hos_id
			and a.copy_code = mitt.copy_code
			and a.instru_type_id = mitt.instru_type_id
		left  join mat_prod_cert mic 
			on micr.group_id = mic.group_id 
			and micr.hos_id = mic.hos_id 
			and micr.copy_code = mic.copy_code
			and micr.cert_id = mic.cert_id
		join mat_type_dict b
			on a.group_id = b.group_id
			and a.hos_id = b.hos_id
			and a.copy_code = b.copy_code
			and a.mat_type_id = b.mat_type_id
			and b.is_stop = 0
		<!-- 2017/03/15 台州中心医院需求:查询有物资分类权限的材料 -->
		<!-- JOIN V_USER_DATA_PERM vu 
			ON vu.group_id = b.group_id AND vu.hos_id = b.hos_id
			AND vu.user_id = #{user_id,jdbcType=INTEGER} 
			AND vu.table_code = 'MAT_TYPE_DICT' 
			AND vu.perm_code = b.mat_type_id AND vu.is_read = 1 AND vu.is_write = 1 -->
		left join hos_unit c
			on a.group_id = c.group_id
			and a.hos_id = c.hos_id
			and a.unit_code = c.unit_code
		left join sys_user su on a.group_id = su.group_id
			and a.hos_id = su.hos_id
			and a.checker = su.user_id
		left join hos_fac e
			on a.group_id = e.group_id
			and a.hos_id = e.hos_id
			and a.fac_id = e.fac_id
			<!-- and e.is_stop = 0 -->
		<if test="sup_id != null and sup_id != ''">
		inner join mat_inv_sup mis
			on a.group_id = mis.group_id
			and a.hos_id = mis.hos_id
			and a.copy_code = mis.copy_code
			and a.inv_id = mis.inv_id
			and mis.sup_id = #{sup_id,jdbcType=INTEGER}
<!-- 			20170620温州市人民医院需求 ：只查询默认供应商材料-->
			and mis.is_default = 1 
		</if>
		<if test="sup_id == null or sup_id == ''">
		left join mat_inv_sup mis
			on a.group_id = mis.group_id
			and a.hos_id = mis.hos_id
			and a.copy_code = mis.copy_code
			and a.inv_id = mis.inv_id
			and mis.is_default = 1 
		</if>
		left join hos_sup_dict hsd 
			on a.group_id = hsd.group_id 
			and a.hos_id = hsd.hos_id 
			and mis.sup_id = hsd.sup_id 
			and hsd.is_stop = 0
		left join mat_inv_mana_type mm on a.group_id=mm.group_id and a.hos_id=mm.hos_id and a.copy_code=mm.copy_code
         	and a.manage_type=mm.manage_type
		WHERE a.group_id = #{group_id,jdbcType=INTEGER}
			AND a.hos_id = #{hos_id,jdbcType=INTEGER}
			AND a.copy_code = #{copy_code,jdbcType=VARCHAR}
			  <!-- 2017/03/15 台州中心医院需求:查询有物资分类权限的材料 -->
		and b.mat_type_id in (select vu.perm_code  from  V_USER_DATA_PERM vu 
			where vu.group_id =#{group_id,jdbcType=INTEGER}  AND vu.hos_id =#{hos_id,jdbcType=INTEGER} 
			AND vu.user_id = #{user_id,jdbcType=INTEGER} 
			AND vu.table_code = 'MAT_TYPE_DICT' 
			 AND vu.is_read = 1 AND vu.is_write = 1
			)
			<if test="inv_id != null and inv_id != ''">
				AND a.inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_code != null and inv_code != ''">
				AND a.inv_code like '${inv_code}%'
			</if>
			<if test="inv_name != null and inv_name != ''">
				and (a.inv_name like '%${inv_name}%'
				     or a.alias like '%${inv_name}%'
				     or upper(a.spell_code) like '%${inv_name}%'
				     or upper(a.wbx_code) like '%${inv_name}%'
				     or upper(a.alias_spell) like '%${inv_name}%'
				     or lower(a.spell_code) like '%${inv_name}%'
				     or lower(a.wbx_code) like '%${inv_name}%'
				     or lower(a.alias_spell) like '%${inv_name}%'
				     )
			</if>
			<if test="mat_type_code != null and mat_type_code != ''">
				AND b.mat_type_code like '${mat_type_code}%'
			</if>
			<if test="fim_type_code != null and fim_type_code != ''">
				AND b.fim_type_code like '${fim_type_code}%'
			</if>
			<if test="amortize_type != null and amortize_type != ''">
				AND a.amortize_type = #{amortize_type,jdbcType=INTEGER}
			</if>
			<if test="fac_id != null and fac_id != ''">
				AND a.fac_id = #{fac_id,jdbcType=INTEGER}
			</if>
			<if test="is_highvalue != null and is_highvalue != ''">
				AND a.is_highvalue = #{is_highvalue,jdbcType=INTEGER}
			</if>
			<if test="is_charge != null and is_charge != ''">
				AND a.is_charge = #{is_charge,jdbcType=INTEGER}
			</if>
			<if test="alias != null and alias != ''">
				AND (a.alias like '%${alias}%'
					or LOWER(a.alias_spell) like '%${alias}%'
					or UPPER(a.alias_spell) like '%${alias}%'
				)
			</if>
			<if test="inv_model != null and inv_model != ''">
				and (a.inv_model like '%${inv_model}%'
				     or upper(a.spell_code) like '%${inv_model}%'
				     or upper(a.wbx_code) like '%${inv_model}%'
				     or lower(a.spell_code) like '%${inv_model}%'
				     or lower(a.wbx_code) like '%${inv_model}%'
			     )
			</if>
			<if test="is_involved != null and is_involved != '' ">
				and a.is_involved = #{is_involved,jdbcType=INTEGER}
			</if>
			<if test="is_implant != null and is_implant != '' ">
				and a.is_implant = #{is_implant,jdbcType=INTEGER}
			</if>
			<if test="is_com != null and is_com != '' ">
				and a.is_com = #{is_com,jdbcType=INTEGER}
			</if>
			<if test="bid_code != null and bid_code != '' ">
				and a.bid_code like  '%${bid_code}%' 
			</if>
			<if test="cert_code != null and cert_code != '' ">
				and mic.cert_code like '%${cert_code}%'
			</if>
			<if test="start_date != null and start_date != '' ">
				and mic.start_date &gt;= to_date(#{start_date ,jdbcType=DATE},'yyyy-MM-dd')
			</if>
			<if test="end_date != null and end_date != '' ">
				and mic.end_date &lt;= to_date(#{end_date ,jdbcType=DATE},'yyyy-MM-dd')
			</if>
			<if test="e_begin_date != null and e_begin_date != '' ">
				and a.edate &gt;= to_date(#{e_begin_date ,jdbcType=DATE},'yyyy-MM-dd')
			</if>
			<if test="e_end_date != null and e_end_date != '' ">
				and a.edate &lt;= to_date(#{e_end_date ,jdbcType=DATE},'yyyy-MM-dd')
			</if>
			<if test="use_state != null and use_state != ''"> 
				AND a.use_state = #{use_state,jdbcType=INTEGER}
			</if>
			<if test="state != null and state != '' ">
				and a.state = #{state,jdbcType=INTEGER}
			</if>
			<if test="s_begin_date != null and s_begin_date != '' ">
				and a.sdate &gt;= to_date(#{s_begin_date ,jdbcType=DATE},'yyyy-MM-dd')
			</if>
			<if test="s_end_date != null and s_end_date != '' ">
				and a.sdate &lt;= to_date(#{s_end_date ,jdbcType=DATE},'yyyy-MM-dd')
			</if>
			<if test="change_s_date != null and change_s_date != '' ">
				and mid.change_date &gt;= to_date(#{change_s_date ,jdbcType=DATE},'yyyy-MM-dd')
			</if>
			<if test="change_e_date != null and change_e_date != '' ">
				and mid.change_date &lt;= to_date(#{change_e_date ,jdbcType=DATE},'yyyy-MM-dd')
			</if>
			<if test="abc_type != null and abc_type != '' ">
				and a.abc_type = #{abc_type ,jdbcType=VARCHAR}
			</if>
			<if test="is_bar != null and is_bar != '' ">
				and a.is_bar = #{is_bar,jdbcType=INTEGER}
			</if>
			<if test="is_inv_bar != null and is_inv_bar != '' ">
				and a.is_inv_bar = #{is_inv_bar,jdbcType=INTEGER}
			</if>
			<if test="is_per_bar != null and is_per_bar != '' ">
				and a.is_per_bar = #{is_per_bar,jdbcType=INTEGER}
			</if>
			<if test="source_plan != null and source_plan != '' ">
				and a.source_plan = #{source_plan,jdbcType=INTEGER}
			</if>
			<if test="is_sec_whg != null and is_sec_whg != '' ">
				and a.is_sec_whg = #{is_sec_whg,jdbcType=INTEGER}
			</if>
		order by a.inv_code  
	</select>
	
	<!-- 一般用于修改页面数据加载 -->
	<select id="queryByCode" resultMap="matInv" parameterType="java.util.Map" >
		SELECT 
			a.group_id, a.hos_id, a.copy_code, a.inv_id, mid.inv_no, a.inv_code, a.inv_name, a.spell_code, 
			a.wbx_code, a.mat_type_id, mid.mat_type_no,b.mat_type_code,b.mat_type_name, a.inv_model, a.unit_code, c.unit_name, 
			a.amortize_type, a.price_type, a.fac_id, mid.fac_no, e.fac_code, e.fac_name, a.plan_price, 
			a.price_rate, a.sell_price,  a.sdate, a.edate, a.agent_name, a.brand_name, a.inv_usage, 
			a.inv_structure, a.per_weight, a.per_volum, a.abc_type,  a.is_single_ven, a.use_state, 
			a.is_charge, a.is_highvalue, a.is_dura, a.is_com, a.is_bar, a.is_per_bar, a.is_inv_bar, a.is_quality, a.is_disinfect, 
			a.is_cert, a.is_sec_whg, a.is_shel_make, a.note, a.is_bid, a.bid_date, a.bid_code, a.is_involved, a.is_implant, 
			a.stora_tran_cond, a.is_zero_store,a.alias,a.alias_spell, a.manage_type, a.memory_encoding, mid.source_plan, 
			mid.is_bid, mid.bid_date, mid.bid_code, f.certIds,mid.bar_code_new,mid.state, a.charge_code,
			a.instru_type_id, mitt.instru_type_code || ' ' || mitt.instru_type_name instru_type_text
		FROM mat_inv a 
		left join mat_inv_dict mid
			on a.group_id = mid.group_id
			and a.hos_id = mid.hos_id
			and a.copy_code = mid.copy_code
			and a.inv_id = mid.inv_id
			and mid.is_stop = 0
		left join mat_type_dict b
			on a.group_id = b.group_id
			and a.hos_id = b.hos_id
			and a.copy_code = b.copy_code
			and a.mat_type_id = b.mat_type_id
			and b.is_stop = 0
		left join mat_instru_type mitt
			on a.group_id = mitt.group_id
			and a.hos_id = mitt.hos_id
			and a.copy_code = mitt.copy_code
			and a.instru_type_id = mitt.instru_type_id
		left join hos_unit c
			on a.group_id = c.group_id
			and a.hos_id = c.hos_id
			and a.unit_code = c.unit_code
			and c.is_stop=0
		left join hos_fac e
			on a.group_id = e.group_id
			and a.hos_id = e.hos_id
			and a.fac_id = e.fac_id
<!-- 			and e.is_stop = 0 -->
		LEFT JOIN (
			SELECT inv_id, to_char(wm_concat(cert_id||'@'||to_char(cert_code))) certIds 
			FROM mat_prod_cert_inv 
			WHERE group_id = #{group_id,jdbcType=INTEGER} 
				AND hos_id = #{hos_id,jdbcType=INTEGER} 
				AND copy_code = #{copy_code,jdbcType=VARCHAR} 
				AND inv_id = #{inv_id,jdbcType=INTEGER} 
			GROUP BY inv_id
		) f
			ON a.inv_id = f.inv_id 
		WHERE a.group_id = #{group_id,jdbcType=INTEGER}    
			and a.hos_id = #{hos_id,jdbcType=INTEGER} 
			and a.copy_code = #{copy_code,jdbcType=VARCHAR}  
			and a.inv_id = #{inv_id,jdbcType=INTEGER} 
	</select>
	
	<!-- 用于批量修改 -->
	<select id="queryByCodes" resultMap="matInv" parameterType="java.util.Map" >
		SELECT 
			group_id, hos_id, copy_code, inv_id, inv_code, inv_name, spell_code,wbx_code, mat_type_id, 
			price_type, amortize_type, inv_model, unit_code, plan_price, price_rate, sell_price, fac_id, 
			agent_name, brand_name, inv_usage, inv_structure, sdate, edate, per_weight, per_volum, 
			abc_type, use_state, is_single_ven, is_charge, is_highvalue, is_dura, is_com, is_bar, note, is_per_bar,  
			is_inv_bar, is_quality, is_disinfect, is_cert, is_sec_whg, is_shel_make, is_batch, state, bar_code_new, 
			is_bid, bid_date, bid_code, is_involved, is_implant, stora_tran_cond, is_zero_store, alias, alias_spell,
			manage_type, memory_encoding, source_plan,bar_code_new
		FROM mat_inv
		WHERE group_id = #{group_id,jdbcType=INTEGER}    
			and hos_id = #{hos_id,jdbcType=INTEGER} 
			and copy_code = #{copy_code,jdbcType=VARCHAR}  
			and inv_id in (${inv_ids}) 
	</select>
	
	<select id="queryMatInvPrintTemlateByMainBatch" parameterType="java.util.Map" resultType="java.util.Map" >
			SELECT 
				a.group_id, a.hos_id, a.copy_code,a.memory_encoding ,a.inv_id, a.inv_code, a.inv_name, a.spell_code, 
				a.mat_type_id,b.mat_type_name, a.inv_model, c.unit_name, a.plan_price, e.fac_name, 
				a.is_charge, a.is_highvalue,a.state,a.check_date, a.use_state, a.alias, a.alias_spell, 
				a.is_involved, a.is_implant, a.bid_code, mic.cert_code, mic.start_date, mic.end_date,  hsd.sup_name
			from mat_inv a
			
		   left join (select group_id ,hos_id ,copy_code ,inv_id,max(cert_id) cert_id 
		           from mat_prod_cert_inv group by group_id ,hos_id ,copy_code ,inv_id ) micr 
            on a.inv_id = micr.inv_id 
            and a.group_id = micr.group_id 
            and a.hos_id = micr.hos_id 
            and a.copy_code = micr.copy_code
            
        left  join mat_prod_cert mic 
              on micr.cert_id = mic.cert_id
              and micr.group_id = mic.group_id 
              and micr.hos_id = mic.hos_id 
              and micr.copy_code = mic.copy_code
       join mat_type_dict b
        on a.group_id = b.group_id
        and a.hos_id = b.hos_id
        and a.copy_code = b.copy_code
        and a.mat_type_id = b.mat_type_id
        and b.is_stop = 0
   
      left join hos_unit c
        on a.group_id = c.group_id 
        and a.hos_id = c.hos_id
        and a.unit_code = c.unit_code
      left join hos_fac e
        on a.group_id = e.group_id
        and a.hos_id = e.hos_id
        and a.fac_id = e.fac_id
<!--         and e.is_stop = 0 -->
       
      left join mat_inv_sup mis
        on a.group_id = mis.group_id
        and a.hos_id = mis.hos_id
        and a.copy_code = mis.copy_code
        and a.inv_id = mis.inv_id
        and mis.is_default = 1 
       
      left join hos_sup_dict hsd 
        on a.group_id = hsd.group_id 
        and a.hos_id = hsd.hos_id 
        and mis.sup_id = hsd.sup_id 
        and hsd.is_stop = 0
		WHERE a.group_id = #{group_id,jdbcType=INTEGER}    
			and a.hos_id = #{hos_id,jdbcType=INTEGER} 
			and a.copy_code = #{copy_code,jdbcType=VARCHAR}  
			and a.inv_id in (${paraId})
			order by a.inv_code
	</select>
	
	<select id="queryByUniqueness" resultMap="matInv" parameterType="java.util.Map" >
		SELECT 
			group_id,
			hos_id,
			copy_code,
			inv_id,
			inv_code,
			inv_name,
			alias,
			spell_code,
			wbx_code,
			mat_type_id,
			inv_model,
			unit_code,
			amortize_type,
			price_type,
			fac_id,
			plan_price,
			price_rate,
			sell_price,
			is_single_ven,
			is_batch,
			is_quality,
			is_dura,
			is_sec_whg,
			is_shel_make,
			is_add_sale,
			is_bar,
			bar_code_new,
			is_cert,
			is_highvalue,
			is_com,
			is_charge,
			sdate,
			edate,
			per_weight,
			per_volum,
			brand_name,
			agent_name,
			inv_structure,
			inv_usage,
			use_state,
			note,
			alias,
			alias_spell,
			is_bid, bid_date, bid_code, is_involved, is_implant, stora_tran_cond, is_zero_store, manage_type
		FROM MAT_INV 
		<where>                     
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_code != null and inv_code != ''">
				AND inv_code = #{inv_code,jdbcType=VARCHAR}
			</if>
			<if test="inv_name != null and inv_name != ''">
				AND inv_name = #{inv_name,jdbcType=VARCHAR}
			</if>
			<if test="alias != null and alias != ''">
				AND alias = #{alias,jdbcType=VARCHAR}
			</if>
			<if test="spell_code != null and spell_code != ''">
				AND spell_code = #{spell_code,jdbcType=VARCHAR}
			</if>
			<if test="wbx_code != null and wbx_code != ''">
				AND wbx_code = #{wbx_code,jdbcType=VARCHAR}
			</if>
			<if test="mat_type_id != null and mat_type_id != ''">
				AND mat_type_id = #{mat_type_id,jdbcType=INTEGER}
			</if>
			<if test="inv_model != null and inv_model != ''">
				AND inv_model = #{inv_model,jdbcType=VARCHAR}
			</if>
			<if test="unit_code != null and unit_code != ''">
				AND unit_code = #{unit_code,jdbcType=VARCHAR}
			</if>
			<if test="amortize_type != null and amortize_type != ''">
				AND amortize_type = #{amortize_type,jdbcType=INTEGER}
			</if>
			<if test="price_type != null and price_type != ''">
				AND price_type = #{price_type,jdbcType=INTEGER}
			</if>
			<if test="fac_id != null and fac_id != ''">
				AND fac_id = #{fac_id,jdbcType=INTEGER}
			</if>
			<if test="plan_price != null and plan_price != ''">
				AND plan_price = #{plan_price,jdbcType=INTEGER}
			</if>
			<if test="price_rate != null and price_rate != ''">
				AND price_rate = #{price_rate,jdbcType=INTEGER}
			</if>
			<if test="sell_price != null and sell_price != ''">
				AND sell_price = #{sell_price,jdbcType=INTEGER}
			</if>
			<if test="is_single_ven != null and is_single_ven != ''">
				AND is_single_ven = #{is_single_ven,jdbcType=INTEGER}
			</if>
			<if test="is_batch != null and is_batch != ''">
				AND is_batch = #{is_batch,jdbcType=INTEGER}
			</if>
			<if test="is_quality != null and is_quality != ''">
				AND is_quality = #{is_quality,jdbcType=INTEGER}
			</if>
			<if test="is_dura != null and is_dura != ''">
				AND is_dura = #{is_dura,jdbcType=INTEGER}
			</if>
			<if test="stay_time != null and stay_time != ''">
				AND stay_time = #{stay_time,jdbcType=INTEGER}
			</if>
			<if test="is_overstock != null and is_overstock != ''">
				AND is_overstock = #{is_overstock,jdbcType=INTEGER}
			</if>
			<if test="is_sec_whg != null and is_sec_whg != ''">
				AND is_sec_whg = #{is_sec_whg,jdbcType=INTEGER}
			</if>
			<if test="is_shel_make != null and is_shel_make != ''">
				AND is_shel_make = #{is_shel_make,jdbcType=INTEGER}
			</if>
			<if test="is_add_sale != null and is_add_sale != ''">
				AND is_add_sale = #{is_add_sale,jdbcType=INTEGER}
			</if>
			<if test="is_bar != null and is_bar != ''">
				AND is_bar = #{is_bar,jdbcType=INTEGER}
			</if>
			<if test="bar_code_new != null and bar_code_new != ''">
				AND bar_code_new = #{bar_code_new,jdbcType=VARCHAR}
			</if>
			<if test="is_cert != null and is_cert != ''">
				AND is_cert = #{is_cert,jdbcType=INTEGER}
			</if>
			<if test="is_highvalue != null and is_highvalue != ''">
				AND is_highvalue = #{is_highvalue,jdbcType=INTEGER}
			</if>
			<if test="is_com != null and is_com != ''">
				AND is_com = #{is_com,jdbcType=INTEGER}
			</if>
			<if test="is_charge != null and is_charge != ''">
				AND is_charge = #{is_charge,jdbcType=INTEGER}
			</if>
			<if test="sdate != null and sdate != ''">
				AND sdate = #{sdate,jdbcType=DATE}
			</if>
			<if test="edate != null and edate != ''">
				AND edate = #{edate,jdbcType=DATE}
			</if>
			<if test="per_weight != null and per_weight != ''">
				AND per_weight = #{per_weight,jdbcType=INTEGER}
			</if>
			<if test="per_volum != null and per_volum != ''">
				AND per_volum = #{per_volum,jdbcType=INTEGER}
			</if>
			<if test="brand_name != null and brand_name != ''">
				AND brand_name = #{brand_name,jdbcType=VARCHAR}
			</if>
			<if test="agent_name != null and agent_name != ''">
				AND agent_name = #{agent_name,jdbcType=VARCHAR}
			</if>
			<if test="inv_structure != null and inv_structure != ''">
				AND inv_structure = #{inv_structure,jdbcType=VARCHAR}
			</if>
			<if test="inv_usage != null and inv_usage != ''">
				AND inv_usage = #{inv_usage,jdbcType=VARCHAR}
			</if>
			<if test="use_state != null and use_state != ''">
				AND use_state = #{use_state,jdbcType=INTEGER}
			</if>
			<if test="note != null and note != ''">
				AND note = #{note,jdbcType=INTEGER},
			</if>
			<if test="is_bid != null and is_bid != ''">
				AND is_bid = #{is_bid,jdbcType=INTEGER},
			</if>
			<if test="bid_date != null and bid_date != ''">
				AND bid_date = #{bid_date,jdbcType=DATE},
			</if>
			<if test="bid_code != null and bid_code != ''">
				AND bid_code = #{bid_code,jdbcType=VARCHAR},
			</if>
			<if test="is_involved != null and is_involved != ''">
				AND is_involved = #{is_involved,jdbcType=INTEGER},
			</if>
			<if test="is_implant != null and is_implant != ''">
				AND is_implant = #{is_implant,jdbcType=INTEGER},
			</if>
			<if test="stora_tran_cond != null and stora_tran_cond != ''">
				AND stora_tran_cond = #{stora_tran_cond,jdbcType=VARCHAR},
			</if>
			<if test="is_zero_store != null and is_zero_store != ''">
				AND is_zero_store = #{is_zero_store,jdbcType=INTEGER}
			</if>
			<if test="manage_type != null and manage_type != ''">
				AND manage_type = #{manage_type,jdbcType=VARCHAR}
			</if>
		</where>   
		order by inv_code
	</select>
	
	<!-- 材料供应商结果集byCode -->
	<select id="queryMatInvSupbyCode" resultType="java.util.Map" parameterType="java.util.Map" >
		select group_id,hos_id,copy_code,inv_id,sup_id
        from mat_inv_sup
        where 
         group_id = #{group_id,jdbcType=INTEGER}
         and hos_id = #{hos_id,jdbcType=INTEGER}
         and  copy_code = #{copy_code,jdbcType=VARCHAR}
         and  inv_id = #{inv_id,jdbcType=INTEGER}
         and  sup_id = #{sup_id,jdbcType=INTEGER}
	</select>
	<!-- 材料供应商结果集 -->
	<select id="queryMatInvSup" resultType="java.util.TreeMap" parameterType="java.util.Map" >
		SELECT a.sup_id, b.sup_code, b.sup_name,a.is_default
		FROM mat_inv_sup a
		LEFT JOIN hos_sup_dict b
			ON a.group_id = b.group_id
			AND a.hos_id = b.hos_id
			AND a.sup_id = b.sup_id
			AND b.is_stop = 0
		WHERE a.group_id = #{group_id,jdbcType=INTEGER}
			AND a.hos_id = #{hos_id,jdbcType=INTEGER}
			AND a.copy_code = #{copy_code,jdbcType=VARCHAR}
			AND a.inv_id = #{inv_id,jdbcType=INTEGER}
	</select>
	<!-- 供应商选择列表 -->
	<select id="queryMatInvSupList" resultType="java.util.TreeMap" parameterType="java.util.Map" >
		SELECT sup_id, sup_code, sup_name
		FROM hos_sup_dict
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND is_stop = 0
			AND NOT EXISTS(
				select 1 from mat_inv_sup 
				where group_id = #{group_id,jdbcType=INTEGER}
					and hos_id = #{hos_id,jdbcType=INTEGER}
					and copy_code = #{copy_code,jdbcType=VARCHAR}
					and inv_id = #{inv_id,jdbcType=INTEGER}
					and sup_id = hos_sup_dict.sup_id)
			<if test="key != null and key != ''">
				AND (
					sup_code like '%${key}%' or 
					sup_name like '%${key}%'
					or
					spell_code like '%${key}%' or 
					wbx_code like '%${key}%'
				)
			</if>
		order by sup_code
	</select>
	
		<!-- 供应商选择列表不查停用材料 -->
	<select id="queryMatInvSupListDisable" resultType="java.util.TreeMap" parameterType="java.util.Map" >
		SELECT sup_id, sup_code, sup_name
		FROM hos_sup_dict
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND is_stop = 0
			and is_disable=0
			AND NOT EXISTS(
				select 1 from mat_inv_sup 
				where group_id = #{group_id,jdbcType=INTEGER}
					and hos_id = #{hos_id,jdbcType=INTEGER}
					and copy_code = #{copy_code,jdbcType=VARCHAR}
					and inv_id = #{inv_id,jdbcType=INTEGER}
					and sup_id = hos_sup_dict.sup_id)
			<if test="key != null and key != ''">
				AND (
					sup_code like '%${key}%' or 
					sup_name like '%${key}%'
					or
					spell_code like '%${key}%' or 
					wbx_code like '%${key}%'
				)
			</if>
		order by sup_code
	</select>
	
	<!-- 新增供应商材料对应关系 -->
	<insert id="addMatInvSup" parameterType="java.util.List" >
		INSERT INTO MAT_INV_SUP (
			group_id, hos_id, copy_code, inv_id, sup_id,is_default
		) select t.* from(
		<foreach collection="list" item="item" index="index" separator=" union all " >
			select 	
				#{item.group_id,jdbcType=INTEGER},
				#{item.hos_id,jdbcType=INTEGER},
				#{item.copy_code,jdbcType=VARCHAR},
				#{item.inv_id,jdbcType=INTEGER},
				#{item.sup_id,jdbcType=INTEGER},
				#{item.is_default,jdbcType=INTEGER}
			from dual
		</foreach>
		)t
	</insert>
	<!-- 新增供应商材料对应关系 -->
	<delete id="deleteMatInvSup" parameterType="java.util.Map">
		DELETE FROM mat_inv_sup 
		WHERE group_id = #{group_id,jdbcType=INTEGER}   
			and hos_id = #{hos_id,jdbcType=INTEGER}  
			and copy_code = #{copy_code,jdbcType=VARCHAR}  
			and inv_id = #{inv_id,jdbcType=INTEGER} 
	</delete>
	<!-- 材料批量删除供应商材料对应关系 -->
	<delete id="deleteMatInvSupBatch" parameterType="java.util.List">
		DELETE FROM mat_inv_sup WHERE
			<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
				group_id = #{item.group_id,jdbcType=INTEGER}
				and hos_id = #{item.hos_id,jdbcType=INTEGER}
				and copy_code = #{item.copy_code,jdbcType=VARCHAR}
				and inv_id = #{item.inv_id,jdbcType=INTEGER}
			</foreach>
	</delete>
	<!-- 根据是否默认供应商删除材料供应商信息 -->
	<update id="deleteMatInvSupByDefault" parameterType="java.util.List">
		DELETE mat_inv_sup 
		WHERE
			<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
				group_id = #{item.group_id,jdbcType=INTEGER}
				and hos_id = #{item.hos_id,jdbcType=INTEGER}
				and copy_code = #{item.copy_code,jdbcType=VARCHAR}
				and inv_id = #{item.inv_id,jdbcType=INTEGER}
				and is_default = #{item.is_default,jdbcType=INTEGER}
			</foreach>
	</update>
	
	<!-- 批量修改材料供应商为非默认 -->
	<update id="updateMatInvSupIsNotDefault" parameterType="java.util.List">
		update mat_inv_sup 
			set is_default = 0  
		WHERE
			<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
				group_id = #{item.group_id,jdbcType=INTEGER}
				and hos_id = #{item.hos_id,jdbcType=INTEGER}
				and copy_code = #{item.copy_code,jdbcType=VARCHAR}
				and inv_id = #{item.inv_id,jdbcType=INTEGER}
			</foreach>
	</update>
	
	<update id="updateMatInvSupIsDefault" parameterType="java.util.List">
		update mat_inv_sup 
			set is_default = 1  
		WHERE
			<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
				group_id = #{item.group_id,jdbcType=INTEGER}
				and hos_id = #{item.hos_id,jdbcType=INTEGER}
				and copy_code = #{item.copy_code,jdbcType=VARCHAR}
				and inv_id = #{item.inv_id,jdbcType=INTEGER}
				and sup_id = #{item.sup_id,jdbcType=INTEGER}
			</foreach>
	</update>
	
	<!-- 按分类取最大材料编码 -->
	<select id="queryMatInvMaxByType"  parameterType="java.util.Map" resultType="java.lang.String" >
		select '1' || MAX(inv_code) + 1 from MAT_INV_dict 
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			and copy_code = #{copy_code,jdbcType=VARCHAR}
			AND mat_type_id = #{mat_type_id,jdbcType=INTEGER}
			and is_stop = 0
	</select>
	
	<!-- 按分类取最大材料编码 -->
	<select id="queryMatInvMaxByTypes"  parameterType="java.util.Map" resultType="java.lang.String" >
		select '1' || MAX(inv_code) + #{index,jdbcType=INTEGER} from MAT_INV_dict 
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			and copy_code = #{copy_code,jdbcType=VARCHAR}
			AND mat_type_id = #{mat_type_id,jdbcType=INTEGER}
			and is_stop = 0
	</select>
	
	<!-- 复制时 根据材料名称、规格 查询 材料是否存在 （专用SQL 不允许修改）-->
	<select id="queryMatInvExist" resultType="java.lang.Integer" parameterType="java.util.Map" >
		select count(inv_model)
        from mat_inv
        where group_id = #{group_id,jdbcType=INTEGER}
         	and hos_id = #{hos_id,jdbcType=INTEGER}
         	and  copy_code = #{copy_code,jdbcType=VARCHAR}
         	and  inv_name = #{inv_name,jdbcType=VARCHAR}
         	and  inv_model = #{inv_model,jdbcType=VARCHAR}
         	<if test="mat_type_id !=null and mat_type_id !='' ">
         		and  mat_type_id = #{mat_type_id,jdbcType=INTEGER}
	        </if>
	</select>
	
	
	<select id="queryExists" resultMap="matInv" parameterType="java.util.Map" >
		SELECT 
			group_id,
			hos_id,
			copy_code,
			inv_id,
			inv_code,
			inv_name,
			alias,
			spell_code,
			wbx_code,
			mat_type_id,
			inv_model,
			unit_code,
			amortize_type,
			price_type,
			fac_id,
			plan_price,
			price_rate,
			sell_price,
			is_single_ven,
			is_batch,
			is_quality,
			is_dura,
			is_sec_whg,
			is_shel_make,
			is_add_sale,
			is_bar,
			bar_code_new,
			is_cert,
			is_highvalue,
			is_com,
			is_charge,
			sdate,
			edate,
			per_weight,
			per_volum,
			brand_name,
			agent_name,
			inv_structure,
			inv_usage,
			use_state,
			note,
			alias,
			alias_spell,
			is_bid, bid_date, bid_code, is_involved, is_implant, stora_tran_cond, is_zero_store, manage_type
		FROM MAT_INV 
		<where>                     
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_code != null and inv_code != ''">
				AND inv_code = #{inv_code,jdbcType=VARCHAR}
			</if>
			<if test="inv_name != null and inv_name != ''">
				AND inv_name = #{inv_name,jdbcType=VARCHAR}
			</if>
			<if test="alias != null and alias != ''">
				AND alias = #{alias,jdbcType=VARCHAR}
			</if>
			<if test="spell_code != null and spell_code != ''">
				AND spell_code = #{spell_code,jdbcType=VARCHAR}
			</if>
			<if test="wbx_code != null and wbx_code != ''">
				AND wbx_code = #{wbx_code,jdbcType=VARCHAR}
			</if>
			<if test="mat_type_id != null and mat_type_id != ''">
				AND mat_type_id = #{mat_type_id,jdbcType=INTEGER}
			</if>
			<if test="inv_model != null and inv_model != ''">
				AND inv_model = #{inv_model,jdbcType=VARCHAR}
			</if>
			<if test="unit_code != null and unit_code != ''">
				AND unit_code = #{unit_code,jdbcType=VARCHAR}
			</if>
			<if test="amortize_type != null and amortize_type != ''">
				AND amortize_type = #{amortize_type,jdbcType=INTEGER}
			</if>
			<if test="price_type != null and price_type != ''">
				AND price_type = #{price_type,jdbcType=INTEGER}
			</if>
			<if test="fac_id != null and fac_id != ''">
				AND fac_id = #{fac_id,jdbcType=INTEGER}
			</if>
			<if test="plan_price != null and plan_price != ''">
				AND plan_price = #{plan_price,jdbcType=INTEGER}
			</if>
			<if test="price_rate != null and price_rate != ''">
				AND price_rate = #{price_rate,jdbcType=INTEGER}
			</if>
			<if test="sell_price != null and sell_price != ''">
				AND sell_price = #{sell_price,jdbcType=INTEGER}
			</if>
			<if test="is_single_ven != null and is_single_ven != ''">
				AND is_single_ven = #{is_single_ven,jdbcType=INTEGER}
			</if>
			<if test="is_batch != null and is_batch != ''">
				AND is_batch = #{is_batch,jdbcType=INTEGER}
			</if>
			<if test="is_quality != null and is_quality != ''">
				AND is_quality = #{is_quality,jdbcType=INTEGER}
			</if>
			<if test="is_dura != null and is_dura != ''">
				AND is_dura = #{is_dura,jdbcType=INTEGER}
			</if>
			<if test="stay_time != null and stay_time != ''">
				AND stay_time = #{stay_time,jdbcType=INTEGER}
			</if>
			<if test="is_overstock != null and is_overstock != ''">
				AND is_overstock = #{is_overstock,jdbcType=INTEGER}
			</if>
			<if test="is_sec_whg != null and is_sec_whg != ''">
				AND is_sec_whg = #{is_sec_whg,jdbcType=INTEGER}
			</if>
			<if test="is_shel_make != null and is_shel_make != ''">
				AND is_shel_make = #{is_shel_make,jdbcType=INTEGER}
			</if>
			<if test="is_add_sale != null and is_add_sale != ''">
				AND is_add_sale = #{is_add_sale,jdbcType=INTEGER}
			</if>
			<if test="is_bar != null and is_bar != ''">
				AND is_bar = #{is_bar,jdbcType=INTEGER}
			</if>
			<if test="bar_code_new != null and bar_code_new != ''">
				AND bar_code_new = #{bar_code_new,jdbcType=VARCHAR}
			</if>
			<if test="is_cert != null and is_cert != ''">
				AND is_cert = #{is_cert,jdbcType=INTEGER}
			</if>
			<if test="is_highvalue != null and is_highvalue != ''">
				AND is_highvalue = #{is_highvalue,jdbcType=INTEGER}
			</if>
			<if test="is_com != null and is_com != ''">
				AND is_com = #{is_com,jdbcType=INTEGER}
			</if>
			<if test="is_charge != null and is_charge != ''">
				AND is_charge = #{is_charge,jdbcType=INTEGER}
			</if>
			<if test="sdate != null and sdate != ''">
				AND sdate = #{sdate,jdbcType=DATE}
			</if>
			<if test="edate != null and edate != ''">
				AND edate = #{edate,jdbcType=DATE}
			</if>
			<if test="per_weight != null and per_weight != ''">
				AND per_weight = #{per_weight,jdbcType=INTEGER}
			</if>
			<if test="per_volum != null and per_volum != ''">
				AND per_volum = #{per_volum,jdbcType=INTEGER}
			</if>
			<if test="brand_name != null and brand_name != ''">
				AND brand_name = #{brand_name,jdbcType=VARCHAR}
			</if>
			<if test="agent_name != null and agent_name != ''">
				AND agent_name = #{agent_name,jdbcType=VARCHAR}
			</if>
			<if test="inv_structure != null and inv_structure != ''">
				AND inv_structure = #{inv_structure,jdbcType=VARCHAR}
			</if>
			<if test="inv_usage != null and inv_usage != ''">
				AND inv_usage = #{inv_usage,jdbcType=VARCHAR}
			</if>
			<if test="use_state != null and use_state != ''">
				AND use_state = #{use_state,jdbcType=INTEGER}
			</if>
			<if test="note != null and note != ''">
				AND note = #{note,jdbcType=INTEGER},
			</if>
			<if test="is_bid != null and is_bid != ''">
				AND is_bid = #{is_bid,jdbcType=INTEGER},
			</if>
			<if test="bid_date != null and bid_date != ''">
				AND bid_date = #{bid_date,jdbcType=DATE},
			</if>
			<if test="bid_code != null and bid_code != ''">
				AND bid_code = #{bid_code,jdbcType=VARCHAR},
			</if>
			<if test="is_involved != null and is_involved != ''">
				AND is_involved = #{is_involved,jdbcType=INTEGER},
			</if>
			<if test="is_implant != null and is_implant != ''">
				AND is_implant = #{is_implant,jdbcType=INTEGER},
			</if>
			<if test="stora_tran_cond != null and stora_tran_cond != ''">
				AND stora_tran_cond = #{stora_tran_cond,jdbcType=VARCHAR},
			</if>
			<if test="is_zero_store != null and is_zero_store != ''">
				AND is_zero_store = #{is_zero_store,jdbcType=INTEGER}
			</if>
			<if test="manage_type != null and manage_type != ''">
				AND manage_type = #{manage_type,jdbcType=VARCHAR}
			</if>
		</where>   
		order by inv_code
	</select>
	
	<select id="queryMatInvCertInfo" parameterType="java.util.Map" resultMap="invCert" >
		select b.group_id, b.hos_id, b.copy_code, b.cert_id, b.cert_code, b.prod_name, b.cert_type_code, 
			d.cert_type_name, b.fac_id, b.cert_date, b.start_date, b.end_date, b.is_stop, c.fac_code, c.fac_name
		from mat_prod_cert_inv a
		left join mat_prod_cert b 
			on 
				a.group_id = b.group_id 
				and a.hos_id =b.hos_id
				and a.copy_code =b.copy_code
		     	and a.cert_id = b.cert_id
		left join hos_fac c 
			on b.group_id = c.group_id 
				and b.hos_id = c.hos_id 
				and b.fac_id = c.fac_id
<!-- 		     	and c.is_stop =0 -->
		left join MAT_CERT_TYPE d 
			on 
				b.group_id = d.group_id 
				and b.hos_id = d.hos_id 
				and b.cert_type_code = d.cert_type_code
		<where>                     
			<if test="group_id != null and group_id != ''">
				AND a.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND a.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND a.copy_code = #{copy_code}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND a.inv_id = #{inv_id}
			</if>
		</where>
		order by b.cert_code asc
	</select>
	
	<!-- 材料改变物资类别查询改类别材料数 -->
	<select id="queryChangeMatTypeCode" parameterType="java.util.Map" resultMap="invCert">
		select count(mid.inv_code) as inv_count, max(mid.inv_code) as inv_code
		  from MAT_TYPE_DICT mtd
		  left join MAT_INV_DICT mid
		    on mtd.group_id = mid.group_id
		   and mtd.hos_id = mid.hos_id
		   and mtd.copy_code = mid.copy_code
		   and mtd.mat_type_id = mid.mat_type_id
		 where mtd.group_id = #{group_id,jdbcType=INTEGER}
		   and mtd.hos_id =  #{hos_id,jdbcType=INTEGER}
		   and mtd.copy_code = #{copy_code,jdbcType=VARCHAR}
		   and mtd.mat_type_id = #{mat_type_id,jdbcType=INTEGER}
		   and mid.is_stop = 0
	</select>
	
	<!-- 停用物资材料验证材料库存 -->
	<select id="queryStopTimeByCode" parameterType="java.util.Map" resultMap="invCert">
		select sum(mih.inv_id) as inv_id,mih.cur_amount as cur_amount
			  from ${table} mih
			 where mih.group_id = #{group_id}
			  and mih.hos_id = #{hos_id}
			  and mih.copy_code = #{copy_code}
			  and mih.inv_id = #{inv_id}
			  group by mih.cur_amount 
	</select>
	
	<select id="queryMatInvSupCode" resultType="java.lang.Integer" parameterType="java.util.Map" >
		select 
		 count(1) 
        from MAT_INV_SUP
        where 
         group_id = #{group_id,jdbcType=INTEGER}
         and hos_id = #{hos_id,jdbcType=INTEGER}
         and  copy_code = #{copy_code,jdbcType=VARCHAR}
         and  inv_id = #{inv_id,jdbcType=INTEGER}
         and  sup_id = #{sup_id,jdbcType=INTEGER}
	</select>
	
	<!-- 根据 证件信息 查询 对应的 供应商信息  -->
	<select id="queryCertSup" resultMap="certSupMap" parameterType="java.util.Map" >
		select 
		mcs.sup_id ,
		hsd.sup_code ,
		hsd.sup_name ,
		mcs.fac_id
        from mat_prod_cert mcs
        left join hos_sup_dict hsd
        	on
        		mcs.group_id  = hsd.group_id
        		and mcs.hos_id  = hsd.hos_id
        		and mcs.sup_id = hsd.sup_id
        		and hsd.is_stop = 0 
        where 
         mcs.group_id = #{group_id,jdbcType=INTEGER}
         and mcs.hos_id = #{hos_id,jdbcType=INTEGER}
         and  mcs.copy_code = #{copy_code,jdbcType=VARCHAR}
         and  mcs.cert_id = #{cert_id,jdbcType=INTEGER}
	</select>
	
	<!-- 生产厂商的字典 -->
	<select id="queryHosFacDict" resultMap="facMap">
		SELECT
			fac_id ,
			fac_code||' '||fac_name as fac_name
		FROM HOS_FAC
		<where>
			<if test="group_id != null  and group_id != ''">
				and group_id = #{group_id}
			</if>
			<if test="hos_id != null  and hos_id != ''">
				and hos_id = #{hos_id}
			</if>
			<if test="fac_id != null  and fac_id != ''">
				and fac_id = #{fac_id}
			</if>
<!-- 			and is_stop = 0 -->
			<if test="key != null and key != ''">
				and (
				fac_code like '${key}%' or 
				fac_name like '%${key}%'
				or
				spell_code like '%${key}%' 
				or wbx_code like '%${key}%'
				)
			</if>
		</where>
		order by fac_code
	</select>
	
	<!-- 导入过程中获取已插入的材料ID  -->
	<select id="getInvIdByImp"  parameterType="java.util.Map" resultType="java.lang.String" >
		SELECT inv_id
		FROM MAT_INV 
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			and copy_code = #{copy_code,jdbcType=VARCHAR}
			AND inv_name = #{inv_name,jdbcType=VARCHAR}
			AND inv_model = #{inv_model,jdbcType=VARCHAR}
			<if test="fac_id!=null and fac_id!=''">
				AND fac_id = #{fac_id,jdbcType=INTEGER}
			</if>
			<if test="fac_id==null or fac_id==''">
				AND fac_id is null
			</if>
			AND rownum = 1
	</select>
	
	
	<select id="queryMatInvInSup" parameterType="java.util.List" resultType="java.util.Map">
		with inv_list as (
			<foreach collection="list" item="item" index="index" separator=" union all " >
				select    
					#{item.group_id,jdbcType=INTEGER} as group_id, 
					#{item.hos_id,jdbcType=INTEGER} as hos_id, 
					#{item.copy_code,jdbcType=VARCHAR} as copy_code,
					#{item.inv_id,jdbcType=VARCHAR} as inv_id,
					#{item.sup_id,jdbcType=VARCHAR} as sup_id
				from dual
			</foreach>
		)
		select group_id,hos_id,copy_code,inv_id,sup_id
		from inv_list 
		where inv_id in (
		    select distinct a.inv_id 
			from inv_list a
			join mat_inv_sup b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
				and a.sup_id=b.sup_id and a.inv_id=b.inv_id and b.is_default=0
		)
	</select>
	
	<select id="queryMatInvNotInSup" parameterType="java.util.List" resultType="java.util.Map">
		with inv_list as (
			<foreach collection="list" item="item" index="index" separator=" union all " >
				select    
					#{item.group_id,jdbcType=INTEGER} as group_id, 
					#{item.hos_id,jdbcType=INTEGER} as hos_id, 
					#{item.copy_code,jdbcType=VARCHAR} as copy_code,
					#{item.inv_id,jdbcType=VARCHAR} as inv_id,
					#{item.sup_id,jdbcType=VARCHAR} as sup_id
				from dual
			</foreach>
		)
		select group_id,hos_id,copy_code,inv_id,sup_id
		from inv_list 
		where inv_id not in (
		      select distinct a.inv_id 
		      from inv_list a
		      join mat_inv_sup b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
		      	and a.sup_id=b.sup_id and a.inv_id=b.inv_id
		)
	</select>
	
	
	
	
	
	<!-- 台州接口:HRP_MAT_INV表为HRP提供给HIS的材料中间表,用于材料变更时,更改材料的现行状态-->
	
	<select id="queryTableIsExit" parameterType="java.util.Map" resultType="Integer">
		SELECT 
			count(1) 
		FROM USER_TABLES 
		WHERE 
			table_name = #{table_name}
	</select>
	
	
	<!-- 查询HRP_MAT_INV表中,材料是否存在  -->
	<select id="queryHrpMatInvByCode" parameterType="java.util.Map" resultMap="hrpMatInvMap">
		SELECT
			INV_ID          ,
			INV_NAME        ,
			INV_MODEL       ,
			UNIT_NAME       ,
			PLAN_PRICE      ,
			SALE_PRICE      ,
			FACTORY_NAME    ,
			CERT_CODE       ,
			INV_STATE
		FROM HRP_MAT_INV
		WHERE
			inv_id = #{inv_id}
	</select>
	
	<!-- 更新HRP_MAT_INV材料,及状态 -->
	<update id="updateHrpMatInv" parameterType="java.util.Map">
		UPDATE HRP_MAT_INV SET
			INV_NAME = #{inv_name}       ,
			INV_MODEL = #{inv_model}       ,
			UNIT_NAME = #{unit_name}       ,
			PLAN_PRICE = #{plan_price}      ,
			SALE_PRICE = #{sale_price}      ,
			FACTORY_NAME = #{factory_name}    ,
			CERT_CODE = #{cert_code}       ,
			INV_STATE = #{inv_state} 
		WHERE
			INV_ID = #{inv_id}
	</update>
	
	<!-- 新增HRP_MAT_INV材料信息 -->
	<insert id="addHrpMatInv" parameterType="java.util.Map">
		INSERT INTO HRP_MAT_INV(
			INV_ID          ,
			INV_NAME        ,
			INV_MODEL       ,
			UNIT_NAME       ,
			PLAN_PRICE      ,
			SALE_PRICE      ,
			FACTORY_NAME    ,
			CERT_CODE       ,
			INV_STATE
		) VALUES(
			#{inv_id}        ,
			#{inv_name}       ,
			#{inv_model}       ,
			#{unit_name}       ,
			#{plan_price,jdbcType=VARCHAR}      ,
			#{sale_price,jdbcType=VARCHAR}      ,
			#{factory_name}    ,
			#{cert_code}       ,
			#{inv_state}
		)
	</insert>
	
	<resultMap type="map" id="dictMatInvMap">
		<result property="change_id" column="change_id"/>
		<result property="inv_code" column="inv_code"/>
		<result property="inv_name" column="inv_name"/>
		<result property="mat_type_code" column="mat_type_code"/>
		<result property="mat_type_name" column="mat_type_name"/>
		<result property="inv_model" column="inv_model"/>
		<result property="unit_code" column="unit_code"/>
		<result property="unit_name" column="unit_name"/>
		<result property="fac_code" column="fac_code"/>
		<result property="fac_name" column="fac_name"/>
		<result property="plan_price" column="plan_price"/>
		<result property="sell_price" column="sell_price"/>
		<result property="is_charge" column="is_charge"/>
		<result property="is_highvalue" column="is_highvalue"/>
		<result property="change_date" column="change_date"/>
		<result property="change_state" column="change_state"/>
	</resultMap>
	<!-- 查询DICT_MAT_INV表中,材料是否存在  -->
	<select id="queryDictMatInvByCode" parameterType="java.util.Map" resultMap="dictMatInvMap">
		SELECT
			change_id,
			inv_code,
			inv_name,
			mat_type_code,
			mat_type_name,
			inv_model,
			unit_code,
			unit_name,
			fac_code,
			fac_name,
			plan_price,
			sell_price,
			is_charge,
			is_highvalue,
			change_date,
			change_state
		FROM DICT_MAT_INV
		WHERE
			inv_code = #{inv_id}
	</select>
	
	<!-- 更新DICT_MAT_INV材料,及状态 -->
	<update id="updateDictMatInv" parameterType="java.util.Map">
		UPDATE DICT_MAT_INV SET
			inv_name = #{inv_name,jdbcType=VARCHAR},
			mat_type_code = #{mat_type_code,jdbcType=VARCHAR},
			mat_type_name = #{mat_type_name,jdbcType=VARCHAR},
			inv_model = #{inv_model,jdbcType=VARCHAR},
			unit_code = #{unit_code,jdbcType=VARCHAR},
			unit_name = #{unit_name,jdbcType=VARCHAR},
			fac_code = #{fac_code,jdbcType=VARCHAR},
			fac_name = #{fac_name,jdbcType=VARCHAR},
			plan_price = #{plan_price,jdbcType=INTEGER},
			sell_price = #{sell_price,jdbcType=INTEGER},
			is_charge = #{is_charge,jdbcType=INTEGER},
			is_highvalue = #{is_highvalue,jdbcType=INTEGER},
			change_date = #{change_date,jdbcType=DATE},
			change_state = #{change_state,jdbcType=INTEGER}
		WHERE
			inv_code = #{inv_id}
	</update>
	
	<!-- 新增DICT_MAT_INV材料信息 -->
	<insert id="addDictMatInv" parameterType="java.util.Map">
		<selectKey keyProperty="change_id" order="BEFORE" resultType="int">
			select DICT_MAT_INV_SEQ.nextval from dual
		</selectKey>
		INSERT INTO DICT_MAT_INV(
			change_id,
			inv_code,
			inv_name,
			mat_type_code,
			mat_type_name,
			inv_model,
			unit_code,
			unit_name,
			fac_code,
			fac_name,
			plan_price,
			sell_price,
			is_charge,
			is_highvalue,
			change_date,
			change_state
		) VALUES(
			#{change_id,jdbcType=INTEGER},
			#{inv_id,jdbcType=VARCHAR},
			#{inv_name,jdbcType=VARCHAR},
			#{mat_type_code,jdbcType=VARCHAR},
			#{mat_type_name,jdbcType=VARCHAR},
			#{inv_model,jdbcType=VARCHAR},
			#{unit_code,jdbcType=VARCHAR},
			#{unit_name,jdbcType=VARCHAR},
			#{fac_code,jdbcType=VARCHAR},
			#{fac_name,jdbcType=VARCHAR},
			#{plan_price,jdbcType=INTEGER},
			#{sell_price,jdbcType=INTEGER},
			#{is_charge,jdbcType=INTEGER},
			#{is_highvalue,jdbcType=INTEGER},
			#{change_date,jdbcType=DATE},
			#{change_state,jdbcType=INTEGER}
		)
	</insert>
	
	<update id="updateBatchHrpMatInvState" parameterType="java.util.List">
		<foreach collection="list" index="index" item="item" open="begin" separator=";" close=";end;">
			UPDATE HRP_MAT_INV SET
				INV_STATE = '3'
			WHERE
				INV_ID = #{item.inv_id}
		</foreach>
	</update>
	
	<select id="queryMatInvSupDefault" parameterType="java.util.Map" resultType="java.util.Map">
		
		select a.group_id,a.hos_id,a.sup_id,a.sup_no,a.sup_code,a.sup_name
		from hos_sup_dict a
		left join mat_inv_sup b on a.group_id=b.group_id and a.hos_id=b.hos_id
		     and a.sup_id=b.sup_id
		<where>
			<if test="group_id != null and group_id !='' ">
				and b.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id !='' ">
				and b.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code !='' ">
				and b.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="inv_id != null and inv_id !='' ">
				and b.inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			and a.is_stop = 0
			and b.is_default = 1
		</where>
		
	</select>
	
	
	<!-- 查询材料用于导入 -->
	<select id="queryMatInvListForImport" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT inv_id, inv_code, inv_name, inv_model, unit_code, nvl(plan_price,0) plan_price
		FROM mat_inv
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
	</select>
	
	<!-- 查询材料分类用于导入 -->
	<select id="queryMatTypeListForImport" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT mat_type_id, mat_type_no, mat_type_code, mat_type_name
		FROM mat_type_dict
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			AND is_stop = 0
	</select>
	
	<!-- 查询计量单位用于导入 -->
	<select id="queryHosUnitListForImport" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT unit_code, unit_name
		FROM hos_unit
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND is_stop = 0
	</select>
	
	<!-- 查询生产厂商用于导入 -->
	<select id="queryHosFacListForImport" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT fac_id, fac_no, fac_code, fac_name
		FROM hos_fac_dict
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND is_stop = 0
	</select>
	
	<!-- 查询供应商用于导入 -->
	<select id="queryHosSupListForImport" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT sup_id, sup_no, sup_code, sup_name
		FROM hos_sup_dict
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND is_stop = 0
	</select>
	
	<!-- 查询管理类别用于导入 -->
	<select id="queryManaTypeListForImport" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT manage_type, manage_type_name
		FROM mat_inv_mana_type
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
	</select>
	
	<select id="getMaxInvCodeByType" resultType="java.util.Map" parameterType="java.util.Map">
		SELECT max(a.inv_code) inv_code, b.mat_type_code
		FROM mat_inv a 
		LEFT JOIN mat_type b 
			ON a.group_id = b.group_id 
			AND a.hos_id = b.hos_id 
			AND a.copy_code = b.copy_code 
			AND a.mat_type_id = b.mat_type_id 
		WHERE a.group_id = #{group_id,jdbcType=INTEGER}
			AND a.hos_id = #{hos_id,jdbcType=INTEGER}
			AND a.copy_code = #{copy_code,jdbcType=VARCHAR}
			AND a.mat_type_id = #{mat_type_id,jdbcType=INTEGER}
		GROUP BY b.mat_type_code
	</select>
</mapper>

