<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.mat.dao.affi.in.MatAffiInCommonMapper">
	
	<!-- 代销入库主表 -->
	<resultMap id="matAffiInMain" type="java.util.Map">
		<result property="group_id" column="group_id"/>
		<result property="hos_id" column="hos_id"/> 
		<result property="copy_code" column="copy_code"/>
		<result property="in_id" column="in_id"/>
		<result property="in_no" column="in_no"/>
		<result property="year" column="year"/>
		<result property="month" column="month"/>
		<result property="brief" column="brief"/> 
		<result property="bus_type_code" column="bus_type_code"/>
		<result property="bus_type_name" column="bus_type_name"/>
		<result property="sup_no" column="sup_no"/>
		<result property="sup_id" column="sup_id"/>
		<result property="sup_name" column="sup_name"/>
		<result property="store_id" column="store_id"/>
		<result property="store_no" column="store_no"/>
		<result property="store_name" column="store_name"/>
		<result property="dept_id" column="dept_id"/>
		<result property="dept_no" column="dept_no"/>
		<result property="dept_name" column="dept_name"/>
		<result property="stocker" column="stocker"/>
		<result property="stock_type_code" column="stock_type_code"/>
		<result property="stock_type_name" column="stock_type_name"/>
		<result property="is_org" column="is_org"/>
		<result property="in_date" column="in_date"/>
		<result property="maker" column="maker"/>
		<result property="maker_name" column="maker_name"/>
		<result property="make_date" column="make_date"/>
		<result property="checker" column="checker"/>
		<result property="checker_name" column="checker_name"/>
		<result property="check_date" column="check_date"/>
		<result property="confirmer" column="confirmer"/>
		<result property="confirmer_name" column="confirmer_name"/>
		<result property="confirm_date" column="confirm_date"/>
		<result property="state" column="state"/>
		<result property="state_name" column="state_name"/>
		<result property="is_pay" column="is_pay"/>
		<result property="amount_money" column="amount_money"/>
		<result property="proj_id" column="proj_id"/>
		<result property="proj_code" column="proj_code"/>
		<result property="proj_name" column="proj_name"/>
		<result property="protocol_id" column="protocol_id"/>
		<result property="protocol_code" column="protocol_code"/>
		<result property="protocol_name" column="protocol_name"/>
		
		<result property="come_from" column="come_from" />
		<result property="delivery_code" column="delivery_code"/>
		<result property="examiner" column="examiner"/>
		<result property="examiner_code" column="examiner_code"/>
		<result property="examiner_name" column="examiner_name"/>
		<result property="come_from" column="come_from"/>
		<result property="field_desc" column="field_desc"/>
	</resultMap>
	
	<!-- 代销入库明细表 -->
	<resultMap id="matAffiInDetail" type="java.util.Map">
		<result property="group_id" column="group_id"/>
		<result property="hos_id" column="hos_id"/>
		<result property="copy_code" column="copy_code"/>
		<result property="in_id" column="in_id"/>
		<result property="detail_id" column="detail_id"/>
		<result property="inv_id" column="inv_id"/>
		<result property="inv_no" column="inv_no"/>
		<result property="inv_code" column="inv_code"/>
		<result property="inv_name" column="inv_name"/>
		<result property="inv_model" column="inv_model"/>
		<result property="unit_code" column="unit_code"/>
		<result property="unit_name" column="unit_name"/>
		<result property="batch_no" column="batch_no"/>
		<result property="batch_sn" column="batch_sn"/>
		<result property="price" column="price"/>
		<result property="amount" column="amount"/>
		<result property="amount_money" column="amount_money"/>
		<result property="sell_price" column="sell_price"/>
		<result property="sell_money" column="sell_money"/>
		<result property="sale_price" column="sale_price"/>
		<result property="sale_money" column="sale_money"/>
		<result property="allot_price" column="allot_price"/>
		<result property="allot_money" column="allot_money"/>
		<result property="pack_code" column="pack_code"/>
		<result property="pack_name" column="pack_name"/>
		<result property="num_exchange" column="num_exchange"/>
		<result property="pack_price" column="pack_price"/>
		<result property="num" column="num"/>
		<result property="sn" column="sn"/>
		<result property="is_per_bar" column="is_per_bar"/>
		<result property="bar_code" column="bar_code"/>
		<result property="inva_date" column="inva_date"/>
		<result property="disinfect_date" column="disinfect_date"/>
		<result property="disinfect_no" column="disinfect_no"/>
		<result property="location_id" column="location_id"/>
		<result property="location_code" column="location_code"/>
		<result property="location_name" column="location_name"/>
		<result property="order_rela" column="order_rela"/>
		<result property="note" column="note"/>
		<result property="is_highvalue" column="is_highvalue"/>
		<result property="is_batch" column="is_batch"/>
		<result property="is_bar" column="is_bar"/>
		<result property="is_quality" column="is_quality"/>
		<result property="is_single_ven" column="is_single_ven"/>
		<result property="is_disinfect" column="is_disinfect"/>
		<result property="in_amount" column="in_amount"/>
		<result property="out_amount" column="out_amount"/>
		<result property="sup_id" column="sup_id"/>
			<result property="state_name" column="state_name"/>
	</resultMap>
	
	<!-- 订单表返回信息 -->
	<resultMap id="matMatOrder" type="java.util.Map">
		<result property="group_id" column="group_id"/>
		<result property="hos_id" column="hos_id"/>
		<result property="copy_code" column="copy_code"/>
		<result property="order_id" column="order_id"/>
		<result property="order_code" column="order_code"/>
		<result property="order_date" column="order_date"/>
		<result property="pur_type" column="pur_type"/>
		<result property="pur_type_name" column="pur_type_name"/>
		<result property="order_type" column="order_type"/>
		<result property="order_type_name" column="order_type_name"/>
		<result property="brif" column="brif"/>
		<result property="sup_id" column="sup_id"/>
		<result property="sup_no" column="sup_no"/>
		<result property="sup_name" column="sup_name"/>
		<result property="dept_id" column="dept_id"/>
		<result property="dept_no" column="dept_no"/>
		<result property="dept_name" column="dept_name"/>
		<result property="stocker" column="stocker"/>
		<result property="stocker_name" column="stocker_name"/>
		<result property="pur_hos_id" column="pur_hos_id"/>
		<result property="pur_hos_name" column="pur_hos_name"/>
		<result property="take_hos_id" column="take_hos_id"/>
		<result property="take_hos_name" column="take_hos_name"/>
		<result property="pay_hos_id" column="pay_hos_id"/>
		<result property="pay_hos_name" column="pay_hos_name"/>
		<result property="stock_type_code" column="stock_type_code"/>
		<result property="stock_type_name" column="stock_type_name"/>
		<result property="pay_code" column="pay_code"/>
		<result property="pay_name" column="pay_name"/>
		<result property="arr_address" column="arr_address"/>
		<result property="maker" column="maker"/>
		<result property="maker_name" column="maker_name"/>
		<result property="make_date" column="make_date"/>
		<result property="checker" column="checker"/>
		<result property="checker_name" column="checker_name"/>
		<result property="check_date" column="check_date"/>
		<result property="state" column="state"/>
		<result property="state_name" column="state_name"/>
		<result property="is_notice" column="is_notice"/>
		<result property="notice_date" column="notice_date"/>
		<result property="note" column="note"/>
		
		<result property="inv_id" column="inv_id"/>
		<result property="inv_no" column="inv_no"/>
		<result property="inv_code" column="inv_code"/>
		<result property="inv_name" column="inv_name"/>
		<result property="inv_model" column="inv_model"/>
		<result property="unit_code" column="unit_code"/>
		<result property="unit_name" column="unit_name"/>
		<result property="pack_code" column="pack_code"/>
		<result property="pack_name" column="pack_name"/>
		<result property="amount" column="amount"/>
		<result property="price" column="price"/>
		<result property="amount_money" column="amount_money"/>
		<result property="num" column="num"/>	
		<result property="num_exchange" column="num_exchange"/>
		<result property="arrive_date" column="arrive_date"/>
		<result property="memo" column="memo"/>
		
		<result property="order_id_new" column="order_id_new"/>
		<result property="order_rela" column="order_rela"/>
		
	</resultMap>
	
	<!-- 审核 代销入库主表 -->
	<update id="auditMatAffiInCommon" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			UPDATE mat_affi_in 
			SET  state = 2,
				checker = #{item.user_id},
				check_date = SYSDATE
			WHERE	group_id =	#{item.group_id,jdbcType=INTEGER}
				and	hos_id = #{item.hos_id,jdbcType=INTEGER}
				and	copy_code = #{item.copy_code,jdbcType=VARCHAR}
				and	in_id =#{item.in_id,jdbcType=INTEGER}
				
		</foreach>
	</update>
	
	<!-- 取消审核 代销入库主表 -->
	<update id="unAuditMatAffiInCommon" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			UPDATE mat_affi_in 
			SET  state = 1,
				checker = '',
				check_date = ''
			WHERE	group_id =	#{item.group_id,jdbcType=INTEGER}
				and	hos_id = #{item.hos_id,jdbcType=INTEGER}
				and	copy_code = #{item.copy_code,jdbcType=VARCHAR}
				and	in_id =#{item.in_id,jdbcType=INTEGER}
				
		</foreach>
	</update>
	
	<!-- 代销材料入库确认 -->
	<select id="confirmAffiIn" statementType="CALLABLE" parameterType="java.util.Map" resultType="java.lang.String">
		<![CDATA[
			{call mat_affi_in_confirm(
				#{group_id,jdbcType=INTEGER}, 
				#{hos_id,jdbcType=INTEGER}, 
				#{copy_code,jdbcType=VARCHAR}, 
				#{user_id,jdbcType=INTEGER}, 
				#{in_ids,jdbcType=VARCHAR}, 
				#{confirm_date,jdbcType=VARCHAR}, 
				#{msg, mode=OUT, jdbcType=VARCHAR}
			)}
		]]>
	</select>
	
	<!-- 代销入库主查询  -->
	<select id="query" parameterType="java.util.Map" resultMap="matAffiInMain" >
		SELECT temp.* from (
			SELECT 
				null group_id,null hos_id,null copy_code,null in_id,to_char('合计') in_no
		        ,null brief,null store_id,null store_no,null store_name,null bus_type_code
		        ,null bus_type_name,null sup_name,null stocker, SUM(b.amount_money) AS amount_money,null in_date
		        ,null maker_name,null checker_name,null confirm_date,null confirmer_name,null state,null as state_name
		        ,null app_dept,null protocol_code,null proj_id,
		        null come_from, null field_desc, null delivery_code,null examiner,null examiner_code,null examiner_name
	      FROM MAT_AFFI_IN a
	      LEFT JOIN MAT_AFFI_IN_DETAIL b 
	      ON 
	      	a.group_id = b.group_id	AND a.hos_id = b.hos_id
	      	AND a.copy_code = b.copy_code AND a.in_id = b.in_id
	      <where>
			<if test="group_id != null and group_id != ''">
				 a.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and a.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND a.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="in_dateB != null and in_dateB != ''">
				AND a.in_date &gt;= to_date(#{in_dateB},'yyyy-MM-dd')
			</if>
			<if test="in_dateE != null and in_dateE != ''">
				AND a.in_date &lt;= to_date(#{in_dateE},'yyyy-MM-dd')
			</if>
			<if test="confirm_dateB != null and confirm_dateB != ''">
				AND a.confirm_date &gt;= to_date(#{confirm_dateB},'yyyy-MM-dd')
			</if> 
			<if test="confirm_dateE != null and confirm_dateE != ''">
				AND a.confirm_date &lt;= to_date(#{confirm_dateE},'yyyy-MM-dd')
			</if>
			<if test="store_id != null and store_id != ''">
				AND a.store_id = #{store_id,jdbcType=INTEGER}
			</if>
			<if test="sup_id != null and sup_id != ''">
				AND a.sup_id = #{sup_id,jdbcType=INTEGER}
			</if>
			<if test="bus_type_code != null and bus_type_code != ''">
				AND a.bus_type_code = #{bus_type_code,jdbcType=INTEGER}
			</if>
			<if test="state != null and state != ''">
				AND a.state = #{state,jdbcType=INTEGER}
			</if>
			<if test="in_no != null and in_no != ''">
				AND a.in_no like  #{in_no}||'%'
			</if>
			<if test="maker != null and maker != ''">
				AND a.maker =  #{maker}
			</if>
			<!-- 添加用户数据权限 -->
			and exists (
				select 1 from v_user_data_perm vudp 
				where a.group_id=vudp.group_id and a.hos_id=vudp.hos_id 
					and a.store_id=vudp.perm_code and vudp.is_read=1 and vudp.is_write = 1
	      			and vudp.table_code='HOS_STORE_DICT'
					and vudp.user_id=#{user_id}
			)
		</where>  
	    UNION ALL  
		SELECT 
			a.group_id,a.hos_id,a.copy_code,a.in_id,to_char(a.in_no) in_no,a.brief,a.store_id, 
			a.store_no,c.store_name,a.bus_type_code,d.bus_type_name,h.sup_name, 
			he.emp_name  stocker,sum(b.amount_money) as amount_money,a.in_date, 
			e.user_name as maker_name,aa.user_name checker_name,a.confirm_date,
			f.user_name as confirmer_name,a.state,
			  case when a.state = 1 then '未审核'
				when a.state = 2 then '已审核'
				when a.state = '' then ''
			  else '已入库' end state_name,
			a.app_dept,a.protocol_code,a.proj_id,
			a.come_from, m.field_desc, a.delivery_code,a.examiner,hd.emp_code examiner_code,hd.emp_name examiner_name
		FROM MAT_AFFI_IN a
		LEFT JOIN MAT_AFFI_IN_DETAIL b  on a.group_id = b.group_id
			and a.hos_id = b.hos_id
			and a.copy_code = b.copy_code
			and a.in_id = b.in_id
		LEFT JOIN hos_store_dict c on a.group_id = c.group_id
			and a.hos_id = c.hos_id
			and a.store_id = c.store_id
			<if test="show_history == 1">
				and a.store_no = c.store_no
			</if>
			<if test="show_history == 0">
				and c.is_stop = 0
			</if>
		LEFT JOIN mat_bus_type d on a.bus_type_code = d.bus_type_code
			and d.is_stop = 0
		LEFT JOIN sys_user e on a.group_id = e.group_id
			and a.hos_id = e.hos_id
			and a.maker = e.user_id
		LEFT JOIN sys_user f on a.group_id = f.group_id
			and a.hos_id = f.hos_id
			and a.confirmer = f.user_id
		LEFT JOIN hos_sup_dict h on a.group_id = h.group_id
			and a.hos_id = h.hos_id
			and a.sup_id = h.sup_id
			<if test="show_history == 1">
				and a.sup_no = h.sup_no
			</if>
			<if test="show_history == 0">
				and h.is_stop = 0
			</if>
		left join hos_emp he on he.emp_id = a.stocker 
			and he.hos_id = a.hos_id
			and he.group_id = a.group_id
			<if test="show_history == 0">
				and he.is_stop = 0
			</if>	
		left join sys_user aa on aa.user_id = a.checker
			and aa.hos_id = a.hos_id
			and aa.group_id = a.group_id
		left join mat_data_dict m on m.data_code='04014'
			and a.come_from = m.field_value
			and m.field_code='IN_FROM'
		left join hos_emp_dict hd on a.group_id=hd.group_id 
			and a.hos_id=hd.hos_id and a.examiner=hd.emp_id 
			and hd.is_stop=0
		<where>
			<if test="group_id != null and group_id != ''">
				 a.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and a.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND a.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="in_dateB != null and in_dateB != ''">
				AND a.in_date &gt;= to_date(#{in_dateB},'yyyy-MM-dd')
			</if>
			<if test="in_dateE != null and in_dateE != ''">
				AND a.in_date &lt;= to_date(#{in_dateE},'yyyy-MM-dd')
			</if>
			<if test="confirm_dateB != null and confirm_dateB != ''">
				AND a.confirm_date &gt;= to_date(#{confirm_dateB},'yyyy-MM-dd')
			</if>
			<if test="confirm_dateE != null and confirm_dateE != ''">
				AND a.confirm_date &lt;= to_date(#{confirm_dateE},'yyyy-MM-dd')
			</if>
			<if test="store_id != null and store_id != ''">
				AND a.store_id = #{store_id,jdbcType=INTEGER}
			</if>
			<if test="sup_id != null and sup_id != ''">
				AND a.sup_id = #{sup_id,jdbcType=INTEGER}
			</if>
			<if test="bus_type_code != null and bus_type_code != ''">
				AND a.bus_type_code = #{bus_type_code,jdbcType=INTEGER}
			</if>
			<if test="state != null and state != ''">
				AND a.state = #{state,jdbcType=INTEGER}
			</if>
			<if test="in_no != null and in_no != ''">
				AND a.in_no like  #{in_no}||'%'
			</if>
			<if test="maker != null and maker != ''">
				AND a.maker =  #{maker}
			</if>
			<!-- 添加用户数据权限 -->
			and exists (
				select 1 from v_user_data_perm vudp 
				where a.group_id=vudp.group_id and a.hos_id=vudp.hos_id 
					and a.store_id=vudp.perm_code and vudp.is_read=1 and vudp.is_write = 1
	      			and vudp.table_code='HOS_STORE_DICT'
					and vudp.user_id=#{user_id}
			)
		</where>   
		 group by a.group_id, a.hos_id, a.copy_code, a.in_id, a.in_no, a.in_date,a.brief, a.store_id, a.store_no, 
			c.store_name, a. bus_type_code, d.bus_type_name, e.user_name, f.user_name, a.state,
			a.sup_id, a.sup_no, h.sup_name,aa.user_name,he.emp_name,a.confirm_date,a.app_dept,
			a.protocol_code,a.proj_id,a.come_from,m.field_desc,a.delivery_code,a.examiner,hd.emp_code,hd.emp_name
		) temp ORDER BY temp.in_no DESC
	</select>
	
	<!-- 配套导入查询明细信息 -->
	<select id="queryMatAffiInMatchDetail" parameterType="java.util.Map" resultMap="matAffiInDetail">
		SELECT
			mid.inv_id,
			mid.inv_no,
			mid.inv_code,
			mid.inv_name,
			mid.inv_model,
			mid.unit_code,
			hu.unit_name,
			mid.is_highvalue, 
			mid.is_batch, 
			mid.is_bar, 
			mid.is_per_bar, 
			mid.is_quality, 
			mid.is_single_ven, 
			mid.is_disinfect, 
			mid.plan_price price,
			msmd.amount
		FROM mat_store_match msm
		LEFT JOIN MAT_STORE_MATCH_DETAIL msmd ON msm.group_id = msmd.group_id
			AND msm.hos_id = msmd.hos_id
			AND msm.copy_code = msmd.copy_code
			AND msm.store_match_id = msmd.store_match_id
		LEFT JOIN mat_inv_dict mid ON msmd.group_id = mid.group_id
			AND msmd.hos_id = mid.hos_id
			AND msmd.copy_code = mid.copy_code
			AND msmd.inv_id = mid.inv_id
			AND mid.is_stop = 0
		LEFT JOIN hos_unit hu
			ON mid.group_id = hu.group_id
			AND mid.hos_id = hu.hos_id
			AND mid.unit_code = hu.unit_code
		LEFT JOIN hos_store_dict hsd
			ON msm.group_id = hsd.group_id
		    AND msm.hos_id = hsd.hos_id
		    AND msm.store_id = hsd.store_id
		    AND hsd.is_stop = 0 
		<where>
			<if test="group_id != null and group_id != ''">
				and msm.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and msm.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND msm.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="store_id != null and store_id != ''">
				and msm.store_id = #{store_id,jdbcType=INTEGER}
			</if>
			<if test="store_match_id != null and store_match_id != ''">
				and msm.store_match_id = #{store_match_id,jdbcType=INTEGER}
			</if>
			and mid.is_com = 1
		</where>
		order by msmd.inv_id asc
	</select>
	
	<!-- 订单导入  查询 -->
	<select id="queryMatOrder" parameterType="java.util.Map" resultMap="matMatOrder">
		select  distinct
			mom.group_id,
			mom.hos_id,
			mom.copy_code,
			mom.order_id,
			mom.order_code, --订单号
			mom.brif, --摘要
			hsd.sup_name, --供应商
			hc.hos_name pur_hos_name,--采购单位
			hc1.hos_name take_hos_name,--收货单位
			hc2.hos_name pay_hos_name,--付款单位
			su.user_name maker_name, --制单人
			mom.order_date, --编制日期
			mom.state--状态
		from mat_order_main mom
		left join hos_sup_dict hsd  on mom.sup_id = hsd.sup_id 
			and mom.sup_no = hsd.sup_no 
			and mom.hos_id = hsd.hos_id
			and mom.group_id = hsd.group_id
		left join hos_info hc on hc.hos_id = mom.pur_hos_id
			and hc.group_id = mom.group_id
			and hc.is_stop = 0
		left join hos_info hc1  on hc1.hos_id = mom.take_hos_id
			and hc1.group_id = mom.group_id
			and hc1.is_stop = 0
		left join hos_info hc2  on hc2.hos_id = mom.pay_hos_id
			and hc2.group_id = mom.group_id
			and hc2.is_stop = 0
		left join sys_user su on mom.group_id = su.group_id
			and mom.hos_id = su.hos_id
			and mom.maker = su.user_id
		left join mat_order_detail mod on mom.group_id = mod.group_id
			and mom.hos_id = mod.hos_id
			and mom.copy_code = mod.copy_code
			and mom.order_id = mod.order_id
		left join mat_in_order_rela mior  on mod.group_id = mior.group_id
			and mod.hos_id = mior.hos_id
			and mod.copy_code = mior.copy_code
			and mod.order_id = mior.order_id
			and mod.order_detail_id = mior.order_detail_id
			and mior.in_amount &lt;&gt; mior.order_amount
		left join mat_inv_dict mid on mod.group_id = mid.group_id
				and mod.hos_id = mid.hos_id
				and mod.copy_code = mid.copy_code
				and mod.inv_id = mid.inv_id
				and mod.inv_no = mid.inv_no
		<where>
			<if test="group_id != null and group_id != ''">
				and mom.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and mom.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and mom.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and mom.take_hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="begin_date != null and begin_date != ''">
				AND mom.order_date &gt;= to_date(#{begin_date},'yyyy/MM/dd')
			</if>
			<if test="end_date != null and end_date != ''">
				AND mom.order_date &lt;= to_date(#{end_date},'yyyy/MM/dd')
			</if>
			<if test="sup_id != null and sup_id != ''">
				AND mom.sup_id =#{sup_id,jdbcType=INTEGER}
			</if>
			<if test="sup_no != null and sup_no != ''">
				AND mom.sup_no =#{sup_no,jdbcType=INTEGER}
			</if>
			<if test="stocker != null and stocker != ''">
				AND mom.stocker =#{stocker,jdbcType=INTEGER}
			</if>
			<if test="order_code != null and order_code != ''">
				AND mom.order_code like '%'||#{order_code,jdbcType=VARCHAR}||'%'
			</if>
			<if test="brif != null and brif != ''">
				AND mom.brif like '%${brif}%'
			</if>
			<if test="inv_code != null and inv_code !=''">
				AND (mid.inv_code like '${inv_code}%' or mid.inv_name like '%${inv_code}%')
			</if>
			and mid.is_com = 1
			and mior.in_id is null --该材料如果入库完成则不为null 
			and mom.state = 2
		</where>
		order by mom.order_id desc
	</select>
	
	<!-- 订单导入  查询明细 -->
	<select id="queryMatOrderDetail"  parameterType="java.util.Map" resultMap="matMatOrder">
		select 
		    mdd.group_id,
		    mdd.hos_id,
		    mdd.copy_code,
		    mdd.order_id,
		    mdd.order_detail_id,
		    mdd.inv_no,
		    mdd.inv_id,
		    mid.inv_code,
		    mid.inv_name,
		    mid.inv_model,
		    mid.unit_code,
		    hu.unit_name,
		    mdd.pack_code,
		    hp.pack_name,
		    mdd.num,--包装数量
		    mdd.amount,--数量
		    mdd.price,--单价
		    nvl(mdd.amount,0)*nvl(mdd.price,0) amount_money,--金额
		    mdd.num_exchange,--包装换算量
		    --mdd.arrive_date,--计划到货日期
		    mdd.memo --备注
		from mat_order_detail mdd
		left join mat_inv_dict mid on mdd.inv_no = mid.inv_no
		     and mid.inv_id = mdd.inv_id
		     and mdd.group_id = mid.group_id
		     and mdd.hos_id = mid.hos_id
		     and mdd.copy_code = mid.copy_code
		left join hos_unit hu on hu.unit_code = mid.unit_code
		     and hu.group_id = mid.group_id
		     and hu.hos_id = mid.hos_id
		     and hu.is_stop = 0
		left join hos_package hp on hp.pack_code = mdd.pack_code
     		 and hp.group_id = mdd.group_id
		     and hp.hos_id = mdd.hos_id
		     and hp.is_stop = 0 
		where mdd.group_id = #{group_id,jdbcType=INTEGER} 
		      and mdd.hos_id = #{hos_id,jdbcType=INTEGER} 
		      and mdd.copy_code = #{copy_code,jdbcType=VARCHAR}
		      and mid.is_com = 1
		      <if test="order_id != null and order_id != ''">
				and mdd.order_id = #{order_id,jdbcType=INTEGER}
			  </if>
			  <if test="order_detail_id != null and order_detail_id != ''">
				and mdd.order_detail_id = #{order_detail_id,jdbcType=INTEGER}
			  </if> 
		order by mdd.order_id,mdd.order_detail_id asc
	</select>
	
	<!-- 订单导入  选中订单明细 -->
	<select id="queryOrderDetailImp"  parameterType="java.util.Map" resultMap="matMatOrder">
		select rela.order_rela,--材料订单对应关系
		    mod.inv_no,
		    mod.inv_id,
		    mid.inv_code,
		    mid.inv_name,
		    mid.inv_model,
		    mid.unit_code,
		    hu.unit_name,
		    mid.is_highvalue, 
			mid.is_batch, 
			mid.is_bar, 
			mid.is_per_bar, 
			mid.is_quality, 
			mid.is_single_ven, 
			mid.is_disinfect,
		    sum(nvl(mod.amount, 0)) amount,--数量
		    mod.price,    --单价
		    sum(nvl(mod.amount,0)*nvl(mod.price,0)) amount_money  --金额
		    --,mod.pack_code,
        	--hp.pack_name,
		    --sum(nvl(mod.num, 0)) num,--包装数量
		    --mod.num_exchange,--包装换算量
		from mat_order_detail mod
		left join mat_inv_dict mid  on mod.inv_no = mid.inv_no
			and mod.inv_id = mid.inv_id
			and mod.group_id = mid.group_id
			and mod.hos_id = mid.hos_id
			and mod.copy_code = mid.copy_code
		left join hos_unit hu 
			on mid.unit_code = hu.unit_code
			and mid.group_id = hu.group_id
			and mid.hos_id = hu.hos_id
		left join hos_package hp
			on mod.group_id = hp.group_id
			and mod.hos_id = hp.hos_id
			and mod.pack_code = hp.pack_code
		left join (
			select inv_id, '['||to_char(wm_concat('{"order_id":'||order_id||',"order_detail_id":'||order_detail_id||',"in_amount":'||amount||',"order_amount":'||amount||'}'))||']' order_rela 
			from mat_order_detail
			where group_id = #{group_id,jdbcType=INTEGER} 
				and hos_id = #{hos_id,jdbcType=INTEGER} 
				and copy_code = #{copy_code,jdbcType=VARCHAR}
				and order_id in (${order_ids})
			group by inv_id
			) rela
		on mod.inv_id = rela.inv_id
		where mod.group_id = #{group_id,jdbcType=INTEGER} 
			and mod.hos_id = #{hos_id,jdbcType=INTEGER} 
			and mod.copy_code = #{copy_code,jdbcType=VARCHAR}
			and mod.order_id in (${order_ids})
			and mid.is_com = 1
		group by rela.order_rela, mod.inv_no, mod.inv_id, mid.inv_code, mid.inv_name, mid.inv_model,
		    mid.unit_code, hu.unit_name, mid.is_highvalue, mid.is_batch, mid.is_bar, mid.is_per_bar, 
			mid.is_quality, mid.is_single_ven, mid.is_disinfect, mod.price
			<!-- , mod.pack_code, hp.pack_name, mod.num_exchange -->
		order by inv_id 
	</select>
	
	<!-- 协议导入查询 -->
	<select id="queryMatAffiInPro" parameterType="java.util.Map" resultMap="matAffiInDetail">
		select b.inv_id, 
			b.inv_no, 
			b.inv_code, 
			b.inv_name, 
			b.inv_model, 
			b.unit_code, 
			c.unit_name, 
			a.price, 
			b.is_highvalue, 
			b.is_batch, 
			b.is_bar, 
			b.is_per_bar, 
			b.is_quality, 
			b.is_single_ven, 
			b.is_disinfect
		from pact_det_fkxy a
		left join mat_inv_dict b on a.group_id = b.group_id
			and a.hos_id = b.hos_id
			and a.copy_code = b.copy_code
			and a.subject_id = b.inv_id
			and b.is_stop = 0
		left join hos_unit c on b.group_id = c.group_id
			and b.hos_id = c.hos_id
			and b.unit_code = c.unit_code
			and c.is_stop = 0
		<where>
			<if test="group_id != null and group_id != ''">
				and a.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and a.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="protocol_id != null and protocol_id != ''">
                and a.pact_code in (
                SELECT REGEXP_SUBSTR (#{protocol_id,jdbcType=VARCHAR}, '[^,]+', 1,rownum) out_id
                from dual connect by rownum &lt;=LENGTH (#{protocol_id,jdbcType=VARCHAR}) - LENGTH (regexp_replace(#{protocol_id,jdbcType=VARCHAR}, ',', ''))+1
            )
			</if>
			and b.is_com = 1
		</where>
		order by a.detail_id
	</select>	
	
	<!-- 冲账  被冲账的主表数据 -->
	<select id="queryByCodeOffSet" parameterType="java.util.Map" resultMap="matAffiInMain">
		SELECT 
			a.group_id, 
			a.hos_id, 
			a.copy_code, 
			a.in_id,
			a.in_no,
			a.year, 
			a.month, 
			a.sup_no, 
			a.sup_id,  
      		a.store_id, 
      		a.store_no, 
      		a.brief, 
      		a.stocker,
      		a.bus_type_code, 
      		a.stock_type_code, 
      		a.is_org, 
      		sysdate in_date,
      		sysdate make_date, 
      		1 state, 
      		a.dept_id,
      		a.dept_no,
      		a.come_from,
      		a.delivery_code,
      		a.examiner
		FROM mat_affi_in a
		WHERE a.group_id = #{group_id,jdbcType=INTEGER} 
			and a.hos_id = #{hos_id,jdbcType=INTEGER} 
			and a.copy_code = #{copy_code,jdbcType=VARCHAR} 
			and a.in_id = #{in_id,jdbcType=INTEGER} 
	</select>
	
	<!-- 冲账  被冲账的明细表数据 -->
	<select id="queryDetailByCodeOffSet" parameterType="java.util.Map" resultMap="matAffiInDetail">
		SELECT 
			mad.group_id, 
			mad.hos_id, 
			mad.copy_code, 
			#{in_idNew,jdbcType=INTEGER} in_id,
			mad.inv_id, 
			mad.inv_no, 
			nvl(mad.amount,0)*(-1) amount, 
			mad.price,
			nvl(mad.amount_money,0)*(-1) amount_money,
			mad.batch_no, 
			mad.batch_sn,
			mad.sell_price, 
			mad.sell_money, 
			mad.pack_code, 
			mad.num_exchange, 
			mad.num,
			mad.pack_price,
			mad.bar_code,
			mad.is_per_bar,
			mad.sn, 
			mad.inva_date, 
			mad.disinfect_date, 
			mad.location_id, 
			mad.note,
			mad.cert_id,
			mad.fac_date,
			mad.serial_no,
			mad.disinfect_no
		FROM mat_affi_in_detail mad
		WHERE mad.group_id = #{group_id,jdbcType=INTEGER} 
				AND mad.hos_id = #{hos_id,jdbcType=INTEGER} 
				AND mad.copy_code = #{copy_code,jdbcType=VARCHAR} 
				AND mad.in_id = #{in_id,jdbcType=INTEGER} 
			order by mad.in_id,mad.detail_id
	</select>
	
	<!-- 冲账  插入到对应关系中 -->
	<insert id="addMatAffiBackRela" parameterType="java.util.Map">
		insert into mat_affi_back_rela(
			group_id,hos_id,copy_code,back_id,in_id
		)values(
			#{group_id,jdbcType=INTEGER},
			#{hos_id,jdbcType=INTEGER},
			#{copy_code,jdbcType=VARCHAR},
			#{in_id,jdbcType=INTEGER},
			#{in_idNew,jdbcType=INTEGER}
		)
	</insert>
	
	<!-- 维护发票页面跳转查询 -->
	<select id="queryMatAffiInMainByInvoice" parameterType="java.util.Map" resultType="java.util.TreeMap" >
		select mim.group_id, mim.hos_id, mim.copy_code, mim.in_id, mim.in_no, mim.bus_type_code, 
			mbt.bus_type_name, 0 init, hsupd.sup_code, hsupd.sup_name, hsd.store_code, hsd.store_name, 
			hdd.dept_code, hdd.dept_name, sustock.user_name as stocker_name, sumake.user_name as maker_name,
			sucheck.user_name as checker_name, sucon.user_name as confirmer_name, mim.confirm_date, mim.brief, 
			sum(mid.amount_money) as payable_money, sum(mid.amount_money) as bill_money
		from mat_affi_in mim
		left join mat_affi_in_detail mid on mim.group_id = mid.group_id and mim.hos_id = mid.hos_id
			and mim.copy_code = mid.copy_code and mim.in_id = mid.in_id
		left join mat_bus_type mbt on mim.bus_type_code = mbt.bus_type_code
		left join hos_sup_dict hsupd on mim.group_id = hsupd.group_id and mim.hos_id = hsupd.hos_id
			and mim.sup_id = hsupd.sup_id and hsupd.is_stop = 0
		left join hos_store_dict hsd on mim.group_id = hsd.group_id and mim.hos_id = hsd.hos_id
			and mim.store_id = hsd.store_id and hsd.is_stop = 0
		left join hos_dept_dict hdd on mim.group_id = hdd.group_id and mim.hos_id = hdd.hos_id
			and mim.app_dept = hdd.dept_id and hdd.is_stop = 0
		left join sys_user sustock on mim.group_id = sustock.group_id and mim.hos_id = sustock.hos_id
			and mim.stocker = sustock.user_id
		left join sys_user sumake on mim.group_id = sumake.group_id and mim.hos_id = sumake.hos_id
			and mim.maker = sumake.user_id
		left join sys_user sucheck on mim.group_id = sucheck.group_id and mim.hos_id = sucheck.hos_id
			and mim.checker = sucheck.user_id
		left join sys_user sucon on mim.group_id = sucon.group_id and mim.hos_id = sucon.hos_id
			and mim.confirmer = sucon.user_id
		where mim.group_id = #{group_id,jdbcType=INTEGER}
			and mim.hos_id = #{hos_id,jdbcType=INTEGER}
			and mim.copy_code = #{copy_code,jdbcType=VARCHAR}
			and mim.in_id = #{in_id,jdbcType=INTEGER}
			AND mid.detail_id NOT IN (
				SELECT DISTINCT in_detail_id
				FROM mat_bill_detail
				WHERE group_id = #{group_id,jdbcType=INTEGER}
					AND hos_id = #{hos_id,jdbcType=INTEGER}
					AND copy_code = #{copy_code,jdbcType=VARCHAR}
					AND in_id = #{in_id,jdbcType=INTEGER})
		group by mim.group_id, mim.hos_id, mim.copy_code, mim.in_id, mim.in_no, mim.bus_type_code, 
			mbt.bus_type_name, hsupd.sup_code, hsupd.sup_name, hsd.store_code, hsd.store_name, hdd.dept_code, 
			hdd.dept_name, sustock.user_name, sumake.user_name, sucheck.user_name, sucon.user_name, mim.confirm_date, mim.brief
	</select>
	
	<!-- 明细数据是否已经全部维护发票信息  -->
	<select id="existsMatAffiInDetailByInvoice" parameterType="java.util.Map" resultType="java.lang.Integer" >
		select count(1) from mat_affi_in_detail a
		where a.group_id = #{group_id,jdbcType=INTEGER}
			and a.hos_id = #{hos_id,jdbcType=INTEGER}
			and a.copy_code = #{copy_code,jdbcType=VARCHAR}
			and a.in_id = #{in_id,jdbcType=INTEGER}
			and not exists(
				select 1 from mat_bill_detail b
				where b.group_id = a.group_id
					and b.hos_id = a.hos_id
					and b.copy_code = a.copy_code
					and b.in_detail_id = a.detail_id
			)
	</select>
	
	<!-- 下一张单据ID -->
	<select id="queryAffiNextOutId" parameterType="java.util.Map" resultType="java.lang.String">
		select  min(a.in_id) in_idNext
          from mat_affi_in a 
          join (  
               select  mao.group_id,  mao.hos_id,  mao.copy_code,  mao.year,  mao.month, mao.in_id,mao.bus_type_code
               from mat_affi_in mao
               where mao.group_id = #{group_id,jdbcType=INTEGER} 
                 and mao.hos_id = #{hos_id,jdbcType=INTEGER} 
                 and mao.copy_code = #{copy_code,jdbcType=VARCHAR}
                 and mao.in_id = #{in_id,jdbcType=INTEGER}
                 and mao.bus_type_code = #{bus_type_code,jdbcType=VARCHAR}
         ) b on a.group_id = b.group_id 
               and a.hos_id = b.hos_id 
               and a.copy_code = b.copy_code 
               and a.year = b.year 
               and a.month = b.month 
               and a.in_id &gt; b.in_id
               and a.bus_type_code = b.bus_type_code
               group by a.group_id ,a.hos_id,a.copy_code,a.year,a.month
	</select>
	
	
	<!-- 上一张单据ID -->
	<select id="queryAffiUpOutId" parameterType="java.util.Map" resultType="java.lang.String">
		select  max(a.in_id) in_idUp
	    from mat_affi_in a 
	    join (
	       select  mao.group_id, mao.hos_id,mao.copy_code,mao.year,mao.month,mao.in_id,mao.bus_type_code
	        from mat_affi_in mao
	       where mao.group_id = #{group_id,jdbcType=INTEGER}   
	       		and mao.hos_id = #{hos_id,jdbcType=INTEGER}  
	       		and mao.copy_code = #{copy_code,jdbcType=VARCHAR}
	       		and mao.in_id = #{in_id,jdbcType=INTEGER}
	       		and mao.bus_type_code = #{bus_type_code,jdbcType=VARCHAR}
	    ) b on a.group_id = b.group_id 
	      and a.hos_id = b.hos_id 
	      and a.copy_code = b.copy_code 
	      and a.year = b.year 
	      and a.month = b.month 
	      and a.in_id &lt; b.in_id
	      and a.bus_type_code = b.bus_type_code
	      group by a.group_id ,a.hos_id,a.copy_code,a.year,a.month
	</select>
	
	<!-- 入库主表模板打印 -->
	<select id="queryMatAffiInPrintTemlateByMain" parameterType="java.util.Map" resultType="java.util.Map" >
		select a.IN_NO,b.BUS_TYPE_NAME,su.sup_code,su.SUP_NAME,s.STORE_CODE,s.STORE_NAME,u1.user_name MAKER,
			to_char(a.IN_DATE, 'yyyy-MM-dd hh24:mi:ss') as IN_DATE,
			to_char(a.CHECK_DATE, 'yyyy-MM-dd hh24:mi:ss') as CHECK_DATE,
			u2.user_name CHECKER,u4.user_name CONFIRMER,
			to_char(a.CONFIRM_DATE, 'yyyy-MM-dd hh24:mi:ss') as CONFIRM_DATE,
			a.BRIEF,u3.emp_name STOCKER,d1.dept_code APP_DEPT_CODE,d1.dept_name APP_DEPT_NAME,
			t.STOCK_TYPE_NAME,--采购类型
			p.PROJ_CODE,p.PROJ_NAME,--项目编码
			a.PROTOCOL_CODE,pt.PROTOCOL_NAME,  --协议编号
			SUM(maid.amount_money) MONEY_SUM,  --合计金额
			SUM(maid.amount_money) MONEY_SUM_UPPER,  --合计金额大写
			sum(nvl(maid.amount,0)) AMOUNT_SUM,
			a.DELIVERY_CODE,
			hd.emp_name as EXAMINER
		from mat_affi_in a 
		left join mat_affi_in_detail maid 
			on a.group_id = maid.group_id and a.hos_id = maid.hos_id 
			and a.copy_code = maid.copy_code and a.in_id = maid.in_id
		left join hos_proj_dict p on a.group_id=p.group_id and a.hos_id=p.hos_id and a.proj_id=p.proj_id and p.is_stop=0
		left join mat_stock_type t on a.group_id=t.group_id and a.hos_id=t.hos_id and a.copy_code=t.copy_code and a.stock_type_code=t.stock_type_code
		left join mat_bus_type b on a.BUS_TYPE_CODE=b.bus_type_code
		left join hos_store_dict s on a.group_id=s.group_id and a.hos_id=s.hos_id and a.store_id=s.store_id and a.store_no=s.store_no
		left join hos_sup_dict su on a.group_id=su.group_id and a.hos_id=su.hos_id and a.sup_id=su.sup_id and a.sup_no=su.sup_no
		left join sys_user u1 on a.group_id=u1.group_id and a.hos_id=u1.hos_id and a.MAKER=u1.user_id
		left join sys_user u2 on a.group_id=u2.group_id and a.hos_id=u2.hos_id and a.CHECKER=u2.user_id
		left join hos_emp_dict u3 on a.group_id=u3.group_id and a.hos_id=u3.hos_id and a.STOCKER=u3.emp_id
		left join sys_user u4 on a.group_id=u4.group_id and a.hos_id=u4.hos_id and a.CONFIRMER=u4.user_id
		left join hos_dept_dict d1 on a.group_id=d1.group_id and a.hos_id=d1.hos_id and a.app_dept=d1.dept_id and d1.is_stop=0
		left join MAT_PROTOCOL_MAIN pt on a.group_id=pt.group_id and a.hos_id=pt.hos_id and a.copy_code=pt.copy_code and a.protocol_code=pt.protocol_code
		left join hos_emp_dict hd on a.group_id=hd.group_id and a.hos_id=hd.hos_id and a.examiner=hd.emp_id and hd.is_stop=0
		where a.group_id = #{group_id,jdbcType=NUMERIC}
			and a.hos_id = #{hos_id,jdbcType=NUMERIC}
			and a.copy_code = #{copy_code,jdbcType=VARCHAR}
			and a.in_id=#{in_id,jdbcType=NUMERIC}
		group by a.IN_NO, b.BUS_TYPE_NAME, su.sup_code, su.SUP_NAME, s.STORE_CODE, s.STORE_NAME, u1.user_name,
			a.IN_DATE, a.CHECK_DATE, u2.user_name, u4.user_name, a.CONFIRM_DATE, a.BRIEF, u3.emp_name, d1.dept_code, d1.dept_name, t.STOCK_TYPE_NAME,
			p.PROJ_CODE, p.PROJ_NAME, a.PROTOCOL_CODE, pt.PROTOCOL_NAME,a.DELIVERY_CODE,hd.emp_name 
	</select>
	
	
	<select id="queryMatAffiInPrintTemlateByMainBatch" parameterType="java.util.Map" resultType="java.util.Map" >
		select a.in_id as id,a.IN_NO,b.BUS_TYPE_NAME,su.sup_code,su.SUP_NAME,s.STORE_CODE,s.STORE_NAME,u1.user_name MAKER,
			to_char(a.IN_DATE, 'yyyy-MM-dd hh24:mi:ss') as IN_DATE,to_char(a.CHECK_DATE, 'yyyy-MM-dd hh24:mi:ss') as CHECK_DATE,
			u2.user_name CHECKER,u4.user_name CONFIRMER,to_char(a.CONFIRM_DATE, 'yyyy-MM-dd hh24:mi:ss') as CONFIRM_DATE,
			a.BRIEF,u3.user_name STOCKER,d1.dept_code APP_DEPT_CODE,d1.dept_name APP_DEPT_NAME,
			t.STOCK_TYPE_NAME,--采购类型
			p.PROJ_CODE,p.PROJ_NAME,--项目编码
			a.PROTOCOL_CODE,pt.PROTOCOL_NAME,--协议编号
			SUM(maid.amount_money) MONEY_SUM,  --合计金额
			SUM(maid.amount_money) MONEY_SUM_UPPER,  --合计金额大写
			sum(nvl(maid.amount,0)) AMOUNT_SUM,
			a.DELIVERY_CODE,
			hd.emp_name as EXAMINER_NAME
		from mat_affi_in a 
		left join mat_affi_in_detail maid 
			on a.group_id = maid.group_id and a.hos_id = maid.hos_id 
			and a.copy_code = maid.copy_code and a.in_id = maid.in_id
		left join hos_proj_dict p on a.group_id=p.group_id and a.hos_id=p.hos_id and a.proj_id=p.proj_id and p.is_stop=0
		left join mat_stock_type t on a.group_id=t.group_id and a.hos_id=t.hos_id and a.copy_code=t.copy_code and a.stock_type_code=t.stock_type_code
		left join mat_bus_type b on a.BUS_TYPE_CODE=b.bus_type_code
		left join hos_store_dict s on a.group_id=s.group_id and a.hos_id=s.hos_id and a.store_id=s.store_id and a.store_no=s.store_no
		left join hos_sup_dict su on a.group_id=su.group_id and a.hos_id=su.hos_id and a.sup_id=su.sup_id and a.sup_no=su.sup_no
		left join sys_user u1 on a.group_id=u1.group_id and a.hos_id=u1.hos_id and a.MAKER=u1.user_id
		left join sys_user u2 on a.group_id=u2.group_id and a.hos_id=u2.hos_id and a.CHECKER=u2.user_id
		left join sys_user u3 on a.group_id=u3.group_id and a.hos_id=u3.hos_id and a.STOCKER=u3.user_id
		left join sys_user u4 on a.group_id=u4.group_id and a.hos_id=u4.hos_id and a.CONFIRMER=u4.user_id
		left join hos_dept_dict d1 on a.group_id=d1.group_id and a.hos_id=d1.hos_id and a.app_dept=d1.dept_id and d1.is_stop=0
		left join MAT_PROTOCOL_MAIN pt on a.group_id=pt.group_id and a.hos_id=pt.hos_id and a.copy_code=pt.copy_code and a.protocol_code=pt.protocol_code
		left join hos_emp_dict hd on a.group_id=hd.group_id and a.hos_id=hd.hos_id and a.examiner=hd.emp_id and hd.is_stop=0
		where a.group_id = #{group_id,jdbcType=NUMERIC}
			and a.hos_id = #{hos_id,jdbcType=NUMERIC}
			and a.copy_code = #{copy_code,jdbcType=VARCHAR}
			and a.in_id in  (${paraId})
		group by a.in_id, a.IN_NO, b.BUS_TYPE_NAME, su.sup_code, su.SUP_NAME, s.STORE_CODE, s.STORE_NAME, u1.user_name,
			a.IN_DATE, a.CHECK_DATE, u2.user_name, u4.user_name, a.CONFIRM_DATE, a.BRIEF, u3.user_name, d1.dept_code, d1.dept_name, t.STOCK_TYPE_NAME,
			p.PROJ_CODE, p.PROJ_NAME, a.PROTOCOL_CODE, pt.PROTOCOL_NAME,a.DELIVERY_CODE,hd.emp_name
	     order by a.in_id desc	

	</select>
	
	<!-- 入库明细表模板打印 -->
	<select id="queryMatAffiInPrintTemlateByDetail" parameterType="java.util.Map" resultType="java.util.Map" >
		select d.in_id as id,i.INV_CODE,i.INV_NAME,i.INV_MODEL,u.UNIT_NAME  as UNIT_CODE,d.PRICE,d.AMOUNT,d.AMOUNT_MONEY,d.ALLOT_MONEY,
			f.FAC_CODE FAC_CODE,f.FAC_NAME,d.NOTE,p.PACK_NAME,d.NUM_EXCHANGE,d.NUM,d.pack_price as PACK_PRICE,d.BATCH_SN,d.BATCH_NO,
			d.SN,d.BAR_CODE,to_char(d.INVA_DATE, 'yyyy-MM-dd') as INVA_DATE,ld.LOCATION_CODE,ld.LOCATION_NAME,
			to_char(d.DISINFECT_DATE,'yyyy-MM-dd') as DISINFECT_DATE,d.SALE_PRICE,d.SALE_MONEY,d.SELL_PRICE,
			d.SELL_MONEY,d.ALLOT_PRICE,micr.CERT_ID, micr.CERT_CODE,to_char(d.FAC_DATE, 'yyyy-MM-dd') fac_date,d.SERIAL_NO,d.DISINFECT_NO,
			i.bid_code,mtd.mat_type_name,
			case b.is_per_bar
				when 0 then '否'
	            when 1 then '是'
         	end as is_per_bar
		from 
		mat_affi_in_detail d 
		left join mat_inv_dict i on d.group_id=i.group_id and d.hos_id=i.hos_id and d.copy_code=i.copy_code and d.inv_id=i.inv_id and d.inv_no=i.inv_no
		left join mat_type_dict mtd on i.group_id = mtd.group_id
			and i.hos_id = mtd.hos_id
			and i.copy_code = mtd.copy_code
			and i.mat_type_id = mtd.mat_type_id
			and i.mat_type_no = mtd.mat_type_no 
		left JOIN mat_location_dict ld ON d.group_id = ld.group_id AND d.hos_id = ld.hos_id AND d.copy_code = ld.copy_code AND d.location_id = ld.location_id 
		left join hos_fac_dict f on d.group_id = f.group_id AND d.hos_id = f.hos_id and i.fac_id=f.fac_id and i.fac_no=f.fac_no
		left join hos_unit u on d.group_id=u.group_id and d.hos_id=u.hos_id and i.unit_code=u.unit_code
		left join hos_package p on d.group_id=p.group_id and d.hos_id=p.hos_id and d.pack_code=p.pack_code
		left join mat_prod_cert_inv micr on micr.group_id = d.group_id and micr.hos_id = d.hos_id and micr.copy_code = d.copy_code and micr.cert_id=d.cert_id and micr.inv_id=d.inv_id
		left join mat_inv_dict b on d.group_id = b.group_id
			and d.hos_id = b.hos_id
			and d.copy_code = b.copy_code
			and d.inv_id = b.inv_id
			and d.inv_no = b.inv_no
		where d.group_id = #{group_id,jdbcType=NUMERIC}
			and d.hos_id = #{hos_id,jdbcType=NUMERIC}
			and d.copy_code = #{copy_code,jdbcType=VARCHAR}
			<if test="p_num ==1">
				and d.in_id in (${paraId})
				
			</if>
			<if test="p_num ==0">
				and d.in_id=#{in_id,jdbcType=NUMERIC}
			</if>	
			  	order by d.in_id, d.detail_id desc

	</select>
	
	<!-- 入库明细表模板汇总打印 -->
	<select id="queryMatAffiInPrintTemlateByDetailCollect" parameterType="java.util.Map" resultType="java.util.Map" >
		select d.in_id as id,i.INV_CODE,i.INV_NAME,i.INV_MODEL,u.UNIT_NAME  as UNIT_CODE,d.PRICE,
			sum(d.AMOUNT) AMOUNT, sum(d.AMOUNT_MONEY) AMOUNT_MONEY, sum(d.ALLOT_MONEY) ALLOT_MONEY,
			f.FAC_CODE FAC_CODE,f.FAC_NAME,d.NOTE,p.PACK_NAME,d.NUM_EXCHANGE,sum(d.NUM) NUM,d.BATCH_NO,
			to_char(d.INVA_DATE, 'yyyy-MM-dd') as INVA_DATE,ld.LOCATION_CODE,ld.LOCATION_NAME,
			to_char(d.DISINFECT_DATE,'yyyy-MM-dd') as DISINFECT_DATE,d.SALE_PRICE, sum(d.SALE_MONEY) SALE_MONEY, 
			d.SELL_PRICE, sum(d.SELL_MONEY) SELL_MONEY, d.ALLOT_PRICE, micr.CERT_ID, micr.CERT_CODE, 
			to_char(d.FAC_DATE, 'yyyy-MM-dd') fac_date,d.SERIAL_NO,d.DISINFECT_NO, i.bid_code,mtd.mat_type_name
		from 
		mat_affi_in_detail d 
		left join mat_inv_dict i on d.group_id=i.group_id and d.hos_id=i.hos_id and d.copy_code=i.copy_code and d.inv_id=i.inv_id and d.inv_no=i.inv_no
		left join mat_type_dict mtd on i.group_id = mtd.group_id
			and i.hos_id = mtd.hos_id
			and i.copy_code = mtd.copy_code
			and i.mat_type_id = mtd.mat_type_id
			and i.mat_type_no = mtd.mat_type_no 
		left JOIN mat_location_dict ld ON d.group_id = ld.group_id AND d.hos_id = ld.hos_id AND d.copy_code = ld.copy_code AND d.location_id = ld.location_id 
		left join hos_fac_dict f on d.group_id = f.group_id AND d.hos_id = f.hos_id and i.fac_id=f.fac_id and i.fac_no=f.fac_no
		left join hos_unit u on d.group_id=u.group_id and d.hos_id=u.hos_id and i.unit_code=u.unit_code
		left join hos_package p on d.group_id=p.group_id and d.hos_id=p.hos_id and d.pack_code=p.pack_code
		left join mat_prod_cert_inv micr on micr.group_id = d.group_id and micr.hos_id = d.hos_id and micr.copy_code = d.copy_code and micr.cert_id=d.cert_id and micr.inv_id=d.inv_id
		where d.group_id = #{group_id,jdbcType=NUMERIC}
			and d.hos_id = #{hos_id,jdbcType=NUMERIC}
			and d.copy_code = #{copy_code,jdbcType=VARCHAR}
			<if test="p_num ==1">
				and d.in_id in (${paraId})
				
			</if>
			<if test="p_num ==0">
				and d.in_id=#{in_id,jdbcType=NUMERIC}
			</if>	
		group by d.in_id, i.INV_CODE, i.INV_NAME, i.INV_MODEL, u.UNIT_NAME, d.PRICE, 
			f.FAC_CODE, f.FAC_NAME, d.NOTE, p.PACK_NAME, d.NUM_EXCHANGE, d.BATCH_NO, 
			to_char(d.INVA_DATE, 'yyyy-MM-dd'), ld.LOCATION_CODE, ld.LOCATION_NAME, 
			to_char(d.DISINFECT_DATE, 'yyyy-MM-dd'), d.SALE_PRICE, d.SELL_PRICE, d.ALLOT_PRICE, 
			micr.CERT_ID, micr.CERT_CODE, to_char(d.FAC_DATE, 'yyyy-MM-dd'), d.SERIAL_NO, d.DISINFECT_NO, 
			i.bid_code, mtd.mat_type_name 
		order by d.in_id, i.INV_CODE
	</select>
	
	<!-- 历史引入查明细数据 -->
	<select id="queryMatAffiInHistoryDetail" parameterType="java.util.Map" resultType="java.util.Map" >
		with d_tmp as (
			select a.group_id,a.hos_id,a.copy_code,a.in_no,hsd.sup_code,hsd.sup_name,hsd.sup_id,hsd.sup_no,
	       		a.inv_id,a.inv_no,mid.inv_code,mid.inv_name,mid.inv_model,mid.unit_code,hu.unit_name,
	       		mid.plan_price as price,nvl(a.amount,0)*#{flag} amount,
	       	<!-- nvl(a.amount_money,0)*#{flag} as amount_money,  -->
	      	nvl( mid.plan_price,0)*nvl(a.amount,0)*#{flag} as amount_money, 
	       		e.fac_code,e.fac_name,e.fac_id,e.fac_no,
	       		a.fac_date,a.batch_no,a.bar_code,a.inva_date,a.disinfect_date,a.sn,mid.is_per_bar,a.pack_code,
	       		g.pack_name pack_name,a.num_exchange,a.num,a.pack_price,a.sale_price,nvl(a.sale_money,0)*(-1) as sale_money,
	       		a.sell_price,nvl(a.sell_money,0)*(-1) as sell_money,
	       		a.location_id,mld.location_name,a.note,a.cert_id,mic.cert_code,a.detail_id,a.disinfect_no
			from mat_affi_in_detail a
			left join mat_affi_in b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
			     and a.in_id=b.in_id
			left join mat_inv_dict mid on a.group_id=mid.group_id and a.hos_id=mid.hos_id and a.copy_code=mid.copy_code
			     and a.inv_id=mid.inv_id and a.inv_no=mid.inv_no
			left join hos_unit hu on mid.group_id=hu.group_id and mid.hos_id=hu.hos_id and mid.unit_code=hu.unit_code and hu.is_stop=0
			left join hos_sup_dict hsd on b.group_id=hsd.group_id and b.hos_id=hsd.hos_id and b.sup_id=hsd.sup_id and b.sup_no=hsd.sup_no
				<if test="show_history == 1">
					and b.sup_no=hsd.sup_no
				</if>
				<if test="show_history == 0">
					and hsd.is_stop=0
				</if>
			left join hos_fac_dict e on mid.group_id = mid.group_id
	      		and mid.hos_id = e.hos_id and mid.fac_id = e.fac_id and mid.fac_no = e.fac_no
			left join mat_inv_unit_map f on a.group_id = f.group_id
				and a.hos_id = f.hos_id and a.copy_code = f.copy_code and a.inv_id = f.inv_id
			left join hos_package g on f.group_id = g.group_id
				and f.hos_id = g.hos_id and f.pack_code = g.pack_code
			left join mat_location_dict mld  on a.group_id = mld.group_id and a.hos_id = mld.hos_id
			      and a.copy_code = mld.copy_code and a.location_id = mld.location_id and mld.is_stop = 0
			left join mat_prod_cert mic on a.group_id=mic.group_id and a.hos_id=mic.hos_id and a.copy_code=mic.copy_code
			     and a.cert_id=mic.cert_id
			<where>
				<if test="group_id != null and group_id != ''">
					and a.group_id = #{group_id,jdbcType=INTEGER}
				</if>
				<if test="hos_id != null and hos_id != ''">
					and a.hos_id = #{hos_id,jdbcType=INTEGER}
				</if>
				<if test="copy_code != null and copy_code != ''">
					and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				</if>
				<if test="sup_id != null and sup_id != ''">
					and b.sup_id = #{sup_id,jdbcType=INTEGER}
				</if>
				<if test="store_id != null and store_id != ''">
					and b.store_id = #{store_id,jdbcType=INTEGER}
				</if>
				<if test="detailIds != null and detailIds != ''">
					and a.detail_id in (${detailIds})
				</if>
				<if test="begin_date != null and begin_date != '' and end_date!=null and end_date!='' ">
					and to_char(b.in_date,'yyyy-MM-dd') between #{begin_date} and #{end_date}
				</if>
				<if test="inv_code != null and inv_code != ''">
						and (
							mid.inv_code like '%${inv_code}%' or 
							mid.inv_name like '%${inv_code}%'
							or
							mid.bid_code like '%${inv_code}%' or
							mid.spell_code like '%${inv_code}%' or 
							mid.wbx_code like '%${inv_code}%' or
							mid.alias like '%${inv_code}%'
						)
				</if>
				and b.state = 3
				<if test="bus_type_code !=null and bus_type_code !='' ">
					and b.bus_type_code = #{bus_type_code}
				</if>
				<if test="in_no !=null and in_no !='' ">
					and b.in_no like '${in_no}%'
				</if>
			</where>
			order by mid.inv_code,a.batch_no,a.bar_code
		)
		select group_id,hos_id,copy_code,in_no,sup_code,sup_name,sup_id,sup_no,inv_id,inv_no,inv_code,inv_name,inv_model,unit_code,
           unit_name,price,sum(amount) amount,sum(amount_money) amount_money,sum(sell_money) sell_money,sum(sale_money) sale_money,
           fac_code,fac_name,fac_date,batch_no,bar_code,sell_price,location_id,location_name,note,cert_id,cert_code,disinfect_no,
           inva_date,disinfect_date,sn,is_per_bar,pack_code,pack_name,num_exchange,num,pack_price,sale_price
           <if test="detailIds == null or detailIds == ''">
				,detail_id
		   </if>
	    from d_tmp
	    group by group_id,hos_id,copy_code,in_no,sup_code,sup_name,sup_id,sup_no,inv_id,inv_no,inv_code,inv_name,inv_model,unit_code,
	          unit_name,price,fac_code,fac_name,fac_date,batch_no,bar_code,sell_price,location_id,location_name,note,cert_id,cert_code,disinfect_no,
	          inva_date,disinfect_date,sn,is_per_bar,pack_code,pack_name,num_exchange,num,pack_price,sale_price
	           <if test="detailIds == null or detailIds == ''">
				,detail_id
		   	  </if>
	    order by inv_code,batch_no,inva_date,bar_code
	    
	</select>
	
	<!-- 订单导入查询明细 -->
	<select id="queryMatAffiInOrderDetailN" parameterType="java.util.Map" resultType="java.util.Map"  >
		select md.group_id,md.hos_id,md.copy_code,md.order_id,md.order_detail_id,md.order_code,
		       mom.brif,mom.order_date,mom.maker,mom.sup_id,mom.sup_no,hsd.sup_code,hsd.sup_name,su.user_name as maker_name,
		       md.inv_id,md.inv_no,mid.inv_code,mid.inv_name,mid.inv_model,mid.unit_code,hu.unit_name,
		       nvl(mid.plan_price,0) as price ,(nvl(md.amount,0)-nvl(a_in.in_amount,0)) as order_amount,nvl(a_in.in_amount,0) as already_amount, 
		       (nvl(md.amount,0)-nvl(a_in.in_amount,0)) as amount,
		       nvl(mid.plan_price,0)*(nvl(md.amount,0)-nvl(a_in.in_amount,0)) amount_money,
		       hfd.fac_id,hfd.fac_no,hfd.fac_code,hfd.fac_name,mic.cert_code,mic.cert_id,
		       mid.is_bar,mid.is_batch,mid.is_per_bar,mid.is_quality,mid.is_disinfect,mid.is_highvalue,
		       mid.sell_price,msi.store_id,hsdd.store_no,hsdd.store_code,hsdd.store_name,
		       ms.stock_emp,t1.emp_code,t1.emp_name,ms.manager,t2.emp_code as manager_code,t2.emp_name as manager_name
		from mat_order_detail md 
		left join mat_order_main mom on md.group_id = mom.group_id and md.hos_id=mom.hos_id
		     and md.copy_code = mom.copy_code and md.order_id=mom.order_id
		left join mat_inv_dict mid on md.group_id = mid.group_id and md.hos_id = mid.hos_id 
		     and md.copy_code=mid.copy_code and md.inv_id = mid.inv_id and md.inv_no = mid.inv_no
		left join hos_unit hu on mid.group_id = hu.group_id and mid.hos_id=hu.hos_id 
		     and mid.unit_code = hu.unit_code and hu.is_stop = 0
		left join sys_user su on mom.group_id=su.group_id and mom.hos_id=su.hos_id
			 and su.user_id = mom.maker and su.is_stop=0
		left join(
         	select group_id,hos_id,copy_code,order_id,order_detail_id,sum(nvl(in_amount,0)) in_amount 
         	from mat_affi_in_order_rela 
         	<where>
         		<if test="group_id != null and group_id != ''">
					and group_id =#{group_id,jdbcType=INTEGER}
				</if>
				<if test="hos_id != null and hos_id != ''">
					and hos_id =#{hos_id,jdbcType=INTEGER}
				</if>
				<if test="copy_code != null and copy_code != ''">
					and copy_code =#{copy_code,jdbcType=VARCHAR}
				</if>
         	</where> 
         	group by group_id,hos_id,copy_code,order_id,order_detail_id
    	) a_in on md.group_id = a_in.group_id and md.hos_id=a_in.hos_id 
    		and md.copy_code= a_in.copy_code and md.order_id = a_in.order_id 
    		and md.order_detail_id = a_in.order_detail_id
		left join hos_sup_dict hsd on mom.group_id=hsd.group_id and mom.hos_id=hsd.hos_id 
		     and mom.sup_id = hsd.sup_id 
			 and hsd.is_stop = 0
		 left join hos_fac_dict hfd on mid.group_id = hfd.group_id and mid.hos_id = hfd.hos_id and mid.fac_id = hfd.fac_id 
			 and mid.fac_no = hfd.fac_no
		 left join (
		     select max(a.cert_id) AS cert_id,  a.inv_id, a.group_id, a.hos_id, a.copy_code
  			 from mat_prod_cert  b
    		 LEFT JOIN mat_prod_cert_inv a 
    		 	ON a.group_id = b.group_id
			 	AND a.hos_id = b.hos_id
			  	AND a.copy_code = b.copy_code
			  	AND a.cert_id = b.cert_id 
  			 WHERE a.group_id = #{group_id,jdbcType=INTEGER} 
			    AND a.hos_id = #{hos_id,jdbcType=INTEGER}
			    AND a.copy_code = #{copy_code,jdbcType=VARCHAR}
			    AND b.check_state = 2
			    AND b.is_new = 1
			 GROUP BY a.inv_id, a.group_id, a.hos_id, a.copy_code
			 ORDER BY a.inv_id
		) mcr on mid.group_id = mcr.group_id 
			and mid.hos_id = mcr.hos_id 
			and mid.copy_code = mcr.copy_code and mid.inv_id = mcr.inv_id
		left join mat_prod_cert mic on  mcr.group_id = mic.group_id 
			and mcr.hos_id=mic.hos_id
     		and mcr.copy_code= mic.copy_code 
     		and mcr.cert_id=mic.cert_id  
     	left join mat_store_inv  msi on mid.group_id = msi.group_id
         	and mid.hos_id= msi.hos_id and mid.copy_code=msi.copy_code 
         	and mid.inv_id=msi.inv_id and msi.is_apply=1
        left join hos_store_dict hsdd on msi.group_id=hsdd.group_id and msi.hos_id=hsdd.hos_id
        	and msi.store_id=hsdd.store_id and hsdd.is_stop=0 
        join mat_store ms on hsdd.group_id = ms.group_id and hsdd.hos_id = ms.hos_id and hsdd.store_id = ms.store_id 
		left join hos_emp_dict t1 on t1.group_id = ms.group_id
			and t1.hos_id = ms.hos_id and t1.emp_id = ms.stock_emp and t1.is_stop = 0
		left join hos_emp_dict t2 on t2.group_id = ms.group_id
			and t2.hos_id = ms.hos_id and t2.emp_id = ms.manager and t2.is_stop = 0 
		<where>
			<if test="group_id != null and group_id != ''">
				AND mom.group_id =#{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND mom.hos_id =#{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND mom.copy_code =#{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="begin_date != null and begin_date != ''">
				AND mom.order_date &gt;= #{begin_date}
			</if>
			<if test="end_date != null and end_date != ''">
				AND mom.order_date &lt;= #{end_date}
			</if>
			<if test="sup_id != null and sup_id != ''">
				AND mom.sup_id =#{sup_id,jdbcType=INTEGER}
			</if>
			<if test="stocker != null and stocker != ''">
				AND mom.stocker =#{stocker,jdbcType=INTEGER}
			</if>
			<if test="order_code != null and order_code != ''">
				AND mom.order_code like '%'||#{order_code,jdbcType=VARCHAR}||'%'
			</if>
			<if test="brif != null and brif != ''">
				AND mom.brif like '%${brif}%'
			</if>
			<if test="inv_code != null and inv_code !=''">
				AND (mid.inv_code like '${inv_code}%' or mid.inv_name like '%${inv_code}%')
			</if>
			<!-- d mid.is_com = 1
			and hsd.is_sup=0 -->
			<if test="is_closed !=null and is_closed !='' ">
				and md.is_closed = #{is_closed,jdbcType=INTEGER}
			</if>
			and mom.state = #{state}
			and (nvl(md.amount,0)-nvl(a_in.in_amount,0)) > 0
		</where>
		order by mid.inv_code
	</select>
	
	<!-- 更新订单状态 -->
	<select id="updateAffiOrderStates" parameterType="java.util.Map">
		update mat_order_main set state = #{state}
		<where>
			<if test="group_id != null and group_id !='' "> 
				and group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id !='' "> 
				and hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code !='' "> 
				and copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="orderIds != null and orderIds !='' "> 
				and order_id in (${orderIds})
			</if>
		</where>
	</select>
	
	<select id="queryAffiOrderIds" parameterType="java.util.Map" resultType="String">
		with order_tmp as (
				 select distinct group_id,hos_id,copy_code,order_id,sum(amount) order_amount
     			 from  mat_order_detail 
     			 <where>
					<if test="group_id != null and group_id !='' "> 
						and group_id = #{group_id,jdbcType=INTEGER}
					</if>
					<if test="hos_id != null and hos_id !='' "> 
						and hos_id = #{hos_id,jdbcType=INTEGER}
					</if>
					<if test="copy_code != null and copy_code !='' "> 
						and copy_code = #{copy_code,jdbcType=VARCHAR}
					</if>
				</where>
			group by group_id,hos_id,copy_code,order_id
		),in_tmp as (
			select group_id,hos_id,copy_code,order_id,sum(in_amount) in_amount 
			from mat_affi_in_order_rela
			<where>
				<if test="group_id != null and group_id !='' "> 
					and group_id = #{group_id,jdbcType=INTEGER}
				</if>
				<if test="hos_id != null and hos_id !='' "> 
					and hos_id = #{hos_id,jdbcType=INTEGER}
				</if>
				<if test="copy_code != null and copy_code !='' "> 
					and copy_code = #{copy_code,jdbcType=VARCHAR}
				</if>
				<if test="flag ==1">
					and in_id = #{in_id,jdbcType=INTEGER}
				</if>
			</where>
			group by group_id,hos_id,copy_code,order_id
		)
		
		select to_char(wm_concat(ot.order_id))
		from order_tmp ot
		left join in_tmp it on ot.group_id=it.group_id and ot.hos_id=it.hos_id 
			and ot.copy_code=it.copy_code and ot.order_id =it.order_id
		left join mat_order_main mom on ot.group_id = mom.group_id and ot.hos_id = mom.hos_id
		    and ot.copy_code = mom.copy_code and ot.order_id = mom.order_id
		<where>
			<if test="whereSql !=null and whereSql !='' ">
				${whereSql}
			</if>
			<if test="state != null and state !='' ">
				and mom.state = #{state}
			</if>
		</where>
	</select>
	
	<!-- 删除入库单时查询订单id -->
	<select id="queryMatAffiOrderId" parameterType="java.util.List" resultType="String">
		with list_temp as (
			<foreach collection="list" item="item" index="index" separator=" union all " >
				select    
					#{item.group_id,jdbcType=INTEGER} as group_id, 
					#{item.hos_id,jdbcType=INTEGER} as hos_id, 
					#{item.copy_code,jdbcType=VARCHAR} as copy_code,
					#{item.in_id,jdbcType=VARCHAR} as in_id
				from dual
			</foreach>
		)
		select to_char(wm_concat(order_id)) 
		from (
			select distinct b.order_id
      		from list_temp a
      		left join mat_affi_in_order_rela b on a.group_id=b.group_id and a.hos_id=b.hos_id 
        		and a.copy_code=b.copy_code and a.in_id = b.in_id
		)
	</select>
	
	<!-- 获取删除的order_id -->
	<select id="queryAffiDeleteOldIds"  parameterType="java.util.Map" resultType="String">
		select  to_char(wm_concat(order_id)) 
		from mat_affi_in_order_rela
		<where>
			<if test="group_id != null and group_id !='' "> 
				and group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id !='' "> 
				and hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code !='' "> 
				and copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="in_id != null and in_id !='' "> 
				and in_id = #{in_id,jdbcType=INTEGER}
			</if>
			<if test="orderNewIds != null and orderNewIds !='' "> 
				and order_id not in (${orderNewIds})
			</if>
		</where>
	</select>
	
	<!-- 批量添加选择材料 -->
	<select id="queryMatAffiInInvBatch" parameterType="java.util.Map" resultType="java.util.Map"  >
		select mid.group_id,mid.hos_id,mid.copy_code,mid.inv_id,mid.inv_no,mid.inv_code,mid.inv_name,
       		mid.inv_model,mid.unit_code,hu.unit_name,mid.plan_price as price,hfd.fac_code,hfd.fac_name,
       		g.pack_code,g.pack_name,mid.is_per_bar,mic.cert_code,mic.cert_id
		from mat_inv_dict mid
		left join hos_unit hu on mid.group_id=hu.group_id and mid.hos_id=hu.hos_id and mid.unit_code=hu.unit_code
		left join mat_inv_unit_map mim on mid.group_id =mim.group_id and mid.hos_id = mim.hos_id and mid.copy_code = mim.copy_code
		      and mid.inv_id =mim.inv_id
		left join hos_package g on mim.group_id = g.group_id and mim.hos_id = g.hos_id and mim.pack_code = g.pack_code
		left join mat_store_inv msi on mid.group_id=msi.group_id and mid.hos_id=msi.hos_id and mid.copy_code=msi.copy_code
		     and mid.inv_id=msi.inv_id 
		left join mat_inv_sup mis on mid.group_id=mis.group_id and mid.hos_id=mis.hos_id and mid.copy_code=mis.copy_code
		     and mid.inv_id=mis.inv_id and mis.is_default=1
		left join hos_fac_dict hfd on mid.group_id=hfd.group_id and mid.hos_id=hfd.hos_id and mid.fac_id=hfd.fac_id and mid.fac_no=hfd.fac_no
		left join mat_location_inv mli on mid.group_id = mli.group_id and mid.hos_id = mli.hos_id and mid.copy_code = mli.copy_code
		      and mid.inv_id = mli.inv_id
		left join mat_location_dict mld on mli.group_id = mld.group_id and mli.hos_id = mld.hos_id and mli.copy_code = mld.copy_code
		      and mli.location_id = mld.location_id and mld.is_stop = 0
		left join (
			select group_id,hos_id,copy_code,inv_id,max(cert_id) cert_id
			from mat_prod_cert_inv
			<where>
				<if test="group_id != null and group_id !='' "> 
					and group_id = #{group_id,jdbcType=INTEGER}
				</if>
				<if test="hos_id != null and hos_id !='' "> 
					and hos_id = #{hos_id,jdbcType=INTEGER}
				</if>
				<if test="copy_code != null and copy_code !='' "> 
					and copy_code = #{copy_code,jdbcType=VARCHAR}
				</if>
			</where>
			group by group_id,hos_id,copy_code,inv_id
		) micr on mid.group_id=micr.group_id and mid.hos_id=micr.hos_id and mid.copy_code=micr.copy_code
		     and mid.inv_id=micr.inv_id 
		left join mat_prod_cert mic  on micr.group_id = mic.group_id and micr.hos_id = mic.hos_id and micr.copy_code = mic.copy_code
		     and micr.cert_id = mic.cert_id and mic.check_state = 2
		<where>
			<if test="group_id != null and group_id !='' "> 
				and mid.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id !='' "> 
				and mid.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code !='' "> 
				and mid.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="store_id != null and store_id !='' "> 
				and msi.store_id = #{store_id,jdbcType=INTEGER}
			</if>
			<if test="sup_id != null and sup_id !='' "> 
				and mis.sup_id = #{sup_id,jdbcType=INTEGER}
			</if>
			<if test="inv_code != null and inv_code != ''">
				and (
						mid.inv_code like '%${inv_code}%'
						or upper(mid.inv_name) like '%${inv_code}%'
				     or upper(mid.spell_code) like '%${inv_code}%'
				     or upper(mid.wbx_code) like '%${inv_code}%'
				     or lower(mid.spell_code) like '%${inv_code}%'
				     or lower(mid.wbx_code) like '%${inv_code}%'
				     or lower(mid.inv_name) like '%${inv_code}%')
			</if>
			and mid.is_com = 1 
			and mid.use_state = 1
			and mid.is_stop=0
		</where>
		order by mid.inv_code
	</select>
	
	<!-- 批量选择材料生成入库单 --> 
	<select id="queryMatAffiInInvBatchDetail" parameterType="java.util.List" resultType="java.util.Map">
		with list_temp as (
			<foreach collection="list" item="item" index="index" separator=" union all " >
				select    
					<if test="item.inv_id != null and item.inv_id != ''">
						#{item.inv_id,jdbcType=INTEGER} as inv_id,
					</if>
					<if test="item.inv_no != null or item.inv_no != ''">
						#{item.inv_no,jdbcType=INTEGER} as inv_no,
					</if>
					<if test="item.store_id != null or item.store_id != ''">
						#{item.store_id,jdbcType=INTEGER} as store_id,
					</if>
					<if test="item.sup_id != null or item.sup_id != ''">
						#{item.sup_id,jdbcType=INTEGER} as sup_id,
					</if>
					#{item.group_id,jdbcType=INTEGER} as group_id, 
					#{item.hos_id,jdbcType=INTEGER} as hos_id, 
					#{item.copy_code,jdbcType=VARCHAR} as copy_code
				from dual
			</foreach>
		)
		select lt.group_id,lt.hos_id,lt.copy_code,lt.inv_id,lt.inv_no,
      		mid.inv_code,mid.inv_name,mid.inv_model,mid.unit_code,hu.unit_name,
      		mid.plan_price as price,hfd.fac_code,hfd.fac_name,mid.sell_price,
          	g.pack_code,g.pack_name pack_name, f.map_amount num_exchange,
          	mic.cert_code,mic.cert_id,mld.location_id,mld.location_name,
          	mid.is_batch,mid.is_bar,mid.is_per_bar,mid.is_quality,mid.is_disinfect,mid.is_highvalue
		from list_temp lt
		left join mat_inv_dict mid on lt.group_id=mid.group_id and lt.hos_id=mid.hos_id and lt.copy_code=mid.copy_code
			and lt.inv_id=mid.inv_id and lt.inv_no=mid.inv_no
		left join hos_unit hu on mid.group_id=hu.group_id and mid.hos_id=hu.hos_id and mid.unit_code=hu.unit_code
		left join mat_inv_unit_map mim on mid.group_id =mim.group_id and mid.hos_id = mim.hos_id and mid.copy_code = mim.copy_code
		      and mid.inv_id =mim.inv_id
		left join hos_package g on mim.group_id = g.group_id and mim.hos_id = g.hos_id and mim.pack_code = g.pack_code
		left join mat_inv_unit_map f on lt.group_id = f.group_id and lt.hos_id = f.hos_id and lt.copy_code = f.copy_code 
			  and lt.inv_id = f.inv_id
		left join mat_store_inv msi on mid.group_id=msi.group_id and mid.hos_id=msi.hos_id and mid.copy_code=msi.copy_code
		     and mid.inv_id=msi.inv_id and lt.store_id=msi.store_id and msi.is_apply=1
		left join mat_inv_sup mis on mid.group_id=mis.group_id and mid.hos_id=msi.hos_id and mid.copy_code=mis.copy_code
		     and mid.inv_id=mis.inv_id and lt.sup_id=mis.sup_id and mis.is_default=1
		left join hos_fac_dict hfd on mid.group_id=hfd.group_id and mid.hos_id=hfd.hos_id and mid.fac_id=hfd.fac_id and mid.fac_no=hfd.fac_no
		left join mat_location_inv mli on mid.group_id = mli.group_id and mid.hos_id = mli.hos_id and mid.copy_code = mli.copy_code
		      and mid.inv_id = mli.inv_id
		left join mat_location_dict mld on mli.group_id = mld.group_id and mli.hos_id = mld.hos_id and mli.copy_code = mld.copy_code
		      and mli.location_id = mld.location_id and mld.is_stop = 0
		left join (
			select a.group_id,a.hos_id,a.copy_code,a.inv_id,max(cert_id) cert_id
			from mat_prod_cert_inv a
			left join list_temp b on a.group_id=b.hos_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
			group by a.group_id,a.hos_id,a.copy_code,a.inv_id
		) micr on mid.group_id=micr.group_id and mid.hos_id=micr.hos_id and mid.copy_code=micr.copy_code
		     and mid.inv_id=micr.inv_id 
		left join mat_prod_cert mic  on micr.group_id = mic.group_id and micr.hos_id = mic.hos_id and micr.copy_code = mic.copy_code
		     and micr.cert_id = mic.cert_id and mic.check_state = 2
		where mid.use_state = 1
			and mid.is_com = 1
		order by mid.inv_code 
	</select>
	 
	<!-- 显示明细 -->
	<select id="queryDetails" parameterType="java.util.Map" resultType="java.util.Map" >
		with detail_list as (
		     select mid.group_id,mid.hos_id,mid.copy_code,mid.in_id,to_char(mid.in_no) in_no,mim.store_id,mim.store_no,hd.store_code,hd.store_name,
		       mim.brief,hsd.sup_name,mim.bus_type_code,mbt.bus_type_name,mim.come_from, m.field_desc,to_char(mim.in_date,'yyyy-MM-dd') in_date,mim.maker, e.user_name as maker_name,
		       to_char(mim.confirm_date,'yyyy-MM-dd') confirm_date,f.user_name as confirmer_name,mim.state, g.field_desc as state_name,i.emp_name stocker_name,
		       mdd.inv_id,mdd.inv_no,mdd.inv_code,mdd.inv_name,mdd.inv_model,hu.unit_name,mid.price,mid.amount,
		       mid.amount_money,mid.batch_no,mid.bar_code,hfd.fac_name
		  from mat_affi_in_detail mid 
		  left join mat_affi_in mim on mid.group_id=mim.group_id and mid.hos_id=mim.hos_id and mid.copy_code=mim.copy_code
		       and mid.in_id=mim.in_id
		  left join hos_sup_dict hsd on mim.group_id=hsd.group_id and mim.hos_id=hsd.hos_id and mim.sup_id=hsd.sup_id
		       <if test="show_history == 1">
			    	and mim.sup_no=hsd.sup_no 
			   </if>
			   <if test="show_history == 0">
		         	and hsd.is_stop=0
			   </if> 
		  left join hos_store_dict hd on mim.group_id=hd.group_id and mim.hos_id=hd.hos_id and mim.store_id=hd.store_id
		       <if test="show_history == 1">
			    	and mim.store_no=hd.store_no 
			   </if>
			   <if test="show_history == 0">
		         	and hd.is_stop=0
			   </if> 
		  left join mat_sys_list g on g.table_code = 'MAT_IN_MAIN' and g.field_code = 'STATE' and mim.state = g.field_value
		  left join mat_data_dict m on m.data_code='04014' and mim.come_from = m.field_value and m.field_code='IN_FROM'
		  left join mat_bus_type mbt on mim.bus_type_code=mbt.bus_type_code and mbt.is_stop=0
		  left join hos_emp i on mim.group_id = i.group_id and mim.hos_id = i.hos_id and mim.stocker = i.emp_id
		  left join sys_user e on mim.group_id = e.group_id and mim.hos_id = e.hos_id and mim.maker = e.user_id
		  left join sys_user f  on mim.group_id = f.group_id  and mim.hos_id = f.hos_id and mim.confirmer = f.user_id
		  left join mat_inv_dict mdd on mid.group_id=mdd.group_id  and mid.hos_id=mdd.hos_id and mid.copy_code=mdd.copy_code
		       and mid.inv_id=mdd.inv_id  and mid.inv_no=mdd.inv_no 
		  left join hos_unit hu on mdd.group_id=hu.group_id and mdd.hos_id=hu.hos_id and mdd.unit_code=hu.unit_code and hu.is_stop=0
		  left join hos_fac_dict hfd on mdd.group_id=hfd.group_id and mdd.hos_id=hfd.hos_id and mdd.fac_id=hfd.fac_id and mdd.fac_no = hfd.fac_no
		  <where>
		  			mim.group_id = #{group_id,jdbcType=INTEGER}
				AND mim.hos_id = #{hos_id,jdbcType=INTEGER}
				AND mim.copy_code = #{copy_code,jdbcType=VARCHAR}
				<if test="in_dateB != null and in_dateB != ''">
					AND to_char(mim.in_date) &gt;= to_date(#{in_dateB},'yyyy-MM-dd')
				</if>
				<if test="in_dateE != null and in_dateE != ''">
					AND to_char(mim.in_date) &lt;= to_date(#{in_dateE},'yyyy-MM-dd')
				</if>
				<if test="confirm_dateB != null and confirm_dateB != ''">
					AND to_char(mim.confirm_date) &gt;= to_date(#{confirm_dateB},'yyyy-MM-dd')
				</if>
				<if test="confirm_dateE != null and confirm_dateE != ''">
					AND to_char(mim.confirm_date) &lt;= to_date(#{confirm_dateE},'yyyy-MM-dd')
				</if>
				<if test="bus_type_code != null and bus_type_code != ''">
					AND mim.bus_type_code = #{bus_type_code,jdbcType=VARCHAR}
				</if>
				<if test="state != null and state != ''">
					AND mim.state = #{state,jdbcType=VARCHAR}
				</if>
				<if test="store_id != null and store_id != ''">
					AND mim.store_id = #{store_id,jdbcType=VARCHAR}
				</if>
				<if test="sup_id != null and sup_id != ''">
					AND mim.sup_id = #{sup_id,jdbcType=VARCHAR}
				</if>
				<if test="batch_no != null and batch_no != ''">
					AND mid.batch_no like '%${batch_no}%'
				</if>
				<if test="bar_code != null and bar_code != ''">
					AND mid.bar_code like '%${bar_code}%'
				</if>
				<if test="in_no != null and in_no != ''">
					AND mim.in_no like '${in_no}%'
				</if>
				<if test="brief != null and brief != ''">
					AND mim.brief like '%${brief}%'
				</if>
				<if test="inv_code != null and inv_code != ''">
					AND (
							 mdd.inv_code like '%${inv_code}%'
							or upper(mdd.inv_name) like '%${inv_code}%'
							or upper(mdd.inv_model) like '%${inv_code}%'
							or upper(mdd.spell_code) like '%${inv_code}%'
							or upper(mdd.wbx_code) like '%${inv_code}%'
							or lower(mdd.spell_code) like '%${inv_code}%'
							or lower(mdd.wbx_code) like '%${inv_code}%'
							or lower(mdd.inv_name) like '%${inv_code}%'
						
					)
					
				</if>
				<!-- 添加用户数据权限 -->
				and exists (
					select 1 from v_user_data_perm vudp 
					where mim.group_id=vudp.group_id and mim.hos_id=vudp.hos_id 
						and to_char(mim.store_id)=vudp.perm_code and vudp.is_read=1 and vudp.is_write = 1
		      			and vudp.table_code='HOS_STORE_DICT'
						and vudp.user_id=#{user_id}
				)
		  </where>
		),sum_list as (
		   select null group_id,null hos_id,null copy_code,null in_id,'合计' in_no, null store_id, null store_no,null store_code,null store_name,
		       null brief,null sup_name,null bus_type_code,null bus_type_name,null come_from, null field_desc,null in_date,null maker, null maker_name,
		       null confirm_date,null confirmer_name,null state, null  state_name,null stocker_name,
		       null inv_id,null inv_no,null inv_code,null inv_name,null inv_model,null unit_name,null price,sum(amount) amount,
		       sum(amount_money) amount_money,null batch_no,null bar_code,null fac_name
		   from detail_list
		)
		select group_id,hos_id,copy_code, in_id, in_no,  store_id,  store_no, store_code, store_name,
		        brief, sup_name,bus_type_code, bus_type_name, come_from,  field_desc, in_date, maker,  maker_name,
		        confirm_date, confirmer_name, state,   state_name, stocker_name,
		         inv_code, inv_name, inv_model, unit_name, price,amount,
		        amount_money, batch_no, bar_code, fac_name
		from detail_list
		union all
		select  group_id,hos_id,copy_code, in_id,in_no,  store_id,  store_no, store_code, store_name,
		        brief, sup_name,bus_type_code, bus_type_name, come_from,  field_desc, in_date, maker,  maker_name,
		        confirm_date, confirmer_name, state,   state_name, stocker_name,
		        inv_code, inv_name, inv_model, unit_name, price,amount,
		        amount_money, batch_no, bar_code, fac_name 
		from sum_list
		order by in_id desc,in_no,in_date,inv_code
	</select>
	
	 
	
</mapper>

