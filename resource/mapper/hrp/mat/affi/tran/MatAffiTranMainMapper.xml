<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.mat.dao.affi.tran.MatAffiTranMainMapper">

	<resultMap id="matAffiTranMain" type="com.chd.hrp.mat.entity.MatAffiTranMain">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="tran_id" column="tran_id" />
		<result property="tran_no" column="tran_no" />
		<result property="year" column="year" />
		<result property="month" column="month" />
		<result property="bus_type" column="bus_type" />
		<result property="tran_method" column="tran_method" />
		<result property="tran_type" column="tran_type" />
		<result property="out_hos_id" column="out_hos_id" />
		<result property="out_hos_no" column="out_hos_no" />
		<result property="in_hos_id" column="in_hos_id" />
		<result property="in_hos_no" column="in_hos_no" />
		
		<result property="out_store_id" column="out_store_id" />
		<result property="out_store_no" column="out_store_no" />
		<result property="out_store_code" column="out_store_code" />
		<result property="out_store_name" column="out_store_name" />
		
		
		<result property="in_store_id" column="in_store_id" />
		<result property="in_store_no" column="in_store_no" />
		<result property="in_store_code" column="in_store_code" />
		<result property="in_store_name" column="in_store_name" />
		
		<result property="brief" column="brief" />
		<result property="tran_date" column="tran_date" />
		<result property="maker" column="maker" />
		<result property="maker_name" column="maker_name" />
		<result property="checker" column="checker" />
		<result property="check_date" column="check_date" />
		<result property="confirmer" column="confirmer" />
		<result property="confirm_date" column="confirm_date" />
		<result property="state" column="state" />
		<result property="checker_name" column="checker_name" />
		<result property="confirmer_name" column="confirmer_name" />
	</resultMap>

	<select id="queryMatAffiTranMainSeq" resultType="java.lang.Long" useCache="false" flushCache="true">
		select MAT_AFFI_TRAN_MAIN_SEQ.nextval from dual
	</select>
	
	<insert id="add" useGeneratedKeys="true">

		INSERT INTO MAT_AFFI_TRAN_MAIN (
		<trim suffix="" suffixOverrides=",">
			<if test="group_id != null and group_id != ''">group_id,</if>
			<if test="hos_id != null and hos_id != ''">hos_id,</if>
			<if test="copy_code != null and copy_code != ''">copy_code,</if>
			<if test="tran_id != null and tran_id != ''">tran_id,</if>
			<if test="tran_no != null and tran_no != ''">tran_no,</if>
			<if test="year != null and year != ''">year,</if>
			<if test="month != null and month != ''">month,</if>
			<if test="bus_type != null and bus_type != ''">bus_type,</if>
			<if test="tran_method != null and tran_method != ''">tran_method,</if>
			<if test="tran_type != null and tran_type != ''">tran_type,</if>
			<if test="out_hos_id != null and out_hos_id != ''">out_hos_id,</if>
			<if test="out_store_id != null and out_store_id != ''">out_store_id,</if>
			<if test="out_store_no != null and out_store_no != ''">out_store_no,</if>
			<if test="in_hos_id != null and in_hos_id != ''">in_hos_id,</if>
			<if test="in_store_id != null and in_store_id != ''">in_store_id,</if>
			<if test="in_store_no != null and in_store_no != ''">in_store_no,</if>
			<if test="brief != null ">brief,</if>
			<if test="tran_date != null and tran_date != ''">tran_date,</if>
			<if test="maker != null and maker != ''">maker,</if>
			<if test="checker != null and checker != ''">checker,</if>
			<if test="check_date != null and check_date != ''">check_date,</if>
			<if test="confirmer != null and confirmer != ''">confirmer,</if>
			<if test="confirm_date != null and confirm_date != ''">confirm_date,</if>
			<if test="state != null and state != ''">state,</if>
		</trim>
		) VALUES (
		<trim suffix="" suffixOverrides=",">
			<if test="group_id != null and group_id != ''">#{group_id,jdbcType=INTEGER},</if>
			<if test="hos_id != null and hos_id != ''">#{hos_id,jdbcType=INTEGER},</if>
			<if test="copy_code != null and copy_code != ''">#{copy_code,jdbcType=VARCHAR},</if>
			<if test="tran_id != null and tran_id != ''">#{tran_id,jdbcType=INTEGER},</if>
			<if test="tran_no != null and tran_no != ''">#{tran_no,jdbcType=VARCHAR},</if>
			<if test="year != null and year != ''">#{year,jdbcType=VARCHAR},</if>
			<if test="month != null and month != ''">#{month,jdbcType=VARCHAR},</if>
			<if test="bus_type != null and bus_type != ''">#{bus_type,jdbcType=INTEGER},</if>
			<if test="tran_method != null and tran_method != ''">#{tran_method,jdbcType=INTEGER},</if>
			<if test="tran_type != null and tran_type != ''">#{tran_type,jdbcType=INTEGER},</if>
			<if test="out_hos_id != null and out_hos_id != ''">#{out_hos_id,jdbcType=INTEGER},</if>
			<if test="out_store_id != null and out_store_id != ''">#{out_store_id,jdbcType=INTEGER},</if>
			<if test="out_store_no != null and out_store_no != ''">#{out_store_no,jdbcType=INTEGER},</if>
			<if test="in_hos_id != null and in_hos_id != ''">#{in_hos_id,jdbcType=INTEGER},</if>
			<if test="in_store_id != null and in_store_id != ''">#{in_store_id,jdbcType=INTEGER},</if>
			<if test="in_store_no != null and in_store_no != ''">#{in_store_no,jdbcType=INTEGER},</if>
			<if test="brief != null ">#{brief,jdbcType=VARCHAR},</if>
			<if test="tran_date != null and tran_date != ''">to_date(#{tran_date,jdbcType=DATE},'yyyy/MM/dd'),</if>
			<if test="maker != null and maker != ''">#{maker,jdbcType=INTEGER},</if>
			<if test="checker != null and checker != ''">#{checker,jdbcType=INTEGER},</if>
			<if test="check_date != null and check_date != ''">to_date(#{check_date,jdbcType=DATE},'yyyy/MM/dd'),</if>
			<if test="confirmer != null and confirmer != ''">#{confirmer,jdbcType=INTEGER},</if>
			<if test="confirm_date != null and confirm_date != ''">to_date(#{confirm_date,jdbcType=DATE},'yyyy/MM/dd'),</if>
			<if test="state != null and state != ''">#{state,jdbcType=INTEGER}</if>
		</trim>
		)
	</insert>
	<insert id="addBatch" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
		INSERT INTO MAT_AFFI_TRAN_MAIN (
		<if test="item.group_id != null and item.group_id != ''">group_id,</if>
			<if test="item.hos_id != null and item.hos_id != ''">hos_id,</if>
			<if test="item.copy_code != null and item.copy_code != ''">copy_code,</if>
			<if test="item.tran_id != null and item.tran_id != ''">tran_id,</if>
			<if test="item.tran_no != null and item.tran_no != ''">tran_no,</if>
			<if test="item.year != null and item.year != ''">year,</if>
			<if test="item.month != null and item.month != ''">month,</if>
			<if test="item.bus_type !=null and item.bus_type !='' ">bus_type,</if>
			<if test="item.tran_method != null and item.tran_method != ''">tran_method,</if>
			<if test="item.tran_type != null and item.tran_type != ''">tran_type,</if>
			<if test="item.out_hos_id != null and item.out_hos_id != ''">out_hos_id,</if>
			<if test="item.out_store_id != null and item.out_store_id != ''">out_store_id,</if>
			<if test="item.out_store_no != null and item.out_store_no != ''">out_store_no,</if>
			<if test="item.in_hos_id != null and item.in_hos_id != ''">in_hos_id,</if>
			<if test="item.in_store_id != null and item.in_store_id != ''">in_store_id,</if>
			<if test="item.in_store_no != null and item.in_store_no != ''">in_store_no,</if>
			<if test="item.brief != null ">brief,</if>
			<if test="item.tran_date != null and item.tran_date != ''">tran_date,</if>
			<if test="item.maker != null and item.maker != ''">maker,</if>
			<if test="item.checker != null and item.checker != ''">checker,</if>
			<if test="item.check_date != null and item.check_date != ''">check_date,</if>
			<if test="item.confirmer != null and item.confirmer != ''">confirmer,</if>
			<if test="item.confirm_date != null and item.confirm_date != ''">confirm_date,</if>
			<if test="item.state != null and item.state != ''">state</if>
		) values(
			<if test="item.group_id != null and item.group_id != ''">#{item.group_id,jdbcType=INTEGER},</if>
			<if test="item.hos_id != null and item.hos_id != ''">#{item.hos_id,jdbcType=INTEGER},</if>
			<if test="item.copy_code != null and item.copy_code != ''">#{item.copy_code,jdbcType=VARCHAR},</if>
			<if test="item.tran_id != null and item.tran_id != ''">#{item.tran_id,jdbcType=INTEGER},</if>
			<if test="item.tran_no != null and item.tran_no != ''">#{item.tran_no,jdbcType=VARCHAR},</if>
			<if test="item.year != null and item.year != ''">#{item.year,jdbcType=VARCHAR},</if>
			<if test="item.month != null and item.month != ''">#{item.month,jdbcType=VARCHAR},</if>
			<if test="item.bus_type !=null and item.bus_type !='' ">#{item.bus_type,jdbcType=INTEGER},</if>
			<if test="item.tran_method != null and item.tran_method != ''">#{item.tran_method,jdbcType=INTEGER},</if>
			<if test="item.tran_type != null and item.tran_type != ''">#{item.tran_type,jdbcType=INTEGER},</if>
			<if test="item.out_hos_id != null and item.out_hos_id != ''">#{item.out_hos_id,jdbcType=INTEGER},</if>
			<if test="item.out_store_id != null and item.out_store_id != ''">#{item.out_store_id,jdbcType=INTEGER},</if>
			<if test="item.out_store_no != null and item.out_store_no != ''">#{item.out_store_no,jdbcType=INTEGER},</if>
			<if test="item.in_hos_id != null and item.in_hos_id != ''">#{item.in_hos_id,jdbcType=INTEGER},</if>
			<if test="item.in_store_id != null and item.in_store_id != ''">#{item.in_store_id,jdbcType=INTEGER},</if>
			<if test="item.in_store_no != null and item.in_store_no != ''">#{item.in_store_no,jdbcType=INTEGER},</if>
			<if test="item.brief != null ">#{item.brief,jdbcType=VARCHAR},</if>
			<if test="item.tran_date != null and item.tran_date != ''">#{item.tran_date,jdbcType=DATE},</if>
			<if test="item.maker != null and item.maker != ''">#{item.maker,jdbcType=INTEGER},</if>
			<if test="item.checker != null and item.checker != ''">#{item.checker,jdbcType=INTEGER},</if>
			<if test="item.check_date != null and item.check_date != ''">#{item.check_date,jdbcType=DATE},</if>
			<if test="item.confirmer != null and item.confirmer != ''">#{item.confirmer,jdbcType=INTEGER},</if>
			<if test="item.confirm_date != null and item.confirm_date != ''">#{item.confirm_date,jdbcType=DATE},</if>
			<if test="item.state != null and item.state != ''">#{item.state,jdbcType=INTEGER}</if>
		)
		</foreach>
	</insert>

	<update id="update" parameterType="java.util.Map">

		UPDATE MAT_AFFI_TRAN_MAIN
		<trim prefix="SET" suffixOverrides=",">
			<if test="tran_no != null and tran_no != ''">tran_no = #{tran_no,jdbcType=VARCHAR},</if>
			<if test="year != null and year != ''">year = #{year,jdbcType=VARCHAR},</if>
			<if test="month != null and month != ''">month = #{month,jdbcType=VARCHAR},</if>
			<if test="bus_type != null">bus_type = #{bus_type,jdbcType=INTEGER},</if>
			<if test="tran_method != null and tran_method != ''">tran_method = #{tran_method,jdbcType=INTEGER},</if>
			<if test="tran_type != null and tran_type != ''">tran_type = #{tran_type,jdbcType=INTEGER},</if>
			<if test="out_hos_id != null and out_hos_id != ''">out_hos_id = #{out_hos_id,jdbcType=INTEGER},</if>
			<if test="out_store_id != null and out_store_id != ''">out_store_id = #{out_store_id,jdbcType=INTEGER},</if>
			<if test="out_store_no != null and out_store_no != ''">out_store_no = #{out_store_no,jdbcType=INTEGER},</if>
			<if test="in_hos_id != null and in_hos_id != ''">in_hos_id = #{in_hos_id,jdbcType=INTEGER},</if>
			<if test="in_store_id != null and in_store_id != ''">in_store_id = #{in_store_id,jdbcType=INTEGER},</if>
			<if test="in_store_no != null and in_store_no != ''">in_store_no = #{in_store_no,jdbcType=INTEGER},</if>
			<if test="brief != null ">brief = #{brief,jdbcType=VARCHAR},</if>
			<if test="tran_date != null and tran_date != ''">tran_date = #{tran_date,jdbcType=DATE},</if>
			<if test="maker != null and maker != ''">maker = #{maker,jdbcType=INTEGER},</if>
			<if test="checker != null and checker != ''">checker = #{checker,jdbcType=INTEGER},</if>
			<if test="check_date != null and check_date != ''">check_date = #{check_date,jdbcType=DATE},</if>
			<if test="confirmer != null and confirmer != ''">confirmer = #{confirmer,jdbcType=INTEGER},</if>
			<if test="confirm_date != null and confirm_date != ''">confirm_date = #{confirm_date,jdbcType=DATE},</if>
			<if test="state != null and state != ''">state = #{state,jdbcType=INTEGER},</if>
		</trim>
		<where>
			<if test="group_id != null and group_id != ''">AND group_id = #{group_id,jdbcType=INTEGER}</if>
			<if test="hos_id != null and hos_id != ''">AND hos_id = #{hos_id,jdbcType=INTEGER}</if>
			<if test="copy_code != null and copy_code != ''">AND copy_code = #{copy_code,jdbcType=VARCHAR}</if>
			<if test="tran_id != null and tran_id != ''">AND tran_id = #{tran_id,jdbcType=INTEGER}</if>
		</where>
	</update>
	<update id="updateBatch" parameterType="java.util.List">

		<foreach collection="list" item="item" index="index" open="begin"
			close=";end;" separator=";">
			UPDATE MAT_AFFI_TRAN_MAIN
			<trim prefix="SET" suffixOverrides=",">
				<if test="item.tran_no != null and item.tran_no != ''">tran_no = #{item.tran_no,jdbcType=VARCHAR},</if>
				<if test="item.year != null and item.year != ''">year = #{item.year,jdbcType=VARCHAR},</if>
				<if test="item.month != null and item.month != ''">month = #{item.month,jdbcType=VARCHAR},</if>
				<if test="item.bus_type !=null">bus_type = #{item.bus_type,jdbcType=INTEGER}</if>
				<if test="item.tran_method != null and item.tran_method != ''">tran_method = #{item.tran_method,jdbcType=INTEGER},</if>
				<if test="item.tran_type != null and item.tran_type != ''">tran_type = #{item.tran_type,jdbcType=INTEGER},</if>
				<if test="item.out_hos_id != null and item.out_hos_id != ''">out_hos_id = #{item.out_hos_id,jdbcType=INTEGER},</if>
				<if test="item.out_store_id != null and item.out_store_id != ''">out_store_id = #{item.out_store_id,jdbcType=INTEGER},</if>
				<if test="item.out_store_no != null and item.out_store_no != ''">out_store_no = #{item.out_store_no,jdbcType=INTEGER},</if>
				<if test="item.in_hos_id != null and item.in_hos_id != ''">in_hos_id = #{item.in_hos_id,jdbcType=INTEGER},</if>
				<if test="item.in_store_id != null and item.in_store_id != ''">in_store_id = #{item.in_store_id,jdbcType=INTEGER},</if>
				<if test="item.in_store_no != null and item.in_store_no != ''">in_store_no = #{item.in_store_no,jdbcType=INTEGER},</if>
				<if test="item.brief != null ">brief = #{item.brief,jdbcType=VARCHAR},</if>
				<if test="item.tran_date != null and item.tran_date != ''">tran_date = #{item.tran_date,jdbcType=DATE},</if>
				<if test="item.maker != null and item.maker != ''">maker = #{item.maker,jdbcType=INTEGER},</if>
				<if test="item.checker != null and item.checker != ''">checker = #{item.checker,jdbcType=INTEGER},</if>
				<if test="item.check_date != null and item.check_date != ''">check_date = #{item.check_date,jdbcType=DATE},</if>
				<if test="item.confirmer != null and item.confirmer != ''">confirmer = #{item.confirmer,jdbcType=INTEGER},</if>
				<if test="item.confirm_date != null and item.confirm_date != ''">confirm_date = #{item.confirm_date,jdbcType=DATE},</if>
				<if test="item.state != null and item.state != ''">state = #{item.state,jdbcType=INTEGER},</if>
			</trim>
			<where>
				<if test="item.group_id != null and item.group_id != ''">AND group_id = #{item.group_id,jdbcType=INTEGER}</if>
				<if test="item.hos_id != null and item.hos_id != ''">AND hos_id = #{item.hos_id,jdbcType=INTEGER}</if>
				<if test="item.copy_code != null and item.copy_code != ''">AND copy_code = #{item.copy_code,jdbcType=VARCHAR}</if>
				<if test="item.tran_id != null and item.tran_id != ''">AND tran_id = #{item.tran_id,jdbcType=INTEGER}</if>
			</where>
		</foreach>
	</update>

	<update id="updateBatchState" parameterType="java.util.List">

		<foreach collection="list" item="item" index="index" open="begin"
			close=";end;" separator=";">
			UPDATE MAT_AFFI_TRAN_MAIN
			<trim prefix="SET" suffixOverrides=",">
				<if test="item.checker != null ">checker = #{item.checker,jdbcType=INTEGER},</if>
				<if test="item.check_date != null">check_date = fun_date_same_year_month(tran_date, sysdate),</if>
				<if test="item.confirmer != null ">confirmer = #{item.confirmer,jdbcType=INTEGER},</if>
				<if test="item.confirm_date != null ">confirm_date = fun_date_same_year_month(tran_date, sysdate),</if>
				<if test="item.state != null ">state = #{item.state,jdbcType=INTEGER},</if>
			</trim>
			<where>
				<if test="item.group_id != null and item.group_id != ''">AND group_id = #{item.group_id,jdbcType=INTEGER}</if>
				<if test="item.hos_id != null and item.hos_id != ''">AND hos_id = #{item.hos_id,jdbcType=INTEGER}</if>
				<if test="item.copy_code != null and item.copy_code != ''">AND copy_code = #{item.copy_code,jdbcType=VARCHAR}</if>
				<if test="item.tran_id != null and item.tran_id != ''">AND tran_id = #{item.tran_id,jdbcType=INTEGER}</if>
			</where>
		</foreach>
	</update>

	<delete id="delete" parameterType="java.util.Map">

		DELETE FROM MAT_AFFI_TRAN_MAIN
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id != ''">
				AND tran_id = #{tran_id,jdbcType=INTEGER}
			</if>
			<if test="tran_no != null and tran_no != ''">
				AND tran_no = #{tran_no,jdbcType=VARCHAR}
			</if>
			<if test="year != null and year != ''">
				AND year = #{year,jdbcType=VARCHAR}
			</if>
			<if test="month != null and month != ''">
				AND month = #{month,jdbcType=VARCHAR}
			</if>
			<if test="tran_method != null and tran_method != ''">
				AND tran_method = #{tran_method,jdbcType=INTEGER}
			</if>
			<if test="tran_type != null and tran_type != ''">
				AND tran_type = #{tran_type,jdbcType=INTEGER}
			</if>
			<if test="out_hos_id != null and out_hos_id != ''">
				AND out_hos_id = #{out_hos_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_id != null and out_store_id != ''">
				AND out_store_id = #{out_store_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_no != null and out_store_no != ''">
				AND out_store_no = #{out_store_no,jdbcType=INTEGER}
			</if>
			<if test="in_hos_id != null and in_hos_id != ''">
				AND in_hos_id = #{in_hos_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_id != null and in_store_id != ''">
				AND in_store_id = #{in_store_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_no != null and in_store_no != ''">
				AND in_store_no = #{in_store_no,jdbcType=INTEGER}
			</if>
			<if test="brief != null ">
				AND brief = #{brief,jdbcType=VARCHAR}
			</if>
			<if test="tran_date != null and tran_date != ''">
				AND tran_date = #{tran_date,jdbcType=DATE}
			</if>
			<if test="maker != null and maker != ''">
				AND maker = #{maker,jdbcType=INTEGER}
			</if>
			<if test="checker != null and checker != ''">
				AND checker = #{checker,jdbcType=INTEGER}
			</if>
			<if test="check_date != null and check_date != ''">
				AND check_date = #{check_date,jdbcType=DATE}
			</if>
			<if test="confirmer != null and confirmer != ''">
				AND confirmer = #{confirmer,jdbcType=INTEGER}
			</if>
			<if test="confirm_date != null and confirm_date != ''">
				AND confirm_date = #{confirm_date,jdbcType=DATE}
			</if>
			<if test="state != null and state != ''">
				AND state = #{state,jdbcType=INTEGER}
			</if>
		</where>
	</delete>
	<delete id="deleteBatch" parameterType="java.util.List">
		DELETE FROM MAT_AFFI_TRAN_MAIN
		<where>
			<foreach collection="list" index="index" item="item" open="("
				separator="or" close=")">
				<if test="item.group_id != null and item.group_id != ''">
					group_id = #{item.group_id,jdbcType=INTEGER}
				</if>
				<if test="item.hos_id != null and item.hos_id != ''">
					AND hos_id = #{item.hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
				</if>
				<if test="item.tran_id != null and item.tran_id != ''">
					AND tran_id = #{item.tran_id,jdbcType=INTEGER}
				</if>
				<if test="item.tran_no != null and item.tran_no != ''">
					AND tran_no = #{item.tran_no,jdbcType=VARCHAR}
				</if>
				<if test="item.year != null and item.year != ''">
					AND year = #{item.year,jdbcType=VARCHAR}
				</if>
				<if test="item.month != null and item.month != ''">
					AND month = #{item.month,jdbcType=VARCHAR}
				</if>
				<if test="item.tran_method != null and item.tran_method != ''">
					AND tran_method = #{item.tran_method,jdbcType=INTEGER}
				</if>
				<if test="item.tran_type != null and item.tran_type != ''">
					AND tran_type = #{item.tran_type,jdbcType=INTEGER}
				</if>
				<if test="item.out_hos_id != null and item.out_hos_id != ''">
					AND out_hos_id = #{item.out_hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.out_store_id != null and item.out_store_id != ''">
					AND out_store_id = #{item.out_store_id,jdbcType=INTEGER}
				</if>
				<if test="item.out_store_no != null and item.out_store_no != ''">
					AND out_store_no = #{item.out_store_no,jdbcType=INTEGER}
				</if>
				<if test="item.in_hos_id != null and item.in_hos_id != ''">
					AND in_hos_id = #{item.in_hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.in_store_id != null and item.in_store_id != ''">
					AND in_store_id = #{item.in_store_id,jdbcType=INTEGER}
				</if>
				<if test="item.in_store_no != null and item.in_store_no != ''">
					AND in_store_no = #{item.in_store_no,jdbcType=INTEGER}
				</if>
				<if test="item.brief != null ">
					AND brief = #{item.brief,jdbcType=VARCHAR}
				</if>
				<if test="item.tran_date != null and item.tran_date != ''">
					AND tran_date = #{item.tran_date,jdbcType=DATE}
				</if>
				<if test="item.maker != null and item.maker != ''">
					AND maker = #{item.maker,jdbcType=INTEGER}
				</if>
				<if test="item.checker != null and item.checker != ''">
					AND checker = #{item.checker,jdbcType=INTEGER}
				</if>
				<if test="item.check_date != null and item.check_date != ''">
					AND check_date = #{item.check_date,jdbcType=DATE}
				</if>
				<if test="item.confirmer != null and item.confirmer != ''">
					AND confirmer = #{item.confirmer,jdbcType=INTEGER}
				</if>
				<if test="item.confirm_date != null and item.confirm_date != ''">
					AND confirm_date = #{item.confirm_date,jdbcType=DATE}
				</if>
				<if test="item.state != null and item.state != ''">
					AND state = #{item.state,jdbcType=INTEGER}
				</if>
			</foreach>
		</where>
	</delete>
	
	<select id="query" parameterType="java.util.Map" resultMap="matAffiTranMain">

		SELECT
			group_id,
			hos_id,
			copy_code,
			tran_id,
			tran_no,
			year,
			month,
			bus_type,
			tran_method,
			tran_type,
			out_hos_id,
			out_store_id,
			out_store_no,
			in_hos_id,
			in_store_id,
			in_store_no,
			brief,
			tran_date,
			maker,
			checker,
			check_date,
			confirmer,
			confirm_date,
			state
		FROM MAT_AFFI_TRAN_MAIN
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id != ''">
				AND tran_id = #{tran_id,jdbcType=INTEGER}
			</if>
			<if test="tran_no != null and tran_no != ''">
				AND tran_no = #{tran_no,jdbcType=VARCHAR}
			</if>
			<if test="year != null and year != ''">
				AND year = #{year,jdbcType=VARCHAR}
			</if>
			<if test="month != null and month != ''">
				AND month = #{month,jdbcType=VARCHAR}
			</if>
			<if test="tran_method != null and tran_method != ''">
				AND tran_method = #{tran_method,jdbcType=INTEGER}
			</if>
			<if test="tran_type != null and tran_type != ''">
				AND tran_type = #{tran_type,jdbcType=INTEGER}
			</if>
			<if test="out_hos_id != null and out_hos_id != ''">
				AND out_hos_id = #{out_hos_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_id != null and out_store_id != ''">
				AND out_store_id = #{out_store_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_no != null and out_store_no != ''">
				AND out_store_no = #{out_store_no,jdbcType=INTEGER}
			</if>
			<if test="in_hos_id != null and in_hos_id != ''">
				AND in_hos_id = #{in_hos_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_id != null and in_store_id != ''">
				AND in_store_id = #{in_store_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_no != null and in_store_no != ''">
				AND in_store_no = #{in_store_no,jdbcType=INTEGER}
			</if>
			<if test="brief != null ">
				AND brief = #{brief,jdbcType=VARCHAR}
			</if>
			<if test="tran_date != null and tran_date != ''">
				AND tran_date = #{tran_date,jdbcType=DATE}
			</if>
			<if test="maker != null and maker != ''">
				AND maker = #{maker,jdbcType=INTEGER}
			</if>
			<if test="checker != null and checker != ''">
				AND checker = #{checker,jdbcType=INTEGER}
			</if>
			<if test="check_date != null and check_date != ''">
				AND check_date = #{check_date,jdbcType=DATE}
			</if>
			<if test="confirmer != null and confirmer != ''">
				AND confirmer = #{confirmer,jdbcType=INTEGER}
			</if>
			<if test="confirm_date != null and confirm_date != ''">
				AND confirm_date = #{confirm_date,jdbcType=DATE}
			</if>
			<if test="state != null and state != ''">
				AND state = #{state,jdbcType=INTEGER}
			</if>
		</where>
		order by group_id asc
	</select>
	
	<select id="queryByCode" resultMap="matAffiTranMain" parameterType="java.util.Map">

		SELECT
	      a.group_id,
	      a.hos_id,
	      a.copy_code,
	      a.tran_id,
	      a.tran_no,
	      a.year,
	      a.month,
	      a.tran_method,
	      a.tran_type,
	      a.bus_type,
	      a.out_hos_id,
	      a.out_store_id,
	      a.out_store_no,
	      a.in_hos_id,
	      a.in_store_id,
	      a.in_store_no,
	      a.brief,
	      a.maker,
	      a.tran_date tran_date,
	      a.checker,
	      a.check_date check_date,
	      a.confirmer,
	      a.confirm_date confirm_date,
	      a.state
	    FROM MAT_AFFI_TRAN_MAIN a
	    left join hos_store_dict b on a.in_store_id = b.store_id
	         and a.in_store_no = b.store_no
	         and a.group_id = b.group_id
	         and a.hos_id = b.hos_id
	    left join hos_store_dict c on a.out_store_id = c.store_id
	         and a.out_store_no = c.store_no
	         and a.group_id = c.group_id
	         and a.hos_id = c.hos_id
	    left join v_hos_dict  hi on hi.hos_id = a.in_hos_id
	         and hi.group_id = a.group_id
	    left join v_hos_dict hii on hii.hos_id = a.out_hos_id
	         and hii.group_id = a.group_id
			
		WHERE a.group_id = #{group_id,jdbcType=INTEGER} and
			a.hos_id = #{hos_id,jdbcType=INTEGER} and
			a.copy_code = #{copy_code,jdbcType=VARCHAR} and
			a.tran_id = #{tran_id,jdbcType=INTEGER}

	</select>
	
	<select id="queryByUniqueness" resultMap="matAffiTranMain" parameterType="java.util.Map">

		SELECT
		group_id,
		hos_id,
		copy_code,
		tran_id,
		tran_no,
		year,
		month,
		bus_type,
		tran_method,
		tran_type,
		out_hos_id,
		out_store_id,
		out_store_no,
		in_hos_id,
		in_store_id,
		in_store_no,
		brief,
		tran_date,
		maker,
		checker,
		check_date,
		confirmer,
		confirm_date,
		state
		FROM MAT_AFFI_TRAN_MAIN
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id != ''">
				AND tran_id = #{tran_id,jdbcType=INTEGER}
			</if>
			<if test="tran_no != null and tran_no != ''">
				AND tran_no = #{tran_no,jdbcType=VARCHAR}
			</if>
			<if test="year != null and year != ''">
				AND year = #{year,jdbcType=VARCHAR}
			</if>
			<if test="month != null and month != ''">
				AND month = #{month,jdbcType=VARCHAR}
			</if>
			<if test="tran_method != null and tran_method != ''">
				AND tran_method = #{tran_method,jdbcType=INTEGER}
			</if>
			<if test="tran_type != null and tran_type != ''">
				AND tran_type = #{tran_type,jdbcType=INTEGER}
			</if>
			<if test="out_hos_id != null and out_hos_id != ''">
				AND out_hos_id = #{out_hos_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_id != null and out_store_id != ''">
				AND out_store_id = #{out_store_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_no != null and out_store_no != ''">
				AND out_store_no = #{out_store_no,jdbcType=INTEGER}
			</if>
			<if test="in_hos_id != null and in_hos_id != ''">
				AND in_hos_id = #{in_hos_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_id != null and in_store_id != ''">
				AND in_store_id = #{in_store_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_no != null and in_store_no != ''">
				AND in_store_no = #{in_store_no,jdbcType=INTEGER}
			</if>
			<if test="brief != null ">
				AND brief = #{brief,jdbcType=VARCHAR}
			</if>
			<if test="tran_date != null and tran_date != ''">
				AND tran_date = #{tran_date,jdbcType=DATE}
			</if>
			<if test="maker != null and maker != ''">
				AND maker = #{maker,jdbcType=INTEGER}
			</if>
			<if test="checker != null and checker != ''">
				AND checker = #{checker,jdbcType=INTEGER}
			</if>
			<if test="check_date != null and check_date != ''">
				AND check_date = #{check_date,jdbcType=DATE}
			</if>
			<if test="confirmer != null and confirmer != ''">
				AND confirmer = #{confirmer,jdbcType=INTEGER}
			</if>
			<if test="confirm_date != null and confirm_date != ''">
				AND confirm_date = #{confirm_date,jdbcType=DATE}
			</if>
			<if test="state != null and state != ''">
				AND state = #{state,jdbcType=INTEGER}
			</if>
		</where>
		order by group_id asc
	</select>
	
	<select id="queryExists" resultMap="matAffiTranMain" parameterType="java.util.Map">

		SELECT
			group_id,
			hos_id,
			copy_code,
			tran_id,
			tran_no,
			year,
			month,
			bus_type,
			tran_method,
			tran_type,
			out_hos_id,
			out_store_id,
			out_store_no,
			in_hos_id,
			in_store_id,
			in_store_no,
			brief,
			tran_date,
			maker,
			checker,
			check_date,
			confirmer,
			confirm_date,
			state
		FROM MAT_AFFI_TRAN_MAIN
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id != ''">
				AND tran_id = #{tran_id,jdbcType=INTEGER}
			</if>
			<if test="tran_no != null and tran_no != ''">
				AND tran_no = #{tran_no,jdbcType=VARCHAR}
			</if>
			<if test="year != null and year != ''">
				AND year = #{year,jdbcType=VARCHAR}
			</if>
			<if test="month != null and month != ''">
				AND month = #{month,jdbcType=VARCHAR}
			</if>
			<if test="tran_method != null and tran_method != ''">
				AND tran_method = #{tran_method,jdbcType=INTEGER}
			</if>
			<if test="tran_type != null and tran_type != ''">
				AND tran_type = #{tran_type,jdbcType=INTEGER}
			</if>
			<if test="out_hos_id != null and out_hos_id != ''">
				AND out_hos_id = #{out_hos_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_id != null and out_store_id != ''">
				AND out_store_id = #{out_store_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_no != null and out_store_no != ''">
				AND out_store_no = #{out_store_no,jdbcType=INTEGER}
			</if>
			<if test="in_hos_id != null and in_hos_id != ''">
				AND in_hos_id = #{in_hos_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_id != null and in_store_id != ''">
				AND in_store_id = #{in_store_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_no != null and in_store_no != ''">
				AND in_store_no = #{in_store_no,jdbcType=INTEGER}
			</if>
			<if test="brief != null ">
				AND brief = #{brief,jdbcType=VARCHAR}
			</if>
			<if test="tran_date != null and tran_date != ''">
				AND tran_date = #{tran_date,jdbcType=DATE}
			</if>
			<if test="maker != null and maker != ''">
				AND maker = #{maker,jdbcType=INTEGER}
			</if>
			<if test="checker != null and checker != ''">
				AND checker = #{checker,jdbcType=INTEGER}
			</if>
			<if test="check_date != null and check_date != ''">
				AND check_date = #{check_date,jdbcType=DATE}
			</if>
			<if test="confirmer != null and confirmer != ''">
				AND confirmer = #{confirmer,jdbcType=INTEGER}
			</if>
			<if test="confirm_date != null and confirm_date != ''">
				AND confirm_date = #{confirm_date,jdbcType=DATE}
			</if>
			<if test="state != null and state != ''">
				AND state = #{state,jdbcType=INTEGER}
			</if>
		</where>
		order by group_id asc
	</select>

	<select id="queryMatAffiTranMain" parameterType="java.util.Map" resultType="java.util.HashMap">
		select 
	      mtm.group_id as group_id,
	      mtm.hos_id as hos_id,
	      mtm.copy_code as copy_code,
	      mtm.tran_id as tran_id,
	      mtm.tran_no as tran_no,
	      mtm.year as year,
	      mtm.month as month,
	      mtm.bus_type as bus_type,
	      mtm.tran_date as tran_date,
	      mtm.out_hos_id as out_hos_id,
	      out_hid.hos_code as out_hos_code,
	      out_hid.hos_name as out_hos_name,
	      mtm.in_hos_id as in_hos_id,
	      in_hid.hos_code as in_hos_code,
	      in_hid.hos_name as in_hos_name,
	      mtm.out_store_id as out_store_id,
	      mtm.out_store_no as out_store_no,
	      out_hsd.store_code as out_store_code,
	      out_hsd.store_name as out_store_name,
	      mtm.in_store_id as in_store_id,
	      mtm.in_store_no as in_store_no,
	      in_hsd.store_code as in_store_code,
	      in_hsd.store_name as in_store_name,
	      mtm.maker as maker,
	      sumaker.user_name as maker_name,
	      mtm.checker as checker,
	      suchecker.user_name as checker_name, 
	      mtm.check_date as check_date,
	      mtr.out_id as out_id, 
	      mtr.out_no as out_no, 
	      mtm.confirmer as confirmer,
	      suconfirmer.user_name as confirmer_name,
	      mtm.confirm_date as confirm_date,
	      mtr.in_id as in_id, 
	      mtr.in_no as in_no, 
	      mtm.state as state, 
	      mtd.amount_money as amount_money
	    from mat_affi_tran_main mtm
	    left join v_hos_dict out_hid  on mtm.group_id = out_hid.group_id 
	    	and mtm.out_hos_id = out_hid.hos_id 
	    	<if test="show_history == 0">
				and out_hid.is_stop=0
			</if>
	    left join v_hos_dict in_hid  on mtm.group_id = in_hid.group_id 
	    	and mtm.in_hos_id = in_hid.hos_id 
	      	<if test="show_history == 0">
				and in_hid.is_stop=0
			</if>
	    left join hos_store_dict out_hsd on mtm.group_id = out_hsd.group_id 
	    	and mtm.hos_id = out_hsd.hos_id 
	      	and mtm.out_store_id = out_hsd.store_id 
	      	<if test="show_history == 1">
				and mtm.out_store_no = out_hsd.store_no
			</if>
			<if test="show_history == 0">
				and out_hsd.is_stop = 0
			</if>
	    left join hos_store_dict in_hsd on mtm.group_id = in_hsd.group_id 
	    	and mtm.hos_id = in_hsd.hos_id 
	      	and mtm.in_store_id = in_hsd.store_id 
	      	<if test="show_history == 1">
				and mtm.in_store_no = in_hsd.store_no
			</if>
			<if test="show_history == 0">
				and in_hsd.is_stop = 0
			</if>
	    left join sys_user sumaker  on mtm.group_id = sumaker.group_id 
	    	and mtm.hos_id = sumaker.hos_id 
	      	and mtm.copy_code = sumaker.copy_code 
	      	and mtm.maker = sumaker.user_id
	    left join sys_user suchecker   on mtm.group_id = suchecker.group_id 
	    	and mtm.hos_id = suchecker.hos_id 
	      	and mtm.copy_code = suchecker.copy_code 
	      	and mtm.checker = suchecker.user_id 
	    left join sys_user suconfirmer 
	      on mtm.group_id = suconfirmer.group_id and mtm.hos_id = suconfirmer.hos_id 
	      and mtm.copy_code = suconfirmer.copy_code and mtm.confirmer = suconfirmer.user_id 
	    left join (
	      select group_id,
	      	hos_id,
	      	copy_code,
	      	tran_id,
	      	sum(amount_money) as amount_money 
	      from mat_affi_tran_detail
	      group by tran_id,group_id,hos_id,copy_code
	    ) mtd  on mtm.group_id = mtd.group_id and mtm.hos_id = mtd.hos_id  
	      and mtm.copy_code = mtd.copy_code and mtm.tran_id = mtd.tran_id 
	    left join mat_affi_tran_rela mtr
	      on mtm.group_id = mtr.group_id and mtm.hos_id = mtr.hos_id
	      and mtm.copy_code = mtr.copy_code and mtm.tran_id = mtr.tran_id
		<where>                     
			<if test="group_id != null and group_id != ''">
			AND mtm.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
			AND mtm.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
			AND mtm.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id != ''">
			AND mtm.tran_id = #{tran_id,jdbcType=INTEGER}
			</if>
			<if test="tran_no != null and tran_no != ''">
			AND mtm.tran_no like '${tran_no}%'
			</if>
			<if test="year != null and year != ''">
			AND mtm.year = #{year,jdbcType=VARCHAR}
			</if>
			<if test="month != null and month != ''">
			AND mtm.month = #{month,jdbcType=VARCHAR}
			</if>
			<if test="bus_type != null and bus_type != ''">
			AND mtm.bus_type = #{bus_type,jdbcType=INTEGER}
			</if>
			<if test="tran_method != null and tran_method != ''">
			AND mtm.tran_method = #{tran_method,jdbcType=INTEGER}
			</if>
			<if test="tran_type != null and tran_type != ''">
			AND mtm.tran_type = #{tran_type,jdbcType=INTEGER}
			</if>
			<if test="out_hos_id != null and out_hos_id != ''">
			AND mtm.out_hos_id = #{out_hos_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_id != null and out_store_id != ''">
			AND mtm.out_store_id = #{out_store_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_no != null and out_store_no != ''">
			AND mtm.out_store_no = #{out_store_no,jdbcType=INTEGER}
			</if>
			<if test="in_hos_id != null and in_hos_id != ''">
			AND mtm.in_hos_id = #{in_hos_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_id != null and in_store_id != ''">
			AND mtm.in_store_id = #{in_store_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_no != null and in_store_no != ''">
			AND mtm.in_store_no = #{in_store_no,jdbcType=INTEGER}
			</if>
			<if test="brief != null ">
			AND mtm.brief like '%'||#{brief,jdbcType=VARCHAR}||'%'
			</if>
			<if test="tran_date != null and tran_date != ''">
			AND mtm.tran_date = #{tran_date,jdbcType=DATE}
			</if>
			<if test="maker != null and maker != ''">
			AND mtm.maker = #{maker,jdbcType=INTEGER}
			</if>
			<if test="checker != null and checker != ''">
			AND mtm.checker = #{checker,jdbcType=INTEGER}
			</if>
			<if test="check_date != null and check_date != ''">
			AND mtm.check_date = #{check_date,jdbcType=DATE}
			</if>
			<if test="confirmer != null and confirmer != ''">
			AND mtm.confirmer = #{confirmer,jdbcType=INTEGER}
			</if>
			<if test="confirm_date != null and confirm_date != ''">
			AND mtm.confirm_date = #{confirm_date,jdbcType=DATE}
			</if>
			<if test="state != null and state != ''">
			AND mtm.state = #{state,jdbcType=INTEGER}
			</if>
			<if test="sql!= null and sql != ''">
			${sql}
			</if>
		</where>   
		order by mtm.tran_no asc
	</select>

	<select id="queryMatInMainBySingle" parameterType="java.util.Map" resultType="java.util.TreeMap">
		select mim.group_id, 
			mim.hos_id, 
			mim.copy_code, 
			mim.in_id, 
			mim.in_no, 
			mim.brief, 
			hsd.sup_name, 
			su.user_name as maker_name, 
			mim.in_date, suc.user_name as confirmer_name, 
			mim.confirm_date, 
			sum(nvl(mfb.left_amount, 0) - nvl(modet.amount, 0)) as imme_amount
		from mat_affi_in mim 
		left join mat_affi_in_detail mid
			on mim.group_id = mid.group_id and mim.hos_id = mid.hos_id
			and mim.copy_code = mid.copy_code and mim.in_id = mid.in_id
		left join mat_affi_fifo mfb
			on mim.group_id = mfb.group_id and mim.hos_id = mfb.hos_id
			and mim.copy_code = mfb.copy_code and mim.store_id = mfb.store_id
			and mid.inv_id = mfb.inv_id and mid.batch_no = mfb.batch_no
			and mid.batch_sn = mfb.batch_sn and mid.bar_code = mfb.bar_code
		left join mat_affi_out mom
			on mim.group_id = mom.group_id and mim.hos_id = mom.hos_id
			and mim.copy_code = mom.copy_code and mim.store_id = mom.store_id
			<![CDATA[and mom.state < 3]]>
		left join mat_affi_out_detail modet
			on mom.group_id = modet.group_id and mom.hos_id = modet.hos_id
			and mom.copy_code = modet.copy_code and mom.out_id = modet.out_id
			and mid.inv_id = modet.inv_id and mid.batch_no = modet.batch_no
			and mid.batch_sn = modet.batch_sn and mid.bar_code = modet.bar_code
		left join hos_sup_dict hsd
			on mim.group_id = hsd.group_id and mim.hos_id = hsd.hos_id
			and mim.sup_id = hsd.sup_id and hsd.is_stop = 0
		left join sys_user su
			on mim.group_id = su.group_id and su.hos_id = su.hos_id
			and mim.maker = su.user_id 
		left join sys_user suc
			on mim.group_id = suc.group_id and mim.hos_id = suc.hos_id
			and mim.confirmer = suc.user_id
		where mim.group_id = #{group_id,jdbcType=INTEGER}
			and mim.hos_id = #{hos_id,jdbcType=INTEGER}
			and mim.copy_code = #{copy_code,jdbcType=VARCHAR}
			and mim.store_id = #{store_id,jdbcType=INTEGER}
			<if test="in_no != null and in_no != ''">
				AND mim.in_no like '%${in_no}%'
			</if>
			<if test="in_date_start != null and in_date_start != ''">
				<![CDATA[AND mim.in_date >= #{in_date_start,jdbcType=DATE}]]>
			</if>
			<if test="in_date_end != null and in_date_end != ''">
				<![CDATA[AND mim.in_date <= #{in_date_end,jdbcType=DATE}]]>
			</if>
			and mim.state = 3
		group by mim.group_id, mim.hos_id, mim.copy_code, mim.in_id, mim.in_no, mim.brief, hsd.sup_name, 
			su.user_name, mim.in_date, suc.user_name, mim.confirm_date
		having sum(nvl(mfb.left_amount, 0) - nvl(modet.amount, 0)) > 0
		order by mim.in_id
	</select>

	<select id="queryMatInDetailBySingle" parameterType="java.util.Map" resultType="java.util.TreeMap">
		select 
			mid.detail_id, mid.inv_id, inv.inv_no, inv.inv_code,
			inv.inv_name, inv.inv_model, mid.batch_no,
			mid.batch_sn, mid.bar_code,
			mid.price, sum(nvl(mfb.left_amount, 0) - nvl(modet.amount, 0)) as
			imme_amount
		from mat_affi_in_detail mid
		left join mat_affi_fifo mfb
			on mid.group_id = mfb.group_id and mid.hos_id = mfb.hos_id
			and mid.copy_code = mfb.copy_code 
			and mfb.store_id = #{store_id,jdbcType=INTEGER}
			and mid.inv_id = mfb.inv_id 
			and mid.batch_no = mfb.batch_no
			and mid.batch_sn = mfb.batch_sn 
			and mid.bar_code = mfb.bar_code
		left join(
			select detail.inv_id,
				detail.batch_no, detail.batch_sn,
				detail.bar_code, sum(amount) as
				amount
			from mat_affi_out mom
			left join mat_affi_out_detail detail
				on mom.group_id = detail.group_id and mom.hos_id = detail.hos_id
				and mom.copy_code = detail.copy_code and mom.out_id = detail.out_id
			where
				mom.group_id = #{group_id,jdbcType=INTEGER}
				and mom.hos_id = #{hos_id,jdbcType=INTEGER}
				and mom.copy_code = #{copy_code,jdbcType=VARCHAR}
				and mom.store_id = #{store_id,jdbcType=INTEGER}
				<![CDATA[and mom.state < 3]]>
				group by detail.inv_id, detail.batch_no, detail.batch_sn,
				detail.bar_code
		)modet on mid.inv_id = modet.inv_id 
			and mid.batch_no = modet.batch_no
			and mid.batch_sn = modet.batch_sn 
			and mid.bar_code = modet.bar_code
		left join mat_inv_dict inv
			on mid.group_id = inv.group_id
			and mid.hos_id = inv.hos_id
			and mid.copy_code = inv.copy_code 
			and mid.inv_id = inv.inv_id
			and inv.is_stop = 0
		where mid.group_id = #{group_id,jdbcType=INTEGER}
			and mid.hos_id = #{hos_id,jdbcType=INTEGER}
			and mid.copy_code = #{copy_code,jdbcType=VARCHAR}
			and mid.in_id = #{in_id,jdbcType=INTEGER}
		group by mid.detail_id, mid.inv_id, inv.inv_no, inv.inv_code,
		inv.inv_name, inv.inv_model, mid.batch_no, mid.batch_sn, mid.bar_code, mid.price
		<!-- 如果不显示即时库存为0的材料，取消注释 -->
		--having sum(nvl(mfb.left_amount, 0) - nvl(modet.amount, 0)) > 0
		order by mid.detail_id
	</select>
	
	<select id="queryMatAffiTranMainByMatInv" parameterType="java.util.Map" resultType="java.util.TreeMap">
		SELECT
			mid.group_id as group_id,
			mid.hos_id as hos_id,
			mid.copy_code as copy_code,
			mid.inv_id as inv_id,
			mid.inv_no as inv_no,
			mid.inv_code as inv_code,
			mid.inv_name as inv_name,
			mid.inv_model as inv_model,--规格型号
			mid.unit_code as unit_code,
			hu.unit_name as unit_name,
			mfb.price as price,--单价
			mfb.batch_sn as batch_sn,
			mfb.batch_no as batch_no,
			mfb.bar_code as bar_code,
			mfb.left_amount as left_amount, -- 账面数量
			mbv.inva_date as inva_date,
			mid.sup_id as sup_id,
			hsd.sup_code as sup_code,
			hsd.sup_name as sup_name,
			mid.fac_id as fac_id,
			mid.fac_no as fac_no,
			hfd.fac_code as fac_code,
			hfd.fac_name as fac_name,
			mfb.location_id as location_id,
			mld.location_code as location_code,
			mld.location_name as location_name

		FROM mat_inv_dict mid
		LEFT JOIN hos_unit hu ON mid.group_id = hu.group_id and mid.hos_id =
		hu.hos_id and mid.unit_code = hu.unit_code
		left join mat_fifo_balance mfb on mid.group_id = mfb.group_id and
		mid.hos_id = mfb.hos_id and mid.copy_code = mfb.copy_code and
		mid.inv_id = mfb.inv_id
		left join mat_batch_validity mbv on mfb.group_id = mbv.group_id and
		mfb.hos_id = mbv.hos_id and mfb.copy_code = mbv.copy_code and
		mfb.inv_id = mbv.inv_id and mfb.batch_no = mbv.batch_no
		left join hos_sup_dict hsd on mid.group_id = hsd.group_id and mid.hos_id =
		hsd.group_id and mid.sup_id = hsd.sup_id and hsd.is_stop=0
		LEFT JOIN hos_fac_dict hfd ON mid.group_id = hfd.group_id and mid.hos_id =
		hfd.hos_id and mid.fac_id = hfd.fac_id and mid.fac_no = hfd.fac_no
		LEFT JOIN mat_location_dict mld on mfb.group_id = mld.group_id and
		mfb.hos_id = mld.hos_id and mfb.copy_code = mld.copy_code and
		mfb.location_id = mld.location_id and mld.is_stop=0

		<where>
			<if test="hos_id != null and hos_id != ''">
				AND mid.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="group_id != null and group_id != ''">
				AND mid.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND mid.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND mid.inv_id = #{inv_id,jdbcType=VARCHAR}
			</if>
			<if test="inv_no != null and inv_no != ''">
				AND mid.inv_no = #{inv_no,jdbcType=VARCHAR}
			</if>
			<if test="store_id != null and store_id != ''">
				AND mid.store_id = #{store_id,jdbcType=VARCHAR}
			</if>
		</where>
		order by inv_no
	</select>
	
	<select id="queryMatAffiTranMainByCode" resultMap="matAffiTranMain"  parameterType="java.util.Map" >
		SELECT 
			mtm.group_id ,
			mtm.hos_id ,
			mtm.copy_code ,
			mtm.tran_id ,
			mtm.tran_no ,
			mtm.year ,
			mtm.month ,
			mtm.bus_type ,
			mtm.tran_method ,
			mtm.tran_type ,
			mtm.out_hos_id ,
			mtm.out_store_id ,
			mtm.out_store_no ,
			hsd.store_code  out_store_code,
			hsd.store_name  out_store_name,
			mtm.in_hos_id ,
			mtm.in_store_id ,
			mtm.in_store_no ,
			hsi.store_code  in_store_code,
			hsi.store_name  in_store_name,
			mtm.brief ,
			mtm.tran_date ,
			mtm.maker ,
			mtm.checker ,
			mtm.check_date ,
			mtm.confirmer ,
			mtm.confirm_date ,
			mtm.state ,
		    hidi.hos_no  in_hos_no,
		    hido.hos_no  out_hos_no
		FROM mat_affi_tran_main mtm
	    left join v_hos_dict hidi on mtm.group_id = hidi.group_id 
	    	and mtm.in_hos_id = hidi.hos_id 
			and hidi.is_stop=0
		left join v_hos_dict hido on mtm.group_id = hido.group_id 
	    	and mtm.out_hos_id = hido.hos_id 
			and hido.is_stop=0
	    left join hos_store_dict hsd on hsd.store_id = mtm.out_store_id
      		and hsd.group_id = mtm.group_id
      		and hsd.hos_id = mtm.hos_id
    	left join hos_store_dict hsi on hsi.store_id = mtm.in_store_id
         	and hsi.group_id = mtm.group_id
         	and hsi.hos_id = mtm.hos_id
		WHERE 
			mtm.group_id = #{group_id,jdbcType=INTEGER}   and 
			mtm.hos_id = #{hos_id,jdbcType=INTEGER}   and 
			mtm.copy_code = #{copy_code,jdbcType=VARCHAR}   and 
			mtm.tran_id = #{tran_id,jdbcType=INTEGER} 
	
	</select>
	
	<!-- 入库确认 -->
	<update id="updateConfirmBatch" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			UPDATE mat_affi_tran_main set 
				year = #{item.year,jdbcType=VARCHAR},
				month = #{item.month,jdbcType=VARCHAR},
				confirm_date = fun_date_same_year_month(tran_date, sysdate),
				confirmer = #{item.confirmer,jdbcType=INTEGER},
				state = #{item.state,jdbcType=INTEGER}
			<where>   
				hos_id = #{item.hos_id,jdbcType=INTEGER}   
				AND group_id = #{item.group_id,jdbcType=INTEGER} 
				AND copy_code = #{item.copy_code,jdbcType=VARCHAR}  
				AND tran_id = #{item.tran_id,jdbcType=INTEGER}            
			</where>  			
		</foreach>
	</update>
	
	<select id="queryMainByCode" parameterType="java.util.Map" resultType="java.util.HashMap">
		select 
			mtm.group_id ,
			mtm.hos_id ,
			mtm.copy_code ,
			mtm.tran_id ,
			mtm.tran_no ,
			mtm.year ,
			mtm.month ,
			mtm.bus_type ,
			mtm.tran_method ,
			mtm.tran_type ,
			mtm.out_hos_id ,
			hido.hos_no out_hos_no,
			hido.hos_code out_hos_code,
			hido.hos_name out_hos_name,
			mtm.out_store_id ,
			mtm.out_store_no ,
			hsd.store_code  out_store_code,
			hsd.store_name  out_store_name,
			mtm.in_hos_id ,
			hidi.hos_no in_hos_no,
			hidi.hos_code in_hos_code,
			hidi.hos_name in_hos_name,
			mtm.in_store_id ,
			mtm.in_store_no ,
			hsi.store_code  in_store_code,
			hsi.store_name  in_store_name,
			mtm.brief ,
			to_char(mtm.tran_date,'yyyy-MM-dd') tran_date,
			mtm.maker ,
			mtm.checker ,
			to_char(mtm.check_date,'yyyy-MM-dd') check_date,
			mtm.confirmer ,
			to_char(mtm.confirm_date,'yyyy-MM-dd') confirm_date,
			mtm.state ,
		    hidi.hos_no  in_hos_no,
		    hido.hos_no  out_hos_no
		FROM mat_affi_tran_main mtm
	    left join v_hos_dict hidi on mtm.group_id = hidi.group_id 
	    	and mtm.in_hos_id = hidi.hos_id 
			and hidi.is_stop=0
		left join v_hos_dict hido on mtm.group_id = hido.group_id 
	    	and mtm.out_hos_id = hido.hos_id 
			and hido.is_stop=0
	    left join hos_store_dict hsd on hsd.store_id = mtm.out_store_id
      		and hsd.group_id = mtm.group_id
      		and hsd.hos_id = mtm.hos_id
    	left join hos_store_dict hsi on hsi.store_id = mtm.in_store_id
         	and hsi.group_id = mtm.group_id
         	and hsi.hos_id = mtm.hos_id
		WHERE 
			mtm.group_id = #{group_id,jdbcType=INTEGER}   and 
			mtm.hos_id = #{hos_id,jdbcType=INTEGER}   and 
			mtm.copy_code = #{copy_code,jdbcType=VARCHAR}   and 
			mtm.tran_id = #{tran_id,jdbcType=INTEGER} 
	</select>
	
	<!-- 入库主表模板打印 -->
	<select id="queryMatAffiTranPrintTemlateByMain" parameterType="java.util.Map" resultType="java.util.Map">

		select 
			mtm.tran_no as TRAN_NO,
			mbt.bus_type_name as BUS_TYPE_CODE,
			case mtm.tran_method when 1 then '同价调拨' when 2 then '异价调拨' end as TRAN_METHOD,
			case mtm.tran_type when 1 then '院内调拨' when 2 then '院外调拨' end as TRAN_TYPE,
			out_hos.hos_name as OUT_HOS,
			out_stroe.store_name as OUT_STORE,
			in_hos.hos_name as IN_HOS ,
			in_stroe.store_name as IN_STORE,
			mtm.brief as BRIEF ,
			su_maker.user_name as MAKER ,
			to_char(mtm.tran_date, 'yyyy-MM-dd hh24:mi:ss') as TRAN_DATE,
			su_checker.user_name as CHECKER,
			to_char(mtm.check_date, 'yyyy-MM-dd hh24:mi:ss') as CHECK_DATE,
			su_confirmer.user_name as CONFIRMER,
			to_char(mtm.confirm_date, 'yyyy-MM-dd hh24:mi:ss') as CONFIRM_DATE, 
			sum(matd.amount_money) as MONEY_SUM, 
			sum(matd.amount_money) as MONEY_SUM_UPPER ,
			sum(matd.amount) as AMOUNT_SUM
		from mat_affi_tran_main mtm
		left join mat_affi_tran_detail matd 
			on mtm.group_id = matd.group_id and mtm.hos_id = matd.hos_id 
			and mtm.copy_code = matd.copy_code and mtm.tran_id = matd.tran_id 
		left join mat_bus_type mbt on mtm.bus_type = mtm.bus_type
		left join v_hos_dict out_hos on mtm.group_id = out_hos.group_id
			and mtm.in_hos_id = out_hos.hos_id and out_hos.is_stop = '0'
		left join hos_store_dict out_stroe on mtm.group_id = out_stroe.group_id
			and mtm.hos_id = out_stroe.hos_id and mtm.out_store_id = out_stroe.store_id
			and mtm.out_store_no = out_stroe.store_no and out_stroe.is_stop = '0'
		left join v_hos_dict in_hos on mtm.group_id = in_hos.group_id
			and mtm.in_hos_id = in_hos.hos_id and in_hos.is_stop = '0'
		left join hos_store_dict in_stroe on mtm.group_id = in_stroe.group_id
			and mtm.hos_id = in_stroe.hos_id and mtm.in_store_id = in_stroe.store_id
			and mtm.in_store_no = in_stroe.store_no
			and in_stroe.is_stop = '0'
		left join sys_user su_maker on mtm.group_id = su_maker.group_id
			and mtm.hos_id = su_maker.hos_id and mtm.maker = su_maker.user_id
		left join sys_user su_checker on mtm.group_id = su_checker.group_id
			and mtm.hos_id = su_checker.hos_id and mtm.checker = su_checker.user_id
		left join sys_user su_confirmer on mtm.group_id = su_confirmer.group_id
			and mtm.hos_id = su_confirmer.hos_id and mtm.confirmer = su_confirmer.user_id
		where mtm.group_id = #{group_id,jdbcType=NUMERIC}
			and mtm.hos_id = #{hos_id,jdbcType=NUMERIC}
			and mtm.copy_code = #{copy_code,jdbcType=VARCHAR}
			and mtm.tran_id=#{tran_id,jdbcType=NUMERIC}
		group by mtm.tran_no, mbt.bus_type_name, mtm.tran_method, mtm.tran_type, out_hos.hos_name,
			out_stroe.store_name, in_hos.hos_name, in_stroe.store_name, mtm.brief, su_maker.user_name,
			mtm.tran_date, su_checker.user_name, mtm.check_date, su_confirmer.user_name, mtm.confirm_date
	</select>
<select id="queryMatAffiTranPrintTemlateByMainBatch" parameterType="java.util.Map" resultType="java.util.Map">

		select mtm.tran_id as id,
			mtm.tran_no as TRAN_NO,
			mbt.bus_type_name as BUS_TYPE_CODE,
			case mtm.tran_method when 1 then '同价调拨' when 2 then '异价调拨' end as TRAN_METHOD,
			case mtm.tran_type when 1 then '院内调拨' when 2 then '院外调拨' end as TRAN_TYPE,
			out_hos.hos_name as OUT_HOS,
			out_stroe.store_name as OUT_STORE,
			in_hos.hos_name as IN_HOS ,
			in_stroe.store_name as IN_STORE,
			mtm.brief as BRIEF ,
			su_maker.user_name as MAKER ,
			to_char(mtm.tran_date, 'yyyy-MM-dd hh24:mi:ss') as TRAN_DATE,
			su_checker.user_name as CHECKER,
			to_char(mtm.check_date, 'yyyy-MM-dd hh24:mi:ss') as CHECK_DATE,
			su_confirmer.user_name as CONFIRMER,
			to_char(mtm.confirm_date, 'yyyy-MM-dd hh24:mi:ss') as CONFIRM_DATE, 
			sum(matd.amount_money) as MONEY_SUM, 
			sum(matd.amount_money) as MONEY_SUM_UPPER ,
			sum(matd.amount) as AMOUNT_SUM
		from mat_affi_tran_main mtm
		left join mat_affi_tran_detail matd 
			on mtm.group_id = matd.group_id and mtm.hos_id = matd.hos_id 
			and mtm.copy_code = matd.copy_code and mtm.tran_id = matd.tran_id 
		left join mat_bus_type mbt on mtm.bus_type = mtm.bus_type
		left join v_hos_dict out_hos on mtm.group_id = out_hos.group_id
			and mtm.in_hos_id = out_hos.hos_id and out_hos.is_stop = '0'
		left join hos_store_dict out_stroe on mtm.group_id = out_stroe.group_id
			and mtm.hos_id = out_stroe.hos_id and mtm.out_store_id = out_stroe.store_id
			and mtm.out_store_no = out_stroe.store_no and out_stroe.is_stop = '0'
		left join v_hos_dict in_hos on mtm.group_id = in_hos.group_id
			and mtm.in_hos_id = in_hos.hos_id and in_hos.is_stop = '0'
		left join hos_store_dict in_stroe on mtm.group_id = in_stroe.group_id
			and mtm.hos_id = in_stroe.hos_id and mtm.in_store_id = in_stroe.store_id
			and mtm.in_store_no = in_stroe.store_no
			and in_stroe.is_stop = '0'
		left join sys_user su_maker on mtm.group_id = su_maker.group_id
			and mtm.hos_id = su_maker.hos_id and mtm.maker = su_maker.user_id
		left join sys_user su_checker on mtm.group_id = su_checker.group_id
			and mtm.hos_id = su_checker.hos_id and mtm.checker = su_checker.user_id
		left join sys_user su_confirmer on mtm.group_id = su_confirmer.group_id
			and mtm.hos_id = su_confirmer.hos_id and mtm.confirmer = su_confirmer.user_id
		where mtm.group_id = #{group_id,jdbcType=NUMERIC}
			and mtm.hos_id = #{hos_id,jdbcType=NUMERIC}
			and mtm.copy_code = #{copy_code,jdbcType=VARCHAR}
			and mtm.tran_id in  (${paraId})
		group by mtm.tran_id, mtm.tran_no, mbt.bus_type_name, mtm.tran_method, mtm.tran_type, out_hos.hos_name,
			out_stroe.store_name, in_hos.hos_name, in_stroe.store_name, mtm.brief, su_maker.user_name,
			mtm.tran_date, su_checker.user_name, mtm.check_date, su_confirmer.user_name, mtm.confirm_date
		order by mtm.tran_id 
	</select>
	<!-- 入库明细表模板打印 -->
	<select id="queryMatAffiTranPrintTemlateByDetail" parameterType="java.util.Map" resultType="java.util.Map">

		select mtd.tran_id as id ,
			mid.inv_code as INV_CODE,
			mid.inv_name as INV_NAME,
			mid.inv_model as INV_MODEL,
			hu.unit_name as UNIT_CODE,
			mtd.price as PRICE,
			mtd.amount as AMOUNT,
			mtd.amount_money as MONEY,
			hfd.fac_name as FAC_NAME ,
			mtd.note as NOTE,
			hp.pack_name as PACK_CODE,
			mtd.num_exchange as NUM_EXCHANGE ,
			mtd.num as NUM,
			mtd.batch_sn as BATCH_SN,
			mtd.batch_no as BATCH_NO,
			'' as SN,
			mtd.bar_code as BAR_CODE,
			to_char(mtd.inva_date,'yyyy-MM-dd') as INVA_DATE,
			mld.location_name as LOCATION_NAME,
			to_char(mtd.disinfect_date,'yyyy-MM-dd') as DISINFECT_DATE,
			mtd.sale_price as SALE_PRICE,
			mtd.sale_money as SALE_MONEY,
			mtd.sell_price as SELL_PRICE,
			mtd.sell_money as SELL_MONEY,
			mtd.allot_price as ALLOT_PRICE,
			mtd.allot_money as ALLOT_MONEY,
			mldin.location_name as location_in_name,
  			mldout.location_name as location_out_name
		from mat_affi_tran_detail mtd
		left join mat_inv_dict mid on mtd.group_id = mid.group_id 
			and mtd.hos_id = mid.hos_id and mtd.copy_code = mid.copy_code
			and mtd.inv_id = mid.inv_id and mtd.inv_no = mid.inv_no
		left join hos_unit hu on hu.unit_code = mid.unit_code
		left join hos_fac_dict hfd on hfd.group_id = mid.group_id
			and hfd.hos_id = mid.hos_id and hfd.fac_id = mid.fac_id
			and hfd.fac_no = mid.fac_no
		left join hos_package hp on hp.pack_code = mtd.pack_code
		left join mat_location_dict mld on mld.group_id = mtd.group_id
			and mld.hos_id = mtd.hos_id and mld.copy_code = mtd.copy_code
			and mld.location_id = mtd.location_in_id
			and mld.is_stop = '0'
		left join mat_location_dict mldout on mldout.group_id = mtd.group_id
			and mldout.hos_id = mtd.hos_id
			and mldout.copy_code = mtd.copy_code
			and mldout.location_id = mtd.location_in_id
			and mldout.is_stop = '0' 
		left join mat_location_dict mldin on mldin.group_id = mtd.group_id
			and mldin.hos_id = mtd.hos_id
			and mldin.copy_code = mtd.copy_code
			and mldin.location_id = mtd.location_in_id
			and mldin.is_stop = '0'	
		where mtd.group_id =#{group_id,jdbcType=NUMERIC}
			and mtd.hos_id = #{hos_id,jdbcType=NUMERIC}
			and mtd.copy_code = #{copy_code,jdbcType=VARCHAR}
				<if test="p_num ==1">
				and mtd.tran_id in (${paraId})
				
				</if>
				<if test="p_num ==0">
				and mtd.tran_id=#{tran_id,jdbcType=NUMERIC}
				</if>	
		order by mtd.tran_detail_id 			  
	</select>
	
	<!-- 查询明细 -->
	<select id="queryMatAffiTranMainDetails" parameterType="java.util.Map" resultType="java.util.Map">
		with detail_tmp as (
			select 
			      mtm.group_id as group_id,
			      mtm.hos_id as hos_id,
			      mtm.copy_code as copy_code,
			      mtm.tran_id as tran_id,
			      to_char(mtm.tran_no) as tran_no,
			      mtm.year as year,
			      mtm.month as month,
			      mtm.bus_type as bus_type,
			      mtm.tran_date as tran_date,
			      mtm.out_hos_id as out_hos_id,
			      out_hid.hos_code as out_hos_code,
			      out_hid.hos_name as out_hos_name,
			      mtm.in_hos_id as in_hos_id,
			      in_hid.hos_code as in_hos_code,
			      in_hid.hos_name as in_hos_name,
			      mtm.out_store_id as out_store_id,
			      mtm.out_store_no as out_store_no,
			      out_hsd.store_code as out_store_code,
			      out_hsd.store_name as out_store_name,
			      mtm.in_store_id as in_store_id,
			      mtm.in_store_no as in_store_no,
			      in_hsd.store_code as in_store_code,
			      in_hsd.store_name as in_store_name,
			      mtm.maker as maker,
			      sumaker.user_name as maker_name,
			      mtm.checker as checker,
			      suchecker.user_name as checker_name, 
			      mtm.check_date as check_date,
			      mtr.out_id as out_id, 
			      mtr.out_no as out_no, 
			      mtm.confirmer as confirmer,
			      suconfirmer.user_name as confirmer_name,
			      mtm.confirm_date as confirm_date,
			      mtr.in_id as in_id, 
			      mtr.in_no as in_no, 
			      mtm.state as state, 
			      mid.inv_code,mid.inv_name,mid.inv_model,hu.unit_name,aa.amount,aa.price,aa.amount_money,
			      aa.bar_code,aa.batch_no,hfd.fac_name
	    	from mat_affi_tran_main mtm
	    	left join mat_affi_tran_detail aa on mtm.group_id=aa.group_id and mtm.hos_id=aa.hos_id
	    		and mtm.copy_code=aa.copy_code and mtm.tran_id=aa.tran_id
	    	left join mat_inv_dict mid on aa.group_id=mid.group_id and aa.hos_id=mid.hos_id and aa.copy_code=mid.copy_code
	    		and aa.inv_id=mid.inv_id and aa.inv_no=mid.inv_no
	    	left join hos_fac_dict hfd on mid.group_id=hfd.group_id and mid.hos_id=hfd.hos_id 
	    		and mid.fac_id=hfd.fac_id and mid.fac_no=hfd.fac_no
	    	left join hos_unit hu on mid.group_id=hu.group_id and mid.hos_id=hu.hos_id 
	    		and mid.unit_code=hu.unit_code and hu.is_stop=0	
	    	left join v_hos_dict out_hid  on mtm.group_id = out_hid.group_id 
	    		and mtm.out_hos_id = out_hid.hos_id 
	    		<if test="show_history == 0">
					and out_hid.is_stop=0
				</if>
	    	left join v_hos_dict in_hid  on mtm.group_id = in_hid.group_id 
		    	and mtm.in_hos_id = in_hid.hos_id 
		      	<if test="show_history == 0">
					and in_hid.is_stop=0
				</if>
		    left join hos_store_dict out_hsd on mtm.group_id = out_hsd.group_id 
		    	and mtm.hos_id = out_hsd.hos_id 
		      	and mtm.out_store_id = out_hsd.store_id 
		      	<if test="show_history == 1">
					and mtm.out_store_no = out_hsd.store_no
				</if>
				<if test="show_history == 0">
					and out_hsd.is_stop = 0
				</if>
	    	left join hos_store_dict in_hsd on mtm.group_id = in_hsd.group_id 
		    	and mtm.hos_id = in_hsd.hos_id 
		      	and mtm.in_store_id = in_hsd.store_id 
		      	<if test="show_history == 1">
					and mtm.in_store_no = in_hsd.store_no
				</if>
				<if test="show_history == 0">
					and in_hsd.is_stop = 0
				</if>
		    left join sys_user sumaker  on mtm.group_id = sumaker.group_id 
		    	and mtm.hos_id = sumaker.hos_id 
		      	and mtm.copy_code = sumaker.copy_code 
		      	and mtm.maker = sumaker.user_id
		    left join sys_user suchecker   on mtm.group_id = suchecker.group_id 
		    	and mtm.hos_id = suchecker.hos_id 
		      	and mtm.copy_code = suchecker.copy_code 
		      	and mtm.checker = suchecker.user_id 
		    left join sys_user suconfirmer 
		      on mtm.group_id = suconfirmer.group_id and mtm.hos_id = suconfirmer.hos_id 
		      and mtm.copy_code = suconfirmer.copy_code and mtm.confirmer = suconfirmer.user_id 
		    left join (
		      select group_id,
		      	hos_id,
		      	copy_code,
		      	tran_id,
		      	sum(amount_money) as amount_money 
		      from mat_affi_tran_detail
		      group by tran_id,group_id,hos_id,copy_code
		    ) mtd  on mtm.group_id = mtd.group_id and mtm.hos_id = mtd.hos_id  
		      and mtm.copy_code = mtd.copy_code and mtm.tran_id = mtd.tran_id 
		    left join mat_affi_tran_rela mtr
		      on mtm.group_id = mtr.group_id and mtm.hos_id = mtr.hos_id
		      and mtm.copy_code = mtr.copy_code and mtm.tran_id = mtr.tran_id
			<where>                     
				<if test="group_id != null and group_id != ''">
				AND mtm.group_id = #{group_id,jdbcType=INTEGER}
				</if>
				<if test="hos_id != null and hos_id != ''">
				AND mtm.hos_id = #{hos_id,jdbcType=INTEGER}
				</if>
				<if test="copy_code != null and copy_code != ''">
				AND mtm.copy_code = #{copy_code,jdbcType=VARCHAR}
				</if>
				<if test="tran_id != null and tran_id != ''">
				AND mtm.tran_id = #{tran_id,jdbcType=INTEGER}
				</if>
				<if test="tran_no != null and tran_no != ''">
				AND mtm.tran_no like '${tran_no}%'
				</if>
				<if test="year != null and year != ''">
				AND mtm.year = #{year,jdbcType=VARCHAR}
				</if>
				<if test="month != null and month != ''">
				AND mtm.month = #{month,jdbcType=VARCHAR}
				</if>
				<if test="bus_type != null and bus_type != ''">
				AND mtm.bus_type = #{bus_type,jdbcType=INTEGER}
				</if>
				<if test="tran_method != null and tran_method != ''">
				AND mtm.tran_method = #{tran_method,jdbcType=INTEGER}
				</if>
				<if test="tran_type != null and tran_type != ''">
				AND mtm.tran_type = #{tran_type,jdbcType=INTEGER}
				</if>
				<if test="out_hos_id != null and out_hos_id != ''">
				AND mtm.out_hos_id = #{out_hos_id,jdbcType=INTEGER}
				</if>
				<if test="out_store_id != null and out_store_id != ''">
				AND mtm.out_store_id = #{out_store_id,jdbcType=INTEGER}
				</if>
				<if test="out_store_no != null and out_store_no != ''">
				AND mtm.out_store_no = #{out_store_no,jdbcType=INTEGER}
				</if>
				<if test="in_hos_id != null and in_hos_id != ''">
				AND mtm.in_hos_id = #{in_hos_id,jdbcType=INTEGER}
				</if>
				<if test="in_store_id != null and in_store_id != ''">
				AND mtm.in_store_id = #{in_store_id,jdbcType=INTEGER}
				</if>
				<if test="in_store_no != null and in_store_no != ''">
				AND mtm.in_store_no = #{in_store_no,jdbcType=INTEGER}
				</if>
				<if test="brief != null ">
				AND mtm.brief like '%'||#{brief,jdbcType=VARCHAR}||'%'
				</if>
				<if test="tran_date != null and tran_date != ''">
				AND mtm.tran_date = #{tran_date,jdbcType=DATE}
				</if>
				<if test="maker != null and maker != ''">
				AND mtm.maker = #{maker,jdbcType=INTEGER}
				</if>
				<if test="checker != null and checker != ''">
				AND mtm.checker = #{checker,jdbcType=INTEGER}
				</if>
				<if test="check_date != null and check_date != ''">
				AND mtm.check_date = #{check_date,jdbcType=DATE}
				</if>
				<if test="confirmer != null and confirmer != ''">
				AND mtm.confirmer = #{confirmer,jdbcType=INTEGER}
				</if>
				<if test="confirm_date != null and confirm_date != ''">
				AND mtm.confirm_date = #{confirm_date,jdbcType=DATE}
				</if>
				<if test="state != null and state != ''">
				AND mtm.state = #{state,jdbcType=INTEGER}
				</if>
				<if test="sql!= null and sql != ''">
				${sql}
				</if>
			</where>   
			order by mtm.tran_no asc
		),sum_tmp as (
			select 
				null group_id,null hos_id, null copy_code,null tran_id,
			      '合计' tran_no,null year, null month,null bus_type,null tran_date,null out_hos_id,
			      null out_hos_code,null out_hos_name,null in_hos_id,null in_hos_code,null in_hos_name,null out_store_id,
			      null out_store_no,null out_store_code,null out_store_name,null in_store_id,null in_store_no,
			      null in_store_code,null in_store_name,null maker,null maker_name,null checker,null checker_name, null check_date,
			      null out_id,null out_no,null confirmer,null confirmer_name,null confirm_date,null in_id,null in_no,null state, 
			      null inv_code,null inv_name,null inv_model,null unit_name,sum(amount) amount,
			      0 price,sum(amount_money) amount_money,
			      null bar_code,null batch_no,null fac_name
			from detail_tmp
		)
		
		select
			 group_id, hos_id,  copy_code, tran_id,tran_no,year, month,bus_type,tran_date,out_hos_id,
			 out_hos_code, out_hos_name, in_hos_id, in_hos_code, in_hos_name, out_store_id,
			 out_store_no, out_store_code, out_store_name, in_store_id, in_store_no,
			 in_store_code, in_store_name, maker, maker_name,checker, checker_name, check_date,
			 out_id, out_no, confirmer, confirmer_name, confirm_date, in_id, in_no, state, 
			 inv_code, inv_name, inv_model, unit_name,amount, price,amount_money,
			 bar_code, batch_no, fac_name 
		from detail_tmp
		union all 
		select
			group_id, hos_id,  copy_code, tran_id,tran_no,year, month,bus_type,tran_date,out_hos_id,
			 out_hos_code, out_hos_name, in_hos_id, in_hos_code, in_hos_name, out_store_id,
			 out_store_no, out_store_code, out_store_name, in_store_id, in_store_no,
			 in_store_code, in_store_name, maker, maker_name,checker, checker_name, check_date,
			 out_id, out_no, confirmer, confirmer_name, confirm_date, in_id, in_no, state, 
			 inv_code, inv_name, inv_model, unit_name,amount, price,amount_money,
			 bar_code, batch_no, fac_name 
		from sum_tmp
		order by tran_id desc,tran_no,tran_date,inv_code
	</select>
	
	<!-- 查询对应关系表中的明细 -->
	<select id="queryMatAffiTranRela" parameterType="java.util.Map" resultType="java.util.Map">
		
		select t.group_id,t.hos_id,t.copy_code,t.rela_id,t.rela_detail_id
		from (
		      select a.group_id,a.hos_id,a.copy_code,a.rela_id,a.rela_detail_id
		      from  mat_apply_out_rela  a
		      join  (
		      	select group_id,hos_id,copy_code,tran_id,tran_detail_id
		      	from mat_affi_tran_detail
		      	<where>
		      			group_id = #{group_id,jdbcType=INTEGER}
					AND hos_id = #{hos_id,jdbcType=INTEGER}
					AND copy_code = #{copy_code,jdbcType=VARCHAR}
					AND tran_id = #{tran_id,jdbcType=INTEGER}
		      	</where>
		      ) b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
		      	and a.rela_id=b.tran_id
		      where a.rela_type=4
		      minus
		      select group_id,hos_id,to_char(copy_code) copy_code,tran_id,tran_detail_id
		      from mat_affi_tran_detail 
		      <where>
		      		group_id = #{group_id,jdbcType=INTEGER}
				AND hos_id = #{hos_id,jdbcType=INTEGER}
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
				AND tran_id = #{tran_id,jdbcType=INTEGER}
		      </where> 
		)t
		
	</select>
	
	<!-- 删除对应关系表中的明细 -->
	<delete id="deleteMatAffiTranRela" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			DELETE FROM mat_apply_out_rela
			<where>
				<if test="item.group_id != null ">
					AND group_id = #{item.group_id,jdbcType=INTEGER}
				</if>
				<if test="item.hos_id != null ">
					AND hos_id = #{item.hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
				</if>
				<if test="item.rela_id != null ">
					AND rela_id = #{item.rela_id,jdbcType=INTEGER}
				</if>
				<if test="item.rela_detail_id != null ">
					AND rela_detail_id = #{item.rela_detail_id,jdbcType=INTEGER}
				</if>
				and rela_type =4
			</where>
		</foreach>
	</delete>
	<select id="queryMatAffiTranMainIsApply" parameterType="java.util.List" resultType="Integer">
		select count(0) counts
		from mat_apply_out_rela
		<where>
			<if test="group_id != null and group_id !='' ">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id !='' ">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id !='' ">
				AND rela_id = #{tran_id,jdbcType=INTEGER}
			</if>
			and rela_type = 4
		</where>
	</select>
</mapper>

