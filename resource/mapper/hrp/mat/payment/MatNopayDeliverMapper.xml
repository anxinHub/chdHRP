<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.mat.dao.payment.MatNopayDeliverMapper">
	
	<resultMap id="matNopayDeliver" type="java.util.Map">
		<result property="group_id" column="group_id"/>
		<result property="hos_id" column="hos_id"/>
		<result property="copy_code" column="copy_code"/>
		<result property="deliver_id" column="deliver_id"/>
		<result property="deliver_no" column="deliver_no"/>
		<result property="origin_no" column="origin_no"/>
		<result property="year" column="year"/>
		<result property="month" column="month"/>
		<result property="sup_no" column="sup_no"/>
		<result property="sup_id" column="sup_id"/>
		<result property="sup_code" column="sup_code"/>
		<result property="sup_name" column="sup_name"/>
		<result property="store_id" column="store_id"/>
		<result property="store_no" column="store_no"/>
		<result property="store_code" column="store_code"/>
		<result property="store_name" column="store_name"/>
		<result property="brief" column="brief"/>
		<result property="stocker" column="stocker"/>
		<result property="stocker_name" column="stocker_name"/>
		<result property="stock_type_code" column="stock_type_code"/>
		<result property="stock_type_name" column="stock_type_name"/>
		<result property="confirmer" column="confirmer"/>
		<result property="confirmer_name" column="confirmer_name"/>
		<result property="confirm_date" column="confirm_date"/>
		<result property="maker" column="maker"/>
		<result property="maker_name" column="maker_name"/>
		<result property="in_date" column="in_date"/>
		<result property="checker" column="checker"/>
		<result property="checker_name" column="checker_name"/>
		<result property="check_date" column="check_date"/>
		<result property="state" column="state"/>
		<result property="protocol_id" column="protocol_id"/>
		<result property="protocol_code" column="protocol_code"/>
		<result property="protocol_name" column="protocol_name"/>
		<result property="app_dept" column="app_dept"/>
		<result property="dept_code" column="dept_code"/>
		<result property="dept_name" column="dept_name"/>
		<result property="proj_id" column="proj_id"/>
		<result property="proj_code" column="proj_code"/>
		<result property="proj_name" column="proj_name"/>
		<result property="amount_money" column="amount_money"/>
		<result property="source_id" column="source_id"/>
		<result property="source_money" column="source_money"/>
		<result property="bill_no" column="bill_no"/>
		<result property="bill_date" column="bill_date"/>
		<result property="bill_state" column="bill_state"/>
		<result property="bus_type_code" column="bus_type_code"/>
	</resultMap>
	
	<resultMap id="matCommonInOrder" type="java.util.Map">
		<result property="group_id" column="group_id"/>
		<result property="hos_id" column="hos_id"/>
		<result property="copy_code" column="copy_code"/>
		<result property="order_id" column="order_id"/>
		<result property="order_code" column="order_code"/>
		<result property="order_date" column="order_date"/>
		<result property="pur_type" column="pur_type"/>
		<result property="pur_type_name" column="pur_type_name"/>
		<result property="order_type" column="order_type"/>
		<result property="order_type_name" column="order_type_name"/>
		<result property="brif" column="brif"/>
		<result property="sup_id" column="sup_id"/>
		<result property="sup_no" column="sup_no"/>
		<result property="sup_name" column="sup_name"/>
		<result property="dept_id" column="dept_id"/>
		<result property="dept_no" column="dept_no"/>
		<result property="dept_name" column="dept_name"/>
		<result property="stocker" column="stocker"/>
		<result property="stocker_name" column="stocker_name"/>
		<result property="pur_hos_id" column="pur_hos_id"/>
		<result property="pur_hos_name" column="pur_hos_name"/>
		<result property="take_hos_id" column="take_hos_id"/>
		<result property="take_hos_name" column="take_hos_name"/>
		<result property="pay_hos_id" column="pay_hos_id"/>
		<result property="pay_hos_name" column="pay_hos_name"/>
		<result property="stock_type_code" column="stock_type_code"/>
		<result property="stock_type_name" column="stock_type_name"/>
		<result property="pay_code" column="pay_code"/>
		<result property="pay_name" column="pay_name"/>
		<result property="arr_address" column="arr_address"/>
		<result property="maker" column="maker"/>
		<result property="maker_name" column="maker_name"/>
		<result property="make_date" column="make_date"/>
		<result property="checker" column="checker"/>
		<result property="checker_name" column="checker_name"/>
		<result property="check_date" column="check_date"/>
		<result property="state" column="state"/>
		<result property="is_notice" column="is_notice"/>
		<result property="notice_date" column="notice_date"/>
		<result property="note" column="note"/>
	</resultMap>
	
	<resultMap id="matInDetailCommon" type="java.util.Map">
		<result property="group_id" column="group_id"/>
		<result property="hos_id" column="hos_id"/>
		<result property="copy_code" column="copy_code"/>
		<result property="deliver_id" column="deliver_id"/>
		<result property="deliver_no" column="deliver_no"/>
		<result property="detail_id" column="detail_id"/>
		<result property="inv_id" column="inv_id"/>
		<result property="inv_no" column="inv_no"/>
		<result property="inv_code" column="inv_code"/>
		<result property="left_amount" column="left_amount"/>
		<result property="left_money" column="left_money"/>
		<result property="inv_name" column="inv_name"/>
		<result property="inv_model" column="inv_model"/>
		<result property="unit_code" column="unit_code"/>
		<result property="unit_name" column="unit_name"/>
		<result property="batch_no" column="batch_no"/>
		<result property="batch_sn" column="batch_sn"/>
		<result property="price" column="price"/>
		<result property="amount" column="amount"/>
		<result property="amount_money" column="amount_money"/>
		
		<result property="sell_price" column="sell_price"/>
		<result property="sell_money" column="sell_money"/>
		<result property="allot_price" column="allot_price"/>
		<result property="allot_money" column="allot_money"/>
		<result property="pack_code" column="pack_code"/>
		<result property="pack_name" column="pack_name"/>
		<result property="num_exchange" column="num_exchange"/>
		<result property="pack_price" column="pack_price"/>
		<result property="num" column="num"/>
		<result property="bar_code" column="bar_code"/>
		<result property="is_bar" column="is_bar"/>
		<result property="is_per_bar" column="is_per_bar"/>
		<result property="sn" column="sn"/>
		
		<result property="brief" column="brief"/>
		<result property="bus_type_code" column="bus_type_code"/>
		<result property="bus_type_name" column="bus_type_name"/>
		<result property="dept_id" column="dept_id"/>
		<result property="dept_no" column="dept_no"/>
		<result property="dept_code" column="dept_code"/>
		<result property="dept_name" column="dept_name"/>
		<result property="sup_id" column="sup_id"/>
		<result property="sup_no" column="sup_no"/>
		<result property="sup_code" column="sup_code"/>
		<result property="sup_name" column="sup_name"/>
		<result property="dept_emp" column="dept_emp"/>
		<result property="dept_emp_name" column="dept_emp_name"/>
		<result property="out_date" column="out_date"/>
		<result property="maker" column="maker"/>
		<result property="maker_name" column="maker_name"/>
		<result property="checker" column="checker"/>
		<result property="checker_name" column="checker_name"/>
		<result property="check_date" column="check_date"/>
		<result property="confirmer" column="confirmer"/>
		<result property="confirmer_name" column="confirmer_name"/>
		<result property="confirm_date" column="confirm_date"/>
		<result property="state" column="state"/>
		
		<result property="inva_date" column="inva_date"/>
		<result property="out_id" column="out_id"/>
		<result property="out_no" column="out_no"/>
		<result property="year" column="year"/>
		<result property="month" column="month"/>
		<result property="detail_id" column="detail_id"/>
		<result property="store_id" column="store_id"/>
		<result property="store_no" column="store_no"/>
		<result property="store_name" column="store_name"/>
		<result property="disinfect_date" column="disinfect_date"/>
		<result property="location_id" column="location_id"/>
		<result property="location_code" column="location_code"/>
		<result property="location_name" column="location_name"/>
		<result property="order_rela" column="order_rela"/>
		<result property="note" column="note"/>
		<result property="out_detail_id" column="out_detail_id" />
	</resultMap>
	<!-- 新增期初未付款供货单入库主表数据-->
	<insert id="addMatNopayDeliver" parameterType="java.util.Map">
		INSERT INTO MAT_NOPAY_DELIVER (
			group_id, hos_id, copy_code, deliver_id, deliver_no, origin_no , year, month, 
			sup_id, sup_no, store_id, store_no, brief, stocker, stock_type_code, maker, 
			in_date, state, bill_state, bus_type_code, amount_money 
			<if test="bill_no != null and bill_no != ''">, bill_no</if>
			<if test="bill_date != null and bill_date != ''">, bill_date</if>
			<if test="checker != null and checker != ''">, checker</if>
			<if test="check_date != null and check_date != ''">, check_date</if>
			<if test="confirmer != null and confirmer != ''">, confirmer</if>
			<if test="confirm_date != null and confirm_date != ''">, confirm_date</if>
			<if test="protocol_code != null and protocol_code != ''">, protocol_code</if>
			<if test="app_dept != null and app_dept != ''">, app_dept</if>
			<if test="proj_id != null and proj_id != ''">, proj_id</if>
		) VALUES (
			#{group_id,jdbcType=INTEGER},
			#{hos_id,jdbcType=INTEGER},
			#{copy_code,jdbcType=VARCHAR},
			#{deliver_id,jdbcType=INTEGER},
			#{deliver_no,jdbcType=VARCHAR},
			#{origin_no,jdbcType=VARCHAR},
			#{year,jdbcType=VARCHAR},
			#{month,jdbcType=VARCHAR},
			#{sup_id,jdbcType=INTEGER},
			#{sup_no,jdbcType=INTEGER},
			#{store_id,jdbcType=INTEGER},
			#{store_no,jdbcType=INTEGER},
			#{brief,jdbcType=VARCHAR},
			#{stocker,jdbcType=INTEGER},
			#{stock_type_code,jdbcType=VARCHAR},
			#{maker,jdbcType=INTEGER},
			#{in_date,jdbcType=DATE},
			1, 
			#{bill_state,jdbcType=INTEGER}, 
			#{bus_type_code,jdbcType=VARCHAR}, 
			#{amount_money,jdbcType=FLOAT} 
			<if test="bill_no != null and bill_no != ''">, #{bill_no,jdbcType=VARCHAR}</if>
			<if test="bill_date != null and bill_date != ''">, #{bill_date,jdbcType=DATE}</if>
			<if test="checker != null and checker != ''">, #{checker,jdbcType=INTEGER}</if>
			<if test="check_date != null and check_date != ''">, #{check_date,jdbcType=DATE}</if>
			<if test="confirmer != null and confirmer != ''">, #{confirmer,jdbcType=INTEGER}</if>
			<if test="confirm_date != null and confirm_date != ''">,#{confirm_date,jdbcType=DATE}</if>
			<if test="protocol_code != null and protocol_code != ''">, #{protocol_code,jdbcType=VARCHAR}</if>
			<if test="app_dept != null and app_dept != ''">, #{app_dept,jdbcType=INTEGER}</if>
			<if test="proj_id != null and proj_id != ''">, #{proj_id,jdbcType=INTEGER}</if>
		)
	</insert>
	<!-- 期初未付款供货单 主查询 -->
	<select id="queryMatNopayDeliver" parameterType="java.util.Map" resultMap="matNopayDeliver" >
		SELECT 
			mnd.group_id, mnd.hos_id, mnd.copy_code, mnd.deliver_id, mnd.deliver_no, mnd.origin_no , mnd.year,
			mnd.month , mnd.sup_id, mnd.sup_no, hsd.sup_name, mnd.store_id, mnd.store_no, hsc.store_name, mnd.brief, 
			mnd.stocker, he.emp_name as stocker_name, mnd.stock_type_code , mst.stock_type_name ,  mnd.confirmer ,
			hed.emp_name as confirmer_name, mnd.confirm_date, mnd.maker, su.user_name as maker_name, mnd.in_date,
			mnd.checker, syu.user_name as checker_name , mnd.check_date, mnd.state , mnd.protocol_code , mnd.app_dept,
			hdd.dept_code, hdd.dept_name, mnd.proj_id ,	mnd.amount_money, mnd.bill_no, mnd.bill_date, 
			case mnd.bill_state when 0 then '货到票未到' when 1 then '货票同到' else '未维护' end bill_state
		FROM MAT_NOPAY_DELIVER  mnd
		LEFT JOIN HOS_DEPT_DICT hdd
			ON 
				mnd.group_id = hdd.group_id
				and mnd.hos_id = hdd.hos_id
				and mnd.app_dept = hdd.dept_id
				and hdd.is_stop = 0
		LEFT JOIN hos_store_dict hsc
			on mnd.group_id = hsc.group_id
			and mnd.hos_id = hsc.hos_id
			and mnd.store_id = hsc.store_id
			and mnd.store_no = hsc.store_no
			and hsc.is_stop = 0
		LEFT JOIN sys_user su
			on mnd.group_id = su.group_id
			and mnd.hos_id = su.hos_id
			and mnd.maker = su.user_id
		LEFT JOIN sys_user syu
			on mnd.group_id = syu.group_id
			and mnd.hos_id = syu.hos_id
			and mnd.checker = syu.user_id
		LEFT JOIN hos_emp_dict hed
			on mnd.group_id = hed.group_id
			and mnd.hos_id = hed.hos_id
			and mnd.confirmer = hed.emp_id
			and hed.is_stop = 0
		LEFT JOIN hos_sup_dict hsd
			on mnd.group_id = hsd.group_id
			and mnd.hos_id = hsd.hos_id
			and mnd.sup_id = hsd.sup_id
			and hsd.is_stop = 0
		LEFT JOIN hos_emp_dict he
			on mnd.group_id = he.group_id
			and mnd.hos_id = he.hos_id
			and mnd.stocker = he.emp_id
			and he.is_stop = 0
		LEFT JOIN mat_stock_type mst
			ON 
				mnd.group_id = mst.group_id
				and mnd.hos_id = mst.hos_id
				and mnd.copy_code = mst.copy_code
				and mnd.stock_type_code = mst.stock_type_code
				and hdd.is_stop = 0
		WHERE 
			mnd.group_id = #{group_id,jdbcType=INTEGER}
			AND mnd.hos_id = #{hos_id,jdbcType=INTEGER}
			AND mnd.copy_code = #{copy_code,jdbcType=VARCHAR}
			<if test="begin_confirm_date != null and begin_confirm_date != '' and end_confirm_date != null and end_confirm_date != '' ">
				AND mnd.confirm_date between #{begin_confirm_date,jdbcType=DATE} and  #{end_confirm_date,jdbcType=DATE}
			</if>
			<if test="begin_check_date != null and begin_check_date != '' and end_check_date != null and end_check_date != '' ">
				AND mnd.check_date between #{begin_check_date,jdbcType=DATE} and  #{end_check_date,jdbcType=DATE}
			</if>
			<if test="begin_in_date != null and begin_in_date != '' and end_in_date != null and end_in_date != '' ">
				AND mnd.in_date between #{begin_in_date,jdbcType=DATE} and  #{end_in_date,jdbcType=DATE}
			</if>
			<if test="state != null and state != ''">
				AND mnd.state = #{state,jdbcType=INTEGER}
			</if>
			<if test="store_id != null and store_id != ''">
				AND mnd.store_id = #{store_id,jdbcType=INTEGER}
			</if>
			<if test="sup_id != null and sup_id != ''">
				AND mnd.sup_id = #{sup_id,jdbcType=INTEGER}
			</if>
			<if test="deliver_no != null and deliver_no != ''">
				AND mnd.deliver_no like '%${deliver_no}%'
			</if>
			<if test="origin_no != null and origin_no != ''">
				AND mnd.origin_no like '%${origin_no}%'
			</if>
			<if test="bill_no != null and bill_no != ''">
				AND mnd.bill_no like '${bill_no}%'
			</if>
			<if test="bill_state != null and bill_state != ''">
				AND mnd.bill_state = #{bill_state,jdbcType=INTEGER}
			</if>
		order by mnd.deliver_id
	</select>
	
	
	<!-- 根据 ID 查询 期初未付款供货单主表 MAT_NOPAY_DELIVER 数据 -->
	<select id="queryMatNopayDeliverById" parameterType="java.util.Map" resultMap="matNopayDeliver" >
		SELECT 
			group_id, hos_id, copy_code, deliver_id, deliver_no, origin_no, year, month , sup_id, sup_no, store_id, 
			store_no, brief, stocker, stock_type_code, confirmer, confirm_date, maker, in_date,checker, check_date,
			state, protocol_code , app_dept , proj_id, amount_money, bill_no, bill_date, bill_state , BUS_TYPE_CODE
		FROM MAT_NOPAY_DELIVER 
		WHERE 
			group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			<if test="deliver_id != null and deliver_id != ''">
				AND deliver_id = #{deliver_id,jdbcType=INTEGER}
			</if>
			<if test="deliver_no != null and deliver_no != ''">
				AND deliver_no = #{deliver_no , jdbcType=VARCHAR}
			</if>
		order by deliver_id
	</select>
	
	<!-- 根据主键Id获取 期初未付款供货单 明细表List -->
	<select id="queryMatNopayDeliverDetailById" parameterType="java.util.Map" resultMap="matInDetailCommon" >
		SELECT mndd.group_id, mndd.hos_id, mndd.copy_code, mndd.deliver_id, mndd.deliver_no, mndd.detail_id, 
			mndd.inv_id, mndd.inv_no, mndd.batch_no, mndd.price, mndd.amount, mndd.amount_money, mndd.sale_price, 
			mndd.sale_money, mndd.sell_price, mndd.sell_money, mndd.pack_code, mndd.num_exchange, mndd.pack_price, 
			mndd.num, mndd.bar_code, mndd.inva_date, mndd.disinfect_date, mndd.location_id, mndd.note ,mid.is_bar ,
			mid.is_per_bar , mnd.sup_id , mnd.sup_no , hsd.sup_name 
		FROM MAT_NOPAY_DELIVER_D  mndd
		left join mat_inv_dict mid
			ON
				mndd.group_id = mid.group_id 
				and mndd.hos_id = mid.hos_id
				and mndd.copy_code = mid.copy_code
				and mndd.inv_id = mid.inv_id
				and mndd.inv_no = mid.inv_no
		left join MAT_NOPAY_DELIVER mnd
			ON 
				mndd.group_id = mnd.group_id 
				and mndd.hos_id = mnd.hos_id
				and mndd.copy_code = mnd.copy_code
				and mndd.deliver_id = mnd.deliver_id
				and mndd.deliver_no = mnd.deliver_no
		LEFT JOIN hos_sup_dict hsd
			on mnd.group_id = hsd.group_id
			and mnd.hos_id = hsd.hos_id
			and mnd.sup_id = hsd.sup_id
			<!-- and mnd.sup_no = hsd.sup_no -->
			and hsd.is_stop = 0
		WHERE mndd.group_id = #{group_id,jdbcType=INTEGER}
			AND mndd.hos_id = #{hos_id,jdbcType=INTEGER}
			AND mndd.copy_code = #{copy_code,jdbcType=VARCHAR}
			AND mndd.deliver_id = #{deliver_id,jdbcType=INTEGER}
			AND mndd.deliver_no = #{deliver_no,jdbcType=VARCHAR}
	</select>
	
	<!-- 用于期初未付款供货单  更新页面加载 -->
	<select id="queryMatNopayDeliverMainUpdate" resultMap="matNopayDeliver" parameterType="java.util.Map" >
		SELECT mnd.group_id, mnd.hos_id, mnd.copy_code, mnd.deliver_id, mnd.deliver_no, mnd.origin_no , mnd.year, 
			mnd.month , mnd.sup_id, mnd.sup_no, hsd.sup_name, mnd.store_id, mnd.store_no, hsc.store_name, mnd.brief, 
			mnd.stocker, he.emp_name as stocker_name, mnd.stock_type_code , mst.stock_type_name ,  mnd.confirmer ,
			hed.emp_name as confirmer_name, mnd.confirm_date, mnd.maker, su.user_name as maker_name, mnd.in_date,
			mnd.checker, syu.user_name as checker_name , mnd.check_date, mnd.state , mnd.protocol_code , mpm.protocol_name,
			mnd.app_dept, hdd.dept_code, hdd.dept_name, mnd.proj_id , hpd.proj_code , hpd.proj_name, mnd.amount_money, 
			mnd.in_date, mnd.bill_no, mnd.bill_date, mnd.bill_state 
		FROM MAT_NOPAY_DELIVER  mnd
		left join hos_store_dict hsc 
			on mnd.group_id = hsc.group_id
			and mnd.hos_id = hsc.hos_id
			and mnd.store_id = hsc.store_id
			and hsc.is_stop = 0 
		left join hos_dept_dict hdd 
			on mnd.group_id = hdd.group_id
			and mnd.hos_id = hdd.hos_id
			and mnd.app_dept = hdd.dept_id
			and hsc.is_stop = 0 
		left join mat_stock_type mst 
			on mnd.group_id = mst.group_id
			and mnd.hos_id = mst.hos_id
			and mnd.copy_code = mst.copy_code
			and mnd.stock_type_code = mst.stock_type_code
			and mst.is_stop = 0 
		left join sys_user su on mnd.group_id = su.group_id
			and mnd.hos_id = su.hos_id
			and mnd.maker = su.user_id 
		left join hos_emp_dict hed 
			on mnd.group_id = hed.group_id
			and mnd.hos_id = hed.hos_id
			and mnd.confirmer = hed.emp_id 
			and hed.is_stop = 0 
		left join sys_user syu 
			on mnd.group_id = syu.group_id
			and mnd.hos_id = syu.hos_id
			and mnd.checker = syu.user_id 
		left join hos_sup_dict hsd 
			on mnd.group_id = hsd.group_id
			and mnd.hos_id = hsd.hos_id
			and mnd.sup_id = hsd.sup_id
			and hsd.is_stop = 0 
		left join hos_emp_dict he 
			on mnd.group_id = he.group_id
			and mnd.hos_id = he.hos_id
			and mnd.stocker = he.emp_id 
			and he.is_stop = 0
		left join MAT_PROTOCOL_MAIN mpm 
			on mnd.group_id = mpm.group_id
			and mnd.hos_id = mpm.hos_id
			and mnd.copy_code = mpm.copy_code
			and mnd.protocol_code = mpm.protocol_code 
		left join hos_proj_dict hpd 
			on mnd.group_id = hpd.group_id
			and mnd.hos_id = hpd.hos_id
			and mnd.proj_id = hpd.proj_id 
			and hpd.is_stop = 0 
		WHERE mnd.group_id = #{group_id,jdbcType=INTEGER}
			AND mnd.hos_id = #{hos_id,jdbcType=INTEGER}
			AND mnd.copy_code = #{copy_code,jdbcType=VARCHAR}
			AND mnd.deliver_id = #{deliver_id,jdbcType=INTEGER}
	</select>
	
	<!-- 期初未付款供货单主表 审核或消审 -->
	<update id="updateStateMatNopayDeliver" parameterType="java.util.List">
		<foreach collection="list" index="index" item="item" open="begin" separator=";" close=";end;">
			update MAT_NOPAY_DELIVER set 
				state = #{item.state,jdbcType=INTEGER}, 
				checker = #{item.checker,jdbcType=INTEGER}, 
				check_date = #{item.check_date,jdbcType=DATE}, 
				confirm_date = #{item.check_date,jdbcType=DATE} 
			WHERE
				group_id = #{item.group_id,jdbcType=INTEGER}
				and hos_id = #{item.hos_id,jdbcType=INTEGER}
				and copy_code = #{item.copy_code,jdbcType=VARCHAR}
				and deliver_id = #{item.deliver_id,jdbcType=INTEGER}
		</foreach>
	</update>
	
	<!-- 删除期初未付款供货单明细数据  -->
	<delete id="deleteMatNopayDeliverDetail" parameterType="java.util.Map">
		DELETE FROM mat_nopay_deliver_d
		<where>
			group_id = #{group_id,jdbcType=INTEGER}
			and hos_id = #{hos_id,jdbcType=INTEGER}
			and copy_code = #{copy_code,jdbcType=VARCHAR}
			and deliver_id = #{deliver_id,jdbcType=INTEGER}
			<if test=" detial_id != null and detial_id != ''">
				and detial_id = #{detial_id,jdbcType=INTEGER}
			</if>
			<if test=" inv_id != null and inv_id != ''">
				and inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test=" inv_no != null and inv_no != ''">
				and inv_no = #{inv_no,jdbcType=INTEGER}
			</if>
			<if test=" batch_sn != null and item.batch_sn != ''">
				and batch_sn = #{batch_sn,jdbcType=INTEGER}
			</if>
			<if test=" batch_no != null and batch_no != ''">
				and batch_no = #{batch_no,jdbcType=VARCHAR}
			</if>
		</where>
	</delete>
	
	<!-- 批量删除期初未付款供货单 明细数据  -->
	<delete id="deleteMatNopayDeliverDetailBatch" parameterType="java.util.List">
		DELETE FROM MAT_NOPAY_DELIVER_D
		<where>
			<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
			group_id = #{item.group_id,jdbcType=INTEGER}
			and hos_id = #{item.hos_id,jdbcType=INTEGER}
			and copy_code = #{item.copy_code,jdbcType=VARCHAR}
			and deliver_id = #{item.deliver_id,jdbcType=INTEGER}
			<if test=" item.detail_id != null and item.detail_id != '' ">
			and detail_id = #{item.detail_id,jdbcType=INTEGER}
			</if>
		</foreach> 
		</where>
	</delete>
	
	<!-- 批量删除期初未付款供货单主表数据  -->
	<delete id="deleteMatNopayDeliverBatch" parameterType="java.util.List">
		DELETE FROM MAT_NOPAY_DELIVER
		<where>
			<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
			group_id = #{item.group_id,jdbcType=INTEGER}
			and hos_id = #{item.hos_id,jdbcType=INTEGER}
			and copy_code = #{item.copy_code,jdbcType=VARCHAR}
			and deliver_id = #{item.deliver_id,jdbcType=INTEGER}
		</foreach> 
		</where>
	</delete>
	
	<!-- (添加时)查询 期初未付款供货单主表  要插入的ID -->
	<select id="queryMatNopayDeliverNextval"  resultType="java.lang.Long" useCache="false" flushCache="true">
		SELECT MAT_NOPAY_DELIVER_SEQ.nextval  FROM DUAL
	</select>
	
	<!-- (添加时)查询 期初未付款供货单明细表  要插入的ID -->
	<select id="queryMatNopayDeliverDetailSeq"  resultType="java.lang.Long" useCache="false" flushCache="true">
		SELECT MAT_NOPAY_DELIVER_D_SEQ.nextval  FROM DUAL
	</select>
	
	<!-- 批量 新增期初未付款供货单主表数据-->
	<insert id="addMatNopayDeliverBatch" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			INSERT INTO MAT_NOPAY_DELIVER (
				group_id, hos_id, copy_code, deliver_id, deliver_no, origin_no, year, month, sup_id, sup_no ,
				store_id, store_no, stocker ,   maker, in_date, state, bill_state, bus_type_code, amount_money
				<if test="item.bill_no != null and item.bill_no != ''">, bill_no</if>
				<if test="item.bill_date != null and item.bill_date != ''">, bill_date</if>
				<if test="item.stock_type_code != null and item.stock_type_code != ''">, stock_type_code</if>
				<if test="item.brief != null and item.brief != ''">, brief</if>
				<if test="item.checker != null and item.checker != ''">, checker</if>
				<if test="item.check_date != null and item.check_date != ''">, check_date</if>
				<if test="item.confirmer != null and item.confirmer != ''">, confirmer</if>
				<if test="item.confirm_date != null and item.confirm_date != ''">, confirm_date</if>
				<if test="item.protocol_code != null and item.protocol_code != ''">, protocol_code</if>
				<if test="item.app_dept != null and item.app_dept != ''">, app_dept</if>
				<if test="item.proj_id != null and item.proj_id != ''">, proj_id</if>
			) VALUES (
				#{item.group_id,jdbcType=INTEGER},
				#{item.hos_id,jdbcType=INTEGER},
				#{item.copy_code,jdbcType=VARCHAR},
				#{item.deliver_id,jdbcType=INTEGER},
				#{item.deliver_no,jdbcType=VARCHAR},
				#{item.origin_no,jdbcType=VARCHAR},
				#{item.year,jdbcType=VARCHAR},
				#{item.month,jdbcType=VARCHAR},
				#{item.sup_id,jdbcType=INTEGER},
				#{item.sup_no,jdbcType=INTEGER},
				#{item.store_id,jdbcType=INTEGER},
				#{item.store_no,jdbcType=INTEGER},
				#{item.stocker,jdbcType=INTEGER},
				#{item.maker,jdbcType=INTEGER},
				#{item.in_date,jdbcType=DATE},
				#{item.state,jdbcType=INTEGER},
				#{item.bill_state,jdbcType=INTEGER},
				#{item.bus_type_code,jdbcType=VARCHAR}, 
				#{item.amount_money,jdbcType=FLOAT}
				<if test="item.bill_no != null and item.bill_no != ''">, #{item.bill_no,jdbcType=VARCHAR}</if>
				<if test="item.bill_date != null and item.bill_date != ''">, #{item.bill_date,jdbcType=DATE}</if>
				<if test="item.stock_type_code != null and item.stock_type_code != ''">, #{item.stock_type_code,jdbcType=VARCHAR}</if>
				<if test="item.brief != null and item.brief != ''">, #{item.brief,jdbcType=VARCHAR}</if>
				<if test="item.checker != null and item.checker != ''">, #{item.checker,jdbcType=INTEGER}</if>
				<if test="item.check_date != null and item.check_date != ''">, #{item.check_date,jdbcType=DATE}</if>
				<if test="item.confirmer != null and item.confirmer != ''">, #{item.confirmer,jdbcType=INTEGER}</if>
				<if test="item.confirm_date != null and item.confirm_date != ''">, #{item.confirm_date,jdbcType=DATE}</if>
				<if test="item.protocol_code != null and item.protocol_code != ''">, #{item.protocol_code,jdbcType=VARCHAR}</if>
				<if test="item.app_dept != null and item.app_dept != ''">, #{item.app_dept,jdbcType=INTEGER}</if>
				<if test="item.proj_id != null and item.proj_id != ''">, #{item.proj_id,jdbcType=INTEGER}</if>
			)
		</foreach>
	</insert>
	
	<!-- 批量添加  期初未付款供货单明细表数据 -->
	<insert id="addMatNopayDeliverDetailBatch" parameterType="java.util.List" >
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			INSERT INTO MAT_NOPAY_DELIVER_D (
				group_id, hos_id, copy_code, deliver_id, deliver_no, detail_id, inv_id, inv_no, batch_no,
				price, amount, amount_money  
				<if test="item.sale_price != null and item.sale_price != ''">, sale_price</if>
				<if test="item.sale_money != null and item.sale_money != ''">, sale_money</if>
					<if test="item.sell_price != null and item.sell_price != ''">, sell_price</if>
				<if test="item.sell_money != null and item.sell_money != ''">, sell_money</if>
				<if test="item.pack_code != null and item.pack_code != ''">, pack_code</if>
				<if test="item.num_exchange != null and item.num_exchange != ''">, num_exchange</if>
				<if test="item.pack_price != null and item.pack_price != ''">, pack_price</if>
				<if test="item.num != null and item.num != ''">, num</if>
				<if test="item.bar_code != null and item.bar_code != ''">, bar_code</if>
				<if test="item.inva_date != null and item.inva_date != ''">, inva_date</if>
				<if test="item.disinfect_date != null and item.disinfect_date != ''">, disinfect_date</if>
				<if test="item.location_id != null and item.location_id != ''">, location_id</if>
				<if test="item.note != null and item.note != ''">, note</if>
			) 
			values(
				#{item.group_id,jdbcType=INTEGER},
				#{item.hos_id,jdbcType=INTEGER},
				#{item.copy_code,jdbcType=VARCHAR},
				#{item.deliver_id,jdbcType=INTEGER},
				#{item.deliver_no,jdbcType=VARCHAR},
				#{item.detail_id,jdbcType=INTEGER}, 
				#{item.inv_id,jdbcType=INTEGER},
				#{item.inv_no,jdbcType=INTEGER},
				#{item.batch_no,jdbcType=VARCHAR},
				#{item.price,jdbcType=FLOAT},
				#{item.amount,jdbcType=FLOAT},
				#{item.amount_money,jdbcType=FLOAT}
				
				<if test="item.sale_price != null and item.sale_price != ''">, #{item.sale_price,jdbcType=FLOAT}</if>
				<if test="item.sale_money != null and item.sale_money != ''">, #{item.sale_money,jdbcType=FLOAT}</if>
				<if test="item.sell_price != null and item.sell_price != ''">, #{item.sell_price,jdbcType=FLOAT}</if>
				<if test="item.sell_money != null and item.sell_money != ''">, #{item.sell_money,jdbcType=FLOAT}</if>
				<if test="item.pack_code != null and item.pack_code != ''">, #{item.pack_code,jdbcType=VARCHAR}</if>
				<if test="item.num_exchange != null and item.num_exchange != ''">, #{item.num_exchange,jdbcType=INTEGER}</if>
				<if test="item.pack_price != null and item.pack_price != ''">, #{item.pack_price,jdbcType=INTEGER}</if>
				<if test="item.num != null and item.num != ''">, #{item.num,jdbcType=INTEGER}</if>
				<if test="item.bar_code != null and item.bar_code != ''">, #{item.bar_code,jdbcType=VARCHAR}</if>
				<if test="item.inva_date != null and item.inva_date != ''">, #{item.inva_date,jdbcType=DATE}</if>
				<if test="item.disinfect_date != null and item.disinfect_date != ''">, #{item.disinfect_date,jdbcType=DATE}</if>
				<if test="item.location_id != null and item.location_id != ''">, #{item.location_id,jdbcType=INTEGER}</if>
				<if test="item.note != null and item.note != ''">, #{item.note,jdbcType=VARCHAR}</if>
			)
		</foreach>
	</insert>
	<!-- 批量添加  期初未付款供货单明细表数据 -->
	<insert id="addBatch" parameterType="java.util.List" >
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			INSERT INTO MAT_NOPAY_DELIVER_D (
				group_id, hos_id, copy_code, deliver_id, deliver_no, detail_id, inv_id, inv_no, batch_no,
				price, amount, amount_money  
				<if test="item.sale_price != null and item.sale_price != ''">, sale_price</if>
				<if test="item.sale_money != null and item.sale_money != ''">, sale_money</if>
					<if test="item.sell_price != null and item.sell_price != ''">, sell_price</if>
				<if test="item.sell_money != null and item.sell_money != ''">, sell_money</if>
				<if test="item.pack_code != null and item.pack_code != ''">, pack_code</if>
				<if test="item.num_exchange != null and item.num_exchange != ''">, num_exchange</if>
				<if test="item.pack_price != null and item.pack_price != ''">, pack_price</if>
				<if test="item.num != null and item.num != ''">, num</if>
				<if test="item.bar_code != null and item.bar_code != ''">, bar_code</if>
				<if test="item.inva_date != null and item.inva_date != ''">, inva_date</if>
				<if test="item.disinfect_date != null and item.disinfect_date != ''">, disinfect_date</if>
				<if test="item.location_id != null and item.location_id != ''">, location_id</if>
				<if test="item.note != null and item.note != ''">, note</if>
			) 
			values(
				#{item.group_id,jdbcType=INTEGER},
				#{item.hos_id,jdbcType=INTEGER},
				#{item.copy_code,jdbcType=VARCHAR},
				#{item.deliver_id,jdbcType=INTEGER},
				#{item.deliver_no,jdbcType=VARCHAR},
				mat_nopay_deliver_d_seq.nextval,
				#{item.inv_id,jdbcType=INTEGER},
				#{item.inv_no,jdbcType=INTEGER},
				#{item.batch_no,jdbcType=VARCHAR},
				#{item.price,jdbcType=FLOAT},
				#{item.amount,jdbcType=FLOAT},
				#{item.amount_money,jdbcType=FLOAT}
				
				<if test="item.sale_price != null and item.sale_price != ''">, #{item.sale_price,jdbcType=FLOAT}</if>
				<if test="item.sale_money != null and item.sale_money != ''">, #{item.sale_money,jdbcType=FLOAT}</if>
				<if test="item.sell_price != null and item.sell_price != ''">, #{item.sell_price,jdbcType=FLOAT}</if>
				<if test="item.sell_money != null and item.sell_money != ''">, #{item.sell_money,jdbcType=FLOAT}</if>
				<if test="item.pack_code != null and item.pack_code != ''">, #{item.pack_code,jdbcType=VARCHAR}</if>
				<if test="item.num_exchange != null and item.num_exchange != ''">, #{item.num_exchange,jdbcType=INTEGER}</if>
				<if test="item.pack_price != null and item.pack_price != ''">, #{item.pack_price,jdbcType=INTEGER}</if>
				<if test="item.num != null and item.num != ''">, #{item.num,jdbcType=INTEGER}</if>
				<if test="item.bar_code != null and item.bar_code != ''">, #{item.bar_code,jdbcType=VARCHAR}</if>
				<if test="item.inva_date != null and item.inva_date != ''">, to_date(#{item.inva_date},'yyyy-MM-dd')</if>
				<if test="item.disinfect_date != null and item.disinfect_date != ''">, to_date(#{item.disinfect_date},'yyyy-MM-dd')</if>
				<if test="item.location_id != null and item.location_id != ''">, #{item.location_id,jdbcType=INTEGER}</if>
				<if test="item.note != null and item.note != ''">, #{item.note,jdbcType=VARCHAR}</if>
			)
		</foreach>
	</insert>
	
	<!-- 修改  期初未付款供货单主表数据 -->
	<update id="updateMatNopayDeliver" parameterType="java.util.Map">
		update MAT_NOPAY_DELIVER
		set
			deliver_no = #{deliver_no,jdbcType=VARCHAR},
			sup_id = #{sup_id,jdbcType=INTEGER},
			sup_no = #{sup_no,jdbcType=INTEGER},
			store_id = #{store_id,jdbcType=INTEGER},
			store_no = #{store_no,jdbcType=INTEGER},
			in_date = #{in_date,jdbcType=DATE},
			amount_money = #{amount_money,jdbcType=FLOAT},
			brief = #{brief,jdbcType=VARCHAR},
			stocker = #{stocker,jdbcType=INTEGER},
			stock_type_code = #{stock_type_code,jdbcType=INTEGER},
			bill_no = #{bill_no,jdbcType=VARCHAR},
			bill_date = #{bill_date,jdbcType=DATE},
			bill_state = #{bill_state,jdbcType=INTEGER},
			protocol_code = #{protocol_code,jdbcType=VARCHAR},
			proj_id = #{proj_id,jdbcType=INTEGER}
		WHERE
			group_id = #{group_id,jdbcType=INTEGER}
			and hos_id = #{hos_id,jdbcType=INTEGER}
			and copy_code = #{copy_code,jdbcType=VARCHAR}
			and deliver_id = #{deliver_id,jdbcType=INTEGER}
	</update>
	
	
		<!-- 用于 期初未付款供货单明细表加载 -->
	<select id="queryMatNopayDeliverDetailByCode" resultMap="matInDetailCommon" parameterType="java.util.Map" >
		SELECT 
			mndd.group_id, mndd.hos_id, mndd.copy_code, mndd.deliver_id , mndd.deliver_no ,mndd.detail_id, mndd.inv_id,
			mndd.inv_no, b.inv_code, b.inv_name, b.inv_model, b.unit_code, c.unit_name, mndd.amount, mndd.price, 
			mndd.amount_money, mndd.pack_code, e.pack_name, mndd.num_exchange, mndd.pack_price, mndd.num, 
			mndd.batch_no, mndd.bar_code, mndd.sell_price, mndd.sell_money, mndd.sale_price, mndd.sale_money, 
			mndd.inva_date, mndd.disinfect_date, mndd.location_id,	d.location_name, mndd.note, 
			b.is_highvalue, b.is_batch, b.is_bar, b.is_per_bar, b.is_quality, b.is_single_ven, b.is_disinfect ,
			mnd.sup_id , mnd.sup_no , hsd.sup_code ,hsd.sup_name
		FROM mat_nopay_deliver_d mndd
		left join mat_inv_dict b
			on mndd.group_id = b.group_id
			and mndd.hos_id = b.hos_id
			and mndd.copy_code = b.copy_code
			and mndd.inv_id = b.inv_id
			and mndd.inv_no = b.inv_no
		left join hos_unit c
			on b.group_id = c.group_id
			and b.hos_id = c.hos_id
			and b.unit_code = c.unit_code
		left join mat_location_dict d
			on mndd.group_id = d.group_id 
			and mndd.hos_id = d.hos_id
			and mndd.copy_code = d.copy_code
			and mndd.location_id = d.location_id
		left join hos_package e
			on mndd.group_id = e.group_id
			and mndd.hos_id = e.hos_id
			and mndd.pack_code = e.pack_code
		left join MAT_NOPAY_DELIVER mnd
			ON 
				mndd.group_id = mnd.group_id 
				and mndd.hos_id = mnd.hos_id
				and mndd.copy_code = mnd.copy_code
				and mndd.deliver_id = mnd.deliver_id
				and mndd.deliver_no = mnd.deliver_no
		LEFT JOIN hos_sup_dict hsd
			on mnd.group_id = hsd.group_id
			and mnd.hos_id = hsd.hos_id
			and mnd.sup_id = hsd.sup_id
			<!-- and mnd.sup_no = hsd.sup_no -->
			and hsd.is_stop = 0
		
		WHERE mndd.group_id = #{group_id,jdbcType=INTEGER} 
			and mndd.hos_id = #{hos_id,jdbcType=INTEGER} 
			and mndd.copy_code = #{copy_code,jdbcType=VARCHAR} 
			and mndd.deliver_id = #{deliver_id,jdbcType=INTEGER} 
	</select>
	
	<!-- 期初未付款供货单明细表修改（批量） -->
	<update id="updateMatNopayDeliverDetailBatch" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			UPDATE mat_nopay_deliver_d 
			<set>
				<trim suffix="" suffixOverrides=",">
				<if test="item.inv_id != null and item.inv_id != ''">
					inv_id = #{item.inv_id,jdbcType=INTEGER},
				</if>
				<if test="item.inv_no != null and item.inv_no != ''">
					inv_no = #{item.inv_no,jdbcType=INTEGER},
				</if>
				<if test="item.batch_no != null and item.batch_no != ''">
					batch_no = #{item.batch_no,jdbcType=VARCHAR},
				</if>
				<if test="item.batch_sn != null and item.batch_sn != ''">
					batch_sn = #{item.batch_sn,jdbcType=INTEGER},
				</if>
				<if test="item.price != null and item.price != ''">
					price = #{item.price,jdbcType=FLOAT},
				</if>
				<if test="item.amount != null and item.amount != ''">
					amount = #{item.amount,jdbcType=INTEGER},
				</if>
				<if test="item.amount_money != null and item.amount_money != ''">
					amount_money = #{item.amount_money,jdbcType=FLOAT},
				</if>
				<if test="item.sell_price != null and item.sell_price != ''">
					sell_price = #{item.sell_price,jdbcType=FLOAT},
				</if>
				<if test="item.sell_money != null and item.sell_money != ''">
					sell_money = #{item.sell_money,jdbcType=FLOAT},
				</if>
				<if test="item.sale_price != null and item.sale_price != ''">
					sale_price = #{item.sale_price,jdbcType=FLOAT},
				</if>
				<if test="item.sale_money != null and item.sale_money != ''">
					sale_money = #{item.sale_money,jdbcType=FLOAT},
				</if>
				<if test="item.pack_code != null and item.pack_code != ''">
					pack_code = #{item.pack_code,jdbcType=VARCHAR},
				</if>
				<if test="item.num_exchange!= null and item.num_exchange != ''">
					num_exchange = #{item.num_exchange,jdbcType=INTEGER},
				</if>
				<if test="item.pack_price != null and item.pack_price != ''">
					pack_price = #{item.pack_price,jdbcType=FLOAT},
				</if>
				<if test="item.num != null and item.num != ''">
					num = #{item.num,jdbcType=INTEGER},
				</if>
				<if test="item.bar_code != null and item.bar_code != ''">
					bar_code = #{item.bar_code,jdbcType=VARCHAR},
				</if>
				<if test="item.inva_date != null and item.inva_date != ''">
					inva_date = #{item.inva_date,jdbcType=DATE},
				</if>
				<if test="item.disinfect_date != null and item.disinfect_date != ''">
					disinfect_date = #{item.disinfect_date,jdbcType=DATE},
				</if>
				<if test="item.location_id != null and item.location_id != ''">
					location_id = #{item.location_id,jdbcType=INTEGER},
				</if>
				<if test="item.note != null and item.note != ''">
					note = #{item.note,jdbcType=VARCHAR},
				</if>
				</trim>
			</set>
			WHERE group_id = #{item.group_id,jdbcType=INTEGER}
				and hos_id = #{item.hos_id,jdbcType=INTEGER}
				and copy_code = #{item.copy_code,jdbcType=VARCHAR}
				and deliver_id = #{item.deliver_id,jdbcType=INTEGER}
				and detail_id = #{item.detail_id,jdbcType=INTEGER}
		</foreach>
	</update>
	
	<!-- 查询 材料灭菌日期表  MAT_BATCH_DISINFECT 是否存在该记录（存在则不修改 否则就添加 -->
	<select id="queryDisinfectExists" parameterType="java.util.Map" resultType="java.lang.Long" >
		select count(inv_id)
		from MAT_BATCH_DISINFECT
		<where>
			<if test="group_id != null and group_id != '' ">
			    AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != '' ">
			    AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != '' ">
			    AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="inv_id != null and inv_id != '' ">
			    AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null and batch_no != '' ">
			    AND batch_no = #{batch_no,jdbcType=INTEGER}
			</if>
		</where>
	</select>
	
	<!-- 查询 材料期效表 MAT_BATCH_VALIDITY 是否存在该记录（存在则不修改 否则就添加 -->
	<select id="queryValidityExists" parameterType="java.util.Map" resultType="java.lang.Long" >
		select count(inv_id)
		from MAT_BATCH_VALIDITY
		<where>
			<if test="group_id != null and group_id != '' ">
			    AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != '' ">
			    AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != '' ">
			    AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="inv_id != null and inv_id != '' ">
			    AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null and batch_no != '' ">
			    AND batch_no = #{batch_no,jdbcType=INTEGER}
			</if>
		</where>
	</select>
	
	<!-- 批量添加  材料灭菌日期表  MAT_BATCH_DISINFECT -->
	<insert id="addBatchDisinfect" parameterType="java.util.List" >
		insert into MAT_BATCH_DiSINFECT (group_id, hos_id, copy_code,inv_id , batch_no ,disinfect_date )
		select t.* from(
		<foreach collection="list" item="item" index="index" separator=" union all " >
			select 		
				#{item.group_id,jdbcType=INTEGER},
				#{item.hos_id,jdbcType=INTEGER},
				#{item.copy_code,jdbcType=VARCHAR},
				#{item.inv_id,jdbcType=INTEGER},
				#{item.batch_no,jdbcType=VARCHAR},
				#{item.disinfect_date,jdbcType=DATE}
			from dual
		</foreach>
		)t
	</insert>
	
	<!-- 批量添加 材料期效表  MAT_BATCH_VALIDITY -->
	<insert id="addBatchValidity" parameterType="java.util.List" >
		insert into MAT_BATCH_VALIDITY (group_id, hos_id, copy_code,inv_id , batch_no ,inva_date )
		select t.* from(
		<foreach collection="list" item="item" index="index" separator=" union all " >
			select 		
				#{item.group_id,jdbcType=INTEGER},
				#{item.hos_id,jdbcType=INTEGER},
				#{item.copy_code,jdbcType=VARCHAR},
				#{item.inv_id,jdbcType=INTEGER},
				#{item.batch_no,jdbcType=VARCHAR},
				#{item.inva_date,jdbcType=DATE}
			from dual
		</foreach>
		)t
	</insert>
	
	<!-- 查询 期初未付款供货单上一张 单据数据 -->
	<select id="queryMatNopayDeliverBefore" parameterType="java.util.Map" resultMap="matNopayDeliver" >
		SELECT  deliver_id , deliver_no
		FROM MAT_NOPAY_DELIVER
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			AND bus_type_code = #{bus_type_code,jdbcType=VARCHAR}
			AND deliver_id = (
				SELECT MAX(deliver_id) FROM MAT_NOPAY_DELIVER
				WHERE group_id = #{group_id,jdbcType=INTEGER}
					AND hos_id = #{hos_id,jdbcType=INTEGER}
					AND copy_code = #{copy_code,jdbcType=VARCHAR}
					AND bus_type_code = #{bus_type_code,jdbcType=VARCHAR}
					AND deliver_id &lt; #{deliver_id,jdbcType=INTEGER}
			) 
	</select>
	
	<!-- 查询 期初未付款供货单下一张 单据数据 -->
	<select id="queryMatNopayDeliverNext" parameterType="java.util.Map" resultMap="matNopayDeliver" >
		SELECT deliver_id , deliver_no 
		FROM MAT_NOPAY_DELIVER
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			AND bus_type_code = #{bus_type_code,jdbcType=VARCHAR}
			AND deliver_id =( 
				SELECT MIN(deliver_id) 	FROM MAT_NOPAY_DELIVER
				WHERE group_id = #{group_id,jdbcType=INTEGER}
					AND hos_id = #{hos_id,jdbcType=INTEGER}
					AND copy_code = #{copy_code,jdbcType=VARCHAR}
					AND bus_type_code = #{bus_type_code,jdbcType=VARCHAR}
					AND deliver_id &gt; #{deliver_id,jdbcType=INTEGER}
			)
	</select>
	
	<!-- 查询期初未付款送货单 是否已生成发票  -->
	<select id="queryBillOrNot" parameterType="java.util.Map" resultType="java.lang.Integer" >
		select count(mbd.in_id) 
		from mat_bill_detail mbd
		left join mat_bill_main mbm
			ON
				mbd.group_id = mbm.group_id 
				and mbd.hos_id = mbm.hos_id
				and mbd.copy_code = mbm.copy_code
				and mbd.bill_id = mbm.bill_id
				and mbm.is_init = 1
		WHERE mbd.group_id = #{group_id,jdbcType=INTEGER}
			AND mbd.hos_id = #{hos_id,jdbcType=INTEGER}
			AND mbd.copy_code = #{copy_code,jdbcType=INTEGER}
			AND mbm.is_init = 1
			AND mbd.in_id = #{deliver_id,jdbcType=INTEGER}
	</select>		
	<select id="queryMaxDeliverId" resultType="int" parameterType="java.util.Map">
		select max(t.deliver_id)as deliver_id  
		from MAT_NOPAY_DELIVER t 
		where t.group_id = #{group_id} 
		and t.hos_id=#{hos_id}
		and t.copy_code = #{copy_code}
	</select>
	<select id="queryMaxDetailId" resultType="int" parameterType="java.util.Map">
		select mat_nopay_deliver_d_seq.nextval from dual
	</select>
	
	<!-- 导入时使用根据明细更新主表的金额字段 -->
	<update id="updateMatDeliverMoneyByDetail" parameterType="java.util.List">
		<foreach collection="list" index="index" item="item" open="begin" separator=";" close=";end;">
			UPDATE mat_nopay_deliver
	        SET amount_money = (
	          SELECT sum(amount_money) 
	          FROM mat_nopay_deliver_d 
	          WHERE group_id = #{item.group_id,jdbcType=INTEGER}
	            AND hos_id = #{item.hos_id,jdbcType=INTEGER}
	            AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
	            AND deliver_id = #{item.deliver_id,jdbcType=INTEGER}
	        )
	        WHERE group_id = #{item.group_id,jdbcType=INTEGER}
	            AND hos_id = #{item.hos_id,jdbcType=INTEGER}
	            AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
	            AND deliver_id = #{item.deliver_id,jdbcType=INTEGER}
		</foreach>
	</update>

	<!-- 发票主表数据 -->
	<select id="queryMatNopayDeliverForBill" parameterType="java.util.Map" resultType="java.util.Map" >
		SELECT distinct group_id, hos_id, copy_code, bill_no, bill_date, bill_state, sup_id, sup_no, store_id, bus_type_code
		FROM mat_nopay_deliver 
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			<if test="deliver_id != '' and deliver_id != null">
				AND deliver_id = #{deliver_id,jdbcType=INTEGER}
			</if>
			<if test="deliver_ids != '' and deliver_ids != null ">
				and deliver_id in (${deliver_ids})
			</if>
	</select>	
	
	<!-- 获取没有维护发票的明细数据 -->
	<select id="queryMatNopayDeliverDByNotBill" parameterType="java.util.Map" resultType="java.util.Map" >
		SELECT group_id, hos_id, copy_code, deliver_id in_id, detail_id in_detail_id, 0 payable_money, amount_money bill_money
		FROM mat_nopay_deliver_d
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			<if test="deliver_id != null and deliver_id !='' ">
				AND deliver_id = #{deliver_id,jdbcType=INTEGER}
			</if>
			<if test="deliver_ids != null and deliver_ids != ''">
				and deliver_id in (${deliver_ids})
			</if>
			AND detail_id NOT IN (
				SELECT DISTINCT in_detail_id
				FROM mat_bill_detail
				WHERE group_id = #{group_id,jdbcType=INTEGER}
					AND hos_id = #{hos_id,jdbcType=INTEGER}
					AND copy_code = #{copy_code,jdbcType=VARCHAR}
					<if test="deliver_id != null and deliver_id !='' ">
						AND in_id = #{deliver_id,jdbcType=INTEGER}
					</if>
					<if test="deliver_ids != null and deliver_ids != ''">
						and in_id in (${deliver_ids})
					</if>
				)
	</select>
</mapper>

