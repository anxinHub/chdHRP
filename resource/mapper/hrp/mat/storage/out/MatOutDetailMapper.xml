<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.mat.dao.storage.out.MatOutDetailMapper">  

	<resultMap id="matOutDetail" type="com.chd.hrp.mat.entity.MatOutDetail">  
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" /> 
		<result property="out_id" column="out_id" />
		<result property="out_no" column="out_no" />
		<result property="year" column="year" />
		<result property="month" column="month" />  
		<result property="store_id" column="store_id" />
		<result property="out_detail_id" column="out_detail_id" />
		<result property="inv_id" column="inv_id" />
		<result property="inv_no" column="inv_no" />
		<result property="inv_code" column="inv_code" />
		<result property="inv_name" column="inv_name" />
		<result property="batch_sn" column="batch_sn" />
		<result property="batch_no" column="batch_no" />
		<result property="price" column="price" />
		<result property="amount" column="amount" />
		<result property="sale_price" column="sale_price" />
		<result property="sale_money" column="sale_money" />
		<result property="sell_price" column="sell_price" />
		<result property="sell_money" column="sell_money" />
		<result property="allot_price" column="allot_price" />
		<result property="allot_money" column="allot_money" />
		<result property="amount_money" column="amount_money" />
		<result property="num_exchange" column="num_exchange" />
		<result property="pack_price" column="pack_price" />
		<result property="num" column="num" />
		<result property="bar_code" column="bar_code" />
		<result property="inva_date" column="inva_date" />
		<result property="disinfect_date" column="disinfect_date" />
		<result property="location_id" column="location_id" />
		<result property="note" column="note" />
		<result property="pack_code" column="pack_code" />
		<result property="left_amount" column="left_amount" />
		<result property="cur_amount" column="cur_amount" />
		<result property="imma_amount" column="imma_amount" />
		<result property="sum_amount" column="sum_amount" />
		<result property="inv_detail_data" column="inv_detail_data" />
	</resultMap>

	<resultMap type="java.util.Map" id="matOutDetailList">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="out_id" column="out_id" />
		<result property="out_no" column="out_no" />
		<result property="brief" column="brief" />
		<result property="confirm_date" column="confirm_date" />
		<result property="bus_type_code" column="bus_type_code" />
		<result property="bus_type_name" column="bus_type_name" />
		<result property="dept_code" column="dept_code" />
		<result property="dept_name" column="dept_name" />
		<result property="state" column="state" />
		<result property="inv_code" column="inv_code" />
		<result property="inv_name" column="inv_name" />
		<result property="inv_model" column="inv_model" />
		<result property="unit_code" column="unit_code" />
		<result property="unit_name" column="unit_name" />
		<result property="price" column="price" />
		<result property="amount" column="amount" />
		<result property="amount_money" column="amount_money" />
		<result property="mat_type_code" column="mat_type_code" />
		<result property="mat_type_name" column="mat_type_name" />
		<result property="field_desc" column="field_desc" />
		<result property="inv_id" column="inv_id" />
		<result property="inv_no" column="inv_no" />
		<result property="store_id" column="store_id" />
		<result property="store_name" column="store_name" />
		<result property="dept_id" column="dept_id" />
		<result property="bid_code" column="bid_code" />

		<result property="in_no" column="in_no" />
		<result property="in_date" column="in_date" />
		<result property="sup_name" column="sup_name" />
		<result property="batch_no" column="batch_no" />
		<result property="bar_code" column="bar_code" />
		<result property="inva_date" column="inva_date" />
		<result property="fac_name" column="fac_name" />
		<result property="out_date" column="out_date" />
		<result property="confirm_date" column="confirm_date" />
		<!-- 制单人 -->
		<result property="maker" column="maker" />
		<result property="agent_name" column="agent_name" />
		<result property="cert_code" column="cert_code" />
	</resultMap>
	
	<select id="queryMatOutDetailSeq"  resultType="java.lang.Long" useCache="false" flushCache="true">		
		select MAT_OUT_DETAIL_SEQ.nextval from dual
	</select>

	<insert id="add" useGeneratedKeys="true">

		INSERT INTO MAT_OUT_DETAIL (
		<trim suffix="" suffixOverrides=",">
			<if test="group_id != null ">
				group_id
				,
			</if>
			<if test="hos_id != null ">
				hos_id
				,
			</if>
			<if test="copy_code != null and copy_code != ''">
				copy_code
				,
			</if>
			<if test="out_id != null ">
				out_id
				,
			</if>
			<if test="out_no != null ">
				out_no
				,
			</if>
			<if test="out_detail_id != null and out_detail_id != ''">
				out_detail_id
				,
			</if>
			<if test="inv_id != null ">
				inv_id
				,
			</if>
			<if test="inv_no != null ">
				inv_no
				,
			</if>
			<if test="batch_sn != null ">
				batch_sn
				,
			</if>
			<if test="batch_no != null  and batch_no != '' ">
				batch_no
				,
			</if>
			<if test="price != null ">
				price
				,
			</if>
			<if test="amount != null ">
				amount
				,
			</if>
			<if test="sale_price != null ">
				sale_price
				,
			</if>
			<if test="sale_money != null ">
				sale_money
				,
			</if>
			<if test="sell_price != null ">
				sell_price
				,
			</if>
			<if test="sell_money != null ">
				sell_money
				,
			</if>
			<if test="allot_price != null ">
				allot_price
				,
			</if>
			<if test="allot_money != null ">
				allot_money
				,
			</if>
			<if test="amount_money != null ">
				amount_money
				,
			</if>
			<if test="num_exchange != null ">
				num_exchange
				,
			</if>
			<if test="pack_price != null ">
				pack_price
				,
			</if>
			<if test="num != null ">
				num
				,
			</if>
			<if test="bar_code != null  and bar_code != '' ">
				bar_code
				,
			</if>
			<if test="inva_date != null and inva_date != ''">
				inva_date
				,
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				disinfect_date
				,
			</if>
			<if test="location_id != null ">
				location_id
				,
			</if>
			<if test="note != null and note != ''">
				note
				,
			</if>
			<if test="pack_code != null and pack_code != ''">
				pack_code
				,
			</if>
		</trim>
		) VALUES (
		<trim suffix="" suffixOverrides=",">
			<if test="group_id != null ">
				#{group_id,jdbcType=INTEGER}
				,
			</if>
			<if test="hos_id != null ">
				#{hos_id,jdbcType=INTEGER}
				,
			</if>
			<if test="copy_code != null and copy_code != ''">
				#{copy_code,jdbcType=VARCHAR}
				,
			</if>
			<if test="out_id != null ">
				#{out_id,jdbcType=INTEGER}
				,
			</if>
			<if test="out_no != null ">
				#{out_no,jdbcType=VARCHAR}
				,
			</if>
			<if test="out_detail_id != null and out_detail_id != ''">
				#{out_detail_id,jdbcType=INTEGER}
				,
			</if>
			<if test="inv_id != null ">
				#{inv_id,jdbcType=INTEGER}
				,
			</if>
			<if test="inv_no != null ">
				#{inv_no,jdbcType=INTEGER}
				,
			</if>
			<if test="batch_sn != null ">
				#{batch_sn,jdbcType=INTEGER}
				,
			</if>
			<if test="batch_no != null  and batch_no != '' ">
				#{batch_no,jdbcType=VARCHAR}
				,
			</if>
			<if test="price != null ">
				#{price,jdbcType=INTEGER}
				,
			</if>
			<if test="amount != null ">
				#{amount,jdbcType=INTEGER}
				,
			</if>
			<if test="sale_price != null ">
				#{sale_price,jdbcType=INTEGER}
				,
			</if>
			<if test="sale_money != null ">
				#{sale_money,jdbcType=INTEGER}
				,
			</if>
			<if test="sell_price != null ">
				#{sell_price,jdbcType=INTEGER}
				,
			</if>
			<if test="sell_money != null ">
				#{sell_money,jdbcType=INTEGER}
				,
			</if>
			<if test="allot_price != null ">
				#{allot_price,jdbcType=INTEGER}
				,
			</if>
			<if test="allot_money != null ">
				#{allot_money,jdbcType=INTEGER}
				,
			</if>
			<if test="amount_money != null ">
				#{amount_money,jdbcType=INTEGER}
				,
			</if>
			<if test="num_exchange != null ">
				#{num_exchange,jdbcType=INTEGER}
				,
			</if>
			<if test="pack_price != null ">
				#{pack_price,jdbcType=INTEGER}
				,
			</if>
			<if test="num != null ">
				#{num,jdbcType=INTEGER}
				,
			</if>
			<if test="bar_code != null  and bar_code != '' ">
				#{bar_code,jdbcType=VARCHAR}
				,
			</if>
			<if test="inva_date != null and inva_date != ''">
				#{inva_date,jdbcType=DATE}
				,
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				#{disinfect_date,jdbcType=DATE}
				,
			</if>
			<if test="location_id != null ">
				#{location_id,jdbcType=INTEGER}
				,
			</if>
			<if test="note != null and note != ''">
				#{note,jdbcType=VARCHAR}
				,
			</if>
			<if test="pack_code != null and pack_code != ''">
				#{pack_code,jdbcType=VARCHAR}

			</if>
		</trim>
		)

	</insert>
	
	<insert id="addBatch" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
		INSERT INTO MAT_OUT_DETAIL (
			group_id ,
			hos_id ,
			copy_code,
			out_id	,
			out_no	,
			out_detail_id	,
			inv_id	,
			inv_no	,
			batch_sn	,
			batch_no	,
			price	,
			amount	,
			amount_money
			<if test="item.sale_price != null ">, sale_price</if>
			<if test="item.sale_money != null ">, sale_money</if>
			<if test="item.sell_price != null ">, sell_price</if>
			<if test="item.sell_money != null ">, sell_money</if>
			<if test="item.allot_price!= null ">, allot_price</if>
			<if test="item.allot_money != null ">, allot_money</if>
			<if test="item.num_exchange != null ">, num_exchange</if>
			<if test="item.pack_price != null ">, pack_price</if>
			<if test="item.num != null ">, num</if>
			<if test="item.bar_code != null and item.bar_code != ''">, bar_code</if>
			<if test="item.inva_date != null   ">, inva_date</if>
			<if test="item.disinfect_date != null  ">, disinfect_date</if>
			<if test="item.location_id != null ">, location_id</if>
			<if test="item.note != null ">, note</if>
			<if test="item.pack_code != null ">, pack_code</if>
		) values(
			#{item.group_id,jdbcType=INTEGER}		,
			#{item.hos_id,jdbcType=INTEGER}		,
			#{item.copy_code,jdbcType=VARCHAR}		,
			#{item.out_id,jdbcType=INTEGER}		,
			#{item.out_no,jdbcType=VARCHAR}		,
			#{item.out_detail_id,jdbcType=INTEGER}		,
			#{item.inv_id,jdbcType=INTEGER}		,
			#{item.inv_no,jdbcType=INTEGER}		,
			#{item.batch_sn,jdbcType=INTEGER}	,
			#{item.batch_no,jdbcType=VARCHAR}	,
			#{item.price,jdbcType=INTEGER}		,
			#{item.amount,jdbcType=INTEGER}		,
			#{item.amount_money,jdbcType=INTEGER}
			
			<if test="item.sale_price != null ">, #{item.sale_price,jdbcType=INTEGER}</if>
			<if test="item.sale_money != null ">, #{item.sale_money,jdbcType=INTEGER}</if>
			<if test="item.sell_price != null ">, #{item.sell_price,jdbcType=INTEGER}</if>
			<if test="item.sell_money != null ">, #{item.sell_money,jdbcType=INTEGER}</if>
			<if test="item.allot_price!= null ">, #{item.allot_price,jdbcType=INTEGER}</if>
			<if test="item.allot_money != null ">, #{item.allot_money,jdbcType=INTEGER}</if>
			<if test="item.num_exchange != null ">, #{item.num_exchange,jdbcType=INTEGER}</if>
			<if test="item.pack_price != null ">, #{item.pack_price,jdbcType=INTEGER}</if>
			<if test="item.num != null ">, #{item.num,jdbcType=INTEGER}</if>
			<if test="item.bar_code != null and item.bar_code != ''">, #{item.bar_code,jdbcType=VARCHAR}</if>
			<if test="item.inva_date != null ">, #{item.inva_date,jdbcType=DATE}</if>
			<if test="item.disinfect_date != null ">, #{item.disinfect_date,jdbcType=DATE}</if>
			<if test="item.location_id != null ">, #{item.location_id,jdbcType=INTEGER}</if>
			<if test="item.note != null ">, #{item.note,jdbcType=VARCHAR}</if>
			<if test="item.pack_code != null ">, #{item.pack_code,jdbcType=VARCHAR}</if>
		)
		</foreach>
	</insert>

	<update id="update" parameterType="java.util.Map">

		UPDATE mat_out_detail
		<trim prefix="SET" suffixOverrides=",">
			<if test="inv_id != null ">
				inv_id = #{inv_id,jdbcType=INTEGER}
				,
			</if>
			<if test="inv_no != null ">
				inv_no = #{inv_no,jdbcType=INTEGER}
				,
			</if>
			<if test="batch_sn != null ">
				batch_sn = #{batch_sn,jdbcType=INTEGER}
				,
			</if>
			<if test="batch_no != null  and batch_no != '' ">
				batch_no = #{batch_no,jdbcType=VARCHAR}
				,
			</if>
			<if test="price != null ">
				price = #{price,jdbcType=INTEGER}
				,
			</if>
			<if test="amount != null ">
				amount = #{amount,jdbcType=INTEGER}
				,
			</if>
			<if test="sale_price != null ">
				sale_price = #{sale_price,jdbcType=INTEGER}
				,
			</if>
			<if test="sale_money != null ">
				sale_money = #{sale_money,jdbcType=INTEGER}
				,
			</if>
			<if test="sell_price != null ">
				sell_price = #{sell_price,jdbcType=INTEGER}
				,
			</if>
			<if test="sell_money != null ">
				sell_money = #{sell_money,jdbcType=INTEGER}
				,
			</if>
			<if test="allot_price != null ">
				allot_price = #{allot_price,jdbcType=INTEGER}
				,
			</if>
			<if test="allot_money != null ">
				allot_money = #{allot_money,jdbcType=INTEGER}
				,
			</if>
			<if test="amount_money != null ">
				amount_money = #{amount_money,jdbcType=INTEGER}
				,
			</if>
			<if test="num_exchange != null ">
				num_exchange = #{num_exchange,jdbcType=INTEGER}
				,
			</if>
			<if test="pack_price != null ">
				pack_price = #{pack_price,jdbcType=INTEGER}
				,
			</if>
			<if test="num != null ">
				num = #{num,jdbcType=INTEGER}
				,
			</if>
			<if test="bar_code != null  and bar_code != '' ">
				bar_code = #{bar_code,jdbcType=VARCHAR}
				,
			</if>
			<if test="inva_date != null">
				inva_date = #{inva_date,jdbcType=DATE}
				,
			</if>
			<if test="disinfect_date != null">
				disinfect_date = #{disinfect_date,jdbcType=DATE}
				,
			</if>
			<if test="location_id != null ">
				location_id = #{location_id,jdbcType=INTEGER}
				,
			</if>
			<if test="note != null">
				note = #{note,jdbcType=VARCHAR}
				,
			</if>
			<if test="pack_code != null">
				pack_code = #{pack_code,jdbcType=VARCHAR}
				,
			</if>
		</trim>
		<where>
			<if test="group_id != null ">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null ">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="out_id != null ">
				AND out_id = #{out_id,jdbcType=INTEGER}
			</if>
			<if test="out_detail_id != null and out_detail_id != ''">
				AND out_detail_id = #{out_detail_id,jdbcType=INTEGER}
			</if>
			<if test="inv_id != null ">
				AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_no != null ">
				AND inv_no = #{inv_no,jdbcType=INTEGER}
			</if>
			<if test="batch_sn != null ">
				AND batch_sn = #{batch_sn,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null  and batch_no != '' ">
				AND batch_no = #{batch_no,jdbcType=VARCHAR}
			</if>
			<if test="price != null ">
				AND price = #{price,jdbcType=INTEGER}
			</if>
			<if test="amount != null ">
				AND amount = #{amount,jdbcType=INTEGER}
			</if>
			<if test="sale_price != null ">
				AND sale_price = #{sale_price,jdbcType=INTEGER}
			</if>
			<if test="sale_money != null ">
				AND sale_money = #{sale_money,jdbcType=INTEGER}
			</if>
			<if test="sell_price != null ">
				AND sell_price = #{sell_price,jdbcType=INTEGER}
			</if>
			<if test="sell_money != null ">
				AND sell_money = #{sell_money,jdbcType=INTEGER}
			</if>
			<if test="allot_price != null ">
				AND allot_price = #{allot_price,jdbcType=INTEGER}
			</if>
			<if test="allot_money != null ">
				AND allot_money = #{allot_money,jdbcType=INTEGER}
			</if>
			<if test="amount_money != null ">
				AND amount_money = #{amount_money,jdbcType=INTEGER}
			</if>
			<if test="num_exchange != null ">
				AND num_exchange = #{num_exchange,jdbcType=INTEGER}
			</if>
			<if test="pack_price != null ">
				AND pack_price = #{pack_price,jdbcType=INTEGER}
			</if>
			<if test="num != null ">
				AND num = #{num,jdbcType=INTEGER}
			</if>
			<if test="bar_code != null  and bar_code != '' ">
				AND bar_code = #{bar_code,jdbcType=VARCHAR}
			</if>
			<if test="inva_date != null and inva_date != ''">
				AND inva_date = #{inva_date,jdbcType=DATE}
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				AND disinfect_date = #{disinfect_date,jdbcType=DATE}
			</if>
			<if test="location_id != null ">
				AND location_id = #{location_id,jdbcType=INTEGER}
			</if>
			<if test="note != null and note != ''">
				AND note = #{note,jdbcType=VARCHAR}
			</if>
			<if test="pack_code != null and pack_code != ''">
				AND pack_code = #{pack_code,jdbcType=VARCHAR}
			</if>
		</where>
	</update>
	<update id="updateBatch" parameterType="java.util.List">

		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			UPDATE mat_out_detail
			<trim prefix="SET" suffixOverrides=",">
				<if test="item.inv_id != null ">
					inv_id = #{item.inv_id,jdbcType=INTEGER}
					,
				</if>
				<if test="item.inv_no != null ">
					inv_no = #{item.inv_no,jdbcType=INTEGER}
					,
				</if>
				<if test="item.batch_sn != null ">
					batch_sn = #{item.batch_sn,jdbcType=INTEGER}
					,
				</if>
				<if test="item.batch_no != null and item.batch_no != ''">
					batch_no = #{item.batch_no,jdbcType=VARCHAR}
					,
				</if>
				<if test="item.price != null ">
					price = #{item.price,jdbcType=INTEGER}
					,
				</if>
				<if test="item.amount != null ">
					amount = #{item.amount,jdbcType=INTEGER}
					,
				</if>
				<if test="item.sale_price != null ">
					sale_price = #{item.sale_price,jdbcType=INTEGER}
					,
				</if>
				<if test="item.sale_money != null ">
					sale_money = #{item.sale_money,jdbcType=INTEGER}
					,
				</if>
				<if test="item.sell_price != null ">
					sell_price = #{item.sell_price,jdbcType=INTEGER}
					,
				</if>
				<if test="item.sell_money != null ">
					sell_money = #{item.sell_money,jdbcType=INTEGER}
					,
				</if>
				<if test="item.allot_price != null ">
					allot_price = #{item.allot_price,jdbcType=INTEGER}
					,
				</if>
				<if test="item.allot_money != null ">
					allot_money = #{item.allot_money,jdbcType=INTEGER}
					,
				</if>
				<if test="item.amount_money != null ">
					amount_money = #{item.amount_money,jdbcType=INTEGER}
					,
				</if>
				<if test="item.num_exchange != null ">
					num_exchange = #{item.num_exchange,jdbcType=INTEGER}
					,
				</if>
				<if test="item.pack_price != null ">
					pack_price = #{item.pack_price,jdbcType=INTEGER}
					,
				</if>
				<if test="item.num != null ">
					num = #{item.num,jdbcType=INTEGER}
					,
				</if>
				<if test="item.bar_code != null and item.bar_code != ''">
					bar_code = #{item.bar_code,jdbcType=VARCHAR}
					,
				</if>
				<if test="item.inva_date != null">
					inva_date = #{item.inva_date,jdbcType=DATE}
					,
				</if>
				<if test="item.disinfect_date != null">
					disinfect_date = #{item.disinfect_date,jdbcType=DATE}
					,
				</if>
				<if test="item.location_id != null ">
					location_id = #{item.location_id,jdbcType=INTEGER}
					,
				</if>
				<if test="item.note != null">
					note = #{item.note,jdbcType=VARCHAR}
					,
				</if>
				<if test="item.pack_code != null">
					pack_code = #{item.pack_code,jdbcType=VARCHAR}
					,
				</if>
			</trim>
			<where>
				<if test="item.group_id != null ">
					AND group_id = #{item.group_id,jdbcType=INTEGER}
				</if>
				<if test="item.hos_id != null ">
					AND hos_id = #{item.hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
				</if>
				<if test="item.out_id != null ">
					AND out_id = #{item.out_id,jdbcType=INTEGER}
				</if>
				<if test="item.out_detail_id != null and item.out_detail_id != ''">
					AND out_detail_id =
					#{item.out_detail_id,jdbcType=INTEGER}
				</if>
				<if test="item.inv_id != null ">
					AND inv_id = #{item.inv_id,jdbcType=INTEGER}
				</if>
				<if test="item.inv_no != null ">
					AND inv_no = #{item.inv_no,jdbcType=INTEGER}
				</if>
				<if test="item.batch_sn != null ">
					AND batch_sn = #{item.batch_sn,jdbcType=INTEGER}
				</if>
				<if test="item.batch_no != null and item.batch_no != ''">
					AND batch_no = #{item.batch_no,jdbcType=VARCHAR}
				</if>
				<if test="item.price != null ">
					AND price = #{item.price,jdbcType=INTEGER}
				</if>
				<if test="item.amount != null ">
					AND amount = #{item.amount,jdbcType=INTEGER}
				</if>
				<if test="item.sale_price != null ">
					AND sale_price = #{item.sale_price,jdbcType=INTEGER}
				</if>
				<if test="item.sale_money != null ">
					AND sale_money = #{item.sale_money,jdbcType=INTEGER}
				</if>
				<if test="item.sell_price != null ">
					AND sell_price = #{item.sell_price,jdbcType=INTEGER}
				</if>
				<if test="item.sell_money != null ">
					AND sell_money = #{item.sell_money,jdbcType=INTEGER}
				</if>
				<if test="item.allot_price != null ">
					AND allot_price = #{item.allot_price,jdbcType=INTEGER}
				</if>
				<if test="item.allot_money != null ">
					AND allot_money = #{item.allot_money,jdbcType=INTEGER}
				</if>
				<if test="item.amount_money != null ">
					AND amount_money = #{item.amount_money,jdbcType=INTEGER}
				</if>
				<if test="item.num_exchange != null ">
					AND num_exchange = #{item.num_exchange,jdbcType=INTEGER}
				</if>
				<if test="item.pack_price != null ">
					AND pack_price =
					#{item.item.pack_price,jdbcType=INTEGER}
				</if>
				<if test="item.num != null ">
					AND num = #{item.num,jdbcType=INTEGER}
				</if>
				<if test="item.bar_code != null and item.bar_code != ''">
					AND bar_code = #{item.bar_code,jdbcType=VARCHAR}
				</if>
				<if test="item.inva_date != null and item.inva_date != ''">
					AND inva_date = #{item.inva_date,jdbcType=DATE}
				</if>
				<if test="item.disinfect_date != null and item.disinfect_date != ''">
					AND disinfect_date =
					#{item.disinfect_date,jdbcType=DATE}
				</if>
				<if test="item.location_id != null ">
					AND location_id = #{item.location_id,jdbcType=INTEGER}
				</if>
				<if test="item.note != null and item.note != ''">
					AND note = #{item.note,jdbcType=VARCHAR}
				</if>
				<if test="item.pack_code != null and item.pack_code != ''">
					AND pack_code = #{item.pack_code,jdbcType=VARCHAR}
				</if>
			</where>
		</foreach>
	</update>

	<delete id="delete" parameterType="java.util.Map">

		DELETE FROM mat_out_detail
		<where>
			<if test="group_id != null ">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null ">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="out_id != null ">
				AND out_id = #{out_id,jdbcType=INTEGER}
			</if>
		</where>
	</delete>
	<delete id="deleteBatch" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			DELETE FROM mat_out_detail
			<where>
				<if test="item.group_id != null ">
					AND group_id = #{item.group_id,jdbcType=INTEGER}
				</if>
				<if test="item.hos_id != null ">
					AND hos_id = #{item.hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
				</if>
				<if test="item.out_id != null ">
					AND out_id = #{item.out_id,jdbcType=INTEGER}
				</if>
				<if test="item.out_detail_id != null and item.out_detail_id != ''">
					AND out_detail_id =
					#{item.out_detail_id,jdbcType=INTEGER}
				</if>
				<if test="item.inv_id != null ">
					AND inv_id = #{item.inv_id,jdbcType=INTEGER}
				</if>
				<if test="item.inv_no != null ">
					AND inv_no = #{item.inv_no,jdbcType=INTEGER}
				</if>
				<if test="item.batch_sn != null ">
					AND batch_sn = #{item.batch_sn,jdbcType=INTEGER}
				</if>
				<if test="item.batch_no != null and item.batch_no != ''">
					AND batch_no = #{item.batch_no,jdbcType=VARCHAR}
				</if>
				<if test="item.price != null ">
					AND price = #{item.price,jdbcType=INTEGER}
				</if>
				<if test="item.amount != null ">
					AND amount = #{item.amount,jdbcType=INTEGER}
				</if>
				<if test="item.sale_price != null ">
					AND sale_price = #{item.sale_price,jdbcType=INTEGER}
				</if>
				<if test="item.sale_money != null ">
					AND sale_money = #{item.sale_money,jdbcType=INTEGER}
				</if>
				<if test="item.sell_price != null ">
					AND sell_price = #{item.sell_price,jdbcType=INTEGER}
				</if>
				<if test="item.sell_money != null ">
					AND sell_money = #{item.sell_money,jdbcType=INTEGER}
				</if>
				<if test="item.allot_price != null ">
					AND allot_price = #{item.allot_price,jdbcType=INTEGER}
				</if>
				<if test="item.allot_money != null ">
					AND allot_money = #{item.allot_money,jdbcType=INTEGER}
				</if>
				<if test="item.amount_money != null ">
					AND amount_money = #{item.amount_money,jdbcType=INTEGER}
				</if>
				<if test="item.num_exchange != null ">
					AND num_exchange = #{item.num_exchange,jdbcType=INTEGER}
				</if>
				<if test="item.pack_price != null ">
					AND pack_price = #{item.pack_price,jdbcType=INTEGER}
				</if>
				<if test="item.num != null ">
					AND num = #{item.num,jdbcType=INTEGER}
				</if>
				<if test="item.bar_code != null and item.bar_code != ''">
					AND bar_code = #{item.bar_code,jdbcType=VARCHAR}
				</if>
				<if test="item.inva_date != null and item.inva_date != ''">
					AND inva_date = #{item.inva_date,jdbcType=DATE}
				</if>
				<if test="item.disinfect_date != null and item.disinfect_date != ''">
					AND disinfect_date =
					#{item.disinfect_date,jdbcType=DATE}
				</if>
				<if test="item.location_id != null ">
					AND location_id = #{item.location_id,jdbcType=INTEGER}
				</if>
				<if test="item.note != null and item.note != ''">
					AND note = #{item.note,jdbcType=VARCHAR}
				</if>
				<if test="item.pack_code != null and item.pack_code != ''">
					AND pack_code = #{item.pack_code,jdbcType=VARCHAR}
				</if>
			</where>
		</foreach>
	</delete>
	
	<select id="queryAmountByInvId" parameterType="java.util.Map" resultMap="matOutDetail">

		select
			matod.inv_id as inv_id,
			matod.batch_sn as batch_sn,
			matod.batch_no as batch_no,
			matod.bar_code as bar_code,
			sum(matod.amount) as imme_amount,
			sum(mfb.left_amount) as left_amount
		from mat_out_detail matod
		left join mat_fifo_balance mfb on
			matod.group_id = mfb.group_id and
			matod.copy_code = mfb.copy_code and
			matod.hos_id = mfb.hos_id
			and matod.inv_id = mfb.inv_id and
			matod.batch_sn = mfb.batch_sn and
			matod.batch_no = mfb.batch_no and
			matod.bar_code = mfb.bar_code
		<where>
			<if test="group_id != null ">
				AND matod.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null ">
				AND matod.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND matod.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="inv_id != null ">
				AND matod.inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_no != null ">
				AND matod.inv_no = #{inv_no,jdbcType=INTEGER}
			</if>
			<if test="batch_sn != null ">
				AND matod.batch_sn = #{batch_sn,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null  and batch_no != '' ">
				AND matod.batch_no = #{batch_no,jdbcType=VARCHAR}
			</if>
		</where>
		group by matod.inv_id,matod.batch_sn,matod.batch_no,matod.bar_code
		order by matod.inv_id asc
	</select>
	<select id="query" parameterType="java.util.Map" resultMap="matOutDetail">

		SELECT
			a.group_id,
			a.hos_id,
			a.copy_code,
			a.out_id,
			a.out_detail_id,
			a.inv_id,
			a.inv_no,
			b.inv_code,
			b.inv_name,
			a.batch_sn,
			a.batch_no,
			a.price,
			a.amount,
			a.sale_price,
			a.sale_money,
			a.sell_price,
			a.sell_money,
			a.allot_price,
			a.allot_money,
			a.amount_money,
			a.num_exchange,
			a.pack_price,
			a.num,
			a.bar_code,
			a.inva_date,
			a.disinfect_date,
			a.location_id,
			a.note,
			a.pack_code
		FROM MAT_OUT_DETAIL a
		LEFT JOIN mat_inv_dict b on a.group_id = b.group_id and a.hos_id = b.hos_id
			and a.copy_code = b.copy_code and a.inv_id = b.inv_id
			and b.is_stop = 0
		<where>
			<if test="group_id != null ">
				AND a.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null ">
				AND a.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND a.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="out_id != null ">
				AND a.out_id = #{out_id,jdbcType=INTEGER}
			</if>
			<if test="out_detail_id != null and out_detail_id != ''">
				AND a.out_detail_id = #{out_detail_id,jdbcType=INTEGER}
			</if>
			<if test="inv_id != null ">
				AND a.inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_no != null ">
				AND a.inv_no = #{inv_no,jdbcType=INTEGER}
			</if>
			<if test="batch_sn != null ">
				AND a.batch_sn = #{batch_sn,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null  and batch_no != '' ">
				AND a.batch_no = #{batch_no,jdbcType=VARCHAR}
			</if>
			<if test="price != null ">
				AND a.price = #{price,jdbcType=INTEGER}
			</if>
			<if test="amount != null ">
				AND a.amount = #{amount,jdbcType=INTEGER}
			</if>
			<if test="sale_price != null ">
				AND a.sale_price = #{sale_price,jdbcType=INTEGER}
			</if>
			<if test="sale_money != null ">
				AND a.sale_money = #{sale_money,jdbcType=INTEGER}
			</if>
			<if test="sell_price != null ">
				AND a.sell_price = #{sell_price,jdbcType=INTEGER}
			</if>
			<if test="sell_money != null ">
				AND a.sell_money = #{sell_money,jdbcType=INTEGER}
			</if>
			<if test="allot_price != null ">
				AND a.allot_price = #{allot_price,jdbcType=INTEGER}
			</if>
			<if test="allot_money != null ">
				AND a.allot_money = #{allot_money,jdbcType=INTEGER}
			</if>
			<if test="amount_money != null ">
				AND a.amount_money = #{amount_money,jdbcType=INTEGER}
			</if>
			<if test="num_exchange != null ">
				AND a.num_exchange = #{num_exchange,jdbcType=INTEGER}
			</if>
			<if test="pack_price != null ">
				AND a.pack_price = #{pack_price,jdbcType=INTEGER}
			</if>
			<if test="num != null ">
				AND a.num = #{num,jdbcType=INTEGER}
			</if>
			<if test="bar_code != null  and bar_code != '' ">
				AND a.bar_code = #{bar_code,jdbcType=VARCHAR}
			</if>
			<if test="inva_date != null and inva_date != ''">
				AND a.inva_date = #{inva_date,jdbcType=DATE}
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				AND a.disinfect_date = #{disinfect_date,jdbcType=DATE}
			</if>
			<if test="location_id != null ">
				AND a.location_id = #{location_id,jdbcType=INTEGER}
			</if>
			<if test="note != null and note != ''">
				AND a.note = #{note,jdbcType=VARCHAR}
			</if>
			<if test="pack_code != null and pack_code != ''">
				AND a.pack_code = #{pack_code,jdbcType=VARCHAR}
			</if>
		</where>
		order by a.out_detail_id asc
	</select>
	
	<select id="queryByCode" resultMap="matOutDetail" parameterType="java.util.Map">

		SELECT
			group_id,
			hos_id,
			copy_code,
			out_id,
			out_detail_id,
			inv_id,
			inv_no,
			batch_sn,
			batch_no,
			price,
			amount,
			sale_price,
			sale_money,
			sell_price,
			sell_money,
			allot_price,
			allot_money,
			amount_money,
			num_exchange,
			pack_price,
			num,
			bar_code,
			inva_date,
			disinfect_date,
			location_id,
			note,
			pack_code
		FROM mat_out_detail
		WHERE group_id = #{group_id,jdbcType=INTEGER} 
			and hos_id = #{hos_id,jdbcType=INTEGER}
			and copy_code = #{copy_code,jdbcType=VARCHAR} 
			and out_id = #{out_id,jdbcType=INTEGER} 
			and out_detail_id = #{out_detail_id,jdbcType=INTEGER}

	</select>
	
	<select id="queryByUniqueness" resultMap="matOutDetail" parameterType="java.util.Map">

		SELECT
			group_id,
			hos_id,
			copy_code,
			out_id,
			out_detail_id,
			inv_id,
			inv_no,
			batch_sn,
			batch_no,
			price,
			amount,
			sale_price,
			sale_money,
			sell_price,
			sell_money,
			allot_price,
			allot_money,
			amount_money,
			num_exchange,
			pack_price,
			num,
			bar_code,
			inva_date,
			disinfect_date,
			location_id,
			note,
			pack_code
		FROM MAT_OUT_DETAIL
		<where>
			<if test="group_id != null ">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null ">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="out_id != null ">
				AND out_id = #{out_id,jdbcType=INTEGER}
			</if>
			<if test="out_detail_id != null and out_detail_id != ''">
				AND out_detail_id = #{out_detail_id,jdbcType=INTEGER}
			</if>
			<if test="inv_id != null ">
				AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_no != null ">
				AND inv_no = #{inv_no,jdbcType=INTEGER}
			</if>
			<if test="batch_sn != null ">
				AND batch_sn = #{batch_sn,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null  and batch_no != '' ">
				AND batch_no = #{batch_no,jdbcType=VARCHAR}
			</if>
			<if test="price != null ">
				AND price = #{price,jdbcType=INTEGER}
			</if>
			<if test="amount != null ">
				AND amount = #{amount,jdbcType=INTEGER}
			</if>
			<if test="sale_price != null ">
				AND sale_price = #{sale_price,jdbcType=INTEGER}
			</if>
			<if test="sale_money != null ">
				AND sale_money = #{sale_money,jdbcType=INTEGER}
			</if>
			<if test="sell_price != null ">
				AND sell_price = #{sell_price,jdbcType=INTEGER}
			</if>
			<if test="sell_money != null ">
				AND sell_money = #{sell_money,jdbcType=INTEGER}
			</if>
			<if test="allot_price != null ">
				AND allot_price = #{allot_price,jdbcType=INTEGER}
			</if>
			<if test="allot_money != null ">
				AND allot_money = #{allot_money,jdbcType=INTEGER}
			</if>
			<if test="amount_money != null ">
				AND amount_money = #{amount_money,jdbcType=INTEGER}
			</if>
			<if test="num_exchange != null ">
				AND num_exchange = #{num_exchange,jdbcType=INTEGER}
			</if>
			<if test="pack_price != null ">
				AND pack_price = #{pack_price,jdbcType=INTEGER}
			</if>
			<if test="num != null ">
				AND num = #{num,jdbcType=INTEGER}
			</if>
			<if test="bar_code != null  and bar_code != '' ">
				AND bar_code = #{bar_code,jdbcType=VARCHAR}
			</if>
			<if test="inva_date != null and inva_date != ''">
				AND inva_date = #{inva_date,jdbcType=DATE}
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				AND disinfect_date = #{disinfect_date,jdbcType=DATE}
			</if>
			<if test="location_id != null ">
				AND location_id = #{location_id,jdbcType=INTEGER}
			</if>
			<if test="note != null and note != ''">
				AND note = #{note,jdbcType=VARCHAR}
			</if>
			<if test="pack_code != null and pack_code != ''">
				AND pack_code = #{pack_code,jdbcType=VARCHAR}
			</if>
		</where>
		order by group_id asc
	</select>
	
	<select id="queryExists" resultMap="matOutDetail" parameterType="java.util.Map">

		SELECT
			group_id,
			hos_id,
			copy_code,
			out_id,
			out_detail_id,
			inv_id,
			inv_no,
			batch_sn,
			batch_no,
			price,
			amount,
			sale_price,
			sale_money,
			sell_price,
			sell_money,
			allot_price,
			allot_money,
			amount_money,
			num_exchange,
			pack_price,
			num,
			bar_code,
			inva_date,
			disinfect_date,
			location_id,
			note,
			pack_code
		FROM MAT_OUT_DETAIL
		<where>
			<if test="group_id != null ">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null ">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="out_id != null ">
				AND out_id = #{out_id,jdbcType=INTEGER}
			</if>
			<if test="out_detail_id != null and out_detail_id != ''">
				AND out_detail_id = #{out_detail_id,jdbcType=INTEGER}
			</if>
			<if test="inv_id != null ">
				AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_no != null ">
				AND inv_no = #{inv_no,jdbcType=INTEGER}
			</if>
			<if test="batch_sn != null ">
				AND batch_sn = #{batch_sn,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null  and batch_no != '' ">
				AND batch_no = #{batch_no,jdbcType=VARCHAR}
			</if>
			<if test="price != null ">
				AND price = #{price,jdbcType=INTEGER}
			</if>
			<if test="amount != null ">
				AND amount = #{amount,jdbcType=INTEGER}
			</if>
			<if test="sale_price != null ">
				AND sale_price = #{sale_price,jdbcType=INTEGER}
			</if>
			<if test="sale_money != null ">
				AND sale_money = #{sale_money,jdbcType=INTEGER}
			</if>
			<if test="sell_price != null ">
				AND sell_price = #{sell_price,jdbcType=INTEGER}
			</if>
			<if test="sell_money != null ">
				AND sell_money = #{sell_money,jdbcType=INTEGER}
			</if>
			<if test="allot_price != null ">
				AND allot_price = #{allot_price,jdbcType=INTEGER}
			</if>
			<if test="allot_money != null ">
				AND allot_money = #{allot_money,jdbcType=INTEGER}
			</if>
			<if test="amount_money != null ">
				AND amount_money = #{amount_money,jdbcType=INTEGER}
			</if>
			<if test="num_exchange != null ">
				AND num_exchange = #{num_exchange,jdbcType=INTEGER}
			</if>
			<if test="pack_price != null ">
				AND pack_price = #{pack_price,jdbcType=INTEGER}
			</if>
			<if test="num != null ">
				AND num = #{num,jdbcType=INTEGER}
			</if>
			<if test="bar_code != null  and bar_code != '' ">
				AND bar_code = #{bar_code,jdbcType=VARCHAR}
			</if>
			<if test="inva_date != null and inva_date != ''">
				AND inva_date = #{inva_date,jdbcType=DATE}
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				AND disinfect_date = #{disinfect_date,jdbcType=DATE}
			</if>
			<if test="location_id != null ">
				AND location_id = #{location_id,jdbcType=INTEGER}
			</if>
			<if test="note != null and note != ''">
				AND note = #{note,jdbcType=VARCHAR}
			</if>
			<if test="pack_code != null and pack_code != ''">
				AND pack_code = #{pack_code,jdbcType=VARCHAR}
			</if>
			<if test="sql != null and sql != ''">
				AND ${sql}
			</if>
		</where>
		order by group_id asc
	</select>
	<!-- liusiqi 180413 此方法暂时只被常备材料出库添加-历史导入界面引用 ,修复了发生退库造成的材料库存,即时库存翻倍问题-->
	<select id="queryMatOutDetailByHistory" parameterType="java.util.Map" resultType="java.util.TreeMap">
		with inv_temp as (
			select outmsg.group_id,outmsg.hos_id,outmsg.copy_code,outmsg.inv_id,
		           mid.inv_no,mid.inv_code,mid.inv_name,mid.inv_model,hu.unit_name,
		           mtd.mat_type_name,hfd.fac_name,outmsg.batch_no,outmsg.bar_code,
		           sum(outmsg.amount) as amount,
		           sum(mfb.left_amount) as left_amount,
		           sum(mfb.left_money) as left_money,
		           outmsg.price,outmsg.sale_price,outmsg.sell_price,outmsg.location_id,
		           mld.location_code,mld.location_name,outmsg.inva_date,outmsg.disinfect_date
		      from (select mom.group_id,mom.hos_id,mom.copy_code,modet.inv_id,
		                        modet.batch_no,modet.bar_code,modet.price,modet.sale_price,
		                        modet.sell_price,modet.location_id,modet.inva_date,modet.batch_sn,
		                        modet.disinfect_date,sum(modet.amount) as amount,mom.store_id,
		                        mom.dept_id
		                   from mat_out_main mom
		                   left join mat_out_detail modet
		                     on mom.group_id = modet.group_id
		                    and mom.hos_id = modet.hos_id
		                    and mom.copy_code = modet.copy_code
		                    and mom.out_id = modet.out_id
		                  <where>
		                   <![CDATA[ AND mom.confirm_date >= #{begin_out_date,jdbcType=DATE} ]]>
			   			   <![CDATA[ AND mom.confirm_date <= #{end_out_date,jdbcType=DATE} ]]>
		                  </where>
		                  group by 
		                        mom.group_id,mom.hos_id,mom.copy_code,modet.inv_id,
		                        modet.batch_no,modet.bar_code,modet.price,modet.sale_price,
		                        modet.sell_price,modet.location_id,modet.inva_date,modet.batch_sn,
		                        modet.disinfect_date,mom.store_id,mom.dept_id
		         ) outmsg
		        left join mat_fifo_balance mfb
		        on outmsg.group_id = mfb.group_id
		       and outmsg.hos_id = mfb.hos_id
		       and outmsg.copy_code = mfb.copy_code
		       and outmsg.store_id = mfb.store_id
		       and outmsg.inv_id = mfb.inv_id
		       and outmsg.batch_no = mfb.batch_no
		       and outmsg.batch_sn = mfb.batch_sn
		       and outmsg.bar_code = mfb.bar_code
		      left join mat_location_dict mld
		        on outmsg.group_id = mld.group_id
		       and outmsg.hos_id = mld.hos_id
		       and outmsg.copy_code = mld.copy_code
		       and outmsg.location_id = mld.location_id
		       and mld.is_stop = 0
		      left join mat_inv_dict mid
		        on outmsg.group_id = mid.group_id
		       and outmsg.hos_id = mid.hos_id
		       and outmsg.copy_code = mid.copy_code
		       and outmsg.inv_id = mid.inv_id
		       and mid.is_stop = 0
		       and mid.use_state = 1
		      left join mat_type_dict mtd
		        on outmsg.group_id = mtd.group_id
		       and outmsg.hos_id = mtd.hos_id
		       and outmsg.copy_code = mtd.copy_code
		       and mid.mat_type_id = mtd.mat_type_id
		       and mtd.is_stop = 0
		      left join hos_fac_dict hfd
		        on outmsg.group_id = hfd.group_id
		       and outmsg.hos_id = hfd.hos_id
		       and mid.fac_id = hfd.fac_id
		       and mid.fac_no = hfd.fac_no
		      left join hos_unit hu
		        on outmsg.group_id = hu.group_id
		       and outmsg.hos_id = hu.hos_id
		       and mid.unit_code = hu.unit_code
		 	 where outmsg.group_id = #{group_id,jdbcType=INTEGER}
			   AND outmsg.hos_id = #{hos_id,jdbcType=INTEGER}
			   AND outmsg.copy_code = #{copy_code,jdbcType=VARCHAR}
			   <if test="store_id != null and store_id != ''">
					AND outmsg.store_id = #{store_id,jdbcType=INTEGER}
			   </if>
			   <if test="dept_id != null and dept_id != ''">
					AND outmsg.dept_id = #{dept_id,jdbcType=INTEGER}
			   </if>
			   <if test="inv_id != null and inv_id != ''">
					AND outmsg.inv_id = #{inv_id,jdbcType=INTEGER}
			   </if>
			group by 
	           outmsg.group_id,outmsg.hos_id,outmsg.copy_code,outmsg.inv_id,
	           mid.inv_no,mid.inv_code,mid.inv_name,mid.inv_model,hu.unit_name,
	           mtd.mat_type_name,hfd.fac_name,outmsg.batch_no,outmsg.bar_code,
	           outmsg.price,outmsg.sale_price,outmsg.sell_price,outmsg.location_id,
	           mld.location_code,mld.location_name,outmsg.inva_date,outmsg.disinfect_date
		),out_temp as (
			select inv_id, batch_no, bar_code, sum(amount) as imme_amount
			from(
				--出库未确认单据
				select b.inv_id, b.batch_no, b.bar_code, sum(b.amount) as amount
				from mat_out_main a
				left join mat_out_detail b on a.group_id = b.group_id and a.hos_id = b.hos_id
					and a.copy_code = b.copy_code and a.out_id = b.out_id
				where a.group_id = #{group_id,jdbcType=INTEGER}
					AND a.hos_id = #{hos_id,jdbcType=INTEGER}
					AND a.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND a.store_id = #{store_id,jdbcType=INTEGER}
					<![CDATA[
						AND a.state < 3 
						AND a.bus_type_code <> '21'
						and b.amount_money > 0
					]]>
				group by b.inv_id, b.batch_no, b.bar_code
				--退货未确认单据
				union all
				select b.inv_id, b.batch_no, b.bar_code,  sum(b.amount) as amount
				from mat_in_main a
				left join mat_in_detail b on a.group_id = b.group_id and a.hos_id = b.hos_id
					and a.copy_code = b.copy_code and a.in_id = b.in_id
				where a.group_id = #{group_id,jdbcType=INTEGER}
					AND a.hos_id = #{hos_id,jdbcType=INTEGER}
					AND a.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND a.store_id = #{store_id,jdbcType=INTEGER}
					AND <![CDATA[ a.state < 3 ]]>
					AND a.bus_type_code in ( '10','12','16','22')
					and <![CDATA[ b.amount_money < 0 ]]>
				group by b.inv_id, b.batch_no, b.bar_code
			)
			group by inv_id, batch_no, bar_code
			order by inv_id asc
		)
		select a.group_id, a.hos_id,
			a.copy_code,
			a.inv_id, --材料ID
			a.inv_no, --材料变更号
			a.inv_code, --材料编码
			a.inv_name, --材料名称
			a.inv_model, --规格型号
			a.unit_name,
			--计量单位
			a.mat_type_name, --材料类别名称
			a.fac_name, --生成产商名称
			a.batch_no, --批号
			a.bar_code, --条形码
			a.amount as old_amount, --上期使用量
			a.left_amount as
			cur_amount, --当前库存数量
			a.left_money as cur_money, --当前库存金额
			a.price, --单价
			a.sale_price, --批发单价
			a.sell_price, --零售单价
			a.location_id, --货位ID
			a.location_code, --货位编码
			a.location_name, --货位名称
			a.inva_date, --有效期
			a.disinfect_date, --灭菌期
			nvl(a.left_amount,0) - nvl(b.imme_amount,0) AS
			imme_amount
		from inv_temp a
		left join out_temp b on a.inv_id = b.inv_id
			and a.batch_no= b.batch_no
			and a.bar_code= b.bar_code
		<where>
			<if test="show_zero != null and show_zero != 1">
				nvl(a.left_amount,0) - nvl(b.imme_amount,0) > 0
			</if>
		</where>
		order by a.inv_code, a.inva_date
	</select>
	
	<select id="queryMatOutDetailByCode" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT mom.group_id, mom.hos_id, mom.copy_code, mom.out_id, mom.store_id, mom.state, 
			mod.out_detail_id, mod.inv_id, mod.inv_no, mid.inv_code, mid.inv_name, mid.bid_code, 
			mid.inv_model, hu.unit_name, hfd.fac_name, mod.batch_no, mod.batch_sn, mod.bar_code, 
			mod.location_id location_new_id, mld.location_code location_new_code, mld.location_name location_new_name, 
			mod.inva_date, mod.disinfect_date, mod.amount, mod.price, mod.sell_price, mod.sale_price, mod.allot_price, 
			mod.amount_money, mod.sell_money, mod.sale_money, mod.allot_money, mod.note,
			nvl(mfb.left_amount, 0)  as cur_amount,
			<!-- nvl(mfb.left_amount - nvl(vmsi.amount, 0), 0) + nvl(mod.amount,0) as imme_amount -->
			case when mom.state = 3 then nvl(mfb.left_amount - nvl(vmsi.amount, 0), 0)  
    		else nvl(mfb.left_amount - nvl(vmsi.amount, 0), 0) + nvl(mod.amount, 0) end as imme_amount
		FROM mat_out_main mom 
		LEFT JOIN mat_out_detail mod 
			ON mom.group_id = mod.group_id 
			AND mom.hos_id = mod.hos_id 
			AND mom.copy_code = mod.copy_code 
			AND mom.out_id = mod.out_id 
		LEFT JOIN mat_inv_dict mid 
			ON mod.group_id = mid.group_id
			AND mod.hos_id = mid.hos_id
			AND mod.copy_code = mid.copy_code
			AND  mod.inv_id = mid.inv_id
			<if test="show_history == 1">
				AND mod.inv_no = mid.inv_no
			</if>
			<if test="show_history == 0">
				AND mid.is_stop = 0
			</if>
		LEFT JOIN hos_unit hu 
			ON mid.group_id = hu.group_id 
			AND mid.hos_id = hu.hos_id 
			AND mid.unit_code = hu.unit_code 
		left join mat_store_inv msi 
			on mid.group_id =msi.group_id
			and mid.hos_id = msi.hos_id 
			and mid.copy_code = msi.copy_code
			and mid.inv_id = msi.inv_id
			and msi.store_id = #{store_id,jdbcType=INTEGER}
		left join mat_location_dict mld 
			on msi.group_id = mld.group_id
			and msi.hos_id = mld.hos_id
			and msi.copy_code = mld.copy_code
			and msi.location_id = mld.location_id
			and msi.store_id = mld.store_id 
			and mld.is_stop = 0 
		left join hos_fac_dict hfd 
			on hfd.group_id = mid.group_id
			and hfd.hos_id = mid.hos_id
			and hfd.fac_id = mid.fac_id
			and hfd.fac_no = mid.fac_no
	    left join mat_fifo_balance mfb on  
			mod.group_id = mfb.group_id
			and mod.hos_id = mfb.hos_id
			and mod.copy_code = mfb.copy_code
			and mom.store_id = mfb.store_id
			and mod.inv_id = mfb.inv_id
			and mod.price = mfb.price
			and mod.batch_no = mfb.batch_no
			and mod.batch_sn = mfb.batch_sn
			and mod.bar_code = mfb.bar_code
			and mod.location_id = mfb.location_id 
	    left join v_mat_stock_imme vmsi on mfb.group_id = vmsi.group_id
			and mfb.hos_id = vmsi.hos_id
			and mfb.copy_code = vmsi.copy_code
			and mfb.store_id = vmsi.store_id
			and mfb.inv_id = vmsi.inv_id
			and mfb.price = vmsi.price
			and mfb.batch_no = vmsi.batch_no
			and mfb.batch_sn = vmsi.batch_sn
			and mfb.bar_code = vmsi.bar_code
			and mfb.location_id = vmsi.location_id
		WHERE mom.group_id = #{group_id,jdbcType=BIGINT}
			AND mom.hos_id = #{hos_id,jdbcType=BIGINT}
			AND mom.copy_code = #{copy_code,jdbcType=VARCHAR}
			AND mom.out_id = #{out_id,jdbcType=BIGINT}
		order by mom.out_id,mld.LOCATION_NAME,mid.spell_code,mod.out_detail_id desc
	</select>
	
	<select id="queryMatOutDetailByOutId" parameterType="java.util.Map" resultType="java.util.TreeMap">
		WITH tmp_imme AS(
		    SELECT inv_id, batch_sn, batch_no, bar_code,  SUM(amount) AS amount,price
		    FROM (
		         SELECT inv_id, batch_sn, batch_no, bar_code, SUM(nvl(amount, 0)) AS amount,price
		         FROM mat_out_main mom
		         LEFT JOIN mat_out_detail matod  ON mom.group_id = matod.group_id
		              AND mom.hos_id =  matod.hos_id
		              AND mom.copy_code = matod.copy_code
		              AND mom.out_id = matod.out_id
		         WHERE matod.group_id = #{group_id,jdbcType=INTEGER}
		               AND matod.hos_id = #{hos_id,jdbcType=INTEGER}
		               AND matod.copy_code = #{copy_code,jdbcType=VARCHAR}
		               AND mom.store_id = #{store_id,jdbcType=INTEGER}
		              <![CDATA[
			              AND mom.out_id <> #{out_id,jdbcType=INTEGER} 
			              AND mom.state < 3
			              AND mom.bus_type_code <> '21'
			              AND matod.amount_money > 0
		              ]]>
		         GROUP BY inv_id, batch_sn, batch_no, bar_code,price
		         UNION ALL
		         SELECT inv_id AS inv_id, batch_sn AS batch_sn, batch_no AS batch_no, bar_code AS bar_code, -1 * SUM(nvl(amount, 0)) AS amount,price
		         FROM mat_in_main mim
		         LEFT JOIN mat_in_detail matid  ON mim.group_id = matid.group_id
		              AND mim.hos_id = matid.hos_id
		              AND mim.copy_code = matid.copy_code
		              AND mim.in_id = matid.in_id
		         WHERE matid.group_id = #{group_id,jdbcType=INTEGER}
		               AND matid.hos_id = #{hos_id,jdbcType=INTEGER}
		               AND matid.copy_code = #{copy_code,jdbcType=VARCHAR}
		               AND mim.store_id = #{store_id,jdbcType=INTEGER}
		               <![CDATA[
		         	     AND mim.state < 3
		                 AND mim.bus_type_code in ('10','12','16','22')
		                 and matid.amount_money < 0 
		               ]]>
		         GROUP BY inv_id, batch_sn, batch_no, bar_code,price
		    )
		    GROUP BY inv_id, batch_sn, batch_no, bar_code,price
		    ORDER BY inv_id ASC
		    ), tmp_detail AS(
		      SELECT
		          modet.group_id, modet.hos_id, modet.copy_code, modet.out_id,
		          modet.out_detail_id,
		          modet.inv_id, modet.inv_no, modet.batch_no,
		          modet.bar_code, modet.batch_sn,
		          modet.inva_date,
		          modet.disinfect_date,
		          modet.location_id, modet.note, modet.price, modet.amount,
		          modet.amount_money,
		          modet.sale_price, modet.sale_money,
		          modet.sell_price, modet.sell_money,
		          modet.allot_price,
		          modet.allot_money,
		          mfb.left_amount AS cur_amount, mfb.left_amount -
		      nvl(imme.amount, 0) AS imme_amount
		      FROM MAT_OUT_DETAIL modet
		      LEFT JOIN mat_fifo_balance mfb ON modet.group_id = mfb.group_id
		           AND modet.hos_id = mfb.hos_id
		           AND modet.copy_code = mfb.copy_code
		           AND modet.inv_id = mfb.inv_id
		           AND modet.batch_sn = mfb.batch_sn
		           AND modet.batch_no = mfb.batch_no
		           AND modet.bar_code = mfb.bar_code
		           and modet.price = mfb.price
		           AND mfb.store_id = #{store_id,jdbcType=INTEGER}
		      LEFT JOIN tmp_imme imme ON modet.inv_id = imme.inv_id
		           AND modet.batch_sn = imme.batch_sn
		           AND modet.batch_no = imme.batch_no
		           AND modet.bar_code = imme.bar_code
		           and modet.price = imme.price
		      WHERE modet.group_id = #{group_id,jdbcType=INTEGER}
		            AND modet.hos_id = #{hos_id,jdbcType=INTEGER}
		            AND modet.copy_code = #{copy_code,jdbcType=VARCHAR}
		            AND modet.out_id =  #{out_id,jdbcType=INTEGER}
		      ORDER BY modet.out_detail_id ASC
		    ), tmp_main AS(
		    SELECT main.group_id, main.hos_id, main.copy_code, main.out_id,
		      main.inv_id,
		      main.inv_no,
		      main.batch_no, main.bar_code, main.inva_date,
		      main.disinfect_date, main.location_id,
		      main.note, main.price,
		      main.amount, main.amount_money,
		      main.sale_price, main.sale_money,
		      main.sell_price, main.sell_money, main.allot_price, main.allot_money,
		      SUM(mfb.left_amount) AS cur_amount, SUM(mfb.left_amount) -
		      main.out_amount AS imme_amount
		    FROM (
		         SELECT detail.*, nvl(imme.amount,0) AS out_amount
		         FROM (
		         SELECT group_id, hos_id, copy_code, out_id,
		            inv_id, inv_no, batch_no,
		            bar_code, inva_date,
		            disinfect_date,
		            location_id, note, price, SUM(amount) AS amount, SUM(amount_money) AS
		            amount_money,
		            sale_price, SUM(sale_money) AS sale_money, sell_price,
		            SUM(sell_money) AS
		            sell_money,
		            allot_price, SUM(allot_money) AS
		            allot_money
		         FROM tmp_detail
		         GROUP BY group_id, hos_id, copy_code, out_id, inv_id, inv_no, batch_no, bar_code, inva_date, disinfect_date,
		         location_id, note, price, sell_price, sale_price, allot_price
		    ) detail
		    LEFT JOIN (
		        SELECT inv_id, batch_no, bar_code, SUM(amount) AS amount,price
		        FROM tmp_imme
		        GROUP BY inv_id, batch_no, bar_code,price
		    ) imme  ON detail.inv_id = imme.inv_id
		        AND detail.batch_no = imme.batch_no
		        AND detail.bar_code = imme.bar_code
		        and detail.price = imme.price 
		    ) main
		    LEFT JOIN mat_fifo_balance mfb ON main.group_id =  mfb.group_id
		        AND main.hos_id = mfb.hos_id
		        AND main.copy_code = mfb.copy_code
		        AND main.inv_id = mfb.inv_id
		        AND main.batch_no = mfb.batch_no
		        AND main.bar_code = mfb.bar_code
		        AND main.price = mfb.price
		        AND mfb.store_id = #{store_id,jdbcType=INTEGER}
		    GROUP BY main.group_id, main.hos_id, main.copy_code, main.out_id, main.inv_id, main.inv_no,  main.batch_no,
		        main.bar_code, main.inva_date, main.disinfect_date, main.location_id,
		        main.note, main.price, main.amount, main.amount_money,
		        main.sale_price, main.sale_money,
		        main.sell_price, main.sell_money,
		        main.allot_price, main.allot_money, main.out_amount
		    )
		    select main.group_id, main.hos_id, main.copy_code, mid.bid_code, main.out_id
		        , hfd.fac_name, main.inv_id, main.inv_no, main.batch_no, main.price
		        , main.cur_amount, main.imme_amount, main.amount, main.amount_money, main.sale_price
		        , main.sale_money, main.sell_price, main.sell_money, main.allot_price, main.allot_money
		        , main.bar_code, main.inva_date, main.disinfect_date, msi.location_id location_new_id, main.note
		        , mid.inv_code, mid.inv_name, mid.inv_model, mid.unit_code, hu.unit_name
		        , mld.location_code location_new_code, mld.location_name location_new_name, main.amount as sum_amount
		        , '[' || to_char(wm_concat('{"out_detail_id":' || detail.out_detail_id || ',"inv_id":' || detail.inv_id || ',"inv_code":"' || to_char(mid.inv_code) || '","inv_name":"' || to_char(mid.inv_name) || '","batch_sn":' || detail.batch_sn || ',"cur_amount":' || detail.cur_amount || ',"imme_amount":' || detail.imme_amount || ',"amount":' || detail.amount || ',"price":' || detail.price || ',"amount_money":' || detail.amount_money || ',"sale_price":' || detail.sale_price || ',"sale_money":' || detail.sale_money || ',"sell_price":' || detail.sell_price || ',"sell_money":' || detail.sell_money || '}')) || ']' as inv_detail_data
		 		 
		 		<!-- ,mc.cert_code -->
		  from tmp_main main
		  LEFT JOIN mat_inv_dict mid ON main.group_id = mid.group_id
		    AND main.hos_id = mid.hos_id
		    AND main.copy_code = mid.copy_code
		    AND  main.inv_id = mid.inv_id
		    <if test="show_history == 1">
		      AND main.inv_no = mid.inv_no
		    </if>
			<if test="show_history == 0">
		      AND mid.is_stop = 0
			</if>
			 <!-- left join (
		      select micr.group_id, micr.hos_id, micr.copy_code, micr.inv_id, max(micr.cert_id) as cert_id
					from mat_prod_cert_inv micr
						left join mat_prod_cert mic on mic.cert_id = micr.cert_id 
					where micr.group_id =  #{group_id,jdbcType=INTEGER}
						and micr.hos_id = #{hos_id,jdbcType=INTEGER}
						and micr.copy_code =  #{copy_code,jdbcType=VARCHAR}
						and mic.cert_state = 1
					group by micr.group_id, micr.hos_id, micr.copy_code, micr.inv_id
			) mm on mm.inv_id=main.inv_id
			left join mat_prod_cert mc on mm.group_id=mc.group_id and mm.hos_id=mc.hos_id
				and mm.copy_code=mc.copy_code and mm.cert_id=mc.cert_id and mc.check_state=2 -->
		
		    LEFT JOIN hos_unit hu ON mid.group_id = hu.group_id
		    AND mid.hos_id = hu.hos_id
		    AND mid.unit_code = hu.unit_code and hu.is_stop = 0
		    left join mat_store_inv msi on main.group_id =msi.group_id
		      and main.hos_id = msi.hos_id and main.copy_code = msi.copy_code
		      and main.inv_id = msi.inv_id
		      and msi.store_id = #{store_id,jdbcType=INTEGER}
		   left join mat_location_dict mld on msi.group_id = mld.group_id
		      and msi.hos_id = mld.hos_id
		      and msi.copy_code = mld.copy_code
		      and msi.location_id = mld.location_id
		      and msi.store_id = mld.store_id 
		      and mld.is_stop = 0 
		    LEFT JOIN tmp_detail detail ON main.inv_id = detail.inv_id
		      AND main.batch_no = detail.batch_no
		      AND main.bar_code = detail.bar_code
		      AND main.price = detail.price
		  left join hos_fac_dict hfd on hfd.group_id = mid.group_id
		         and hfd.hos_id = mid.hos_id
		         and hfd.fac_id = mid.fac_id
		         and hfd.fac_no = mid.fac_no
		    group by main.group_id, main.hos_id, main.copy_code, mid.bid_code, main.out_id, 
		      hfd.fac_name, main.inv_id, main.inv_no, main.batch_no, main.price, main.cur_amount, 
		      main.imme_amount, main.amount, main.amount_money, main.sale_price, main.sale_money, 
		      main.sell_price, main.sell_money, main.allot_price, main.allot_money, main.bar_code, 
		      main.inva_date, main.disinfect_date, msi.location_id, main.note, mid.inv_code, mid.inv_name, 
		      mid.inv_model, mid.unit_code, hu.unit_name, mld.location_code, mld.location_name, main.amount<!-- ,mc.cert_code -->
		    <!--order by mid.inv_name--> 
		    <!-- , inv_detail_data --> 
	</select>

	<select id="queryMatOutDetailByIsDir" parameterType="java.util.Map" resultType="java.util.TreeMap">
		with tmp_imme as (
			select inv_id, batch_sn, batch_no, bar_code, sum(amount) as amount
			from (
				select inv_id, batch_sn, batch_no, bar_code, sum(nvl(amount, 0)) as amount
				from mat_out_main mom
				left join mat_out_detail matod on mom.group_id = matod.group_id and mom.hos_id = matod.hos_id
					and mom.copy_code = matod.copy_code and mom.out_id = matod.out_id
				where matod.group_id = #{group_id,jdbcType=INTEGER}
					AND matod.hos_id = #{hos_id,jdbcType=INTEGER}
					AND matod.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND mom.store_id = #{store_id,jdbcType=INTEGER}
					<![CDATA[
						AND mom.state < 3 
						AND mom.bus_type_code <> '21'
						AND matod.amount_money > 0
					]]>
				group by inv_id, batch_sn, batch_no, bar_code
				union all
				select inv_id, batch_sn, batch_no, bar_code, -1 * sum(nvl(amount, 0)) as amount
				from mat_in_main mim
				left join mat_in_detail matid on mim.group_id = matid.group_id and mim.hos_id = matid.hos_id
					and mim.copy_code = matid.copy_code and mim.in_id = matid.in_id
				where matid.group_id = #{group_id,jdbcType=INTEGER}
					AND matid.hos_id = #{hos_id,jdbcType=INTEGER}
					AND matid.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND mim.store_id = #{store_id,jdbcType=INTEGER} 
					<![CDATA[ 
					AND mim.state < 3 
					AND mim.bus_type_code in ('10','12','16','22')
					AND matid.amount_money < 0
					]]>
				group by inv_id, batch_sn, batch_no, bar_code
			)
			group by inv_id, batch_sn, batch_no, bar_code
			order by inv_id asc
		), tmp_detail as(
			select
				midet.group_id, midet.hos_id, midet.copy_code, midet.inv_id,
				midet.batch_no, midet.batch_sn,
				midet.bar_code, midet.price,
				nvl(midet.sale_price, 0) as sale_price,
				nvl(midet.sell_price, 0) as sell_price,
				nvl(midet.allot_price, 0) as allot_price, midet.inva_date,
				midet.disinfect_date,
				midet.location_id,
				sum(nvl(mfb.left_amount, 0)) as cur_amount,
				sum(nvl(mfb.left_amount, 0) - nvl(imme.amount, 0)) as imme_amount,
				sum(nvl(mfb.left_amount, 0) - nvl(imme.amount, 0)) as amount
			from mat_in_detail midet
			left join mat_fifo_balance mfb on midet.group_id = mfb.group_id and midet.hos_id = mfb.hos_id
				and midet.copy_code = mfb.copy_code and mfb.store_id = #{store_id,jdbcType=INTEGER}
				and midet.inv_id = mfb.inv_id and midet.batch_no = mfb.batch_no
				and midet.batch_sn = mfb.batch_sn and midet.bar_code = mfb.bar_code
			left join tmp_imme imme on midet.inv_id = imme.inv_id and midet.batch_no = imme.batch_no
				and midet.batch_sn = imme.batch_sn and midet.bar_code = imme.bar_code
			where midet.group_id = #{group_id,jdbcType=INTEGER}
				and midet.hos_id = #{hos_id,jdbcType=INTEGER}
				and midet.copy_code = #{copy_code,jdbcType=VARCHAR}
			<if test="sql!= null and sql != ''">
				${sql}
			</if>
			group by midet.group_id, midet.hos_id, midet.copy_code, midet.inv_id,
				midet.batch_no, midet.batch_sn,
				midet.bar_code, midet.price,
				midet.sale_price, midet.sell_price, midet.allot_price,
				midet.inva_date,
				midet.disinfect_date, midet.location_id
				having sum(nvl(mfb.left_amount, 0) - nvl(imme.amount, 0)) > 0
			order by midet.inv_id, midet.inva_date, midet.bar_code, midet.batch_sn
		), tmp_main as(
			SELECT main.group_id, main.hos_id, main.copy_code, main.inv_id,
				main.batch_no, main.bar_code,
				main.inva_date,
				main.disinfect_date, main.location_id, main.price, main.amount,
				main.sale_price,
				main.sell_price, main.allot_price,
				SUM(mfb.left_amount) AS cur_amount,
				SUM(mfb.left_amount) - main.out_amount AS imme_amount
			FROM (
			SELECT detail.*, nvl(imme.amount,0) AS out_amount
			FROM (
			select group_id, hos_id, copy_code, inv_id, batch_no, bar_code, inva_date, disinfect_date, location_id,
				price, SUM(amount) AS amount, sale_price, sell_price, allot_price
			from
			tmp_detail
			group by group_id, hos_id, copy_code, inv_id, batch_no, bar_code,
			inva_date, disinfect_date, location_id,price, sell_price,sale_price, sale_price, sell_price, allot_price
		) detail
		LEFT JOIN (
			SELECT inv_id, batch_no, bar_code, SUM(amount) AS amount
			FROM tmp_imme
			GROUP BY inv_id, batch_no, bar_code
		) imme ON detail.inv_id = imme.inv_id
			AND detail.batch_no = imme.batch_no
			AND detail.bar_code = imme.bar_code
		) main
		LEFT JOIN mat_fifo_balance mfb ON main.group_id = mfb.group_id AND main.hos_id = mfb.hos_id
			AND main.copy_code = mfb.copy_code AND main.inv_id = mfb.inv_id
			AND main.batch_no = mfb.batch_no AND main.bar_code = mfb.bar_code
			AND mfb.store_id = #{store_id,jdbcType=INTEGER}
		group by main.group_id, main.hos_id,
			main.copy_code, main.inv_id, main.batch_no, main.bar_code,
			main.inva_date, main.disinfect_date, main.location_id, main.price,
			main.amount, main.sale_price, main.sell_price, main.allot_price, main.out_amount
		)
		select main.inv_id, mid.inv_no,
			mid.inv_code,
			mid.inv_name, mtd.mat_type_name, mid.inv_model,
			hu.unit_name,
			main.batch_no, main.bar_code, main.price, main.sale_price,
			main.sell_price,
			main.inva_date, main.disinfect_date,
			hfd.fac_name,
			main.location_id, mld.location_code, mld.location_name,
			main.cur_amount, main.imme_amount,
			main.amount, main.amount * main.price as amount_money, main.amount * main.sale_price as sale_money,
			main.amount * main.sell_price as sell_money, main.amount as sum_amount,
			'[' || to_char(wm_concat('{"inv_id":' || detail.inv_id ||
			',"inv_code":"' ||
			to_char(mid.inv_code)
			|| '","inv_name":"' ||
			to_char(mid.inv_name) || '","batch_sn":' ||
			detail.batch_sn
			||
			',"cur_amount":' || detail.cur_amount || ',"imme_amount":' ||
			detail.imme_amount
			|| ',"amount":' || detail.amount || ',"price":' ||
			detail.price
			|| ',"amount_money":' || (detail.amount * detail.price) ||
			',"sale_price":' || detail.sale_price
			|| ',"sale_money":' ||
			(detail.amount * detail.sale_price) ||
			',"sell_price":' ||
			detail.sell_price
			|| ',"sell_money":' || (detail.amount *
			detail.sell_price) || '}'))
			|| ']' inv_detail_data
		from tmp_main main
		left join mat_inv_dict mid on main.group_id = mid.group_id and main.hos_id = mid.hos_id
			and main.copy_code = mid.copy_code and main.inv_id = mid.inv_id
			and mid.is_stop = 0
		left join mat_type_dict mtd on main.group_id = mtd.group_id
			and main.hos_id = mtd.hos_id
			and main.copy_code = mtd.copy_code
			and mid.mat_type_id = mtd.mat_type_id
			and mtd.is_stop = 0
		left join hos_fac_dict hfd on main.group_id = hfd.group_id and main.hos_id = hfd.hos_id
			and mid.fac_id = hfd.fac_id
			and mid.fac_no = hfd.fac_no
		LEFT JOIN hos_unit hu ON main.group_id = hu.group_id
			and main.hos_id = hu.hos_id
			and mid.unit_code = hu.unit_code
		LEFT JOIN mat_location_dict mld on main.group_id = mld.group_id
			and main.hos_id = mld.hos_id
			and main.copy_code = mld.copy_code
			and main.location_id = mld.location_id
			and mld.is_stop = 0
		LEFT JOIN tmp_detail detail ON main.inv_id = detail.inv_id
			AND main.batch_no = detail.batch_no
			AND main.bar_code = detail.bar_code
			AND main.price = detail.price
			and nvl(main.inva_date,to_date('2000-01-01','yyyy-mm-dd'))=nvl(detail.inva_date,to_date('2000-01-01','yyyy-mm-dd'))
		group by main.inv_id, mid.inv_no, mid.inv_code, mid.inv_name, mtd.mat_type_name, mid.inv_model,
			hu.unit_name, main.batch_no, main.bar_code, main.price,
			main.sale_price, main.sell_price, main.inva_date, main.disinfect_date,
			hfd.fac_name, main.location_id, mld.location_code, mld.location_name,
			main.cur_amount, main.imme_amount, main.amount
	</select>

	<select id="queryMatOutDetailForConfirm" parameterType="java.util.List" resultMap="matOutDetail">
		SELECT
			a.group_id, a.hos_id, a.copy_code, 
			<!-- 如果确认日期走编制日期则放开注释
			a.year, 
			a.month, 
			 --> 
			a.store_id, b.inv_id, 
			c.inv_code, c.inv_name, b.batch_sn, b.batch_no, b.price, 
			sum(b.amount) as amount, sum(b.amount_money) as amount_money, 
			nvl(b.sale_price, 0) as sale_price, sum(nvl(b.sale_money, 0)) as sale_money, 
			b.bar_code, b.location_id 
		FROM MAT_OUT_MAIN a 
		LEFT JOIN MAT_OUT_DETAIL b 
			on a.group_id = b.group_id and a.hos_id = b.hos_id 
			and a.copy_code = b.copy_code and a.out_id = b.out_id 
		LEFT JOIN MAT_INV c 
			on b.group_id = c.group_id and b.hos_id = c.hos_id 
			and b.copy_code = c.copy_code and b.inv_id = c.inv_id 
		WHERE
		<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
				a.group_id = #{item.group_id,jdbcType=INTEGER}
			and a.hos_id = #{item.hos_id,jdbcType=INTEGER}
			and a.copy_code = #{item.copy_code,jdbcType=VARCHAR}
			and a.out_id = #{item.out_id,jdbcType=INTEGER}
			and a.state &lt;&gt; 3
		</foreach>
		group by a.group_id, a.hos_id, a.copy_code, 
			<!-- 如果确认日期走编制日期则放开注释
			a.year, 
			a.month, 
			 --> 
			a.store_id, b.inv_id, c.inv_code, c.inv_name, b.price, b.batch_sn, 
			b.batch_no, b.sale_price, b.bar_code, b.location_id
		order by b.inv_id asc
	</select>

	<select id="queryMatOutForDura" parameterType="java.util.List" resultType="java.util.Map">
		SELECT
			a.group_id, a.hos_id, a.copy_code, a.store_id, d.store_no, a.dept_id, e.dept_no, 
			b.inv_id, c.inv_no, c.inv_code, c.inv_name, b.price, b.bar_code, 
			sum(b.amount) as amount, sum(b.amount_money) as amount_money 
		FROM mat_out_main a 
		LEFT JOIN mat_out_detail b 
			ON a.group_id = b.group_id AND a.hos_id = b.hos_id 
			AND a.copy_code = b.copy_code AND a.out_id = b.out_id 
		LEFT JOIN mat_inv_dict c 
			ON b.group_id = c.group_id AND b.hos_id = c.hos_id 
			AND b.copy_code = c.copy_code AND b.inv_id = c.inv_id 
			AND c.is_stop = 0 
		LEFT JOIN hos_store_dict d 
			ON a.group_id = d.group_id AND a.hos_id = d.hos_id 
			AND a.store_id = d.store_id AND d.is_stop = 0
		LEFT JOIN hos_dept_dict e 
			ON a.group_id = e.group_id AND a.hos_id = e.hos_id 
			AND a.dept_id = e.dept_id AND e.is_stop = 0
		WHERE
		<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
				a.group_id = #{item.group_id,jdbcType=INTEGER}
			AND a.hos_id = #{item.hos_id,jdbcType=INTEGER}
			AND a.copy_code = #{item.copy_code,jdbcType=VARCHAR}
			AND a.out_id = #{item.out_id,jdbcType=INTEGER}
		</foreach>
			AND c.is_dura = 1
		group by a.group_id, a.hos_id, a.copy_code, a.store_id, d.store_no, a.dept_id, 
			e.dept_no, b.inv_id, c.inv_no, c.inv_code, c.inv_name, b.price, b.bar_code  
		order by b.inv_id asc
	</select>
<!-- 2016/12/19 lxj 查询出库明细 -->
	<select id="queryMatStorageQueryOutDetailNew" parameterType="java.util.Map" resultMap="matOutDetailList">
	
		with temp as (
			select mom.dept_id, mom.dept_no, mom.dept_emp, he.emp_name, mod.price
					, hsd.store_name, mtd.mat_type_code,mtd.mat_type_name
					, decode(mid.inv_code, null, '0', mid.inv_code) as inv_code
					, mid.inv_name, mid.inv_model, sum(mod.amount) as amount
					, sum(mod.amount_money) as amount_money
					,to_char(mom.confirm_date,'yyyy-MM') confirm_dates
			from mat_out_detail mod
			left join mat_out_main mom on mod.group_id = mom.group_id
				and mod.hos_id = mom.hos_id and mod.copy_code = mom.copy_code
				and mod.out_id = mom.out_id
			left join mat_inv_dict mid on mid.group_id = mod.group_id
				and mid.hos_id = mod.hos_id and mid.inv_id = mod.inv_id
				and mid.inv_no = mod.inv_no
			left join mat_bus_type mbt on mom.bus_type_code = mbt.bus_type_code 
		  	LEFT JOIN mat_type_dict mtd  ON mtd.group_id = mid.group_id
		    	AND mtd.hos_id = mid.hos_id
		    	AND mtd.copy_code = mid.copy_code
		    	AND mtd.mat_type_id = mid.mat_type_id
		    	AND mtd.mat_type_no = mid.mat_type_no 
		    left join hos_store_dict hsd on
			        mom.group_id=hsd.group_id
			        and mom.hos_id=hsd.hos_id
			        and mom.store_id=hsd.store_id
			        and mom.store_no=hsd.store_no
			 left join hos_emp he on
			        mom.group_id=he.group_id
			        and mom.hos_id=he.hos_id
			        and mom.dept_emp=he.emp_id
			
			<where>
				<!--由于专购品在mat_bus_type中sel_flag没有进行维护  导致选择专购品查询不到数据 -->
			 	(mbt.sel_flag = 'out' or mbt.sel_flag is null)
			    <!-- mbt.sel_flag = 'out' --> 
			    <!-- 2017/03/21注释掉此处,增加如下业务类型条件 -->
				<!-- and mom.bus_type_code = '3' -->
				<if test="bus_type_code != null and bus_type_code != '' ">
					and mom.bus_type_code in ${bus_type_code}
				</if>
				<if test="bus_type_code == null or bus_type_code == '' ">
					and mom.bus_type_code in (3, 21, 9,11,13,23,49,50)
				</if>
				<if test="group_id != null and group_id != ''">
					and mom.group_id = #{group_id}
				</if>
				<if test="hos_id != null and hos_id != ''">
					and mom.hos_id = #{hos_id}
				</if>
				<if test="copy_code != null and copy_code != ''">
					and mom.copy_code = #{copy_code}
				</if>
				<if test="begin_confirm_date != null and begin_confirm_date != '' and end_confirm_date != null and end_confirm_date != ''">
			     AND  mom.confirm_date  between to_date(#{begin_confirm_date},'yyyy-MM-dd') and to_date(#{end_confirm_date},'yyyy-MM-dd')
			    </if>
				<if test="store_id != null and store_id != '' and store_id != '00'">
					and mom.store_id = #{store_id}
				</if>
				<if test="store_no != null and store_no != '' and store_id != '00' ">
					and mom.store_no= #{store_no}
				</if>
				<!-- <if test="mat_type_id != null and mat_type_id != ''">
					and mid.mat_type_id= #{mat_type_id}
				</if> -->
				<if test="mat_type_id != null and mat_type_id != ''">
					and mtd.mat_type_code like '${mat_type_code}%'
				</if>
				<if test="mat_type_id == null or mat_type_id == ''">
					and to_char(mtd.mat_type_id) in (
						select perm_code from v_user_data_perm  
						where group_id = #{group_id,jdbcType=INTEGER}
							and hos_id = #{hos_id,jdbcType=INTEGER}
							and table_code = 'MAT_TYPE_DICT'
							and user_id = #{user_id,jdbcType=INTEGER}
							and is_read = 1 and is_write = 1 
					)
				</if>
				<!-- 	<if test="mat_type_no != null and mat_type_no != ''">
					and mid.mat_type_no= #{mat_type_no}
				</if> -->
				<if test="begin_out_date != null and begin_out_date != '' and end_out_date != null and end_out_date != ''">
			     AND  mom.out_date  between to_date(#{begin_out_date},'yyyy-MM-dd') and to_date(#{end_out_date},'yyyy-MM-dd')
			    </if>
			    <if test="dept_id != null and dept_id != '' and dept_id != '00'">
					and mom.dept_id= #{dept_id}
				</if>
				<if test="dept_no != null and dept_no != '' and dept_id != '00'">
					and mom.dept_no= #{dept_no}
				</if>
			
				<if test="inv_msg != null and inv_msg != '' ">
				<!-- 	and (
					mid.inv_code like '%${inv_msg}%' 
					or 
					mid.inv_name like '%${inv_msg}%'
					or
					mid.spell_code like '%${inv_msg}%' 
					or 
					mid.wbx_code like '%${inv_msg}%'
				) -->
				AND (
							 mid.inv_code like '%${inv_msg}%'
							or upper(mid.inv_name) like '%${inv_msg}%'
							or upper(mid.inv_model) like '%${inv_msg}%'
							or upper(mid.spell_code) like '%${inv_msg}%'
							or upper(mid.wbx_code) like '%${inv_msg}%'
							or upper(mid.bid_code) like '%${inv_msg}%'
							or lower(mid.spell_code) like '%${inv_msg}%'
							or lower(mid.bid_code) like '%${inv_msg}%'
							or lower(mid.wbx_code) like '%${inv_msg}%'
							or lower(mid.inv_name) like '%${inv_msg}%'
						
					)
				
			</if>
			
			<!-- <if test="inv_id != null and inv_id != ''">
				and mod.inv_id = #{inv_id}
			</if>
			<if test="inv_no != null and inv_no != ''">
				and mod.inv_no= #{inv_no}
			</if> -->
			<if test="is_charge != null and is_charge != ''">
				and mid.is_charge= #{is_charge}
			</if>
			<if test="state != null and state != ''">
				and mom.state in ${state}
			</if>
			
			<if test="dept_id == '00' ">
				and to_char(mom.dept_id) in ( select perm_code from v_user_data_perm
				where group_id = ${group_id}
				and hos_id = ${hos_id} and user_id = ${user_id} and table_code =
				'HOS_DEPT_DICT'
				and is_read = 1 and is_write = 1)
			</if>
			<if test="store_id == '00' ">
				and to_char(mom.store_id) in (select perm_code from v_user_data_perm
				where group_id = ${group_id}
				and hos_id = ${hos_id} and user_id = ${user_id} and table_code =
				'HOS_STORE_DICT'
				and is_read = 1 and is_write = 1 )
			</if>
			<if test="inv_model != null and inv_model != ''">
					     	AND (
							mid.inv_model like '%${inv_model}%'
							or upper(mid.inv_name) like '%${inv_model}%'
							or upper(mid.inv_model) like '%${inv_model}%'
							or upper(mid.spell_code) like '%${inv_model}%'
							or upper(mid.wbx_code) like '%${inv_model}%'
							or upper(mid.bid_code) like '%${inv_model}%'
							or lower(mid.spell_code) like '%${inv_model}%'
							or lower(mid.bid_code) like '%${inv_model}%'
							or lower(mid.wbx_code) like '%${inv_model}%'
							or lower(mid.inv_name) like '%${inv_model}%'
						
					)
			</if> 
			
			<!-- 2017/03/17 -->
			and mom.dept_id is not null
			</where>
			 group by mom.dept_id, mom.dept_no, mid.inv_code, mid.inv_name, mid.inv_model, mom.dept_id, mom.dept_emp, emp_name, 
        mod.price, hsd.store_name, mtd.mat_type_code,mtd.mat_type_name, mom.confirm_date
		), temp1 as (
			  select dept_id, dept_no, inv_code, inv_name, inv_model
          , amount, amount_money,dept_emp,emp_name,price,store_name,mat_type_code, mat_type_name,confirm_dates
        from temp
        union all
        select null, null, null, null, null
          , sum(amount), sum(amount_money),null,null,null,null,null,null,null
        from temp
        where inv_code != '0'
		), temp2 as (
			select  
				( select a.dept_code from hos_dept_dict a where a.dept_id = temp1.dept_id and a.is_stop = '0') dept_code,
				(select a.dept_name from hos_dept_dict a where a.dept_id = temp1.dept_id and a.is_stop = '0') dept_name,
				decode(inv_code,'0','小计',inv_code) inv_code, inv_name, inv_model, amount, amount_money,dept_emp,emp_name,
				price,store_name,mat_type_code , mat_type_name,confirm_dates
				from temp1
		) 
		select decode(dept_code,'','合计',dept_code) dept_code,dept_name, inv_code, inv_name, inv_model,
		 amount,dept_emp,emp_name,price,store_name,mat_type_code
      , amount_money, mat_type_name,confirm_dates
		from temp2
		where amount != 0
	</select>



	<!-- 2016/12/19 lxj 查询出库明细 -->
	<select id="queryMatStorageQueryOutDetail" parameterType="java.util.Map"
	resultMap="matOutDetailList">
	with temp1 as(

	<if test="bus_type_code!=null or  tran_code==null">
		select
		mom.group_id,mom.hos_id,mom.copy_code,mom.out_id,mom.out_no,mom.confirm_date,mbt.bus_type_code,mbt.bus_type_name,
		hdd.dept_code,hdd.dept_name,mom.state,mid.inv_code,mid.inv_name,mid.inv_model,hu.unit_code,hu.unit_name,mod.price,mod.amount,
		mod.amount_money,mtd.mat_type_code,mtd.mat_type_name,mod.inv_id,mod.inv_no,mom.store_id,hstd.store_name,
		mod.batch_no,mod.inva_date,hfd.fac_name,sup.sup_name,mid.agent_name,sup.cert_code,mid.bid_code
		from mat_out_detail mod
		left join mat_out_main mom on
		mod.group_id = mom.group_id
		and mod.hos_id = mom.hos_id
		and mod.copy_code = mom.copy_code
		and mod.out_id = mom.out_id
		and mod.out_no = mom.out_no
		left join mat_bus_type mbt on mom.bus_type_code = mbt.bus_type_code
		left join hos_dept_dict hdd on
		mom.group_id = hdd.group_id
		and mom.hos_id = hdd.hos_id
		and mom.dept_id = hdd.dept_id
		and mom.dept_no = hdd.dept_no
		left join mat_inv_dict mid on
		mod.group_id = mid.group_id
		and mod.hos_id = mid.hos_id
		and mod.copy_code = mid.copy_code
		and mod.inv_id = mid.inv_id
		and mod.inv_no = mid.inv_no
		left join hos_fac_dict hfd on mid.group_id = hfd.group_id
		and mid.hos_id = hfd.hos_id
		and mid.fac_id=hfd.fac_id
		and mid.fac_no=hfd.fac_no
		left join hos_unit hu on
		mid.group_id = hu.group_id
		and mid.hos_id = hu.hos_id
		and mid.unit_code = hu.unit_code
		and hu.is_stop = 0
		left join mat_type_dict mtd on
		mid.group_id = mtd.group_id
		and mid.hos_id = mtd.hos_id
		and mid.copy_code = mtd.copy_code
		and mid.mat_type_id = mtd.mat_type_id
		and mid.mat_type_no = mtd.mat_type_no
		left join hos_store_dict hstd
		on hstd.group_id=mom.group_id
		and hstd.hos_id=mom.hos_id
		and hstd.store_id=mom.store_id
		and hstd.is_stop=0
		and hstd.is_mat=1
		left join (
		select distinct
		mind.group_id,mind.hos_id,mind.copy_code,
		mind.inv_id,mind.batch_sn,mind.batch_no,
		mind.bar_code,mind.price,hsud.sup_name,hsud.sup_id,mind.cert_code
		from mat_in_main mim
		left join mat_in_detail mind
		on mind.group_id=mim.group_id
		and mind.hos_id=mim.hos_id
		and mind.copy_code=mim.copy_code
		and mind.in_id=mim.in_id
		left join mat_prod_cert mic
		on mic.group_id = mind.group_id
		and mic.hos_id = mind.hos_id
		and mic.copy_code = mind.copy_code
		and mic.cert_id = mind.cert_id
		and mic.check_state = 2
		left join hos_sup_dict hsud
		on hsud.group_id=mim.group_id
		and hsud.hos_id=mim.hos_id
		and hsud.sup_id=mim.sup_id
		and hsud.sup_no=mim.sup_no
		where mim.bus_type_code in (1,2)
		) sup
		on sup.group_id=mod.group_id
		and sup.hos_id=mod.hos_id
		and sup.copy_code=mod.copy_code
		and sup.inv_id=mod.inv_id
		and sup.batch_no=mod.batch_no
		and sup.batch_sn=mod.batch_sn
		and sup.bar_code=mod.bar_code
		and sup.price=mod.price
		<where>
			and mom.state=3
			<if test="agent_name!=null and agent_name!=''">
				and mid.agent_name like '%${agent_name}%'
			</if>

			<if test="sup_id!=null and sup_id!=''">
				and sup.sup_id=#{sup_id}
			</if>
			<if test="group_id != null and group_id != ''">
				and mom.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and mom.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != '' ">
				and mom.copy_code = #{copy_code}
			</if>
			<if
				test="begin_confirm_date != null and begin_confirm_date != '' and end_confirm_date != null and end_confirm_date != '' ">
				and mom.confirm_date between
				to_date(#{begin_confirm_date},'yyyy/MM/dd') and
				to_date(#{end_confirm_date},'yyyy/MM/dd')
			</if>
			<if
				test="begin_out_date != null and begin_out_date != '' and end_out_date != null and end_out_date != '' ">
				and mom.out_date between
				to_date(#{begin_out_date},'yyyy/MM/dd') and
				to_date(#{end_out_date},'yyyy/MM/dd')
			</if>
			<if test="store_id != null and store_id != '' ">
				and mom.store_id = #{store_id}
			</if>
			<if test="store_id == null or store_id == '' ">
				and to_char(mom.store_id) in (
				select perm_code from v_user_data_perm
				where group_id = ${group_id}
				and hos_id = ${hos_id} and user_id = ${user_id}
				and table_code = 'HOS_STORE_DICT'
				and is_read = 1 and is_write = 1
				)
			</if>
			<if test="store_no != null and store_no != '' ">
				and mom.store_no = #{store_no}
			</if>
			<if test="mat_type_code != null and mat_type_code != '' ">
				and mtd.mat_type_code like '${mat_type_code}%'
			</if>
			<!-- <if test="mat_type_id != null and mat_type_id != '' "> and mtd.mat_type_id 
				= #{mat_type_id} </if> -->
			<!-- <if test="mat_type_no != null and mat_type_no != '' "> and mtd.mat_type_no 
				= #{mat_type_no} </if> -->
			<if test="mat_type_id == null or mat_type_id == ''">
				and to_char(mtd.mat_type_id) in (
				select perm_code from v_user_data_perm
				where group_id = #{group_id,jdbcType=INTEGER}
				and hos_id = #{hos_id,jdbcType=INTEGER}
				and table_code = 'MAT_TYPE_DICT'
				and user_id = #{user_id,jdbcType=INTEGER}
				and is_read = 1 and is_write = 1
				)
			</if>
			<if test="dept_id == '00' ">
				and to_char(mom.dept_id) in (
				select perm_code from v_user_data_perm
				where
				group_id = ${group_id}
				and hos_id = ${hos_id}
				and user_id = ${user_id}
				and table_code ='HOS_DEPT_DICT'
				and is_read = 1 and is_write = 1
				)
			</if>
			<if test="dept_id != null and dept_id != '' and dept_id != '00'">
				and mom.dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != '' and dept_id != '00'">
				and mom.dept_no = #{dept_no}
			</if>
			<if test="is_charge != null and is_charge != '' ">
				and mid.is_charge = #{is_charge}
			</if>
			<if test="inv_id != null and inv_id != '' ">
				and mod.inv_id = #{inv_id}
			</if>
			<if test="inv_no != null and inv_no != '' ">
				and mod.inv_no = #{inv_no}
			</if>
			<if test="out_no != null and out_no != '' ">
				AND (
				mom.out_no like '%${out_no}%'
				or upper(mid.inv_name) like '%${out_no}%'
				or upper(mid.inv_model) like '%${out_no}%'
				or upper(mid.spell_code) like '%${out_no}%'
				or upper(mid.wbx_code) like '%${out_no}%'
				or upper(mid.bid_code) like '%${out_no}%'
				or lower(mid.spell_code) like '%${out_no}%'
				or lower(mid.bid_code) like '%${out_no}%'
				or lower(mid.wbx_code) like '%${out_no}%'
				or lower(mid.inv_name) like '%${out_no}%'

				)
			</if>

			<if test="inv_model != null and inv_model != ''">
				and mid.inv_model like '%${inv_model}%'
			</if>

			<if test="inv_msg != null and inv_msg != '' ">
				and (
				mid.inv_id like '%${inv_msg}%'
				or mid.inv_code like '%${inv_msg}%'
				or upper(mid.inv_name) like '%${inv_msg}%'
				or upper(mid.inv_model) like '%${inv_msg}%'
				or upper(mid.spell_code) like '%${inv_msg}%'
				or upper(mid.wbx_code) like '%${inv_msg}%'
				or lower(mid.spell_code) like '%${inv_msg}%'
				or lower(mid.wbx_code) like '%${inv_msg}%'
				or lower(mid.inv_name) like '%${inv_msg}%'
				or lower(mid.inv_model) like '%${inv_msg}%'
				)
			</if>
			<if test="bus_type_code != null and bus_type_code != '' ">
				and mbt.bus_type_code in (${bus_type_code})
			</if>
			<if test="bus_type_code == null or bus_type_code == '' ">
				and mbt.bus_type_code in (3, 21, 9,11,13,23,49,50,19)
			</if>
			<if
				test='set_or_store_id!=null and set_or_store_id!="" and set_or_store!=null and set_or_store=="1"'>
				and mom.store_id =#{set_or_store_id}
			</if>
			<if
				test='set_or_store_id!=null and set_or_store_id!="" and (set_or_store==null or set_or_store!="1")'>
				and mom.store_id in (
				select mss.store_id
				from mat_store_detail mss
				where mss.set_id=#{set_or_store_id}
				)
			</if>

		</where>
	</if>
	<if
		test="(bus_type_code==null and  tran_code==null) or (bus_type_code!=null and  tran_code!=null)">
		union all
	</if>
	<if test="bus_type_code==null or tran_code!=null">
		select
		mom.group_id,mom.hos_id,mom.copy_code,mom.out_id,mtr.tran_no out_no,mom.confirm_date,mbt.bus_type_code,mbt.bus_type_name,
		out_store.store_code as dept_code,out_store.store_name as dept_name,
		mom.state,mid.inv_code,mid.inv_name,mid.inv_model,hu.unit_code,hu.unit_name,mod.price,mod.amount,
		mod.amount_money,mtd.mat_type_code,mtd.mat_type_name,mod.inv_id,mod.inv_no,mom.store_id,hstd.store_name,
		mod.batch_no,mod.inva_date,hfd.fac_name,sup.sup_name,mid.agent_name,sup.cert_code,mid.bid_code
		from mat_out_detail mod
		left join mat_out_main mom on
		mod.group_id = mom.group_id
		and mod.hos_id = mom.hos_id
		and mod.copy_code = mom.copy_code
		and mod.out_id = mom.out_id
		and mod.out_no = mom.out_no
		left join mat_bus_type mbt on mom.bus_type_code = mbt.bus_type_code
		left join hos_dept_dict hdd on
		mom.group_id = hdd.group_id
		and mom.hos_id = hdd.hos_id
		and mom.dept_id = hdd.dept_id
		and mom.dept_no = hdd.dept_no
		left join mat_inv_dict mid on
		mod.group_id = mid.group_id
		and mod.hos_id = mid.hos_id
		and mod.copy_code = mid.copy_code
		and mod.inv_id = mid.inv_id
		and mod.inv_no = mid.inv_no
		left join hos_fac_dict hfd on mid.group_id = hfd.group_id
		and mid.hos_id = hfd.hos_id
		and mid.fac_id=hfd.fac_id
		and mid.fac_no=hfd.fac_no
		left join hos_unit hu on
		mid.group_id = hu.group_id
		and mid.hos_id = hu.hos_id
		and mid.unit_code = hu.unit_code
		and hu.is_stop = 0
		left join mat_type_dict mtd on
		mid.group_id = mtd.group_id
		and mid.hos_id = mtd.hos_id
		and mid.copy_code = mtd.copy_code
		and mid.mat_type_id = mtd.mat_type_id
		and mid.mat_type_no = mtd.mat_type_no
		left join hos_store_dict hstd
		on hstd.group_id=mom.group_id
		and hstd.hos_id=mom.hos_id
		and hstd.store_id=mom.store_id
		and hstd.is_stop=0
		and hstd.is_mat=1
		left join (
		select distinct
		mind.group_id,mind.hos_id,mind.copy_code,
		mind.inv_id,mind.batch_sn,mind.batch_no,
		mind.bar_code,mind.price,hsud.sup_name,hsud.sup_id,mind.cert_code
		from mat_in_main mim
		left join mat_in_detail mind
		on mind.group_id=mim.group_id
		and mind.hos_id=mim.hos_id
		and mind.copy_code=mim.copy_code
		and mind.in_id=mim.in_id
		left join mat_prod_cert mic
		on mic.group_id = mind.group_id
		and mic.hos_id = mind.hos_id
		and mic.copy_code = mind.copy_code
		and mic.cert_id = mind.cert_id
		and mic.check_state = 2
		left join hos_sup_dict hsud
		on hsud.group_id=mim.group_id
		and hsud.hos_id=mim.hos_id
		and hsud.sup_id=mim.sup_id
		and hsud.sup_no=mim.sup_no
		where mim.bus_type_code in (1,2)
		) sup
		on sup.group_id=mod.group_id
		and sup.hos_id=mod.hos_id
		and sup.copy_code=mod.copy_code
		and sup.inv_id=mod.inv_id
		and sup.batch_no=mod.batch_no
		and sup.batch_sn=mod.batch_sn
		and sup.bar_code=mod.bar_code
		and sup.price=mod.price
		left join mat_tran_rela mtr
		on mom.group_id=mtr.group_id
		and mom.hos_id=mtr.hos_id
		and mom.copy_code=mtr.copy_code
		and mom.out_id=mtr.out_id


		left join mat_in_main mim
		on mim.group_id=mtr.group_id
		and mim.hos_id=mtr.hos_id
		and mim.copy_code=mtr.copy_code
		and mim.in_id=mtr.in_id
		left join hos_store_dict out_store
		on out_store.group_id=mim.group_id
		and out_store.hos_id=mim.hos_id
		and out_store.store_id=mim.store_id
		and out_store.is_stop=0

		<where>
			and mom.state=3
			<if test="agent_name!=null and agent_name!=''">
				and mid.agent_name like '%${agent_name}%'
			</if>
			<if test="sup_id!=null and sup_id!=''">
				and sup.sup_id=#{sup_id}
			</if>
			<if test="group_id != null and group_id != ''">
				and mom.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and mom.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != '' ">
				and mom.copy_code = #{copy_code}
			</if>
			<if
				test="begin_confirm_date != null and begin_confirm_date != '' and end_confirm_date != null and end_confirm_date != '' ">
				and mom.confirm_date between
				to_date(#{begin_confirm_date},'yyyy/MM/dd') and
				to_date(#{end_confirm_date},'yyyy/MM/dd')
			</if>
			<if
				test="begin_out_date != null and begin_out_date != '' and end_out_date != null and end_out_date != '' ">
				and mom.out_date between
				to_date(#{begin_out_date},'yyyy/MM/dd') and
				to_date(#{end_out_date},'yyyy/MM/dd')
			</if>
			<if test="store_id != null and store_id != '' ">
				and mom.store_id = #{store_id}
			</if>
			<if test="store_id == null or store_id == '' ">
				and to_char(mom.store_id) in (
				select perm_code from v_user_data_perm
				where group_id = ${group_id}
				and hos_id = ${hos_id} and user_id = ${user_id}
				and table_code = 'HOS_STORE_DICT'
				and is_read = 1 and is_write = 1
				)
			</if>
			<if test="store_no != null and store_no != '' ">
				and mom.store_no = #{store_no}
			</if>
			<if test="mat_type_code != null and mat_type_code != '' ">
				and mtd.mat_type_code like '${mat_type_code}%'
			</if>
			<!-- <if test="mat_type_id != null and mat_type_id != '' "> and mtd.mat_type_id 
				= #{mat_type_id} </if> <if test="mat_type_no != null and mat_type_no != '' 
				"> and mtd.mat_type_no = #{mat_type_no} </if> -->
			<if test="mat_type_id == null or mat_type_id == ''">
				and to_char(mtd.mat_type_id) in (
				select perm_code from v_user_data_perm
				where group_id = #{group_id,jdbcType=INTEGER}
				and hos_id = #{hos_id,jdbcType=INTEGER}
				and table_code = 'MAT_TYPE_DICT'
				and user_id = #{user_id,jdbcType=INTEGER}
				and is_read = 1 and is_write = 1
				)
			</if>
			<if test="dept_id == '00' ">
				and (to_char(mom.dept_id) in ( select perm_code from v_user_data_perm
				where group_id = ${group_id}
				and hos_id = ${hos_id} and user_id = ${user_id} and table_code =
				'HOS_DEPT_DICT'
				and is_read = 1 and is_write = 1)
				or mom.dept_id is null -- dept_id为空 ,意味是调拨单
				)
			</if>
			<if test="dept_id != null and dept_id != '' and dept_id != '00'">
				and mom.dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != '' and dept_id != '00'">
				and mom.dept_no = #{dept_no}
			</if>
			<if test="is_charge != null and is_charge != '' ">
				and mid.is_charge = #{is_charge}
			</if>
			<if test="inv_id != null and inv_id != '' ">
				and mod.inv_id = #{inv_id}
			</if>
			<if test="inv_no != null and inv_no != '' ">
				and mod.inv_no = #{inv_no}
			</if>
			<if test="out_no != null and out_no != '' ">
				AND (
				mom.out_no like '%${out_no}%'
				or upper(mid.inv_name) like '%${out_no}%'
				or upper(mid.inv_model) like '%${out_no}%'
				or upper(mid.spell_code) like '%${out_no}%'
				or upper(mid.wbx_code) like '%${out_no}%'
				or upper(mid.bid_code) like '%${out_no}%'
				or lower(mid.spell_code) like '%${out_no}%'
				or lower(mid.bid_code) like '%${out_no}%'
				or lower(mid.wbx_code) like '%${out_no}%'
				or lower(mid.inv_name) like '%${out_no}%'

				)
			</if>
			<if test="inv_model != null and inv_model != ''">
				and mid.inv_model like '%${inv_model}%'
			</if>

			<if test="inv_msg != null and inv_msg != '' ">
				and (
				mid.inv_id like '%${inv_msg}%'
				or mid.inv_code like '%${inv_msg}%'
				or
				upper(mid.inv_name) like '%${inv_msg}%'
				or upper(mid.inv_model) like
				'%${inv_msg}%'
				or upper(mid.spell_code) like '%${inv_msg}%'
				or
				upper(mid.wbx_code) like '%${inv_msg}%'
				or lower(mid.spell_code) like
				'%${inv_msg}%'
				or lower(mid.wbx_code) like '%${inv_msg}%'
				or
				lower(mid.inv_name) like '%${inv_msg}%'
				or lower(mid.inv_model) like
				'%${inv_msg}%'
				)
			</if>
			and mbt.bus_type_code = '15'
			<if
				test='set_or_store_id!=null and set_or_store_id!="" and set_or_store!=null and set_or_store=="1"'>
				and mom.store_id =#{set_or_store_id}
			</if>
			<if
				test='set_or_store_id!=null and set_or_store_id!="" and (set_or_store==null or set_or_store!="1")'>
				and mom.store_id in (
				select mss.store_id
				from mat_store_detail mss
				where mss.set_id=#{set_or_store_id}
				)
			</if>
		</where>
	</if>
	),
	temp as (
	select group_id,hos_id,copy_code,out_id,to_char(out_no)
	out_no,confirm_date,bus_type_code,bus_type_name,
	dept_code,dept_name,state,inv_code,inv_name,inv_model,unit_code,unit_name,price,amount,bid_code,
	amount_money,mat_type_code,mat_type_name,inv_id,inv_no,store_id,batch_no,inva_date,fac_name,store_name,sup_name,agent_name,cert_code
	from temp1
	order by confirm_date,out_no,out_id
	)
	select group_id,hos_id,copy_code,out_id,to_char(out_no)
	out_no,confirm_date,bus_type_code,bus_type_name,bid_code,
	dept_code,dept_name,state,inv_code,inv_name,inv_model,unit_code,unit_name,price,amount,
	amount_money,mat_type_code,mat_type_name,inv_id,inv_no,store_id,batch_no,inva_date,fac_name,store_name,sup_name,agent_name,cert_code
	from temp
	union all
	select null,null,null,null,'合计',null,null,null,null,
	null,null,null,null,null,null,null,null,null,sum(amount) as amount,
	sum(amount_money) amount_money,null,null,null,null,null, null, null,
	null,null,null,null,null
	from temp
</select>
	
	
	<select id="queryMatStorageOutInvCollection" parameterType="java.util.Map" resultMap="matOutDetailList">
		with temp1 as(
		<if test="bus_type_code!=null or  tran_code==null">
			select
		      mom.group_id,mom.hos_id,mom.copy_code,
		      <if test="is_agent ==1 ">
		      mid.agent_name,
		      </if>
		        <if test="is_dept ==1 " >
		      hdd.dept_code,
		   		</if>
		   	 <if test="is_dept ==1 ">
		      hdd.dept_name,
		      </if>
		      mid.inv_code,
		      mid.inv_name,mid.inv_model,hu.unit_code,
		      hu.unit_name,mod.price,sum(nvl(mod.amount,0)) amount,
		      sum(nvl(mod.amount_money,0)) amount_money,mtd.mat_type_code,mtd.mat_type_name,
		      mod.inv_id,<!-- mod.inv_no, -->mom.store_id,hstd.store_name,
		      hfd.fac_name
		       <if test="is_sup ==1 ">
		      ,sup.sup_name
		      </if>
		    from mat_out_detail mod
		    left join mat_out_main mom on
		      mod.group_id = mom.group_id
		      and mod.hos_id = mom.hos_id
		      and mod.copy_code = mom.copy_code
		      and mod.out_id = mom.out_id
		      and mod.out_no = mom.out_no
		    left join hos_dept_dict hdd on
		      mom.group_id = hdd.group_id
		      and mom.hos_id = hdd.hos_id
		      and mom.dept_id = hdd.dept_id
		      and mom.dept_no = hdd.dept_no
		    left join mat_inv_dict mid on
		      mod.group_id = mid.group_id
		      and mod.hos_id = mid.hos_id
		      and mod.copy_code = mid.copy_code
		      and mod.inv_id = mid.inv_id
		      and mod.inv_no = mid.inv_no
		    left join hos_fac_dict hfd on mid.group_id = hfd.group_id
		          and mid.hos_id = hfd.hos_id
		          and mid.fac_id=hfd.fac_id
		          and mid.fac_no=hfd.fac_no
		    left join hos_unit hu on
		      mid.group_id = hu.group_id
		      and mid.hos_id = hu.hos_id
		      and mid.unit_code = hu.unit_code
		      and hu.is_stop = 0
		    left join mat_type_dict mtd on
		      mid.group_id = mtd.group_id
		      and mid.hos_id = mtd.hos_id
		      and mid.copy_code = mtd.copy_code
		      and mid.mat_type_id = mtd.mat_type_id
		      and mid.mat_type_no = mtd.mat_type_no
		    left join hos_store_dict hstd
		      on hstd.group_id=mom.group_id
		      and hstd.hos_id=mom.hos_id
		      and hstd.store_id=mom.store_id
		      and hstd.is_stop=0
		      and hstd.is_mat=1
		    left join (
		       select distinct
		           mind.group_id,mind.hos_id,mind.copy_code,
		           mind.inv_id,mind.batch_sn,mind.batch_no,
		           mind.bar_code,mind.price,hsud.sup_name,hsud.sup_id
		       from mat_in_main mim
		       left join mat_in_detail mind
		       on mind.group_id=mim.group_id
		       and mind.hos_id=mim.hos_id
		       and mind.copy_code=mim.copy_code
		       and mind.in_id=mim.in_id
		       left join hos_sup_dict hsud
		       on hsud.group_id=mim.group_id
		       and hsud.hos_id=mim.hos_id
		       and hsud.sup_id=mim.sup_id
		       and hsud.sup_no=mim.sup_no
		     <!--   and hsud.is_stop=0 -->
		       where mim.bus_type_code in (1,2,8,10,22,47)
		    )  sup
		    on sup.group_id=mod.group_id
		    and sup.hos_id=mod.hos_id
		    and sup.copy_code=mod.copy_code
		    and sup.inv_id=mod.inv_id
		    and sup.batch_no=mod.batch_no
		    and sup.batch_sn=mod.batch_sn
		    and sup.bar_code=mod.bar_code
		    and sup.price=mod.price
			<where>
				and mom.state=3
				<if test="agent_name!=null and agent_name!=''">
					and mid.agent_name like '%${agent_name}%'
				</if>
			    <if test="sup_id!=null and sup_id!=''">
			    	and sup.sup_id=#{sup_id}
			    </if>
				<if test="group_id != null and group_id != ''">
					and mom.group_id = #{group_id}
				</if>
				<if test="hos_id != null and hos_id != ''">
					and mom.hos_id = #{hos_id}
				</if>
				<if test="copy_code != null and copy_code != '' ">
					and mom.copy_code = #{copy_code}
				</if>
				<if
					test="begin_confirm_date != null and begin_confirm_date != '' and end_confirm_date != null and end_confirm_date != '' ">
					and mom.confirm_date between
					to_date(#{begin_confirm_date},'yyyy/MM/dd') and
					to_date(#{end_confirm_date},'yyyy/MM/dd')
				</if>
				<if
					test="begin_out_date != null and begin_out_date != '' and end_out_date != null and end_out_date != '' ">
					and mom.out_date between
					to_date(#{begin_out_date},'yyyy/MM/dd') and
					to_date(#{end_out_date},'yyyy/MM/dd')
				</if>
				<if test="store_id != null and store_id != '' ">
					and mom.store_id = #{store_id}
				</if>
				<if test="store_id == null or store_id == '' ">
					and to_char(mom.store_id) in (
						select perm_code from v_user_data_perm
						where group_id = ${group_id}
							and hos_id = ${hos_id} and user_id = ${user_id} 
							and table_code = 'HOS_STORE_DICT'
							and is_read = 1  and is_write = 1
					 )
				</if>
				<if test="store_no != null and store_no != '' ">
					and mom.store_no = #{store_no}
				</if>
				<if test="mat_type_code != null and mat_type_code != '' ">
					and mtd.mat_type_code like '${mat_type_code}%'
				</if>
				<!--  <if test="mat_type_id != null and mat_type_id != '' ">
					and mtd.mat_type_id = #{mat_type_id}
				</if>
				<if test="mat_type_no != null and mat_type_no != '' ">
					and mtd.mat_type_no = #{mat_type_no}
				</if>-->
				<if test="mat_type_id == null or mat_type_id == ''">
					and to_char(mtd.mat_type_id) in (
						select perm_code from v_user_data_perm  
						where group_id = #{group_id,jdbcType=INTEGER}
							and hos_id = #{hos_id,jdbcType=INTEGER}
							and table_code = 'MAT_TYPE_DICT'
							and user_id = #{user_id,jdbcType=INTEGER}
							and is_read = 1 and is_write = 1 
					)
				</if>
				<if test="dept_id == '00' ">
					and to_char(mom.dept_id) in ( select perm_code from v_user_data_perm
					where group_id = ${group_id}
					and hos_id = ${hos_id} and user_id = ${user_id} and table_code =
					'HOS_DEPT_DICT'
					and is_read = 1 and is_write = 1)
				</if>
				<if test="dept_id != null and dept_id != '' and dept_id != '00'">
					and mom.dept_id = #{dept_id}
				</if>
				<if test="dept_no != null and dept_no != '' and dept_id != '00'">
					and mom.dept_no = #{dept_no}
				</if>
				<if test="is_charge != null and is_charge != '' ">
					and mid.is_charge = #{is_charge}
				</if>
				<if test="inv_id != null and inv_id != '' ">
					and mod.inv_id = #{inv_id}
				</if>
				<if test="inv_no != null and inv_no != '' ">
					and mod.inv_no = #{inv_no}
				</if>
				<if test="out_no != null and out_no != '' ">
					AND (
								 mom.out_no like '%${out_no}%'
								or upper(mid.inv_name) like '%${out_no}%'
								or upper(mid.inv_model) like '%${out_no}%'
								or upper(mid.spell_code) like '%${out_no}%'
								or upper(mid.wbx_code) like '%${out_no}%'
								or upper(mid.bid_code) like '%${out_no}%'
								or lower(mid.spell_code) like '%${out_no}%'
								or lower(mid.bid_code) like '%${out_no}%'
								or lower(mid.wbx_code) like '%${out_no}%'
								or lower(mid.inv_name) like '%${out_no}%'
							
						)
				</if>
				<if test="inv_model != null and inv_model != ''">
						and mid.inv_model like '%${inv_model}%'
				</if>
				
				<if test="inv_msg != null and inv_msg != '' ">
					and (
						 mid.inv_id like '%${inv_msg}%'
				or mid.inv_code like '%${inv_msg}%'
				or upper(mid.inv_name) like '%${inv_msg}%'
				or upper(mid.inv_model) like '%${inv_msg}%'
				or upper(mid.spell_code) like '%${inv_msg}%'
				or upper(mid.wbx_code) like '%${inv_msg}%'
				or lower(mid.spell_code) like '%${inv_msg}%'
				or lower(mid.wbx_code) like '%${inv_msg}%'
				or lower(mid.inv_name) like '%${inv_msg}%'
				or lower(mid.inv_model) like '%${inv_msg}%'
					)
				</if> 
				<if test="bus_type_code != null and bus_type_code != '' ">
					and mom.bus_type_code in  (${bus_type_code})
				</if>
				<if test="bus_type_code == null or bus_type_code == '' ">
					and mom.bus_type_code in (3, 21, 9,11,13,23,49,50,19)
				</if>
				<if test='set_or_store_id!=null and set_or_store_id!="" and set_or_store!=null and set_or_store=="1"'>
					and mom.store_id =#{set_or_store_id}
				</if>
				<if test='set_or_store_id!=null and set_or_store_id!="" and (set_or_store==null or set_or_store!="1")'>
					and mom.store_id in (
						select mss.store_id
						from mat_store_detail mss
						where mss.set_id=#{set_or_store_id}
					)
				</if>
			</where>
			group by
			  mom.group_id,mom.hos_id,mom.copy_code,
		      <if test="is_dept ==1  ">
		        hdd.dept_code,
		      </if> 
		        <if test="is_dept ==1 ">
		        hdd.dept_name,
		        
		        </if>
		        mid.inv_code,
		      mid.inv_name,mid.inv_model,hu.unit_code,
		      hu.unit_name,mod.price,mtd.mat_type_code,mtd.mat_type_name,
		      mod.inv_id<!-- ,mod.inv_no -->,mom.store_id,hstd.store_name,
		      hfd.fac_name
		       <if test="is_sup ==1 ">
		      ,sup.sup_name
		      </if>
		        <if test="is_agent ==1 ">
		      ,mid.agent_name
		      </if>
		</if>
		<if test="(bus_type_code==null and  tran_code==null) or (bus_type_code!=null and  tran_code!=null)">
		   union all
		</if>
		<if test="bus_type_code==null or tran_code!=null">
				select
		      mom.group_id,mom.hos_id,mom.copy_code,
		        <if test="is_agent==1 ">
		      mid.agent_name,
		      </if>
		        <if test="is_dept ==1">
		      out_store.store_code as dept_code,
		      
		      </if>
		        <if test="is_dept ==1">
		      out_store.store_name as dept_name,
		      </if>
		      mid.inv_code,
		      mid.inv_name,mid.inv_model,hu.unit_code,
		      hu.unit_name,mod.price,sum(nvl(mod.amount,0)) amount,
		      sum(nvl(mod.amount_money,0)) amount_money,mtd.mat_type_code,mtd.mat_type_name,
		      mod.inv_id,<!-- mod.inv_no, -->mom.store_id,hstd.store_name,
		      hfd.fac_name
		       <if test="is_sup ==1 ">
		      ,sup.sup_name
		      </if>
		    from mat_out_detail mod
		    left join mat_out_main mom on
		      mod.group_id = mom.group_id
		      and mod.hos_id = mom.hos_id
		      and mod.copy_code = mom.copy_code
		      and mod.out_id = mom.out_id
		      and mod.out_no = mom.out_no
		    left join hos_dept_dict hdd on
		      mom.group_id = hdd.group_id
		      and mom.hos_id = hdd.hos_id
		      and mom.dept_id = hdd.dept_id
		      and mom.dept_no = hdd.dept_no
		    left join mat_inv_dict mid on
		      mod.group_id = mid.group_id
		      and mod.hos_id = mid.hos_id
		      and mod.copy_code = mid.copy_code
		      and mod.inv_id = mid.inv_id
		      and mod.inv_no = mid.inv_no
		    left join hos_fac_dict hfd on mid.group_id = hfd.group_id
		          and mid.hos_id = hfd.hos_id
		          and mid.fac_id=hfd.fac_id
		          and mid.fac_no=hfd.fac_no
		    left join hos_unit hu on
		      mid.group_id = hu.group_id
		      and mid.hos_id = hu.hos_id
		      and mid.unit_code = hu.unit_code
		      and hu.is_stop = 0
		    left join mat_type_dict mtd on
		      mid.group_id = mtd.group_id
		      and mid.hos_id = mtd.hos_id
		      and mid.copy_code = mtd.copy_code
		      and mid.mat_type_id = mtd.mat_type_id
		      and mid.mat_type_no = mtd.mat_type_no
		    left join hos_store_dict hstd
		      on hstd.group_id=mom.group_id
		      and hstd.hos_id=mom.hos_id
		      and hstd.store_id=mom.store_id
		      and hstd.is_stop=0
		      and hstd.is_mat=1
		    left join (
		       select distinct
		           mind.group_id,mind.hos_id,mind.copy_code,
		           mind.inv_id,mind.batch_sn,mind.batch_no,
		           mind.bar_code,mind.price,hsud.sup_name,hsud.sup_id
		       from mat_in_main mim
		       left join mat_in_detail mind
		       on mind.group_id=mim.group_id
		       and mind.hos_id=mim.hos_id
		       and mind.copy_code=mim.copy_code
		       and mind.in_id=mim.in_id
		       left join hos_sup_dict hsud
		       on hsud.group_id=mim.group_id
		       and hsud.hos_id=mim.hos_id
		       and hsud.sup_id=mim.sup_id
		       and hsud.sup_no=mim.sup_no
		      <!--  and hsud.is_stop=0 -->
		       where mim.bus_type_code in (1,2,8,10,22,47)
		    )  sup
		     on sup.group_id=mod.group_id
		    and sup.hos_id=mod.hos_id
		    and sup.copy_code=mod.copy_code
		    and sup.inv_id=mod.inv_id
		    and sup.batch_no=mod.batch_no
		    and sup.batch_sn=mod.batch_sn
		    and sup.bar_code=mod.bar_code
		    and sup.price=mod.price
		    left join mat_tran_rela mtr 
	        on mom.group_id = mtr.group_id
			and mom.hos_id = mtr.hos_id
			and mom.copy_code = mtr.copy_code
			and mom.out_id = mtr.out_id 
	        left join mat_in_main mim
	        on mim.group_id=mtr.group_id
	        and mim.hos_id=mtr.hos_id
	        and mim.copy_code=mtr.copy_code
	        and mim.in_id=mtr.in_id
	        left join hos_store_dict  out_store
	        on out_store.group_id=mim.group_id
	        and out_store.hos_id=mim.hos_id
	        and out_store.store_id=mim.store_id
	        and out_store.is_stop=0
		    
		    
		   
			<where>
				and mom.state=3
				<if test="agent_name!=null and agent_name!=''">
					and mid.agent_name like '%${agent_name}%'
				</if>
			    <if test="sup_id!=null and sup_id!=''">
			    	and sup.sup_id=#{sup_id}
			    </if>
				<if test="group_id != null and group_id != ''">
					and mom.group_id = #{group_id}
				</if>
				<if test="hos_id != null and hos_id != ''">
					and mom.hos_id = #{hos_id}
				</if>
				<if test="copy_code != null and copy_code != '' ">
					and mom.copy_code = #{copy_code}
				</if>
				<if
					test="begin_confirm_date != null and begin_confirm_date != '' and end_confirm_date != null and end_confirm_date != '' ">
					and mom.confirm_date between
					to_date(#{begin_confirm_date},'yyyy/MM/dd') and
					to_date(#{end_confirm_date},'yyyy/MM/dd')
				</if>
				<if
					test="begin_out_date != null and begin_out_date != '' and end_out_date != null and end_out_date != '' ">
					and mom.out_date between
					to_date(#{begin_out_date},'yyyy/MM/dd') and
					to_date(#{end_out_date},'yyyy/MM/dd')
				</if>
				<if test="store_id != null and store_id != '' ">
					and mom.store_id = #{store_id}
				</if>
				<if test="store_id == null or store_id == '' ">
					and to_char(mom.store_id) in (
						select perm_code from v_user_data_perm
						where group_id = ${group_id}
							and hos_id = ${hos_id} and user_id = ${user_id} 
							and table_code = 'HOS_STORE_DICT'
							and is_read = 1  and is_write = 1
					 )
				</if>
				<if test="store_no != null and store_no != '' ">
					and mom.store_no = #{store_no}
				</if>
				<if test="mat_type_code != null and mat_type_code != '' ">
					and mtd.mat_type_code like '${mat_type_code}%'
				</if>
				<!--  <if test="mat_type_id != null and mat_type_id != '' ">
					and mtd.mat_type_id = #{mat_type_id}
				</if>
				<if test="mat_type_no != null and mat_type_no != '' ">
					and mtd.mat_type_no = #{mat_type_no}
				</if>-->
				<if test="mat_type_id == null or mat_type_id == ''">
					and to_char(mtd.mat_type_id) in (
						select perm_code from v_user_data_perm  
						where group_id = #{group_id,jdbcType=INTEGER}
							and hos_id = #{hos_id,jdbcType=INTEGER}
							and table_code = 'MAT_TYPE_DICT'
							and user_id = #{user_id,jdbcType=INTEGER}
							and is_read = 1 and is_write = 1 
					)
				</if>
				<if test="dept_id == '00' ">
					and to_char(mom.dept_id) in ( select perm_code from v_user_data_perm
					where group_id = ${group_id}
					and hos_id = ${hos_id} and user_id = ${user_id} and table_code =
					'HOS_DEPT_DICT'
					and is_read = 1 and is_write = 1)
				</if>
				<if test="dept_id != null and dept_id != '' and dept_id != '00'">
					and mom.dept_id = #{dept_id}
				</if>
				<if test="dept_no != null and dept_no != '' and dept_id != '00'">
					and mom.dept_no = #{dept_no}
				</if>
				<if test="is_charge != null and is_charge != '' ">
					and mid.is_charge = #{is_charge}
				</if>
				<if test="inv_id != null and inv_id != '' ">
					and mod.inv_id = #{inv_id}
				</if>
				<if test="inv_no != null and inv_no != '' ">
					and mod.inv_no = #{inv_no}
				</if>
				<if test="out_no != null and out_no != '' ">
					AND (
								 mom.out_no like '%${out_no}%'
								or upper(mid.inv_name) like '%${out_no}%'
								or upper(mid.inv_model) like '%${out_no}%'
								or upper(mid.spell_code) like '%${out_no}%'
								or upper(mid.wbx_code) like '%${out_no}%'
								or upper(mid.bid_code) like '%${out_no}%'
								or lower(mid.spell_code) like '%${out_no}%'
								or lower(mid.bid_code) like '%${out_no}%'
								or lower(mid.wbx_code) like '%${out_no}%'
								or lower(mid.inv_name) like '%${out_no}%'
							
						)
				</if>
				<if test="inv_model != null and inv_model != ''">
						and mid.inv_model like '%${inv_model}%'
				</if>
				
				<if test="inv_msg != null and inv_msg != '' ">
					and (
						 mid.inv_id like '%${inv_msg}%'
				or mid.inv_code like '%${inv_msg}%'
				or upper(mid.inv_name) like '%${inv_msg}%'
				or upper(mid.inv_model) like '%${inv_msg}%'
				or upper(mid.spell_code) like '%${inv_msg}%'
				or upper(mid.wbx_code) like '%${inv_msg}%'
				or lower(mid.spell_code) like '%${inv_msg}%'
				or lower(mid.wbx_code) like '%${inv_msg}%'
				or lower(mid.inv_name) like '%${inv_msg}%'
				or lower(mid.inv_model) like '%${inv_msg}%'
					)
				</if> 
				
			    and mom.bus_type_code ='15'
				
				<if test='set_or_store_id!=null and set_or_store_id!="" and set_or_store!=null and set_or_store=="1"'>
					and mom.store_id =#{set_or_store_id}
				</if>
				<if test='set_or_store_id!=null and set_or_store_id!="" and (set_or_store==null or set_or_store!="1")'>
					and mom.store_id in (
						select mss.store_id
						from mat_store_detail mss
						where mss.set_id=#{set_or_store_id}
					)
				</if>
			</where>
			group by
			  mom.group_id,mom.hos_id,mom.copy_code,
			    <if test="is_dept ==1 ">
		      out_store.store_code,
		      </if>
		        <if test="is_dept ==1  ">
		      out_store.store_name,
		      </if>
		      mid.inv_code,
		      mid.inv_name,mid.inv_model,hu.unit_code,
		      hu.unit_name,mod.price,mtd.mat_type_code,mtd.mat_type_name,
		      mod.inv_id,<!-- mod.inv_no, -->mom.store_id,hstd.store_name,
		      hfd.fac_name
		      
		        <if test="is_sup ==1 ">
		        ,sup.sup_name</if>
		        <if test="is_agent ==1  ">
		      ,mid.agent_name
		      </if>
		</if>
		  
		),
		temp as (
			select 
		      group_id,hos_id,copy_code,
		        <if test="is_dept ==1  ">
		      dept_code,dept_name,
		      </if>
		      inv_code,inv_name,inv_model,unit_code,unit_name,
		      price,mat_type_code,mat_type_name,inv_id,<!-- inv_no, -->
		      store_id,store_name,fac_name,
		      
		      <if test="is_sup ==1 "> sup_name,
		      </if>
		      amount,amount_money
		        <if test="is_agent ==1 ">
		      ,agent_name
		      </if>
			from temp1
			order by store_name,mat_type_code,inv_name
		)
		select 
	      group_id,hos_id,copy_code,
	        <if test="is_dept ==1 ">
	      dept_code,dept_name,
	      </if>
	      inv_code,inv_name,inv_model,unit_code,unit_name,
	      price,mat_type_code, to_char(mat_type_name) as mat_type_name,inv_id,<!-- inv_no, -->
	      store_id,store_name,fac_name,
	        <if test="is_sup ==1 "> sup_name,</if>
	        
	        amount,amount_money
	        <if test="is_agent ==1  ">
	        ,agent_name
	        </if>
		from temp
		union all
		select 
		    null,null,null,
		      <if test="is_dept ==1  ">
		    null,null,
		    </if>
		    null,null,null,null,null,
			null,null,'合计',null,<!-- null, -->
			null,null,null, 
			 <if test="is_sup ==1 ">
			  null,</if>
			sum(amount),sum(amount_money)
			 <if test="is_agent ==1  ">
			,null
			  </if>
		from temp
	</select>
	

	<!-- 2016/12/19 lxj 查询出库单供应商信息 -->
	<select id="queryMatOutSupMessage" parameterType="java.util.Map" resultMap="matOutDetailList">
		with temp as(
			select mid.inv_id,mid.inv_no,mid.in_no,mim.in_date,hsd.sup_name,mod.amount,mod.price,mod.amount_money
			from mat_out_detail mod
			left join mat_in_detail mid on mod.group_id = mid.group_id
				and mod.hos_id = mid.hos_id
				and mod.copy_code = mid.copy_code
				and mod.inv_id = mid.inv_id
				and mod.batch_no = mid.batch_no
				and mod.batch_sn = mid.batch_sn
				and mod.bar_code = mid.bar_code
			left join mat_in_main mim on  mid.group_id = mim.group_id
				and mid.hos_id = mim.hos_id
				and mid.copy_code = mim.copy_code
				and mid.in_id = mim.in_id
			left join hos_sup_dict hsd on  mim.group_id = hsd.group_id
				and mim.hos_id = hsd.hos_id
				and mim.sup_id = hsd.sup_id
				<if test="show_history == 1">
					and mim.sup_no = hsd.sup_no
				</if>
				<if test="show_history == 0">
					and hsd.is_stop = 0
				</if>
			where mod.group_id = #{group_id,jdbcType=INTEGER}
				and mod.hos_id = #{hos_id,jdbcType=INTEGER}
				and mod.copy_code = #{copy_code,jdbcType=VARCHAR}
				and mod.out_id = #{out_id,jdbcType=INTEGER}
				and mod.inv_id = #{inv_id,jdbcType=INTEGER}
				and mim.bus_type_code in ('10','12','16','22')
				and <![CDATA[ mid.amount_money < 0 ]]>
				and mim.store_id = #{store_id,jdbcType=INTEGER}
		 )
		select inv_id,inv_no,to_char(in_no) in_no,in_date,sup_name ,amount,price,amount_money
		from temp
		union all
		select null,null,to_char('合计'),null,null, sum(amount) as amount,null,sum(amount_money) as amount_money
		from temp

	</select>
	<select id="queryDetailForCopy" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT a.group_id, a.hos_id, a.copy_code, a.inv_id, a.inv_no, b.inv_code, b.inv_name, a.batch_no, a.price,
			a.bar_code, sum(nvl(a.amount, 0)) amount, nvl(a.sale_price, 0) sale_price,
			sum(nvl(a.sale_money,0)) as sale_money, nvl(a.sell_price, 0) sell_price, sum(nvl(a.sell_money, 0)) sell_money,
			nvl(a.allot_price, 0) allot_price, sum(nvl(a.allot_money, 0)) allot_money, sum(nvl(a.amount_money, 0)) amount_money,
			a.inva_date, a.disinfect_date, a.location_id, a.note
		FROM MAT_OUT_DETAIL a
		LEFT JOIN MAT_INV_DICT b ON a.group_id = b.group_id AND a.hos_id = b.hos_id
			AND a.copy_code = b.copy_code AND a.inv_id = b.inv_id
			AND b.is_stop = 0
		WHERE a.group_id = #{group_id,jdbcType=INTEGER}
			AND a.hos_id = #{hos_id,jdbcType=INTEGER}
			AND a.copy_code = #{copy_code,jdbcType=VARCHAR}
			AND a.out_id = #{out_id,jdbcType=INTEGER}
		GROUP BY a.group_id, a.hos_id, a.copy_code, a.inv_id, a.inv_no, b.inv_code, b.inv_name, a.batch_no,
			a.price, a.bar_code, a.sale_price, a.sell_price, a.allot_price, a.inva_date, a.disinfect_date,
			a.location_id, a.note
		ORDER BY a.inv_id
	</select>

	<!-- 合并冲账查询勾选单据 -->
	<select id="mergeOffsetMatOutMainOld" parameterType="java.util.Map" resultType="java.util.TreeMap">

		WITH tmp_imme AS (
			SELECT inv_id, batch_no, bar_code, price, SUM(amount) AS amount
			FROM (
				SELECT inv_id, batch_no, bar_code, price, SUM(nvl(amount,0)) AS amount
				FROM mat_out_main mom
				LEFT JOIN mat_out_detail matod ON mom.group_id = matod.group_id
					AND mom.hos_id = matod.hos_id
					AND mom.copy_code = matod.copy_code
					AND mom.out_id = matod.out_id
				where matod.group_id = #{group_id,jdbcType=INTEGER}
					AND matod.hos_id = #{hos_id,jdbcType=INTEGER}
					AND matod.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND mom.store_id = #{store_id,jdbcType=INTEGER}
					<![CDATA[
						AND mom.state < 3 
						AND mom.bus_type_code <> '21'
						AND matod.amount_money > 0
					]]>
				GROUP BY inv_id, batch_no, bar_code, price
				UNION ALL
				SELECT inv_id, batch_no, bar_code, price, -1 * SUM(nvl(amount, 0)) AS amount
				FROM mat_in_main mim
				LEFT JOIN mat_in_detail matid ON mim.group_id = matid.group_id
					AND mim.hos_id = matid.hos_id
					AND mim.copy_code =matid.copy_code
					AND mim.in_id = matid.in_id
				where matid.group_id = #{group_id,jdbcType=INTEGER}
					AND matid.hos_id = #{hos_id,jdbcType=INTEGER}
					AND matid.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND mim.store_id = #{store_id,jdbcType=INTEGER} 
					<![CDATA[ 
					AND mim.state < 3 
					AND mim.bus_type_code in ('10','12','16','22') 
					AND matid.amount_money < 0
					]]>
				GROUP BY inv_id, batch_no, bar_code, price
		   ) GROUP BY inv_id, batch_no, bar_code, price
			ORDER BY inv_id ASC
		),tem_left_amount as (
			select inv_id,batch_no, bar_code, price, sum(left_amount) left_amount
			from mat_fifo_balance
			where group_id = #{group_id,jdbcType=INTEGER}
				AND hos_id = #{hos_id,jdbcType=INTEGER}
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
				AND store_id = #{store_id,jdbcType=INTEGER}
			group by inv_id, batch_no, bar_code,price
	    ),tem_detail as(
	    select main.group_id,
			main.hos_id,
			main.copy_code,
			main.inv_id,
			main.batch_no,
			main.batch_sn,
			main.bar_code,
			main.price,
			main.sale_price,
			main.sell_price,
			main.inva_date,
			main.disinfect_date,
			main.location_id,
			sum(main.amount) amount
		from mat_out_detail main
		WHERE main.group_id = #{group_id,jdbcType=INTEGER} AND main.hos_id =
		#{hos_id,jdbcType=INTEGER} AND main.copy_code =
		#{copy_code,jdbcType=VARCHAR} AND main.out_id in ${out_ids}
		GROUP BY main.group_id,
			main.hos_id,
			main.copy_code,
			main.inv_id,
			main.batch_no,
			main.batch_sn,
			main.bar_code,
			main.price,
			main.sale_price,
			main.sell_price,
			main.inva_date,
			main.disinfect_date,
			main.location_id
		)

		SELECT main.inv_id, mid.inv_no, mid.inv_code, mid.inv_name,
			mtd.mat_type_name, mid.inv_model, hu.unit_name, main.batch_no,
			main.bar_code, main.price, main.sale_price, main.sell_price,
			main.inva_date, main.disinfect_date, hfd.fac_name, main.location_id,
			mld.location_code, mld.location_name, left_amount cur_amount,
			imme_amount, -main.amount AS amount, - (main.amount * main.price) AS
			amount_money, - (main.amount * main.sale_price) AS sale_money, -
			(main.amount * main.sell_price) AS sell_money, -main.amount AS
			sum_amount, '[' || to_char(WM_CONCAT('{"inv_id":' || main.inv_id ||
			',"inv_code":"' || to_char(mid.inv_code) || '","inv_name":"' ||
			to_char(mid.inv_name) || '","batch_sn":' || main.batch_sn ||
			',"cur_amount":' || left_amount || ',"imme_amount":' || imme_amount ||
			',"amount":' ||-main.amount || ',"price":' || main.price ||
			',"amount_money":' || - (main.amount* main.price) || ',"sale_price":'|| main.sale_price ||
			',"sale_money":' || - (main.amount *main.sale_price) ||',"sell_price":' || main.sell_price ||
			',"sell_money":' || - (main.amount * main.sell_price) || '}')) || ']' AS inv_detail_data
		FROM tem_detail main
		LEFT JOIN mat_inv_dict mid ON
			main.group_id = mid.group_id AND main.hos_id = mid.hos_id AND
			main.copy_code = mid.copy_code AND main.inv_id = mid.inv_id AND
			mid.is_stop = 0
		LEFT JOIN mat_type_dict mtd ON main.group_id = mtd.group_id AND main.hos_id = mtd.hos_id AND
			main.copy_code = mtd.copy_code AND mid.mat_type_id = mtd.mat_type_id
			AND mtd.is_stop = 0
		LEFT JOIN hos_fac_dict hfd
			ON main.group_id = hfd.group_id AND
			main.hos_id = hfd.hos_id AND
			mid.fac_id = hfd.fac_id  and mid.fac_no=hfd.fac_no
		LEFT JOIN hos_unit hu
		ON main.group_id = hu.group_id AND main.hos_id =
		hu.hos_id AND
		mid.unit_code = hu.unit_code
		LEFT JOIN mat_location_dict
		mld
		ON main.group_id = mld.group_id AND main.hos_id = mld.hos_id AND
		main.copy_code = mld.copy_code AND main.location_id = mld.location_id
		AND mld.is_stop = 0

		left join (select a.*, a.left_amount -
		nvl(b.amount, 0) imme_amount
		from tem_left_amount a
		left join tmp_imme b
		on a.inv_id = b.inv_id
		and a.batch_no = b.batch_no
		and a.bar_code =
		b.bar_code
		and a.price = b.price

		) t1
		on main.inv_id = t1.inv_id and
		main.batch_no = t1.batch_no and
		main.bar_code = t1.bar_code and
		main.price = t1.price

		GROUP BY main.inv_id, mid.inv_no, mid.inv_code, mid.inv_name,
		mtd.mat_type_name, mid.inv_model, hu.unit_name, main.batch_no,
		main.bar_code, main.price, main.sale_price, main.sell_price,
		main.inva_date, main.disinfect_date, hfd.fac_name, main.location_id,
		mld.location_code, mld.location_name, left_amount, imme_amount,
		main.amount

	</select>
	
	<select id="mergeOffsetMatOutMain" parameterType="java.util.Map" resultType="java.util.TreeMap">
		WITH tmp_imme AS(
			SELECT inv_id, batch_sn, batch_no, bar_code, SUM(amount) AS amount,price
			FROM v_mat_stock_imme
			WHERE group_id = #{group_id,jdbcType=INTEGER}
				AND hos_id = #{hos_id,jdbcType=INTEGER}
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
				AND store_id = #{store_id,jdbcType=INTEGER}
			GROUP BY inv_id, batch_sn, batch_no, bar_code,price
			ORDER BY inv_id ASC
		),
		tmp_detail AS(
			SELECT
				modet.group_id, modet.hos_id, modet.copy_code, modet.inv_id, modet.inv_no, modet.batch_no, 
				modet.bar_code, modet.batch_sn, modet.inva_date, modet.disinfect_date, modet.location_id, 
				modet.note, modet.price, (-1 * modet.amount) amount, (-1 * modet.amount_money) amount_money, 
				modet.sale_price, (-1 * modet.sale_money) sale_money, modet.sell_price, (-1 * modet.sell_money) sell_money, 
				modet.allot_price, (-1 * modet.allot_money) allot_money, mfb.left_amount AS cur_amount, 
				mfb.left_amount - nvl(imme.amount, 0) AS imme_amount
			FROM MAT_OUT_DETAIL modet
			LEFT JOIN mat_fifo_balance mfb
				ON modet.group_id = mfb.group_id
				AND modet.hos_id = mfb.hos_id
				AND modet.copy_code = mfb.copy_code
				AND modet.inv_id = mfb.inv_id
				AND modet.batch_sn = mfb.batch_sn
				AND modet.batch_no = mfb.batch_no
				AND modet.bar_code = mfb.bar_code
				and modet.price = mfb.price
				AND mfb.store_id = #{store_id,jdbcType=INTEGER}
			LEFT JOIN tmp_imme imme
				ON modet.inv_id = imme.inv_id
				AND modet.batch_sn = imme.batch_sn
				AND modet.batch_no = imme.batch_no
				AND modet.bar_code = imme.bar_code
			WHERE modet.group_id = #{group_id,jdbcType=INTEGER}
				AND modet.hos_id = #{hos_id,jdbcType=INTEGER}
				AND modet.copy_code = #{copy_code,jdbcType=VARCHAR}
				AND modet.out_id in ${out_ids}
			ORDER BY modet.out_detail_id ASC
		),
		tmp_main AS(
			SELECT main.group_id, main.hos_id, main.copy_code, main.inv_id, main.inv_no,
				main.batch_no, main.bar_code, main.inva_date, main.disinfect_date, main.location_id,
				main.note, main.price, main.amount, main.amount_money, main.sale_price, main.sale_money,
				main.sell_price, main.sell_money, main.allot_price, main.allot_money, 
				SUM(mfb.left_amount) AS cur_amount, SUM(mfb.left_amount) - main.out_amount AS imme_amount
			FROM (
				SELECT detail.*, nvl(imme.amount, 0) AS out_amount
				FROM (
					SELECT group_id, hos_id, copy_code, inv_id, inv_no, batch_no, bar_code, inva_date, disinfect_date, 
						location_id, note, price, SUM(amount) AS amount, SUM(amount_money) AS amount_money,
						sale_price, SUM(sale_money) AS sale_money, sell_price, SUM(sell_money) AS sell_money,
						allot_price, SUM(allot_money) AS allot_money
				FROM tmp_detail
				GROUP BY group_id, hos_id, copy_code, inv_id, inv_no, batch_no, bar_code, inva_date, 
					disinfect_date, location_id, note, price, sell_price, sale_price, allot_price
		) detail
		LEFT JOIN (
			SELECT inv_id, batch_no, bar_code, SUM(amount) AS amount,price
			FROM tmp_imme
			GROUP BY inv_id, batch_no, bar_code,price
		) imme
			ON detail.inv_id = imme.inv_id
			AND detail.batch_no = imme.batch_no
			AND detail.bar_code = imme.bar_code
		 	and detail.price = imme.price 
		) main
		LEFT JOIN mat_fifo_balance mfb
			ON main.group_id = mfb.group_id
			AND main.hos_id = mfb.hos_id
			AND main.copy_code = mfb.copy_code
			AND main.inv_id = mfb.inv_id
			AND main.batch_no = mfb.batch_no
			AND main.bar_code = mfb.bar_code
			AND mfb.store_id = #{store_id,jdbcType=INTEGER}
			and nvl(main.price,0) = nvl(mfb.price,0)
		GROUP BY main.group_id, main.hos_id, main.copy_code, main.inv_id, main.inv_no,
			main.batch_no, main.bar_code, main.inva_date, main.disinfect_date, main.location_id,
			main.note, main.price, main.amount, main.amount_money, main.sale_price, main.sale_money,
			main.sell_price, main.sell_money, main.allot_price, main.allot_money, main.out_amount
		)
		SELECT
			main.group_id, main.hos_id, main.copy_code,mid.bid_code, hfd.fac_name, main.inv_id,
			main.inv_no, main.batch_no, main.price, main.cur_amount, main.imme_amount, main.amount, 
			main.amount_money, main.sale_price, main.sale_money, main.sell_price, main.sell_money, main.allot_price,
			main.allot_money, main.bar_code, main.inva_date, main.disinfect_date, main.location_id, main.note, mid.inv_code,
			mid.inv_name, mid.inv_model, mid.unit_code, hu.unit_name, mld.location_code, mld.location_name,
			main.amount as sum_amount,
			'[' || to_char(WM_CONCAT('{"inv_id":' || detail.inv_id
				|| ',"inv_code":"' || to_char(mid.inv_code) || '","inv_name":"' || to_char(mid.inv_name)
				|| '","batch_sn":' || detail.batch_sn || ',"cur_amount":' || detail.cur_amount
				|| ',"imme_amount":' || detail.imme_amount || ',"amount":' || detail.amount
				|| ',"price":' || detail.price || ',"amount_money":' || detail.amount_money
				|| ',"sale_price":' || detail.sale_price || ',"sale_money":' || detail.sale_money
				|| ',"sell_price":' || detail.sell_price || ',"sell_money":' || detail.sell_money
				|| '}')) || ']' AS inv_detail_data
		FROM tmp_main main
		LEFT JOIN mat_inv_dict mid
			ON main.group_id = mid.group_id
			AND main.hos_id = mid.hos_id
			AND main.copy_code = mid.copy_code
			AND main.inv_id = mid.inv_id
			<if test="show_history == 1">
				AND main.inv_no = mid.inv_no
			</if>
			<if test="show_history == 0">
				AND mid.is_stop = 0
			</if>
		LEFT JOIN hos_unit hu
			ON mid.group_id = hu.group_id
			AND mid.hos_id = hu.hos_id
			AND mid.unit_code = hu.unit_code
		LEFT JOIN mat_location_dict mld
			ON main.group_id = mld.group_id
			AND main.hos_id = mld.hos_id
			AND main.copy_code = mld.copy_code
			AND main.location_id = mld.location_id
			AND mld.is_stop = 0
		LEFT JOIN tmp_detail detail
			ON main.inv_id = detail.inv_id
			AND main.batch_no = detail.batch_no
			AND main.bar_code = detail.bar_code
			AND main.price = detail.price
		left join hos_fac_dict hfd on hfd.group_id = mid.group_id
         	and hfd.hos_id = mid.hos_id
         	and hfd.fac_id = mid.fac_id
			and hfd.fac_no = mid.fac_no
		GROUP BY main.group_id, main.hos_id, main.copy_code,mid.bid_code, hfd.fac_name,
			main.inv_id, main.inv_no, main.batch_no, main.price, main.cur_amount, main.imme_amount, 
			main.amount, main.amount_money, main.sale_price, main.sale_money, main.sell_price, main.sell_money,
			main.allot_price, main.allot_money, main.bar_code, main.inva_date, main.disinfect_date, main.location_id, 
			main.note, mid.inv_code, mid.inv_name, mid.inv_model, mid.unit_code, hu.unit_name, mld.location_code, 
			mld.location_name, main.amount
		ORDER BY inv_detail_data
	</select>
	
	<!-- 查询对应关系表中的明细 -->
	<select id="queryMatApplyOutRela" parameterType="java.util.Map" resultType="java.util.Map">
		
		select t.group_id,t.hos_id,t.copy_code,t.rela_id,t.rela_detail_id
		from (
		      select a.group_id,a.hos_id,a.copy_code,a.rela_id,a.rela_detail_id
		      from  mat_apply_out_rela  a
		      join  (
		      	select group_id,hos_id,copy_code,out_id,out_detail_id
		      	from mat_out_detail 
		      	<where>
		      			group_id = #{group_id,jdbcType=INTEGER}
					AND hos_id = #{hos_id,jdbcType=INTEGER}
					AND copy_code = #{copy_code,jdbcType=VARCHAR}
					AND out_id = #{out_id,jdbcType=INTEGER}
		      	</where>
		      ) b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
		      	and a.rela_id=b.out_id
		      where a.rela_type=1
		      minus
		      select group_id,hos_id,to_char(copy_code) copy_code,out_id,out_detail_id
		      from mat_out_detail 
		      <where>
		      		group_id = #{group_id,jdbcType=INTEGER}
				AND hos_id = #{hos_id,jdbcType=INTEGER}
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
				AND out_id = #{out_id,jdbcType=INTEGER}
		      </where> 
		)t
		
	</select>
	
	<!-- 删除对应关系表中的明细 -->
	<delete id="deleteMatApplyOutRela" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			DELETE FROM mat_apply_out_rela
			<where>
				<if test="item.group_id != null ">
					AND group_id = #{item.group_id,jdbcType=INTEGER}
				</if>
				<if test="item.hos_id != null ">
					AND hos_id = #{item.hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
				</if>
				<if test="item.rela_id != null ">
					AND rela_id = #{item.rela_id,jdbcType=INTEGER}
				</if>
				<if test="item.rela_detail_id != null ">
					AND rela_detail_id = #{item.rela_detail_id,jdbcType=INTEGER}
				</if>
				and rela_type = 1
			</where>
		</foreach>
	</delete>
	
	<select id="queryMatOutMainIsApply" parameterType="java.util.List" resultType="Integer">
		select count(0) counts
		from mat_apply_out_rela
		<where>
			<if test="group_id != null and group_id !='' ">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id !='' ">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="out_id != null and out_id !='' ">
				AND rela_id = #{out_id,jdbcType=INTEGER}
			</if>
			and rela_type = 1
		</where>
	</select>
	
	<select id="queryMatOutDetailAmount" parameterType="java.util.Map" resultType="java.util.Map">
		select group_id,hos_id,copy_code,out_id,out_detail_id,amount
		from mat_out_detail
		<where>
				group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			AND out_id = #{out_id,jdbcType=INTEGER}
		</where>
	</select>
	
	
	
	<update id="updateMatApplyOutRela" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			UPDATE mat_apply_out_rela  set 
					<if test="item.amount != null ">
						rela_amount = #{item.amount,jdbcType=INTEGER}
					</if>
			<where>
				<if test="item.group_id != null and item.group_id != ''">
					and group_id = #{item.group_id,jdbcType=INTEGER}
				</if>
				<if test="item.hos_id != null and item.hos_id != ''">
					and hos_id = #{item.hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					and copy_code = #{item.copy_code,jdbcType=VARCHAR}
				</if>
				<if test="item.out_id != null and item.out_id != ''">
					and rela_id = #{item.out_id,jdbcType=INTEGER}
				</if>
				<if test="item.out_detail_id != null and item.out_detail_id != ''">
					and rela_detail_id = #{item.out_detail_id,jdbcType=INTEGER}
				</if>
				and rela_type = 1
			</where>
		</foreach>
	</update>
	
	
	<select id="queryInvOutDetail" parameterType="java.util.Map" resultMap="matOutDetailList">
	
	    with inv_msg as(
	        select
	          mid.group_id,mid.hos_id,mid.copy_code,         
	          midd.inv_id, mid.price,mid.batch_no,
	          mid.batch_sn, mid.bar_code    
	        from mat_in_detail mid
	        left join mat_in_main mim
	        on mim.group_id=mid.group_id
	        and mim.hos_id=mid.hos_id
	        and mim.copy_code=mid.copy_code
	        and mim.in_id=mid.in_id
	        left join mat_inv_dict midd
	        on midd.group_id=mid.group_id
	        and midd.hos_id=mid.hos_id
	        and midd.copy_code=mid.copy_code
	        and midd.inv_id=mid.inv_id
	        and midd.inv_no=mid.inv_no
	            
	          
	        <where>
	              mim.state = 3 <!-- 已确认的入库单  -->
		      and mim.bus_type_code <![CDATA[<>]]>14  <!-- 不包括 移入库  的业务类型  -->
	          <if test="group_id != null and group_id != ''">
	              and mim.group_id = #{group_id}
	            </if>
	            <if test="hos_id != null and hos_id != ''">
	              and mim.hos_id = #{hos_id}
	            </if>
	            <if test="copy_code != null and copy_code != ''">
	              and mim.copy_code = #{copy_code}
	            </if>
	            <if test="inv_id!=null and inv_id!=''">
	              and mid.inv_id=#{inv_id}
	            </if>
	            <if test="startDate != null and startDate != '' ">
	              and mim.confirm_date &gt;= to_date(#{startDate},'yyyy-MM-dd')
	            </if>
	            <if test="endDate != null and endDate != '' ">
	              and mim.confirm_date &lt;=to_date( #{endDate},'yyyy-MM-dd')
	          </if>
	          <if test="store_id != null and store_id != ''">
	          and mim.store_id = #{store_id}
	          </if>
	          <if test="store_no != null and store_no != ''">
	          and mim.store_no = #{store_no}
	          </if>
	          <if test="sup_id != null and sup_id != ''">
	           and mim.sup_id = #{sup_id}
	          </if>
	          <if test="sup_id == null or sup_id == ''">
	           and mim.sup_id is null
	          </if>
	          <if test="fac_id != null and fac_id != ''">
	           and midd.fac_id = #{fac_id}
	          </if>
	          <if test="bus_type_code != null and bus_type_code != ''">
	           and mim.bus_type_code=#{bus_type_code}
	          </if>
	          <if test="mat_type_code != null and mat_type_code != ''">
	           and midd.mat_type_id=#{mat_type_code}
	          </if>
	          <if test="batch_no != null and batch_no != ''">
	           and mid.batch_no like  '%${batch_no}%'
	          </if>
	         <if test="bus_type_code == null and bus_type_code == ''">
		     and to_char(mim.bus_type_code) in (
					select perm_code from v_user_data_perm  
					where group_id = #{group_id,jdbcType=INTEGER}
						and hos_id = #{hos_id,jdbcType=INTEGER}
						and table_code = 'MAT_BUS_TYPE'
						and user_id = #{user_id,jdbcType=INTEGER}
						and (is_read = 1 or is_write = 1) 
				)
		    </if>
		    <if test="mat_type_code != null and mat_type_code != ''">
		     and to_char(midd.mat_type_id) in (
					select perm_code from v_user_data_perm  
					where group_id = #{group_id,jdbcType=INTEGER}
						and hos_id = #{hos_id,jdbcType=INTEGER}
						and table_code = 'MAT_TYPE_DICT'
						and user_id = #{user_id,jdbcType=INTEGER}
						and (is_read = 1 or is_write = 1) 
				)
		    </if>
	        </where>
	        group by
	          mid.group_id,mid.hos_id,mid.copy_code,         
	          midd.inv_id, mid.price,mid.batch_no,
	          mid.batch_sn,mid.bar_code  
	      ),
		out_detail as (
		  select mom.out_no, mom.brief, hstd.store_name, hdd.dept_name, inv.inv_id
		    , midd.inv_code, midd.inv_name, hu.unit_name, midd.inv_model, inv.price
		    , sum(nvl(modd.amount, 0)) as amount
		    , sum(nvl(modd.amount_money, 0)) as amount_money
		    , inv.batch_no, inv.bar_code, hfd.fac_name, mom.out_date, mom.confirm_date
		    , m.user_name as maker, mbt.bus_type_name
		  from inv_msg inv
		  left join mat_out_detail modd on modd.group_id = inv.group_id
		  and modd.hos_id = inv.hos_id
		  and modd.copy_code = inv.copy_code
		  and modd.inv_id = inv.inv_id
		  and modd.batch_no = inv.batch_no
		  and modd.batch_sn = inv.batch_sn
		  and modd.price = inv.price
		  and modd.bar_code = inv.bar_code 
		  left join mat_out_main mom on mom.group_id = modd.group_id
		  and mom.hos_id = modd.hos_id
		  and mom.copy_code = modd.copy_code
		  and mom.out_id = modd.out_id 
		  left join mat_inv_dict midd on midd.group_id = modd.group_id
		  and midd.hos_id = modd.hos_id
		  and midd.copy_code = modd.copy_code
		  and midd.inv_id = modd.inv_id
		  and midd.inv_no = modd.inv_no 
		  left join hos_store_dict hstd on hstd.group_id = mom.group_id
		  and hstd.hos_id = mom.hos_id
		  and hstd.store_id = mom.store_id
		  and hstd.store_no = mom.store_no 
		  left join hos_dept_dict hdd on hdd.group_id = mom.group_id
		  and hdd.hos_id = mom.hos_id
		  and hdd.dept_id = mom.dept_id
		  and hdd.dept_no = mom.dept_no 
		  left join hos_unit hu on hu.group_id = midd.group_id
		  and hu.hos_id = midd.hos_id
		  and hu.unit_code = midd.unit_code
		  and hu.is_stop = 0 
		  left join hos_fac_dict hfd on hfd.group_id = midd.group_id
		  and hfd.hos_id = midd.hos_id
		  and hfd.fac_id = midd.fac_id
		  and hfd.fac_no = midd.fac_no 
		  left join sys_user m on m.group_id = mom.group_id
		  and m.hos_id = mom.hos_id
		  and m.copy_code = mom.copy_code
		  and m.user_id = mom.maker
		  and m.is_stop = 0 
		    left join mat_bus_type mbt on mbt.bus_type_code = mom.bus_type_code
		  and mbt.is_stop = 0 
		  where mom.bus_type_code <![CDATA[<>]]>  15 
		    and mom.state = 3
		  group by mom.out_no, mom.brief, hstd.store_name, hdd.dept_name, inv.inv_id, midd.inv_code, midd.inv_name, hu.unit_name, midd.inv_model, inv.price, inv.batch_no, inv.bar_code, hfd.fac_name, mom.out_date, mom.confirm_date, m.user_name, mbt.bus_type_name
		  order by mom.confirm_date, hstd.store_name, hdd.dept_name, hfd.fac_name
		)
		select 
		   out_no,brief,store_name,dept_name,
		   inv_id, inv_code,to_char(inv_name) inv_name,unit_name,inv_model,
		   price, amount,amount_money,batch_no,bar_code,
		   fac_name,out_date,confirm_date,maker,to_char(bus_type_name) bus_type_name
		from out_detail
		union all
		select 
		   null out_no,null brief,'合计' store_name,null dept_name,
		   null inv_id, null inv_code,null inv_name,null unit_name,
		   null inv_model,null price,sum(nvl( amount, 0)) as amount,
		   sum(nvl( amount_money, 0)) as amount_money,null batch_no,
		   null bar_code,null fac_name,null out_date,null confirm_date,
		   null  maker,null bus_type_name
		from out_detail
	</select>
	
</mapper>

