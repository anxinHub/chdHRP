<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.acc.dao.books.subjaccount.GroupAccSubjLedgerMapper">

	<resultMap id="groupAccSubjLedger" type="com.chd.hrp.acc.entity.AccSubjLedger">
		<result property="acc_year" column="acc_year" />
		<result property="acc_month" column="acc_month" />
		<result property="acc_day" column="acc_day" />
		<result property="fun_name" column="fun_name" />
		<result property="eco_name" column="eco_name" />
		<result property="subj_id" column="subj_id" />
		<result property="subj_code" column="subj_code" />
		<result property="subj_name" column="subj_name" />
		<result property="summary" column="summary" />
		<result property="debit" column="debit" />
		<result property="credit" column="credit" />
		<result property="end_os" column="end_os" />
		<result property="cash_dire" column="cash_dire" />
		<result property="subj_level" column="subj_level" />
		<result property="vouch_id" column="vouch_id" />
		<result property="vouch_no" column="vouch_no" />
		<result property="subj_dire" column="subj_dire" />
		<result property="nq_debit" column="nq_debit" />
		<result property="nq_credit" column="nq_credit" />
		<result property="qc_debit" column="qc_debit" />
		<result property="qc_credit" column="qc_credit" />
		<result property="bq_debit" column="bq_debit" />
		<result property="bq_credit" column="bq_credit" />
		<result property="lj_debit" column="lj_debit" />
		<result property="lj_credit" column="lj_credit" />
		
		<result property="end_debit" column="end_debit" />
		<result property="end_credit" column="end_credit" />
		<result property="vouch_date" column="vouch_date" />
	</resultMap>
	
	<resultMap id="paraMap" type="java.util.Map">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="acc_year" column="acc_year" />
		<result property="sum_od" column="sum_od" />
		<result property="sum_oc" column="sum_oc" />
		<result property="end_os" column="end_os" />
		<result property="bal_os" column="bal_os" />
		<result property="this_od" column="this_od" />
		<result property="this_oc" column="this_oc" />
		<result property="lj_debit" column="lj_debit" />
		<result property="lj_credit" column="lj_credit" />
		<result property="check1" column="check1" />
		<result property="check2" column="check2" />
		<result property="check3" column="check3" />
		<result property="check4" column="check4" />
		<result property="value1" column="value1" />
		<result property="value2" column="value2" />
		<result property="value3" column="value3" />
		<result property="value4" column="value4" />
		<result property="acc_year" column="acc_year" />
		<result property="acc_month" column="acc_month" />
		<result property="acc_date" column="acc_date" />
		<result property="vouch_no" column="vouch_no" />
		<result property="summary" column="summary" />
		<result property="debit" column="debit" />
		<result property="credit" column="credit" />
		<result property="subj_dire" column="subj_dire" />
		<result property="subj_code" column="subj_code" />
		<result property="amount_money" column="amount_money" />
		<result property="code_debit" column="code_debit" />
		<result property="code_credit" column="code_credit" />
	</resultMap>
	<resultMap type="java.util.Map" id="treeMap">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="subj_id" column="subj_id" />
		<result property="subj_name" column="subj_name" />
		<result property="subj_code" column="subj_code" />
		<result property="super_code" column="super_code" />
	</resultMap>
	
	<resultMap type="java.util.Map" id="accBooksMap">
	</resultMap>
	
	
	
	<!-- 查询页面传递科目查询科目 -->
	<select id="queryGroupSubjByCody" parameterType="java.util.Map" resultType="java.util.TreeMap">

		select subj_code, subj_name, subj_dire,subj_dire,is_last,subj_level from acc_subj subj
       
       	where 	subj.group_id = #{group_id,jdbcType=INTEGER} and subj.hos_id = #{hos_id,jdbcType=INTEGER} and subj.copy_code = #{copy_code,jdbcType=VARCHAR}
       
         		and TO_NUMBER(subj.acc_year) between TO_NUMBER(#{acc_year_b,jdbcType=VARCHAR}) and TO_NUMBER(#{acc_year_e,jdbcType=VARCHAR})
         		
         		<if test="subjSql != null and subjSql != ''">
         		
					and ${subjSql}
					
				</if>
				<if test="subj_level != null and subj_level != ''">
         		
					and ${subj_level}
					
				</if>
				
       	
       	order by subj.subj_code
	</select>
	
	<!-- ****************************************************查询科目余额表使用 **************************************************** -->
	<!-- 根据科目查询期初或者年初 -->
	<select id="queryGroupLdegerBALOS" parameterType="java.util.Map" resultType="java.util.TreeMap">

		select 	subj.subj_code as subj_code,NVL(al.bal_os, 0) as bal_os,NVL(al.bal_os_w, 0) as bal_os_w
				,NVL(al.sum_od, 0) as sum_od, NVL(al.sum_oc, 0) as sum_oc
				,NVL(al.sum_od_w, 0) as sum_od_w, NVL(al.sum_oc_w, 0) as sum_oc_w
				,NVL(al.end_os, 0) as end_os,NVL(al.end_os_w, 0) as end_os_w
		 from acc_subj subj
		
		left join ACC_LEDER al on subj.group_id = al.group_id and subj.hos_id = al.hos_id and subj.copy_code = al.copy_code
             						and subj.subj_id = al.subj_id and subj.acc_year = al.acc_year
             						
        where	subj.group_id = #{group_id} and subj.hos_id = #{hos_id} and subj.copy_code = #{copy_code}
             	
				<if test="yearMonthSql != null and yearMonthSql != ''">
         		
				and ${yearMonthSql}
					
				</if> 
             	
             	<if test="subjSql != null and subjSql != ''">
         		
					and ${subjSql}
					
				</if>
	</select>
	
	<!-- 根据科目查询本期发生 -->
	<select id="queryGroupLdegerTHIS" parameterType="java.util.Map" resultType="java.util.TreeMap">

		select subj.subj_code as subj_code
				,NVL(sum(al.this_od), 0) as this_od, NVL(sum(al.this_oc), 0) as this_oc
				,NVL(sum(al.this_od_w), 0) as this_od_w, NVL(sum(al.this_oc_w), 0) as this_oc_w
		 from acc_subj subj
		
		left join ACC_LEDER al on subj.group_id = al.group_id and subj.hos_id = al.hos_id and subj.copy_code = al.copy_code 
									and subj.subj_id = al.subj_id and subj.acc_year = al.acc_year
									
		where	subj.group_id = #{group_id} and subj.hos_id = #{hos_id} and subj.copy_code = #{copy_code}
		
            <if test="yearMonthSql != null and yearMonthSql != ''">
         		
				and ${yearMonthSql}
					
			</if>     		  		
                 		
			<if test="subjSql != null and subjSql != ''">
         		
				and ${subjSql}
					
			</if>
			
			group by subj.subj_code
			
	</select>
	
	<!-- 根据科目查询累计发生 -->
	<select id="queryGroupLdegerSUM" parameterType="java.util.Map" resultType="java.util.TreeMap">

		select subj.subj_code as subj_code
			,NVL(sum(al.sum_od), 0) as sum_od, NVL(sum(al.sum_oc), 0) as sum_oc
			,NVL(sum(al.sum_od_w), 0) as sum_od_w, NVL(sum(al.sum_oc_w), 0) as sum_oc_w
		 from acc_subj subj
		
		left join ACC_LEDER al on subj.group_id = al.group_id and subj.hos_id = al.hos_id and subj.copy_code = al.copy_code 
									and subj.subj_id = al.subj_id and subj.acc_year = al.acc_year
									
		where	subj.group_id = #{group_id} and subj.hos_id = #{hos_id} and subj.copy_code = #{copy_code}

            <if test="yearMonthSql != null and yearMonthSql != ''">
         		
				and ${yearMonthSql}
					
			</if>     		  		
                 		
			<if test="subjSql != null and subjSql != ''">
         		
				and ${subjSql}
					
			</if>
			
			group by subj.subj_code
			
	</select>

	<!-- 根据科目查询期初或者年初 -->
	<select id="queryGroupLdegerENDOS" parameterType="java.util.Map" resultType="java.util.TreeMap">

		select subj.subj_code as subj_code,NVL(al.end_os, 0) as end_os,NVL(al.end_os_w, 0) as end_os_w from acc_subj subj
		
		left join ACC_LEDER al on subj.group_id = al.group_id and subj.hos_id = al.hos_id and subj.copy_code = al.copy_code
             						and subj.subj_id = al.subj_id and subj.acc_year = al.acc_year
             						
        where	subj.group_id = #{group_id} and subj.hos_id = #{hos_id} and subj.copy_code = #{copy_code}
				
				<if test="yearMonthSql != null and yearMonthSql != ''">
         		
				and ${yearMonthSql}
					
				</if> 
             	
             	<if test="subjSql != null and subjSql != ''">
         		
					and ${subjSql}
					
				</if>
	</select>
	
		<!-- 根据科目查询期初或者年初 -->
	<select id="queryGroupVouchData" parameterType="java.util.Map" resultType="java.util.TreeMap"  flushCache="true" useCache="false">

select subj.subj_code,subj.subj_dire,sum(NVL(avd.debit, 0)) as debit,sum(NVL(avd.credit, 0)) as credit,sum(NVL(avd.debit_w, 0)) as debit_w,sum(NVL(avd.credit_w, 0)) as credit_w  from acc_subj subj 
left join acc_vouch av on subj.group_id = av.group_id and subj.hos_id = av.hos_id and subj.copy_code = av.copy_code and subj.acc_year = av.acc_year
left join acc_vouch_detail avd on subj.group_id = avd.group_id and subj.hos_id = avd.hos_id and subj.copy_code = avd.copy_code and subj.subj_id = avd.subj_id
             						
        where	subj.group_id = #{group_id} and subj.hos_id = #{hos_id} and subj.copy_code = #{copy_code}
				
				<if test="yearMonthSql != null and yearMonthSql != ''">
         		
					and ${yearMonthSql}
					
				</if> 
             	
             	<if test="subjSql != null and subjSql != ''">
         		
					and ${subjSql}
					
				</if>
				
				group by subj.subj_code,subj.subj_dire
	</select>
	<!-- ****************************************************查询科目余额表使用 **************************************************** -->

	<select id="collectGroupAccSubjLedger" statementType="CALLABLE" parameterType="java.util.Map" >
		<![CDATA[
		{call group_month_subjledergeneral(
		#{group_id},
		#{hos_id},
		#{copy_code},
		#{acc_year_b},
	    #{acc_month_b},
	    #{acc_year_e},
	    #{acc_month_e},
		#{state},
		#{is_subj_flag},
		#{is_show},
		#{subj_code},  
		#{rela_code},
		#{rst,jdbcType=CURSOR,mode=OUT,resultMap=com.chd.hrp.acc.dao.books.subjaccount.AccSubjLedgerMapper.accBooksMap,javaType=java.sql.ResultSet})}
		]]>
	</select>
	
	<select id="collectGroupAccSubjLedgerDetail"  statementType="CALLABLE" parameterType="java.util.Map" >
		<![CDATA[
		{call group_day_subjlederdetail(
		#{
		group_id},
		#{hos_id},
		#{copy_code},
		#{acc_year_b},
	    #{acc_month_b},
	    #{acc_year_e},
	    #{acc_month_e},
		#{state},
		#{is_subj_flag},
		#{subj_code},
		#{rela_code},
		#{rst,jdbcType=CURSOR,mode=OUT,resultMap=com.chd.hrp.acc.dao.books.subjaccount.AccSubjLedgerMapper.accBooksMap,javaType=java.sql.ResultSet})}
		]]>
	</select>
	<select id="collectGroupThreeColumnLedgerDetail"  statementType="CALLABLE" parameterType="java.util.Map" >
		<![CDATA[
		{call group_threecolumnledgerdetail(
		#{group_id},
		#{hos_id},
		#{copy_code},
		#{acc_year_b},
	    #{acc_month_b},
	    #{acc_year_e},
	    #{acc_month_e},
		#{state},
		#{is_subj_flag},
		#{is_show},
		#{subj_code},
		#{summary},
		#{vouch_no_begin},
		#{vouch_no_end}, 
		#{subj_level},
		#{rela_code},
		#{rst,jdbcType=CURSOR,mode=OUT,resultMap=com.chd.hrp.acc.dao.books.subjaccount.AccSubjLedgerMapper.accBooksMap,javaType=java.sql.ResultSet})}
		]]>
	</select>
	
	
	<select id="collectGroupBalanceLedgerDetail"  parameterType="java.util.Map" resultType="java.util.Map"> 
 
with y_balance
 as
 (
    select a.subj_id as obj_id, a.subj_code, sum(end_os) as end_os, sum(sum_od) as sum_od, sum(sum_oc) as sum_oc
			, a.subj_dire, a.subj_type_code,a.is_last,a.subj_level
		from (       
          select distinct a5.subj_id,a5.subj_code,a5.subj_name,a5.subj_name_all,a5.subj_level,a5.is_check,
          a5.is_last,a5.subj_type_code,a5.subj_dire  
          from acc_subj a5 
          where a5.group_id=#{group_id,jdbcType=INTEGER} 
		          and a5.hos_id=#{hos_id,jdbcType=INTEGER}  
		          and a5.copy_code=#{copy_code,jdbcType=VARCHAR}   
                 and a5.acc_year =#{acc_year_b,jdbcType=VARCHAR}
                 and a5.is_stop =0 
                 and a5.subj_code like '${subj_code}%'
      ) a 
      left join (
      select s.subj_code,c.subj_id, sum(c.end_os) end_os, sum(sum_od) sum_od, sum(sum_oc) sum_oc, s.subj_dire,s.subj_type_code
    from acc_leder c
   right join acc_subj s
      on c.group_id = s.group_id
     and c.hos_id = s.hos_id
     and c.copy_code = s.copy_code
  and c.subj_id = s.subj_id
  left join acc_subj_type a on s.group_id = a.group_id and s.hos_id = a.hos_id and s.copy_code = a.copy_code and s.subj_type_code = a.subj_type_code
   left join hos_copy_rela hcr on c.group_id = hcr.group_id
        and c.hos_id = hcr.hos_id and c.copy_code = hcr.copy_code 
   where c.group_id = #{group_id,jdbcType=INTEGER}   
    <!--  and c.hos_id = #{hos_id,jdbcType=INTEGER}  
     and c.copy_code = #{copy_code,jdbcType=VARCHAR}    --> 
      and hcr.rela_code in (#{rela_code})
     and c.acc_year = #{acc_year_b,jdbcType=VARCHAR}
     and c.acc_month = '00' 
     and s.subj_code like '${subj_code}%'
   group by c.subj_id, s.subj_dire,s.subj_type_code,s.subj_code) 
   b on b.subj_code like a.subj_code||'%'
   <if test="subj_level != null and subj_level != ''">
    <choose>
                <when test="subj_level == '99'    ">
                         where a.is_last = 1 
                </when>
                <otherwise>
                   
                     where  a.subj_level &lt;= #{subj_level}
                 </otherwise>
         </choose>
     
   </if>  
      group by a.subj_id,a.subj_code, a.subj_dire,a.subj_type_code,a.is_last,a.subj_level
       
),
vouch_data
 as
 (
 
 select a.subj_id obj_id, a.subj_code,b.acc_month,  sum(b.debit) debit, sum(b.credit) credit,  a.subj_dire,a.subj_type_code,a.is_last,a.subj_level
      from ( 
          select distinct a5.subj_id,a5.subj_code,a5.subj_name,a5.subj_name_all,a5.subj_level,a5.is_check,a5.is_last,
          a5.subj_type_code,a5.subj_dire 
           from acc_subj a5 
          where a5.group_id=#{group_id,jdbcType=INTEGER} 
          and a5.hos_id=#{hos_id,jdbcType=INTEGER} 
          and a5.copy_code=#{copy_code,jdbcType=VARCHAR}  
                and a5.acc_year=#{acc_year_b,jdbcType=VARCHAR}
                 and a5.is_stop =0 
                 and a5.subj_code like '${subj_code}%'
      ) a 
      left  join (select s.subj_code,v.acc_month, c.subj_id, sum(c.debit) debit, sum(c.credit) credit,  s.subj_dire,s.subj_type_code
    from acc_vouch v
   inner join acc_vouch_detail c
      on c.group_id = v.group_id
     and c.hos_id = v.hos_id
     and c.copy_code = v.copy_code
     and c.vouch_id = v.vouch_id
   inner join acc_subj s
      on c.group_id = s.group_id
     and c.hos_id = s.hos_id
     and c.copy_code = s.copy_code
     and c.subj_id = s.subj_id 
   left join hos_copy_rela hcr on v.group_id= hcr.group_id
        and v.hos_id = hcr.hos_id and v.copy_code = hcr.copy_code  
   where v.group_id = #{group_id,jdbcType=INTEGER}
     <!-- and v.hos_id = #{hos_id,jdbcType=INTEGER}
     and v.copy_code =#{copy_code,jdbcType=VARCHAR}   -->
      and hcr.rela_code in (#{rela_code})
     and v.acc_year =#{acc_year_b,jdbcType=VARCHAR}
     and acc_month  &lt;= #{acc_month_e,jdbcType=VARCHAR}  
     and s.subj_code like '${subj_code}%'
     and v.state &gt;= #{is_state,jdbcType=INTEGER} 
   group by v.acc_month, c.subj_id, s.subj_dire,s.subj_type_code,s.subj_code) 
   b on b.subj_code like a.subj_code||'%'
 	<if test="subj_level != null and subj_level != ''">
    
          <choose>
                
                <when test="subj_level == '99'    ">
                         where a.is_last = 1 
                </when>
                <otherwise> 
                     where  a.subj_level &lt;= #{subj_level}
                 </otherwise>
         </choose>
          
     
   </if>  
      group by  a.subj_code,b.acc_month, a.subj_id, a.subj_dire,a.subj_type_code,a.is_last,a.subj_level
  
   
   ),
q_vouch_data
 as
 (
 select c.obj_id, sum(c.debit) debit, sum(c.credit) credit, c.subj_dire,c.subj_type_code,c.is_last,c.subj_level from vouch_data c
   where c.acc_month &lt;#{ acc_month_b,jdbcType=VARCHAR}  
   group by c.obj_id, c.subj_dire,c.subj_type_code,c.is_last,c.subj_level
   ),
b_vouch_data
 as
 (
 select c.obj_id, sum(c.debit) debit, sum(c.credit) credit,c.subj_type_code,c.is_last,c.subj_dire,c.subj_level
    from vouch_data c
   where c.acc_month  between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
   group by c.obj_id,c.subj_type_code,c.is_last,c.subj_dire,c.subj_level
   ),

result_1 as
 ( select a.obj_id, sum(a.nc_d) as nc_d, sum(a.nc_c) as nc_c, sum(a.qc_d) as qc_d, sum(a.qc_c) as qc_c
      , sum(bq_d) as bq_d, sum(bq_c) as bq_c, sum(sum_od) as sum_od, sum(sum_oc) as sum_oc, a.subj_dire
      , a.subj_type_code,a.is_last,a.subj_level
    from (
      select y.obj_id, y.end_os as nc_d, y.end_os as nc_c, 0 as qc_d
        , 0 as qc_c, 0 as bq_d, 0 as bq_c, sum_od, sum_oc
        , y.subj_type_code,y.is_last,y.subj_dire,y.subj_level
      from y_balance y
      union
      select q.obj_id,  0 as nc_d, 0 as nc_c, q.debit - q.credit as qc_d
        , q.credit - q.debit as qc_c, 0 as bq_d, 0 as bq_c, q.debit as sum_od, q.credit as sum_oc
        , q.subj_type_code,q.is_last,q.subj_dire,q.subj_level
      from q_vouch_data q
      union
      select b.obj_id, 0 as nc_d, 0 as nc_c, 0 as qc_d
        , 0 as qc_c, b.debit as bq_d, b.credit as bq_c, b.debit as sum_od, b.credit as sum_oc
        , b.subj_type_code,b.is_last,b.subj_dire,b.subj_level
      from b_vouch_data b
    ) a
    group by a.obj_id, a.subj_dire, a.subj_type_code,a.is_last,a.subj_level),
result_2 as
 (
   select r1.obj_id,ck.subj_code as obj_code, ck.subj_name as obj_name,ck.subj_name_all as obj_name_all, case when r1.subj_dire = 0 then nc_d else 0 end as nc_d, case when r1.subj_dire = 1 then nc_c else 0 end as nc_c, case when r1.subj_dire = 0 then nc_d + qc_d else 0 end as qc_d
      , case when r1.subj_dire = 1 then nc_c + qc_c else 0 end as qc_c, bq_d, bq_c, sum_od, sum_oc
      , case when r1.subj_dire = 0 then nc_d + qc_d + bq_d - bq_c else 0 end as end_d, case when r1.subj_dire = 1 then nc_c + qc_c + bq_c - bq_d else 0 end as end_c, ck.is_check, r1.subj_type_code
    ,r1.is_last,r1.subj_dire,r1.subj_level
    from result_1 r1  left join acc_subj ck 
      on ck.group_id = #{group_id,jdbcType=INTEGER}
     and ck.hos_id = #{hos_id,jdbcType=INTEGER}  
     and ck.copy_code = #{copy_code,jdbcType=VARCHAR}  
     and ck.subj_id = r1.obj_id
     left join acc_subj_type ast on ast.group_id = #{group_id,jdbcType=INTEGER}
     and ast.hos_id =#{hos_id,jdbcType=INTEGER}
     and ast.copy_code = #{copy_code,jdbcType=VARCHAR} 
     and r1.subj_type_code = ast.subj_type_code
   order by ck.subj_code 
   
   ),
   type_data as (
<!--  select null obj_id ,tt.subj_type_code as obj_code, ast.subj_type_name as obj_name, 
      sum(tt.nc_d)  as nc_d, 
       sum(tt.nc_c) as nc_c, 
       sum(tt.qc_d) as qc_d , 
      sum(tt.qc_c)  as qc_c, 
   sum(tt.bq_d) as bq_d, sum(tt.bq_c) as bq_c, sum(tt.sum_od) as sum_od, sum(tt.sum_oc) as sum_oc
      ,    sum(tt.end_d )  as end_d, 
       sum(tt.end_c )  as end_c, 0 as is_check ,tt.is_last
    from result_2 tt inner join acc_subj_type ast on tt.subj_type_code = ast.subj_type_code
    and ast.group_id =#{group_id,jdbcType=INTEGER}  
    and ast.hos_id =#{hos_id,jdbcType=INTEGER}  
    and ast.copy_code =#{copy_code,jdbcType=VARCHAR}  -->
  
      <!-- 之前注释的代码<if test="subj_code != null and subj_code != ''">
             and   is_last = 1
   </if> -->
  <!--   group by tt.subj_type_code, ast.subj_type_name   ,tt.is_last -->
  select null as obj_id, tt.subj_type_code as obj_code, ast.subj_type_name as obj_name, sum(tt.nc_d) as nc_d
      , sum(tt.nc_c) as nc_c, sum(tt.qc_d) as qc_d
      , sum(tt.qc_c) as qc_c, sum(tt.bq_d) as bq_d
      , sum(tt.bq_c) as bq_c, sum(tt.sum_od) as sum_od
      , sum(tt.sum_oc) as sum_oc, sum(tt.end_d) as end_d
      , sum(tt.end_c) as end_c, 0 as is_check,${typef}
    from result_2 tt
      inner join acc_subj_type ast on tt.subj_type_code = ast.subj_type_code
        and ast.group_id =#{group_id,jdbcType=INTEGER}  
    and ast.hos_id =#{hos_id,jdbcType=INTEGER}  
    and ast.copy_code =#{copy_code,jdbcType=VARCHAR} 
    <choose>
           <when  test="  subj_level == '' " >
               where subj_level = 1
             </when>
             <otherwise>
               <choose>
                 <when  test=" subj_level == '99' " >
                   where   is_last = 1
                 </when>
                 <otherwise>
                   where   subj_level &lt;= #{subj_level}
                 </otherwise> 
               </choose>
                
             </otherwise>
            
        </choose>
           
 <!--   left join acc_subj s on tt.obj_id = s.subj_id 
      left join hos_copy_rela hcr on ast.group_id = hcr.group_id
    and ast.hos_id = hcr.hos_id
    and ast.copy_code = hcr.copy_code 
    where s.group_id = #{group_id,jdbcType=INTEGER}  
      and hcr.rela_code in (#{rela_code})
    and  tt.subj_level = 1 -->
    group by tt.subj_type_code, ast.subj_type_name${groupf}
)
   
 select obj_id as "obj_id",obj_code as "obj_code", obj_name as "obj_name",obj_name_all as "obj_name_all", nvl(nc_d,0) as "nc_d", nvl(nc_c,0) as "nc_c", nvl(qc_d,0) as "qc_d"
  , nvl(qc_c,0) as "qc_c", nvl(bq_d,0) as "bq_d", nvl(bq_c,0) as "bq_c", nvl(sum_od,0) as "sum_od", nvl(sum_oc,0) as "sum_oc"
  , nvl(end_d,0) as "end_d", nvl(end_c,0) as "end_c", is_check as "is_check", subj_type_code
from (
  select  obj_id,obj_code as obj_code, to_char(obj_name) as obj_name,to_char(obj_name_all) as obj_name_all,  nc_d as nc_d, nc_c as nc_c, qc_d as qc_d
    , qc_c as qc_c, bq_d as bq_d, bq_c as bq_c, sum_od as sum_od, sum_oc as sum_oc
    , end_d as end_d, end_c as end_c, is_check, subj_type_code,subj_level
  from result_2
  union all
  select obj_id,obj_code, obj_name || '小计',obj_name || '小计', nc_d as nc_d, nc_c as nc_c, qc_d as qc_d
    , qc_c as qc_c, bq_d as bq_d, bq_c as bq_c, sum_od as sum_od, sum_oc as sum_oc
    , end_d as end_d, end_c as end_c, is_check, obj_code as subj_type_code,${unionf}
  from type_data 
 
       
      
  union all
  select null obj_id ,null as obj_code, '合计' as obj_name,'合计' as obj_name_all, sum(nc_d) as nc_d, sum(nc_c) as nc_c, sum(qc_d) as qc_d
    , sum(qc_c) as qc_c, sum(bq_d) as bq_d, sum(bq_c) as bq_c, sum(sum_od) as sum_od, sum(sum_oc) as sum_oc
    , sum(end_d) as end_d, sum(end_c) as end_c, null as is_check, '99999' as subj_type_code,null as subj_level
  from result_2
 
  <choose>
           <when  test="  subj_level == '' " >
                where subj_level = 1
             </when>
             <otherwise>
               <choose>
                 <when  test=" subj_level == '99' " >
                   where   is_last = 1
                 </when>
                 <otherwise>
                   where   subj_level &lt;= #{subj_level}
                 </otherwise> 
               </choose>
                
             </otherwise>
            
        </choose>
        
    
   )  aa  order by subj_type_code ,obj_code
    
		  
	</select>
	
	<select id="collectGroupAccExpendFinancial"  statementType="CALLABLE" parameterType="java.util.Map" >
		<![CDATA[
		{call act_subj_finasubjresult(
		#{group_id},
		#{hos_id},
		#{copy_code},
		#{acc_year},
	    #{acc_time},
	    #{acc_date},
	    #{content_code},
		#{rst,jdbcType=CURSOR,mode=OUT,resultMap=com.chd.hrp.acc.dao.books.subjaccount.AccSubjLedgerMapper.accBooksMap,javaType=java.sql.ResultSet})}
		]]>
	</select>
	
	<select id="queryGroupAccSubjLederDetail" parameterType="java.util.Map" resultType="java.util.Map">
		
		with a_table as (
			select 
			    0 t_id,'00' as acc_month,
			    '' acc_day,'' vouch_id,
			    '' subj_code,
			    '' vouch_date, 
			    '' vouch_no,
				'期初' summary,
				0 as debit,
			    0 as credit,
				 <!-- 由于期初没有借贷方 所有都为0 -->
				<!-- sum(nvl(c.debit,0)) debit, 
				sum(nvl(c.credit,0)) credit, -->
				c.subj_dire  subj_dire,
				sum(nvl(c.end_os,0)) end_os,
				'' subj_name 
			from  (
					select case when hs.subj_dire =0 then bal_os else 0 end    debit,
                           case when hs.subj_dire =1 then bal_os else 0 end    credit,
					       hs.subj_dire subj_dire,
					       c.end_os end_os
	              	from acc_leder c
	              	inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
	                  	and c.acc_year=hs.acc_year and hs.subj_id=c.subj_id
	              	where c.group_id=#{group_id,jdbcType=INTEGER} 
	              		and c.hos_id=#{hos_id,jdbcType=INTEGER} 
	              		and c.copy_code=#{copy_code,jdbcType=VARCHAR} 
	                    and c.acc_year=#{acc_year,jdbcType=VARCHAR} 
	                    and c.acc_month ='00'
	                    and hs.subj_code like '${subj_id}%' 
	                union all
	              select sum(c.debit) debit,
	                     sum(c.credit) credit,
	                      hs.subj_dire ,
	                     sum(case when hs.subj_dire=0 then c.debit-c.credit else c.credit-c.debit end) end_os
	              from acc_vouch v
	              inner join acc_vouch_detail c on c.group_id=v.group_id and c.hos_id=v.hos_id and c.copy_code=v.copy_code
	                    and c.acc_year=v.acc_year and v.vouch_id=c.vouch_id
	              inner join acc_subj hs on c.group_id=hs.group_id and c.hos_id=hs.hos_id and c.copy_code=hs.copy_code
	                    and c.acc_year=hs.acc_year and hs.subj_id=c.subj_id
	              where v.group_id=#{group_id,jdbcType=INTEGER}
	              and v.hos_id=#{hos_id,jdbcType=VARCHAR} 
	              and v.copy_code=#{copy_code,jdbcType=VARCHAR} 
	              and v.state>=#{state}
	              and v.acc_year=#{acc_year,jdbcType=VARCHAR}  
	              <!-- and TO_NUMBER(v.acc_year||''||v.acc_month) &gt;= #{acc_year}||'01' -->
			      and TO_NUMBER(v.acc_year||''||v.acc_month) &lt; #{acc_year}||''||#{acc_month}
	              and hs.subj_code  like '${subj_id}%'
	              group by hs.subj_dire
			) c	 group by  c.subj_dire            
		),b_table as (
			    select distinct 1 as t_id, a.acc_month,  substr(a.vouch_date,9,10) as acc_day,
			    	to_char(a.vouch_id) as vouch_id, a.subj_code, a.vouch_date
			      , f.vouch_type_short || '-' || a.vouch_no as vouch_no, a.summary as summary, Nvl(a.debit, 0) as debit, Nvl(a.credit, 0) as credit, a.subj_dire
			      , 0 as end_os, replace(to_char(wm_concat(
			      	distinct case 
			      		when (SELECT LENGTHB(TRANSLATE(b.subj_name,'-'||b.subj_name,'-')) FROM DUAL)>=2
							then  substr(b.subj_name,0,(select instr(b.subj_name,'-',instr(b.subj_name,'-'),2) from dual)-1)
						else b.subj_name 
					end)
				), ',', '/') as subj_name
         	    FROM   (
         	    	select av.group_id, av.hos_id, av.copy_code, av.acc_month, av.vouch_id, asubj.subj_code, 
         	    		To_char(av.vouch_date, 'yyyy-MM-dd') as vouch_date, av.vouch_no, avd.summary, sum(avd.debit) debit,
				        sum(avd.credit) credit, asubj.subj_dire, av.vouch_type_code,to_char(asubj.subj_name) subj_name
				    from acc_vouch av
				   	left join acc_vouch_detail avd on av.group_id = avd.group_id
				      	and av.hos_id = avd.hos_id
				      	and av.copy_code = av.copy_code
				      	and av.acc_year = avd.acc_year
				      	and av.vouch_id = avd.vouch_id 
				  	left join acc_subj asubj on av.group_id = asubj.group_id
				      	and av.hos_id = asubj.hos_id
				      	and av.copy_code = asubj.copy_code
				      	and av.acc_year = asubj.acc_year
				      	and avd.subj_id = asubj.subj_id	    
					where asubj.subj_code  like '${subj_id}%'
				        and av.group_id = #{group_id,jdbcType=INTEGER}
				        and av.hos_id = #{hos_id,jdbcType=INTEGER}
				        and av.copy_code = #{copy_code,jdbcType=VARCHAR}
			        	and av.state &gt;= #{state,jdbcType=INTEGER}
			        	and av.acc_year = #{acc_year,jdbcType=VARCHAR}
			        	and av.acc_month between #{acc_month} and #{year_month}
			            group by av.group_id, av.hos_id, av.copy_code, av.acc_month, av.vouch_id  , asubj.subj_code,av.vouch_date,av.vouch_no, 
			    		avd.summary,asubj.subj_dire, av.vouch_type_code,asubj.subj_name 
	             ) a 
	             left JOIN (
			    	select avd.subj_id, av.acc_month, asubj.subj_code, To_char(av.vouch_date, 'yyyy-MM-dd') as vouch_date, av.vouch_no, 
			    		avd.summary, To_char(asubj.subj_name_all) as subj_name, 
			       		avd.debit debit,
			       		avd.credit credit,
			        	asubj.subj_dire,av.vouch_id
			      	from acc_vouch av
			      	left join acc_vouch_detail avd on av.group_id = avd.group_id
				      	and av.hos_id = avd.hos_id
				      	and av.copy_code = av.copy_code
				      	and av.acc_year = avd.acc_year
				      	and av.vouch_id = avd.vouch_id 
			      	left join acc_subj asubj on av.group_id = asubj.group_id
				      	and av.hos_id = asubj.hos_id
				      	and av.copy_code = asubj.copy_code
				      	and av.acc_year = asubj.acc_year
				      	and avd.subj_id = asubj.subj_id
			      	<where>
				      		asubj.subj_code not like '${subj_id}%'
				        and av.group_id = #{group_id,jdbcType=INTEGER}
				        and av.hos_id = #{hos_id,jdbcType=INTEGER}
				        and av.copy_code = #{copy_code,jdbcType=VARCHAR}
				        and av.state >=#{state,jdbcType=INTEGER}
				        and av.acc_year =#{acc_year,jdbcType=VARCHAR}
				        and av.acc_month between #{acc_month} and #{year_month}
			      	</where>
			   ) b ON  a.vouch_no = b.vouch_no
			    and ((a.debit > 0
				and b.debit = 0) or (a.debit &lt; 0
				and b.debit > 0)
			or (b.credit = 0
				and a.credit > 0) or (b.credit > 0
				and a.credit &lt; 0))
		and a.vouch_id = b.vouch_id 
                LEFT JOIN acc_vouch_type f ON a.group_id = f.group_id
				    and a.hos_id = f.hos_id
				    and a.copy_code = f.copy_code
				    and a.vouch_type_code = f.vouch_type_code
         		group by a.acc_month, a.vouch_date, a.vouch_id, a.subj_code
			      , a.vouch_date, f.vouch_type_short ,a.vouch_no , a.summary,a.debit, a.credit
			      , a.subj_dire
			),c_table as(
			    select 2 t_id,
			           av.acc_month,
			           '' acc_day,
			           '' vouch_id,
			           '' subj_code,
			           '' vouch_date,
			           '' vouch_no,
			           '本月合计' summary,
			    	   sum(nvl(avd.debit,0)) debit,
			    	   sum(nvl(avd.credit,0)) credit, 
			    	   max(asubj.subj_dire) subj_dire,
			    	   0 end_os,
			    	   '' subj_name 
			    	   
			    from acc_vouch av
				   	left join acc_vouch_detail avd on av.group_id = avd.group_id
				      	and av.hos_id = avd.hos_id
				      	and av.copy_code = av.copy_code
				      	and av.acc_year = avd.acc_year
				      	and av.vouch_id = avd.vouch_id 
				  	left join acc_subj asubj on av.group_id = asubj.group_id
				      	and av.hos_id = asubj.hos_id
				      	and av.copy_code = asubj.copy_code
				      	and av.acc_year = asubj.acc_year
				      	and avd.subj_id = asubj.subj_id	    
					where asubj.subj_code like '${subj_id}%'
				        and av.group_id = #{group_id,jdbcType=INTEGER}
				        and av.hos_id = #{hos_id,jdbcType=INTEGER}
				        and av.copy_code = #{copy_code,jdbcType=VARCHAR}
			        	and av.state &gt;= #{state,jdbcType=INTEGER}
			        	and av.acc_year = #{acc_year,jdbcType=VARCHAR}
			        	and av.acc_month between #{acc_month} and #{year_month}	   

				group by av.acc_month
			),d_table as(
			    select 3 t_id,
			           '' acc_month,
			           '' acc_day,
			           '' vouch_id,
			           '' subj_code,
			           '' vouch_date,
			           '' vouch_no,
			           '本年累计' summary,
			    	   sum(nvl(avd.debit,0)) debit,
			    	   sum(nvl(avd.credit,0)) credit, 
			    	   max(asubj.subj_dire) subj_dire,
			    	   0 end_os,
			    	   '' subj_name 
			    	   
			    from acc_vouch av
				   	left join acc_vouch_detail avd on av.group_id = avd.group_id
				      	and av.hos_id = avd.hos_id
				      	and av.copy_code = av.copy_code
				      	and av.acc_year = avd.acc_year
				      	and av.vouch_id = avd.vouch_id 
				  	left join acc_subj asubj on av.group_id = asubj.group_id
				      	and av.hos_id = asubj.hos_id
				      	and av.copy_code = asubj.copy_code
				      	and av.acc_year = asubj.acc_year
				      	and avd.subj_id = asubj.subj_id	    
					where asubj.subj_code  like '${subj_id}%'
				        and av.group_id = #{group_id,jdbcType=INTEGER}
				        and av.hos_id = #{hos_id,jdbcType=INTEGER}
				        and av.copy_code = #{copy_code,jdbcType=VARCHAR}
			        	and av.state &gt;= #{state,jdbcType=INTEGER}
			        	and av.acc_year = #{acc_year,jdbcType=VARCHAR}
			        	and av.acc_month &lt;= #{year_month}	   
			)
			select subj_code,acc_month,acc_day, vouch_id, subj_dire, vouch_date, summary, subj_name, vouch_no, debit, credit, 
	        case when subj_dire = '0' then sum(decode(t_id, 0, end_os , 1, end_os + debit - credit, 0)) over (order by acc_month, vouch_date, vouch_no, subj_name, debit, credit) 
			  else sum(decode(t_id, 0, end_os , 1, end_os - debit + credit, 0)) over (order by acc_month, vouch_date, vouch_no, subj_name,debit, credit) end as end_os
			 
			 
			from (
			  select t_id,subj_code,acc_month,acc_day,vouch_id,subj_dire,vouch_date,summary,subj_name,vouch_no,debit,credit,end_os
			  from a_table
			  union all
			  select t_id,subj_code,acc_month,acc_day,vouch_id,subj_dire,vouch_date,summary,subj_name,vouch_no,debit,credit,end_os
			  from b_table
			  union all
			  select t_id,subj_code,acc_month,acc_day,vouch_id,subj_dire,vouch_date,summary,subj_name,vouch_no,debit,credit,end_os
			  from c_table
			  union all
			  select t_id,subj_code,acc_month,acc_day,vouch_id,subj_dire,vouch_date,summary,subj_name,vouch_no,debit,credit,end_os
			  from d_table
			)
			order by acc_month  asc,acc_day asc, vouch_date asc,  vouch_no, subj_name, debit, credit
	</select>
	
	<select id="queryGroupAccSubjLederCheck" parameterType="java.util.Map" resultMap="paraMap">
		
		<!-- with a_table as (
			SELECT alc.group_id, alc.hos_id, alc.copy_code, alc.acc_year,asubj.subj_id,asubj.subj_code,asubj.subj_name,asubj.subj_dire,sum(alc.bal_os) bal_os,
       			0 this_od,0 this_oc,sum(alc.sum_od) sum_od,sum(alc.sum_oc) sum_oc,sum(alc.end_os) end_os
				<if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 != ''">
					,a.${COLUMN_ID1} ||'.'|| a.${COLUMN_NO1} as value1
					,a.${COLUMN_CODE1} ||' '|| a.${COLUMN_NAME1} as check1
				</if>
				<if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 == ''">
					,a.${COLUMN_ID1}  as value1
					,a.${COLUMN_CODE1} ||' '|| a.${COLUMN_NAME1} as check1
				</if>
				<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 != '' ">
					,b.${COLUMN_ID2} ||'.'|| b.${COLUMN_NO2} as value2
					, b.${COLUMN_CODE2} ||' '|| b.${COLUMN_NAME2} as check2
				</if>
				<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 == '' ">
					,b.${COLUMN_ID2}  as value2
					, b.${COLUMN_CODE2} ||' '|| b.${COLUMN_NAME2} as check2
				</if>
				<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and COLUMN_NO3 != '' ">
					,c.${COLUMN_ID3} ||'.'|| c.${COLUMN_NO3} as value3
					, c.${COLUMN_CODE3} ||' '||  c.${COLUMN_NAME3} as check3
				</if>
				<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and  COLUMN_NO3 == '' ">
					,c.${COLUMN_ID3}  as value3
					, c.${COLUMN_CODE3} ||' '||  c.${COLUMN_NAME3} as check3
				</if>
				<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and COLUMN_NO4 != '' ">
					,d.${COLUMN_ID4} ||'.'|| d.${COLUMN_NO4} as value4
					, d.${COLUMN_CODE4} ||' '|| d.${COLUMN_NAME4} as check4
				</if>
				<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and  COLUMN_NO4 == '' ">
					,d.${COLUMN_ID4} as value4
					, d.${COLUMN_CODE4} ||' '|| d.${COLUMN_NAME4} as check4
				</if>
			FROM acc_leder_check alc 
			left join acc_subj asubj on alc.group_id = asubj.group_id and alc.hos_id = asubj.hos_id
		  		and alc.copy_code = asubj.copy_code and alc.acc_year=asubj.acc_year
		  		and alc.subj_id = asubj.subj_id
				<if test="TABLE1 != NULL and TABLE1 != '' ">
					left join  ${TABLE1}  a on   alc.group_id = a.group_id 
						and alc.hos_id = a.hos_id
						<if test=" TABLE1 =='ACC_CHECK_ITEM' ">
							and alc.copy_code = a.copy_code
						</if>
			    			and  alc.${COLUMN_CHECK1} = a.${COLUMN_ID1}
			    		<if test=" TABLE1 !='ACC_CHECK_ITEM' and COLUMN_NO1 != '' and COLUMN_CHECK1_NO != ''">
							and  alc.${COLUMN_CHECK1_NO} = a.${COLUMN_NO1}
						</if>
				</if>
				<if test="TABLE2 != NULL and TABLE1 != '' ">
				left join  ${TABLE2}   b on  alc.group_id = b.group_id 
					and alc.hos_id = b.hos_id
	    			<if test=" TABLE2 == 'ACC_CHECK_ITEM' ">
						and alc.copy_code = b.copy_code
					</if>
		    			and  alc.${COLUMN_CHECK2} = b.${COLUMN_ID2}
		    		<if test=" TABLE2 !='ACC_CHECK_ITEM' and COLUMN_NO2 != '' and COLUMN_CHECK2_NO != ''">
						and  alc.${COLUMN_CHECK2_NO} = b.${COLUMN_NO2}
					</if>
				</if>
				<if test="TABLE3 != NULL and TABLE3 != '' ">
				left join  ${TABLE3}   c on   alc.group_id = c.group_id 
					and alc.hos_id = c.hos_id
		    		<if test=" TABLE3 =='ACC_CHECK_ITEM' ">
						and alc.copy_code = c.copy_code
					</if>
		    			and  alc.${COLUMN_CHECK3} = c.${COLUMN_ID3}
		    		<if test=" TABLE3 !='ACC_CHECK_ITEM' and COLUMN_NO3 != '' and COLUMN_CHECK3_NO != ''">
						and  alc.${COLUMN_CHECK3_NO} = c.${COLUMN_NO3}
					</if>
				</if>
			<if test="TABLE4 != NULL and TABLE4 != '' ">
			left join  ${TABLE4}   d on  
			alc.group_id = d.group_id 
			and alc.hos_id = d.hos_id
    		<if test=" TABLE4 =='ACC_CHECK_ITEM' ">
			and alc.copy_code = d.copy_code
			</if> 
    		and  alc.${COLUMN_CHECK4} = d.${COLUMN_ID4}
    		<if test=" TABLE4 !='ACC_CHECK_ITEM' and COLUMN_NO4 != '' and COLUMN_CHECK4_NO != ''">
			and  alc.${COLUMN_CHECK4_NO} = d.${COLUMN_NO4}
			</if>
		</if>
	<where>
		 alc.acc_month='00'
		<if test="group_id != null  and group_id != ''">
			and alc.group_id = #{group_id}
		</if>
		<if test="hos_id != null  and hos_id != ''">
			and alc.hos_id = #{hos_id}
		</if>
		<if test="copy_code != null  and copy_code != ''">
			and alc.copy_code = #{copy_code}
		</if>
		<if test="subj_id != null  and subj_id != ''">
			and alc.subj_id = #{subj_id}
		</if>
		<if test="acc_year != null  and acc_year != ''">
			and alc.acc_year = #{acc_year}
		</if>
		</where>
		 group by alc.group_id,alc.hos_id,alc.copy_code,alc.acc_year,asubj.subj_id,asubj.subj_code,asubj.subj_name,asubj.subj_dire,${groupSql}              
		),b_table as (
			    SELECT alc.group_id,alc.hos_id,alc.copy_code,alc.acc_year,asubj.subj_id,asubj.subj_code,asubj.subj_name,asubj.subj_dire,0 bal_os,debit  this_od,credit this_oc,
       				0 sum_od,0 sum_oc, 0 end_os
			<if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 != ''">
			,a.${COLUMN_ID1} ||'.'|| a.${COLUMN_NO1} as value1
			,a.${COLUMN_CODE1} ||' '|| a.${COLUMN_NAME1} as check1
			</if>
			<if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 == ''">
			,a.${COLUMN_ID1}  as value1
			,a.${COLUMN_CODE1} ||' '|| a.${COLUMN_NAME1} as check1
			</if>
			<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 != '' ">
			,b.${COLUMN_ID2} ||'.'|| b.${COLUMN_NO2} as value2
			, b.${COLUMN_CODE2} ||' '|| b.${COLUMN_NAME2} as check2
			</if>
			<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 == '' ">
			,b.${COLUMN_ID2}  as value2
			, b.${COLUMN_CODE2} ||' '|| b.${COLUMN_NAME2} as check2
			</if>
			<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and COLUMN_NO3 != '' ">
			,c.${COLUMN_ID3} ||'.'|| c.${COLUMN_NO3} as value3
			, c.${COLUMN_CODE3} ||' '||  c.${COLUMN_NAME3} as check3
			</if>
			<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and  COLUMN_NO3 == '' ">
			,c.${COLUMN_ID3}  as value3
			, c.${COLUMN_CODE3} ||' '||  c.${COLUMN_NAME3} as check3
			</if>
			<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and COLUMN_NO4 != '' ">
			,d.${COLUMN_ID4} ||'.'|| d.${COLUMN_NO4} as value4
			, d.${COLUMN_CODE4} ||' '|| d.${COLUMN_NAME4} as check4
			</if>
			<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and  COLUMN_NO4 == '' ">
			,d.${COLUMN_ID4} as value4
			, d.${COLUMN_CODE4} ||' '|| d.${COLUMN_NAME4} as check4
			</if>
		FROM acc_vouch_check alc 
		left join acc_vouch av on
		  alc.group_id=av.group_id and alc.hos_id = av.hos_id
		  and  alc.copy_code = av.copy_code and alc.acc_year= av.acc_year
		  and  alc.vouch_id = av.vouch_id
		  left join acc_subj asubj
		  on alc.group_id = asubj.group_id and alc.hos_id = asubj.hos_id
		  and alc.copy_code = asubj.copy_code and alc.acc_year=asubj.acc_year
		  and alc.subj_id = asubj.subj_id
		<if test="TABLE1 != NULL and TABLE1 != '' ">
			left join  ${TABLE1}   a
			on  
			alc.group_id = a.group_id 
			and alc.hos_id = a.hos_id
			<if test=" TABLE1 =='ACC_CHECK_ITEM' ">
			and alc.copy_code = a.copy_code
			</if>
    		and  alc.${COLUMN_CHECK1} = a.${COLUMN_ID1}
    		<if test=" TABLE1 !='ACC_CHECK_ITEM' and COLUMN_NO1 != '' and COLUMN_CHECK1_NO != ''">
			and  alc.${COLUMN_CHECK1_NO} = a.${COLUMN_NO1}
			</if>
		</if>
		<if test="TABLE2 != NULL and TABLE1 != '' ">
			left join  ${TABLE2}   b
		on  
			alc.group_id = b.group_id 
			and alc.hos_id = b.hos_id
    		<if test=" TABLE2 == 'ACC_CHECK_ITEM' ">
			and alc.copy_code = b.copy_code
			</if>
    		and  alc.${COLUMN_CHECK2} = b.${COLUMN_ID2}
    		<if test=" TABLE2 !='ACC_CHECK_ITEM' and COLUMN_NO2 != '' and COLUMN_CHECK2_NO != ''">
			and  alc.${COLUMN_CHECK2_NO} = b.${COLUMN_NO2}
			</if>
		</if>
		<if test="TABLE3 != NULL and TABLE3 != '' ">
			left join  ${TABLE3}   c
		on  
			alc.group_id = c.group_id 
			and alc.hos_id = c.hos_id
    		<if test=" TABLE3 =='ACC_CHECK_ITEM' ">
			and alc.copy_code = c.copy_code
			</if>
    		and  alc.${COLUMN_CHECK3} = c.${COLUMN_ID3}
    		<if test=" TABLE3 !='ACC_CHECK_ITEM' and COLUMN_NO3 != '' and COLUMN_CHECK3_NO != ''">
			and  alc.${COLUMN_CHECK3_NO} = c.${COLUMN_NO3}
			</if>
		</if>
		<if test="TABLE4 != NULL and TABLE4 != '' ">
			left join  ${TABLE4}   d
		on  
			alc.group_id = d.group_id 
			and alc.hos_id = d.hos_id
    		<if test=" TABLE4 =='ACC_CHECK_ITEM' ">
			and alc.copy_code = d.copy_code
			</if> 
    		and  alc.${COLUMN_CHECK4} = d.${COLUMN_ID4}
    		<if test=" TABLE4 !='ACC_CHECK_ITEM' and COLUMN_NO4 != '' and COLUMN_CHECK4_NO != ''">
			and  alc.${COLUMN_CHECK4_NO} = d.${COLUMN_NO4}
			</if>
		</if>
	<where>
		 av.acc_month between #{acc_month} and #{year_month}
		<if test="group_id != null  and group_id != ''">
			and alc.group_id = #{group_id}
		</if>
		<if test="hos_id != null  and hos_id != ''">
			and alc.hos_id = #{hos_id}
		</if>
		<if test="copy_code != null  and copy_code != ''">
			and alc.copy_code = #{copy_code}
		</if>
		<if test="subj_id != null  and subj_id != ''">
			and alc.subj_id = #{subj_id}
		</if>
		<if test="acc_year != null  and acc_year != ''">
			and alc.acc_year = #{acc_year}
		</if>
		</where>
			)
		select ${querySql},sum(bal_os) bal_os,sum(this_od) this_od,sum(this_oc) this_oc,sum(nvl(this_od,0)) lj_debit,
		   sum(nvl(this_oc,0)) lj_credit,
		   case when subj_dire = 0 then sum(bal_os)+sum(nvl(this_od,0))-sum(nvl(this_oc,0))
		   else sum(bal_os)-sum(nvl(this_od,0))+sum(nvl(this_oc,0)) end as end_os,
		   subj_dire,subj_id,subj_code,subj_name 
		from (
		   	select * from b_table 
		   	union all
		   	select * from a_table
		) group by ${querySql},subj_dire,subj_id,subj_code,subj_name -->
		
		with a_table as ( 
			 select   c.group_id, c.hos_id, c.copy_code, c.acc_year, c.subj_id
      , c.subj_code, c.subj_name, c.subj_dire,  
       case when c.subj_dire = 0 then sum(c.bal_os) + sum(nvl(c.this_od, 0)) - sum(nvl(c.this_oc, 0)) else sum(c.bal_os) - sum(nvl(c.this_od, 0)) + sum(nvl(c.this_oc, 0)) end as bal_os,
       0 as this_od
      , 0 as this_oc, sum(c.sum_od) as sum_od, sum(c.sum_oc) as sum_oc, sum(c.end_os) as end_os
      <!--   ,c.value1
      , c.check1  -->
      
       <if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 != ''">
					,c.value1
					,c.check1
				</if>
				<if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 == ''">
					,c.value1
					,c.check1
				</if>
				<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 != '' ">
					,c.value2
					, c.check2
				</if>
				<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 == '' ">
					,c.value2
					,c.check2
				</if>
				<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and COLUMN_NO3 != '' ">
					,c.value3
					,c.check3
				</if>
				<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and  COLUMN_NO3 == '' ">
					,c.value3
					,c.check3
				</if>
				<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and COLUMN_NO4 != '' ">
					,c.value4
					, c.check4
				</if>
				<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and  COLUMN_NO4 == '' ">
					,c.value4
					, c.check4
				</if>
				 
      
      
      
       from (
				select a.group_id, a.hos_id, a.copy_code, a.acc_year, a.subj_id
		      , a.subj_code, a.subj_name, a.subj_dire, a.bal_os, a.this_od
		      , a.this_oc, a.sum_od, a.sum_oc, a.end_os
		      <!--  ,a.value1
		      , a.check1  -->
		      <if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 != ''">
					,a.value1
					,a.check1
				</if>
				<if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 == ''">
					,a.value1
					,a.check1
				</if>
				<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 != '' ">
					,a.value2
					, a.check2
				</if>
				<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 == '' ">
					,a.value2
					,a.check2
				</if>
				<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and COLUMN_NO3 != '' ">
					,a.value3
					,a.check3
				</if>
				<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and  COLUMN_NO3 == '' ">
					,a.value3
					,a.check3
				</if>
				<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and COLUMN_NO4 != '' ">
					,a.value4
					, a.check4
				</if>
				<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and  COLUMN_NO4 == '' ">
					,a.value4
					, a.check4
				</if>
		      
		      
		      from (
       SELECT alc.group_id, alc.hos_id, alc.copy_code, alc.acc_year,asubj.subj_id,
       asubj.subj_code,asubj.subj_name,asubj.subj_dire,sum(alc.bal_os) bal_os,
       0 this_od,0 this_oc,sum(alc.sum_od) sum_od,sum(alc.sum_oc) sum_oc,
       sum(alc.end_os) end_os
				<if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 != ''">
					,a.${COLUMN_ID1} ||'.'|| a.${COLUMN_NO1} as value1
					,a.${COLUMN_CODE1} ||' '|| a.${COLUMN_NAME1} as check1
				</if>
				<if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 == ''">
					,a.${COLUMN_ID1}  as value1
					,a.${COLUMN_CODE1} ||' '|| a.${COLUMN_NAME1} as check1
				</if>
				<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 != '' ">
					,b.${COLUMN_ID2} ||'.'|| b.${COLUMN_NO2} as value2
					, b.${COLUMN_CODE2} ||' '|| b.${COLUMN_NAME2} as check2
				</if>
				<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 == '' ">
					,b.${COLUMN_ID2}  as value2
					, b.${COLUMN_CODE2} ||' '|| b.${COLUMN_NAME2} as check2
				</if>
				<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and COLUMN_NO3 != '' ">
					,c.${COLUMN_ID3} ||'.'|| c.${COLUMN_NO3} as value3
					, c.${COLUMN_CODE3} ||' '||  c.${COLUMN_NAME3} as check3
				</if>
				<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and  COLUMN_NO3 == '' ">
					,c.${COLUMN_ID3}  as value3
					, c.${COLUMN_CODE3} ||' '||  c.${COLUMN_NAME3} as check3
				</if>
				<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and COLUMN_NO4 != '' ">
					,d.${COLUMN_ID4} ||'.'|| d.${COLUMN_NO4} as value4
					, d.${COLUMN_CODE4} ||' '|| d.${COLUMN_NAME4} as check4
				</if>
				<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and  COLUMN_NO4 == '' ">
					,d.${COLUMN_ID4} as value4
					, d.${COLUMN_CODE4} ||' '|| d.${COLUMN_NAME4} as check4
				</if>
			FROM acc_leder_check alc 
			left join acc_subj asubj on alc.group_id = asubj.group_id and alc.hos_id = asubj.hos_id
		  		and alc.copy_code = asubj.copy_code and alc.acc_year=asubj.acc_year
		  		and alc.subj_id = asubj.subj_id
				<if test="TABLE1 != NULL and TABLE1 != '' ">
					left join  ${TABLE1}  a on   alc.group_id = a.group_id 
						and alc.hos_id = a.hos_id 
						${typeSql1}
						<!-- <if test=" check_type_id1 !='' and  check_type_id1!= null">
							and  a.check_type_id=#{check_type_id1}
						</if> -->
						<if test=" TABLE1 =='ACC_CHECK_ITEM' ">
							and alc.copy_code = a.copy_code 
						</if>
			    			and  alc.${COLUMN_CHECK1} = a.${COLUMN_ID1}
			    		<if test=" TABLE1 !='ACC_CHECK_ITEM' and COLUMN_NO1 != '' and COLUMN_CHECK1_NO != ''">
							and  alc.${COLUMN_CHECK1_NO} = a.${COLUMN_NO1}
						</if>
				</if>
				<if test="TABLE2 != NULL and TABLE1 != '' ">
				left join  ${TABLE2}   b on  alc.group_id = b.group_id 
					and alc.hos_id = b.hos_id
	    			<if test=" TABLE2 == 'ACC_CHECK_ITEM' ">
						and alc.copy_code = b.copy_code
					</if>
					${typeSql2}
					<!-- <if test=" check_type_id2 !='' and  check_type_id2!= null">
							and  a.check_type_id=#{check_type_id2}
						</if> -->
		    			and  alc.${COLUMN_CHECK2} = b.${COLUMN_ID2}
		    		<if test=" TABLE2 !='ACC_CHECK_ITEM' and COLUMN_NO2 != '' and COLUMN_CHECK2_NO != ''">
						and  alc.${COLUMN_CHECK2_NO} = b.${COLUMN_NO2}
					</if>
				</if>
				<if test="TABLE3 != NULL and TABLE3 != '' ">
				left join  ${TABLE3}   c on   alc.group_id = c.group_id 
					and alc.hos_id = c.hos_id
		    		<if test=" TABLE3 =='ACC_CHECK_ITEM' ">
						and alc.copy_code = c.copy_code
					</if>
					${typeSql3}
					<!-- <if test=" check_type_id3 !='' and  check_type_id3!= null">
							and  a.check_type_id=#{check_type_id3}
						</if> -->
		    			and  alc.${COLUMN_CHECK3} = c.${COLUMN_ID3}
		    		<if test=" TABLE3 !='ACC_CHECK_ITEM' and COLUMN_NO3 != '' and COLUMN_CHECK3_NO != ''">
						and  alc.${COLUMN_CHECK3_NO} = c.${COLUMN_NO3}
					</if>
				</if>
			<if test="TABLE4 != NULL and TABLE4 != '' ">
			left join  ${TABLE4}   d on  
			alc.group_id = d.group_id 
			and alc.hos_id = d.hos_id
    		<if test=" TABLE4 =='ACC_CHECK_ITEM' ">
			and alc.copy_code = d.copy_code
			</if> 
			${typeSql4}
			<!-- <if test=" check_type_id4 !='' and  check_type_id4!= null">
				and  a.check_type_id=#{check_type_id4}
			 </if> -->
    		and  alc.${COLUMN_CHECK4} = d.${COLUMN_ID4}
    		<if test=" TABLE4 !='ACC_CHECK_ITEM' and COLUMN_NO4 != '' and COLUMN_CHECK4_NO != ''">
			and  alc.${COLUMN_CHECK4_NO} = d.${COLUMN_NO4}
			</if>
		</if>
	<where> 
		    alc.acc_year=#{acc_year,jdbcType=VARCHAR}
		    and  alc.acc_month='00'
			and alc.group_id = #{group_id} 
			and alc.hos_id = #{hos_id} 
			and alc.copy_code = #{copy_code}  
			and alc.subj_id = #{subj_id}  
		</where>
		 group by alc.group_id,alc.hos_id,alc.copy_code,alc.acc_year,asubj.subj_id,asubj.subj_code,asubj.subj_name,asubj.subj_dire,${groupSql}                            
		) a 
		 union all 
      select  b.group_id, b.hos_id, b.copy_code, b.acc_year, b.subj_id
      , b.subj_code, b.subj_name, b.subj_dire, b.bal_os, b.this_od
      , b.this_oc, b.sum_od, b.sum_oc, b.end_os
     <!--  , b.value1
      , b.check1  -->
      
       <if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 != ''">
					,b.value1
					,b.check1
				</if>
				<if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 == ''">
					,b.value1
					,b.check1
				</if>
				<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 != '' ">
					,b.value2
					,b.check2
				</if>
				<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 == '' ">
					,b.value2
					,b.check2
				</if>
				<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and COLUMN_NO3 != '' ">
					,b.value3
					,b.check3
				</if>
				<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and  COLUMN_NO3 == '' ">
					,b.value3
					,b.check3
				</if>
				<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and COLUMN_NO4 != '' ">
					,b.value4
					,b.check4
				</if>
				<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and  COLUMN_NO4 == '' ">
					,b.value4
					,b.check4
				</if>
				
      
      from (
      
      SELECT alc.group_id,alc.hos_id,alc.copy_code,alc.acc_year,asubj.subj_id,asubj.subj_code,asubj.subj_name,asubj.subj_dire,0 bal_os,debit  this_od,credit this_oc,
       				0 sum_od,0 sum_oc, 0 end_os
			<if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 != ''">
			,a.${COLUMN_ID1} ||'.'|| a.${COLUMN_NO1} as value1
			,a.${COLUMN_CODE1} ||' '|| a.${COLUMN_NAME1} as check1
			</if>
			<if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 == ''">
			,a.${COLUMN_ID1}  as value1
			,a.${COLUMN_CODE1} ||' '|| a.${COLUMN_NAME1} as check1
			</if>
			<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 != '' ">
			,b.${COLUMN_ID2} ||'.'|| b.${COLUMN_NO2} as value2
			, b.${COLUMN_CODE2} ||' '|| b.${COLUMN_NAME2} as check2
			</if>
			<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 == '' ">
			,b.${COLUMN_ID2}  as value2
			, b.${COLUMN_CODE2} ||' '|| b.${COLUMN_NAME2} as check2
			</if>
			<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and COLUMN_NO3 != '' ">
			,c.${COLUMN_ID3} ||'.'|| c.${COLUMN_NO3} as value3
			, c.${COLUMN_CODE3} ||' '||  c.${COLUMN_NAME3} as check3
			</if>
			<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and  COLUMN_NO3 == '' ">
			,c.${COLUMN_ID3}  as value3
			, c.${COLUMN_CODE3} ||' '||  c.${COLUMN_NAME3} as check3
			</if>
			<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and COLUMN_NO4 != '' ">
			,d.${COLUMN_ID4} ||'.'|| d.${COLUMN_NO4} as value4
			, d.${COLUMN_CODE4} ||' '|| d.${COLUMN_NAME4} as check4
			</if>
			<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and  COLUMN_NO4 == '' ">
			,d.${COLUMN_ID4} as value4
			, d.${COLUMN_CODE4} ||' '|| d.${COLUMN_NAME4} as check4
			</if>
		FROM acc_vouch_check alc 
		left join acc_vouch av on
		  alc.group_id=av.group_id and alc.hos_id = av.hos_id
		  and  alc.copy_code = av.copy_code and alc.acc_year= av.acc_year
		  and  alc.vouch_id = av.vouch_id
		  left join acc_subj asubj
		  on alc.group_id = asubj.group_id and alc.hos_id = asubj.hos_id
		  and alc.copy_code = asubj.copy_code and alc.acc_year=asubj.acc_year
		  and alc.subj_id = asubj.subj_id
		<if test="TABLE1 != NULL and TABLE1 != '' ">
			left join  ${TABLE1}   a
			on  
			alc.group_id = a.group_id 
			and alc.hos_id = a.hos_id
			<if test=" TABLE1 =='ACC_CHECK_ITEM' ">
			and alc.copy_code = a.copy_code
			</if>
			${typeSql1}
			<!-- <if test=" check_type_id1 !='' and  check_type_id1!= null">
				 and  a.check_type_id=#{check_type_id1}
			</if> -->
    		and  alc.${COLUMN_CHECK1} = a.${COLUMN_ID1}
    		<if test=" TABLE1 !='ACC_CHECK_ITEM' and COLUMN_NO1 != '' and COLUMN_CHECK1_NO != ''">
			and  alc.${COLUMN_CHECK1_NO} = a.${COLUMN_NO1}
			</if>
		</if>
		<if test="TABLE2 != NULL and TABLE1 != '' ">
			left join  ${TABLE2}   b
		on  
			alc.group_id = b.group_id 
			and alc.hos_id = b.hos_id
    		<if test=" TABLE2 == 'ACC_CHECK_ITEM' ">
			and alc.copy_code = b.copy_code
			</if>
			${typeSql2}
			<!-- <if test=" check_type_id2 !='' and  check_type_id2!= null">
				 and  a.check_type_id=#{check_type_id2}
			</if> -->
    		and  alc.${COLUMN_CHECK2} = b.${COLUMN_ID2}
    		<if test=" TABLE2 !='ACC_CHECK_ITEM' and COLUMN_NO2 != '' and COLUMN_CHECK2_NO != ''">
			and  alc.${COLUMN_CHECK2_NO} = b.${COLUMN_NO2}
			</if>
		</if>
		<if test="TABLE3 != NULL and TABLE3 != '' ">
			left join  ${TABLE3}   c
		on  
			alc.group_id = c.group_id 
			and alc.hos_id = c.hos_id
    		<if test=" TABLE3 =='ACC_CHECK_ITEM' ">
			and alc.copy_code = c.copy_code
			</if>
			${typeSql3}
			<!-- <if test=" check_type_id3 !='' and  check_type_id3!= null">
				 and  a.check_type_id=#{check_type_id3}
			</if> -->
    		and  alc.${COLUMN_CHECK3} = c.${COLUMN_ID3}
    		<if test=" TABLE3 !='ACC_CHECK_ITEM' and COLUMN_NO3 != '' and COLUMN_CHECK3_NO != ''">
			and  alc.${COLUMN_CHECK3_NO} = c.${COLUMN_NO3}
			</if>
		</if>
		<if test="TABLE4 != NULL and TABLE4 != '' ">
			left join  ${TABLE4}   d
		on  
			alc.group_id = d.group_id 
			and alc.hos_id = d.hos_id
    		<if test=" TABLE4 =='ACC_CHECK_ITEM' ">
			and alc.copy_code = d.copy_code
			</if> 
			${typeSql4}
			<!-- <if test=" check_type_id4 !='' and  check_type_id4!= null">
				 and  a.check_type_id=#{check_type_id4}
			</if> -->
    		and  alc.${COLUMN_CHECK4} = d.${COLUMN_ID4}
    		<if test=" TABLE4 !='ACC_CHECK_ITEM' and COLUMN_NO4 != '' and COLUMN_CHECK4_NO != ''">
			and  alc.${COLUMN_CHECK4_NO} = d.${COLUMN_NO4}
			</if>
		</if>
	<where>
				      alc.acc_year = #{acc_year,jdbcType=VARCHAR}
		        and   av.acc_month  &gt;=  '01' 
		        and   av.acc_month &lt;   #{acc_month}
		        and av.state &gt;= #{state,jdbcType=INTEGER} 
				and alc.group_id = #{group_id} 
				and alc.hos_id = #{hos_id} 
				and alc.copy_code = #{copy_code}  
			    and alc.subj_id = #{subj_id}  
		
		</where>
		) b 
		
		  ) c
    group by c.group_id, c.hos_id, c.copy_code, c.acc_year,c.subj_id, c.subj_code, c.subj_name, c.subj_dire ,
    <!--  ,c.value1
      , c.check1 -->
      ${searchSql}
		),b_table as (
			    SELECT alc.group_id,alc.hos_id,alc.copy_code,alc.acc_year,asubj.subj_id,asubj.subj_code,asubj.subj_name,asubj.subj_dire,0 bal_os,debit  this_od,credit this_oc,
       				0 sum_od,0 sum_oc, 0 end_os
			<if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 != ''">
			,a.${COLUMN_ID1} ||'.'|| a.${COLUMN_NO1} as value1
			,a.${COLUMN_CODE1} ||' '|| a.${COLUMN_NAME1} as check1
			</if>
			<if test=" COLUMN_NAME1 != null and COLUMN_NAME1 != '' and  COLUMN_NO1 == ''">
			,a.${COLUMN_ID1}  as value1
			,a.${COLUMN_CODE1} ||' '|| a.${COLUMN_NAME1} as check1
			</if>
			<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 != '' ">
			,b.${COLUMN_ID2} ||'.'|| b.${COLUMN_NO2} as value2
			, b.${COLUMN_CODE2} ||' '|| b.${COLUMN_NAME2} as check2
			</if>
			<if test=" COLUMN_NAME2 != null and COLUMN_NAME2 != '' and COLUMN_NO2 == '' ">
			,b.${COLUMN_ID2}  as value2
			, b.${COLUMN_CODE2} ||' '|| b.${COLUMN_NAME2} as check2
			</if>
			<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and COLUMN_NO3 != '' ">
			,c.${COLUMN_ID3} ||'.'|| c.${COLUMN_NO3} as value3
			, c.${COLUMN_CODE3} ||' '||  c.${COLUMN_NAME3} as check3
			</if>
			<if test=" COLUMN_NAME3 != null and COLUMN_NAME3 != '' and  COLUMN_NO3 == '' ">
			,c.${COLUMN_ID3}  as value3
			, c.${COLUMN_CODE3} ||' '||  c.${COLUMN_NAME3} as check3
			</if>
			<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and COLUMN_NO4 != '' ">
			,d.${COLUMN_ID4} ||'.'|| d.${COLUMN_NO4} as value4
			, d.${COLUMN_CODE4} ||' '|| d.${COLUMN_NAME4} as check4
			</if>
			<if test=" COLUMN_NAME4 != null and COLUMN_NAME4 != '' and  COLUMN_NO4 == '' ">
			,d.${COLUMN_ID4} as value4
			, d.${COLUMN_CODE4} ||' '|| d.${COLUMN_NAME4} as check4
			</if>
		FROM acc_vouch_check alc 
		left join acc_vouch av on
		  alc.group_id=av.group_id and alc.hos_id = av.hos_id
		  and  alc.copy_code = av.copy_code and alc.acc_year= av.acc_year
		  and  alc.vouch_id = av.vouch_id
		  left join acc_subj asubj
		  on alc.group_id = asubj.group_id and alc.hos_id = asubj.hos_id
		  and alc.copy_code = asubj.copy_code and alc.acc_year=asubj.acc_year
		  and alc.subj_id = asubj.subj_id
		<if test="TABLE1 != NULL and TABLE1 != '' ">
			left join  ${TABLE1}   a
			on  
			alc.group_id = a.group_id 
			and alc.hos_id = a.hos_id
			<if test=" TABLE1 =='ACC_CHECK_ITEM' ">
			and alc.copy_code = a.copy_code
			</if>
			${typeSql}
			<!-- <if test=" check_type_id1 !='' and  check_type_id1!= null">
				 and  a.check_type_id=#{check_type_id1}
			</if> -->
    		and  alc.${COLUMN_CHECK1} = a.${COLUMN_ID1}
    		<if test=" TABLE1 !='ACC_CHECK_ITEM' and COLUMN_NO1 != '' and COLUMN_CHECK1_NO != ''">
			and  alc.${COLUMN_CHECK1_NO} = a.${COLUMN_NO1}
			</if>
		</if>
		<if test="TABLE2 != NULL and TABLE1 != '' ">
			left join  ${TABLE2}   b
		on  
			alc.group_id = b.group_id 
			and alc.hos_id = b.hos_id
    		<if test=" TABLE2 == 'ACC_CHECK_ITEM' ">
			and alc.copy_code = b.copy_code
			</if>
			${typeSql}
			<!-- <if test=" check_type_id2 !='' and  check_type_id2!= null">
				 and  a.check_type_id=#{check_type_id2}
			</if> -->
    		and  alc.${COLUMN_CHECK2} = b.${COLUMN_ID2}
    		<if test=" TABLE2 !='ACC_CHECK_ITEM' and COLUMN_NO2 != '' and COLUMN_CHECK2_NO != ''">
			and  alc.${COLUMN_CHECK2_NO} = b.${COLUMN_NO2}
			</if>
		</if>
		<if test="TABLE3 != NULL and TABLE3 != '' ">
			left join  ${TABLE3}   c
		on  
			alc.group_id = c.group_id 
			and alc.hos_id = c.hos_id
    		<if test=" TABLE3 =='ACC_CHECK_ITEM' ">
			and alc.copy_code = c.copy_code
			</if>
			${typeSql}
			<!-- <if test=" check_type_id3 !='' and  check_type_id3!= null">
				 and  a.check_type_id=#{check_type_id3}
			</if> -->
    		and  alc.${COLUMN_CHECK3} = c.${COLUMN_ID3}
    		<if test=" TABLE3 !='ACC_CHECK_ITEM' and COLUMN_NO3 != '' and COLUMN_CHECK3_NO != ''">
			and  alc.${COLUMN_CHECK3_NO} = c.${COLUMN_NO3}
			</if>
		</if>
		<if test="TABLE4 != NULL and TABLE4 != '' ">
			left join  ${TABLE4}   d
		on  
			alc.group_id = d.group_id 
			and alc.hos_id = d.hos_id
    		<if test=" TABLE4 =='ACC_CHECK_ITEM' ">
			and alc.copy_code = d.copy_code
			</if> 
			${typeSql} 
			<!-- <if test=" check_type_id4 !='' and  check_type_id4!= null">
				 and  a.check_type_id=#{check_type_id4}
			</if> -->
    		and  alc.${COLUMN_CHECK4} = d.${COLUMN_ID4}
    		<if test=" TABLE4 !='ACC_CHECK_ITEM' and COLUMN_NO4 != '' and COLUMN_CHECK4_NO != ''">
			and  alc.${COLUMN_CHECK4_NO} = d.${COLUMN_NO4}
			</if>
		</if>
	<where>
				 alc.acc_year = #{acc_year,jdbcType=VARCHAR}
				and av.acc_month between  #{acc_month} and #{year_month}
		        and av.state &gt;= #{state,jdbcType=INTEGER} 
				and alc.group_id = #{group_id} 
				and alc.hos_id = #{hos_id} 
				and alc.copy_code = #{copy_code}  
			    and alc.subj_id = #{subj_id}  
		</where>
			)
		<!-- select ${querySql},sum(bal_os) bal_os,sum(this_od) this_od,sum(this_oc) this_oc,sum(nvl(this_od,0)) lj_debit,
		   sum(nvl(this_oc,0)) lj_credit,
		   case when subj_dire = 0 then sum(bal_os)+sum(nvl(this_od,0))-sum(nvl(this_oc,0))
		   else sum(bal_os)-sum(nvl(this_od,0))+sum(nvl(this_oc,0)) end as end_os,
		   subj_dire,subj_id,subj_code,subj_name 
		from (
		   	select * from b_table 
		   	union all
		   	select * from a_table
		) group by ${querySql},subj_dire,subj_id,subj_code,subj_name -->
		
		 select * from (  
			select  ${querySql},   sum(bal_os) as bal_os, sum(this_od) as this_od, sum(this_oc) as this_oc
			  , sum(nvl(this_od, 0)) as lj_debit, sum(nvl(this_oc, 0)) as lj_credit,
			   case when subj_dire = 0 then sum(bal_os) + sum(nvl(this_od, 0)) - sum(nvl(this_oc, 0)) else sum(bal_os) - sum(nvl(this_od, 0)) + sum(nvl(this_oc, 0)) end as end_os, subj_dire, subj_id
			  , subj_code, subj_name
			from (
			  select *
			  from b_table
			  union all
			  select *
			  from a_table   
			) cc
			
			
			group by ${querySql}, subj_dire, subj_id, subj_code, subj_name 
			) rr
			union all 
			
			select * from (
			select    ${totalSql},   0 as bal_os, 0 as this_od,0 as this_oc
			  , 0 as lj_debit, 0 as lj_credit,
			   case when subj_dire = 0 then sum(bal_os) + sum(nvl(this_od, 0)) - sum(nvl(this_oc, 0)) else sum(bal_os) - sum(nvl(this_od, 0)) + sum(nvl(this_oc, 0)) end as end_os, subj_dire,0 as  subj_id
			  ,null as  subj_code, null as  subj_name
			from (
			  select *
			  from b_table
			  union all
			  select *
			  from a_table   
			) dd
			group by subj_dire
			)
			ee 
		
											
	</select>
	
	<!-- 科目余额表  辅助核算项明细查询 -->
	<select id="queryGroupAccSubjLedgerCheckDetail" parameterType="java.util.Map" resultType="java.util.Map" >
		with q_tmp as (
			select 0 as t_id,avc.group_id,avc.hos_id,avc.copy_code,avc.acc_year,avc.acc_month,
		  		null as acc_day,'期初' summary,null vouch_date,avc.sum_od as debit,avc.sum_oc as credit,avc.end_os as end_os,
	       		asu.subj_dire,asu.subj_code,asu.subj_name,null as vouch_no,avc.subj_id,0 as vouch_id
		       	<if test="columnName !=null">
		       		${columnName}
		       	</if>
	      	from acc_leder_check avc 
	      	<if test="joinSql != null ">
	      		${joinSql}
	      	</if>
	      	   left join acc_subj asu on avc.group_id=asu.group_id and avc.hos_id=asu.hos_id and avc.copy_code=asu.copy_code 
	           	and avc.acc_year=asu.acc_year and avc.subj_id=asu.subj_id
	      	<where>
		      	<if test="group_id != null and group_id !='' ">
		      		and avc.group_id=#{group_id,jdbcType=INTEGER}
		      	</if>
		      	<if test="hos_id != null and hos_id !='' ">
		      		and avc.hos_id=#{hos_id,jdbcType=INTEGER}
		      	</if>
		      	<if test="copy_code != null and copy_code !='' ">
		      		and avc.copy_code=#{copy_code,jdbcType=VARCHAR}
		      	</if> 
		      	<if test="acc_year != null and acc_year !='' ">
		      		and avc.acc_year=#{acc_year,jdbcType=VARCHAR}
		      	</if>
		      	<if test="whereSql != null ">
		      		${whereSql}
		      	</if>
			      	and avc.acc_month = #{begin_month}
			      	and asu.subj_code = #{subj_code}
			      	and asu.subj_id = #{subj_id}
	      	</where>
		 ),d_tmp as (
		  	select 1 as t_id,av.group_id,av.hos_id,av.copy_code,av.acc_year,av.acc_month,av.vouch_id,
		  		substr(to_char(av.vouch_date,'yyyy-MM-dd'), 9, 10) as acc_day,avc.summary,av.vouch_date,avc.debit,avc.credit,0 as end_os,
	       		asu.subj_dire,asu.subj_code,asu.subj_name,avt.vouch_type_short||'-'||av.vouch_no as vouch_no,asu.subj_id
	       		<if test="columnName !=null">
	       			${columnName}
	       		</if>
	      	from acc_vouch_check avc 
	      	<if test="joinSql != null ">
	      		${joinSql}
	      	</if>
	      	left join acc_vouch_detail avd on avc.group_id=avd.group_id and avc.hos_id=avd.hos_id and avc.copy_code=avd.copy_code
	           	and avc.vouch_id=avd.vouch_id and avc.acc_year=avd.acc_year and avc.vouch_detail_id=avd.vouch_detail_id
	      	left join acc_vouch av on avd.group_id=av.group_id and avd.hos_id=av.hos_id and avd.copy_code=av.copy_code
	           	and avd.acc_year=av.acc_year and avd.vouch_id=av.vouch_id
	      	left join acc_subj asu on avd.group_id=asu.group_id and avd.hos_id=asu.hos_id and avd.copy_code=asu.copy_code 
	           	and avd.acc_year=asu.acc_year and avd.subj_id=asu.subj_id
	      	left join acc_vouch_type avt on av.group_id=avt.group_id and av.hos_id=avt.hos_id and av.copy_code=avt.copy_code
	           	and av.vouch_type_code=avt.vouch_type_code
	      	<where>
	      		<if test="group_id != null and group_id !='' ">
	      			and avd.group_id=#{group_id,jdbcType=INTEGER}
	      		</if>
		      	<if test="hos_id != null and hos_id !='' ">
		      		and avd.hos_id=#{hos_id,jdbcType=INTEGER}
		      	</if>
		      	<if test="copy_code != null and copy_code !='' ">
		      		and avd.copy_code=#{copy_code,jdbcType=VARCHAR}
		      	</if>
		      	<if test="acc_year != null and acc_year !='' ">
		      		and av.acc_year=#{acc_year,jdbcType=VARCHAR}
		      	</if>
		      	<if test="whereSql != null ">
		      		${whereSql}
		      	</if>
			      	and av.acc_month between #{acc_month} and #{year_month}
			      	and asu.subj_code = #{subj_code}
			      	and asu.subj_id = #{subj_id}
			      	and av.state >= #{state,jdbcType=INTEGER}
	      	</where>
		),m_sum as (
			select 2 as t_id,avc.group_id,avc.hos_id,avc.copy_code,avc.acc_year,avc.acc_month,null as  acc_day,null as vouch_date,
				'本月合计' as summary,asu.subj_dire,asu.subj_code,asu.subj_name,
	       		avc.this_od debit,avc.this_oc credit,avc.end_os end_os,null as vouch_no,avc.subj_id,null as vouch_id
		       	<if test="columnName !=null">
		       		${columnName}
		       	</if>
	      from acc_leder_check avc 
	      <if test="joinSql != null ">
	      	${joinSql}
	      </if>
	      left join acc_subj asu on avc.group_id=asu.group_id and avc.hos_id=asu.hos_id and avc.copy_code=asu.copy_code 
	           and avc.acc_year=asu.acc_year and avc.subj_id=asu.subj_id
	      <where>
	      	<if test="group_id != null and group_id !='' ">
	      		and avc.group_id=#{group_id,jdbcType=INTEGER}
	      	</if>
	      	<if test="hos_id != null and hos_id !='' ">
	      		and avc.hos_id=#{hos_id,jdbcType=INTEGER}
	      	</if>
	      	<if test="copy_code != null and copy_code !='' ">
	      		and avc.copy_code=#{copy_code,jdbcType=VARCHAR}
	      	</if>
	      	<if test="acc_year != null and acc_year !='' ">
	      		and avc.acc_year=#{acc_year,jdbcType=VARCHAR}
	      	</if>
	      	<if test="whereSql != null ">
	      		${whereSql}
	      	</if>
		      	and avc.acc_month between #{acc_month} and #{year_month}
		      	and asu.subj_code = #{subj_code}
		      	and asu.subj_id = #{subj_id}
	      </where>
		),n_sum as (
			select 3 as t_id,avc.group_id,avc.hos_id,avc.copy_code,avc.acc_year,avc.acc_month,null as acc_day,null as vouch_date,
				'本年累计' as summary,asu.subj_dire,asu.subj_code,asu.subj_name,
	       		avc.sum_od debit,avc.sum_oc credit,avc.end_os end_os,null as vouch_no,avc.subj_id,null as vouch_id
	       	<if test="columnName !=null">
	       		${columnName}
	       	</if>
	      from acc_leder_check avc 
	      <if test="joinSql != null ">
	      	${joinSql}
	      </if>
	      left join acc_subj asu on avc.group_id=asu.group_id and avc.hos_id=asu.hos_id and avc.copy_code=asu.copy_code 
	           and avc.acc_year=asu.acc_year and avc.subj_id=asu.subj_id
	      <where>
	      	<if test="group_id != null and group_id !='' ">
	      		and avc.group_id=#{group_id,jdbcType=INTEGER}
	      	</if>
	      	<if test="hos_id != null and hos_id !='' ">
	      		and avc.hos_id=#{hos_id,jdbcType=INTEGER}
	      	</if>
	      	<if test="copy_code != null and copy_code !='' ">
	      		and avc.copy_code=#{copy_code,jdbcType=VARCHAR}
	      	</if>
	      	<if test="acc_year != null and acc_year !='' ">
	      		and avc.acc_year=#{acc_year,jdbcType=VARCHAR}
	      	</if>
	      	<if test="whereSql != null ">
	      		${whereSql}
	      	</if>
		      	and avc.acc_month between #{acc_month} and #{year_month}
		      	and asu.subj_code = #{subj_code}
		      	and asu.subj_id = #{subj_id}
	      </where>
		)
		
		
		select acc_month,acc_day, vouch_id, subj_dire, summary, subj_name, vouch_no, debit, credit, subj_dire,
			  case when subj_dire = '0' then sum(decode(t_id, 0, end_os , 1, end_os + debit - credit, 0)) 
			  	over (order by acc_month,  vouch_no, subj_name, debit, credit) 
			  else sum(decode(t_id, 0, end_os , 1, end_os - debit + credit, 0)) 
			  	over (order by acc_month,  vouch_no, subj_name,debit, credit) end as end_os
			  <if test="showColumn !=null ">
				${showColumn}
			  </if>
			from (
			  	select t_id,group_id,hos_id,copy_code,acc_year,acc_month,acc_day,vouch_date,vouch_no,subj_name,vouch_date,summary,
					debit,credit,subj_dire,subj_id,end_os,null vouch_id
					<if test="showColumn !=null ">
						${showColumn}
					</if>
				from q_tmp
				union all
				select t_id,group_id,hos_id,copy_code,acc_year,acc_month,acc_day,vouch_date,vouch_no,subj_name,vouch_date,summary,
					debit,credit,subj_dire,subj_id,end_os,vouch_id
					<if test="showColumn !=null ">
						${showColumn}
					</if>
				from d_tmp
				union all
				select t_id,group_id,hos_id,copy_code,acc_year,acc_month,acc_day,vouch_date,null vouch_no,subj_name,vouch_date,summary,
					debit,credit,subj_dire,subj_id,end_os,null vouch_id
					<if test="showColumn !=null ">
						${showColumn}
					</if>
				from m_sum
				union all 
				select t_id,group_id,hos_id,copy_code,acc_year,acc_month,acc_day,vouch_date,null vouch_no,subj_name,vouch_date,summary,
					debit,credit,subj_dire,subj_id,end_os,null vouch_id
					<if test="showColumn !=null ">
						${showColumn}
					</if>
				from n_sum
			) aa
		order by acc_month  asc,acc_day asc,  vouch_no, subj_name, debit, credit,t_id
			
	</select>
	
	<select id="queryGroupAccSubjByPlan" parameterType="java.util.Map" resultMap="paraMap">
	
	select asubj.subj_id, amps.subj_code, asubj.subj_name,amps.subj_dire
	  from acc_multi_plan amp
	  left join acc_multi_plan_subj amps on amp.group_id = amps.group_id
	                                    and amp.hos_id = amps.hos_id
	                                    and amp.copy_code = amps.copy_code
	                                    and amp.plan_code = amps.plan_code
	  left join acc_subj asubj on amps.group_id = asubj.group_id
	                          and amps.hos_id = asubj.hos_id
	                          and amps.copy_code = asubj.copy_code
	                          and amps.subj_code = asubj.subj_code
	 where amp.group_id = #{group_id}
	   and amp.hos_id = #{hos_id}
	   and amp.copy_code = #{copy_code}
	   and asubj.acc_year=#{acc_year}
	   <if test="plan_code != null  and plan_code != ''">
	   and amp.plan_code = #{plan_code}
	   </if>
	</select>
	
	<!-- 按月根据凭证类型统计凭证张数 -->
	<select id="queryGroupAccVouchCountSum" parameterType="java.util.Map" resultType="java.util.Map" >
		with t_tmp as (
		     select distinct a.vouch_type_code 
		     from acc_vouch a
		     left join acc_vouch_detail b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
		     	and a.acc_year=b.acc_year and a.vouch_id=b.vouch_id
		     left join acc_subj c on b.group_id=c.group_id and b.hos_id=c.hos_id and b.copy_code=c.copy_code
		     	and b.acc_year=c.acc_year <!-- and b.subj_id=c.subj_id -->
		     left join hos_copy_rela hcr on a.group_id = hcr.group_id and a.hos_id = hcr.hos_id and a.copy_code = hcr.copy_code	
		     <where>
					 a.group_id = #{group_id,jdbcType=INTEGER}
					 and hcr.rela_code in (#{rela_code})
				<!-- <if test="hos_id != null and hos_id !='' "> 
					and a.hos_id = #{hos_id,jdbcType=INTEGER}
				</if>
				<if test="copy_code != null and copy_code !='' "> 
					and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				</if> -->
				<if test="acc_year_b != null and acc_year_b !='' "> 
					and a.acc_year = #{acc_year_b,jdbcType=VARCHAR}
				</if>
				<if test="acc_month_b != null and acc_month_b !='' and acc_month_e !=null and acc_month_e !=''"> 
					and a.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
				</if>
				<if test="stateSql != null ">
					${stateSql}
				</if>
				<if test="subjSql != null ">
					${subjSql}
				</if>
		     </where>
		),n_tmp as (
		     select min(a.vouch_no) vouch_min,max(a.vouch_no) vouch_max,a.vouch_type_code ,d.vouch_type_short
		     from acc_vouch a
		     left join acc_vouch_detail b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
		     	and a.acc_year=b.acc_year and a.vouch_id=b.vouch_id
		     left join acc_subj c on b.group_id=c.group_id and b.hos_id=c.hos_id and b.copy_code=c.copy_code
		     	and b.acc_year=c.acc_year and b.subj_id=c.subj_id 
		     left join acc_vouch_type d on a.group_id=d.group_id and a.hos_id=d.hos_id and a.copy_code=d.copy_code
		          and a.vouch_type_code=d.vouch_type_code
		     left join t_tmp e on a.vouch_type_code=e.vouch_type_code
		     left join hos_copy_rela hcr on a.group_id = hcr.group_id and a.hos_id = hcr.hos_id and a.copy_code = hcr.copy_code
		     <where>
		     		a.group_id = #{group_id,jdbcType= INTEGER}
		     		and hcr.rela_code in (#{rela_code})
		     	<!-- <if test="group_id != null and group_id !='' "> 
					and a.group_id = #{group_id,jdbcType=INTEGER}
				</if>
				<if test="hos_id != null and hos_id !='' "> 
					and a.hos_id = #{hos_id,jdbcType=INTEGER}
				</if>
				<if test="copy_code != null and copy_code !='' "> 
					and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				</if> -->
				<if test="acc_year_b != null and acc_year_b !='' "> 
					and a.acc_year = #{acc_year_b,jdbcType=VARCHAR}
				</if>
				<if test="acc_month_b != null and acc_month_b !='' and acc_month_e !=null and acc_month_e !=''"> 
					and a.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
				</if>
				<if test="stateSql != null ">
					${stateSql}
				</if>
				<if test="subjSql != null ">
					${subjSql}
				</if>
		     </where>
		     group by a.vouch_type_code,d.vouch_type_short    
		),att_tmp as (
			select distinct a.vouch_att_num 
		       	from acc_vouch a 
		       	left join acc_vouch_detail b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
			     	and a.acc_year=b.acc_year and a.vouch_id=b.vouch_id
			    left join acc_subj c on b.group_id=c.group_id and b.hos_id=c.hos_id and b.copy_code=c.copy_code
			     	and b.acc_year=c.acc_year and b.subj_id=c.subj_id 
			    left join hos_copy_rela hcr on a.group_id = hcr.group_id and a.hos_id = hcr.hos_id and a.copy_code = hcr.copy_code 	
		       	<where>
		       			a.group_id = #{group_id,jdbcType=INTEGER}
		       			and hcr.rela_code in (#{rela_code})
		       		<!-- <if test="group_id != null and group_id !='' "> 
						and a.group_id = #{group_id,jdbcType=INTEGER}
					</if>
					<if test="hos_id != null and hos_id !='' "> 
						and a.hos_id = #{hos_id,jdbcType=INTEGER}
					</if>
					<if test="copy_code != null and copy_code !='' "> 
						and a.copy_code = #{copy_code,jdbcType=VARCHAR}
					</if> -->
					<if test="acc_year_b != null and acc_year_b !='' "> 
						and a.acc_year = #{acc_year_b,jdbcType=VARCHAR}
					</if>
					<if test="acc_month_b != null and acc_month_b !='' and acc_month_e !=null and acc_month_e !=''"> 
						and a.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
					</if>
					<if test="stateSql != null ">
						${stateSql}
					</if>
					<if test="subjSql != null ">
						${subjSql}
					</if>
		       	</where>
		),c_tmp as (
			select distinct a.vouch_id from acc_vouch  a
			left join acc_vouch_detail b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
				and a.acc_year=b.acc_year and a.vouch_id=b.vouch_id
			left join acc_subj c on b.group_id=c.group_id and b.hos_id=c.hos_id and b.copy_code=c.copy_code
				and b.acc_year=c.acc_year and b.subj_id=c.subj_id
			left join hos_copy_rela hcr on a.group_id = hcr.group_id and a.hos_id = hcr.hos_id and a.copy_code = hcr.copy_code	
			<where>
					a.group_id = #{group_id,jdbcType=INTEGER}
					and hcr.rela_code in (#{rela_code})
				<!-- <if test="group_id != null and group_id !='' "> 
					and a.group_id = #{group_id,jdbcType=INTEGER}
				</if>
				<if test="hos_id != null and hos_id !='' "> 
					and a.hos_id = #{hos_id,jdbcType=INTEGER}
				</if>
				<if test="copy_code != null and copy_code !='' "> 
					and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				</if> -->
				<if test="acc_year_b != null and acc_year_b !='' "> 
					and a.acc_year = #{acc_year_b,jdbcType=VARCHAR}
				</if>
				<if test="acc_month_b != null and acc_month_b !='' and acc_month_e !=null and acc_month_e !=''"> 
					and a.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
				</if>
				<if test="stateSql != null ">
					${stateSql}
				</if>
				<if test="subjSql != null ">
					${subjSql}
				</if>
			</where>
		),v_tmp as (
			select  distinct a.vouch_id from acc_vouch  a
			left join acc_vouch_detail b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
				and a.acc_year=b.acc_year and a.vouch_id=b.vouch_id
			left join acc_subj c on b.group_id=c.group_id and b.hos_id=c.hos_id and b.copy_code=c.copy_code
				and b.acc_year=c.acc_year and b.subj_id=c.subj_id
			left join hos_copy_rela hcr on a.group_id = hcr.group_id and a.hos_id = hcr.hos_id and a.copy_code = hcr.copy_code	
		   <where>
		   			a.group_id = #{group_id,jdbcType=INTEGER}
		   			and hcr.rela_code in (#{rela_code})
				<!-- <if test="group_id != null and group_id !='' "> 
					and a.group_id = #{group_id,jdbcType=INTEGER}
				</if>
				<if test="hos_id != null and hos_id !='' "> 
					and a.hos_id = #{hos_id,jdbcType=INTEGER}
				</if>
				<if test="copy_code != null and copy_code !='' "> 
					and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				</if> -->
				<if test="acc_year_b != null and acc_year_b !='' "> 
					and a.acc_year = #{acc_year_b,jdbcType=VARCHAR}
				</if>
				<if test="acc_month_b != null and acc_month_b !='' and acc_month_e !=null and acc_month_e !=''"> 
					and a.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
				</if>
				and a.state=0
				<if test="subjSql != null ">
					${subjSql}
				</if>
			</where>
		)
		
		select vouch_min,vouch_max,vouch_type_code,vouch_type_short,
		       ( select count(1) from c_tmp  ) vouch_num,
		       ( select sum(vouch_att_num) from att_tmp ) vouch_att_sums,
		       ( select count(1) from v_tmp) vouch_void
		from n_tmp
		
	</select>
	
	<!-- 科目汇总表  明细 -->
	<select id="queryGroupAccVouchCountSumDetail" parameterType="java.util.Map" resultType="java.util.Map" >
			with d_tmp as (
		         select 1 as t_id, c.subj_type_code,c.subj_code,to_char(c.subj_name) subj_name,sum(b.debit) debit,sum(b.credit) credit
		         from acc_vouch a
		         left join acc_vouch_detail b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
		          	and a.acc_year=b.acc_year and a.vouch_id=b.vouch_id
		         left join acc_subj c on b.group_id=c.group_id and b.hos_id=c.hos_id and b.copy_code=c.copy_code
		          	and b.acc_year=c.acc_year and b.subj_id=c.subj_id
		         left join hos_copy_rela hcr on a.group_id = hcr.group_id 
    				and a.hos_id = hcr.hos_id and a.copy_code = hcr.copy_code 	
		         <where>
					 a.group_id = #{group_id,jdbcType=INTEGER} 
					 and hcr.rela_code in (#{rela_code})
					<!-- <if test="hos_id != null and hos_id !='' "> 
						and a.hos_id = #{hos_id,jdbcType=INTEGER}
					</if>
					<if test="copy_code != null and copy_code !='' "> 
						and a.copy_code = #{copy_code,jdbcType=VARCHAR}
					</if> -->
					<if test="acc_year != null and acc_year !='' "> 
						and a.acc_year = #{acc_year,jdbcType=VARCHAR}
					</if>
					<if test="create_date_b != null and create_date_b !='' and create_date_e !=null and create_date_e !=''"> 
						and to_char(a.vouch_date,'yyyy-MM-dd') between #{create_date_b,jdbcType=VARCHAR} and #{create_date_e,jdbcType=VARCHAR}
					</if>
					<if test="stateSql != null ">
						${stateSql}
					</if>
					<if test="subjSql != null ">
						${subjSql}
					</if>
					<!-- <if test="levelSql != null ">
						${levelSql}
					</if> -->
		         </where>
		        group by c.subj_type_code,c.subj_code,c.subj_name
		        order by c.subj_type_code,c.subj_code
		 ),type_tmp as (
		       select cc.t_id,cc.subj_code,cc.subj_name,cc.subj_type_code,cc.debit,cc.credit
			    from (
			         select aa.t_id, aa.subj_code, to_char(aa.subj_name) as subj_name,aa.subj_level,aa.is_last, aa.subj_type_code, sum(bb.debit) as debit
			            , sum(bb.credit) as credit
			          from (
			            select 1 as t_id, subj_code, subj_name, subj_type_code,subj_level,is_last
			            from acc_subj
			            <where>
			            	<if test="group_id != null and group_id !='' "> 
								and group_id = #{group_id,jdbcType=INTEGER}
							</if>
							<if test="hos_id != null and hos_id !='' "> 
								and hos_id = #{hos_id,jdbcType=INTEGER}
							</if>
							<if test="copy_code != null and copy_code !='' "> 
								and copy_code = #{copy_code,jdbcType=VARCHAR}
							</if>
							<if test="acc_year != null and acc_year !='' "> 
								and acc_year = #{acc_year,jdbcType=VARCHAR}
							</if>
							and is_stop=0
			            </where>
			           ) aa
			            left join d_tmp bb on bb.subj_code like (aa.subj_code || '%') 
			          group by aa.t_id, aa.subj_code, aa.subj_name, aa.subj_type_code,aa.subj_level,aa.is_last
			    ) cc 
    		<where>
    			<if test="levelSql2 != null ">
					${levelSql2}
				</if> 
    		</where>
		  ), l_tmp as (
		       select 0 as t_id, c.subj_type_code,c.subj_type_code subj_code,to_char(d.subj_type_name||'小计') subj_name,sum(b.debit) debit,sum(b.credit) credit
		       from acc_vouch a
		       left join acc_vouch_detail b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
		       		and a.acc_year=b.acc_year and a.vouch_id=b.vouch_id
		       left join acc_subj c on b.group_id=c.group_id and b.hos_id=c.hos_id and b.copy_code=c.copy_code
		       		and b.acc_year=c.acc_year and b.subj_id=c.subj_id
		       left join acc_subj_type d on c.group_id=d.group_id and c.hos_id=d.hos_id 
		       		and c.copy_code=d.copy_code
		       		and c.subj_type_code=d.subj_type_code
		       left join hos_copy_rela hcr on a.group_id = hcr.group_id 
    				and a.hos_id = hcr.hos_id and a.copy_code = hcr.copy_code 		 
		       <where>
						a.group_id = #{group_id,jdbcType=INTEGER}
						and hcr.rela_code in (#{rela_code})
					<!-- <if test="hos_id != null and hos_id !='' "> 
						and a.hos_id = #{hos_id,jdbcType=INTEGER}
					</if>
					<if test="copy_code != null and copy_code !='' "> 
						and a.copy_code = #{copy_code,jdbcType=VARCHAR}
					</if> -->
					<if test="acc_year != null and acc_year !='' "> 
						and a.acc_year = #{acc_year,jdbcType=VARCHAR}
					</if>
					<if test="create_date_b != null and create_date_b !='' and create_date_e !=null and create_date_e !=''"> 
						and to_char(a.vouch_date,'yyyy-MM-dd') between #{create_date_b,jdbcType=VARCHAR} and #{create_date_e,jdbcType=VARCHAR}
					</if>
					<if test="stateSql != null ">
						${stateSql}
					</if>
					<if test="subjSql != null ">
						${subjSql}
					</if>
				<!-- 	<if test="levelSql != null ">
						${levelSql}
					</if> -->
		         </where>
		        group by c.subj_type_code,c.subj_type_code,d.subj_type_name
		 ),s_tmp as (
		         select 2 as t_id,null subj_type_code,null subj_code,'总合计' subj_name,sum(debit) debit,sum(credit) credit
		         from d_tmp
		 )
 
		 select t_id,subj_type_code,subj_code,subj_name,debit,credit from l_tmp
		 union all
		 select t_id,subj_type_code,subj_code,subj_name,debit,credit from type_tmp
		 where nvl(debit,0)!=0 or nvl(credit,0)!=0
		 union all
		 select t_id,subj_type_code,subj_code,subj_name,debit,credit from s_tmp
		 order by subj_type_code,subj_code,t_id
	
	</select>
	
	<select id="queryGroupAccSubjTree" resultMap="treeMap" parameterType="java.util.Map" >
		select a.subj_id, a.subj_code,a.subj_code || ' ' || a.subj_name as subj_name , a.super_code
			  from ACC_SUBJ a
			 where  a.group_id= #{group_id}
			 and a.hos_id= #{hos_id}
			 and a.copy_code = #{copy_code}
			 and a.subj_code like '${subj_code}%'
			 and a.acc_year = #{acc_year}
	</select>
	<select id="queryGroupAccColumnsLedgerBegin" resultMap="paraMap" parameterType="java.util.Map">
		select sum(av.credit) as credit, sum(av.debit) as debit 
		  from ACC_VOUCH_DETAIL av
		  left join acc_vouch b
		    on av.group_id = b.group_id
		   and av.hos_id = b.hos_id
		   and av.copy_code = b.copy_code
		   and av.vouch_id = b.vouch_id
		 where av.group_id = #{group_id}
		   and av.hos_id =  #{hos_id}
		   and av.copy_code = #{copy_code}
		   and b.acc_year =  #{acc_year}
		   and b.acc_month &lt; #{end_acc_month}
		   and exists (select *
		          from acc_subj  asu2 
		          left join  ACC_MULTI_PLAN  p
		            on asu2.group_id = p.group_id
		           and asu2.hos_id = p.hos_id
		           and asu2.copy_code = p.copy_code
		           and asu2.subj_code like p.subj_code||'%'
		         where p.plan_code = #{plan_code}
		           and av.subj_id = asu2.subj_id
		           and av.acc_year = asu2.acc_year
		           and av.group_id = #{group_id}
		           and av.hos_id = #{hos_id}
		           and av.copy_code = #{copy_code})

	</select>
	<select id="queryGroupAccColumnsLedgerDetail" resultMap="paraMap" parameterType="java.util.Map">
		  with dataAll as
 (
 select b.acc_year, b.acc_month, b.acc_date,b.vouch_no, b.summary , sum(b.debit) as debit,sum(b.credit) as credit ,b.subj_dire, sum(b.amount_money) as amount_money,
   amps.subj_code , sum(b.code_debit)as code_debit ,sum(b.code_credit) as code_credit
      from ACC_MULTI_PLAN_SUBJ amps 
      inner join (
      select v.acc_year,
         v.acc_month,
         to_char(v.acc_date, 'DD') as acc_date,
         t.vouch_type_short || '-' || v.vouch_no as vouch_no,
         d.summary,
         nvl(d.debit, 0) as debit,
         nvl(d.credit, 0) as credit,
         case s.subj_dire
           when 0 then
            '借'
           else
            '贷'
         end as subj_dire,
         null as amount_money,
         s.subj_code,
         d.debit as code_debit,
         d.credit as code_credit
    from acc_vouch v
    left join acc_vouch_detail d
      on v.group_id = d.group_id
     and v.hos_id = d.hos_id
     and v.copy_code = d.copy_code
     and v.vouch_id = d.vouch_id
    left join acc_vouch_type t
      on v.group_id = t.group_id
     and v.hos_id = t.hos_id
     and v.copy_code = t.copy_code
     and v.vouch_type_code = t.vouch_type_code
    left join acc_subj s
      on d.group_id = s.group_id
     and d.hos_id = s.hos_id
     and d.copy_code = s.copy_code
     and d.subj_id = s.subj_id
   where v.acc_year = #{acc_year}
   and v.acc_month &gt;=#{between_acc_month}
   and v.acc_month &lt;=#{end_acc_month}
     and exists (select *
            from acc_subj s1
            left join ACC_MULTI_PLAN_SUBJ dp
              on dp.group_id = s1.group_id
             and dp.hos_id = s1.hos_id
             and dp.copy_code = s1.copy_code
             and s1.subj_code like dp.subj_code||'%'
           where dp.group_id = #{group_id}
             and dp.hos_id = #{hos_id}
             and dp.copy_code = #{copy_code}
             and dp.plan_code =  #{plan_code}
             and s1.acc_year =  #{acc_year}
             and s1.subj_id = d.subj_id)
             and v.state &gt;= #{state}
    order by v.acc_date, v.acc_month, v.acc_year asc
     ) b on b.subj_code like amps.subj_code||'%'
     group by  b.acc_year, b.acc_month, b.acc_date,b.vouch_no, b.summary ,b.subj_dire, b.amount_money, amps.subj_code 
     )
select null as acc_year,
       null as acc_month,
       null as acc_date,
       null as vouch_no,
       '期初余额' as summary,
       null as debit,
       null as credit,
       null as subj_dire,
       sum(l.end_os) as amount_money,
       null as subj_code,
       null as code_debit,
       null as code_credit
  from acc_leder l
  left join acc_subj asu
    on asu.group_id = l.group_id
    and asu.hos_id = l.hos_id
    and asu.copy_code = l.copy_code
    and l.subj_id = asu.subj_id
 where l.acc_year = #{acc_year}
   and acc_month = '00'
   and exists (select *
          from acc_subj as1
          left join ACC_MULTI_PLAN p
            on p.group_id = as1.group_id
           and p.hos_id = as1.hos_id
           and p.copy_code = as1.copy_code
           and as1.subj_code like p.subj_code ||'%'
         where as1.subj_code = asu.subj_code)
union all
select acc_year,
       acc_month,
       acc_date,
       vouch_no,
       summary,
       debit,
       credit,
       subj_dire,
       amount_money,
       subj_code,
       code_debit,
       code_credit
  from dataAll
		  
	</select>
	 
</mapper>

