<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.acc.dao.vouch.AccVouchMapper">
 
	<resultMap id="accVouch" type="com.chd.hrp.acc.entity.AccVouch">
		<result property="vouch_id" column="vouch_id" />
		<result property="vouchId" column="vouchId" />
		<result property="vouch_detail_id" column="vouch_detail_id" />
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />   
		<result property="acc_year" column="acc_year" />
		<result property="acc_month" column="acc_month" />
		<result property="vouch_type_code" column="vouch_type_code" />
		<result property="vouch_no" column="vouch_no" />
		<result property="next_vouch_no" column="next_vouch_no" />
		<result property="vouch_date" column="vouch_date" />
		<result property="vouch_att_num" column="vouch_att_num" />
		<result property="vouch_id_cx" column="vouch_id_cx" />
		<result property="create_user" column="create_user" />
		<result property="create_name" column="create_name" />
		<result property="create_date" column="create_date" />
		<result property="cash_user" column="cash_user" />
		<result property="cash_name" column="cash_name" />
		<result property="cashe_date" column="cashe_date" />
		<result property="audit_user" column="audit_user" />
		<result property="audit_name" column="audit_name" />
		<result property="audit_date" column="audit_date" />
		<result property="acc_user" column="acc_user" />
		<result property="acc_name" column="acc_name" />
		<result property="acc_date" column="acc_date" />
		<result property="state" column="state" />
		<result property="note" column="note" />
		<result property="subj_code" column="subj_code" />
		<result property="subj_name" column="subj_name" />
		<result property="summary" column="summary" />
		<result property="debit" column="debit" />
		<result property="credit" column="credit" />
		<result property="subj_dire" column="subj_dire" />
		<result property="is_check" column="is_check" />
		<result property="vouch_type_short" column="vouch_type_short" />
		<result property="cash_item_name" column="cash_item_name" />
		<result property="cash_item_id" column="cash_item_id" />
		<result property="vouch_accounting" column="vouch_accounting" />
		<result property="unvouch_accounting" column="unvouch_accounting" />
		<result property="vouch_state" column="vouch_state" />
		<result property="busi_type_name" column="busi_type_name" />
		

		<!-- 2016/06/02 现金日记账结果集字段 -->
		<result property="other_subj_name" column="other_subj_name" />
		<result property="other_money" column="other_money" />
		<result property="bal" column="bal" />
		<result property="v_year" column="v_year" />
		<result property="v_month" column="v_month" />
		<result property="v_day" column="v_day" />
	</resultMap>

	<resultMap id="accVouch1" type="java.util.Map">
		<result property="vouch_id" column="vouch_id" />
		<result property="vouchId" column="vouchId" />
		<result property="vouch_detail_id" column="vouch_detail_id" />
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />   
		<result property="acc_year" column="acc_year" />
		<result property="acc_month" column="acc_month" />
		<result property="vouch_type_code" column="vouch_type_code" />
		<result property="vouch_no" column="vouch_no" />
		<result property="next_vouch_no" column="next_vouch_no" />
		<result property="vouch_date" column="vouch_date" />
		<result property="vouch_att_num" column="vouch_att_num" />
		<result property="vouch_id_cx" column="vouch_id_cx" />
		<result property="create_user" column="create_user" />
		<result property="create_name" column="create_name" />
		<result property="create_date" column="create_date" />
		<result property="cash_user" column="cash_user" />
		<result property="cash_name" column="cash_name" />
		<result property="cashe_date" column="cashe_date" />
		<result property="audit_user" column="audit_user" />
		<result property="audit_name" column="audit_name" />
		<result property="audit_date" column="audit_date" />
		<result property="acc_user" column="acc_user" />
		<result property="acc_name" column="acc_name" />
		<result property="acc_date" column="acc_date" />
		<result property="state" column="state" />
		<result property="note" column="note" />
		<result property="subj_code" column="subj_code" />
		<result property="subj_name" column="subj_name" />
		<result property="summary" column="summary" />
		<result property="debit" column="debit" />
		<result property="credit" column="credit" />
		<result property="subj_dire" column="subj_dire" />
		<result property="is_check" column="is_check" />
		<result property="vouch_type_short" column="vouch_type_short" />
		<result property="cash_item_name" column="cash_item_name" />
		<result property="cash_item_id" column="cash_item_id" />
		<result property="vouch_accounting" column="vouch_accounting" />
		<result property="unvouch_accounting" column="unvouch_accounting" />
		<result property="vouch_state" column="vouch_state" />
		<result property="busi_type_name" column="busi_type_name" />
		<result property="budg_debit" column="budg_debit" />
		<result property="budg_credit" column="budg_credit" />

		<!-- 2016/06/02 现金日记账结果集字段 -->
		<result property="other_subj_name" column="other_subj_name" />
		<result property="other_money" column="other_money" />
		<result property="bal" column="bal" />
		<result property="v_year" column="v_year" />
		<result property="v_month" column="v_month" />
		<result property="v_day" column="v_day" />
		<result property="sign_flag" column="sign_flag" />
		
	</resultMap>

	<resultMap  id="map" type="java.util.Map">
		<result property="parent_node_id" column="parent_node_id" />
		<result property="state_name" column="state_name" />
	</resultMap>
	
	<resultMap id="accAdjunct" type="java.util.Map">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="vouch_id" column="vouch_id" />
		<result property="att_name_n" column="att_name_n" />
		<result property="att_name_o" column="att_name_o" />
		<result property="att_path" column="att_path" />
		<result property="att_size" column="att_size" />
		<result property="create_user" column="create_user" />
		<result property="create_date" column="create_date" />
		<result property="create_name" column="create_name" />
		<result property="att_type" column="att_type" />
		<result property="invo_num" column="invo_num" />
		<result property="invo_date" column="invo_date" />
		<result property="invo_money" column="invo_money" />
		<result property="vouch_no" column="vouch_no" />
		<result property="vouch_date" column="vouch_date" />
		<result property="state" column="state" />
	</resultMap>

	<insert id="addAccVouch" useGeneratedKeys="true">

		INSERT INTO ACC_VOUCH
		(
		vouch_id
		,
		group_id
		,
		hos_id
		,
		copy_code
		,
		acc_year
		,
		acc_month
		,
		vouch_type_code
		,
		vouch_no
		,
		vouch_date
		,
		vouch_att_num
		,
		create_user
		,
		create_date
		,
		state,
		vouch_id_cx

		) VALUES (
		#{vouch_id} ,
		#{group_id} ,
		#{hos_id} ,
		#{copy_code} ,
		#{acc_year} ,
		#{acc_month} ,
		#{vouch_type_code} ,
		#{vouch_no} ,
		#{vouch_date} ,
		#{vouch_att_num} ,
		#{create_user} ,
		#{create_date} ,
		#{state} ,
		#{vouch_id_cx}

		)

	</insert>
	<insert id="addBatchAccVouch" parameterType="java.util.List">

		INSERT INTO ACC_VOUCH (
		vouch_id
		,
		group_id
		,
		hos_id
		,
		copy_code
		,
		acc_year
		,
		acc_month
		,
		vouch_type_code
		,
		vouch_no
		,
		vouch_date
		,
		vouch_att_num
		,
		vouch_id_cx
		,
		create_user
		,
		create_date
		,
		cash_user
		,
		cashe_date
		,
		audit_user
		,
		audit_date
		,
		acc_user
		,
		acc_date
		,
		state
		,
		note

		)
		<foreach collection="list" item="item" index="index"
			separator=" union all ">
			select
			#{item.vouch_id} ,
			#{item.group_id} ,
			#{item.hos_id} ,
			#{item.copy_code} ,
			#{item.acc_year} ,
			#{item.acc_month} ,
			#{item.vouch_type_code} ,
			#{item.vouch_no} ,
			#{item.vouch_date} ,
			#{item.vouch_att_num} ,
			#{item.vouch_id_cx} ,
			#{item.create_user} ,
			#{item.create_date} ,
			#{item.cash_user} ,
			#{item.cashe_date} ,
			#{item.audit_user} ,
			#{item.audit_date} ,
			#{item.acc_user} ,
			#{item.acc_date} ,
			#{item.state} ,
			#{item.note}
			from dual
		</foreach>

	</insert>

	<update id="updateAccVouch" parameterType="java.util.Map">

		UPDATE acc_vouch SET
		state = #{state}
		<where>
			<if test="vouch_id != null and vouch_id != ''">
				AND vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year}
			</if>
			<if test="acc_month != null and acc_month != ''">
				AND acc_month = #{acc_month}
			</if>
		</where>
	</update>

	<update id="updateAccVouchUser" parameterType="java.util.Map">

		UPDATE acc_vouch SET
		state = 3,
		acc_user = null,
		acc_date= null
		<where>
			
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year}
			</if>
			<if test="acc_month != null and acc_month != ''">
				AND acc_month = #{acc_month}
			</if>
		</where>
	</update>

	<update id="updateBatchAccVouch" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin"
			close=";end;" separator=";">
			UPDATE acc_vouch
			<set>
				<if test="item.state!=null and item.state!=''">
					state = #{item.state}
				</if>
				<if test="item.audit_user!=null and item.audit_user!=''">
					,audit_user = #{item.audit_user}
				</if>
				<if test="item.audit_date!=null and item.audit_date!=''">
					,audit_date = #{item.audit_date}
				</if>
				<if test="item.sign_flag!= null and item.sign_flag!= ''">
					,sign_flag = #{item.sign_flag} 
				</if>
			</set>
			<where>
				<if test="item.vouch_id != null and item.vouch_id != ''">
					AND vouch_id = #{item.vouch_id}
				</if>
				<if test="item.group_id != null and item.group_id != ''">
					AND group_id = #{item.group_id}
				</if>
				<if test="item.hos_id != null and item.hos_id != ''">
					AND hos_id = #{item.hos_id}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					AND copy_code = #{item.copy_code}
				</if>
				<if test="item.acc_year != null and item.acc_year != ''">
					AND acc_year = #{item.acc_year}
				</if>
				<if test="item.acc_month != null and item.acc_month != ''">
					AND acc_month = #{item.acc_month}
				</if>
				<if test="item.vouch_state!= null and item.vouch_state != ''">
					AND state = #{item.vouch_state}
				</if>
			</where>
		</foreach>
	</update>
	
	
	<delete id="deleteBatchAccVouchByDiff" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			delete from acc_vouch_diff 
			where group_id = #{item.group_id} and hos_id = #{item.hos_id} and copy_code = #{item.copy_code} AND vouch_id = #{item.vouch_id}
		</foreach>
	</delete>

	<update id="updateBatchAccVouchLen" statementType="CALLABLE" parameterType="java.util.Map">
		
		<![CDATA[
		{call acc_vouch_neaten(
	        #{vouch_no},
	        #{group_id},
	        #{hos_id},
	        #{copy_code},
	        #{acc_year},
	        #{acc_month},
	        #{vouch_type_code}
		)}
		]]>
		
	</update>

	<update id="updateBatchAccVouchCashFlow" parameterType="java.util.List">

		<foreach collection="list" item="item" index="index" open="begin"
			close=";end;" separator=";">
			UPDATE ACC_CASH_TEMPLATE
			<set>
				<if test="item.cash_item_code!=null and item.cash_item_code!=''">
					cash_item_id = #{item.cash_item_code}
				</if>
			</set>
			where
				group_id = #{item.group_id}
			AND hos_id = #{item.hos_id}
			AND copy_code = #{item.copy_code}
			AND acc_year = #{item.acc_year}
			AND subj_code_other = #{item.subj_code_other}
		</foreach>

	</update>

	<update id="updateAccVouchCashFlowBatch" parameterType="java.util.List">

		<foreach collection="list" item="item" index="index" open="begin"
			close=";end;" separator=";">
			UPDATE ACC_CASH_FLOW set cash_money = #{cash_money},create_user = #{create_user},
				create_date = #{create_date}
			where
				group_id = #{item.group_id}
			AND hos_id = #{item.hos_id}
			AND copy_code = #{item.copy_code}
			AND acc_year = #{item.acc_year}
			AND vouch_detial_id = #{item.vouch_detial_id}
		</foreach>

	</update>

	<!-- 签字、审核 -->
	<update id="updateBatchAccVouchCashier" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			UPDATE acc_vouch
			set
				state =#{item.state}
				<if test="item.state == 2">					
					,cash_user= #{item.cash_user}
					,cashe_date=#{item.cashe_date}
				</if>
				<if test="item.state == 3">
					,audit_user= #{item.audit_user}
					,audit_date=#{item.audit_date}
				</if>
			where state !=99 AND vouch_id = #{item.vouch_id} AND group_id = #{item.group_id} AND hos_id = #{item.hos_id} AND copy_code = #{item.copy_code}				
		</foreach>
	</update>
	
	<!-- 取消签字 -->
	<update id="updateBatchAccVouchUnCashier" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			UPDATE acc_vouch
			set
				state =#{item.state}
				,cash_user=null
				,cashe_date=null
			where state !=99 AND vouch_id = #{item.vouch_id} AND group_id = #{item.group_id} AND hos_id = #{item.hos_id} AND copy_code = #{item.copy_code}				
		</foreach>
	</update>
	
	<!-- 取消审核 -->
	<update id="updateBatchAccVouchUnAudit" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			UPDATE acc_vouch
			set
				state =#{item.state}
				,audit_user=null
				,audit_date=null
			where state !=99 AND vouch_id = #{item.vouch_id} AND group_id = #{item.group_id} AND hos_id = #{item.hos_id} AND copy_code = #{item.copy_code}				
		</foreach>
	</update>
	
	<!-- 不包含现金银行的 -->
	<update id="updateBatchAccVouchCashierNotBank" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			UPDATE acc_vouch
			<set>
					state = (select 
					parent_node_id from ACC_VOUCH_FLOW 
					where
					 group_id = #{item.group_id}
					 and hos_id = #{item.hos_id} 
					 and copy_code = #{item.copy_code}
					 and node_id = 2
					 )
				<if test="item.cash != null and item.cash != ''">
					,cash_user= #{item.cash_user}
					,cashe_date
					=#{item.cashe_date}
				</if>
				<if test="item.audit!= null and item.audit != ''">
					,audit_user= #{item.audit_user}
					,audit_date
					=#{item.audit_date}
				</if>
			</set>
			where
			    state!=99 AND vouch_id = #{item.vouch_id} AND group_id = #{item.group_id} AND hos_id = #{item.hos_id} AND copy_code = #{item.copy_code}				
				and not exists (select 1 from acc_vouch_detail b 
					left join acc_subj h on
						b.group_id=h.group_id and
						b.hos_id=h.hos_id and
						b.copy_code=h.copy_code and
						b.subj_code=h.subj_code and 
						b.acc_year =h.acc_year			
					where b.vouch_id = #{item.vouch_id}	and h.subj_nature_code in ('02','03')
						)
		</foreach>
	</update>
	
	<!-- 包含现金银行的 -->
	<update id="updateBatchAccVouchCashierBank" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			UPDATE acc_vouch
			<set>
					state = #{item.parent_state}
				<if test="item.cash != null and item.cash != ''">
					,cash_user= #{item.cash_user}
					,cashe_date
					=#{item.cashe_date}
				</if>
				<if test="item.audit!= null and item.audit != ''">
					,audit_user= #{item.audit_user}
					,audit_date
					=#{item.audit_date}
				</if>
			</set>
			where
			  state !=99
				AND vouch_id = #{item.vouch_id} AND group_id = #{item.group_id} AND hos_id = #{item.hos_id} AND copy_code = #{item.copy_code}				
				and exists (select 1 from acc_vouch_detail b 
					left join acc_subj h on
						b.group_id=h.group_id and
						b.hos_id=h.hos_id and
						b.copy_code=h.copy_code and
						b.subj_code=h.subj_code and b.acc_year=h.acc_year 					
					where b.vouch_id = #{item.vouch_id}	and h.subj_nature_code in ('02','03')
						)
			
		</foreach>
	</update>
	
	

	<update id="updateBatchAccVouchLabel" parameterType="java.util.List">

		<foreach collection="list" item="item" index="index" open="begin"
			close=";end;" separator=";">
			UPDATE acc_vouch 
			<set>
				note =#{item.note}
			</set>
			<where>
				<if test="item.vouch_id != null and item.vouch_id != ''">
					AND vouch_id = #{item.vouch_id}
				</if>
				<if test="item.group_id != null and item.group_id != ''">
					AND group_id = #{item.group_id}
				</if>
				<if test="item.hos_id != null and item.hos_id != ''">
					AND hos_id = #{item.hos_id}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					AND copy_code = #{item.copy_code}
				</if>
				<if test="item.acc_year != null and item.acc_year != ''">
					AND acc_year = #{item.acc_year}
				</if>
				<if test="item.acc_month != null and item.acc_month != ''">
					AND acc_month = #{item.acc_month}
				</if>
				<if test="item.vouch_state!= null and item.vouch_state != ''">
					AND state = #{item.vouch_state}
				</if>
			</where>
		</foreach>
	</update>

	<delete id="deleteAccVouch" parameterType="java.util.Map">

		DELETE FROM acc_vouch
		WHERE
		vouch_id = #{vouch_id}

	</delete>
	<delete id="deleteBatchAccVouch" parameterType="java.util.List">
		DELETE FROM acc_vouch WHERE
		<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
			vouch_id = #{item.vouch_id}
			and state in
			('-1','0','1')
		</foreach>
	</delete>

	<select id="queryAccVouchByCode" resultType="com.chd.hrp.acc.entity.AccVouch" parameterType="string">

		SELECT
		vouch_id,
		group_id,
		hos_id,
		copy_code,
		acc_year,
		acc_month,
		vouch_type_code,
		vouch_no,
		vouch_date,
		vouch_att_num,
		vouch_id_cx,
		create_user,
		create_date,
		cash_user,
		cashe_date,
		audit_user,
		audit_date,
		acc_user,
		acc_date,
		state,
		note
		FROM acc_vouch
		WHERE
		vouch_id =
		#{vouch_id}

	</select>
	
	<!-- 凭证制单、出纳签字、凭证审核查询 -->
	<select id="queryAccVouch" parameterType="java.util.Map" resultMap="accVouch1">
	
		with d_table as (
			select
				a.acc_year,a.acc_month,'' AS subj_name,a.vouch_id,a.vouch_type_code,
				f.vouch_type_short || '-' || a.vouch_no vouch_no,
				a.vouch_date,a.create_date,c.user_name create_name,d.user_name cash_name,e.user_name audit_name,
				g.user_name acc_name,a.note, min(b.vouch_row) vouch_row, a.create_user,a.cash_user,a.audit_user,
				sum(b.debit) debit,sum(b.credit) credit,
				a.state,s.kind_code,
				bt.busi_type_name,case a.sign_flag when 1 then '已标注' when 2 then '不需要标注' else '未标注' end sign_flag
			from acc_vouch a
			left join acc_vouch_detail b on
				a.group_id=b.group_id and
				a.hos_id=b.hos_id and 
				a.copy_code=b.copy_code
				and a.vouch_id=b.vouch_id	
			left join acc_subj s on s.group_id=b.group_id and
				s.hos_id=b.hos_id and 
				s.copy_code=b.copy_code and s.acc_year=b.acc_year and s.subj_code=b.subj_code
			left join sys_user c on a.group_id=c.group_id
				and a.hos_id=c.hos_id 
				and a.create_user=c.user_id
			left join sys_user d on a.group_id=d.group_id 
				and a.hos_id=d.hos_id 
				and a.cash_user=d.user_id
			left join sys_user e on a.group_id=e.group_id
				and a.hos_id=e.hos_id 
				and a.audit_user=e.user_id
			left join sys_user g on
				a.group_id=g.group_id
				and a.hos_id=g.hos_id 
				and a.acc_user=g.user_id
			left join acc_vouch_type f on  a.group_id=f.group_id 
				and a.hos_id=f.hos_id
				and a.copy_code=f.copy_code 
				and f.vouch_type_code=a.vouch_type_code
			left join acc_busi_type bt on bt.group_id=a.group_id 
				and bt.hos_id=a.hos_id 
				and bt.copy_code=a.copy_code 
				and a.busi_type_code=bt.busi_type_code
			where a.group_id = #{group_id} AND a.hos_id = #{hos_id} AND a.copy_code = #{copy_code} 
			AND a.vouch_date between to_date(#{create_date_b},'yyyy-MM-dd') and to_date(#{create_date_e},'yyyy-MM-dd')	
			<choose>
				<when test='page_url== "cash"'>
					<choose>
					<when test='parent_node_id== 3'><!-- 凭证制单-凭证审核-出纳签字-凭证记账 -->
						<if test="state == 1 ">
							AND a.state in(-1,1,3)
						</if> 
						<if test="state == 2 ">
							AND a.state in(2,99)
						</if>
					</when>	
					<otherwise>
						<if test="state == 1 ">
							AND a.state &lt;2 and a.state!=0
						</if> 
						<if test="state == 2 ">
							AND a.state &gt;= 2 and a.state!=0
						</if>
					</otherwise>
					</choose>
					and exists (
						select 1 from acc_subj 
						where b.group_id=acc_subj.group_id and b.hos_id=acc_subj.hos_id and b.copy_code=acc_subj.copy_code and b.acc_year=acc_subj.acc_year
						and b.subj_code = acc_subj.subj_code and acc_subj.subj_nature_code in ('02','03')
					)
					
				</when>
				<when test='page_url== "audit"'>
					<choose>
					<when test='parent_node_id== 1'><!-- 凭证制单-凭证审核-凭证记账 或者 凭证制单-凭证审核-出纳签字-凭证记账 -->
						<if test="state == 1 ">
							AND a.state in(-1,1)
						</if> 
						<if test="state == 2 ">
							AND a.state in(2,3,99)
						</if>
					</when>
					<otherwise>
						<if test="state == 1 ">
							AND a.state &lt;3 and a.state!=0
						</if> 
						<if test="state == 2 ">
							AND a.state &gt;= 3 and a.state!=0
						</if>
					</otherwise>
					</choose>
				</when>
				<otherwise>
					<if test="state != null and state != ''">
						AND a.state = #{state}
					</if>
				</otherwise>
			</choose>
			<if test="vouch_type_code != null and vouch_type_code != ''">
				AND a.vouch_type_code = #{vouch_type_code}
			</if>
			<if test="busi_type_code != null and busi_type_code != '' and busi_type_code != 'undefined' ">
				AND a.busi_type_code = #{busi_type_code}
			</if>
			<if test=" busi_type_code == 'undefined'">
				AND a.busi_type_code is null
			</if>
			<if test="vouch_no_b != null and vouch_no_b != ''">
				AND a.vouch_no &gt;= to_number(#{vouch_no_b})
			</if>
			<if test="vouch_no_e != null and vouch_no_e != ''">
				AND a.vouch_no &lt;= to_number(#{vouch_no_e})
			</if>				
			<if test="create_user != null and create_user != ''">
				AND a.create_user = #{create_user}
			</if>
			<if test="create_date != null and create_date != ''">
				AND a.vouch_date = #{create_date}
			</if>
			<if test="cash_user != null and cash_user != ''">
				AND a.cash_user = #{cash_user}
			</if>				
			<if test="audit_user != null and audit_user != ''">
				AND a.audit_user = #{audit_user}
			</if>				
			<if test="acc_user != null and acc_user != ''">
				AND a.acc_user = #{acc_user}
			</if>										
			<if test='note =="1" '>
				and a.note is not null
			</if>
			<if test="sign_flag != null and sign_flag != ''">
				and nvl(a.sign_flag,0) =#{sign_flag}
			</if>
			<if test=" (summary != null and summary != '') or (subj_code_b!=null and subj_code_b != '') or (subj_code_e != null and subj_code_e != '') or  (money!=null and money != '') or (sumMoney!=null and sumMoney  != '')">
		    	and exists(
		         	select 1 from acc_vouch_detail b1 
		         	left join  acc_vouch_check avc on avc.group_id =b1.group_id 
		              and avc.hos_id =b1.hos_id 
		              and avc.copy_code =b1.copy_code 
		              and avc.vouch_id =b1.vouch_id 
		              and avc.vouch_detail_id =b1.vouch_detail_id
		         	LEFT JOIN acc_subj asubj ON b1.group_id = asubj.group_id
		              AND b1.hos_id = asubj.hos_id
		              AND b1.copy_code = asubj.copy_code
		              AND b1.acc_year = asubj.acc_year
		              AND b1.subj_code = asubj.subj_code
		         	where b1.group_id=#{group_id} and b1.hos_id=#{hos_id}  and b1.copy_code=#{copy_code} 
	         		and a.vouch_id=b1.vouch_id	        
	        		<if test="summary != null and summary != ''">
			        	AND (b1.summary like '%${summary}%' or avc.summary LIKE '%${summary}%')
					</if>
					<choose>
						<when test="subj_code_b != null and subj_code_b != '' and  subj_code_e != null and subj_code_e != ''">
							and asubj.subj_code between #{subj_code_b} and '${subj_code_e}%'
						</when>
						<otherwise>
							<if test="subj_code_b != null and subj_code_b != ''">
								AND asubj.subj_code like '${subj_code_b}%'
							</if>
							<if test="subj_code_e != null and subj_code_e != ''">
								AND asubj.subj_code like '${subj_code_e}%'
							</if>
						</otherwise>
					</choose>
					
					<choose>
						<when test="money!=null and money != '' and sumMoney!=null and sumMoney  != ''">
							and ((b1.debit &gt;=#{money} and b1.debit &lt;=#{sumMoney}) or (b1.credit &gt;=#{money} and b1.credit&lt;=#{sumMoney}))
						</when>
						<otherwise>
							<if test="money!=null and money !=''">
								AND ((b1.debit &gt;= #{money}) or (b1.credit &gt;= #{money})) 
							</if>
							<if test="sumMoney != null and sumMoney  != ''"> 
								AND ((b1.debit &lt;= #{sumMoney} ) or ( b1.credit &lt;= #{sumMoney}))  
							</if>
						</otherwise>
					</choose>
	     		)
     		</if>	
			GROUP BY s.kind_code,a.vouch_id, f.vouch_type_short,a.vouch_type_code, a.vouch_no, a.vouch_date, a.create_date, 
			a.acc_year, a.acc_month, c.user_name, d.user_name, e.user_name, g.user_name, a.create_user,a.cash_user,
			a.audit_user,a.note, a.state, a.busi_type_code, bt.busi_type_name,a.sign_flag
        	order by a.acc_year desc,a.acc_month desc,a.vouch_type_code,to_number(a.vouch_no)	
		),
	   
	    result as (
		   select acc_year,acc_month,vouch_id,vouch_type_code,vouch_no,create_user,cash_user,audit_user,
		   		vouch_date,create_date,create_name,cash_name,audit_name,acc_name,note,
		   		(select b.summary from acc_vouch_detail b where b.vouch_id=d_table.vouch_id and rownum=1 ) summary,
		   		(select d.debit from d_table d where d.kind_code='01' and d.vouch_id=d_table.vouch_id) debit,
		   		(select d.credit from d_table d where d.kind_code='01' and d.vouch_id=d_table.vouch_id) credit,
		   		(select d.debit from d_table d where d.kind_code='02' and d.vouch_id=d_table.vouch_id) budg_debit,
		   		(select d.credit from d_table d where d.kind_code='02' and d.vouch_id=d_table.vouch_id) budg_credit,
		   		state,busi_type_name,sign_flag
		   from d_table 
		   group by  acc_year, acc_month, vouch_id, vouch_type_code, vouch_no
	       ,create_user, cash_user, audit_user, vouch_date, create_date
	       ,create_name, cash_name, audit_name, acc_name, note,state, busi_type_name,sign_flag
	        order by acc_year desc, acc_month desc, vouch_type_code, vouch_no
	   ) 
	  
		select  null as acc_year, null as acc_month, 0 as vouch_id, null as vouch_type_code, ' ' as vouch_no
		  , null as create_user, null as cash_user, null as audit_user
		  , to_date(null, 'yyyy-MM-dd') as vouch_date
		  , to_date(null, 'yyyy-MM-dd') as create_date, null as create_name
		  , null as cash_name, null as audit_name, null as acc_name, null as note, '合计' as summary
		  , sum(debit) debit,sum(credit) credit,sum(budg_debit) budg_debit,sum(budg_credit) budg_credit,
		   null as state, null as busi_type_name,null as sign_flag
		from result
		union all
		select  acc_year, acc_month, vouch_id, vouch_type_code, vouch_no
		  , create_user, cash_user, audit_user, vouch_date, create_date
		  , create_name, cash_name, audit_name, acc_name, note
		  , summary, debit, credit, budg_debit, budg_credit
		  , state, busi_type_name,sign_flag
		from result

	</select>
	
	
	<!-- 凭证制单、出纳签字、凭证审核查询，按分录展示 -->
	<select id="queryAccVouchPayTypeCode" parameterType="java.util.Map" resultMap="accVouch1">
	
		with d_table as(
		    select a.acc_year, a.acc_month, a.vouch_id, to_char(asubj.subj_code || ' ' || asubj.subj_name) as subj_name, f.vouch_type_short || '-' || a.vouch_no as vouch_no
		    , a.vouch_date, a.create_date, c.user_name as create_name,d.user_name as cash_name, e.user_name as audit_name, g.user_name as acc_name, 
		    a.create_user,a.audit_user,a.cash_user, b.summary,a.note
		    , b.debit as debit, b.credit as credit, b.debit_w as debit_w, b.credit_w as credit_w, a.state
		    , bt.busi_type_name, 
		    a.vouch_type_code,case a.sign_flag when 1 then '已标注' when 2 then '不需要标注' else '未标注' end sign_flag
		  from acc_vouch a
		  left join acc_vouch_detail b on a.group_id = b.group_id
		  and a.hos_id = b.hos_id
		  and a.copy_code = b.copy_code
		  and a.vouch_id = b.vouch_id 
		  left join acc_subj asubj on b.group_id = asubj.group_id
			  and b.hos_id = asubj.hos_id
			  and b.copy_code = asubj.copy_code
			  and b.acc_year = asubj.acc_year
			  and b.subj_code = asubj.subj_code 
		  left join sys_user c on a.group_id = c.group_id
			  and a.hos_id = c.hos_id
			  and a.create_user = c.user_id 
		  left join sys_user d on a.group_id = d.group_id
			  and a.hos_id = d.hos_id
			  and a.cash_user = d.user_id 
		  left join sys_user e on a.group_id = e.group_id
			  and a.hos_id = e.hos_id
			  and a.audit_user = e.user_id 
		  left join sys_user g on a.group_id = g.group_id
			  and a.hos_id = g.hos_id
			  and a.acc_user = g.user_id 
		  left join acc_vouch_type f on a.group_id = f.group_id
			  and a.hos_id = f.hos_id
			  and a.copy_code = f.copy_code
			  and f.vouch_type_code = a.vouch_type_code 		 
		  left join acc_busi_type bt on bt.group_id = a.group_id
			  and bt.hos_id = a.hos_id
			  and bt.copy_code = a.copy_code
			  and a.busi_type_code = bt.busi_type_code 
		  where a.group_id =#{group_id}
		    and a.hos_id = #{hos_id}
		    and a.copy_code = #{copy_code}
		    and a.vouch_date between to_date(#{create_date_b}, 'yyyy-MM-dd') and to_date(#{create_date_e}, 'yyyy-MM-dd')
		    <choose>
				<when test='page_url== "cash"'>
					<choose>
					<when test='parent_node_id== 3'><!-- 凭证制单-凭证审核-出纳签字-凭证记账 -->
						<if test="state == 1 ">
							AND a.state in(-1,1,3)
						</if> 
						<if test="state == 2 ">
							AND a.state in(2,99)
						</if>
					</when>	
					<otherwise>
						<if test="state == 1 ">
							AND a.state &lt;2 and a.state!=0
						</if> 
						<if test="state == 2 ">
							AND a.state &gt;= 2 and a.state!=0
						</if>
					</otherwise>
					</choose>
					 and asubj.subj_nature_code in ('02','03')<!-- 只查询出纳签字的分录 -->
				</when>
				<when test='page_url== "audit"'>
					<choose>
					<when test='parent_node_id== 1'><!-- 凭证制单-凭证审核-凭证记账 或者 凭证制单-凭证审核-出纳签字-凭证记账 -->
						<if test="state == 1 ">
							AND a.state in(-1,1)
						</if> 
						<if test="state == 2 ">
							AND a.state in(2,3,99)
						</if>
					</when>
					<otherwise>
						<if test="state == 1 ">
							AND a.state &lt;3 and a.state!=0
						</if> 
						<if test="state == 2 ">
							AND a.state &gt;= 3 and a.state!=0
						</if>
					</otherwise>
					</choose>
				</when>
				<otherwise>
					<if test="state != null and state != ''">
						AND a.state = #{state}
					</if>
				</otherwise>
			</choose>
		    
		  	<if test="vouch_type_code != null and vouch_type_code != ''">
				AND a.vouch_type_code = #{vouch_type_code}
			</if>
			<if test="vouch_no_b != null and vouch_no_b != ''">
				AND a.vouch_no &gt;= to_number(#{vouch_no_b})
			</if>
			<if test="vouch_no_e != null and vouch_no_e != ''">
				AND a.vouch_no &lt;= to_number(#{vouch_no_e})
			</if>
			<choose>
				<when test="money!=null and money != '' and sumMoney!=null and sumMoney  != ''">
					and ((b.debit &gt;=#{money} and b.debit &lt;=#{sumMoney}) or (b.credit &gt;=#{money} and b.credit&lt;=#{sumMoney}))
				</when>
				<otherwise>
					<if test="money!=null and money !=''">
						AND ((b.debit &gt;= #{money}) or (b.credit &gt;= #{money})) 
					</if>
					<if test="sumMoney != null and sumMoney  != ''"> 
						AND ((b.debit &lt;= #{sumMoney} ) or ( b.credit &lt;= #{sumMoney}))  
					</if>
				</otherwise>
			</choose>
			<choose>
				<when test="subj_code_b != null and subj_code_b != '' and  subj_code_e != null and subj_code_e != ''">
					and asubj.subj_code between #{subj_code_b} and '${subj_code_e}%'
				</when>
				<otherwise>
					<if test="subj_code_b != null and subj_code_b != ''">
						AND asubj.subj_code like '${subj_code_b}%'
					</if>
					<if test="subj_code_e != null and subj_code_e != ''">
						AND asubj.subj_code like '${subj_code_e}%'
					</if>
				</otherwise>
			</choose>
			<if test="create_user != null and create_user != ''">
				AND a.create_user = #{create_user}
			</if>			
			<if test="cash_user != null and cash_user != ''">
				AND a.cash_user = #{cash_user}
			</if>			
			<if test="audit_user != null and audit_user != ''">
				AND a.audit_user = #{audit_user}
			</if>			
			<if test="acc_user != null and acc_user != ''">
				AND a.acc_user = #{acc_user}
			</if>			
			<if test="summary != null and summary != ''">
				AND (b.summary like '%${summary}%' or exists (
				select * from acc_vouch_check avc where avc.group_id = b.group_id
			    and avc.hos_id = b.hos_id
			    and avc.copy_code = b.copy_code
			    and avc.vouch_id = b.vouch_id
			    and avc.vouch_detail_id = b.vouch_detail_id 
			    and avc.summary like '%${summary}%'
				))
			</if>
			<if test="cur_code != null and cur_code != ''">
				AND asubj.cur_code = #{cur_code}
			</if>			
			<if test='note =="1" '>
				and a.note is not null
			</if>
			<if test="sign_flag != null and sign_flag != ''">
				and nvl(a.sign_flag,0) =#{sign_flag}
			</if>
		  order by a.acc_year desc, a.acc_month desc, a.vouch_type_code, to_number(a.vouch_no),asubj.kind_code,b.vouch_row
		
		)
		select null as acc_year, null as acc_month, 0 as vouch_id, null as subj_name, ' ' as vouch_no
		  , to_date(null, 'yyyy-MM-dd') as vouch_date, to_date(null, 'yyyy-MM-dd') as create_date, null as create_name, null as cash_name, null as audit_name, null as acc_name 
		  , null create_user,null audit_user,null cash_user
		  , null as note,null as summary
		  , sum(debit) as debit, sum(credit) as credit, sum(debit_w) as debit_w, sum(credit_w) as credit_w, null as state
		  , null as busi_type_name, null as vouch_type_code,null as sign_flag
		from d_table
		union all
		select acc_year, acc_month, vouch_id,subj_name,vouch_no
		    , vouch_date, create_date,create_name,cash_name, audit_name, acc_name
		    , create_user,audit_user,cash_user
		    , note,summary
		    ,debit,credit,debit_w,credit_w,state
		    ,busi_type_name,vouch_type_code,sign_flag
		from d_table 
	</select>
	
	
	<!-- 出纳签字查询 停用 -->
	<select id="queryAccVouchCashier" parameterType="java.util.Map" resultMap="accVouch">
		select
		'' acc_year,'' acc_month,0 vouch_id,' ' vouch_no,to_date('','yyyy-MM-dd') vouch_date,to_date('','yyyy-MM-dd')
		create_date,
		'' create_name,'' cash_name,'' audit_name,'' cash_user,'' audit_user,'' acc_name,
		'' note
		,'合计' summary,sum(b.debit) debit
		,sum(b.credit) credit
		,sum(b.debit_w) debit_w,
		sum(b.credit_w) credit_w,9 state,'' busi_type_name,null vouch_type_code
		from acc_vouch a
		left join acc_vouch_detail b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
			and a.vouch_id=b.vouch_id
		left join sys_user c on a.group_id=c.group_id and a.hos_id=c.hos_id and a.create_user=c.user_id
		left join sys_user d on a.group_id=d.group_id and a.hos_id=d.hos_id and a.cash_user=d.user_id
		left join sys_user e on a.group_id=e.group_id and a.hos_id=e.hos_id and a.audit_user=e.user_id
		left join sys_user su on a.group_id=su.group_id and a.hos_id=su.hos_id and a.acc_user=su.user_id
		left join acc_vouch_type f on a.group_id=f.group_id and a.hos_id=f.hos_id and a.copy_code=f.copy_code
			and f.vouch_type_code=a.vouch_type_code
		left join acc_subj h on b.group_id=h.group_id and b.hos_id=h.hos_id and b.copy_code=h.copy_code 
			and b.subj_code=h.subj_code and b.acc_year=h.acc_year
		<where>
			<if test="vouch_id != null and vouch_id != ''">
				AND a.vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND a.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND a.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND a.copy_code = #{copy_code}
			</if>
			<if
				test="create_date_b != null and create_date_b != '' and create_date_e != null and create_date_e != ''">
				AND a.vouch_date between to_date(#{create_date_b},'yyyy-MM-dd')
				and to_date(#{create_date_e},'yyyy-MM-dd')
			</if>
			<if test="vouch_type_code != null and vouch_type_code != ''">
				AND a.vouch_type_code = #{vouch_type_code}
			</if>
			<if test="state != null and state != ''">
				AND a.state = #{state}
			</if>
			<if test="vouch_no_b != null and vouch_no_b != ''">
				AND a.vouch_no &gt;= to_number(#{vouch_no_b})
			</if>
			<if test="vouch_no_e != null and vouch_no_e != ''">
				AND a.vouch_no &lt;= to_number(#{vouch_no_e})
			</if>

			<!--if test="money != null and money != '' and sumMoney != null and sumMoney 
				!= ''"> AND (b.debit between #{money} and #{sumMoney} or b.credit between 
				#{money} and #{sumMoney}) </if -->
			<if test="money != null and money != '' ">
				AND (b.debit &gt;= #{money} or b.credit &gt;= #{money})
			</if>
			<if test="sumMoney != null and sumMoney != ''">
				AND (b.debit &lt;= #{sumMoney} or b.credit &lt;=
				#{sumMoney})
			</if>
			<!--if test="subj_code != null and subj_code != '' and subj_id != null 
				and subj_id != ''"> AND h.subj_code between #{subj_code} and #{subj_id} </if -->
			<if test="subj_code_b != null and subj_code_b != ''">
				AND h.subj_code like '${subj_code_b}%'
			</if>
			<if test="subj_code_e != null and subj_code_e != ''">
				AND h.subj_code like '${subj_code_e}%'
			</if>
			<!-- 下面2个不知道什么意思 -->
			<if test="vouch_att_num != null and vouch_att_num != ''">
				AND vouch_att_num = #{vouch_att_num}
			</if>
			<if test="vouch_id_cx != null and vouch_id_cx != ''">
				AND vouch_id_cx = #{vouch_id_cx}
			</if>
			<if test="create_user != null and create_user != ''">
				AND a.create_user = #{create_user}
			</if>
			<if test="create_date != null and create_date != ''">
				AND a.create_date = #{create_date}
			</if>
			<if test="cash_user != null and cash_user != ''">
				AND a.cash_user = #{cash_user}
			</if>
			<if test="cashe_date != null and cashe_date != ''">
				AND a.cashe_date = #{cashe_date}
			</if>
			<if test="audit_user != null and audit_user != ''">
				AND a.audit_user = #{audit_user}
			</if>
			<if test="audit_date != null and audit_date != ''">
				AND a.audit_date = #{audit_date}
			</if>
			<if test="acc_user != null and acc_user != ''">
				AND a.acc_user = #{acc_user}
			</if>
			<if test="acc_date != null and acc_date != ''">
				AND a.acc_date = #{acc_date}
			</if>
			<if test="summary != null and summary != ''">
				AND (b.summary like '%${summary}%' or exists(
		        select avc.summary from acc_vouch_check avc where avc.vouch_id =b.vouch_id and avc.vouch_detail_id =b.vouch_detail_id
		        and avc.group_id =b.group_id and avc.hos_id =b.hos_id and avc.copy_code =b.copy_code and avc.acc_year =b.acc_year
		        and avc.summary LIKE '%${summary}%'
		        ))
			</if>
			<if test="cur_code != null and cur_code != ''">
				AND h.cur_code = #{cur_code}
			</if>
			<!-- <if test="cur_code != null and cur_code != ''"> AND a.cur_code = 
				#{cur_code} </if> -->
			<if test="note != null and note != '' ">
				AND (#{note} = 0 or (${note} = 1 and a.note != 'NULL'))
			</if>
			<if test="cnqz != null and znqz != ''">
				and exists (select 1 from acc_subj where b.acc_year=acc_subj.acc_year and b.subj_code = acc_subj.subj_code and acc_subj.subj_nature_code in ('02','03'))
			</if>
		</where>
		union all	
	
		select * from (
			select a.acc_year,a.acc_month,a.vouch_id,f.vouch_type_short||'-'||a.vouch_no vouch_no,a.vouch_date,a.create_date,c.user_name
				create_name,d.user_name cash_name,e.user_name
				audit_name,to_char(a.cash_user) cash_user,to_char(a.audit_user) audit_user,su.user_name
				acc_name,a.note ,min(b.summary) summary,sum(b.debit)
				debit,sum(b.credit) credit ,sum(b.debit_w)
				debit_w,sum(b.credit_w) credit_w,a.state,
				bt.busi_type_name
				,a.vouch_type_code
			from acc_vouch a
			left join acc_vouch_detail b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
				and a.vouch_id=b.vouch_id
			left join sys_user c on a.group_id=c.group_id and a.hos_id=c.hos_id and a.create_user=c.user_id
			left join sys_user d on a.group_id=d.group_id and a.hos_id=d.hos_id and a.cash_user=d.user_id
			left join sys_user e on a.group_id=e.group_id and a.hos_id=e.hos_id and a.audit_user=e.user_id
			left join sys_user su on a.group_id=su.group_id and a.hos_id=su.hos_id and a.acc_user=su.user_id
			left join acc_vouch_type f on a.group_id=f.group_id and a.hos_id=f.hos_id and a.copy_code=f.copy_code 
				and f.vouch_type_code=a.vouch_type_code
			left join acc_subj h on b.group_id=h.group_id and b.hos_id=h.hos_id and b.copy_code=h.copy_code 
				and b.subj_code=h.subj_code and a.acc_year=h.acc_year
			left join acc_busi_type bt on bt.group_id=a.group_id and bt.hos_id=a.hos_id 
				and bt.copy_code=a.copy_code and a.busi_type_code=bt.busi_type_code
			<where>
			<if test="vouch_id != null and vouch_id != ''">
				AND a.vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND a.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND a.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND a.copy_code = #{copy_code}
			</if>
			<if
				test="create_date_b != null and create_date_b != '' and create_date_e != null and create_date_e != ''">
				AND a.vouch_date between to_date(#{create_date_b},'yyyy-MM-dd')
				and
				to_date(#{create_date_e},'yyyy-MM-dd')
			</if>
			<if test="vouch_type_code != null and vouch_type_code != ''">
				AND a.vouch_type_code = #{vouch_type_code}
			</if>
			<if test="state != null and state != ''">
				AND a.state = #{state}
			</if>
			<if test="vouch_no_b != null and vouch_no_b != ''">
				AND a.vouch_no &gt;= to_number(#{vouch_no_b})
			</if>
			<if test="vouch_no_e != null and vouch_no_e != ''">
				AND a.vouch_no &lt;= to_number(#{vouch_no_e})
			</if>

			<!--if test="money != null and money != '' and sumMoney != null and sumMoney 
				!= ''"> AND (b.debit between #{money} and #{sumMoney} or b.credit between 
				#{money} and #{sumMoney}) </if -->
			<if test="money != null and money != '' ">
				AND (b.debit &gt;= #{money} or b.credit &gt;= #{money})
			</if>
			<if test="sumMoney != null and sumMoney != ''">
				AND (b.debit &lt;= #{sumMoney} or b.credit &lt;=
				#{sumMoney})
			</if>
			<!--if test="subj_code != null and subj_code != '' and subj_id != null 
				and subj_id != ''"> AND h.subj_code between #{subj_code} and #{subj_id} </if -->
			<if test="subj_code_b != null and subj_code_b != ''">
				AND h.subj_code like '${subj_code_b}%'
			</if>
			<if test="subj_code_e != null and subj_code_e != ''">
				AND h.subj_code like '${subj_code_e}%'
			</if>
			<!-- 下面2个不知道什么意思 -->
			<if test="vouch_att_num != null and vouch_att_num != ''">
				AND vouch_att_num = #{vouch_att_num}
			</if>
			<if test="vouch_id_cx != null and vouch_id_cx != ''">
				AND vouch_id_cx = #{vouch_id_cx}
			</if>
			<if test="create_user != null and create_user != ''">
				AND a.create_user = #{create_user}
			</if>
			<if test="create_date != null and create_date != ''">
				AND a.create_date = #{create_date}
			</if>
			<if test="cash_user != null and cash_user != ''">
				AND a.cash_user = #{cash_user}
			</if>
			<if test="cashe_date != null and cashe_date != ''">
				AND a.cashe_date = #{cashe_date}
			</if>
			<if test="audit_user != null and audit_user != ''">
				AND a.audit_user = #{audit_user}
			</if>
			<if test="audit_date != null and audit_date != ''">
				AND a.audit_date = #{audit_date}
			</if>
			<if test="acc_user != null and acc_user != ''">
				AND a.acc_user = #{acc_user}
			</if>
			<if test="acc_date != null and acc_date != ''">
				AND a.acc_date = #{acc_date}
			</if>
			<if test="summary != null and summary != ''">
				AND (b.summary like '%${summary}%' or exists(
		        select avc.summary from acc_vouch_check avc where avc.vouch_id =b.vouch_id and avc.vouch_detail_id =b.vouch_detail_id
		        and avc.group_id =b.group_id and avc.hos_id =b.hos_id and avc.copy_code =b.copy_code and avc.acc_year =b.acc_year
		        and avc.summary LIKE '%${summary}%'
		        ))
			</if>
			<if test="cur_code != null and cur_code != ''">
				AND h.cur_code = #{cur_code}
			</if>
			<!-- <if test="cur_code != null and cur_code != ''"> AND a.cur_code = 
				#{cur_code} </if> -->
			<if test="note != null and note != '' ">
				AND (#{note} = 0 or (${note} = 1 and a.note != 'NULL'))
			</if>
			<if test="cnqz != null and znqz != ''">
				and exists (select 1 from acc_subj where b.subj_code = acc_subj.subj_code and acc_subj.subj_nature_code in ('02','03'))
			</if>
		</where>
		group by a.vouch_id,f.vouch_type_short,a.vouch_no,a.vouch_date,a.create_date,a.acc_year,a.acc_month,
			c.user_name,d.user_name,e.user_name,a.acc_user,a.note,a.state,su.user_name,a.busi_type_code,bt.busi_type_name,a.cash_user,a.audit_user,a.vouch_type_code
		order by a.acc_year desc,a.acc_month desc,a.vouch_type_code desc,to_number(a.vouch_no) desc
		)a 
		
		
	</select>
	
	<!-- 凭证审核-->
	<select id="queryAccVouchAudit" parameterType="java.util.Map" resultMap="accVouch1">
		--查询条件中金额范围不起作用
		with t_tmp as (
			select acc_year,acc_month,vouch_id,vouch_no,vouch_date,create_date,create_name,create_user,cash_name,audit_name,
				audit_user,acc_name,note,summary,debit,credit,debit_w,credit_w,state,busi_type_name,vouch_type_code
			from (
				select
					a.acc_year,a.acc_month,a.vouch_id,f.vouch_type_short||'-'||a.vouch_no vouch_no,a.vouch_date,a.create_date,
					c.user_name create_name,to_char(a.create_user) create_user,d.user_name cash_name,
					e.user_name audit_name,to_char(a.audit_user) audit_user,su.user_name acc_name,a.note,min(b.summary)
					summary,sum(b.debit) debit,sum(b.credit) credit ,sum(b.debit_w) debit_w,sum(b.credit_w) credit_w,a.state,
					bt.busi_type_name,a.vouch_type_code
				from acc_vouch a
				left join acc_vouch_detail b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
					and a.vouch_id=b.vouch_id
				left join sys_user c on a.group_id=c.group_id and a.hos_id=c.hos_id and a.create_user=c.user_id
				left join sys_user d on a.group_id=d.group_id and a.hos_id=d.hos_id and a.cash_user=d.user_id
				left join sys_user e on a.group_id=e.group_id and a.hos_id=e.hos_id and a.audit_user=e.user_id
				left join sys_user su on a.group_id=su.group_id and a.hos_id=su.hos_id and a.acc_user=su.user_id
				left join acc_vouch_type f on a.group_id=f.group_id and a.hos_id=f.hos_id and a.copy_code=f.copy_code
					and f.vouch_type_code=a.vouch_type_code
				left join acc_subj h on b.group_id=h.group_id and b.hos_id=h.hos_id and b.copy_code=h.copy_code and
					b.acc_year=h.acc_year and b.subj_code=h.subj_code
				left join acc_busi_type bt on bt.group_id=a.group_id and bt.hos_id=a.hos_id 
					and bt.copy_code=a.copy_code and a.busi_type_code=bt.busi_type_code
				<where>
					<if test="vouch_id != null and vouch_id != ''">
						AND a.vouch_id = #{vouch_id}
					</if>
					<if test="group_id != null and group_id != ''">
						AND a.group_id = #{group_id}
					</if>
					<if test="hos_id != null and hos_id != ''">
						AND a.hos_id = #{hos_id}
					</if>
					<if test="copy_code != null and copy_code != ''">
						AND a.copy_code = #{copy_code}
					</if>
					<if test="create_date_b != null and create_date_b != '' and create_date_e != null and create_date_e != ''">
						AND a.vouch_date between to_date(#{create_date_b},'yyyy-MM-dd') and to_date(#{create_date_e},'yyyy-MM-dd')
					</if>
					<if test="vouch_type_code != null and vouch_type_code != ''">
						AND a.vouch_type_code = #{vouch_type_code}
					</if>
					<if test="state != null and state != ''">
						AND a.state = #{state}
					</if>
					<if test="falg != null and falg != ''">
						<if test="falg == 2 ">
							AND a.state &lt;3
						</if> 
						<if test="falg == 1 ">
							AND a.state &gt;= 3
						</if>
					</if>
					<if test="vouch_no_b != null and vouch_no_b != ''">
						AND a.vouch_no &gt;= to_number(#{vouch_no_b})
					</if>
					<if test="vouch_no_e != null and vouch_no_e != ''">
						AND a.vouch_no &lt;= to_number(#{vouch_no_e})
					</if>
		
					<!--if test="money != null and money != '' and sumMoney != null and sumMoney 
						!= ''"> AND (b.debit between #{money} and #{sumMoney} or b.credit between 
						#{money} and #{sumMoney}) </if -->
					<!-- <if test="money != null and money != '' ">
						AND (b.debit &gt;= #{money} or b.credit &gt;= #{money})
					</if>
					<if test="sumMoney != null and sumMoney != ''">
						AND (b.debit &lt;= #{sumMoney} or b.credit &lt;=
						#{sumMoney})
					</if> -->			
					<if test="subj_code_b != null and subj_code_b != ''">
						AND h.subj_code like '${subj_code_b}%'
					</if>
					<if test="subj_code_e != null and subj_code_e != ''">
						AND h.subj_code like '${subj_code_e}%'
					</if>
					<!-- 下面2个不知道什么意思 -->
					<if test="vouch_att_num != null and vouch_att_num != ''">
						AND vouch_att_num = #{vouch_att_num}
					</if>
					<if test="vouch_id_cx != null and vouch_id_cx != ''">
						AND vouch_id_cx = #{vouch_id_cx}
					</if>
					<if test="create_user != null and create_user != ''">
						AND a.create_user = #{create_user}
					</if>
					<if test="create_date != null and create_date != ''">
						AND a.create_date = #{create_date}
					</if>
					<if test="cash_user != null and cash_user != ''">
						AND a.cash_user = #{cash_user}
					</if>
					<if test="cashe_date != null and cashe_date != ''">
						AND a.cashe_date = #{cashe_date}
					</if>
					<if test="audit_user != null and audit_user != ''">
						AND a.audit_user = #{audit_user}
					</if>
					<if test="audit_date != null and audit_date != ''">
						AND a.audit_date = #{audit_date}
					</if>
					<if test="acc_user != null and acc_user != ''">
						AND a.acc_user = #{acc_user}
					</if>
					<if test="acc_date != null and acc_date != ''">
						AND a.acc_date = #{acc_date}
					</if>
					<if test="summary != null and summary != ''">
						AND (b.summary like '%${summary}%' or exists(
				        select avc.summary from acc_vouch_check avc where avc.vouch_id =b.vouch_id and avc.vouch_detail_id =b.vouch_detail_id
				        and avc.group_id =b.group_id and avc.hos_id =b.hos_id and avc.copy_code =b.copy_code and avc.acc_year =b.acc_year
				        and avc.summary LIKE '%${summary}%'
				        ))
					</if>
					<if test="cur_code != null and cur_code != ''">
						AND h.cur_code = #{cur_code}
					</if>
					<!-- <if test="cur_code != null and cur_code != ''"> AND a.cur_code = 
						#{cur_code} </if> -->
					<if test="note != null and note != '' ">
						AND (#{note} = 0 or (${note} = 1 and a.note != 'NULL'))
					</if>
				</where>
				group by
				a.vouch_id,f.vouch_type_short,a.vouch_no,a.vouch_date,a.create_date,a.acc_year,a.acc_month,a.create_user,
				c.user_name,d.user_name,e.user_name,a.acc_user,a.audit_user,a.note,a.state,su.user_name,a.busi_type_code,bt.busi_type_name,a.vouch_type_code
				order by a.acc_year desc,a.acc_month desc,a.vouch_type_code desc,to_number(a.vouch_no) desc				
			) a 
			<where>
				<if test="money != null and money != '' ">
					AND (a.debit &gt;= #{money} or a.credit &gt;= #{money})
				</if>
				<if test="sumMoney != null and sumMoney != ''">
					AND (a.debit &lt;= #{sumMoney} or a.credit &lt;= #{sumMoney})
				</if>
			</where>
		)
		
		select '' acc_year,'' acc_month,0 vouch_id,' ' vouch_no,to_date('','yyyy-MM-dd') vouch_date,to_date('','yyyy-MM-dd')
			create_date, '' create_name,'' create_user,'' cash_name,'' audit_name,'' audit_user,'' acc_name,'' note ,'合计' summary,sum(debit) debit
			,sum(credit) credit ,sum(debit_w) debit_w, sum(credit_w) credit_w,9 state,'' busi_type_name,null vouch_type_coce
		from t_tmp 
		union all
		select acc_year,acc_month,vouch_id,vouch_no,vouch_date,create_date,create_name,create_user,cash_name,audit_name,
			audit_user,acc_name,note,summary,debit,credit,debit_w,credit_w,state,busi_type_name,vouch_type_code
		from t_tmp 
		
		<!-- select '' acc_year,'' acc_month,0 vouch_id,' ' vouch_no,to_date('','yyyy-MM-dd') vouch_date,to_date('','yyyy-MM-dd')
			create_date, '' create_name,'' create_user,'' cash_name,'' audit_name,'' audit_user,'' acc_name,'' note ,'合计' summary,sum(b.debit) debit
			,sum(b.credit) credit ,sum(b.debit_w) debit_w, sum(b.credit_w) credit_w,9 state,'' busi_type_name,null vouch_type_coce
		from acc_vouch a
		left join acc_vouch_detail b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code and a.vouch_id=b.vouch_id
		left join sys_user c on a.group_id=c.group_id and a.hos_id=c.hos_id and a.create_user=c.user_id
		left join sys_user d on a.group_id=d.group_id and a.hos_id=d.hos_id and a.cash_user=d.user_id
		left join sys_user e on a.group_id=e.group_id and a.hos_id=e.hos_id and a.audit_user=e.user_id
		left join sys_user su on a.group_id=su.group_id and a.hos_id=su.hos_id and a.acc_user=su.user_id
		left join acc_vouch_type f on a.group_id=f.group_id and a.hos_id=f.hos_id and a.copy_code=f.copy_code
			and f.vouch_type_code=a.vouch_type_code
		left join acc_subj h on b.group_id=h.group_id and b.hos_id=h.hos_id and b.copy_code=h.copy_code and
			b.acc_year=h.acc_year and b.subj_code=h.subj_code
		<where>
			<if test="vouch_id != null and vouch_id != ''">
				AND a.vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND a.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND a.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND a.copy_code = #{copy_code}
			</if>
			<if
				test="create_date_b != null and create_date_b != '' and create_date_e != null and create_date_e != ''">
				AND a.vouch_date between to_date(#{create_date_b},'yyyy-MM-dd')
				and
				to_date(#{create_date_e},'yyyy-MM-dd')
			</if>
			<if test="vouch_type_code != null and vouch_type_code != ''">
				AND a.vouch_type_code = #{vouch_type_code}
			</if>
			<if test="state!= null and state == 0">
				AND a.state &lt; 3
			</if>
			<if test="state!= null and state == 1">
				AND a.state = 3
			</if>
			<if test="vouch_no_b != null and vouch_no_b != ''">
				AND a.vouch_no &gt;= to_number(#{vouch_no_b})
			</if>
			<if test="vouch_no_e != null and vouch_no_e != ''">
				AND a.vouch_no &lt;= to_number(#{vouch_no_e})
			</if>

			if test="money != null and money != '' and sumMoney != null and sumMoney 
				!= ''"> AND (b.debit between #{money} and #{sumMoney} or b.credit between 
				#{money} and #{sumMoney}) </if
			<if test="money != null and money != '' ">
				AND (b.debit &gt;= #{money} or b.credit &gt;= #{money})
			</if>
			<if test="sumMoney != null and sumMoney != ''">
				AND (b.debit &lt;= #{sumMoney} or b.credit &lt;=
				#{sumMoney})
			</if>		
			<if test="subj_code_b != null and subj_code_b != ''">
				AND h.subj_code like '${subj_code_b}%'
			</if>
			<if test="subj_code_e != null and subj_code_e != ''">
				AND h.subj_code like '${subj_code_e}%'
			</if>
			下面2个不知道什么意思
			<if test="vouch_att_num != null and vouch_att_num != ''">
				AND vouch_att_num = #{vouch_att_num}
			</if>
			<if test="vouch_id_cx != null and vouch_id_cx != ''">
				AND vouch_id_cx = #{vouch_id_cx}
			</if>
			<if test="create_user != null and create_user != ''">
				AND a.create_user = #{create_user}
			</if>
			<if test="create_date != null and create_date != ''">
				AND a.create_date = #{create_date}
			</if>
			<if test="cash_user != null and cash_user != ''">
				AND a.cash_user = #{cash_user}
			</if>
			<if test="cashe_date != null and cashe_date != ''">
				AND a.cashe_date = #{cashe_date}
			</if>
			<if test="audit_user != null and audit_user != ''">
				AND a.audit_user = #{audit_user}
			</if>
			<if test="audit_date != null and audit_date != ''">
				AND a.audit_date = #{audit_date}
			</if>
			<if test="acc_user != null and acc_user != ''">
				AND a.acc_user = #{acc_user}
			</if>
			<if test="acc_date != null and acc_date != ''">
				AND a.acc_date = #{acc_date}
			</if>
			<if test="summary != null and summary != ''">
				AND (b.summary like '%${summary}%' or exists(
		        select avc.summary from acc_vouch_check avc where avc.vouch_id =b.vouch_id and avc.vouch_detail_id =b.vouch_detail_id
		        and avc.group_id =b.group_id and avc.hos_id =b.hos_id and avc.copy_code =b.copy_code and avc.acc_year =b.acc_year
		        and avc.summary LIKE '%${summary}%'
		        ))
			</if>
			<if test="cur_code != null and cur_code != ''">
				AND h.cur_code = #{cur_code}
			</if>
			<if test="cur_code != null and cur_code != ''"> AND a.cur_code = 
				#{cur_code} </if>
			<if test="note != null and note != '' ">
				AND (#{note} = 0 or (${note} = 1 and a.note != 'NULL'))
			</if>
		</where>
		union all
		select * from (
			select
			a.acc_year,a.acc_month,a.vouch_id,f.vouch_type_short||'-'||a.vouch_no vouch_no,a.vouch_date,a.create_date,
			c.user_name create_name,to_char(a.create_user) create_user,d.user_name cash_name,
			e.user_name
			audit_name,to_char(a.audit_user) audit_user,su.user_name acc_name,a.note
			,min(b.summary)
			summary,sum(b.debit) debit
			,sum(b.credit) credit ,sum(b.debit_w)
			debit_w,
			sum(b.credit_w) credit_w,a.state,
			bt.busi_type_name
			,a.vouch_type_code
			from acc_vouch a
			left join acc_vouch_detail b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
				and a.vouch_id=b.vouch_id
			left join sys_user c on a.group_id=c.group_id and a.hos_id=c.hos_id and a.create_user=c.user_id
			left join sys_user d on a.group_id=d.group_id and a.hos_id=d.hos_id and a.cash_user=d.user_id
			left join sys_user e on a.group_id=e.group_id and a.hos_id=e.hos_id and a.audit_user=e.user_id
			left join sys_user su on a.group_id=su.group_id and a.hos_id=su.hos_id and a.acc_user=su.user_id
			left join acc_vouch_type f on a.group_id=f.group_id and a.hos_id=f.hos_id and a.copy_code=f.copy_code
				and f.vouch_type_code=a.vouch_type_code
			left join acc_subj h on b.group_id=h.group_id and b.hos_id=h.hos_id and b.copy_code=h.copy_code and
				b.acc_year=h.acc_year and b.subj_code=h.subj_code
			left join acc_busi_type bt on bt.group_id=a.group_id and bt.hos_id=a.hos_id 
				and bt.copy_code=a.copy_code and a.busi_type_code=bt.busi_type_code
			<where>
				<if test="vouch_id != null and vouch_id != ''">
					AND a.vouch_id = #{vouch_id}
				</if>
				<if test="group_id != null and group_id != ''">
					AND a.group_id = #{group_id}
				</if>
				<if test="hos_id != null and hos_id != ''">
					AND a.hos_id = #{hos_id}
				</if>
				<if test="copy_code != null and copy_code != ''">
					AND a.copy_code = #{copy_code}
				</if>
				<if
					test="create_date_b != null and create_date_b != '' and create_date_e != null and create_date_e != ''">
					AND a.vouch_date between to_date(#{create_date_b},'yyyy-MM-dd')
					and
					to_date(#{create_date_e},'yyyy-MM-dd')
				</if>
				<if test="vouch_type_code != null and vouch_type_code != ''">
					AND a.vouch_type_code = #{vouch_type_code}
				</if>
				<if test="state!= null and state == 0">
					AND a.state &lt; 3
				</if>
				<if test="state!= null and state == 1">
					AND a.state = 3
				</if>
				<if test="vouch_no_b != null and vouch_no_b != ''">
					AND a.vouch_no &gt;= to_number(#{vouch_no_b})
				</if>
				<if test="vouch_no_e != null and vouch_no_e != ''">
					AND a.vouch_no &lt;= to_number(#{vouch_no_e})
				</if>
	
				if test="money != null and money != '' and sumMoney != null and sumMoney 
					!= ''"> AND (b.debit between #{money} and #{sumMoney} or b.credit between 
					#{money} and #{sumMoney}) </if
				<if test="money != null and money != '' ">
					AND (b.debit &gt;= #{money} or b.credit &gt;= #{money})
				</if>
				<if test="sumMoney != null and sumMoney != ''">
					AND (b.debit &lt;= #{sumMoney} or b.credit &lt;=
					#{sumMoney})
				</if>			
				<if test="subj_code_b != null and subj_code_b != ''">
					AND h.subj_code like '${subj_code_b}%'
				</if>
				<if test="subj_code_e != null and subj_code_e != ''">
					AND h.subj_code like '${subj_code_e}%'
				</if>
				下面2个不知道什么意思
				<if test="vouch_att_num != null and vouch_att_num != ''">
					AND vouch_att_num = #{vouch_att_num}
				</if>
				<if test="vouch_id_cx != null and vouch_id_cx != ''">
					AND vouch_id_cx = #{vouch_id_cx}
				</if>
				<if test="create_user != null and create_user != ''">
					AND a.create_user = #{create_user}
				</if>
				<if test="create_date != null and create_date != ''">
					AND a.create_date = #{create_date}
				</if>
				<if test="cash_user != null and cash_user != ''">
					AND a.cash_user = #{cash_user}
				</if>
				<if test="cashe_date != null and cashe_date != ''">
					AND a.cashe_date = #{cashe_date}
				</if>
				<if test="audit_user != null and audit_user != ''">
					AND a.audit_user = #{audit_user}
				</if>
				<if test="audit_date != null and audit_date != ''">
					AND a.audit_date = #{audit_date}
				</if>
				<if test="acc_user != null and acc_user != ''">
					AND a.acc_user = #{acc_user}
				</if>
				<if test="acc_date != null and acc_date != ''">
					AND a.acc_date = #{acc_date}
				</if>
				<if test="summary != null and summary != ''">
					AND (b.summary like '%${summary}%' or exists(
			        select avc.summary from acc_vouch_check avc where avc.vouch_id =b.vouch_id and avc.vouch_detail_id =b.vouch_detail_id
			        and avc.group_id =b.group_id and avc.hos_id =b.hos_id and avc.copy_code =b.copy_code and avc.acc_year =b.acc_year
			        and avc.summary LIKE '%${summary}%'
			        ))
				</if>
				<if test="cur_code != null and cur_code != ''">
					AND h.cur_code = #{cur_code}
				</if>
				<if test="cur_code != null and cur_code != ''"> AND a.cur_code = 
					#{cur_code} </if>
				<if test="note != null and note != '' ">
					AND (#{note} = 0 or (${note} = 1 and a.note != 'NULL'))
				</if>
			</where>
			group by
			a.vouch_id,f.vouch_type_short,a.vouch_no,a.vouch_date,a.create_date,a.acc_year,a.acc_month,a.create_user,
			c.user_name,d.user_name,e.user_name,a.acc_user,a.audit_user,a.note,a.state,su.user_name,a.busi_type_code,bt.busi_type_name,a.vouch_type_code
			order by a.acc_year desc,a.acc_month desc,a.vouch_type_code desc,to_number(a.vouch_no) desc				
		)a  -->
	</select>
	
	<select id="queryAccVouchCashFlow" parameterType="java.util.Map" resultMap="accVouch1">
		SELECT av.group_id, av.hos_id, av.copy_code, 
			avt.vouch_type_short || '-' || av.vouch_no AS vouch_no,
			avd.vouch_detail_id, av.vouch_id, av.vouch_date, avd.summary, 
			asubj.subj_code || ' ' || asubj.subj_name AS subj_name, 
			case when avd.debit &lt;&gt; 0 then acf.cash_money else 0 end debit,
      		case when avd.credit &lt;&gt; 0 then acf.cash_money else 0 end credit,
      		av.state,aci.cash_item_name || '@' || aci.cash_dire cash_item_name,
      		aci.cash_item_id
		FROM acc_vouch av
		LEFT JOIN acc_vouch_detail avd 
			ON av.group_id = avd.group_id
			AND av.hos_id =avd.hos_id
			AND av.copy_code = avd.copy_code
			AND av.acc_year =avd.acc_year
			AND av.vouch_id = avd.vouch_id
		LEFT JOIN acc_subj asubj 
			ON asubj.group_id = avd.group_id
			AND asubj.hos_id = avd.hos_id
			AND asubj.copy_code = avd.copy_code
			AND asubj.subj_code = avd.subj_code
			AND asubj.acc_year = avd.acc_year
		LEFT JOIN acc_vouch_type avt 
			ON av.group_id = avt.group_id
			AND av.hos_id = avt.hos_id
			AND av.copy_code = avt.copy_code
			AND av.vouch_type_code = avt.vouch_type_code
		left join ACC_CASH_FLOW acf 
			on  acf.group_id = avd.group_id
		    and acf.hos_id = avd.hos_id
		    and acf.copy_code = avd.copy_code
		    and acf.vouch_detail_id = avd.vouch_detail_id
		    and acf.vouch_id = avd.vouch_id
	    left join acc_cash_item aci 
	    	on acf.group_id = aci.group_id
		    and acf.hos_id = aci.hos_id
		    and acf.copy_code = aci.copy_code
		    and acf.cash_item_id = aci.cash_item_id 
		WHERE av.group_id = #{group_id}
			AND av.hos_id =#{hos_id}
			AND av.copy_code = #{copy_code}
			AND av.acc_year = #{acc_year}
			AND av.acc_month = #{acc_month}
			and asubj.is_cash=1
			and av.state>0
			<if test='cash_flow_state != null and cash_flow_state == "0"'>
				and not exists(
				select 1 from ACC_CASH_FLOW acf where
				acf.group_id = avd.group_id AND
				acf.hos_id = avd.hos_id AND
				acf.copy_code = avd.copy_code and
				acf.vouch_detail_id=avd.vouch_detail_id
				)
			</if>
			<if test='cash_flow_state != null and cash_flow_state == "1"'>
				and exists(
				select 1 from ACC_CASH_FLOW acf where
				acf.group_id = avd.group_id AND
				acf.hos_id = avd.hos_id AND
				acf.copy_code = avd.copy_code and
				acf.vouch_detail_id=avd.vouch_detail_id
				)
			</if>
			<if test='cash_flow_state != null and cash_flow_state == "2"'>
				and exists(
				select sum(acf.cash_money),acf.vouch_detail_id cash_money 
				from ACC_CASH_FLOW acf 
				where acf.group_id = avd.group_id
					AND acf.hos_id = avd.hos_id
					AND acf.copy_code = avd.copy_code 
					and acf.vouch_detail_id=avd.vouch_detail_id
				group by acf.vouch_detail_id
				having (sum(acf.cash_money) !=avd.debit and avd.credit=0) or
				(sum(acf.cash_money)!=avd.credit and avd.debit=0)
				)
			</if>
			<if test='cash_flow_state != null and cash_flow_state == "3"'>
				and exists(
		        select 1 from
		        ACC_CASH_FLOW acf 
		        LEFT JOIN ACC_CASH_ITEM item ON item.cash_item_id = acf.cash_item_id
		        and item.group_id = acf.group_id and  item.hos_id = acf.hos_id
		        and item.copy_code = acf.copy_code
		        where acf.group_id = avd.group_id
		        AND acf.hos_id =  avd.hos_id
		        AND acf.copy_code = avd.copy_code and
		        acf.vouch_detail_id=avd.vouch_detail_id
		        and 
		       (
		          <!-- 分录借方金额不等于0并且大于0 表示流入 记贷方（流出）表示流入流出不等 -->
		          (
		            avd.debit &lt;&gt; 0 and avd.debit >0          
		            and item.cash_dire=1 
		          )
		          
		          or   <!-- 分录借方金额不等于0并且小于0 表示流出 记借方（流入）表示流入流出不等 -->
		          (
		            avd.debit &lt;&gt; 0 and avd.debit &lt; 0          
		            and item.cash_dire=0 
		          )
		          or   <!-- 分录贷方金额不等于0并且大于0 表示流出 记借方（流入）表示流入流出不等 -->
		          (
		            avd.credit &lt;&gt; 0 and avd.credit >0          
		            and item.cash_dire=0 
		          )
		          or   <!-- 分录贷方金额不等于0并且小于0 表示流入 记贷方（流出）表示流入流出不等 -->
		          (
		            avd.credit &lt;&gt; 0 and avd.credit &lt; 0          
		            and item.cash_dire=1 
		          )
		        ) 
		        )
			</if>
		order by av.vouch_type_code,to_number(av.vouch_no) desc,avd.vouch_row
	</select>
	
	<select id="queryAccVouchAccounting" parameterType="java.util.Map" resultType="com.chd.hrp.acc.entity.AccVouch">
		select
			a.group_id,a.hos_id,a.copy_code,a.vouch_id, to_char(WM_CONCAT(b.subj_code)) subj_code,a.acc_year,a.acc_month,
			f.vouch_type_name,f.vouch_type_short,a.vouch_no,a.create_date,c.user_name
			create_name,d.user_name cash_name,e.user_name
			audit_name,a.acc_user,b.summary,sum(b.debit) debit, sum(b.credit) credit,a.vouch_date,accu.user_name as acc_name,a.note
		from acc_vouch a
		left join acc_vouch_detail b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
			and a.vouch_id=b.vouch_id
		left join sys_user c on a.group_id=c.group_id and a.hos_id=c.hos_id and a.create_user=c.user_id
		left join sys_user d on a.group_id=d.group_id and a.hos_id=d.hos_id and a.cash_user=d.user_id
		left join sys_user e on a.group_id=e.group_id and a.hos_id=e.hos_id and a.audit_user=e.user_id
		left join acc_vouch_type f on a.group_id=f.group_id and a.hos_id=f.hos_id and a.copy_code=f.copy_code
			and f.vouch_type_code=a.vouch_type_code
		left join sys_user accu
		  on
		       a.group_id = accu.group_id
		       and a.hos_id = accu.hos_id
		       and a.copy_code = accu.copy_code
		       and a.acc_user = accu.user_id
		       and accu.is_stop = 0
		<!-- left join acc_vouch_state g on a.group_id=g.group_id and a.hos_id=g.hos_id 
			and a.copy_code=g.copy_code -->
		<where>
			a.state = '99'
			<if test="group_id != null and group_id != ''">
				AND a.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND a.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND a.copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND a.acc_year = #{acc_year}
			</if>
			<if test="acc_month != null and acc_month != ''">
				AND a.acc_month = #{acc_month}
			</if>
			<if test="vouch_type_code != null and vouch_type_code != ''">
				AND a.vouch_type_code = #{vouch_type_code}
			</if>
		</where>
		group BY a.group_id,a.hos_id,a.copy_code,a.vouch_id,a.acc_year, a.acc_month, f.vouch_type_name, f.vouch_type_short, a.vouch_no
		,a.create_date, c.user_name , d.user_name , e.user_name , a.acc_user ,b.summary, a.vouch_date,accu.user_name,a.note
		order by f.vouch_type_short,to_number(a.vouch_no) desc,a.vouch_date asc

	</select>
	<select id="queryAccVouchUnAccounting" parameterType="java.util.Map"
		resultType="com.chd.hrp.acc.entity.AccVouch">
		select
		a.group_id,a.hos_id,a.copy_code,a.vouch_id, to_char(WM_CONCAT(b.subj_code)) subj_code,a.acc_year,a.acc_month
		,f.vouch_type_name,f.vouch_type_short,a.vouch_no,c.user_name
		create_name,d.user_name cash_name,e.user_name
		audit_name,a.acc_user,max(b.summary) summary,sum(b.debit) debit, sum(b.credit)
		credit
		from acc_vouch a
		left join
		acc_vouch_detail b on
		a.group_id=b.group_id and
		a.hos_id=b.hos_id and
		a.copy_code=b.copy_code
		and a.vouch_id=b.vouch_id
		left join sys_user c
		on a.group_id=c.group_id
		and a.hos_id=c.hos_id and
		a.create_user=c.user_id
		left join sys_user d
		on a.group_id=d.group_id
		and a.hos_id=d.hos_id and
		a.cash_user=d.user_id
		left join sys_user e
		on a.group_id=e.group_id
		and
		a.hos_id=e.hos_id and
		a.audit_user=e.user_id
		left join
		acc_vouch_type f
		on
		a.group_id=f.group_id and a.hos_id=f.hos_id
		and
		a.copy_code=f.copy_code
		and f.vouch_type_code=a.vouch_type_code
		<!-- left join acc_vouch_state g on a.group_id=g.group_id and a.hos_id=g.hos_id 
			and a.copy_code=g.copy_code -->
		<where>
			a.state != '99'
			<if test="group_id != null and group_id != ''">
				AND a.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND a.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND a.copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND a.acc_year||'.'||a.acc_month = #{acc_year}
			</if>
			<if test="vouch_type_code != null and vouch_type_code != ''">
				AND a.vouch_type_code = #{vouch_type_code}
			</if>
		</where>
		group BY a.group_id,a.hos_id,a.copy_code,a.vouch_id,a.acc_year,
		a.acc_month, f.vouch_type_name, f.vouch_type_short, a.vouch_no
		, c.user_name , d.user_name , e.user_name , a.acc_user
		order by
		f.vouch_type_short,to_number(a.vouch_no) desc

	</select>
	<select id="queryAccVouchAccountingCount" parameterType="java.util.Map"
		resultType="com.chd.hrp.acc.entity.AccVouch">
		select
		t.group_id,t.hos_id,t.copy_code,t.acc_year,t.acc_month,t.vouch_type_code,vouch_type_name,sum(acc_state)
		acc_state,sum(unacc_state) unacc_state from (
		select
		group_id,hos_id,copy_code,a.acc_year,a.acc_month
		,a.vouch_type_code,count(a.vouch_no) acc_state,0 unacc_state
		from
		acc_vouch a
		where a.state=4
		AND a.group_id = #{group_id}
		AND a.hos_id =
		#{hos_id}
		AND a.copy_code = #{copy_code}
		AND a.acc_year = #{acc_year}
		AND a.acc_month = #{acc_month}
		group by
		group_id,hos_id,copy_code,a.acc_year,a.acc_month
		,a.vouch_type_code
		union all
		select group_id,hos_id,copy_code,a.acc_year,a.acc_month
		,a.vouch_type_code,0
		acc_state,count(a.vouch_no) unacc_state
		from
		acc_vouch a
		where a.state!=4
		AND a.group_id = #{group_id}
		AND a.hos_id =
		#{hos_id}
		AND a.copy_code = #{copy_code}
		AND a.acc_year = #{acc_year}
		AND a.acc_month = #{acc_month}
		group by
		group_id,hos_id,copy_code,a.acc_year,a.acc_month
		,a.vouch_type_code
		) t
		left join
		acc_vouch_type f on t.group_id=f.group_id and
		t.hos_id=f.hos_id
		and f.copy_code=t.copy_code and
		t.vouch_type_code=f.vouch_type_code
		where
		t.group_id = #{group_id}
		AND
		t.hos_id = #{hos_id}
		AND t.copy_code = #{copy_code}
		AND t.acc_year =
		#{acc_year}
		AND t.acc_month = #{acc_month}
		group by
		t.group_id,t.hos_id,t.copy_code,t.acc_year,t.acc_month,t.vouch_type_code,vouch_type_name
		order by t.vouch_type_code asc

	</select>
	<select id="queryAccVouchStatistics" parameterType="java.util.Map"
		resultMap="accVouch1">
		<!-- select a.acc_year, a.acc_month, f.vouch_type_short, a.vouch_no, a.vouch_att_num, 
			a.vouch_date, a.create_date, c.user_name create_name, d.user_name cash_name, 
			e.user_name audit_name, a.acc_user from acc_vouch a left join sys_user c 
			on a.group_id = c.group_id and a.hos_id = c.hos_id and a.create_user = c.user_id 
			left join sys_user d on a.group_id = d.group_id and a.hos_id = d.hos_id and 
			a.cash_user = d.user_id left join sys_user e on a.group_id = e.group_id and 
			a.hos_id = e.hos_id and a.audit_user = e.user_id left join acc_vouch_type 
			f on a.group_id = f.group_id and a.hos_id = f.hos_id and a.copy_code = f.copy_code 
			and f.vouch_type_code = a.vouch_type_code <where> <if test="vouch_id != null 
			and vouch_id != ''"> AND a.vouch_id = #{vouch_id} </if> <if test="group_id 
			!= null and group_id != ''"> AND a.group_id = #{group_id} </if> <if test="hos_id 
			!= null and hos_id != ''"> AND a.hos_id = #{hos_id} </if> <if test="copy_code 
			!= null and copy_code != ''"> AND a.copy_code = #{copy_code} </if> <if test="acc_year 
			!= null and acc_year != ''"> AND a.acc_year = #{acc_year} </if> <if test="acc_month_b 
			!= null and acc_month_e != null"> AND a.acc_month between #{acc_month_b} 
			and #{acc_month_e} </if> <if test="vouch_type_code != null and vouch_type_code 
			!= ''"> AND a.vouch_type_code = #{vouch_type_code} </if> <if test="create_user 
			!= null and create_user != ''"> AND a.create_user = #{create_user} </if> 
			<if test="cash_user != null and cash_user != ''"> AND a.cash_user = #{cash_user} 
			</if> <if test="audit_user != null and audit_user != ''"> AND a.audit_user 
			= #{audit_user} </if> <if test="acc_user != null and acc_user != ''"> AND 
			a.acc_user = #{acc_user} </if> </where> order by a.vouch_date,a.vouch_no 
			asc -->
		select
		(SELECT COUNT(*) FROM acc_vouch
		<where>
			<if test="vouch_id != null and vouch_id != ''">
				AND vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year}
			</if>
			<if test="acc_month_b != null and acc_month_e != null ">
				AND acc_month between #{acc_month_b} and #{acc_month_e}
			</if>
			<if test="vouch_type_code != null and vouch_type_code != ''"> 
			    AND vouch_type_code = #{vouch_type_code}
		    </if>
		    <if test="create_user != null and create_user != ''"> 
			    AND create_user = #{create_user}
		    </if>
			and state != -1
		</where>
		) vouch_tote
		,
		(SELECT count(*) FROM acc_vouch
		<where>
			<if test="vouch_id != null and vouch_id != ''">
				AND vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year}
			</if>
			<if test="acc_month_b != null and acc_month_e != null ">
				AND acc_month between #{acc_month_b} and #{acc_month_e}
			</if>
			<if test="vouch_type_code != null and vouch_type_code != ''"> 
			    AND vouch_type_code = #{vouch_type_code}
		    </if>
		    <if test="create_user != null and create_user != ''"> 
			    AND create_user = #{create_user}
		    </if>
			and state != -1 and state != 0
		</where>
		) vouch_normal
		,
		(SELECT count(*) FROM acc_vouch
		<where>
			<if test="vouch_id != null and vouch_id != ''">
				AND vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year}
			</if>
			<if test="acc_month_b != null and acc_month_e != null ">
				AND acc_month between #{acc_month_b} and #{acc_month_e}
			</if>
			<if test="vouch_type_code != null and vouch_type_code != ''"> 
			    AND vouch_type_code = #{vouch_type_code}
		    </if>
		    <if test="create_user != null and create_user != ''"> 
			    AND create_user = #{create_user}
		    </if>
			and state = -1 
		</where>
		) draft
		,
		(SELECT count(*) FROM acc_vouch
		<where>
			<if test="vouch_id != null and vouch_id != ''">
				AND vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year}
			</if>
			<if test="acc_month_b != null and acc_month_e != null ">
				AND acc_month between #{acc_month_b} and #{acc_month_e}
			</if>
			<if test="vouch_type_code != null and vouch_type_code != ''"> 
			    AND vouch_type_code = #{vouch_type_code}
		    </if>
		    <if test="create_user != null and create_user != ''"> 
			    AND create_user = #{create_user}
		    </if>
			and state != -1 and state = 0
		</where>
		) vouch_cancel
		,
		(SELECT count(*) FROM acc_vouch
		<where>
			<if test="vouch_id != null and vouch_id != ''">
				AND vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year}
			</if>
			<if test="acc_month_b != null and acc_month_e != null ">
				AND acc_month between #{acc_month_b} and #{acc_month_e}
			</if>
			 <if test="vouch_type_code != null and vouch_type_code != ''"> 
			    AND vouch_type_code = #{vouch_type_code}
		    </if>
		    <if test="create_user != null and create_user != ''"> 
			    AND create_user = #{create_user}
		    </if>
			and state != -1
			and state != 0 and state &lt;2
		</where>
		) no_cashier
		,
		(SELECT count(*) FROM
		acc_vouch
		<where>
			<if test="vouch_id != null and vouch_id != ''">
				AND vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year}
			</if>
			<if test="acc_month_b != null and acc_month_e != null ">
				AND acc_month between #{acc_month_b} and #{acc_month_e}
			</if>
			<if test="vouch_type_code != null and vouch_type_code != ''"> 
			    AND vouch_type_code = #{vouch_type_code}
		    </if>
		    <if test="create_user != null and create_user != ''"> 
			    AND create_user = #{create_user}
		    </if>
			and state != -1 and state != 0 and
			state &gt;=2
		</where>
		)cashier
		,
		(SELECT
		count(*) FROM acc_vouch
		<where>
			<if test="vouch_id != null and vouch_id != ''">
				AND vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year}
			</if>
			<if test="acc_month_b != null and acc_month_e != null ">
				AND acc_month between #{acc_month_b} and #{acc_month_e}
			</if>
			 <if test="vouch_type_code != null and vouch_type_code != ''"> 
			    AND vouch_type_code = #{vouch_type_code}
		    </if>
		    <if test="create_user != null and create_user != ''"> 
			    AND create_user = #{create_user}
		    </if>
			and state != -1 and state != 0
			and state &lt; 3
		</where>
		) no_examine
		,
		(SELECT count(*) FROM acc_vouch
		<where>
			<if test="vouch_id != null and vouch_id != ''">
				AND vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year}
			</if>
			<if test="acc_month_b != null and acc_month_e != null ">
				AND acc_month between #{acc_month_b} and #{acc_month_e}
			</if>
		     <if test="vouch_type_code != null and vouch_type_code != ''"> 
			    AND vouch_type_code = #{vouch_type_code}
		    </if>
		    <if test="create_user != null and create_user != ''"> 
			    AND create_user = #{create_user}
		    </if>
			and state != -1 and
			state != 0
			and
			state &gt;=3
		</where>
		) examine
		,
		(SELECT count(*) FROM acc_vouch
		<where>
			<if test="vouch_id != null and vouch_id != ''">
				AND vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year}
			</if>
			<if test="acc_month_b != null and acc_month_e != null ">
				AND acc_month between #{acc_month_b} and #{acc_month_e}
			</if>
			<if test="vouch_type_code != null and vouch_type_code != ''"> 
			    AND vouch_type_code = #{vouch_type_code}
		    </if>
		    <if test="create_user != null and create_user != ''"> 
			    AND create_user = #{create_user}
		    </if>
			and state != -1 and state !=99
		</where>
		) no_telly
		,
		(SELECT count(*) FROM acc_vouch
		<where>
			<if test="vouch_id != null and vouch_id != ''">
				AND vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year}
			</if>
			<if test="acc_month_b != null and acc_month_e != null ">
				AND acc_month between #{acc_month_b} and #{acc_month_e}
			</if>
			<if test="vouch_type_code != null and vouch_type_code != ''"> 
			    AND vouch_type_code = #{vouch_type_code}
		    </if>
		    <if test="create_user != null and create_user != ''"> 
			    AND create_user = #{create_user}
		    </if>
			  and state != -1 and state =99
		</where>
		) telly
		from
		dual

	</select>

	<select id="queryAccVouchSubjCode" parameterType="java.util.Map" resultType="com.chd.hrp.acc.entity.AccVouch">
		select avd.summary,asubj.subj_code,asubj.subj_name,avd.debit,avd.credit,asubj.subj_dire,asubj.is_check
		from acc_vouch avouch left join acc_vouch_detail avd on avouch.group_id = avd.group_id and avouch.hos_id = avd.hos_id
			and avouch.copy_code = avd.copy_code and avouch.vouch_id = avd.vouch_id
			and avd.acc_year = avouch.acc_year 
		left join acc_subj asubj on avd.group_id = asubj.group_id and avd.hos_id = asubj.hos_id and avd.copy_code = asubj.copy_code
			and avd.acc_year = asubj.acc_year and avd.subj_code = asubj.subj_code
		<where>
			<if test="vouch_id != null and vouch_id != ''">
				AND avouch.vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND avouch.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND avouch.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND avouch.copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND avouch.acc_year = #{acc_year}
			</if>
			<if test="vouch_type_code != null and vouch_type_code != ''">
				AND avouch.vouch_type_code = #{vouch_type_code}
			</if>
		</where>
		order by asubj.subj_code asc
	</select>



	<select id="queryAccVouchNextval" parameterType="java.util.Map" resultType="java.lang.Integer">
		select ACC_VOUCH_SEQ.nextval from dual
	</select>

	<select id="queryAccCashJournal" parameterType="java.util.Map" resultType="com.chd.hrp.acc.entity.AccVouch">
	
		<!-- 昨日结转=本年年初余额加小于开始日期的余额 -->
		with v_table as(
			<!-- 昨日结转 -->
			SELECT
				a.group_id,a.hos_id,a.copy_code,0 as vouch_id,0 as vouch_detail_id,null as vouch_date,'' as v_year,'' as v_month,
				'' as v_day,'' as vouch_no,'期初余额' as summary,to_char('') as subj_name, '' as other_subj_name,0 as other_bal,
				0 as debit, 0 as credit, a.acc_year, a.subj_code,a.bal+b.bal as bal
			FROM (
				<!-- 年初余额 -->
				SELECT 
					al.group_id,al.hos_id,al.copy_code,al.end_os as bal,al.subj_code,al.acc_year
				FROM ACC_LEDER al
				WHERE
					al.group_id = #{group_id}
					AND al.hos_id = #{hos_id}
					AND al.copy_code = #{copy_code}
					AND al.subj_code = #{subj_code}
					AND al.acc_year = #{acc_year}
					AND al.acc_month = '00'
			) a,
			
			<!-- 小于开始日期的余额 -->
			(
				SELECT 
					nvl(sum(avd.debit),0)-nvl(sum(avd.credit),0) AS bal
				FROM
				ACC_VOUCH av
				LEFT JOIN ACC_VOUCH_DETAIL avd
				ON 
					av.vouch_id = avd.vouch_id
					AND av.group_id = avd.group_id
					AND av.hos_id = avd.hos_id
					AND av.copy_code = avd.copy_code
					AND av.acc_year = av.acc_year
				WHERE
					av.group_id = #{group_id}
					AND av.hos_id = #{hos_id}
					AND av.copy_code = #{copy_code}
					AND av.acc_year = #{acc_year}
					AND av.vouch_date&lt;to_date(#{begin_date},'yyyy/MM/dd')
					AND avd.subj_code = #{subj_code}
			) b
		),
		
		<!-- 每日凭证明细 -->
		a_table AS(
			SELECT
				avd.group_id,avd.hos_id,avd.copy_code,avd.vouch_id,avd.vouch_detail_id,av.vouch_date,to_char(av.vouch_date,'yyyy') as v_year,
				to_char(av.vouch_date,'MM') as v_month,to_char(av.vouch_date,'dd') as v_day,avt.vouch_type_short||'-'||av.vouch_no as vouch_no,
				avd.summary,null as subj_name,'' as other_subj_name,0 as other_bal,avd.debit,avd.credit,avd.acc_year,avd.subj_code,avd.debit-avd.credit as bal
			FROM ACC_VOUCH_DETAIL avd
			LEFT JOIN ACC_VOUCH av
			ON 
				avd.group_id = av.group_id
				AND avd.hos_id = av.hos_id
				AND avd.copy_code = av.copy_code
				AND avd.acc_year = av.acc_year
				AND avd.vouch_id = av.vouch_id
		
			LEFT JOIN ACC_VOUCH_TYPE avt 
			ON 
				av.group_id = avt.group_id
				AND av.hos_id = avt.hos_id
				AND av.copy_code = avt.copy_code
				AND av.vouch_type_code = avt.vouch_type_code
			<where>
				avd.group_id = #{group_id}
				and avd.hos_id = #{hos_id}
				and avd.copy_code = #{copy_code}
					
				<if test="acc_year != null and acc_year !='' ">
					and avd.acc_year = #{acc_year}
				</if>
				
				<if test="subj_code != null and subj_code != ''">
					and avd.subj_code = #{subj_code}
				</if>
				
				<if
					test="money != null and money != '' and sumMoney!= null and sumMoney != ''">
					and ((avd.debit between #{money} and #{sumMoney}) or
					(avd.credit
					between #{money} and #{sumMoney}))
				</if>
				
				<if
					test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
					and av.vouch_no between #{vouch_no_b} and #{vouch_no_e}
				</if>
				
				<if test="state != null and state !='' ">
					and av.state>=#{state}
				</if>
				
				<if test="begin_date != null and begin_date != '' and end_date != null and end_date !='' ">
					and av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
					and to_date(#{end_date},'yyyy/MM/dd')
				</if>
				
				<if test="vouch_type_code != null and vouch_type_code != ''">
					and av.vouch_type_code = #{vouch_type_code}
				</if>
				
				<if test="create_user != null and create_user != '' ">
					and av.create_user = #{create_user}
				</if>
				
				<if test="summary != null and summary !='' ">
					and avd.summary like '%${summary}%'
				</if>
			</where>

			order by av.vouch_date,vouch_no,avd.vouch_detail_id
		),
		
		<!-- 本日合计 -->
		b_table AS (
			SELECT
				t.group_id,t.hos_id,t.copy_code,null as vouch_id,null as vouch_detail_id,null as vouch_date,
				to_char(t.vouch_date,'yyyy') as v_year,to_char(t.vouch_date,'MM') as v_month,to_char(t.vouch_date,'dd') as v_day,null as vouch_no,
				'本日合计' as summary,to_char('') as subj_name,'' as other_subj_name,0 as other_bal,sum(t.debit) as debit,
				sum(t.credit) as credit,t.acc_year,t.subj_code,0 as bal
			FROM(
				<!-- 凭证明细数据 -->
				SELECT
					avd.group_id,avd.hos_id,avd.copy_code,avd.vouch_id,av.vouch_date,to_char(av.vouch_date,'yyyy') as v_year,
					to_char(av.vouch_date,'MM') as v_month,to_char(av.vouch_date,'dd') as v_day,av.vouch_no,avd.summary,
					avd.debit,avd.credit,avd.acc_year,avd.subj_code,0 as bal
				FROM ACC_VOUCH_DETAIL avd
				
				LEFT JOIN ACC_VOUCH av
				ON 
					avd.group_id = av.group_id
					AND avd.hos_id = av.hos_id
					AND avd.copy_code = av.copy_code
					AND avd.acc_year = av.acc_year
					AND avd.vouch_id = av.vouch_id
				
				LEFT JOIN ACC_VOUCH_TYPE avt
				ON 
					av.group_id = avt.group_id
					AND av.hos_id = avt.hos_id
					AND av.copy_code = avt.copy_code
					AND av.vouch_type_code = avt.vouch_type_code
					
				<where>
					avd.group_id = #{group_id}
					AND avd.hos_id = #{hos_id}
					AND avd.copy_code = #{copy_code}
						
					<if test="acc_year != null and acc_year != ''">
						AND avd.acc_year = #{acc_year}
					</if>
					
					<if test="subj_code != null and subj_code != ''">
						AND avd.subj_code = #{subj_code}
					</if>
					
					<if test="money != null and money !='' and sumMoney != null and sumMoney !=''">
						AND (
							(avd.debit between #{money} AND #{sumMoney}) OR
							(avd.credit between #{money} AND #{sumMoney})
						)
					</if>
					
					<if test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
						AND av.vouch_no between #{vouch_no_b} and #{vouch_no_e}
					</if>
					
					<if test="state != null and state != ''">
						AND av.state>=#{state}
					</if>
					
					<if test="begin_date != null and begin_date != '' and end_date != null and end_date != ''">
						AND av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
						AND to_date(#{end_date},'yyyy/MM/dd')
					</if>
					
					<if test="vouch_type_code != null and vouch_type_code !=''">
						AND av.vouch_type_code = #{vouch_type_code}
					</if>
					
					<if test="create_user != null and create_user != ''">
						AND av.create_user = #{create_user}
					</if>
					
					<if test="summary != null and summary !=''">
						AND avd.summary like '%${summary}%'
					</if>
				</where>
			) t
			GROUP BY t.group_id,t.hos_id,t.copy_code,t.acc_year,t.subj_code,t.v_day,t.vouch_date,t.acc_year,t.subj_code
		),
		
		
		c_table AS (
			<!-- 本月合计 -->
			SELECT
				t.group_id,t.hos_id,t.copy_code,null as vouch_id,null as vouch_detail_id,null as vouch_date,t.v_year,t.v_month,
				'' as v_day, null as vouch_no, '本月合计' as summary,to_char('') as subj_name,'' as other_subj_name,0 as other_bal,
				sum(t.debit) as debit, sum(t.credit) as credit, t.acc_year, t.subj_code,0 as bal
			FROM(
				SELECT
					avd.group_id, avd.hos_id,avd.copy_code,to_char(av.vouch_date,'yyyy') as v_year,to_char(av.vouch_date,'MM') as v_month,
					sum(avd.debit) as debit,sum(avd.credit) as credit,avd.acc_year,avd.subj_code
				FROM ACC_VOUCH_DETAIL avd
				LEFT JOIN ACC_VOUCH av ON avd.group_id = av.group_id
					AND avd.hos_id = av.hos_id
					AND avd.copy_code = av.copy_code
					AND avd.acc_year = av.acc_year
					AND avd.vouch_id = av.vouch_id
				<where>
					avd.group_id = #{group_id}
					AND avd.hos_id = #{hos_id}
					AND avd.copy_code = #{copy_code}
					
					<if test="acc_year != null and acc_year != ''">
						AND avd.acc_year = #{acc_year}
					</if>
					
					<if test="subj_code != null and subj_code != ''">
						AND avd.subj_code = #{subj_code}
					</if>
					
					<if test="money != null and money !='' and sumMoney != null and sumMoney !=''">
						AND (
							(avd.debit BETWEEN #{money} and #{sumMoney}) or
							(avd.credit BETWEEN #{money} and #{sumMoney})
						)
					</if>
					
					<if test="vouch_no_b != null and vouch_no_b !='' and vouch_no_e != null and vouch_no_e != ''">
						AND av.vouch_no BETWEEN #{vouch_no_b} and #{vouch_no_e}
					</if>
					
					<if test="state != null and state != ''">
						AND av.state >= #{state}
					</if>
					
					<if test="begin_date != null and begin_date !='' and end_date != null and end_date != ''">
						AND av.vouch_date BETWEEN to_date(#{begin_date},'yyyy/MM/dd')
						AND to_date(#{end_date},'yyyy/MM/dd')
					</if>
					
					<if test="vouch_type_code != null and vouch_type_code != ''">
						AND av.vouch_type_code = #{vouch_type_code}
					</if>
					
					<if test="create_user != null and create_user != ''">
						AND av.create_user = #{create_user}
					</if>
					
					<if test="summary != null and summary != ''">
						AND avd.summary LIKE '%${summary}%'
					</if>
				</where>
				
				GROUP BY avd.group_id,avd.hos_id,avd.copy_code,av.vouch_date,avd.acc_year,avd.subj_code
			) t 
			GROUP BY t.group_id,t.hos_id,t.copy_code,t.v_year,v_month,t.acc_year,t.subj_code
		),
		
		<!-- 本年累计 -->
		d_table AS (
			SELECT
				t.group_id,t.hos_id,t.copy_code,null as vouch_id,null as vouch_detail_id,null as vouch_date,t.v_year,t.v_month,
				'' as v_day,null as vouch_no,'本年累计' as summary,to_char('') as subj_name,'' as other_subj_name,0 as other_bal,
				sum(t.debit) over(order by t.v_month) as debit, sum(t.credit)over(order by t.v_month) as credit,
				t.acc_year, t.subj_code, 0 as bal
			FROM(
				<!-- 每月合计 -->
				SELECT
					t.group_id,t.hos_id,t.copy_code,t.v_year,t.v_month,sum(t.debit) as debit, sum(t.credit) as credit,t.acc_year,t.subj_code

				FROM(
					<!-- 每日合计 -->
					SELECT
						avd.group_id,avd.hos_id,avd.copy_code,to_char(av.vouch_date,'yyyy') as v_year,to_char(av.vouch_date,'MM') as v_month,
						sum(avd.debit) as debit,sum(avd.credit) as credit,avd.acc_year,avd.subj_code
					FROM ACC_VOUCH_DETAIL avd
					LEFT JOIN ACC_VOUCH av
					ON 
						avd.group_id = av.group_id
						AND avd.hos_id = av.hos_id
						AND avd.copy_code = av.copy_code
						AND avd.acc_year = av.acc_year
						AND avd.vouch_id = av.vouch_id
		
					<where>
						avd.group_id = #{group_id}
						AND avd.hos_id = #{hos_id}
						AND avd.copy_code = #{copy_code}
						
						<if test="acc_year != null and acc_year != ''">
							AND avd.acc_year = #{acc_year}
						</if>
						
						<if test="subj_code != null and subj_code != ''">
							AND avd.subj_code = #{subj_code}
						</if>
						
						<if test="money != null and money !='' and sumMoney != null and sumMoney !=''">
							AND (
								(avd.debit BETWEEN #{money} and #{sumMoney}) or
								(avd.credit BETWEEN #{money} and #{sumMoney})
							)
						</if>
						
						<if test="vouch_no_b != null and vouch_no_b !='' and vouch_no_e != null and vouch_no_e != ''">
							AND av.vouch_no between #{vouch_no_b} and #{vouch_no_e}
						</if>
						
						<if test="state != null and state != ''">
							AND av.state>=#{state}
						</if>
						
						<if test="begin_date != null and begin_date !='' and end_date != null and end_date != ''">
							AND av.vouch_date BETWEEN to_date(#{begin_date},'yyyy/MM/dd')
							AND to_date(#{end_date},'yyyy/MM/dd')
						</if>
						
						<if test="vouch_type_code != null and vouch_type_code != ''">
							AND av.vouch_type_code = #{vouch_type_code}
						</if>
						
						<if test="create_user != null and create_user != ''">
							AND av.create_user = #{create_user}
						</if>
						
						<if test="summary != null and summary != ''">
							AND avd.summary like '%${summary}%'
						</if>
						
					</where>
					GROUP BY avd.group_id,avd.hos_id,avd.copy_code,av.vouch_date,avd.acc_year,avd.subj_code
				) t 
				GROUP BY t.group_id,t.hos_id,t.copy_code,t.v_year,v_month,t.acc_year,t.subj_code
			)t
		),
		
		<!-- 下日结转 -->
		e_table AS(
			SELECT
				t.group_id, t.hos_id,t.copy_code,null as vouch_id,null as vouch_detail_id,null as vouch_date,
				to_char(t.vouch_date,'yyyy') as v_year,to_char(t.vouch_date,'MM') as v_month, to_char(t.vouch_date,'dd') as v_day,
				null as vouch_no, '结转下日' as summary,to_char('') as subj_name, '' as other_subj_name, 0 as other_bal,
				sum(t.debit) as debit, sum(t.credit) as credit,t.acc_year, t.subj_code, 0 as bal
			FROM(
				<!-- 凭证明细数据 -->
				SELECT
					avd.group_id, avd.hos_id, avd.copy_code, avd.vouch_id, av.vouch_date, to_char(av.vouch_date,'yyyy') as v_year,
					to_char(av.vouch_date,'MM') as v_month,to_char(av.vouch_date,'dd') as v_day, av.vouch_no, avd.summary, avd.debit,
					avd.credit, avd.acc_year, avd.subj_code, 0 as bal
				FROM ACC_VOUCH_DETAIL avd
				
				LEFT JOIN ACC_VOUCH av
				ON 
					avd.group_id = av.group_id
					AND avd.hos_id = av.hos_id
					AND avd.copy_code = av.copy_code
					AND avd.acc_year = av.acc_year
					AND avd.vouch_id = av.vouch_id
				LEFT JOIN ACC_VOUCH_TYPE avt
				ON 
					av.group_id = avt.group_id
					AND av.hos_id = avt.hos_id
					AND av.copy_code = avt.copy_code
					AND av.vouch_type_code = avt.vouch_type_code
					
				<where>
					avd.group_id = #{group_id}
					AND avd.hos_id = #{hos_id}
					AND avd.copy_code = #{copy_code}
					
					<if test="acc_year != null and acc_year != ''">
						AND avd.acc_year = #{acc_year}
					</if>
					
					<if test="subj_code != null and subj_code != ''">
						AND avd.subj_code = #{subj_code}
					</if>
					
					<if test="money != null and money !='' and sumMoney != null and sumMoney !=''">
						AND (
							(avd.debit BETWEEN #{money} and #{sumMoney}) OR
							(avd.credit BETWEEN #{money} and #{sumMoney})
						)
					</if>
					
					<if test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
						AND av.vouch_no between #{vouch_no_b} AND #{vouch_no_e}
					</if>
					
					<if test="state != null and state != ''">
						AND av.state>=#{state}
					</if>
					
					<if test="begin_date != null and begin_date != '' and end_date != null and end_date != ''">
						AND av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
						AND to_date(#{end_date},'yyyy/MM/dd')
					</if>
					
					<if test="vouch_type_code != null and vouch_type_code !=''">
						AND av.vouch_type_code = #{vouch_type_code}
					</if>
					
					<if test="create_user != null and create_user != ''">
						AND av.create_user = #{create_user}
					</if>
					
					<if test="summary != null and summary !=''">
						AND avd.summary like '%${summary}%'
					</if>
				</where>
			) t
			GROUP BY t.group_id,t.hos_id,t.copy_code,t.v_day,t.vouch_date,t.acc_year,t.subj_code
		)
		
		
		<!-- 查询所有数据 -->
		SELECT
			t.group_id, t.hos_id, t.copy_code, t.vouch_id, t.vouch_detail_id, t.vouch_date,
			t.v_year, t.v_month, t.v_day, t.vouch_no,t.summary, subj.subj_name, subj.subj_dire,
			( 
				SELECT 
					s.subj_name_all 
				FROM ACC_VOUCH_DETAIL d
				LEFT JOIN ACC_SUBJ s 
				ON 
					d.group_id = s.group_id
					AND d.hos_id = s.hos_id
					AND d.copy_code = s.copy_code
					AND d.acc_year = s.acc_year
					AND d.subj_code=s.subj_code
				WHERE 
					d.vouch_id=t.vouch_id 
					AND rownum=1
					AND (CASE WHEN t.debit=0 THEN d.debit ELSE d.credit END) &lt;&gt;0
					AND d.vouch_detail_id &lt;&gt; t.vouch_detail_id
					<!-- (d.debit=t.debit or d.credit=t.credit ) -->
					<!-- and nvl(d.debit,0) + nvl(d.credit,0) = nvl(t.debit,0) + nvl(t.credit,0) -->
					
			) other_subj_name,
			
			( 
				SELECT 
					CASE WHEN t.debit=0 THEN d.debit ELSE d.credit END o_money
				FROM ACC_VOUCH_DETAIL d
				WHERE
					d.vouch_id=t.vouch_id and rownum=1
					AND (CASE WHEN t.debit=0 THEN d.debit ELSE d.credit END ) &lt;&gt; 0
					AND d.vouch_detail_id &lt;&gt; t.vouch_detail_id
					<!-- and (d.debit=t.debit or d.credit=t.credit ) -->
					<!-- and nvl(d.debit,0) + nvl(d.credit,0) = nvl(t.debit,0) + nvl(t.credit,0) -->
			) other_money,
			
			t.debit,t.credit, t.acc_year,t.subj_code,
			sum(t.bal) over(order by t.numNo,t.vouch_date,t.vouch_no,vouch_detail_id) as bal,
			t.numNo
		FROM(
			<!-- 昨日结转 -->
			SELECT
				v.group_id,v.hos_id, v.copy_code, 0 as vouch_id,null as vouch_detail_id,null as vouch_date,
				'' as v_year, '' as v_month,'' as v_day, '' as vouch_no, v.summary,to_char('') as subj_name,
				'' as other_subj_name,0 as other_bal,0 as debit,0 as credit, v.acc_year, v.subj_code, v.bal,'0' as numNo
			FROM v_table v
			
			UNION ALL
			
			<!-- 每日凭证 -->
			SELECT
				a.group_id, a.hos_id,a.copy_code,a.vouch_id,a.vouch_detail_id,a.vouch_date,
				a.v_year, a.v_month,a.v_day,a.vouch_no, a.summary, a.subj_name,a.other_subj_name,
				a.other_bal,a.debit,a.credit, a.acc_year,a.subj_code,a.bal, a.v_year||a.v_month||a.v_day|| '41' as numNo
			FROM a_table a
			
			UNION ALL
			<!-- 本日合计 -->
			SELECT
				b.group_id, b.hos_id,b.copy_code,null as vouch_id,null as vouch_detail_id,null as vouch_date,
				b.v_year,b.v_month,b.v_day,null as vouch_no,b.summary, to_char('') as subj_name,
				'' as other_subj_name,0 as other_bal,b.debit, b.credit, b.acc_year,b.subj_code,b.bal,b.v_year||b.v_month||b.v_day|| '42' as numNo
			FROM b_table b
			
			UNION ALL
			<!-- 本月合计 -->
			SELECT
				c.group_id,c.hos_id,c.copy_code,null as vouch_id,null as vouch_detail_id,null as vouch_date,
				c.v_year,c.v_month, '' as v_day,null as vouch_no,c.summary,to_char('') as subj_name,
				'' as other_subj_name, 0 as other_bal, c.debit,c.credit,c.acc_year,c.subj_code,c.bal,c.v_year||c.v_month|| '44' as numNo
			FROM c_table c
			
			
			UNION ALL
			<!-- 本年累计 -->
			SELECT
				d.group_id,d.hos_id,d.copy_code, null as vouch_id,null as vouch_detail_id,null as vouch_date,
				d.v_year, null as v_month, '' as v_day,null as vouch_no,d.summary,to_char('') as subj_name,
				'' as other_subj_name, 0 as other_bal,d.debit,d.credit,d.acc_year,d.subj_code,d.bal,d.v_year||d.v_month|| '45' as numNo
			FROM d_table d
			
			UNION ALL
			<!-- 下日结转 -->
			SELECT
				e.group_id,e.hos_id,e.copy_code,null as vouch_id,null as vouch_detail_id, null as vouch_date,
				e.v_year,e.v_month,e.v_day,null as vouch_no, e.summary,to_char('') as subj_name,
				'' as other_subj_name,0 as other_bal,0 as debit,0 as credit,e.acc_year,e.subj_code,0 as bal,
				e.v_year||e.v_month||e.v_day||'43' as numNo
			FROM e_table e
		) t
		LEFT JOIN ACC_SUBJ subj
		ON
			t.group_id = subj.group_id
		  	AND t.hos_id = subj.hos_id
		  	AND t.copy_code = subj.copy_code
		  	AND t.acc_year = subj.acc_year
		  	AND t.subj_code = subj.subj_code
		ORDER BY t.numNo,t.vouch_date,t.vouch_no,t.vouch_detail_id
	</select>


	<!-- 根据当前节点查询父节点 -->
	<select id="queryVouchState" parameterType="java.util.Map" resultType="map">
		select avf.parent_node_id,avs.state_name
		from ACC_VOUCH_FLOW avf
		left join ACC_VOUCH_STATE avs on avf.parent_node_id = avs.state and avf.group_id = avs.group_id
			and avf.hos_id = avs.hos_id and avf.copy_code = avs.copy_code
		<where>
			<if test="state !=null and state != ''">
				avf.node_id=#{state}
			</if>
			<if test="group_id !=null and group_id != ''">
				and avf.group_id=#{group_id}
			</if>
			<if test="hos_id !=null and hos_id != ''">
				and avf.hos_id=#{hos_id}
			</if>
			<if test="copy_code !=null and copy_code != ''">
				and avf.copy_code=#{copy_code}
			</if>
		</where>
	</select>

	<select id="queryAccVouchList" resultType="Integer" parameterType="java.util.List">

		SELECT
		count(*)
		FROM acc_vouch
		<where>
			<foreach collection="list" item="item" index="index"
				separator="or">
				<if test="item.vouch_id != null and item.vouch_id != ''">
					vouch_id =#{item.vouch_id}
				</if>
				<if test="item.state != null and item.state != ''">
					and state =#{item.state}
				</if>
			</foreach>
		</where>

	</select>
	
	<!-- 审核、签字 -->
	<select id="queryAccVouchAuditCashByCheck" resultType="Integer" parameterType="java.util.List">
	
		select count(*) from acc_vouch v 
		where  v.group_id=#{group_id} and v.hos_id=#{hos_id} and v.copy_code=#{copy_code}  
		and not exists(select 1 from acc_vouch_flow where group_id=v.group_id and hos_id=v.hos_id and copy_code=v.copy_code and node_id=#{node_id} 
		and v.state=parent_node_id)
		and (
		<foreach collection="list" item="item" index="index" separator="or">
			v.vouch_id =#{item.vouch_id}
		</foreach>
		)
		
	</select>
	
	<!-- 取消审核、取消签字 -->
	<select id="queryAccVouchUnAuditCashByCheck" resultType="Integer" parameterType="java.util.List">
	
		select count(*) from acc_vouch v 
		where v.group_id=#{group_id} and v.hos_id=#{hos_id} and v.copy_code=#{copy_code} and v.state!=#{node_id}		
		and (
		<foreach collection="list" item="item" index="index" separator="or">
			v.vouch_id =#{item.vouch_id}
		</foreach>
		)
		
	</select>

	<!-- 判断是否已审核、记账 -->
	<select id="queryAccVouchAuditByCheck" resultType="Integer" parameterType="java.util.List">
		select count(*) from acc_vouch v
		where v.group_id=#{group_id} and v.hos_id=#{hos_id} and v.copy_code=#{copy_code} and v.state in(3,99,-1,0)
		and (
			<foreach collection="list" item="item" index="index" separator="or">
				v.vouch_id =#{item.vouch_id}
			</foreach>
			)
	</select>

	<select id="queryAccVouchAccount" parameterType="java.util.Map" resultMap="accVouch1">
		 SELECT  a.group_id, a.hos_id, a.copy_code , a.acc_year, a.vouch_type_short, a.vouch_type_code,  
			(select count(*) from acc_vouch ava 
				where ava.state =99 and ava.group_id=#{group_id}
  					and ava.hos_id =#{hos_id} and ava.copy_code = #{copy_code} 
  					<if test="acc_year != null and acc_year != ''">
						and ava.acc_year =#{acc_year}
					</if>
					<if test="acc_month != null and acc_month != ''">
						and ava.acc_month =#{acc_month}
	    			</if>
  					and ava.vouch_type_code = a.vouch_type_code
  			) AS vouch_accounting, 
		(	select count(*) from acc_vouch avb 
			where state !=99 and group_id=#{group_id}
  				and avb.hos_id =#{hos_id} and avb.copy_code = #{copy_code}
  				<if test="acc_year != null and acc_year != ''">
					and avb.acc_year =#{acc_year}
				</if>
				<if test="acc_month != null and acc_month != ''">
					and avb.acc_month =#{acc_month}
	    		</if>
  				and avb.vouch_type_code = a.vouch_type_code
  		) AS unvouch_accounting
		FROM (
			SELECT  av.vouch_id, av.state, av.group_id, av.hos_id, av.copy_code, av.acc_year || '.' || av.acc_month AS acc_year, avt.vouch_type_name AS vouch_type_short, av.vouch_type_code
			FROM acc_vouch av
			LEFT JOIN acc_vouch_detail avd ON av.group_id = avd.group_id
				AND av.hos_id = avd.hos_id
				AND av.copy_code = avd.copy_code
				AND av.acc_year = avd.acc_year
				AND av.vouch_id = avd.vouch_id 
			LEFT JOIN acc_vouch_type avt ON av.group_id = avt.group_id
				AND av.hos_id = avt.hos_id
				AND av.copy_code = avt.copy_code
				AND av.vouch_type_code = avt.vouch_type_code
			<where>
				<if test="group_id != null and group_id != ''">
					av.group_id =#{group_id}
				</if>
				<if test="hos_id != null and hos_id != ''">
					and av.hos_id =#{hos_id}
				</if>
				<if test="copy_code != null and copy_code != ''">
					and av.copy_code =#{copy_code}
				</if>
				<if test="acc_year != null and acc_year != ''">
					and av.acc_year =#{acc_year}
				</if>
				<if test="acc_month != null and acc_month != ''">
					and av.acc_month =#{acc_month}
				</if>
			</where>
		GROUP BY av.group_id, av.hos_id, av.copy_code,av.vouch_id ,avt.vouch_type_name, av.vouch_type_code, av.acc_year, av.acc_month, av.state
		) a
		GROUP BY a.group_id, a.hos_id, a.copy_code,a.vouch_type_code, a.vouch_type_short, a.acc_year
	</select>

	<select id="updateBatchAccountingAccVouch" statementType="CALLABLE" parameterType="java.util.Map">
		 <![CDATA[ 
		{call acc_vouch_accounting(
			#{group_id},  
	        #{hos_id},  
	        #{copy_code},  
	        #{user_id},
	        #{acc_year},
	        #{acc_month},
	        ''
        )} 
		 ]]>
	</select>
	
	<select id="queryAccVouchFlow" resultType="java.lang.Integer" parameterType="java.util.Map">
		select parent_node_id from acc_vouch_flow
		where   node_id = '99'
		   <if test="group_id != null and group_id != ''">
				and group_id =#{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and hos_id =#{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and copy_code =#{copy_code}
			</if>
	</select>

	<select id="queryAccVouchAccountingReport" parameterType="java.util.Map" resultMap="accVouch1">
		select asubj.subj_code,asubj.subj_name_all subj_name,sum(nvl(avd.debit,0)) debit,
			sum(nvl(avd.credit,0)) credit 
		from acc_subj asubj 
		left join acc_vouch_detail avd on asubj.group_id = avd.group_id and asubj.hos_id =avd.hos_id
			and asubj.acc_year = avd.acc_year and asubj.subj_code = avd.subj_code 
		left join acc_vouch av on av.hos_id =avd.hos_id and av.acc_year = avd.acc_year and av.vouch_id = avd.vouch_id
		<where>
			<if test="group_id != null and group_id != ''">
				asubj.group_id =#{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and asubj.hos_id =#{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and asubj.copy_code =#{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				and av.acc_year =#{acc_year}
			</if>
			<if test="acc_month != null and acc_month != ''">
				and av.acc_month =#{acc_month}
			</if>
		</where>
		group by asubj.subj_code,asubj.subj_name_all
		order by asubj.subj_code
	</select>

	<!-- 凭证制单-选择科目 -->
	<resultMap id="accVouchSubj" type="java.util.Map">
		<result property="id" column="id" />
		<result property="name" column="name" />
		<result property="spell_code" column="spell_code" />
		<result property="wbx_code" column="wbx_code" />
		<result property="subj_nature_code" column="subj_nature_code" />
		<result property="is_check" column="is_check" />
		<result property="is_cash" column="is_cash" />
		<result property="subj_type_code" column="subj_type_code" />
		<result property="subj_dire" column="subj_dire" />
	</resultMap>
	
	<select id="queryAccVouchSubj" parameterType="java.util.Map" resultMap="accVouchSubj">
		select subj_id id,subj_code ||' '||subj_name_all
		name,spell_code,wbx_code,is_check,is_cash,subj_nature_code,subj_type_code,subj_dire
		from acc_subj
		where group_id=#{group_id} and hos_id=#{hos_id} and copy_code=#{copy_code}
			and acc_year=#{acc_year} and is_last=1 and is_stop=0
			<if test="key != null and key != ''">
				and (
				subj_code like '${key}%' or subj_name like '%${key}%'
				or spell_code like '${key}%' or wbx_code like '${key}%'
				)
			</if>
		order by subj_code asc
	</select>
	
	<!-- 查询凭证断号list -->
	<select id="queryAccVouchNeaten" parameterType="java.util.Map" resultMap="accVouch1">
		select av.group_id,av.hos_id,av.copy_code,av.vouch_date,av.vouch_id,av.vouch_att_num,
			avt.vouch_type_short||'-'||av.vouch_no vouch_no,
			next_vouch_no, su1.user_name create_name,
			su2.user_name cash_name,su3.user_name audit_name,su.user_name acc_name ,
			'凭证号 '||av.vouch_no||' 至 '||av.next_vouch_no||' 断号' summary
		from (
			select group_id,hos_id,copy_code,vouch_id,vouch_no,vouch_att_num,acc_year,acc_month,
				vouch_type_code,vouch_date,create_user create_id,cash_user
				cash_id,audit_user audit_id,acc_user acc_id, lead(vouch_no) over(order by vouch_type_code,vouch_no) next_vouch_no
			from acc_vouch a
		<where>
			<if test="group_id != null and group_id != ''">
				a.group_id =#{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and a.hos_id =#{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and a.copy_code =#{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				and a.acc_year =#{acc_year}
			</if>
			<if test="acc_month != null and acc_month != ''">
				and a.acc_month =#{acc_month}
			</if>
			<if test="vouch_type_code != null and vouch_type_code != ''">
				and a.vouch_type_code =#{vouch_type_code}
			</if>
		</where>
		) av 
		left join acc_vouch_type avt on av.group_id = avt.group_id and av.hos_id = avt.hos_id and av.copy_code = avt.copy_code
			and av.vouch_type_code = avt.vouch_type_code and avt.is_stop =0
		left join sys_user su1 on av.group_id=su1.group_id and av.hos_id=su1.hos_id and av.create_id=su1.user_id
		left join sys_user su2 on av.group_id=su2.group_id and av.hos_id=su2.hos_id and av.cash_id=su2.user_id
		left join sys_user su3 on av.group_id=su3.group_id and av.hos_id=su3.hos_id and av.audit_id=su3.user_id
		left join sys_user su on av.group_id=su.group_id and av.hos_id=su.hos_id and av.acc_id=su.user_id
		<where>
			<if test="group_id != null and group_id != ''">
				av.group_id =#{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and av.hos_id =#{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and av.copy_code =#{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				and av.acc_year =#{acc_year}
			</if>
			<if test="acc_month != null and acc_month != ''">
				and av.acc_month =#{acc_month}
			</if>
		</where>
		and next_vouch_no-vouch_no>1
		order by av.vouch_no asc
	</select>

	<select id="queryAccVouchDetailByVouchid" resultMap="accVouch" parameterType="java.util.Map">

		SELECT
			to_char(WM_CONCAT(subj_code)) subj_no
		FROM
		ACC_VOUCH_DETAIL
		<where>
			<if test="vouchid != null and vouchid != ''">
				AND vouch_id in (${vouchid})
			</if>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND acc_year = #{acc_year}
			</if>
		</where>
		order by group_id asc
	</select>
	
	<select id="queryAccVouchDetailByVouchIdList" resultType="String" parameterType="java.util.Map">
		SELECT
			distinct t.vouch_type_short||'-'||av.vouch_no
		FROM
		ACC_VOUCH_DETAIL avd 
		 left join acc_vouch av on avd.group_id=av.group_id and
			avd.hos_id=av.hos_id and
			avd.copy_code=av.copy_code and
			avd.vouch_id=av.vouch_id
		 left join acc_vouch_type t on 
			av.group_id=t.group_id and
			av.hos_id=t.hos_id and
			av.copy_code=t.copy_code and
			av.vouch_type_code=t.vouch_type_code
		<where>
			AND av.state &lt;   #{state}
			and av.state &gt;=  1
			<if test="vouchid != null and vouchid != ''">
				AND avd.vouch_id in (${vouchid})
			</if>
			<if test="group_id != null and group_id != ''">
				AND avd.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND avd.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND avd.copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND avd.acc_year = #{acc_year}
			</if>
			<if test="flag != null and flag == 1">
				AND exists (select 1 from ACC_VOUCH_DETAIL a LEFT JOIN  acc_subj b  ON a.group_id = b.group_id
				AND a.hos_id = b.hos_id
				AND a.copy_code = b.copy_code and a.acc_year=b.acc_year
				AND a.subj_code = b.subj_code where a.vouch_id = avd.vouch_id and b.subj_nature_code  in ('02','03'))
			</if>
			<if test="flag != null and flag == 2">
				AND not exists (select 1 from ACC_VOUCH_DETAIL a LEFT JOIN  acc_subj b  ON a.group_id = b.group_id
				AND a.hos_id = b.hos_id
				AND a.copy_code = b.copy_code
				AND a.acc_year = b.acc_year
				AND a.subj_code = b.subj_code where a.vouch_id = avd.vouch_id and b.subj_nature_code  in ('02','03'))
			</if>
		</where>
	</select>
	
	<!-- 检查是否现金银行凭证 -->
	<select id="queryAccVouchListByBank" resultType="String" parameterType="java.util.Map">
		SELECT
			distinct t.vouch_type_short||'-'||av.vouch_no
		FROM
		ACC_VOUCH_DETAIL avd 
		 left join acc_vouch av on
			avd.group_id=av.group_id and
			avd.hos_id=av.hos_id and
			avd.copy_code=av.copy_code and
			avd.vouch_id=av.vouch_id
		 left join acc_vouch_type t on 
			av.group_id=t.group_id and
			av.hos_id=t.hos_id and
			av.copy_code=t.copy_code and
			av.vouch_type_code=t.vouch_type_code
		where avd.group_id = #{group_id} AND  avd.vouch_id in (${vouchid})
			AND avd.hos_id = #{hos_id} AND avd.copy_code = #{copy_code}
			AND not exists (
				select 1 from ACC_VOUCH_DETAIL a 
				LEFT JOIN  acc_subj b  ON a.group_id = b.group_id AND a.hos_id = b.hos_id AND a.copy_code = b.copy_code AND a.subj_code = b.subj_code 
				and a.acc_year=b.acc_year 
				where a.vouch_id = avd.vouch_id and b.subj_nature_code  in ('02','03') and av.state &gt;0
			)			
	</select>
	
	
	<select id="queryAccVouchFlowByNodeId" parameterType="java.util.Map" resultType="java.lang.Integer">
		select count(*) from acc_vouch_flow
		where node_id=#{node_id} and group_id = #{group_id}
			and hos_id = #{hos_id} and copy_code = #{copy_code}
	</select>
	
	 <select id="accAccountingCheckIndex1" resultType="java.util.Map" parameterType="java.util.Map">
		
		select 
			group_id,
			hos_id,
			copy_code,
			vouch_id,
			state  
		from acc_vouch
		where  group_id = #{group_id}
			AND hos_id = #{hos_id}
			AND copy_code = #{copy_code}
			AND acc_year = #{acc_year}
			AND acc_month = #{acc_month} 
			AND state =-1
		
		</select>
		
	 <select id="accAccountingCheckIndex2" resultType="java.util.Map" parameterType="java.util.Map">
		select 
			group_id,
			hos_id,
			copy_code,
			vouch_id,
			state 
		from acc_vouch
		where group_id = #{group_id}
			AND hos_id = #{hos_id}
			AND copy_code = #{copy_code}
			AND acc_year = #{acc_year}
			AND acc_month = #{acc_month}
		    AND state &lt;  3
		    AND state &gt;=1
	</select>
		
	<select id="accAccountingCheckIndex3" resultType="java.util.Map" parameterType="java.util.Map">
		select 
			a.group_id,
			a.hos_id,
			a.copy_code,
			a.vouch_id,
			a.state,
			b.subj_code 
		from  acc_vouch a 
		left join acc_vouch_detail b  on a.vouch_id=b.vouch_id
		where a.group_id = #{group_id}
			AND a.hos_id = #{hos_id}
			AND a.copy_code = #{copy_code}
			AND a.acc_year = #{acc_year}
			AND a.acc_month = #{acc_month}
			AND a.state!=2
			AND a.state!=0
			AND a.state!=99
			AND b.subj_code in  (
				select subj_code from acc_subj 
				where  group_id = #{group_id}
					AND hos_id = #{hos_id}
					AND copy_code = #{copy_code}
					AND acc_year = #{acc_year} 
					AND subj_nature_code in ('02','03')
			)
	</select>
		
	<select id="accAccountingCheckIndex4" resultType="java.util.Map" parameterType="java.util.Map">
		select 
			a.group_id,
			a.hos_id,
			a.copy_code,
			a.vouch_id,
			a.state,
			b.subj_code
		from  acc_vouch a
		left join acc_vouch_detail b  
			on a.vouch_id = b.vouch_id
		where a.group_id = #{group_id}
			AND a.hos_id = #{hos_id}
			AND a.copy_code = #{copy_code}
			AND a.acc_year = #{acc_year}
			AND a.acc_month = #{acc_month}
			AND a.state!=3
			AND a.state!=0
			AND a.state!=99
			AND a.vouch_id not in (
				select c.vouch_id
				from  acc_vouch c 
				left join acc_vouch_detail d  
					on c.vouch_id = d.vouch_id
				where c.group_id = #{group_id}
					AND c.hos_id = #{hos_id}
					AND c.copy_code = #{copy_code}
					AND c.acc_year = #{acc_year}
					AND c.acc_month = #{acc_month}
					AND d.subj_code in  (
						select subj_code from acc_subj 
						where  subj_nature_code in ('02','03')
							AND group_id = #{group_id}
							AND hos_id = #{hos_id}
							AND copy_code = #{copy_code}
							AND acc_year = #{acc_year}
					)
			)
	</select>
		
	<update id="accUnAccountingCheckIndex1" parameterType="java.util.Map">
		UPDATE acc_vouch SET state = 3, acc_user = null, acc_date= null
		where  group_id = #{group_id}
			AND hos_id = #{hos_id}
			AND copy_code = #{copy_code}
			AND acc_year = #{acc_year}
			AND acc_month = #{acc_month} 
			AND state='99'
	</update>

	<update id="accUnAccountingCheckIndex2" parameterType="java.util.Map">
		UPDATE acc_vouch SET state = 3, acc_user = null, acc_date= null
   		where group_id = #{group_id}
			AND hos_id = #{hos_id}
			AND copy_code = #{copy_code}
			AND acc_year = #{acc_year}
			AND acc_month = #{acc_month}
			AND state='99' 
	</update>

	<update id="accUnAccountingCheckIndex3" parameterType="java.util.Map">
		UPDATE acc_vouch SET state = 2, acc_user = null, acc_date= null
   		where group_id = #{group_id}
			AND hos_id = #{hos_id}
			AND copy_code = #{copy_code}
			AND acc_year = #{acc_year}
			AND acc_month = #{acc_month}
			AND state='3' 
   			AND vouch_id in (
   				select vouch_id from acc_vouch_detail 
   				where  subj_code  in (
       				select subj_code from acc_subj 
	    			where  subj_nature_code in ('02','03')
						AND group_id = #{group_id}
						AND hos_id = #{hos_id}
						AND copy_code = #{copy_code}
						AND acc_year = #{acc_year}
     				)
 				)
	</update>
	
	<insert id="addBatchAccVouchOfRed" useGeneratedKeys="false">
		INSERT INTO ACC_VOUCH
		(
		vouch_id
		,
		group_id
		,
		hos_id
		,
		copy_code
		,
		acc_year
		,
		acc_month
		,
		vouch_type_code
		,
		vouch_no
		,
		vouch_date
		,
		vouch_att_num
		,
		create_user
		,
		create_date
		,
		state,
		vouch_id_cx,
		vouch_cx_state,
		busi_type_code
		) 
		select 
		#{new_vouch_id} ,
		group_id ,
		hos_id ,
		copy_code ,
		#{acc_year},
		#{acc_month} ,
		vouch_type_code ,
		#{new_vouch_no} ,
		#{vouch_date} ,
		vouch_att_num ,
		#{create_user} ,
		#{create_date} ,
		1 ,
		#{vouch_id},
		'1',
		''
		from acc_vouch
		where group_id =#{group_id} and hos_id = #{hos_id}
		and copy_code = #{copy_code} and acc_year=#{acc_year}
		and vouch_id =#{vouch_id}

	</insert>
	
	<select id="queryAccVouchDetailCountByVouchId" parameterType="java.util.Map" resultMap="accVouch">
		select vouch_detail_id from acc_vouch_detail 
		where group_id =#{group_id} and hos_id = #{hos_id}
			and copy_code = #{copy_code} and acc_year=#{acc_year}
			and vouch_id =#{vouch_id}
	</select>
		
	<select id="queryAccVouchCashByVouchDetailId" parameterType="java.util.Map" resultMap="accVouch">
		select cash_id vouch_id from acc_cash_flow 
		where group_id =#{group_id} and hos_id = #{hos_id} and copy_code = #{copy_code} and vouch_id=#{vouch_id} and vouch_detail_id =#{vouch_detail_id}
	</select>
	
	<!-- 作废、取消作废，更新票据号状态 -->
	<update id="updateAccPaperDetailState" parameterType="java.util.Map">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			UPDATE ACC_PAPER_DETAIL set state1=case when #{item.state}=0 then 3 else 2 end
			<where>
				group_id=#{item.group_id} and hos_id=#{item.hos_id} and copy_code=#{item.copy_code} and vouch_id=#{item.vouch_id}  
				and exists(
					select 1 from acc_vouch_check c where c.vouch_id=ACC_PAPER_DETAIL.vouch_id
					and c.group_id= ACC_PAPER_DETAIL.Group_Id and c.hos_id=ACC_PAPER_DETAIL.Hos_Id and c.copy_code=ACC_PAPER_DETAIL.Copy_Code
					and c.check_no is not null and c.paper_type_code=ACC_PAPER_DETAIL.Type_Code and c.check_no=ACC_PAPER_DETAIL.PAPER_NUM
				) 
			</where>
		</foreach>
	</update>
	
	<!-- 	查询凭证附件 -->
	<select id="queryAccVouchAdjunct" parameterType="java.util.Map" resultMap="accAdjunct">
		select
         ava.group_id,
         ava.hos_id,
         ava.copy_code,
         ava.vouch_id,
         (avt.vouch_type_short ||'-'|| a.vouch_no) as vouch_no,
         a.vouch_date,
         a.state,
         ava.att_name_n,
         ava.att_name_o,
         ava.att_path,
         ava.att_size,
         ava.create_user,
         to_char(ava.create_date, 'yyyy-MM-dd hh24:mi:ss') create_date,
         su.user_name as create_name,
         ava.att_type,
         ava.invo_num,
         ava.invo_date,
         ava.invo_money
    	from ACC_VOUCH_ATT ava
      	left join ACC_VOUCH a on ava.group_id=a.group_id and  ava.hos_id=a.hos_id and  ava.copy_code=a.copy_code and
      		ava.vouch_id=a.vouch_id
      	left join  acc_vouch_type avt on avt.group_id=a.group_id and 
	      	avt.hos_id=a.hos_id and  avt.copy_code=a.copy_code and
	      	avt.vouch_type_code=a.vouch_type_code
      	left join sys_user su on ava.group_id=su.group_id and  ava.hos_id=su.hos_id and ava.create_user=su.user_id
	 	WHERE 
			ava.group_id = #{group_id,jdbcType=INTEGER}   and 
			ava.hos_id = #{hos_id,jdbcType=INTEGER}   and 
			ava.copy_code = #{copy_code,jdbcType=VARCHAR}  
			<if test="create_date_b != null and create_date_b != ''">
				AND to_char(a.vouch_date) &gt;= to_date(#{create_date_b},'yyyy-MM-dd')
			</if>
			<if test="create_date_e != null and create_date_e != ''">
				AND to_char(a.vouch_date) &lt;= to_date(#{create_date_e},'yyyy-MM-dd')
			</if>		
			<if test="invo_num != null and invo_num != ''">
				AND ava.invo_num like '${invo_num}%'
			</if>
			<if test="vouch_no_b != null and vouch_no_b != ''">
				AND a.vouch_no &gt;= to_number(#{vouch_no_b})
			</if>
			<if test="vouch_no_e != null and vouch_no_e != ''">
				AND a.vouch_no &lt;= to_number(#{vouch_no_e})
			</if>
			<if test="invo_money_b != null and invo_money_b != ''">
				AND ava.invo_money &gt;= to_number(#{invo_money_b})
			</if>
			<if test="invo_money_e != null and invo_money_e != ''">
				AND ava.invo_money &lt;= to_number(#{invo_money_e})
			</if>	
			order by a.vouch_no,ava.create_date	
	</select>
	
	<select id="queryAccCashJournalPrint" parameterType="java.util.Map" resultType="java.util.Map">
		<!-- 昨日结转=本年年初余额加小于开始日期的余额 -->
		with v_table as(
			<!-- 昨日结转 -->
			SELECT
				a.group_id,a.hos_id,a.copy_code,0 as vouch_id,0 as vouch_detail_id,null as vouch_date,'' as v_year,'' as v_month,
				'' as v_day,'' as vouch_no,'期初余额' as summary,to_char('') as subj_name, '' as other_subj_name,0 as other_bal,
				0 as debit, 0 as credit, a.acc_year, a.subj_code,a.bal+b.bal as bal
			FROM (
				<!-- 年初余额 -->
				SELECT 
					al.group_id,al.hos_id,al.copy_code,al.end_os as bal,al.subj_code,al.acc_year
				FROM ACC_LEDER al
				WHERE
					al.group_id = #{group_id}
					AND al.hos_id = #{hos_id}
					AND al.copy_code = #{copy_code}
					AND al.subj_code = #{subj_code}
					AND al.acc_year = #{acc_year}
					AND al.acc_month = '00'
			) a,
			
			<!-- 小于开始日期的余额 -->
			(
				SELECT 
					nvl(sum(avd.debit),0)-nvl(sum(avd.credit),0) AS bal
				FROM
				ACC_VOUCH av
				LEFT JOIN ACC_VOUCH_DETAIL avd
				ON 
					av.vouch_id = avd.vouch_id
					AND av.group_id = avd.group_id
					AND av.hos_id = avd.hos_id
					AND av.copy_code = avd.copy_code
					AND av.acc_year = av.acc_year
				WHERE
					av.group_id = #{group_id}
					AND av.hos_id = #{hos_id}
					AND av.copy_code = #{copy_code}
					AND av.acc_year = #{acc_year}
					AND av.vouch_date&lt;to_date(#{begin_date},'yyyy/MM/dd')
					AND avd.subj_code = #{subj_code}
			) b
		),
		
		<!-- 每日凭证明细 -->
		a_table AS(
			SELECT
				avd.group_id,avd.hos_id,avd.copy_code,avd.vouch_id,avd.vouch_detail_id,av.vouch_date,to_char(av.vouch_date,'yyyy') as v_year,
				to_char(av.vouch_date,'MM') as v_month,to_char(av.vouch_date,'dd') as v_day,avt.vouch_type_short||'-'||av.vouch_no as vouch_no,
				avd.summary,null as subj_name,'' as other_subj_name,0 as other_bal,avd.debit,avd.credit,avd.acc_year,avd.subj_code,avd.debit-avd.credit as bal
			FROM ACC_VOUCH_DETAIL avd
			LEFT JOIN ACC_VOUCH av
			ON 
				avd.group_id = av.group_id
				AND avd.hos_id = av.hos_id
				AND avd.copy_code = av.copy_code
				AND avd.acc_year = av.acc_year
				AND avd.vouch_id = av.vouch_id
		
			LEFT JOIN ACC_VOUCH_TYPE avt 
			ON 
				av.group_id = avt.group_id
				AND av.hos_id = avt.hos_id
				AND av.copy_code = avt.copy_code
				AND av.vouch_type_code = avt.vouch_type_code
			<where>
				avd.group_id = #{group_id}
				and avd.hos_id = #{hos_id}
				and avd.copy_code = #{copy_code}
					
				<if test="acc_year != null and acc_year !='' ">
					and avd.acc_year = #{acc_year}
				</if>
				
				<if test="subj_code != null and subj_code != ''">
					and avd.subj_code = #{subj_code}
				</if>
				
				<if
					test="money != null and money != '' and sumMoney!= null and sumMoney != ''">
					and ((avd.debit between #{money} and #{sumMoney}) or
					(avd.credit
					between #{money} and #{sumMoney}))
				</if>
				
				<if
					test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
					and av.vouch_no between #{vouch_no_b} and #{vouch_no_e}
				</if>
				
				<if test="state != null and state !='' ">
					and av.state>=#{state}
				</if>
				
				<if test="begin_date != null and begin_date != '' and end_date != null and end_date !='' ">
					and av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
					and to_date(#{end_date},'yyyy/MM/dd')
				</if>
				
				<if test="vouch_type_code != null and vouch_type_code != ''">
					and av.vouch_type_code = #{vouch_type_code}
				</if>
				
				<if test="create_user != null and create_user != '' ">
					and av.create_user = #{create_user}
				</if>
				
				<if test="summary != null and summary !='' ">
					and avd.summary like '%${summary}%'
				</if>
			</where>

			order by av.vouch_date,vouch_no,avd.vouch_detail_id
		),
		
		<!-- 本日合计 -->
		b_table AS (
			SELECT
				t.group_id,t.hos_id,t.copy_code,null as vouch_id,null as vouch_detail_id,null as vouch_date,
				to_char(t.vouch_date,'yyyy') as v_year,to_char(t.vouch_date,'MM') as v_month,to_char(t.vouch_date,'dd') as v_day,null as vouch_no,
				'本日合计' as summary,to_char('') as subj_name,'' as other_subj_name,0 as other_bal,sum(t.debit) as debit,
				sum(t.credit) as credit,t.acc_year,t.subj_code,0 as bal
			FROM(
				<!-- 凭证明细数据 -->
				SELECT
					avd.group_id,avd.hos_id,avd.copy_code,avd.vouch_id,av.vouch_date,to_char(av.vouch_date,'yyyy') as v_year,
					to_char(av.vouch_date,'MM') as v_month,to_char(av.vouch_date,'dd') as v_day,av.vouch_no,avd.summary,
					avd.debit,avd.credit,avd.acc_year,avd.subj_code,0 as bal
				FROM ACC_VOUCH_DETAIL avd
				
				LEFT JOIN ACC_VOUCH av
				ON 
					avd.group_id = av.group_id
					AND avd.hos_id = av.hos_id
					AND avd.copy_code = av.copy_code
					AND avd.acc_year = av.acc_year
					AND avd.vouch_id = av.vouch_id
				
				LEFT JOIN ACC_VOUCH_TYPE avt
				ON 
					av.group_id = avt.group_id
					AND av.hos_id = avt.hos_id
					AND av.copy_code = avt.copy_code
					AND av.vouch_type_code = avt.vouch_type_code
					
				<where>
					avd.group_id = #{group_id}
					AND avd.hos_id = #{hos_id}
					AND avd.copy_code = #{copy_code}
						
					<if test="acc_year != null and acc_year != ''">
						AND avd.acc_year = #{acc_year}
					</if>
					
					<if test="subj_code != null and subj_code != ''">
						AND avd.subj_code = #{subj_code}
					</if>
					
					<if test="money != null and money !='' and sumMoney != null and sumMoney !=''">
						AND (
							(avd.debit between #{money} AND #{sumMoney}) OR
							(avd.credit between #{money} AND #{sumMoney})
						)
					</if>
					
					<if test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
						AND av.vouch_no between #{vouch_no_b} and #{vouch_no_e}
					</if>
					
					<if test="state != null and state != ''">
						AND av.state>=#{state}
					</if>
					
					<if test="begin_date != null and begin_date != '' and end_date != null and end_date != ''">
						AND av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
						AND to_date(#{end_date},'yyyy/MM/dd')
					</if>
					
					<if test="vouch_type_code != null and vouch_type_code !=''">
						AND av.vouch_type_code = #{vouch_type_code}
					</if>
					
					<if test="create_user != null and create_user != ''">
						AND av.create_user = #{create_user}
					</if>
					
					<if test="summary != null and summary !=''">
						AND avd.summary like '%${summary}%'
					</if>
				</where>
			) t
			GROUP BY t.group_id,t.hos_id,t.copy_code,t.acc_year,t.subj_code,t.v_day,t.vouch_date,t.acc_year,t.subj_code
		),
		
		
		c_table AS (
			<!-- 本月合计 -->
			SELECT
				t.group_id,t.hos_id,t.copy_code,null as vouch_id,null as vouch_detail_id,null as vouch_date,t.v_year,t.v_month,
				'' as v_day, null as vouch_no, '本月合计' as summary,to_char('') as subj_name,'' as other_subj_name,0 as other_bal,
				sum(t.debit) as debit, sum(t.credit) as credit, t.acc_year, t.subj_code,0 as bal
			FROM(
				SELECT
					avd.group_id, avd.hos_id,avd.copy_code,to_char(av.vouch_date,'yyyy') as v_year,to_char(av.vouch_date,'MM') as v_month,
					sum(avd.debit) as debit,sum(avd.credit) as credit,avd.acc_year,avd.subj_code
				FROM ACC_VOUCH_DETAIL avd
				LEFT JOIN ACC_VOUCH av
				ON avd.group_id = av.group_id
				AND avd.hos_id = av.hos_id
				AND avd.copy_code = av.copy_code
				AND avd.acc_year = av.acc_year
				AND avd.vouch_id = av.vouch_id
				
				<where>
					avd.group_id = #{group_id}
					AND avd.hos_id = #{hos_id}
					AND avd.copy_code = #{copy_code}
					
					<if test="acc_year != null and acc_year != ''">
						AND avd.acc_year = #{acc_year}
					</if>
					
					<if test="subj_code != null and subj_code != ''">
						AND avd.subj_code = #{subj_code}
					</if>
					
					<if test="money != null and money !='' and sumMoney != null and sumMoney !=''">
						AND (
							(avd.debit BETWEEN #{money} and #{sumMoney}) or
							(avd.credit BETWEEN #{money} and #{sumMoney})
						)
					</if>
					
					<if test="vouch_no_b != null and vouch_no_b !='' and vouch_no_e != null and vouch_no_e != ''">
						AND av.vouch_no BETWEEN #{vouch_no_b} and #{vouch_no_e}
					</if>
					
					<if test="state != null and state != ''">
						AND av.state >= #{state}
					</if>
					
					<if test="begin_date != null and begin_date !='' and end_date != null and end_date != ''">
						AND av.vouch_date BETWEEN to_date(#{begin_date},'yyyy/MM/dd')
						AND to_date(#{end_date},'yyyy/MM/dd')
					</if>
					
					<if test="vouch_type_code != null and vouch_type_code != ''">
						AND av.vouch_type_code = #{vouch_type_code}
					</if>
					
					<if test="create_user != null and create_user != ''">
						AND av.create_user = #{create_user}
					</if>
					
					<if test="summary != null and summary != ''">
						AND avd.summary LIKE '%${summary}%'
					</if>
				</where>
				
				GROUP BY avd.group_id,avd.hos_id,avd.copy_code,av.vouch_date,avd.acc_year,avd.subj_code
			) t 
			GROUP BY t.group_id,t.hos_id,t.copy_code,t.v_year,v_month,t.acc_year,t.subj_code
		),
		
		<!-- 本年累计 -->
		d_table AS (
			SELECT
				t.group_id,t.hos_id,t.copy_code,null as vouch_id,null as vouch_detail_id,null as vouch_date,t.v_year,t.v_month,
				'' as v_day,null as vouch_no,'本年累计' as summary,to_char('') as subj_name,'' as other_subj_name,0 as other_bal,
				sum(t.debit) over(order by t.v_month) as debit, sum(t.credit)over(order by t.v_month) as credit,
				t.acc_year, t.subj_code, 0 as bal
			FROM(
				<!-- 每月合计 -->
				SELECT
					t.group_id,t.hos_id,t.copy_code,t.v_year,t.v_month,sum(t.debit) as debit, sum(t.credit) as credit,t.acc_year,t.subj_code

				FROM(
					<!-- 每日合计 -->
					SELECT
						avd.group_id,avd.hos_id,avd.copy_code,to_char(av.vouch_date,'yyyy') as v_year,to_char(av.vouch_date,'MM') as v_month,
						sum(avd.debit) as debit,sum(avd.credit) as credit,avd.acc_year,avd.subj_code
					FROM ACC_VOUCH_DETAIL avd
					LEFT JOIN ACC_VOUCH av
					ON 
						avd.group_id = av.group_id
						AND avd.hos_id = av.hos_id
						AND avd.copy_code = av.copy_code
						AND avd.acc_year = av.acc_year
						AND avd.vouch_id = av.vouch_id
		
					<where>
						avd.group_id = #{group_id}
						AND avd.hos_id = #{hos_id}
						AND avd.copy_code = #{copy_code}
						
						<if test="acc_year != null and acc_year != ''">
							AND avd.acc_year = #{acc_year}
						</if>
						
						<if test="subj_code != null and subj_code != ''">
							AND avd.subj_code = #{subj_code}
						</if>
						
						<if test="money != null and money !='' and sumMoney != null and sumMoney !=''">
							AND (
								(avd.debit BETWEEN #{money} and #{sumMoney}) or
								(avd.credit BETWEEN #{money} and #{sumMoney})
							)
						</if>
						
						<if test="vouch_no_b != null and vouch_no_b !='' and vouch_no_e != null and vouch_no_e != ''">
							AND av.vouch_no between #{vouch_no_b} and #{vouch_no_e}
						</if>
						
						<if test="state != null and state != ''">
							AND av.state>=#{state}
						</if>
						
						<if test="begin_date != null and begin_date !='' and end_date != null and end_date != ''">
							AND av.vouch_date BETWEEN to_date(#{begin_date},'yyyy/MM/dd')
							AND to_date(#{end_date},'yyyy/MM/dd')
						</if>
						
						<if test="vouch_type_code != null and vouch_type_code != ''">
							AND av.vouch_type_code = #{vouch_type_code}
						</if>
						
						<if test="create_user != null and create_user != ''">
							AND av.create_user = #{create_user}
						</if>
						
						<if test="summary != null and summary != ''">
							AND avd.summary like '%${summary}%'
						</if>
						
					</where>
					GROUP BY avd.group_id,avd.hos_id,avd.copy_code,av.vouch_date,avd.acc_year,avd.subj_code
				) t 
				GROUP BY t.group_id,t.hos_id,t.copy_code,t.v_year,v_month,t.acc_year,t.subj_code
			)t
		),
		
		<!-- 下日结转 -->
		e_table AS(
			SELECT
				t.group_id, t.hos_id,t.copy_code,null as vouch_id,null as vouch_detail_id,null as vouch_date,
				to_char(t.vouch_date,'yyyy') as v_year,to_char(t.vouch_date,'MM') as v_month, to_char(t.vouch_date,'dd') as v_day,
				null as vouch_no, '结转下日' as summary,to_char('') as subj_name, '' as other_subj_name, 0 as other_bal,
				sum(t.debit) as debit, sum(t.credit) as credit,t.acc_year, t.subj_code, 0 as bal
			FROM(
				<!-- 凭证明细数据 -->
				SELECT
					avd.group_id, avd.hos_id, avd.copy_code, avd.vouch_id, av.vouch_date, to_char(av.vouch_date,'yyyy') as v_year,
					to_char(av.vouch_date,'MM') as v_month,to_char(av.vouch_date,'dd') as v_day, av.vouch_no, avd.summary, avd.debit,
					avd.credit, avd.acc_year, avd.subj_code, 0 as bal
				FROM ACC_VOUCH_DETAIL avd
				
				LEFT JOIN ACC_VOUCH av
				ON 
					avd.group_id = av.group_id
					AND avd.hos_id = av.hos_id
					AND avd.copy_code = av.copy_code
					AND avd.acc_year = av.acc_year
					AND avd.vouch_id = av.vouch_id
				LEFT JOIN ACC_VOUCH_TYPE avt
				ON 
					av.group_id = avt.group_id
					AND av.hos_id = avt.hos_id
					AND av.copy_code = avt.copy_code
					AND av.vouch_type_code = avt.vouch_type_code
					
				<where>
					avd.group_id = #{group_id}
					AND avd.hos_id = #{hos_id}
					AND avd.copy_code = #{copy_code}
					
					<if test="acc_year != null and acc_year != ''">
						AND avd.acc_year = #{acc_year}
					</if>
					
					<if test="subj_code != null and subj_code != ''">
						AND avd.subj_code = #{subj_code}
					</if>
					
					<if test="money != null and money !='' and sumMoney != null and sumMoney !=''">
						AND (
							(avd.debit BETWEEN #{money} and #{sumMoney}) OR
							(avd.credit BETWEEN #{money} and #{sumMoney})
						)
					</if>
					
					<if test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
						AND av.vouch_no between #{vouch_no_b} AND #{vouch_no_e}
					</if>
					
					<if test="state != null and state != ''">
						AND av.state>=#{state}
					</if>
					
					<if test="begin_date != null and begin_date != '' and end_date != null and end_date != ''">
						AND av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
						AND to_date(#{end_date},'yyyy/MM/dd')
					</if>
					
					<if test="vouch_type_code != null and vouch_type_code !=''">
						AND av.vouch_type_code = #{vouch_type_code}
					</if>
					
					<if test="create_user != null and create_user != ''">
						AND av.create_user = #{create_user}
					</if>
					
					<if test="summary != null and summary !=''">
						AND avd.summary like '%${summary}%'
					</if>
				</where>
			) t
			GROUP BY t.group_id,t.hos_id,t.copy_code,t.v_day,t.vouch_date,t.acc_year,t.subj_code
		)
		
		
		<!-- 查询所有数据 -->
		SELECT
			t.group_id, t.hos_id, t.copy_code, t.vouch_id, t.vouch_detail_id, t.vouch_date,
			t.v_year, t.v_month, t.v_day, t.vouch_no,t.summary, subj.subj_name, subj.subj_dire,
			( 
				SELECT 
					s.subj_name_all 
				FROM ACC_VOUCH_DETAIL d
				LEFT JOIN ACC_SUBJ s 
				ON 
					d.group_id = s.group_id
					AND d.hos_id = s.hos_id
					AND d.copy_code = s.copy_code
					AND d.acc_year = s.acc_year
					AND d.subj_code=s.subj_code
				WHERE 
					d.vouch_id=t.vouch_id 
					AND rownum=1
					AND (CASE WHEN t.debit=0 THEN d.debit ELSE d.credit END) &lt;&gt;0
					AND d.vouch_detail_id &lt;&gt; t.vouch_detail_id
					<!-- (d.debit=t.debit or d.credit=t.credit ) -->
					<!-- and nvl(d.debit,0) + nvl(d.credit,0) = nvl(t.debit,0) + nvl(t.credit,0) -->
					
			) other_subj_name,
			
			( 
				SELECT 
					CASE WHEN t.debit=0 THEN d.debit ELSE d.credit END o_money
				FROM ACC_VOUCH_DETAIL d
				WHERE
					d.vouch_id=t.vouch_id and rownum=1
					AND (CASE WHEN t.debit=0 THEN d.debit ELSE d.credit END ) &lt;&gt; 0
					AND d.vouch_detail_id &lt;&gt; t.vouch_detail_id
					<!-- and (d.debit=t.debit or d.credit=t.credit ) -->
					<!-- and nvl(d.debit,0) + nvl(d.credit,0) = nvl(t.debit,0) + nvl(t.credit,0) -->
			) other_money,
			
			t.debit,t.credit, t.acc_year,t.subj_code,
			sum(t.bal) over(order by t.numNo,t.vouch_date,t.vouch_no,vouch_detail_id) as bal,
			t.numNo
		FROM(
			<!-- 昨日结转 -->
			SELECT
				v.group_id,v.hos_id, v.copy_code, 0 as vouch_id,null as vouch_detail_id,null as vouch_date,
				'' as v_year, '' as v_month,'' as v_day, '' as vouch_no, v.summary,to_char('') as subj_name,
				'' as other_subj_name,0 as other_bal,0 as debit,0 as credit, v.acc_year, v.subj_code, v.bal,'0' as numNo
			FROM v_table v
			
			UNION ALL
			
			<!-- 每日凭证 -->
			SELECT
				a.group_id, a.hos_id,a.copy_code,a.vouch_id,a.vouch_detail_id,a.vouch_date,
				a.v_year, a.v_month,a.v_day,a.vouch_no, a.summary, a.subj_name,a.other_subj_name,
				a.other_bal,a.debit,a.credit, a.acc_year,a.subj_code,a.bal, a.v_year||a.v_month||a.v_day|| '41' as numNo
			FROM a_table a
			
			UNION ALL
			<!-- 本日合计 -->
			SELECT
				b.group_id, b.hos_id,b.copy_code,null as vouch_id,null as vouch_detail_id,null as vouch_date,
				b.v_year,b.v_month,b.v_day,null as vouch_no,b.summary, to_char('') as subj_name,
				'' as other_subj_name,0 as other_bal,b.debit, b.credit, b.acc_year,b.subj_code,b.bal,b.v_year||b.v_month||b.v_day|| '42' as numNo
			FROM b_table b
			
			UNION ALL
			<!-- 本月合计 -->
			SELECT
				c.group_id,c.hos_id,c.copy_code,null as vouch_id,null as vouch_detail_id,null as vouch_date,
				c.v_year,c.v_month, '' as v_day,null as vouch_no,c.summary,to_char('') as subj_name,
				'' as other_subj_name, 0 as other_bal, c.debit,c.credit,c.acc_year,c.subj_code,c.bal,c.v_year||c.v_month|| '44' as numNo
			FROM c_table c
			
			
			UNION ALL
			<!-- 本年累计 -->
			SELECT
				d.group_id,d.hos_id,d.copy_code, null as vouch_id,null as vouch_detail_id,null as vouch_date,
				d.v_year, null as v_month, '' as v_day,null as vouch_no,d.summary,to_char('') as subj_name,
				'' as other_subj_name, 0 as other_bal,d.debit,d.credit,d.acc_year,d.subj_code,d.bal,d.v_year||d.v_month|| '45' as numNo
			FROM d_table d
			
			UNION ALL
			<!-- 下日结转 -->
			SELECT
				e.group_id,e.hos_id,e.copy_code,null as vouch_id,null as vouch_detail_id, null as vouch_date,
				e.v_year,e.v_month,e.v_day,null as vouch_no, e.summary,to_char('') as subj_name,
				'' as other_subj_name,0 as other_bal,0 as debit,0 as credit,e.acc_year,e.subj_code,0 as bal,
				e.v_year||e.v_month||e.v_day||'43' as numNo
			FROM e_table e
		) t
		LEFT JOIN ACC_SUBJ subj
		ON
			t.group_id = subj.group_id
		  	AND t.hos_id = subj.hos_id
		  	AND t.copy_code = subj.copy_code
		  	AND t.acc_year = subj.acc_year
		  	AND t.subj_code = subj.subj_code
		ORDER BY t.numNo,t.vouch_date,t.vouch_no,t.vouch_detail_id
	</select>
	
	<!-- 	凭证记账，检查断号 -->
	<select id="queryAccVouchAconDH" parameterType="java.util.Map" resultType="String">
		select avt.vouch_type_short || '-' || av.vouch_no || ' 至 ' || avt.vouch_type_short || '-' || av.next_vouch_no || ' 断号' as summary
		from (
		  select group_id, hos_id, copy_code, vouch_id, vouch_no
		    , vouch_att_num, acc_year, acc_month, vouch_type_code, vouch_date
		    , create_user as create_id, cash_user as cash_id, audit_user as audit_id, acc_user as acc_id
		    , lead(vouch_no) over (order by vouch_type_code, vouch_no) as next_vouch_no
		  from acc_vouch a
		  where a.group_id = #{group_id}
		    and a.hos_id = #{hos_id}
		    and a.copy_code = #{copy_code}
		    and a.acc_year = #{acc_year}
		    and a.acc_month = #{acc_month}
		) av
		left join acc_vouch_type avt on av.group_id = avt.group_id
		and av.hos_id = avt.hos_id
		and av.copy_code = avt.copy_code
		and av.vouch_type_code = avt.vouch_type_code
		and avt.is_stop = 0 
		left join sys_user su1 on av.group_id = su1.group_id
		and av.hos_id = su1.hos_id
		and av.create_id = su1.user_id 
		left join sys_user su2 on av.group_id = su2.group_id
		and av.hos_id = su2.hos_id
		and av.cash_id = su2.user_id 
		left join sys_user su3 on av.group_id = su3.group_id
		and av.hos_id = su3.hos_id
		and av.audit_id = su3.user_id 
		  left join sys_user su on av.group_id = su.group_id
		and av.hos_id = su.hos_id
		and av.acc_id = su.user_id 
		where av.group_id = #{group_id}
		  and av.hos_id = #{hos_id}
		  and av.copy_code = #{copy_code}
		  and av.acc_year = #{acc_year}
		  and av.acc_month = #{acc_month}
		  and next_vouch_no - vouch_no > 1
		order by av.vouch_type_code,av.vouch_no asc
	</select>
	
	<select id="queryVouchByState99" parameterType="java.util.Map" resultType="java.lang.Integer">
		select count(1) from acc_vouch 
		where group_id = #{group_id} and hos_id= #{hos_id} and copy_code = #{copy_code} 
		and acc_year=#{acc_year} and acc_month=#{acc_month} and create_user!=#{user_id} 
		and state=99
	</select>
	
	<!-- 全部审核、全部取消 -->
	<update id="updateAuditAll" parameterType="java.util.Map">
	<![CDATA[
	begin
		
		declare 
		    TYPE ref_type IS REF CURSOR;--定义游标指针
		    v_cursor ref_type;--定义游标变量
		    v_vouch_id acc_vouch.vouch_id%TYPE;--根据表结构定义变量 
		    v_state acc_vouch.state%TYPE;--根据表结构定义变量 
		     
		    v_group_id number;
		    v_hos_id number;
		    v_copy_code varchar2(20);
		    v_acc_year varchar2(4);
		    v_acc_month varchar2(2);
		    v_user_id numeric(18,0);
		    v_flag number; 
		    v_parent_node_id number;
		    v_count number;
		    v_str varchar2(100);
		begin
		    v_group_id:=#{group_id};
		    v_hos_id:=#{hos_id};
		    v_copy_code:=#{copy_code};
		    v_acc_year:=#{acc_year};
		    v_acc_month:=#{acc_month};
		    v_user_id:=#{user_id};
		    v_flag:=#{flag};
		    
		   select parent_node_id into v_parent_node_id from acc_vouch_flow
		   where group_id=v_group_id and hos_id=v_hos_id and copy_code=v_copy_code and node_id=3;
		     
		    open v_cursor for      
		         SELECT vouch_id,state from acc_vouch
		         where group_id=v_group_id and hos_id=v_hos_id and copy_code=v_copy_code 
		         and acc_year=v_acc_year and acc_month=v_acc_month and create_user!=v_user_id and state>0 and state<99;
		    loop
		    fetch v_cursor into v_vouch_id,v_state;
		    exit when v_cursor%notfound;
		                  
		         if(v_flag=1) then
		              --审核
		              if(v_state=3 or v_parent_node_id!=v_state) then
		                   continue;
		              end if;
		              
		              update acc_vouch set state=3,audit_user=v_user_id,audit_date=sysdate
		              where group_id = v_group_id and hos_id=v_hos_id and copy_code=v_copy_code
		              and vouch_id=v_vouch_id;
		              
		         else
		              --取消审核
		              if(v_state!=3) then
		                   continue;
		              end if;
		              
		              if(v_parent_node_id=1) then
		                   --父节点=新建
		                   update acc_vouch set state=1,audit_user=null,audit_date=null
		                   where group_id = v_group_id and hos_id=v_hos_id and copy_code=v_copy_code
		                   and vouch_id=v_vouch_id;
		                   
		              elsif(v_parent_node_id=2) then
		                   --父节点=出纳签字
		                   select count(1) into v_count from acc_vouch_detail d
		                   inner join acc_subj s on d.group_id=s.group_id and d.hos_id=s.hos_id and d.copy_code=s.copy_code 
		                   and s.acc_year=v_acc_year and s.subj_nature_code in('02','03')
		                   where d.group_id = v_group_id and d.hos_id=v_hos_id and d.copy_code=v_copy_code
		                   and d.vouch_id=v_vouch_id;
		                   
		                   if(v_count>0) then
		                   
		                         update acc_vouch set state=2,audit_user=null,audit_date=null
		                         where group_id = v_group_id and hos_id=v_hos_id and copy_code=v_copy_code
		                         and vouch_id=v_vouch_id;
		                         
		                   else
		                         update acc_vouch set state=1,audit_user=null,audit_date=null
		                         where group_id = v_group_id and hos_id=v_hos_id and copy_code=v_copy_code
		                         and vouch_id=v_vouch_id;
		                         
		                   end if;
		                                      
		              end if;
		              
		         end if;
		            
		     end loop;
		   close v_cursor;  
		end;
		
	end;	
	]]>	
	</update>
	
</mapper>

