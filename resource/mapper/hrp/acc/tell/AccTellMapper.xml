<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.acc.dao.tell.AccTellMapper">
   
	<resultMap id="accTell" type="com.chd.hrp.acc.entity.AccTell">
		<result property="veri_id" column="veri_id" />
		<result property="veri_check_id" column="veri_check_id" />
		<result property="tell_id" column="tell_id" />  
		<result property="bank_id" column="bank_id" />
		<result property="group_id" column="group_id" />   
		<result property="hos_id" column="hos_id" /> 
		<result property="copy_code" column="copy_code" /> 
		<result property="acc_year" column="acc_year" />
		<result property="cash_subj_code" column="cash_subj_code" />
		<result property="other_subj_code" column="other_subj_code" />
		<result property="summary" column="summary" />
		<result property="att_num" column="att_num" />
		<result property="debit" column="debit" />
		<result property="credit" column="credit" />
		<result property="cur_code" column="cur_code" />
		<result property="debit_w" column="debit_w" />
		<result property="credit_w" column="credit_w" />
		<result property="bal_w" column="bal_w" />
		<result property="check_no" column="check_no" />
		<result property="busi_type" column="busi_type" />
		<result property="business_no" column="business_no" />
		<result property="occur_date" column="occur_date" />
		<result property="pay_type_code" column="pay_type_code" />
		<result property="pay_name" column="pay_name" />
		<result property="create_user" column="create_user" />
		<result property="create_date" column="create_date" />
		<result property="con_user" column="con_user" />
		<result property="con_date" column="con_date" />
		<result property="is_check" column="is_check" />
		<result property="check_user" column="check_user" />
		<result property="check_date" column="check_date" />
		<result property="is_init" column="is_init" />
		<result property="vouch_check_id" column="vouch_check_id" />
		<result property="vouch_id" column="vouch_id" />
		<result property="is_import" column="is_import" />
		<result property="is_auto" column="is_auto" />
		<result property="vouch_no" column="vouch_no"/>
		<result property="subj_dire" column="subj_dire"/>
		
		<result property="vouch_date" column="vouch_date" />
		<result property="tell_debit" column="tell_debit" />
		<result property="acct_debit" column="acct_debit" />
		<result property="rest_debit" column="rest_debit" />
		<result property="tell_credit" column="tell_credit" />
		<result property="acct_credit" column="acct_credit" />
		<result property="rest_credit" column="rest_credit" />
		<result property="tell_end_os" column="tell_end_os" />
		<result property="acct_end_os" column="acct_end_os" />
		<result property="rest_end_os" column="rest_end_os" />
		<result property="create_user_name" column="create_user_name" />
		<result property="con_user_name" column="con_user_name" />
		<result property="bal" column="bal" />
		<result property="is_por" column="is_por" />
		<result property="s_create_date" column="s_create_date" />
		<result property="s_con_date" column="s_con_date" />
		<result property="is_checks" column="is_checks" />
		<result property="other_subj_name" column="other_subj_name"/>
		<result property="other_subj_code" column="other_subj_code"/>
		<result property="tell_number" column="tell_number"/>
		<result property="price" column="price"/>
		<result property="tell_type_code" column="tell_type_code"/>
		<result property="sid" column="sid"/>
		<result property="user_id" column="user_id"/>
		
	</resultMap>
	<resultMap id="accTellMap" type="java.util.Map">
		<result property="veri_id" column="veri_id" />
		<result property="tell_id" column="tell_id" />  
		<result property="bank_id" column="bank_id" />
		<result property="group_id" column="group_id" />   
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" /> 
		<result property="acc_year" column="acc_year" />
		<result property="cash_subj_code" column="cash_subj_code" />
		<result property="other_subj_code" column="other_subj_code" />
		<result property="summary" column="summary" />
		<result property="att_num" column="att_num" />
		<result property="debit" column="debit" />
		<result property="credit" column="credit" />
		<result property="cur_code" column="cur_code" />
		<result property="debit_w" column="debit_w" />
		<result property="credit_w" column="credit_w" />
		<result property="bal_w" column="bal_w" />
		<result property="check_no" column="check_no" />
		<result property="busi_type" column="busi_type" />
		<result property="business_no" column="business_no" />
		<result property="occur_date" column="occur_date" />
		<result property="pay_type_code" column="pay_type_code" />
		<result property="pay_name" column="pay_name" />
		<result property="create_user" column="create_user" />
		<result property="create_date" column="create_date" />
		<result property="con_user" column="con_user" />
		<result property="con_date" column="con_date" />
		<result property="is_check" column="is_check" />
		<result property="check_user" column="check_user" />
		<result property="check_date" column="check_date" />
		<result property="is_init" column="is_init" />
		<result property="vouch_check_id" column="vouch_check_id" />
		<result property="vouch_id" column="vouch_id" />
		<result property="is_import" column="is_import" />
		<result property="is_auto" column="is_auto" />
		<result property="vouch_no" column="vouch_no"/>
		<result property="subj_dire" column="subj_dire"/>
		
		<result property="vouch_date" column="vouch_date" />
		<result property="tell_debit" column="tell_debit" />
		<result property="acct_debit" column="acct_debit" />
		<result property="rest_debit" column="rest_debit" />
		<result property="tell_credit" column="tell_credit" />
		<result property="acct_credit" column="acct_credit" />
		<result property="rest_credit" column="rest_credit" />
		<result property="tell_end_os" column="tell_end_os" />
		<result property="acct_end_os" column="acct_end_os" />
		<result property="rest_end_os" column="rest_end_os" />
		<result property="create_user_name" column="create_user_name" />
		<result property="con_user_name" column="con_user_name" />
		<result property="bal" column="bal" />
		<result property="is_por" column="is_por" />
		<result property="s_create_date" column="s_create_date" />
		<result property="s_con_date" column="s_con_date" />
		<result property="is_checks" column="is_checks" />
		<result property="other_subj_name" column="other_subj_name"/>
		<result property="other_subj_code" column="other_subj_code"/>
		<result property="tell_number" column="tell_number"/>
		<result property="price" column="price"/>
		<result property="tell_type_code" column="tell_type_code"/>
		<result property="sid" column="sid"/>
		<result property="user_id" column="user_id"/>
		
	</resultMap>

	<insert id="addAccTell" useGeneratedKeys="true">

		<selectKey resultType="java.lang.Integer" order="BEFORE" keyProperty="tell_id">
			SELECT ACC_TELL_SEQ.NEXTVAL as tell_id  FROM DUAL
		</selectKey>
		
		INSERT INTO ACC_TELL (
			tell_id		,
			group_id		,
			hos_id		,
			copy_code		,
			acc_year		,
			cash_subj_code		,
			other_subj_code		,
			summary		,
			att_num		,
			debit		,
			credit		,
			debit_w		,
			credit_w		,
			check_no		,
			busi_type		,
			business_no		,
			occur_date		,
			pay_type_code		,
			create_user		,
			create_date		,
			con_user		,
			con_date		,
			state		,
			check_user		,
			check_date		,
			is_init		,
			vouch_check_id		,
			vouch_detail_id		,
			vouch_id		,
			is_import		,
			is_con		,
			tell_number		,
			tell_type_code,
			is_check
		) VALUES (
			#{tell_id,jdbcType=INTEGER} ,
			#{group_id,jdbcType=INTEGER} ,
			#{hos_id,jdbcType=INTEGER} ,
			#{copy_code,jdbcType=VARCHAR} ,
			#{acc_year,jdbcType=VARCHAR} ,
			#{cash_subj_code,jdbcType=VARCHAR} ,
			#{other_subj_code,jdbcType=VARCHAR},
			#{summary,jdbcType=VARCHAR} ,
			#{att_num,jdbcType=INTEGER},
			#{debit,jdbcType=INTEGER} ,
			#{credit,jdbcType=INTEGER} ,
			0 ,
			0 ,
			#{check_no,jdbcType=INTEGER},
			'' ,
			'',
			to_date(#{occur_date},'yyyy/MM/dd'),
			#{pay_type_code,jdbcType=VARCHAR} ,
			#{create_user,jdbcType=INTEGER} ,
			to_date(#{create_date},'yyyy/MM/dd'),
			0,
			'',
			1,
			'',
			'',
			#{is_init,jdbcType=INTEGER},
			'' ,
			'',
			'',
			0,
			0,
			#{tell_number,jdbcType=VARCHAR},
			#{tell_type_code,jdbcType=VARCHAR},
			0
		)

	</insert>
	
	<insert id="addAccTellByBank" useGeneratedKeys="true">

		INSERT INTO ACC_TELL (
			tell_id, group_id, hos_id, copy_code, acc_year, cash_subj_code, summary , debit ,credit, att_num, debit_w ,
			credit_w , check_no , occur_date , pay_type_code , create_user , create_date , con_user , con_date , state ,
			check_user , check_date , is_init , vouch_check_id , vouch_detail_id , vouch_id , is_import ,is_con,is_check
		) VALUES (
			ACC_TELL_SEQ.nextval , #{group_id} ,#{hos_id} ,#{copy_code} ,#{acc_year} ,#{cash_subj_code} ,#{summary} ,#{debit} ,
			#{credit} , 0,0 ,0 ,#{check_no},to_date(#{occur_date},'yyyy/MM/dd'),#{pay_type_code} ,#{create_user} ,to_date(#{create_date},'yyyy/MM/dd'),
			0, '', 1, '', '', #{is_init},'' ,'','',0,0,0
		)

	</insert>
	
	<select id="queryAccTellNextSeq" resultType="java.lang.Long" useCache="false" flushCache="true">
		SELECT ACC_TELL_SEQ.NEXTVAL as tell_id FROM DUAL
	</select>
	
	<insert id="addBatchAccTell" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			INSERT INTO ACC_TELL (
				tell_id		,
				group_id		,
				hos_id		,
				copy_code		,
				acc_year		,
				cash_subj_code		,
				other_subj_code		,
				summary		,
				att_num		,
				debit		,
				credit		,
				debit_w		,
				credit_w		,
				check_no		,
				busi_type		,
				business_no		,
				occur_date		,
				pay_type_code		,
				create_user		,
				create_date		,
				con_user		,
				con_date		,
				state		,
				check_user		,
				check_date		,
				is_init		,
				vouch_check_id		,
				vouch_detail_id		,
				vouch_id		,
				is_import		,
				is_con		,
				tell_number		,
				tell_type_code,is_check
			) values(
				<choose>
					<when test="item.tell_id != null and item.tell_id != ''">
						#{item.tell_id,jdbcType=INTEGER} ,
					</when>
					<otherwise>
						ACC_TELL_SEQ.NEXTVAL,
					</otherwise>
				</choose>
				#{item.group_id,jdbcType=INTEGER} ,
				#{item.hos_id,jdbcType=INTEGER} ,
				#{item.copy_code,jdbcType=VARCHAR} ,
				#{item.acc_year,jdbcType=VARCHAR} ,
				#{item.cash_subj_code,jdbcType=VARCHAR} ,
				#{item.other_subj_code,jdbcType=VARCHAR},
				#{item.summary,jdbcType=VARCHAR} ,
				#{item.att_num,jdbcType=INTEGER},
				#{item.debit,jdbcType=INTEGER} ,
				#{item.credit,jdbcType=INTEGER} ,
				0 ,
				0 ,
				#{item.check_no,jdbcType=INTEGER},
				'' ,
				'' ,
				to_date(#{item.occur_date},'yyyy/MM/dd'),
				#{item.pay_type_code,jdbcType=VARCHAR} ,
				#{item.create_user,jdbcType=INTEGER} ,
				to_date(#{item.create_date},'yyyy/MM/dd'),
				0 ,
				'',
				1 ,
				'' ,
				'' ,
				#{item.is_init,jdbcType=INTEGER},
				'' ,
				'' ,
				'' ,
				0 ,
				0 ,
				#{item.tell_number,jdbcType=VARCHAR},
				#{item.tell_type_code,jdbcType=VARCHAR},0
			)
		</foreach>	
	</insert>

	<update id="updateBatchAccTell" parameterType="java.util.List">

		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
	         UPDATE acc_tell
			<trim prefix="SET"  suffixOverrides=","> 
			<if test="item.acc_year != null and item.acc_year != ''">
			acc_year = #{item.acc_year}
			,
			</if>
			<if test="item.summary != null and item.summary != ''">
			summary = #{item.summary}
			,
			</if>
			<if test="item.att_num != null and item.att_num != ''">
			att_num = #{item.att_num}
			,
			</if>
			<if test="item.debit != null and item.debit != ''">
			debit = #{item.debit}
			,
			</if>
			<if test="item.credit != null and item.credit != ''">
			credit = #{item.credit}
			,
			</if>
			<if test="item.cur_code != null and item.cur_code != ''">
			cur_code = #{item.cur_code}
			,
			</if>
		    <if test="item.debit_w != null and item.debit_w != ''">
			debit_w = #{item.debit_w}
			,
			</if>
		    <if test="item.credit_w != null and item.credit_w != ''">
			credit_w = #{item.credit_w}
			,
			</if>
		    <if test="item.bal_w != null and item.bal_w != ''">
			bal_w = #{item.bal_w}
			,
			</if>
			<if test="item.check_no != null and item.check_no != ''">
			check_no = #{item.check_no}
			,
		    </if>
		    <if test="item.busi_type != null and item.busi_type != ''">
			busi_type = #{item.busi_type}
			,
			</if>
		    <if test="item.business_no != null and item.business_no != ''">
			business_no = #{business_no}
			,
			</if>
			<if test="item.occur_date != null and item.occur_date != ''">
			occur_date = to_date(#{item.occur_date},'yyyy/MM/dd')
			,
			</if>
		    <if test="item.pay_type_code != null and item.pay_type_code != ''">
			pay_type_code = #{item.pay_type_code}
			,
			</if>
		    <if test="item.create_user != null and item.create_user != ''">
			create_user = #{item.create_user}
			,
			</if>
		    <if test="item.create_date != null and item.create_date != ''">
			create_date = to_date(#{item.create_date},'yyyy/MM/dd')
			,
			</if>
		    <if test="item.con_user != null and item.con_user != ''">
			con_user = #{item.con_user,jdbcType=INTEGER}
			,
			</if>
			<if test="item.cancel_con_user != null and item.cancel_con_user != ''">
			con_user = null
			,
			</if>
		    <if test="item.con_date != null and item.con_date != ''">
			con_date = to_date(#{item.con_date},'yyyy/MM/dd')
			,
			</if> 
			<if test="item.cancel_con_date != null and item.cancel_con_date != ''">
			con_date = null
			,
			</if> 
			<if test="item.is_con != null and item.is_con != ''">
			is_con = #{item.is_con,jdbcType=INTEGER}
			,
			</if>
		    <if test="item.is_check != null and item.is_check != ''">
			is_check = #{item.is_check}
			,
			</if>
		    <if test="item.check_user != null and item.check_user != ''">
			check_user = #{item.check_user}
			,
			</if>
		    <if test="item.check_date != null and item.check_date != ''">
			check_date = #{item.check_date}
			,
			</if>
		    <if test="item.is_init != null and item.is_init != ''">
			is_init = #{item.is_init}
			,
			</if>
		    <if test="item.vouch_check_id != null and item.vouch_check_id != ''">
			vouch_check_id = #{item.vouch_check_id}
			,
			</if>
		    <if test="item.vouch_id != null and item.vouch_id != ''">
			vouch_id = #{item.vouch_id}
			,
			</if>
		    <if test="item.is_import != null and item.is_import != ''">
			is_import = #{item.is_import}
			,
			</if>
			<if test="item.sql != null and item.sql != ''">
				AND ${sql}
			
			</if>
			</trim>
		    <where>                   
			<if test="item.group_id != null and item.group_id != ''">
			AND group_id = #{item.group_id,jdbcType=INTEGER}
			</if>  
			<if test="item.hos_id != null and item.hos_id != ''">
			AND hos_id = #{item.hos_id,jdbcType=INTEGER}
			</if>  
			<if test="item.copy_code != null and item.copy_code != ''">
			AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
			</if>  
			<if test="item.tell_id != null and item.tell_id != ''">
			AND tell_id = #{item.tell_id,jdbcType=INTEGER}
			</if>
			</where>
		</foreach>
	</update>

	<delete id="deleteAccTell" parameterType="java.util.Map">
		DELETE FROM acc_tell 
		WHERE tell_id = #{tell_id} 
			and group_id = #{group_id} 
			and hos_id = #{hos_id} 
			and copy_code = #{copy_code}
	</delete>
	
	<delete id="deleteBatchAccTell" parameterType="java.util.List">
		DELETE FROM acc_tell WHERE
		<foreach collection="list" index="index" item="item" open="("
			separator="or" close=")">
			(tell_id = #{item.tell_id}	and
			<if test="item.create_date != null and item.create_date != ''">
			create_date = to_date(#{item.create_date},'yyyy/MM/dd')	and
			</if>
			<if test="item.occur_date != null and item.occur_date != ''">
			occur_date = to_date(#{item.occur_date},'yyyy/MM/dd')	and
			</if>
				group_id = #{item.group_id}
			and hos_id = #{item.hos_id}
			and copy_code = #{item.copy_code})
		</foreach>
	</delete>

	<select id="queryAccTellByCode" resultType="com.chd.hrp.acc.entity.AccTell" parameterType="string">
		SELECT
		    at.tell_id, at.group_id, at.hos_id, at.copy_code, at.acc_year, at.cash_subj_code, at.other_subj_code,
		    at.summary, at.att_num, at.debit, at.credit, at.debit_w, at.credit_w, at.check_no, at.busi_type, at.business_no,
		    at.occur_date, at.pay_type_code, at.create_user, at.create_date, at.con_user, at.con_date,at.check_user,
		    at.check_date, at.is_init, at.vouch_check_id, at.vouch_id, at.is_import, at.tell_number, sa.subj_name,
		    sa.subj_id, sa.subj_code as cash_subj_code, sas.subj_name as other_subj_name,
		    sas.subj_code as other_subj_code, apt.pay_name,
		    nvl(
		    	(SELECT 1
					FROM ACC_BANK_VERI a
					WHERE 
						at.group_id = a.group_id
						AND at.hos_id = a.hos_id
						AND at.copy_code = a.copy_code
						AND at.acc_year = a.acc_year
						AND at.tell_id = a.tell_id
				),0) is_checks
				
		    FROM acc_tell at
		    
		    LEFT JOIN acc_subj sa ON at.group_id = sa.group_id
		    AND at.hos_id = sa.hos_id
		    AND at.copy_code = sa.copy_code
		    AND at.acc_year = sa.acc_year
		    AND at.cash_subj_code = sa.subj_code
		    
		    LEFT JOIN acc_subj sas ON at.group_id = sas.group_id
		    AND at.hos_id = sas.hos_id
		    AND at.copy_code = sas.copy_code
		    AND at.acc_year = sas.acc_year
		    AND at.other_subj_code = sas.subj_code
		    
			LEFT JOIN acc_pay_type apt ON at.group_id = apt.group_id
			AND at.hos_id = apt.hos_id
			AND at.copy_code = apt.copy_code
			AND at.pay_type_code = apt.pay_code 
		<where>
		
			at.group_id = #{group_id} 
			AND at.hos_id = #{hos_id}
			AND at.copy_code = #{copy_code}
				
			<if test="acc_year != null and acc_year != '' ">
				AND at.acc_year = #{acc_year}
			</if>
			<if test="occur_date != null and occur_date !='' ">
				AND at.occur_date = to_date(#{occur_date},'yyyy/MM/dd')
			</if>
			<if test="is_con != null and is_con !=''">
				AND at.is_con = #{is_con}
			</if>
			<if test="tell_id != null and tell_id != ''">
				AND at.tell_id = #{tell_id} 
			</if>
		</where>
		
	</select>
	<select id="queryAccTell" parameterType="java.util.Map" resultMap="accTell">

		SELECT
			abv.veri_check_id,abv.veri_id,att.tell_id bank_id, att.tell_id,att.group_id,att.hos_id,att.copy_code,att.acc_year,
		    att.cash_subj_code,sa.subj_name  cash_subj_name,att.other_subj_code,sas.subj_name as other_subj_name,
      		sas.subj_dire, att.summary,att.occur_date, att.att_num,att.debit,att.credit,
      		case when nvl(att.debit,0)=0 then nvl(att.credit,0) else nvl(att.debit,0) end price,
		    att.debit_w,att.credit_w, att.check_no,att.busi_type,att.business_no,att.pay_type_code,att.create_user,
		    att.create_date,att.con_user, att.con_date, att.check_user, att.check_date,att.is_init, att.vouch_check_id,
		    att.vouch_id, att.is_import, apt.pay_name,
		    case (
		    	select 1 from ACC_TELL_VERI a 
		    	where 
		    	att.group_id = a.group_id
			    AND att.hos_id = a.hos_id
			    AND att.copy_code = a.copy_code
			    AND att.acc_year = a.acc_year
			    AND att.tell_id = a.tell_id 
			) when 1 then '已对账' else '未对账' end is_checks,
		    abv.is_auto,
		    avt.vouch_type_short||'-'||av.vouch_no vouch_no
		    
    	FROM ACC_TELL att
      	LEFT JOIN acc_pay_type apt 
      	ON 
      		att.group_id = apt.group_id
	        AND att.hos_id = apt.hos_id
	        AND att.copy_code = apt.copy_code
	        AND att.pay_type_code = apt.pay_code 
      	LEFT JOIN ACC_TELL_VERI abv 
      	ON 
      		att.group_id = abv.group_id
	        AND att.hos_id = abv.hos_id
	        AND att.copy_code = abv.copy_code
	        AND att.acc_year = abv.acc_year
	        and att.tell_id = abv.tell_id
      	LEFT JOIN ACC_VOUCH av 
      	ON 
      		att.hos_id = av.hos_id
	        AND att.copy_code = av.copy_code
	        AND att.acc_year = av.acc_year 
	        and att.vouch_id = av.vouch_id 
      	LEFT JOIN ACC_VOUCH_TYPE avt on 
	         av.vouch_type_code = avt.vouch_type_code
	         AND av.group_id = avt.group_id 
	         AND av.hos_id = avt.hos_id 
	         AND av.copy_code = avt.copy_code 
      	LEFT JOIN ACC_SUBJ sa 
      	ON 
      		att.group_id = sa.group_id
          	AND att.hos_id = sa.hos_id
          	AND att.copy_code = sa.copy_code
          	AND att.acc_year = sa.acc_year
          	AND att.cash_subj_code = sa.subj_code
      	LEFT JOIN acc_subj sas 
      	ON 
      		att.group_id = sas.group_id
          	AND att.hos_id = sas.hos_id
          	AND att.copy_code = sas.copy_code
          	AND att.acc_year = sas.acc_year
          	AND att.other_subj_code = sas.subj_code	 
		<where>
				att.group_id = #{group_id}
				AND att.hos_id = #{hos_id}
				AND att.copy_code = #{copy_code}
				
			<if test="acc_year != null and acc_year != ''">
				AND att.acc_year = #{acc_year}
			</if>
			
			<if test="tell_id != null and tell_id != ''">
				AND att.tell_id = #{tell_id}
			</if>
			
			<if test="subj_code != null and subj_code != '' and subj_code != 'undefined'">
				AND att.cash_subj_code = #{subj_code}
			</if>
			
			<if test="other_subj_code != null and other_subj_code != ''">
				AND att.other_subj_code = #{other_subj_code}
			</if>
			
			<if test="direct != null and direct != ''">
				${direct}
			</if>
			
			<if test="summary != null and summary != ''">
				AND att.summary like '%${summary}%'
			</if>
			
			<if test="att_num != null and att_num != ''">
				AND att.att_num = #{att_num}
			</if>
			
			<if test="price1 != '' and price1 != '' and price2 != null and price2 != null  and price1 != 'undefined' and price2 != 'undefined'">
				AND (att.debit between #{price1} and #{price2} OR att.credit between #{price1} and #{price2})
			</if>
			
			<if test="debit_w != null and debit_w != ''">
				AND att.debit_w = #{debit_w}
			</if>
			
			<if test="credit_w != null and credit_w != ''">
				AND att.credit_w = #{credit_w}
			</if>
			
			<if test="check_no != null and check_no != ''">
				AND att.check_no like '%${check_no}%'
			</if>
			
			<if test="busi_type != null and busi_type != ''">
				AND att.busi_type = #{busi_type}
			</if>
			
			<if test="business_no != null and business_no != ''">
				AND att.business_no = #{business_no}
			</if>
			
			<if test="acc_time1 != null and acc_time1 != '' and acc_time2 != null and acc_time2 != '' and acc_time1 != 'undefined' and acc_time2 != 'undefined'">
                AND att.occur_date between to_date(#{acc_time1},'yyyy/MM/dd') and to_date(#{acc_time2},'yyyy/MM/dd')
             </if>
			<if test="pay_type_code != null and pay_type_code != ''">
				AND att.pay_type_code = #{pay_type_code}
			</if>
			<if test="create_user != null and create_user != ''">
				AND att.create_user = #{create_user}
			</if>
			<if test="create_date != null and create_date != ''">
				AND att.create_date = #{create_date}
			</if>
			<if test="con_user != null and con_user != ''">
				AND att.con_user = #{con_user}
			</if>
			<if test="con_date != null and con_date != ''">
				AND att.con_date = #{con_date}
			</if>
			<if test="check_user != null and check_user != ''">
				AND att.check_user = #{check_user}
			</if>
			<if test="acc_date1 != null and acc_date1 != '' and acc_date2 != null and acc_date2 != ''">
				AND att.create_date between to_date(#{acc_date1},'yyyy/MM/dd') and to_date(#{acc_date2},'yyyy/MM/dd')
			</if>
			<if test="is_init != null and is_init != ''">
				AND att.is_init = #{is_init}
			</if>
			<if test="vouch_check_id != null and vouch_check_id != ''">
				AND att.vouch_check_id = #{vouch_check_id}
			</if>
			<if test="vouch_id != null and vouch_id != ''">
				AND att.vouch_id = #{vouch_id}
			</if>
			<if test="is_import != null and is_import != ''">
				AND att.is_import = #{is_import}
			</if>
			<if test="is_con != null and is_con != '' ">
				AND att.is_con = #{is_con}
			</if>
			<if test="acc_time != null and acc_time != '' ">
				AND att.occur_date = to_date(#{acc_time},'yyyy/MM/dd')
			</if>
			<if test="now_accYearMonth != null and now_accYearMonth != '' ">
				AND to_char(att.occur_date,'yyyy/MM') = #{now_accYearMonth}
			</if>
			<if test="state == 0">
			and not exists(select 1 from ACC_TELL_VERI b where att.group_id = b.group_id
						    AND att.hos_id = b.hos_id
						    AND att.copy_code = b.copy_code
						    AND att.acc_year = b.acc_year
						    AND att.tell_id = b.tell_id )
   			</if> 
			<if test="state == 1">
			and  exists(select 1 from ACC_TELL_VERI b where att.group_id = b.group_id
						    AND att.hos_id = b.hos_id
						    AND att.copy_code = b.copy_code
						    AND att.acc_year = b.acc_year
						    AND att.tell_id = b.tell_id )
   			</if>
			
		</where>
		order by att.tell_id asc
	</select>
	
	<!-- 查询现金出纳账 -->
	<select id="queryCashAccount" parameterType="java.util.Map"
		resultMap="accTell">

		select
		at.tell_id,at.create_date,at.summary,at.att_num,at.check_no,at.other_subj_code,at.debit,at.credit,su.user_name,suser.user_name,at.con_date,av.vouch_no
		from acc_tell at
		left join acc_subj asubj on at.group_id = asubj.group_id and at.hos_id = asubj.hos_id and at.copy_code = asubj.copy_code
			and at.acc_year = asubj.acc_year and at.other_subj_code = asubj.subj_code
		left join sys_user su on at.group_id = su.group_id and at.hos_id = su.hos_id and at.create_user = su.user_code
		left join sys_user suser on at.group_id = su.group_id and at.hos_id = su.hos_id
			and at.con_user = su.user_code
		left join acc_vouch av on at.group_id = av.group_id and at.hos_id = av.hos_id and at.copy_code = av.copy_code
			and at.vouch_id = av.vouch_id
		<where>
			<if test="tell_id != null and tell_id != ''">
				AND at.tell_id = #{tell_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND at.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND at.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND at.copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				AND at.acc_year = #{acc_year}
			</if>
			<if test="occur_date != null and occur_date != ''  and occur_time != null and occur_time != ''" >
				AND at.occur_date in( #{occur_date},#{occur_time})
			</if>
			<if test="subj_code != null and subj_code != ''">
				AND at.cash_subj_code = #{subj_code}
			</if>
			<if test="con_user != null and con_user != ''">
				AND at.con_user != ''
			</if>
			<if test="nature_code != null and nature_code != ''">
				AND asubj.subj_nature_code = #{nature_code}
			</if>
		</where>
		order by at.tell_id asc
	</select>
	
	<select id="queryAccCheck" statementType="CALLABLE" parameterType="java.util.Map" resultType="java.util.Map">
		<![CDATA[ 
	{call act_account_checkquery(
	#{group_id,jdbcType=INTEGER, mode=IN},
	#{hos_id,jdbcType=INTEGER, mode=IN},
	#{copy_code,jdbcType=VARCHAR, mode=IN},
	#{begin_date,jdbcType=VARCHAR, mode=IN},
	#{end_date,jdbcType=VARCHAR, mode=IN},
	#{subj_code,jdbcType=VARCHAR, mode=IN},
	#{tell_flag,jdbcType=INTEGER, mode=IN},
	#{acct_flag,jdbcType=INTEGER, mode=IN},
	#{objdata,jdbcType=CURSOR,mode=OUT,resultMap=accTell}
	)}]]>  
	</select>
	
	<select id="queryAccCheckPrint" statementType="CALLABLE" parameterType="java.util.Map" >
		<![CDATA[ 
			{call act_account_checkquery(
				#{group_id,jdbcType=INTEGER, mode=IN},
				#{hos_id,jdbcType=INTEGER, mode=IN},
				#{copy_code,jdbcType=VARCHAR, mode=IN},
				#{begin_date,jdbcType=VARCHAR, mode=IN},
				#{end_date,jdbcType=VARCHAR, mode=IN},
				#{subj_code,jdbcType=VARCHAR, mode=IN},
				#{tell_flag,jdbcType=INTEGER, mode=IN},
				#{acct_flag,jdbcType=INTEGER, mode=IN},
				#{objdata,mode=OUT,jdbcType=CURSOR,resultMap=com.chd.hrp.acc.dao.AccInitialBalanceCalibrationMapper.assMap,javaType=java.sql.ResultSet}
		)}]]>  
	</select>
	
	<select id="queryAccCheckList"  parameterType="java.util.Map" resultMap="accTell">
		select 
		tmp_date,
		tell_amt_debit,
		acct_amt_debit,
		rest_amt_debit,
		tell_amt_credit,
		acct_amt_credit,
		rest_amt_credit,
		tell_result,
		acct_result,
		rest_result 
	 	from acc_tmp
		order by order_type, tmp_date
	</select> 
	
	
	<select id="queryCashAccountByCode" parameterType="java.util.Map" resultMap="accTell">
		WITH v_table AS(
			<!--期初余额 -->
			SELECT
				null as tell_id, null as subj_code,'' as occur_date,'期初余额' as summary ,0 as att_num,'' as check_no,
				to_char('') as subj_name,0 as  debit,0 as credit,
				bal,
				'' as user_name,'' as con_user,'' as con_date,'' as vouch_no,'' as is_import,null as is_con 
			FROM (
				select sum(nvl(bal, 0)) as bal 
				from (
					(	<!-- 财务帐表余额 -->
						SELECT al.end_os as bal 
						FROM acc_leder al 
						WHERE al.group_id = #{group_id} 
						  AND al.hos_id =#{hos_id}
						  AND al.copy_code = #{copy_code} 
						  AND al.acc_year = #{acc_year} 
						  AND al.acc_month = '00' 
						  AND al.subj_code = #{subj_code}
					)
					<if test="acc_year==start_year">
						union all
						<!-- 凭证明细表借方减贷方 -->
						(
							SELECT nvl(sum(avd.debit),0)-nvl(sum(avd.credit),0) as bal 
							FROM ACC_VOUCH_DETAIL avd
							LEFT JOIN ACC_VOUCH av 
								   ON avd.group_id = av.group_id 
								  AND avd.hos_id = av.hos_id 
								  AND avd.copy_code = av.copy_code
								  AND avd.vouch_id = av.vouch_id 
								  and avd.acc_year = av.acc_year
							WHERE avd.group_id = #{group_id}
							  AND avd.hos_id = #{hos_id}
							  AND avd.copy_code = #{copy_code} 
							  AND avd.subj_code = #{subj_code}
							  AND avd.acc_year = #{acc_year} 
							  AND av.acc_month &lt; #{start_month}
						)
					</if>
					union all
					<!-- 出纳帐制单日期小于开始日期的发生数 -->
					(
						SELECT nvl(sum(act.debit),0)-nvl(sum(act.credit),0) AS bal 
						FROM ACC_TELL act
						WHERE act.group_id = #{group_id}
						  AND act.hos_id = #{hos_id} 
						  AND act.copy_code = #{copy_code}
						  AND act.acc_year = #{acc_year}
						  AND act.cash_subj_code = #{subj_code}
						  AND act.occur_date &lt; to_date(#{begin_date},'yyyy/MM/dd')
						  AND act.is_init = '0'
					)
				)
			)
		),
			a_table AS (
				<!-- 每天的发生数据 -->
				SELECT 
					att.tell_type_name||'-'||act.tell_number tell_number,act.tell_id,act.cash_subj_code as subj_code,
					to_char(act.occur_date,'yyyy-MM-dd') as occur_date,act.summary, act.att_num,act.check_no, 
					<!-- asubj.subj_name, --> 
					asubj.subj_code other_subj_code,to_char(asubj.subj_code ||'  '|| asubj.subj_name) subj_name,
					act.debit, act.credit, act.debit-act.credit as bal, su.user_name,sus.user_name as con_user,
					to_char(act.con_date,'yyyy/MM/dd') as con_date,
					case when av.vouch_no is not null then avt.vouch_type_name || '-' || av.vouch_no  else '' end vouch_no,
					case when act.is_import=1 then '是' else '否' end as is_import,
					act.is_con,apt.pay_code,apt.pay_name,att.tell_type_code
				FROM ACC_TELL act 
				
				LEFT JOIN ACC_SUBJ asubj
				ON 
					act.group_id= asubj.group_id 
					and act.hos_id = asubj.hos_id 
					and act.copy_code = asubj.copy_code 
					and act.acc_year=asubj.acc_year
					and act.other_subj_code = asubj.subj_code
					
				LEFT JOIN SYS_USER su 
				ON
					act.group_id = su.group_id 
				 	AND act.hos_id = su.hos_id 
				 	AND act.create_user = su.user_id
				 	
				LEFT JOIN SYS_USER sus 
				ON
					act.group_id = sus.group_id 
					AND act.hos_id = sus.hos_id 
					AND act.con_user = sus.user_id
					
				LEFT JOIN ACC_VOUCH av 
				ON 
					act.group_id = av.group_id
					AND act.hos_id = av.hos_id and act.copy_code = av.copy_code 
					AND act.acc_year = av.acc_year
				 	AND act.vouch_id = av.vouch_id
				 	
				LEFT JOIN ACC_VOUCH_TYPE avt 
				ON 
					av.group_id =avt.group_id
			        AND av.hos_id=avt.hos_id 
			        AND av.copy_code=avt.copy_code
			        AND av.vouch_type_code=avt.vouch_type_code 
			        
				LEFT JOIN ACC_PAY_TYPE apt 
				ON 
					apt.group_id = act.group_id
                 	AND apt.hos_id = act.hos_id  
                 	AND apt.copy_code = act.copy_code
                 	AND apt.pay_code = act.pay_type_code
                 	
                LEFT JOIN ACC_TELL_TYPE att 
                ON 
	                att.group_id = act.group_id
			        AND att.hos_id = act.hos_id
			        AND att.copy_code = act.copy_code
			        AND att.tell_type_code = act.tell_type_code 
		         
				<where>
			 	    act.is_init = 0
			 		<if test="group_id != null and group_id != ''">
			 			AND act.group_id = #{group_id} 
			 		</if>
			 		<if test="hos_id != null and hos_id != ''">
			 			AND act.hos_id = #{hos_id}
			 		</if>
			 		<if test="copy_code !=null and copy_code !=''">
			 			AND act.copy_code=#{copy_code} 
			 		</if>
			 		<if test="subj_code !=null and subj_code !=''">
			 			AND act.cash_subj_code=#{subj_code}
			 		</if>
			 		<if test="begin_date != null and begin_date !='' and end_date != null and end_date !=''">
			 			AND act.occur_date between to_date(#{begin_date},'yyyy/MM/dd') and to_date(#{end_date},'yyyy/MM/dd')
			 		</if>
			 		<if test="is_con != null and is_con !=''">
			 			and act.is_con=#{is_con} 
			 		</if>
			 		<if test="vouch_no != null and vouch_no !='' and vouch_no ==0">
			 			and act.vouch_id  is null
			 		</if>
			 		<if test="vouch_no != null and vouch_no !='' and vouch_no ==1 ">
			 			and act.vouch_id is not null
			 		</if>
			 		<if test="pay_code != null and pay_code !=''">
			 			 and apt.pay_code=#{pay_code} 
			 		</if>
			 		<if test="summary != null and summary !=''">
			 			and act.summary like '%${summary}%' 
			 		</if>
			 		<if test="tell_num != null and tell_num !=''">
			 			and (to_number(act.tell_number) >= to_number(#{tell_num}))
			 		</if>
			 		<if test="tell_number != null and tell_number !=''">
			 		    and (to_number(act.tell_number) &lt;= to_number(#{tell_number}))
			 		</if>
			 		<if test="tell_debit != null and tell_debit !='' and tell_credit != null and tell_credit !=''">
			 		  and (act.debit  >=  #{tell_debit} and act.debit   &lt;=  #{tell_credit}
			 		  or  act.credit  >=  #{tell_debit} and act.credit  &lt;=  #{tell_credit})
			 		 </if>
			 		 <if test="tell_debit != null and tell_debit !='' and tell_credit == null and tell_credit ==''">
			 		  and (act.debit  >=  #{tell_debit} or  act.credit  >=  #{tell_debit})
			 		 </if>
			 		 <if test="tell_credit != null and tell_credit !='' and tell_debit == null and tell_debit ==''">
			 		  and ( act.debit   &lt;=  #{tell_credit} and act.credit  &lt;=  #{tell_credit})
			 		 </if>
			 		 <!-- <if test="nature_code != null and nature_code !=''">
			 			and act.tell_type_code=#{nature_code} 
			 		</if> -->
			 	</where> 
				 	order by att.tell_type_code	 	
			 ),
			 
			 b_table as (
				<!--  本日合计 -->
				SELECT 
					null as tell_id,null as subj_code, t.occur_date,'本日合计' as summary ,0 as att_num,'' as check_no,
					to_char('') as subj_name, sum(t.debit) as debit,sum(t.credit) as credit,0 as  bal,'' as user_name,
					'' as con_user,'' as con_date, '' as vouch_no,'' as is_import,null as is_con
				FROM ( 
					SELECT 
						act.cash_subj_code,act.group_id, act.hos_id, act.copy_code,to_char(act.occur_date,'yyyy-MM-dd') as occur_date,
						sum(act.debit) as debit,sum(act.credit) as credit,sum(act.debit-act.credit) as  bal
					FROM ACC_TELL act 
					LEFT JOIN ACC_SUBJ asubj
						 ON act.group_id= asubj.group_id 
						 AND act.hos_id = asubj.hos_id 
						 AND act.copy_code = asubj.copy_code 
						 AND act.acc_year=asubj.acc_year
						 AND act.cash_subj_code = asubj.subj_code
					<where>
						 act.group_id=#{group_id} 
						 AND act.hos_id=#{hos_id} 
						 AND act.copy_code = #{copy_code}
						 AND act.acc_year = #{acc_year} 
						 AND act.occur_date between to_date(#{begin_date},'yyyy/MM/dd') and to_date(#{end_date},'yyyy/MM/dd')
						 AND act.cash_subj_code=#{subj_code}
						 AND act.is_init = 0
						 
						 <if test="is_con != null and is_con != ''">
						 	AND act.is_con = #{is_con}
						 </if>
						 <!-- <if test="tell_num != null and tell_num !=''">
				 			and (to_number(act.tell_number) >= to_number(#{tell_num}))
				 		</if>
				 		<if test="tell_number != null and tell_number !=''">
				 		    and (to_number(act.tell_number) &lt;= to_number(#{tell_number}))
				 		</if>
				 		<if test="tell_debit != null and tell_debit !=''">
				 		  and (act.debit  >=  #{tell_debit} or act.credit  >=  #{tell_debit})
				 		 </if>
				 		<if test="tell_credit != null and tell_credit !=''">
					 			 and (act.debit   &lt;=  #{tell_credit} or act.credit  &lt;=  #{tell_credit})
					 		</if> -->
					 		
				 		<if test="summary != null and summary !=''">
				 			and act.summary like '%${summary}%' 
				 		</if>
				 		
				 		<!-- <if test="nature_code != null and nature_code !=''">
				 			and act.tell_type_code=#{nature_code} 
				 		</if> -->
					</where> 
					 GROUP BY act.cash_subj_code,act.group_id,act.hos_id,act.copy_code,act.occur_date,act.cash_subj_code
				) t 
				GROUP BY t.cash_subj_code,t.group_id,t.hos_id,t.copy_code,t.occur_date
			),
			
			
			<!-- 本月合计-->
			c_table AS (
				SELECT
					null as tell_id, null as subj_code,t.occur_date,'本月合计' as summary ,0 as att_num,'' as check_no,
					to_char('') as subj_name,sum(t.debit) as debit,sum(t.credit) as credit,0 as bal,'' as user_name,
					'' as con_user,'' as con_date,'' as vouch_no,'' as is_import,null as is_con
				FROM(
					SELECT 
						act.cash_subj_code,act.group_id,act.hos_id,act.copy_code,to_char(act.occur_date,'yyyy-MM') as occur_date,
						sum(act.debit) as debit,sum(act.credit) as credit,sum(act.debit)-sum(act.credit) as bal
					FROM acc_tell act 
					
					LEFT JOIN ACC_SUBJ asubj
					ON 
						act.group_id = asubj.group_id 
						AND act.hos_id = asubj.hos_id 
						AND act.copy_code = asubj.hos_id
						AND act.acc_year = asubj.acc_year 
						AND act.cash_subj_code = asubj.subj_code
					<where>
						act.group_id = #{group_id} 
						AND act.hos_id = #{hos_id}
						AND act.copy_code = #{copy_code} 
						AND act.acc_year = #{acc_year} 
						AND act.cash_subj_code = #{subj_code} 
						AND substr(to_char(act.occur_date,'yyyy-MM-dd'),0,7) >=substr(#{begin_date},0,7)
						AND substr(to_char(act.occur_date,'yyyy-MM-dd'),0,7) &lt;=substr(#{end_date},0,7)
						<!-- and act.occur_date  between to_date(#{begin_date},'yyyy/MM/dd') and to_date(#{end_date},'yyyy/MM/dd') -->
						
						<if test="is_con != null and is_con != ''">
						 	AND act.is_con = #{is_con}
						</if>
						<!-- <if test="tell_num != null and tell_num !=''">
				 			and (to_number(act.tell_number) >= to_number(#{tell_num}))
				 		</if>
				 		<if test="tell_number != null and tell_number !=''">
				 		    and (to_number(act.tell_number) &lt;= to_number(#{tell_number}))
				 		</if>
				 		<if test="tell_debit != null and tell_debit !=''">
				 		  and (act.debit  >=  #{tell_debit} or act.credit  >=  #{tell_debit})
				 		 </if>
				 		<if test="tell_credit != null and tell_credit !=''">
					 			 and (act.debit   &lt;=  #{tell_credit} or act.credit  &lt;=  #{tell_credit})
					 		</if> -->
				 		 
				 		<if test="summary != null and summary !=''">
				 			and act.summary like '%${summary}%'
				 		</if>
				 		<!-- <if test="nature_code != null and nature_code !=''">
				 			and act.tell_type_code=#{nature_code} 
				 		</if> -->
				   	 	AND act.is_init = 0
					</where>
					GROUP BY  act.cash_subj_code,act.group_id,act.hos_id,act.copy_code,act.occur_date 
				) t 
				GROUP BY t.cash_subj_code,t.group_id,t.hos_id,t.copy_code,t.occur_date
			),
			
			
			<!-- 本年累计 -->
			d_table as (
				SELECT
					null as tell_id, null as subj_code,t.occur_date,'本年累计' as summary ,0 as att_num,'' as check_no,
					to_char('') as subj_name,sum(t.debit) as debit,sum(t.credit) as credit,0 as bal,'' as create_user,
					'' as con_user, '' as con_date,'' as vouch_no,'' as is_import, null as is_con
				FROM (
					SELECT 
						act.group_id,act.hos_id,act.copy_code,act.cash_subj_code,to_char(act.occur_date,'yyyy') as occur_date,
						sum(act.debit) as debit,sum(act.credit) as credit 
					FROM ACC_TELL act 
					LEFT JOIN ACC_SUBJ asubj
					on 
						act.group_id = asubj.group_id  
						AND act.hos_id = asubj.hos_id
						AND act.copy_code = asubj.copy_code 
						AND act.acc_year = asubj.acc_year
						AND act.cash_subj_code = asubj.subj_code
					<where>
						act.group_id = #{group_id} 
						and act.hos_id = #{hos_id} 
						and act.copy_code = #{copy_code}
						and act.acc_year = #{acc_year}
						and act.cash_subj_code = #{subj_code}
					
						<if test="begin_date != null and begin_date !='' and end_date != null and end_date !=''">
			 				AND act.occur_date between to_date(#{acc_year}||'-01-01','yyyy/MM/dd') and to_date(#{end_date},'yyyy/MM/dd')
			 			</if>
						<if test="is_con != null and is_con != ''">
					 		AND act.is_con = #{is_con}
						</if>
				 		<!-- <if test="tell_num != null and tell_num !=''">
			 				and (to_number(act.tell_number) >= to_number(#{tell_num}))
				 		</if>
				 		<if test="tell_number != null and tell_number !=''">
				 		    and (to_number(act.tell_number) &lt;= to_number(#{tell_number}))
				 		</if>
				 		<if test="tell_debit != null and tell_debit !=''">
				 		  and (act.debit  >=  #{tell_debit} or act.credit  >=  #{tell_debit})
				 		 </if>
				 		<if test="tell_credit != null and tell_credit !=''">
				 			 and (act.debit   &lt;=  #{tell_credit} or act.credit  &lt;=  #{tell_credit})
				 		</if> -->
				 		<!-- <if test="nature_code != null and nature_code !=''">
			 			and act.tell_type_code=#{nature_code} 
			 			</if> -->
			 			<if test="summary != null and summary !=''">
			 			and act.summary like '%${summary}%' 
				 		</if>
						    and act.is_init = 0
						</where>	 
						group by act.group_id,act.hos_id,act.copy_code,act.occur_date,act.cash_subj_code
					) t
					group by t.cash_subj_code,t.group_id,t.hos_id,t.copy_code,t.occur_date
			),
			
			f_table AS (
				SELECT
					null as tell_id, null as subj_code,t.occur_date,'流水号合计' as summary ,0 as att_num,'' as check_no,
					to_char('') as subj_name,sum(t.debit) as debit,sum(t.credit) as credit,0 as bal,'' as create_user,
					'' as con_user,'' as con_date,'' as vouch_no,'' as is_import,null as is_con
				FROM (
					SELECT 
						act.group_id,act.hos_id,act.copy_code,act.cash_subj_code,to_char(act.occur_date,'yyyy') as occur_date,
						sum(act.debit) as debit,sum(act.credit) as credit 
					FROM ACC_TELL act 
					LEFT JOIN ACC_SUBJ asubj
					ON 
						act.group_id = asubj.group_id  
						AND act.hos_id = asubj.hos_id
						AND act.copy_code = asubj.copy_code 
						AND act.acc_year = asubj.acc_year
						AND act.cash_subj_code = asubj.subj_code
					<where>
						act.group_id = #{group_id} 
						AND act.hos_id = #{hos_id} 
						AND act.copy_code = #{copy_code}
						AND act.acc_year = #{acc_year}
						AND act.cash_subj_code = #{subj_code}
						<if test="begin_date != null and begin_date !='' and end_date != null and end_date !=''">
			 				AND act.occur_date between to_date(#{begin_date},'yyyy/MM/dd') and to_date(#{end_date},'yyyy/MM/dd')
			 			</if>
						<if test="is_con != null and is_con != ''">
					 		AND act.is_con = #{is_con}
						</if>
				 		<if test="tell_num != null and tell_num !=''">
			 				and (to_number(act.tell_number) >= to_number(#{tell_num}))
				 		</if>
				 		<if test="tell_number != null and tell_number !=''">
				 		    and (to_number(act.tell_number) &lt;= to_number(#{tell_number}))
				 		</if>
				 		<if test="tell_debit != null and tell_debit !=''">
				 		  and (act.debit  >=  #{tell_debit} or act.credit  >=  #{tell_debit})
				 		 </if>
				 		<if test="tell_credit != null and tell_credit !=''">
				 			 and (act.debit   &lt;=  #{tell_credit} or act.credit  &lt;=  #{tell_credit})
				 		</if>
				 		<!-- <if test="nature_code != null and nature_code !=''">
			 			and act.tell_type_code=#{nature_code} 
			 			</if> -->
			 			<if test="summary != null and summary !=''">
			 			and act.summary like '%${summary}%' 
			 		</if>
					    and act.is_init = 0
					</where>	 
					GROUP BY act.group_id,act.hos_id,act.copy_code,act.occur_date,act.cash_subj_code
				) t
				GROUP BY t.cash_subj_code,t.group_id,t.hos_id,t.copy_code,t.occur_date

			) 
			
			SELECT * FROM ( 
				SELECT  
       	 			t.tell_number,t.bz,t.tell_id,t.subj_code,t.occur_date as s_occur_date,t.summary,t.att_num,
					t.check_no,t.other_subj_code,t.subj_name,t.debit,t.credit,
					sum(t.bal) over(order by t.bz,t.tell_type_code asc,t.occur_date,t.tell_id) as bal, 
					t.user_name as create_user_name,t.con_user as con_user_name,t.con_date as s_con_date,
					t.vouch_no,t.is_import as is_por,t.is_con,t.pay_code,t.pay_name,t.tell_type_code
 				FROM ( 
  
					<!--  期初余额 -->
				     SELECT 
					     null tell_number,null as tell_id,null as subj_code,'0' bz, v.occur_date,v.summary	,null as att_num,
					     v.check_no,null other_subj_code,v.subj_name, v.debit,v.credit,v.bal,'' as user_name,'' as con_user,'' as con_date,
					     '' as vouch_no,v.is_import,null as is_con,null pay_code,null pay_name,null as tell_type_code 
				     FROM v_table v 
				    UNION ALL 
				     
				    <!-- 发生数据 -->
				    SELECT 
					    a.tell_number,a.tell_id,a.subj_code,a.occur_date bz, a.occur_date,a.summary,a.att_num,
					    a.check_no,a.other_subj_code,a.subj_name,a.debit,a.credit,a.bal,a.user_name,a.con_user,a.con_date,
					    a.vouch_no,a.is_import,a.is_con,a.pay_code,a.pay_name,a.tell_type_code 
				    FROM a_table a
				    
				    UNION ALL
				
				    <!-- 本日合计 -->
				    SELECT  
				    	null tell_number,null as tell_id,null as subj_code,b.occur_date||'1' bz ,b.occur_date,b.summary,null as att_num,
				    	'' as check_no,null other_subj_code,to_char('') as subj_name,b.debit,b.credit,b.bal,'' as user_name,'' as con_user,
				    	'' as con_date,'' as vouch_no,b.is_import,null as is_con,null pay_code,null pay_name,null as tell_type_code
				    FROM b_table b inner join a_table a on a. occur_date=b.occur_date
					GROUP BY   
						b.occur_date,b.summary,b.check_no,b.user_name,b.bal,b.att_num,b.debit,b.credit,b.con_user,
						b.con_date,b.vouch_no,b.subj_name,b.is_import
				     
				    UNION ALL
				     
				    <!-- 本月合计  -->
				    SELECT 
					     null tell_number,null as tell_id,null as subj_code,c.occur_date||'2' bz,c.occur_date,c.summary,null as att_num,
					     c.check_no,null other_subj_code,c.subj_name,c.debit,c.credit,c.bal,'' as user_name,'' as con_user,'' as con_date,
				     	'' as vouch_no,c.is_import,null as is_con,null pay_code,null pay_name,null as tell_type_code 
				    FROM c_table c
				     
				    UNION ALL
				   	<!--   本年累计 -->
					SELECT  
						null tell_number,null as vouch_check_id,null as subj_code,d.occur_date||'3' bz,d.occur_date,d.summary,null as att_num,
					    d.check_no,null other_subj_code,d.subj_name,d.debit,d.credit,d.bal,'' as user_name,'' as con_user,'' as con_date,
					    '' as vouch_no,d.is_import,null as is_con,null pay_code,null pay_name,null as tell_type_code 
					FROM d_table d 
			 		
			 		UNION ALL
				   	<!--   本年累计 -->
				     SELECT  
					     null tell_number,null as vouch_check_id,null as subj_code,e.occur_date||'4' bz,e.occur_date,e.summary,null as att_num,
					     e.check_no,null other_subj_code,e.subj_name,e.debit,e.credit,e.bal,'' as user_name,'' as con_user,'' as con_date,
					     '' as vouch_no,e.is_import,null as is_con,null pay_code,null pay_name,null as tell_type_code 
				     FROM f_table e 
			 
			 ) t 
 
 			ORDER BY t.bz,t.tell_type_code asc,t.occur_date,t.tell_number,t.tell_id asc ) a
			<where>
				 <if test="nature_code != null and nature_code !=''">
					and  (a.tell_type_code=#{nature_code} or a.tell_type_code is null)
				</if>
				<if test="nature_code=='01' and type_code != 0">
					and  (a.credit =0 or a.debit !=0 and a.credit !=0)
				</if>
				<if test="nature_code=='03' and type_code != 0">
					and  (a.credit =0 or a.debit !=0 and a.credit !=0)
				</if>
				<if test=" nature_code=='02' and type_code != 0">
					and  (a.debit =0 or a.debit !=0 and a.credit !=0)
				</if>
				<if test=" nature_code=='04' and type_code != 0">
					and  (a.debit =0 or a.debit !=0 and a.credit !=0)
				</if>
			</where>
	</select>

	<!-- 修改出纳账 -->
	<update id="updateAccTell" parameterType="java.util.Map">
		UPDATE ACC_TELL 
		<trim prefix="SET"  suffixOverrides=","> 
			<if test="cash_subj_code != null and cash_subj_code != ''">
			cash_subj_code = #{cash_subj_code,jdbcType=VARCHAR},
			</if>
			<if test="occur_date != null and occur_date != ''">
			occur_date = to_date(#{occur_date,jdbcType=DATE},'yyyy/MM/dd'),
			</if>
			<if test="create_date != null and create_date != ''">
			create_date = to_date(#{create_date,jdbcType=DATE},'yyyy/MM/dd'),
			</if>
			<if test="summary != null and summary != ''">
			summary = #{summary,jdbcType=VARCHAR},
			</if>
			<if test="att_num != null and att_num != ''">
			att_num = #{att_num,jdbcType=INTEGER},
			</if>
			<if test="check_no != null and check_no != ''">
			check_no = #{check_no,jdbcType=VARCHAR},
			</if>
			<if test="other_subj_code != null">
<!-- 			<if test="other_subj_code != null and other_subj_code != ''"> -->
			other_subj_code = #{other_subj_code,jdbcType=VARCHAR},
			</if>
			<if test="debit != null and debit != ''">
			debit = #{debit,jdbcType=INTEGER},
			</if>
			<if test="credit != null and credit != ''">
			credit = #{credit,jdbcType=INTEGER},
			</if>
			<if test="pay_type_code != null and pay_type_code != ''">
			pay_type_code = #{pay_type_code,jdbcType=VARCHAR}
			</if>
			
			</trim>
			<where>                   
			group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			
			<if test="tell_id != null and tell_id != ''">
			AND tell_id = #{tell_id,jdbcType=INTEGER}
			</if>  
			</where>  	
	</update>
	
	<!-- 修改出纳账确认状态 -->
	<update id="update" parameterType="java.util.Map">
	
	    UPDATE ACC_TELL
	    <trim prefix="SET"  suffixOverrides=","> 
		<if test="tell_number != null and tell_number != ''">
		tell_number = #{tell_number}
		,
		</if>
		</trim>
		<where>
		<if test="group_id != null and group_id != ''">
		AND group_id =#{group_id}
		</if>
		<if test="hos_id != null and hos_id != ''">
		AND hos_id =#{hos_id}
		</if>
		<if test="copy_code != null and copy_code != ''">
		AND copy_code =#{copy_code}
		</if>
		<if test="tell_id != null and tell_id != ''">
		AND tell_id =#{tell_id}
		</if>
		<if test="create_date != null and create_date != ''">
		AND create_date = to_date(#{create_date},'yyyy/MM/dd')
		</if>
		</where>
	</update>
	
	<!--查询 银行未达账 -->
	<select id="queryAccTellAndSum" parameterType="java.util.Map" resultMap="accTell">
		WITH 
			a_table AS(
				SELECT 
					abv.veri_id, at.tell_id AS bank_id, at.tell_id, at.group_id, at.hos_id , at.copy_code, at.acc_year, 
					at.cash_subj_code, sa.subj_name AS cash_subj_name, at.other_subj_code, sas.subj_name AS other_subj_name, 
					sas.subj_dire, at.summary, at.occur_date, at.att_num , at.debit, at.credit, at.debit_w, at.credit_w, 
					at.check_no , at.busi_type, at.business_no, at.pay_type_code, at.create_user, at.create_date, at.con_user, 
					at.con_date, at.check_user, at.check_date, at.is_init, at.vouch_check_id, at.vouch_id, at.is_import, apt.pay_name, 
					CASE (
						SELECT 1
						FROM ACC_BANK_VERI a
						WHERE a.group_id = #{group_id, jdbcType=INTEGER}
							AND a.hos_id = #{hos_id, jdbcType=INTEGER}
							AND a.copy_code = #{copy_code, jdbcType=VARCHAR}
							AND a.acc_year = #{acc_year, jdbcType=VARCHAR}
							AND a.tell_id = #{tell_id, jdbcType=INTEGER}
<!-- 						WHERE at.group_id = a.group_id -->
<!-- 							AND at.hos_id = a.hos_id -->
<!-- 							AND at.copy_code = a.copy_code -->
<!-- 							AND at.acc_year = a.acc_year -->
<!-- 							AND at.tell_id = a.tell_id -->
						) WHEN 1 THEN '已对账' ELSE '未对账' END AS is_checks
					, 
					abv.is_auto, avt.vouch_type_short || '-' || av.vouch_no AS vouch_no
				FROM ACC_TELL at
				
				LEFT JOIN acc_pay_type apt 
				ON 
					at.group_id = apt.group_id
					AND at.hos_id = apt.hos_id
					AND at.copy_code = apt.copy_code
					AND at.pay_type_code = apt.pay_code 
				
				LEFT JOIN ACC_BANK_VERI abv 
				ON 
					at.group_id = abv.group_id
					AND at.hos_id = abv.hos_id
					AND at.copy_code = abv.copy_code
					AND at.acc_year = abv.acc_year
					AND at.tell_id = abv.tell_id 
					
				LEFT JOIN acc_vouch av 
				ON 
					at.hos_id = av.hos_id
		        AND at.copy_code = av.copy_code
		        AND at.acc_year = av.acc_year
		        AND at.vouch_id = av.vouch_id 
		        
		        LEFT JOIN acc_vouch_type avt 
		        ON 
			        av.vouch_type_code = avt.vouch_type_code
			        AND av.group_id = avt.group_id
			        AND av.hos_id = avt.hos_id
			        AND av.copy_code = avt.copy_code 
			        
		        LEFT JOIN acc_subj sa 
		        ON 
			        at.group_id = sa.group_id
			        AND at.hos_id = sa.hos_id
			        AND at.copy_code = sa.copy_code
			        AND at.acc_year = sa.acc_year
			        AND at.cash_subj_code = sa.subj_code
			        
		        LEFT JOIN acc_subj sas 
		        ON 
			        at.group_id = sas.group_id
			        AND at.hos_id = sas.hos_id
			        AND at.copy_code = sas.copy_code
			        AND at.acc_year = sas.acc_year
			        AND at.other_subj_code = sas.subj_code
			        
        		<where>
					at.group_id = #{group_id}
					AND at.hos_id = #{hos_id}
					AND at.copy_code = #{copy_code}
					
					<if test="tell_id != null and tell_id != ''">
						AND at.tell_id = #{tell_id}
					</if>
					<if test="acc_year != null and acc_year != ''">
						AND at.acc_year = #{acc_year}
					</if>
					<if test="subj_code != null and subj_code != '' and subj_code != 'undefined'">
						AND at.cash_subj_code = #{subj_code}
					</if>
					<if test="other_subj_code != null and other_subj_code != ''">
						AND at.other_subj_code = #{other_subj_code}
					</if>
					<if test="subj_dire != null and subj_dire != ''">
						AND sas.subj_dire = #{subj_dire}
					</if>
					<if test="summary != null and summary != ''">
						AND at.summary like '%${summary}%'
					</if>
					<if test="att_num != null and att_num != ''">
						AND at.att_num = #{att_num}
					</if>
					<if test="price1 != '' and price1 != '' and price2 != null and price2 != null  and price1 != 'undefined' and price2 != 'undefined'">
						AND (at.debit between #{price1} and #{price2} OR at.credit between #{price1} and #{price2})
					</if>
					<if test="debit_w != null and debit_w != ''">
						AND at.debit_w = #{debit_w}
					</if>
					<if test="credit_w != null and credit_w != ''">
						AND at.credit_w = #{credit_w}
					</if>
					<if test="check_no != null and check_no != ''">
						AND at.check_no like '%${check_no}%'
					</if>
					<if test="busi_type != null and busi_type != ''">
						AND at.busi_type = #{busi_type}
					</if>
					<if test="business_no != null and business_no != ''">
						AND at.business_no = #{business_no}
					</if>
					<if test="acc_time1 != null and acc_time1 != ''">
		                AND at.occur_date  &gt;= to_date(#{acc_time1},'yyyy/MM/dd') 
		             </if>
		             <if test="acc_time2 != null and acc_time2 != ''">
		                AND at.occur_date  &lt;= to_date(#{acc_time2},'yyyy/MM/dd') 
		             </if>
					<if test="pay_type_code != null and pay_type_code != ''">
						AND at.pay_type_code = #{pay_type_code}
					</if>
					<if test="create_user != null and create_user != ''">
						AND at.create_user = #{create_user}
					</if>
					<if test="create_date != null and create_date != ''">
						AND at.create_date = #{create_date}
					</if>
					<if test="con_user != null and con_user != ''">
						AND at.con_user = #{con_user}
					</if>
					<if test="con_date != null and con_date != ''">
						AND at.con_date = #{con_date}
					</if>
					<if test="check_user != null and check_user != ''">
						AND at.check_user = #{check_user}
					</if>
					<if test="acc_date1 != null and acc_date1 != '' and acc_date2 != null and acc_date2 != ''">
						AND at.check_date between to_date(#{acc_date1},'yyyy/MM/dd') and to_date(#{acc_date2},'yyyy/MM/dd')
					</if>
					<if test="is_init != null and is_init != ''">
						AND at.is_init = #{is_init}
					</if>
					<if test="vouch_check_id != null and vouch_check_id != ''">
						AND at.vouch_check_id = #{vouch_check_id}
					</if>
					<if test="vouch_id != null and vouch_id != ''">
						AND at.vouch_id = #{vouch_id}
					</if>
					<if test="is_import != null and is_import != ''">
						AND at.is_import = #{is_import}
					</if>
					<if test="is_con != null and is_con != '' ">
						AND at.is_con = #{is_con}
					</if>
					<if test="acc_time != null and acc_time != '' ">
						AND at.occur_date = to_date(#{acc_time},'yyyy/MM/dd')
					</if>
					<if test="now_accYearMonth != null and now_accYearMonth != '' ">
						AND to_char(at.occur_date,'yyyy/MM') = #{now_accYearMonth}
					</if>
					<if test="state == 0">
					and not exists(select 1 from ACC_BANK_VERI b where at.group_id = b.group_id
								    AND at.hos_id = b.hos_id
								    AND at.copy_code = b.copy_code
								    AND at.acc_year = b.acc_year
								    AND at.tell_id = b.tell_id )
		   			</if>
					<if test="state == 1">
					and  exists(select 1 from ACC_BANK_VERI b where at.group_id = b.group_id
								    AND at.hos_id = b.hos_id
								    AND at.copy_code = b.copy_code
								    AND at.acc_year = b.acc_year
								    AND at.tell_id = b.tell_id )
		   			</if>
					
				</where>
        	ORDER BY at.tell_id ASC
      	)
		select 
			veri_id, bank_id,tell_id,group_id,hos_id, copy_code,acc_year,cash_subj_code,cash_subj_name,other_subj_code, 
	      	other_subj_name,subj_dire,summary,occur_date,att_num , debit,credit,debit_w,credit_w,check_no, busi_type,
	      	business_no,pay_type_code,create_user,create_date, con_user,con_date,check_user,check_date,is_init, 
	      	vouch_check_id,vouch_id,is_import,pay_name,is_checks,is_auto,vouch_no from a_table
		union all
       	select 
       		NULL AS veri_id, NULL AS bank_id, NULL AS tell_id, NULL AS group_id, NULL AS hos_id
          	, NULL AS copy_code, NULL AS acc_year, NULL AS cash_subj_code, NULL AS cash_subj_name, NULL AS other_subj_code
          	, NULL AS other_subj_name, NULL AS subj_dire, '合计' AS summary, NULL AS occur_date, NULL AS att_num
          	, SUM(debit) AS debit, SUM(credit) AS credit, NULL AS debit_w, NULL AS credit_w, NULL AS check_no
          	, NULL AS busi_type, NULL AS business_no, NULL AS pay_type_code, NULL AS create_user, NULL AS create_date
          	, NULL AS con_user, NULL AS con_date, NULL AS check_user, NULL AS check_date, NULL AS is_init
          	, NULL AS vouch_check_id, NULL AS vouch_id, NULL AS is_import, NULL AS pay_name, NULL AS is_checks
          	, NULL AS is_auto, NULL AS vouch_no from a_table
		
	</select>
	<select id="queryAccTellMaxTellNumber" parameterType="java.util.Map"  resultType="java.lang.Long">
                   select 
                    nvl(max(to_number(att.tell_number)),0) tell_number
                    from acc_tell att
                    inner join acc_subj ass
                    on att.group_id = ass.group_id and att.hos_id = ass.hos_id
                    and att.copy_code = ass.copy_code and att.cash_subj_code = ass.subj_code
                   <where>
					<if test="group_id != null and group_id != ''">
						att.group_id = #{group_id}
					</if>
					<if test="hos_id != null and hos_id != ''">
						and att.hos_id = #{hos_id}
					</if>
					<if test="copy_code != null and copy_code != ''">
						and att.copy_code = #{copy_code}
					</if>
					<if test="occur_date != null and occur_date != ''">
						and att.occur_date = to_date(#{occur_date},'yyyy/MM/dd')
					</if>
					<if test="year_month != null and year_month != ''">
						and to_char(occur_date,'yyyy')||to_char(occur_date,'mm') = #{year_month}
					</if>
					<if test="subj_nature_code != null and subj_nature_code != ''">
						and ass.subj_nature_code = #{subj_nature_code}
					</if>
					<if test="cash_subj_code != null and cash_subj_code != ''">
						and att.cash_subj_code = #{cash_subj_code}
					</if>
					<if test="tell_type_code != null and tell_type_code != ''">
						and att.tell_type_code = #{tell_type_code}
					</if>
                   </where>
	</select>
	
	<update id="updateAccTellMaxTellNumber" parameterType="java.util.Map">
	
	         update acc_tell 
                    set tell_number = to_number(tell_number)+1 
                    <where>
                     <if test="group_id != null and group_id != ''">
						  group_id = #{group_id}
					</if>
					<if test="hos_id != null and hos_id != ''">
						and hos_id = #{hos_id}
					</if>
					<if test="copy_code != null and copy_code != ''">
						and copy_code = #{copy_code}
					</if>
					<if test="occur_date != null and occur_date != ''">
						and occur_date =  to_date(#{occur_date},'yyyy/MM/dd')
					</if>
					<if test="tell_number != null and tell_number != ''">
						 and to_number(tell_number) >= #{tell_number}
					</if>
					and exists (
                        select 1 from acc_subj where acc_tell.group_id = acc_subj.group_id
                        and acc_tell.hos_id = acc_subj.hos_id and acc_tell.copy_code = acc_subj.copy_code
                        and acc_tell.acc_year = acc_subj.acc_year
                        and acc_tell.cash_subj_code = acc_subj.subj_code
                    <if test="subj_nature_code != null and subj_nature_code != ''">
						 AND acc_subj.subj_nature_code = #{subj_nature_code}
					</if>
                    )
              </where>
	</update>
	
	<select id="queryAccTellMaxTellResettingNumber" parameterType="java.util.Map"
		resultMap="accTell">
	
	                select 
                    att.group_id,att.hos_id,att.copy_code,att.acc_year,att.tell_id,att.tell_number tell_number
                    from acc_tell att
                    inner join acc_subj ass
                    on att.group_id = ass.group_id and att.hos_id = ass.hos_id
                    and att.copy_code = ass.copy_code and att.cash_subj_code = ass.subj_code
	                <where>
					<if test="group_id != null and group_id != ''">
						att.group_id = #{group_id}
					</if>
					<if test="hos_id != null and hos_id != ''">
						and att.hos_id = #{hos_id}
					</if>
					<if test="copy_code != null and copy_code != ''">
						and att.copy_code = #{copy_code}
					</if>
					<if test="occur_date != null and occur_date != ''">
						and att.occur_date = to_date(#{occur_date},'yyyy/MM/dd')
					</if>
					<if test="subj_nature_code != null and subj_nature_code != ''">
						and ass.subj_nature_code = #{subj_nature_code}
					</if>
                   </where>
                    order by att.tell_number
	</select>

	<select id="queryAccTellByInit"  parameterType="java.util.Map" resultType="java.lang.Integer">
	
	                select count(*)
                    from acc_tell att
	                <where>
					<if test="group_id != null and group_id != ''">
						att.group_id = #{group_id}
					</if>
					<if test="hos_id != null and hos_id != ''">
						and att.hos_id = #{hos_id}
					</if>
					<if test="copy_code != null and copy_code != ''">
						and att.copy_code = #{copy_code}
					</if>
					<if test="tell_id != null and tell_id != ''">
						and att.tell_id in (${tell_id})
					</if>
					and vouch_id is not null
                   </where>
	</select>
	
	<select id="queryAccTellDetail" resultType="com.chd.hrp.acc.entity.AccTell"  parameterType="string">
		SELECT
	    att.tell_id,
	    att.group_id,
	    att.hos_id,
	    att.copy_code,
	    att.acc_year,
	    att.cash_subj_code,
	    att.other_subj_code,
	    att.summary,
	    att.att_num,
	    att.debit,
	    att.credit,
	    att.occur_date,
	    att.tell_number,
	    sa.subj_name,
	    sa.subj_code,
	    att.tell_type_code
	    FROM acc_tell att
	    LEFT JOIN acc_subj sa ON att.group_id = sa.group_id
	    AND att.hos_id = sa.hos_id
	    AND att.copy_code = sa.copy_code
	    AND att.acc_year = sa.acc_year
	    AND att.cash_subj_code = sa.subj_code
		<where>
			<if test="group_id !=null and group_id !=''">
				AND att.group_id = #{group_id} 
			</if>
			
			<if test="hos_id != null and hos_id !=''">
				AND att.hos_id = #{hos_id}
			</if>
			
			<if test="copy_code !=null and copy_code != ''">
				AND att.copy_code = #{copy_code}
				
			</if>
			<if test="tell_id != null and tell_id != ''">
				AND att.tell_id = #{tell_id} 
			</if>
		</where>
		
	</select>
	
	<select id="queryAccBrokenTell" parameterType="java.util.Map"
		resultMap="accTell">
		select att.next_tell_number tell_number,to_number(att.next_tell_number)-to_number(att.tell_number) is_check from (
            select  tell_number,
			    lead(tell_number) over (order by tell_type_code, tell_number) as next_tell_number
			  from acc_tell
            <where>
				<if test="group_id != null and group_id != ''">
					group_id = #{group_id}
				</if>
				<if test="hos_id != null and hos_id != ''">
					and hos_id = #{hos_id}
				</if>
				<if test="copy_code != null and copy_code != ''">
					and copy_code = #{copy_code}
				</if>
				<if test="occur_time != null and occur_time != ''">
					and to_char(occur_date,'yyyy-MM') = #{occur_time}
				</if>
				<if test="tell_type_code != null and tell_type_code != ''">
					and tell_type_code = #{tell_type_code}
				</if>
				<if test="cash_subj_code != null and cash_subj_code != ''">
					and cash_subj_code = #{cash_subj_code}
				</if>
              </where>
                ) att where att.next_tell_number-att.tell_number>1
	</select>
	
	<select id="queryAccBrokenTellList" parameterType="java.util.Map"
		resultMap="accTell">
            select  tell_id,
			    group_id,
			    hos_id,
			    copy_code,
			    acc_year,
			    cash_subj_code,
			    other_subj_code,
			    summary,
			    att_num,
			    occur_date,
			    tell_number,
			    tell_type_code
			  from acc_tell
            <where>
				<if test="group_id != null and group_id != ''">
					group_id = #{group_id}
				</if>
				<if test="hos_id != null and hos_id != ''">
					and hos_id = #{hos_id}
				</if>
				<if test="copy_code != null and copy_code != ''">
					and copy_code = #{copy_code}
				</if>
				<if test="occur_time != null and occur_time != ''">
					and to_char(occur_date,'yyyy-MM') = #{occur_time}
				</if>
				<if test="tell_type_code != null and tell_type_code != ''">
					and tell_type_code = #{tell_type_code}
				</if>
				<if test="cash_subj_code != null and cash_subj_code != ''">
					and cash_subj_code = #{cash_subj_code}
				</if>
				and to_number(tell_number)>=to_number(#{next_tell_number})
              </where>
              order by tell_number
	</select>
	<!--出纳账摘要字典 查询  -->
	<select id="queryAccTellSummary" parameterType="java.util.Map" resultMap="accTell">
            select   
			    group_id,
			    hos_id,
			    copy_code,
			    user_id,
			    sid, 
			    summary 
			  from ACC_TELL_SUMMARY
           <where> 
					group_id = #{group_id,jdbcType=INTEGER} 
					and hos_id = #{hos_id,jdbcType=INTEGER} 
					and copy_code = #{copy_code,jdbcType=VARCHAR}  
					and user_id = #{user_id,jdbcType=INTEGER} 
				<if test="summary != null and summary != ''"> 
					and (summary like '%'||#{summary}||'%' or
						spell_code like  '%'||#{summary}||'%'  or
						wbx_code like  '%'||#{summary}||'%'  
					)
				</if> 
				 
				
          </where>  
	</select>
	
	<!--出纳账摘要字典 添加  -->
	<insert id="addAccTellSummary" useGeneratedKeys="true">

		<selectKey resultType="java.lang.Integer" order="BEFORE" keyProperty="sid">
			SELECT ACC_TELL_SUMMARY_SEQ.NEXTVAL as sid  FROM DUAL
		</selectKey>
		INSERT INTO ACC_TELL_SUMMARY (
		sid
		,
		group_id
		,
		hos_id
		,
		copy_code
		,
		user_id 
		,
		summary,
		
		spell_code,
		
		wbx_code
		 
		) VALUES (
		#{sid,jdbcType=INTEGER} ,
		#{group_id,jdbcType=INTEGER} ,
		#{hos_id,jdbcType=INTEGER} ,
		#{copy_code,jdbcType=VARCHAR} , 
		#{user_id,jdbcType=INTEGER} , 
		#{summary,jdbcType=VARCHAR} ,
		#{spell_code,jdbcType=VARCHAR} ,
		#{wbx_code,jdbcType=VARCHAR} 
		)

	</insert>
	
	<!--出纳账摘要字典 批量添加  -->
 <insert id="addBatchAccTellSummary" parameterType="java.util.List">

		INSERT INTO ACC_TELL_SUMMARY (
		sid
		,
		group_id
		,
		hos_id
		,
		copy_code
		,
		user_id
		, 
		summary ,
		
		spell_code,
		
		wbx_code
		)
		select ACC_TELL_SUMMARY_SEQ.NEXTVAL,a.* from (
			<foreach collection="list" item="item" index="index"
				separator=" union all ">
				select
				#{item.group_id,jdbcType=INTEGER} ,
				#{item.hos_id,jdbcType=INTEGER} ,
				#{item.copy_code,jdbcType=VARCHAR} , 
				#{item.user_id,jdbcType=INTEGER} , 
				#{item.summary,jdbcType=VARCHAR}  ,
				#{item.spell_code,jdbcType=VARCHAR} ,
			    #{item.wbx_code,jdbcType=VARCHAR} 
				from dual
			</foreach>
		) a 
	</insert>
	
	<!--出纳账摘要字典 删除  -->
	<delete id="deleteBatchAccTellSummary" parameterType="java.util.List">
		DELETE FROM ACC_TELL_SUMMARY WHERE
		<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
			(sid = #{item.sid}
			and 
			group_id = #{item.group_id}
			and
			hos_id = #{item.hos_id}
			and
			copy_code = #{item.copy_code}
			and
			user_id = #{item.user_id}
			)

		</foreach> 

	</delete>
	
	<!--出纳账摘要字典   更新  -->
	<update id="updateAccTellSummary" parameterType="java.util.Map">
		UPDATE ACC_TELL_SUMMARY 
		<trim prefix="SET"  suffixOverrides=","> 
			<if test="summary != null and summary != ''">
			summary = #{summary,jdbcType=VARCHAR},
			</if>
			 <if test="spell_code != null and spell_code != ''">
			spell_code = #{spell_code,jdbcType=VARCHAR},
			</if>
			<if test="wbx_code != null and wbx_code != ''">
			wbx_code = #{wbx_code,jdbcType=VARCHAR},
			</if> 
			   
			</trim>
			where group_id = #{group_id,jdbcType=INTEGER}
			     
			      AND hos_id = #{hos_id,jdbcType=INTEGER}
			 
			      AND copy_code = #{copy_code,jdbcType=VARCHAR}
			 
			      AND sid = #{sid,jdbcType=INTEGER}
			      
			      AND user_id = #{user_id,jdbcType=INTEGER}
			   
	</update>
	
	<!--出纳账摘要字典   查询是否有重复摘要 -->
	<select id="SearchAccTellSummaryByExists"  parameterType="java.util.Map" resultType="java.lang.Integer">
		 
		 select count(0) from ACC_TELL_SUMMARY 
		 
		 where 	  group_id = #{group_id,jdbcType=INTEGER}
			     
			      AND hos_id = #{hos_id,jdbcType=INTEGER}
			 
			      AND copy_code = #{copy_code,jdbcType=VARCHAR} 
			      
			      AND user_id = #{user_id,jdbcType=INTEGER}
		
				 AND summary=#{summary,jdbcType=VARCHAR} 
			   
	</select>
	
	<!--出纳账摘要字典   查询是否有重复摘要   用于 导入判断 -->
	<select id="SearchAccTellSummaryByCode" resultType="com.chd.hrp.acc.entity.AccTell"  parameterType="string">
		
		select group_id,hos_id,copy_code,user_id,summary  from ACC_TELL_SUMMARY 
		 
		 where 	  group_id = #{group_id,jdbcType=INTEGER}
			     
			      AND hos_id = #{hos_id,jdbcType=INTEGER}
			 
			      AND copy_code = #{copy_code,jdbcType=VARCHAR} 
			      
			      AND user_id = #{user_id,jdbcType=INTEGER}
		
				 AND summary=#{summary,jdbcType=VARCHAR} 
		
	</select>
	
	<select id="queryAccTellAndSumPrint" parameterType="java.util.Map" resultType="java.util.Map">
		WITH 
			a_table AS (
				SELECT 
					abv.veri_id, at.tell_id AS bank_id, at.tell_id, at.group_id, at.hos_id, at.copy_code, at.acc_year, 
					at.cash_subj_code, sa.subj_name AS cash_subj_name, at.other_subj_code, sas.subj_name AS other_subj_name, 
					sas.subj_dire, at.summary, at.occur_date, at.att_num ,at.debit, at.credit, at.debit_w, at.credit_w,
					at.check_no, at.busi_type, at.business_no, at.pay_type_code, at.create_user, at.create_date, at.con_user, 
					at.con_date, at.check_user, at.check_date, at.is_init, at.vouch_check_id, at.vouch_id, at.is_import, apt.pay_name, 
					
					CASE (
						SELECT 1
						FROM ACC_BANK_VERI a
						WHERE at.group_id = a.group_id
							AND at.hos_id = a.hos_id
							AND at.copy_code = a.copy_code
							AND at.acc_year = a.acc_year
							AND at.tell_id = a.tell_id
					) WHEN 1 THEN '已对账' ELSE '未对账' END AS is_checks, 
					abv.is_auto, avt.vouch_type_short || '-' || av.vouch_no AS vouch_no
				FROM ACC_TELL at
				LEFT JOIN acc_pay_type apt 
				ON 
					at.group_id = apt.group_id
					AND at.hos_id = apt.hos_id
					AND at.copy_code = apt.copy_code
					AND at.pay_type_code = apt.pay_code 
					
				LEFT JOIN ACC_BANK_VERI abv 
					ON 
						at.group_id = abv.group_id
						AND at.hos_id = abv.hos_id
						AND at.copy_code = abv.copy_code
						AND at.acc_year = abv.acc_year
						AND at.tell_id = abv.tell_id 
						
				LEFT JOIN acc_vouch av 
				ON 
					at.hos_id = av.hos_id
			        AND at.copy_code = av.copy_code
			        AND at.acc_year = av.acc_year
			        AND at.vouch_id = av.vouch_id
			         
		        LEFT JOIN acc_vouch_type avt 
		        ON 
			        av.vouch_type_code = avt.vouch_type_code
			        AND av.group_id = avt.group_id
			        AND av.hos_id = avt.hos_id
			        AND av.copy_code = avt.copy_code 
		        
		        LEFT JOIN acc_subj sa 
		        ON 
			        at.group_id = sa.group_id
			        AND at.hos_id = sa.hos_id
			        AND at.copy_code = sa.copy_code
			        AND at.acc_year = sa.acc_year
			        AND at.cash_subj_code = sa.subj_code
			        
		        LEFT JOIN acc_subj sas 
		        ON 
			        at.group_id = sas.group_id
			        AND at.hos_id = sas.hos_id
			        AND at.copy_code = sas.copy_code
			        AND at.acc_year = sas.acc_year
			        AND at.other_subj_code = sas.subj_code
        	<where>
        	
					at.group_id = #{group_id}
					AND at.hos_id = #{hos_id}
					AND at.copy_code = #{copy_code}
					<if test="tell_id != null and tell_id != ''">
						AND at.tell_id = #{tell_id}
					</if>
					<if test="acc_year != null and acc_year != ''">
						AND at.acc_year = #{acc_year}
					</if>
					<if test="subj_code!= null and subj_code != '' and subj_code != 'undefined'">
						AND at.cash_subj_code = #{subj_code}
					</if>
					<if test="other_subj_code != null and other_subj_code != ''">
						AND at.other_subj_code = #{other_subj_code}
					</if>
					<if test="subj_dire != null and subj_dire != ''">
						AND sas.subj_dire = #{subj_dire}
					</if>
					<if test="summary != null and summary != ''">
						AND at.summary like '%${summary}%'
					</if>
					<if test="att_num != null and att_num != ''">
						AND at.att_num = #{att_num}
					</if>
					<if test="price1 != '' and price1 != '' and price2 != null and price2 != null  and price1 != 'undefined' and price2 != 'undefined'">
						AND (at.debit between #{price1} and #{price2} OR at.credit between #{price1} and #{price2})
					</if>
					<if test="debit_w != null and debit_w != ''">
						AND at.debit_w = #{debit_w}
					</if>
					<if test="credit_w != null and credit_w != ''">
						AND at.credit_w = #{credit_w}
					</if>
					<if test="check_no != null and check_no != ''">
						AND at.check_no like '%${check_no}%'
					</if>
					<if test="busi_type != null and busi_type != ''">
						AND at.busi_type = #{busi_type}
					</if>
					<if test="business_no != null and business_no != ''">
						AND at.business_no = #{business_no}
					</if>
					<if test="acc_time1 != null and acc_time1 != ''">
		                AND at.occur_date  &gt;= to_date(#{acc_time1},'yyyy/MM/dd') 
		             </if>
		             <if test="acc_time2 != null and acc_time2 != ''">
		                AND at.occur_date  &lt;= to_date(#{acc_time2},'yyyy/MM/dd') 
		             </if>
					<if test="pay_type_code != null and pay_type_code != ''">
						AND at.pay_type_code = #{pay_type_code}
					</if>
					<if test="create_user != null and create_user != ''">
						AND at.create_user = #{create_user}
					</if>
					<if test="create_date != null and create_date != ''">
						AND at.create_date = #{create_date}
					</if>
					<if test="con_user != null and con_user != ''">
						AND at.con_user = #{con_user}
					</if>
					<if test="con_date != null and con_date != ''">
						AND at.con_date = #{con_date}
					</if>
					<if test="check_user != null and check_user != ''">
						AND at.check_user = #{check_user}
					</if>
					<if test="acc_date1 != null and acc_date1 != '' and acc_date2 != null and acc_date2 != ''">
						AND at.check_date between to_date(#{acc_date1},'yyyy/MM/dd') and to_date(#{acc_date2},'yyyy/MM/dd')
					</if>
					<if test="is_init != null and is_init != ''">
						AND at.is_init = #{is_init}
					</if>
					<if test="vouch_check_id != null and vouch_check_id != ''">
						AND at.vouch_check_id = #{vouch_check_id}
					</if>
					<if test="vouch_id != null and vouch_id != ''">
						AND at.vouch_id = #{vouch_id}
					</if>
					<if test="is_import != null and is_import != ''">
						AND at.is_import = #{is_import}
					</if>
					<if test="is_con != null and is_con != '' ">
						AND at.is_con = #{is_con}
					</if>
					<if test="acc_time != null and acc_time != '' ">
						AND at.occur_date = to_date(#{acc_time},'yyyy/MM/dd')
					</if>
					<if test="now_accYearMonth != null and now_accYearMonth != '' ">
						AND to_char(at.occur_date,'yyyy/MM') = #{now_accYearMonth}
					</if>
					<if test="state == 0">
					and not exists(select 1 from ACC_BANK_VERI b where at.group_id = b.group_id
								    AND at.hos_id = b.hos_id
								    AND at.copy_code = b.copy_code
								    AND at.acc_year = b.acc_year
								    AND at.tell_id = b.tell_id )
		   			</if>
					<if test="state == 1">
					and  exists(select 1 from ACC_BANK_VERI b where at.group_id = b.group_id
								    AND at.hos_id = b.hos_id
								    AND at.copy_code = b.copy_code
								    AND at.acc_year = b.acc_year
								    AND at.tell_id = b.tell_id )
		   			</if>
					
				</where>
        ORDER BY at.tell_id ASC
      )
      select veri_id, bank_id,tell_id,group_id,hos_id
					, copy_code,acc_year,cash_subj_code,cash_subj_name,other_subj_code
					, other_subj_name,subj_dire,summary,to_char(occur_date,'yyyy-MM-dd') occur_date,att_num
					, debit,credit,debit_w,credit_w,check_no
					, busi_type,business_no,pay_type_code,create_user,create_date
					, con_user,con_date,check_user,check_date,is_init
					, vouch_check_id,vouch_id,is_import,pay_name,is_checks,is_auto,vouch_no from a_table
       union all
       select NULL AS veri_id, NULL AS bank_id, NULL AS tell_id, NULL AS group_id, NULL AS hos_id
          , NULL AS copy_code, NULL AS acc_year, NULL AS cash_subj_code, NULL AS cash_subj_name, NULL AS other_subj_code
          , NULL AS other_subj_name, NULL AS subj_dire, '合计' AS summary, NULL AS occur_date, NULL AS att_num
          , SUM(debit) AS debit, SUM(credit) AS credit, NULL AS debit_w, NULL AS credit_w, NULL AS check_no
          , NULL AS busi_type, NULL AS business_no, NULL AS pay_type_code, NULL AS create_user, NULL AS create_date
          , NULL AS con_user, NULL AS con_date, NULL AS check_user, NULL AS check_date, NULL AS is_init
          , NULL AS vouch_check_id, NULL AS vouch_id, NULL AS is_import, NULL AS pay_name, NULL AS is_checks
          , NULL AS is_auto, NULL AS vouch_no from a_table
		
	</select>
	
	<select id="queryCashAccountPrint" parameterType="java.util.Map" resultType="java.util.Map">
			
			with v_table as(

			<!--期初余额 -->
			select
				null as tell_id, 
				null as subj_code,
				'' as occur_date,
				'期初余额' as summary ,
				0 as att_num,
				'' as check_no,
				to_char('') as subj_name,
				0 as  debit,
				0 as credit,
				<if test="acc_year==start_year">
				a.bal+b.bal+c.bal as  bal,
				</if>
				<if test="acc_year!=start_year">
				a.bal+c.bal as  bal,
				</if>
				'' as user_name,
				'' as con_user,
				'' as con_date,
				'' as vouch_no,
				'' as is_import,
				null as is_con 
			from
			<!-- 财务帐表余额 -->
				(select 
					al.end_os as bal 
				from acc_leder al 
					where al.group_id = #{group_id} 
					and al.hos_id =#{hos_id}
					and al.copy_code = #{copy_code} 
					and al.acc_year = #{acc_year} 
					and al.acc_month = '00' 
					and al.subj_code = #{subj_code}
				) a,
			<if test="acc_year==start_year">
				<!-- 凭证明细表借方减贷方 -->
				(select 
					nvl(sum(avd.debit),0)-nvl(sum(avd.credit),0) as bal 
				from <!-- (
					select sms.start_month 
						from sys_mod_start sms 
							where 
								sms.group_id = #{group_id} 
								and sms.hos_id = #{hos_id}
								and sms.copy_code = #{copy_code} 
								and sms.mod_code= #{mod_code}
				) sys, -->acc_vouch_detail avd
				left join acc_vouch av 
					on avd.group_id = av.group_id 
					and avd.hos_id = av.hos_id 
					and avd.copy_code = av.copy_code
					and avd.vouch_id = av.vouch_id and avd.acc_year = av.acc_year
					where 
						avd.group_id = #{group_id}
						and avd.hos_id = #{hos_id}
						and avd.copy_code = #{copy_code} 
						and avd.subj_code = #{subj_code}
						and avd.acc_year = #{acc_year} 
						and av.acc_month &lt; #{start_month}
				) b,
			</if>
			<!-- 出纳帐制单日期小于开始日期的发生数 -->
			
				(select 
					nvl(sum(act.debit),0)-nvl(sum(act.credit),0) as bal 
				from acc_tell act
				where 
					act.group_id = #{group_id}
					and act.hos_id = #{hos_id} 
					and act.copy_code = #{copy_code}
					and act.acc_year = #{acc_year}
					and act.cash_subj_code = #{subj_code}
					and act.occur_date &lt; to_date(#{begin_date},'yyyy/MM/dd')
					and act.is_init = '0'
				) c
			
			),
			
			a_table as (
			<!-- 每天的发生数据 -->
				 select 
				     att.tell_type_name||'-'||act.tell_number tell_number,
					 act.tell_id,
					 act.cash_subj_code as subj_code,
					 to_char(act.occur_date,'yyyy-MM-dd') as occur_date,
					 act.summary,
					 act.att_num,
					 act.check_no,
					 asubj.subj_code other_subj_code,
					 <!-- asubj.subj_name, -->
					 to_char(asubj.subj_code ||'  '|| asubj.subj_name) subj_name,
					 act.debit,
					 act.credit,
					 act.debit-act.credit as bal,
					 su.user_name,
					 sus.user_name as con_user,
					 to_char(act.con_date,'yyyy/MM/dd') as con_date,
					 case when av.vouch_no is not null then avt.vouch_type_name || '-' || av.vouch_no  else '' end vouch_no,
					 case when act.is_import=1 then '是' else '否' end as is_import,
					 act.is_con,apt.pay_code,apt.pay_name,att.tell_type_code
				 from acc_tell act 
				 	left join acc_subj asubj
						 on act.group_id= asubj.group_id 
						 and act.hos_id = asubj.hos_id 
						 and act.copy_code = asubj.copy_code 
						 and act.acc_year=asubj.acc_year
						 and act.other_subj_code = asubj.subj_code
				 	left join sys_user su on
				 act.group_id = su.group_id 
				 and act.hos_id = su.hos_id 
				 and act.create_user = su.user_id
				 	left join sys_user sus on
				 act.group_id = sus.group_id and act.hos_id = sus.hos_id and act.con_user = sus.user_id
				 	left join acc_vouch av on act.group_id = av.group_id
				 and act.hos_id = av.hos_id and act.copy_code = av.copy_code and act.acc_year = av.acc_year
				 and act.vouch_id = av.vouch_id
				 left join acc_vouch_type avt on av.group_id =avt.group_id
		        and av.hos_id=avt.hos_id and av.copy_code=avt.copy_code
		        and av.vouch_type_code=avt.vouch_type_code 
				 left join acc_pay_type apt on apt.group_id = act.group_id
                 and apt.hos_id = act.hos_id  and apt.copy_code = act.copy_code
                 and apt.pay_code = act.pay_type_code
                 left join acc_tell_type att on att.group_id = act.group_id
		        and att.hos_id = act.hos_id
		        and att.copy_code = act.copy_code
		        and att.tell_type_code = act.tell_type_code 
		         
				 	<where>
				 	    act.is_init = 0
				 		<if test="group_id != null and group_id != ''">
				 			AND act.group_id = #{group_id} 
				 		</if>
				 		<if test="hos_id != null and hos_id != ''">
				 			AND act.hos_id = #{hos_id}
				 		</if>
				 		<if test="copy_code !=null and copy_code !=''">
				 			AND act.copy_code=#{copy_code} 
				 		</if>
				 		<if test="subj_code !=null and subj_code !=''">
				 			AND act.cash_subj_code=#{subj_code}
				 		</if>
				 		<if test="begin_date != null and begin_date !='' and end_date != null and end_date !=''">
				 			AND act.occur_date between to_date(#{begin_date},'yyyy/MM/dd') and to_date(#{end_date},'yyyy/MM/dd')
				 		</if>
				 		<if test="is_con != null and is_con !=''">
				 			and act.is_con=#{is_con} 
				 		</if>
				 		<if test="vouch_no != null and vouch_no !='' and vouch_no ==0">
				 			and act.vouch_id  is null
				 		</if>
				 		<if test="vouch_no != null and vouch_no !='' and vouch_no ==1 ">
				 			and act.vouch_id is not null
				 		</if>
				 		<if test="pay_code != null and pay_code !=''">
				 			 and apt.pay_code=#{pay_code} 
				 		</if>
				 		<if test="summary != null and summary !=''">
				 			and act.summary like '%${summary}%' 
				 		</if>
				 		<if test="tell_num != null and tell_num !=''">
				 			and (to_number(act.tell_number) >= to_number(#{tell_num}))
				 		</if>
				 		<if test="tell_number != null and tell_number !=''">
				 		    and (to_number(act.tell_number) &lt;= to_number(#{tell_number}))
				 		</if>
				 		<if test="tell_debit != null and tell_debit !='' and tell_credit != null and tell_credit !=''">
				 		  and (act.debit  >=  #{tell_debit} and act.debit   &lt;=  #{tell_credit}
				 		  or  act.credit  >=  #{tell_debit} and act.credit  &lt;=  #{tell_credit})
				 		 </if>
				 		 <if test="tell_debit != null and tell_debit !='' and tell_credit == null and tell_credit ==''">
				 		  and (act.debit  >=  #{tell_debit} or  act.credit  >=  #{tell_debit})
				 		 </if>
				 		 <if test="tell_credit != null and tell_credit !='' and tell_debit == null and tell_debit ==''">
				 		  and ( act.debit   &lt;=  #{tell_credit} and act.credit  &lt;=  #{tell_credit})
				 		 </if>
				 		 <!-- <if test="nature_code != null and nature_code !=''">
				 			and act.tell_type_code=#{nature_code} 
				 		</if> -->
				 	</where> 
					 	order by att.tell_type_code	 	
			 ),
			 
			 b_table as (
			<!--  本日合计 -->
				 select 
				 	 null as tell_id,
				 	 null as subj_code,
				 	 t.occur_date,
					 '本日合计' as summary ,
					 0 as att_num,
					 '' as check_no,
					 to_char('') as subj_name,
					 sum(t.debit) as debit,
					 sum(t.credit) as credit,
					 0 as  bal,
					 '' as user_name,
					 '' as con_user,
					 '' as con_date,
					 '' as vouch_no,
					 '' as is_import,
					 null as is_con
				from ( 
					select 
						act.cash_subj_code,
						act.group_id,
						act.hos_id,
						act.copy_code,
						to_char(act.occur_date,'yyyy-MM-dd') as occur_date,
						sum(act.debit) as debit,
						sum(act.credit) as credit,
						sum(act.debit-act.credit) as  bal
					from acc_tell act 
					left join acc_subj asubj
						 on act.group_id= asubj.group_id 
						 and act.hos_id = asubj.hos_id 
						 and act.copy_code = asubj.copy_code 
						 and act.acc_year=asubj.acc_year
						 and act.cash_subj_code = asubj.subj_code
					 <where>
						 act.group_id=#{group_id} 
						 and act.hos_id=#{hos_id} 
						 and act.copy_code = #{copy_code}
						 and act.acc_year = #{acc_year} 
						 and act.occur_date between to_date(#{begin_date},'yyyy/MM/dd') and to_date(#{end_date},'yyyy/MM/dd')
						 and act.cash_subj_code=#{subj_code}
						 and act.is_init = 0
						 <if test="is_con != null and is_con != ''">
						 	AND act.is_con = #{is_con}
						 </if>
						 <!-- <if test="tell_num != null and tell_num !=''">
				 			and (to_number(act.tell_number) >= to_number(#{tell_num}))
				 		</if>
				 		<if test="tell_number != null and tell_number !=''">
				 		    and (to_number(act.tell_number) &lt;= to_number(#{tell_number}))
				 		</if>
				 		<if test="tell_debit != null and tell_debit !=''">
				 		  and (act.debit  >=  #{tell_debit} or act.credit  >=  #{tell_debit})
				 		 </if>
				 		<if test="tell_credit != null and tell_credit !=''">
					 			 and (act.debit   &lt;=  #{tell_credit} or act.credit  &lt;=  #{tell_credit})
					 		</if> -->
				 		<if test="summary != null and summary !=''">
				 			and act.summary like '%${summary}%' 
				 		</if>
				 		<!-- <if test="nature_code != null and nature_code !=''">
				 			and act.tell_type_code=#{nature_code} 
				 		</if> -->
					</where> 
					 group by 
					 	act.cash_subj_code,
					 	act.group_id,
					 	act.hos_id,
					 	act.copy_code,
					 	act.occur_date,
					 	act.cash_subj_code) t 
				group by t.cash_subj_code,t.group_id,t.hos_id,t.copy_code,t.occur_date
			
			),
			<!-- 本月合计-->
			c_table as (
				select
					null as tell_id, 
					null as subj_code,
					t.occur_date,
					'本月合计' as summary ,
					0 as att_num,
					'' as check_no,
					to_char('') as subj_name,
					sum(t.debit) as debit,
					sum(t.credit) as credit,
					0 as bal,
					'' as user_name,
					'' as con_user,
					'' as con_date,
					'' as vouch_no,
					'' as is_import,
					null as is_con
				from(
					select act.cash_subj_code,
						act.group_id,
						act.hos_id,
						act.copy_code,
						to_char(act.occur_date,'yyyy-MM') as occur_date,
						sum(act.debit) as debit,
						sum(act.credit) as credit,
						sum(act.debit)-sum(act.credit) as bal
					from acc_tell act 
						left join acc_subj asubj
							on act.group_id = asubj.group_id 
							and act.hos_id = asubj.hos_id 
							and act.copy_code = asubj.hos_id
							and act.acc_year = asubj.acc_year 
							and act.cash_subj_code = asubj.subj_code
					<where>
					act.group_id = #{group_id} 
					and act.hos_id = #{hos_id}
					and act.copy_code = #{copy_code} 
					and act.acc_year = #{acc_year} 
					and act.cash_subj_code = #{subj_code} 
					and substr(to_char(act.occur_date,'yyyy-MM-dd'),0,7) >=substr(#{begin_date},0,7)
					and substr(to_char(act.occur_date,'yyyy-MM-dd'),0,7) &lt;=substr(#{end_date},0,7)
					<!-- and act.occur_date 
					between to_date(#{begin_date},'yyyy/MM/dd') and to_date(#{end_date},'yyyy/MM/dd') -->
					<if test="is_con != null and is_con != ''">
						 	AND act.is_con = #{is_con}
					</if>
						<!-- <if test="tell_num != null and tell_num !=''">
				 			and (to_number(act.tell_number) >= to_number(#{tell_num}))
				 		</if>
				 		<if test="tell_number != null and tell_number !=''">
				 		    and (to_number(act.tell_number) &lt;= to_number(#{tell_number}))
				 		</if>
				 		<if test="tell_debit != null and tell_debit !=''">
				 		  and (act.debit  >=  #{tell_debit} or act.credit  >=  #{tell_debit})
				 		 </if>
				 		<if test="tell_credit != null and tell_credit !=''">
					 			 and (act.debit   &lt;=  #{tell_credit} or act.credit  &lt;=  #{tell_credit})
					 		</if> -->
				 		 
				 		<if test="summary != null and summary !=''">
				 			and act.summary like '%${summary}%'
				 		</if>
				 		<!-- <if test="nature_code != null and nature_code !=''">
				 			and act.tell_type_code=#{nature_code} 
				 		</if> -->
				    and act.is_init = 0
					</where>
				group by  
					act.cash_subj_code,
					act.group_id,
					act.hos_id,
					act.copy_code,
					act.occur_date ) t 
			group by t.cash_subj_code,t.group_id,t.hos_id,t.copy_code,t.occur_date
			
			),
			<!-- 本年累计 -->
			d_table as (
				select
					null as tell_id, 
					null as subj_code,
					t.occur_date,
					'本年累计' as summary ,
					0 as att_num,
					'' as check_no,
					to_char('') as subj_name,
					sum(t.debit) as debit,
					sum(t.credit) as credit,
					0 as bal,
					'' as create_user,
					'' as con_user,
					'' as con_date,
					'' as vouch_no,
					'' as is_import,
					null as is_con
				from (
					select act.group_id,
						act.hos_id,
						act.copy_code,
						act.cash_subj_code,
						to_char(act.occur_date,'yyyy') as occur_date,
						sum(act.debit) as debit,
						sum(act.credit) as credit 
					from acc_tell act 
						left join acc_subj asubj
							on act.group_id = asubj.group_id  
							and act.hos_id = asubj.hos_id
							and act.copy_code = asubj.copy_code 
							and act.acc_year = asubj.acc_year
							and act.cash_subj_code = asubj.subj_code
						<where>
							act.group_id = #{group_id} 
							and act.hos_id = #{hos_id} 
							and act.copy_code = #{copy_code}
							and act.acc_year = #{acc_year}
							and act.cash_subj_code = #{subj_code}
							<if test="begin_date != null and begin_date !='' and end_date != null and end_date !=''">
				 				AND act.occur_date between to_date(#{acc_year}||'-01-01','yyyy/MM/dd') and to_date(#{end_date},'yyyy/MM/dd')
				 			</if>
							<if test="is_con != null and is_con != ''">
						 		AND act.is_con = #{is_con}
							</if>
					 		<!-- <if test="tell_num != null and tell_num !=''">
				 				and (to_number(act.tell_number) >= to_number(#{tell_num}))
					 		</if>
					 		<if test="tell_number != null and tell_number !=''">
					 		    and (to_number(act.tell_number) &lt;= to_number(#{tell_number}))
					 		</if>
					 		<if test="tell_debit != null and tell_debit !=''">
					 		  and (act.debit  >=  #{tell_debit} or act.credit  >=  #{tell_debit})
					 		 </if>
					 		<if test="tell_credit != null and tell_credit !=''">
					 			 and (act.debit   &lt;=  #{tell_credit} or act.credit  &lt;=  #{tell_credit})
					 		</if> -->
					 		<!-- <if test="nature_code != null and nature_code !=''">
				 			and act.tell_type_code=#{nature_code} 
				 			</if> -->
				 			<if test="summary != null and summary !=''">
				 			and act.summary like '%${summary}%' 
				 		</if>
						    and act.is_init = 0
						</where>	 
						group by 
							act.group_id,
							act.hos_id,
							act.copy_code,
							act.occur_date,
							act.cash_subj_code
				) t
				group by t.cash_subj_code,t.group_id,t.hos_id,t.copy_code,t.occur_date

			),f_table as (
				select
					null as tell_id, 
					null as subj_code,
					t.occur_date,
					'流水号合计' as summary ,
					0 as att_num,
					'' as check_no,
					to_char('') as subj_name,
					sum(t.debit) as debit,
					sum(t.credit) as credit,
					0 as bal,
					'' as create_user,
					'' as con_user,
					'' as con_date,
					'' as vouch_no,
					'' as is_import,
					null as is_con
				from (
					select act.group_id,
						act.hos_id,
						act.copy_code,
						act.cash_subj_code,
						to_char(act.occur_date,'yyyy') as occur_date,
						sum(act.debit) as debit,
						sum(act.credit) as credit 
					from acc_tell act 
						left join acc_subj asubj
							on act.group_id = asubj.group_id  
							and act.hos_id = asubj.hos_id
							and act.copy_code = asubj.copy_code 
							and act.acc_year = asubj.acc_year
							and act.cash_subj_code = asubj.subj_code
						<where>
							act.group_id = #{group_id} 
							and act.hos_id = #{hos_id} 
							and act.copy_code = #{copy_code}
							and act.acc_year = #{acc_year}
							and act.cash_subj_code = #{subj_code}
							<if test="begin_date != null and begin_date !='' and end_date != null and end_date !=''">
				 				AND act.occur_date between to_date(#{begin_date},'yyyy/MM/dd') and to_date(#{end_date},'yyyy/MM/dd')
				 			</if>
							<if test="is_con != null and is_con != ''">
						 		AND act.is_con = #{is_con}
							</if>
					 		<if test="tell_num != null and tell_num !=''">
				 				and (to_number(act.tell_number) >= to_number(#{tell_num}))
					 		</if>
					 		<if test="tell_number != null and tell_number !=''">
					 		    and (to_number(act.tell_number) &lt;= to_number(#{tell_number}))
					 		</if>
					 		<if test="tell_debit != null and tell_debit !=''">
					 		  and (act.debit  >=  #{tell_debit} or act.credit  >=  #{tell_debit})
					 		 </if>
					 		<if test="tell_credit != null and tell_credit !=''">
					 			 and (act.debit   &lt;=  #{tell_credit} or act.credit  &lt;=  #{tell_credit})
					 		</if>
					 		<!-- <if test="nature_code != null and nature_code !=''">
				 			and act.tell_type_code=#{nature_code} 
				 			</if> -->
				 			<if test="summary != null and summary !=''">
				 			and act.summary like '%${summary}%' 
				 		</if>
						    and act.is_init = 0
						</where>	 
						group by 
							act.group_id,
							act.hos_id,
							act.copy_code,
							act.occur_date,
							act.cash_subj_code
				) t
				group by t.cash_subj_code,t.group_id,t.hos_id,t.copy_code,t.occur_date

		) select * from ( select  
        t.tell_number,
		t.bz,
		t.tell_id,
		t.subj_code,
		t.occur_date as s_occur_date,
		t.summary summary1,
		t.att_num,
		t.check_no,
		t.other_subj_code,
		t.subj_name,
		t.debit,
		t.credit,
		sum(t.bal) over(order by t.bz,t.tell_type_code asc,t.occur_date,t.tell_id) as bal, 
		t.user_name as create_user_name,
		t.con_user as con_user_name,
		t.con_date as s_con_date,
		t.vouch_no,
		t.is_import as is_por,
		t.is_con,
		t.pay_code,
		t.pay_name,
		t.tell_type_code
 from ( 
  
		<!--  期初余额 -->
	     select null tell_number,null as tell_id,null as subj_code,'0' bz, v.occur_date,v.summary	,null as att_num,v.check_no,null other_subj_code,v.subj_name,
	     v.debit,v.credit,v.bal,'' as user_name,'' as con_user,'' as con_date,'' as vouch_no,v.is_import,null as is_con,null pay_code,null pay_name,null as tell_type_code from v_table v 
	    union all 
	     
	    <!-- 发生数据 -->
	    select a.tell_number,a.tell_id,a.subj_code,a.occur_date bz, a.occur_date,a.summary,a.att_num,a.check_no,a.other_subj_code,a.subj_name,
	     a.debit,a.credit,a.bal,a.user_name,a.con_user,a.con_date,a.vouch_no,a.is_import,a.is_con,a.pay_code,a.pay_name,a.tell_type_code from a_table a
	    
	    union all
	
	    <!-- 本日合计 -->
	    select  null tell_number,null as tell_id,null as subj_code,b.occur_date||'1' bz ,b.occur_date,b.summary,null as att_num,'' as check_no,null other_subj_code,to_char('') as subj_name,
	    b.debit,b.credit,b.bal,'' as user_name,'' as con_user,'' as con_date,'' as vouch_no,b.is_import,null as is_con,null pay_code,null pay_name,null as tell_type_code
	     from b_table b inner join a_table a on a. occur_date=b.occur_date
	     group by   b.occur_date,b.summary,b.check_no,
	     b.user_name,b.bal,b.att_num,b.debit,b.credit,b.con_user,b.con_date,b.vouch_no,b.subj_name,b.is_import
	     
	     union all
	    <!-- 本月合计  -->
	     select null tell_number,null as tell_id,null as subj_code,c.occur_date||'2' bz,c.occur_date,c.summary,null as att_num,c.check_no,null other_subj_code,c.subj_name,
	     c.debit,c.credit,c.bal,'' as user_name,'' as con_user,'' as con_date,'' as vouch_no,c.is_import,null as is_con,null pay_code,null pay_name,null as tell_type_code from c_table c
	     
	     union all
	   <!--   本年累计 -->
	     select  null tell_number,null as vouch_check_id,null as subj_code,d.occur_date||'3' bz,d.occur_date,d.summary,null as att_num,d.check_no,null other_subj_code,d.subj_name,
	     d.debit,d.credit,d.bal,'' as user_name,'' as con_user,'' as con_date,'' as vouch_no,d.is_import,null as is_con,null pay_code,null pay_name,null as tell_type_code from d_table d 
 		union all
	   <!--   本年累计 -->
	     select  null tell_number,null as vouch_check_id,null as subj_code,e.occur_date||'4' bz,e.occur_date,e.summary,null as att_num,e.check_no,null other_subj_code,e.subj_name,
	     e.debit,e.credit,e.bal,'' as user_name,'' as con_user,'' as con_date,'' as vouch_no,e.is_import,null as is_con,null pay_code,null pay_name,null as tell_type_code from f_table e 
 
 ) t 
 
 order by t.bz,t.tell_type_code asc,t.occur_date,t.tell_number,t.tell_id asc ) a
 <where>
	 <if test="nature_code != null and nature_code !=''">
		and  (a.tell_type_code=#{nature_code} or a.tell_type_code is null)
	</if>
	<if test="nature_code=='01' and type_code != 0">
		and  (a.credit =0 or a.debit !=0 and a.credit !=0)
	</if>
	<if test="nature_code=='03' and type_code != 0">
		and  (a.credit =0 or a.debit !=0 and a.credit !=0)
	</if>
	<if test=" nature_code=='02' and type_code != 0">
		and  (a.debit =0 or a.debit !=0 and a.credit !=0)
	</if>
	<if test=" nature_code=='04' and type_code != 0">
		and  (a.debit =0 or a.debit !=0 and a.credit !=0)
	</if>
 </where>
	</select>
	
	
	
	<select id="queryCashAccountByCodeForTemplatePrint" parameterType="java.util.Map" resultMap="accTellMap">
		with v_table as(

			<!--期初余额 -->
			select
				null as tell_id, 
				null as subj_code,
				'' as occur_date,
				'期初余额' as summary ,
				0 as att_num,
				'' as check_no,
				to_char('') as subj_name,
				0 as  debit,
				0 as credit,
				<if test="acc_year==start_year">
				a.bal+b.bal+c.bal as  bal,
				</if>
				<if test="acc_year!=start_year">
				a.bal+c.bal as  bal,
				</if>
				'' as user_name,
				'' as con_user,
				'' as con_date,
				'' as vouch_no,
				'' as is_import,
				null as is_con 
			from
			<!-- 财务帐表余额 -->
				(select 
					al.end_os as bal 
				from acc_leder al 
					where al.group_id = #{group_id} 
					and al.hos_id =#{hos_id}
					and al.copy_code = #{copy_code} 
					and al.acc_year = #{acc_year} 
					and al.acc_month = '00' 
					and al.subj_code = #{subj_code}
				) a,
			<if test="acc_year==start_year">
				<!-- 凭证明细表借方减贷方 -->
				(select 
					nvl(sum(avd.debit),0)-nvl(sum(avd.credit),0) as bal 
				from acc_vouch_detail avd
				left join acc_vouch av 
					on avd.group_id = av.group_id 
					and avd.hos_id = av.hos_id 
					and avd.copy_code = av.copy_code
					and avd.vouch_id = av.vouch_id and avd.acc_year = av.acc_year
					where 
						avd.group_id = #{group_id}
						and avd.hos_id = #{hos_id}
						and avd.copy_code = #{copy_code} 
						and avd.subj_code = #{subj_code}
						and avd.acc_year = #{acc_year} 
						and av.acc_month &lt; #{start_month}
				) b,
			</if>
			<!-- 出纳帐制单日期小于开始日期的发生数 -->
			
				(select 
					nvl(sum(act.debit),0)-nvl(sum(act.credit),0) as bal 
				from acc_tell act
				where 
					act.group_id = #{group_id}
					and act.hos_id = #{hos_id} 
					and act.copy_code = #{copy_code}
					and act.acc_year = #{acc_year}
					and act.cash_subj_code = #{subj_code}
					and act.occur_date &lt; to_date(#{begin_date},'yyyy/MM/dd')
					and act.is_init = '0'
				) c
			
			),
			
			a_table as (
			<!-- 每天的发生数据 -->
				 select 
				     att.tell_type_name||'-'||act.tell_number tell_number,
					 act.tell_id,
					 act.cash_subj_code as subj_code,
					 to_char(act.occur_date,'yyyy-MM-dd') as occur_date,
					 act.summary,
					 act.att_num,
					 act.check_no,
					 asubj.subj_code other_subj_code,
					 <!-- asubj.subj_name, -->
					 to_char(asubj.subj_code ||'  '|| asubj.subj_name) subj_name,
					 act.debit,
					 act.credit,
					 act.debit-act.credit as bal,
					 su.user_name,
					 sus.user_name as con_user,
					 to_char(act.con_date,'yyyy/MM/dd') as con_date,
					 case when av.vouch_no is not null then avt.vouch_type_name || '-' || av.vouch_no  else '' end vouch_no,
					 case when act.is_import=1 then '是' else '否' end as is_import,
					 act.is_con,apt.pay_code,apt.pay_name,att.tell_type_code
				 from acc_tell act 
				 	left join acc_subj asubj
						 on act.group_id= asubj.group_id 
						 and act.hos_id = asubj.hos_id 
						 and act.copy_code = asubj.copy_code 
						 and act.acc_year=asubj.acc_year
						 and act.other_subj_code = asubj.subj_code
				 	left join sys_user su on
				 act.group_id = su.group_id 
				 and act.hos_id = su.hos_id 
				 and act.create_user = su.user_id
				 	left join sys_user sus on
				 act.group_id = sus.group_id and act.hos_id = sus.hos_id and act.con_user = sus.user_id
				 	left join acc_vouch av on act.group_id = av.group_id
				 and act.hos_id = av.hos_id and act.copy_code = av.copy_code and act.acc_year = av.acc_year
				 and act.vouch_id = av.vouch_id
				 left join acc_vouch_type avt on av.group_id =avt.group_id
		        and av.hos_id=avt.hos_id and av.copy_code=avt.copy_code
		        and av.vouch_type_code=avt.vouch_type_code 
				 left join acc_pay_type apt on apt.group_id = act.group_id
                 and apt.hos_id = act.hos_id  and apt.copy_code = act.copy_code
                 and apt.pay_code = act.pay_type_code
                 left join acc_tell_type att on att.group_id = act.group_id
		        and att.hos_id = act.hos_id
		        and att.copy_code = act.copy_code
		        and att.tell_type_code = act.tell_type_code 
		         
				 	<where>
				 	    act.is_init = 0
				 		<if test="group_id != null and group_id != ''">
				 			AND act.group_id = #{group_id} 
				 		</if>
				 		<if test="hos_id != null and hos_id != ''">
				 			AND act.hos_id = #{hos_id}
				 		</if>
				 		<if test="copy_code !=null and copy_code !=''">
				 			AND act.copy_code=#{copy_code} 
				 		</if>
				 		<if test="subj_code !=null and subj_code !=''">
				 			AND act.cash_subj_code = #{subj_code}
				 		</if>
				 		<if test="begin_date != null and begin_date !='' and end_date != null and end_date !=''">
				 			AND act.occur_date between to_date(#{begin_date},'yyyy/MM/dd') and to_date(#{end_date},'yyyy/MM/dd')
				 		</if>
				 		<if test="is_con != null and is_con !=''">
				 			and act.is_con=#{is_con} 
				 		</if>
				 		<if test="vouch_no != null and vouch_no !='' and vouch_no ==0">
				 			and act.vouch_id  is null
				 		</if>
				 		<if test="vouch_no != null and vouch_no !='' and vouch_no ==1 ">
				 			and act.vouch_id is not null
				 		</if>
				 		<if test="pay_code != null and pay_code !=''">
				 			 and apt.pay_code=#{pay_code} 
				 		</if>
				 		<if test="summary != null and summary !=''">
				 			and act.summary like '%${summary}%' 
				 		</if>
				 		<if test="tell_num != null and tell_num !=''">
				 			and (to_number(act.tell_number) >= to_number(#{tell_num}))
				 		</if>
				 		<if test="tell_number != null and tell_number !=''">
				 		    and (to_number(act.tell_number) &lt;= to_number(#{tell_number}))
				 		</if>
				 		<if test="tell_debit != null and tell_debit !='' and tell_credit != null and tell_credit !=''">
				 		  and (act.debit  >=  #{tell_debit} and act.debit   &lt;=  #{tell_credit}
				 		  or  act.credit  >=  #{tell_debit} and act.credit  &lt;=  #{tell_credit})
				 		 </if>
				 		 <if test="tell_debit != null and tell_debit !='' and tell_credit == null and tell_credit ==''">
				 		  and (act.debit  >=  #{tell_debit} or  act.credit  >=  #{tell_debit})
				 		 </if>
				 		 <if test="tell_credit != null and tell_credit !='' and tell_debit == null and tell_debit ==''">
				 		  and ( act.debit   &lt;=  #{tell_credit} and act.credit  &lt;=  #{tell_credit})
				 		 </if>
				 	</where> 
					 	order by att.tell_type_code	 	
			 ),
			 
			 b_table as (
			<!--  本日合计 -->
				 select 
				 	 null as tell_id,
				 	 null as subj_code,
				 	 t.occur_date,
					 '本日合计' as summary ,
					 0 as att_num,
					 '' as check_no,
					 to_char('') as subj_name,
					 sum(t.debit) as debit,
					 sum(t.credit) as credit,
					 0 as  bal,
					 '' as user_name,
					 '' as con_user,
					 '' as con_date,
					 '' as vouch_no,
					 '' as is_import,
					 null as is_con
				from ( 
					select 
						act.cash_subj_code,
						act.group_id,
						act.hos_id,
						act.copy_code,
						to_char(act.occur_date,'yyyy-MM-dd') as occur_date,
						sum(act.debit) as debit,
						sum(act.credit) as credit,
						sum(act.debit-act.credit) as  bal
					from acc_tell act 
					left join acc_subj asubj
						 on act.group_id= asubj.group_id 
						 and act.hos_id = asubj.hos_id 
						 and act.copy_code = asubj.copy_code 
						 and act.acc_year=asubj.acc_year
						 and act.cash_subj_code = asubj.subj_code 
					 <where>
						 act.group_id=#{group_id} 
						 and act.hos_id=#{hos_id} 
						 and act.copy_code = #{copy_code}
						 and act.acc_year = #{acc_year} 
						 and act.occur_date between to_date(#{begin_date},'yyyy/MM/dd') and to_date(#{end_date},'yyyy/MM/dd')
						 and act.cash_subj_code=#{subj_code}
						 and act.is_init = 0
						 <if test="is_con != null and is_con != ''">
						 	AND act.is_con = #{is_con}
						 </if>
						 <!-- <if test="tell_num != null and tell_num !=''">
				 			and (to_number(act.tell_number) >= to_number(#{tell_num}))
				 		</if>
				 		<if test="tell_number != null and tell_number !=''">
				 		    and (to_number(act.tell_number) &lt;= to_number(#{tell_number}))
				 		</if>
				 		<if test="tell_debit != null and tell_debit !=''">
				 		  and (act.debit  >=  #{tell_debit} or act.credit  >=  #{tell_debit})
				 		 </if>
				 		<if test="tell_credit != null and tell_credit !=''">
					 			 and (act.debit   &lt;=  #{tell_credit} or act.credit  &lt;=  #{tell_credit})
					 		</if> -->
				 		<if test="summary != null and summary !=''">
				 			and act.summary like '%${summary}%' 
				 		</if>
				 		<!-- <if test="nature_code != null and nature_code !=''">
				 			and act.tell_type_code=#{nature_code} 
				 		</if> -->
					</where> 
					 group by 
					 	act.cash_subj_id,
					 	act.group_id,
					 	act.hos_id,
					 	act.copy_code,
					 	act.occur_date,
					 	act.cash_subj_code) t 
				group by t.cash_subj_code,t.group_id,t.hos_id,t.copy_code,t.occur_date
			
			),
			<!-- 本月合计-->
			c_table as (
				select
					null as tell_id, 
					null as subj_code,
					t.occur_date,
					'本月合计' as summary ,
					0 as att_num,
					'' as check_no,
					to_char('') as subj_name,
					sum(t.debit) as debit,
					sum(t.credit) as credit,
					0 as bal,
					'' as user_name,
					'' as con_user,
					'' as con_date,
					'' as vouch_no,
					'' as is_import,
					null as is_con
				from(
					select act.cash_subj_code,
						act.group_id,
						act.hos_id,
						act.copy_code,
						to_char(act.occur_date,'yyyy-MM') as occur_date,
						sum(act.debit) as debit,
						sum(act.credit) as credit,
						sum(act.debit)-sum(act.credit) as bal
					from acc_tell act 
						left join acc_subj asubj
							on act.group_id = asubj.group_id 
							and act.hos_id = asubj.hos_id 
							and act.copy_code = asubj.hos_id
							and act.acc_year = asubj.acc_year 
							and act.cash_subj_code = asubj.subj_code
					<where>
					act.group_id = #{group_id} 
					and act.hos_id = #{hos_id}
					and act.copy_code = #{copy_code} 
					and act.acc_year = #{acc_year} 
					and act.cash_subj_code = #{subj_code} 
					and substr(to_char(act.occur_date,'yyyy-MM-dd'),0,7) >=substr(#{begin_date},0,7)
					and substr(to_char(act.occur_date,'yyyy-MM-dd'),0,7) &lt;=substr(#{end_date},0,7)
					<!-- and act.occur_date 
					between to_date(#{begin_date},'yyyy/MM/dd') and to_date(#{end_date},'yyyy/MM/dd') -->
					<if test="is_con != null and is_con != ''">
						 	AND act.is_con = #{is_con}
					</if>
						<!-- <if test="tell_num != null and tell_num !=''">
				 			and (to_number(act.tell_number) >= to_number(#{tell_num}))
				 		</if>
				 		<if test="tell_number != null and tell_number !=''">
				 		    and (to_number(act.tell_number) &lt;= to_number(#{tell_number}))
				 		</if>
				 		<if test="tell_debit != null and tell_debit !=''">
				 		  and (act.debit  >=  #{tell_debit} or act.credit  >=  #{tell_debit})
				 		 </if>
				 		<if test="tell_credit != null and tell_credit !=''">
					 			 and (act.debit   &lt;=  #{tell_credit} or act.credit  &lt;=  #{tell_credit})
					 		</if> -->
				 		 
				 		<if test="summary != null and summary !=''">
				 			and act.summary like '%${summary}%'
				 		</if>
				 		<!-- <if test="nature_code != null and nature_code !=''">
				 			and act.tell_type_code=#{nature_code} 
				 		</if> -->
				    and act.is_init = 0
					</where>
				group by  
					act.cash_subj_code,
					act.group_id,
					act.hos_id,
					act.copy_code,
					act.occur_date ) t 
			group by t.cash_subj_code,t.group_id,t.hos_id,t.copy_code,t.occur_date
			
			),
			<!-- 本年累计 -->
			d_table as (
				select
					null as tell_id, 
					null as subj_code,
					t.occur_date,
					'本年累计' as summary ,
					0 as att_num,
					'' as check_no,
					to_char('') as subj_name,
					sum(t.debit) as debit,
					sum(t.credit) as credit,
					0 as bal,
					'' as create_user,
					'' as con_user,
					'' as con_date,
					'' as vouch_no,
					'' as is_import,
					null as is_con
				from (
					select act.group_id,
						act.hos_id,
						act.copy_code,
						act.cash_subj_code,
						to_char(act.occur_date,'yyyy') as occur_date,
						sum(act.debit) as debit,
						sum(act.credit) as credit 
					from acc_tell act 
						left join acc_subj asubj
							on act.group_id = asubj.group_id  
							and act.hos_id = asubj.hos_id
							and act.copy_code = asubj.copy_code 
							and act.acc_year = asubj.acc_year
							and act.cash_subj_code = asubj.subj_code
						<where>
							act.group_id = #{group_id} 
							and act.hos_id = #{hos_id} 
							and act.copy_code = #{copy_code}
							and act.acc_year = #{acc_year}
							and act.cash_subj_code = #{subj_code}
							<if test="begin_date != null and begin_date !='' and end_date != null and end_date !=''">
				 				AND act.occur_date between to_date(#{acc_year}||'-01-01','yyyy/MM/dd') and to_date(#{end_date},'yyyy/MM/dd')
				 			</if>
							<if test="is_con != null and is_con != ''">
						 		AND act.is_con = #{is_con}
							</if>
					 		<!-- <if test="tell_num != null and tell_num !=''">
				 				and (to_number(act.tell_number) >= to_number(#{tell_num}))
					 		</if>
					 		<if test="tell_number != null and tell_number !=''">
					 		    and (to_number(act.tell_number) &lt;= to_number(#{tell_number}))
					 		</if>
					 		<if test="tell_debit != null and tell_debit !=''">
					 		  and (act.debit  >=  #{tell_debit} or act.credit  >=  #{tell_debit})
					 		 </if>
					 		<if test="tell_credit != null and tell_credit !=''">
					 			 and (act.debit   &lt;=  #{tell_credit} or act.credit  &lt;=  #{tell_credit})
					 		</if> -->
					 		<!-- <if test="nature_code != null and nature_code !=''">
				 			and act.tell_type_code=#{nature_code} 
				 			</if> -->
				 			<if test="summary != null and summary !=''">
				 			and act.summary like '%${summary}%' 
				 		</if>
						    and act.is_init = 0
						</where>	 
						group by 
							act.group_id,
							act.hos_id,
							act.copy_code,
							act.occur_date,
							act.cash_subj_code
				) t
				group by t.cash_subj_code,t.group_id,t.hos_id,t.copy_code,t.occur_date

			),f_table as (
				select
					null as tell_id, 
					null as subj_code,
					t.occur_date,
					'流水号合计' as summary ,
					0 as att_num,
					'' as check_no,
					to_char('') as subj_name,
					sum(t.debit) as debit,
					sum(t.credit) as credit,
					0 as bal,
					'' as create_user,
					'' as con_user,
					'' as con_date,
					'' as vouch_no,
					'' as is_import,
					null as is_con
				from (
					select act.group_id,
						act.hos_id,
						act.copy_code,
						act.cash_subj_code,
						to_char(act.occur_date,'yyyy') as occur_date,
						sum(act.debit) as debit,
						sum(act.credit) as credit 
					from acc_tell act 
						left join acc_subj asubj
							on act.group_id = asubj.group_id  
							and act.hos_id = asubj.hos_id
							and act.copy_code = asubj.copy_code 
							and act.acc_year = asubj.acc_year
							and act.cash_subj_code = asubj.subj_code
						<where>
							act.group_id = #{group_id} 
							and act.hos_id = #{hos_id} 
							and act.copy_code = #{copy_code}
							and act.acc_year = #{acc_year}
							and act.cash_subj_code = #{subj_code}
							<if test="begin_date != null and begin_date !='' and end_date != null and end_date !=''">
				 				AND act.occur_date between to_date(#{begin_date},'yyyy/MM/dd') and to_date(#{end_date},'yyyy/MM/dd')
				 			</if>
							<if test="is_con != null and is_con != ''">
						 		AND act.is_con = #{is_con}
							</if>
					 		<if test="tell_num != null and tell_num !=''">
				 				and (to_number(act.tell_number) >= to_number(#{tell_num}))
					 		</if>
					 		<if test="tell_number != null and tell_number !=''">
					 		    and (to_number(act.tell_number) &lt;= to_number(#{tell_number}))
					 		</if>
					 		<if test="tell_debit != null and tell_debit !=''">
					 		  and (act.debit  >=  #{tell_debit} or act.credit  >=  #{tell_debit})
					 		 </if>
					 		<if test="tell_credit != null and tell_credit !=''">
					 			 and (act.debit   &lt;=  #{tell_credit} or act.credit  &lt;=  #{tell_credit})
					 		</if>
					 		<!-- <if test="nature_code != null and nature_code !=''">
				 			and act.tell_type_code=#{nature_code} 
				 			</if> -->
				 			<if test="summary != null and summary !=''">
				 			and act.summary like '%${summary}%' 
				 		</if>
						    and act.is_init = 0
						</where>	 
						group by 
							act.group_id,
							act.hos_id,
							act.copy_code,
							act.occur_date,
							act.cash_subj_code
				) t
				group by t.cash_subj_code,t.group_id,t.hos_id,t.copy_code,t.occur_date

		) 
		select 1 as id,a.* from ( select  
        t.tell_number,
		t.bz,
		t.tell_id,
		t.subj_code,
		t.occur_date as s_occur_date,
		t.summary,
		t.att_num,
		t.check_no,
		t.other_subj_code,
		t.subj_name,
		t.debit,
		t.credit,
		sum(t.bal) over(order by t.bz,t.tell_type_code asc,t.occur_date,t.tell_id) as bal, 
		t.user_name as create_user_name,
		t.con_user as con_user_name,
		t.con_date as s_con_date,
		t.vouch_no,
		t.is_import as is_por,
		t.is_con,
		t.pay_code,
		t.pay_name,
		t.tell_type_code
 from ( 
  
		<!--  期初余额 -->
	     select null tell_number,null as tell_id,null as subj_id,'0' bz, v.occur_date,v.summary	,null as att_num,v.check_no,null other_subj_id,v.subj_name,
	     v.debit,v.credit,v.bal,'' as user_name,'' as con_user,'' as con_date,'' as vouch_no,v.is_import,null as is_con,null pay_code,null pay_name,null as tell_type_code from v_table v 
	    union all 
	     
	    <!-- 发生数据 -->
	    select a.tell_number,a.tell_id,a.subj_id,a.occur_date bz, a.occur_date,a.summary,a.att_num,a.check_no,a.other_subj_id,a.subj_name,
	     a.debit,a.credit,a.bal,a.user_name,a.con_user,a.con_date,a.vouch_no,a.is_import,a.is_con,a.pay_code,a.pay_name,a.tell_type_code from a_table a
	    
	    union all
	
	    <!-- 本日合计 -->
	    select  null tell_number,null as tell_id,null as subj_id,b.occur_date||'1' bz ,b.occur_date,b.summary,null as att_num,'' as check_no,null other_subj_id,to_char('') as subj_name,
	    b.debit,b.credit,b.bal,'' as user_name,'' as con_user,'' as con_date,'' as vouch_no,b.is_import,null as is_con,null pay_code,null pay_name,null as tell_type_code
	     from b_table b inner join a_table a on a. occur_date=b.occur_date
	     group by   b.occur_date,b.summary,b.check_no,
	     b.user_name,b.bal,b.att_num,b.debit,b.credit,b.con_user,b.con_date,b.vouch_no,b.subj_name,b.is_import
	     
	     union all
	    <!-- 本月合计  -->
	     select null tell_number,null as tell_id,null as subj_id,c.occur_date||'2' bz,c.occur_date,c.summary,null as att_num,c.check_no,null other_subj_id,c.subj_name,
	     c.debit,c.credit,c.bal,'' as user_name,'' as con_user,'' as con_date,'' as vouch_no,c.is_import,null as is_con,null pay_code,null pay_name,null as tell_type_code from c_table c
	     
	     union all
	   <!--   本年累计 -->
	     select  null tell_number,null as vouch_check_id,null as subj_id,d.occur_date||'3' bz,d.occur_date,d.summary,null as att_num,d.check_no,null other_subj_id,d.subj_name,
	     d.debit,d.credit,d.bal,'' as user_name,'' as con_user,'' as con_date,'' as vouch_no,d.is_import,null as is_con,null pay_code,null pay_name,null as tell_type_code from d_table d 
 		union all
	   <!--   本年累计 -->
	     select  null tell_number,null as vouch_check_id,null as subj_id,e.occur_date||'4' bz,e.occur_date,e.summary,null as att_num,e.check_no,null other_subj_id,e.subj_name,
	     e.debit,e.credit,e.bal,'' as user_name,'' as con_user,'' as con_date,'' as vouch_no,e.is_import,null as is_con,null pay_code,null pay_name,null as tell_type_code from f_table e 
 
 ) t 
 
 order by t.bz,t.tell_type_code asc,t.occur_date,t.tell_number,t.tell_id asc ) a
 <where>
	 <if test="nature_code != null and nature_code !=''">
		and  (a.tell_type_code=#{nature_code} or a.tell_type_code is null)
	</if>
	<if test="nature_code=='01' and type_code != 0">
		and  (a.credit =0 or a.debit !=0 and a.credit !=0)
	</if>
	<if test="nature_code=='03' and type_code != 0">
		and  (a.credit =0 or a.debit !=0 and a.credit !=0)
	</if>
	<if test=" nature_code=='02' and type_code != 0">
		and  (a.debit =0 or a.debit !=0 and a.credit !=0)
	</if>
	<if test=" nature_code=='04' and type_code != 0">
		and  (a.debit =0 or a.debit !=0 and a.credit !=0)
	</if>
 </where>
	</select>
	
	
	
	<insert id="saveAutoVouchLog" parameterType="java.util.List">
		
		<foreach collection="list" item="item" index="index" open="begin" separator=";" close=";end;">
		
			INSERT INTO acc_busi_log_temp(
				group_id, hos_id, copy_code,vouch_id, business_no, busi_type_code, template_code, create_date
			)
			VALUES(
				#{item.group_id,jdbcType=INTEGER}, 
				#{item.hos_id,jdbcType=INTEGER}, 
				#{item.copy_code,jdbcType=INTEGER}, 
				#{item.vouch_id,jdbcType=VARCHAR}, 
				#{item.business_no,jdbcType=VARCHAR}, 
				#{item.busi_type_code,jdbcType=VARCHAR}, 
				#{item.template_code,jdbcType=VARCHAR}, 
				#{item.create_date,jdbcType=TIMESTAMP}<!-- ,
				#{item.create_user,jdbcType=INTEGER}  -->
			)
		</foreach>
	</insert>
	<select id="querSubjCode" parameterType="java.util.Map" resultType="java.util.Map">
	
	select a.subj_code
    from ACC_SUBJ a
    where a.group_id = #{group_id} 
      and a.hos_id = #{hos_id} 
      and a.copy_code = #{copy_code} 
      and a.acc_year = #{acc_year} 
    and a.SUBJ_NATURE_CODE in( '03','02')
 
      and a.is_last = '1'
    order by a.SUBJ_CODE
	</select>
 	<select id="queryAllCheckQuery"  parameterType="java.util.Map" resultType="java.util.Map">

WITH subj AS (
			<!-- 查询现金、银行科目 -->
    		SELECT DISTINCT 
	    		s.super_code, s.subj_nature_code, s.is_last, s.subj_level, s.subj_code, s.subj_name 
	    	FROM ACC_SUBJ s 
	    	WHERE 
		    	s.group_id=#{group_id} 
		    	AND s.hos_id=#{hos_id}
		    	AND s.copy_code=#{copy_code} 
		    	AND s.subj_nature_code in('02','03')
		    	  and s.is_last = '1'
		), 
		
		cashData AS(
			<!-- 4.上月库存 -->
    		SELECT
	    		subj.super_code, subj.subj_nature_code, subj.is_last, subj.subj_level, subj.subj_code, subj.subj_name,
	    		nvl(c.end_os,0)+nvl(a.bal,0)+nvl(b.bal,0) as bal, nvl(d.debit,0) as debit, nvl(d.credit,0) as credit 
   			FROM SUBJ
    		LEFT JOIN (
    			select 
      			<!-- 2.凭证结存：根据会计期间表中的开始日期作为条件查询凭证明细表 -->
	            	s.subj_code, avd.group_id,
	            avd.hos_id,
	            avd.copy_code,
	            avd.acc_year,
	            sum(avd.debit-avd.credit) as bal
	         from
	                acc_vouch_detail avd
	         inner join acc_vouch av          
	               on avd.vouch_id = av.vouch_id
	         inner join acc_subj s 
	         	   on 
	         	   	avd.group_id = s.group_id
	         	   	AND avd.hos_id = s.hos_id
	         	   	AND avd.copy_code = s.copy_code
	         	   	AND avd.acc_year = s.acc_year
	         	   	AND avd.subj_code =s.subj_code
	         	   and s.subj_nature_code in('02','03')
	         where
	               avd.group_id = #{group_id}
	               AND avd.hos_id = #{hos_id}
	               AND avd.copy_code = #{copy_code}   
	               AND avd.acc_year between #{acc_year_b} and #{acc_year_e}
	               and exists (
	                 <!-- 1.根据出纳账系统启用年月作为条件查询会计期间表的开始日期 -->                                                                                        
	               		select
	                      	1
	                  	from
	                       acc_year_month aym
	                  	where
	                       aym.group_id = avd.group_id
	                       AND aym.hos_id = avd.hos_id
	                       AND aym.copy_code =avd.copy_code
	                       AND aym.acc_year || aym.acc_month = #{modStartYearMonth}
	                       AND av.vouch_date &lt; aym.begin_date
	                   )
	                   <if test="is_account == 1">
	                    AND av.state > 0
	                  </if>
	               <if test="is_account == 0">
	                    AND av.state = 99
	                  </if>
	           group by avd.group_id,avd.hos_id,avd.copy_code,avd.acc_year,s.subj_code
			) a 
	           on subj.subj_code=a.subj_code
      left join 
<!-- 3.根据选择的年月,选择的日期年度，状态查询出纳账表借(收入)减贷(支出)的值 -->
        (
        select
             s.subj_code,
             sum(att.debit)-
             sum(att.credit) as bal
        from acc_tell att
        inner join acc_subj s 
	        on 
	        	att.group_id = s.group_id
	        	AND att.hos_id = s.hos_id
	        	AND att.copy_code = s.copy_code
	        	AND att.acc_year = s.acc_year
	        	AND att.cash_subj_code = s.subj_code
	        	 
	        	and s.subj_nature_code in('02','03')
        where att.group_id = #{group_id}
             AND att.hos_id = #{hos_id}
             AND att.copy_code = #{copy_code}
             AND att.acc_year  between #{acc_year_b} and #{acc_year_e}
             <!-- 选择的年月 -->
             AND to_char(att.occur_date,'yyyy/MM') &lt; #{end_yearMonth}
            <!--  AND att.state > 0 -->
        group by 
               s.subj_code
        ) b
    ON subj.subj_code=b.subj_code 
    left join
		(
		     select s.subj_code,sum(al.end_os) end_os  from acc_leder al
		     inner join acc_subj s 
		     on 
		     	al.group_id = s.group_id 
		     	AND al.hos_id = s.hos_id
		     	AND al.copy_code = s.copy_code
		     	AND al.acc_year = s.acc_year
		     	AND al.subj_code =s.subj_code
		     	AND s.subj_nature_code in('02','03')
		     	
		       where al.group_id = #{group_id}
		        AND al.hos_id =#{hos_id}
		        AND al.copy_code = #{copy_code}
		        AND al.acc_year between #{acc_year_b} and #{acc_year_e}
		        AND s.subj_code = al.subj_code
		           AND al.acc_month=00
		       group by s.subj_code    
		 )  c
     on c.subj_code=subj.subj_code
 <!-- 查询本月收入和支出 -->
		 left join 
		 (
		       select
		             s.subj_code,
		             sum(att.debit) as debit,
		             sum(att.credit) as credit
		        from acc_tell att
		         inner join acc_subj s 
		         on
		         	att.group_id = s.group_id
		         	AND att.hos_id = s.hos_id
		         	AND att.copy_code = s.copy_code
		         	AND att.acc_year = s.acc_year
		        	AND att.cash_subj_code = s.subj_code
		         and s.subj_nature_code in('02','03')
		        where att.group_id = #{group_id}
		             AND att.hos_id = #{hos_id}
		             AND att.copy_code = #{copy_code}
		             AND att.acc_year  between #{acc_year_b} and #{acc_year_e}
		             AND to_char(att.occur_date,'yyyy/MM')&gt;= #{begin_date}
		             and to_char(att.occur_date,'yyyy/MM')&lt;= #{end_date}
		             <!-- AND att.state > 0 -->
		             group by  s.subj_code
		 ) d
     	on d.subj_code=subj.subj_code
 
     	order by subj.subj_code
 ),
 superData as(
 		select 
	 		super_code,
	 		sum(bal) bal,
	 		sum(debit) as debit,
	 		sum(credit) as credit,
	 		sum(bal)+sum(debit)-sum(credit) as curMonth_bal 
 		from cashData 
 		where 
 			super_code!='top' and super_code!='0' 
 		group by 
 			super_code
 ), 
 resultData as(
	 select 
			 subj_code ord,
			 subj_nature_code,
			 subj_level,
			 subj_code,  
			 bal as preMonth_bal,
			 debit,
			 credit,
			 bal+debit-credit as curMonth_bal  
	 from cashData 
	<!--  where 
 		is_last=1 -->
 
 )
, 
subj_temp as (
    select c.group_id,c.hos_id,c.copy_code,c.acc_year,c.subj_code,c.subj_name,c.subj_name_all,c.subj_dire,c.is_last,
				c.subj_type_code,a.subj_type_name,c.subj_level,c.is_check
			from acc_subj c
			left join acc_subj_type a on c.group_id = a.group_id and c.hos_id = a.hos_id 
  				and c.copy_code = a.copy_code and c.subj_type_code = a.subj_type_code
      where c.group_id = #{group_id}
          and c.hos_id =#{hos_id}
          and c.copy_code = #{copy_code}
         and   c.acc_year between #{acc_year_b} and #{acc_year_e}
          and c.subj_nature_code in ('02', '03')
            and c.is_last = '1'
        <!--   and c.is_last='1' -->
  ), 
  y_balance as (
    		select a.group_id,a.hos_id,a.copy_code,a.acc_year,a.subj_code, a.subj_dire, a.subj_type_code,a.subj_type_name,a.is_last,
    			sum(end_os) as end_os, sum(sum_od) as sum_od, sum(sum_oc) as sum_oc
			from subj_temp a 
      		left join (
      			select s.group_id,s.hos_id,s.copy_code,s.acc_year,s.subj_code,s.subj_dire,s.subj_type_code,sum(c.end_os) end_os, sum(sum_od) sum_od, sum(sum_oc) sum_oc
    			from acc_leder c
   				right join subj_temp s on c.group_id = s.group_id and c.hos_id = s.hos_id
     				and c.copy_code = s.copy_code and c.acc_year = s.acc_year and c.subj_code = s.subj_code
   				where c.acc_month = '00' 
   				group by s.group_id,s.hos_id,s.copy_code,s.acc_year,s.subj_code,s.subj_dire,s.subj_type_code
   			) b on b.subj_code = a.subj_code
     		group by a.group_id,a.hos_id,a.copy_code,a.acc_year,a.subj_code, a.subj_dire, a.subj_type_code,a.subj_type_name,a.is_last
		), vouch_data as (
 			select c.group_id,c.hos_id,c.copy_code,c.acc_year,c.subj_code,b.acc_month,c.subj_type_code,c.subj_type_name,c.is_last,c.subj_dire,
 				sum(b.debit) debit, sum(b.credit) credit
      		from subj_temp c 
      		left join (
      			select s.group_id,s.hos_id,s.copy_code,s.acc_year,s.subj_code,s.subj_dire,s.subj_type_code,s.subj_type_name,v.acc_month, 
      				sum(c.debit) debit, sum(c.credit) credit
    			from acc_vouch v
   				inner join acc_vouch_detail c on c.group_id = v.group_id and c.hos_id = v.hos_id
     				and c.copy_code = v.copy_code and c.vouch_id = v.vouch_id
   				inner join subj_temp s on c.group_id = s.group_id and c.hos_id = s.hos_id and c.copy_code = s.copy_code
     				and c.subj_code = s.subj_code  and c.acc_year = s.acc_year
     				       <!--   and   c.acc_year between #{acc_year_b} and #{acc_year_e} -->
			    where to_char(v.vouch_date,'yyyy/MM')&gt;= #{begin_date}
		             and to_char(v.vouch_date,'yyyy/MM')&lt;= #{end_date}  
		               <if test="is_account == 1">
	                    AND v.state > 0
	                  </if>
	               <if test="is_account == 0">
	                    AND v.state = 99
	                  </if>
   				group by s.group_id,s.hos_id,s.copy_code,s.acc_year,s.subj_code,s.subj_dire,s.subj_type_code,s.subj_type_name,v.acc_month
   			)  b on b.subj_code =c.subj_code
      		group by c.group_id,c.hos_id,c.copy_code,c.acc_year,c.subj_code,b.acc_month,c.subj_type_code,c.subj_type_name,c.is_last,c.subj_dire
   		),
   		qc_vouch_data as (
 			select c.group_id,c.hos_id,c.copy_code,c.acc_year,c.subj_code,b.acc_month,c.subj_type_code,c.subj_type_name,c.is_last,c.subj_dire,
 				sum(b.debit) debit, sum(b.credit) credit
      		from subj_temp c 
      		left join (
      			select s.group_id,s.hos_id,s.copy_code,s.acc_year,s.subj_code,s.subj_dire,s.subj_type_code,s.subj_type_name,v.acc_month, 
      				sum(c.debit) debit, sum(c.credit) credit
    			from acc_vouch v
   				inner join acc_vouch_detail c on c.group_id = v.group_id and c.hos_id = v.hos_id
     				and c.copy_code = v.copy_code and c.vouch_id = v.vouch_id
   				inner join subj_temp s on c.group_id = s.group_id and c.hos_id = s.hos_id and c.copy_code = s.copy_code
     				and c.subj_code = s.subj_code  and c.acc_year = s.acc_year
     				       <!--   and   c.acc_year between #{acc_year_b} and #{acc_year_e} -->
			    where to_char(v.vouch_date,'yyyy/MM')&lt; #{begin_date}
		           
   				group by s.group_id,s.hos_id,s.copy_code,s.acc_year,s.subj_code,s.subj_dire,s.subj_type_code,s.subj_type_name,v.acc_month
   			)  b on b.subj_code =c.subj_code
      		group by c.group_id,c.hos_id,c.copy_code,c.acc_year,c.subj_code,b.acc_month,c.subj_type_code,c.subj_type_name,c.is_last,c.subj_dire
   		),
   		 q_vouch_data as (
 			select c.group_id,c.hos_id,c.copy_code,c.acc_year,c.subj_code, c.subj_dire,c.subj_type_code,c.subj_type_name,c.is_last,
 				sum(c.debit) debit, sum(c.credit) credit 
 			from qc_vouch_data c
   			<!-- where c.acc_month 
   			&lt;#{ acc_month_b,jdbcType=VARCHAR}  -->
   			
   			group by c.group_id,c.hos_id,c.copy_code,c.acc_year,c.subj_code, c.subj_dire,c.subj_type_name,c.subj_type_code,c.is_last
   		), b_vouch_data as (
 			select c.group_id,c.hos_id,c.copy_code,c.acc_year,c.subj_code,c.subj_type_code,c.subj_type_name,c.is_last,c.subj_dire, 
 				sum(c.debit) debit, sum(c.credit) credit
    		from vouch_data c
   			<!-- where c.acc_month  <if test="stateSql !='' ">
					${stateSql}
				</if>
				<if test="gltSql !='' ">
					${gltSql}
				</if>  -->
   			group by c.group_id,c.hos_id,c.copy_code,c.acc_year,c.subj_code,c.subj_type_code,c.subj_type_name,c.is_last,c.subj_dire
   		), result_1 as ( 
   			select a.group_id,a.hos_id,a.copy_code,a.acc_year,a.subj_code,a.subj_dire,a.subj_type_code,a.subj_type_name,a.is_last,
   				sum(a.nc_d) as nc_d, sum(a.nc_c) as nc_c, sum(a.qc_d) as qc_d, sum(a.qc_c) as qc_c,
       			sum(bq_d) as bq_d, sum(bq_c) as bq_c, sum(sum_od) as sum_od, sum(sum_oc) as sum_oc 
    		from (
      			select y.group_id,y.hos_id,y.copy_code,y.acc_year,y.subj_code,y.subj_type_code,y.subj_type_name,y.is_last,y.subj_dire,
      				y.end_os as nc_d, y.end_os as nc_c, 0 as qc_d,0 as qc_c, 0 as bq_d, 0 as bq_c, sum_od, sum_oc
      			from y_balance y
	      		union
	      		select q.group_id,q.hos_id,q.copy_code,q.acc_year,q.subj_code,q.subj_type_code，q.subj_type_name,q.is_last,q.subj_dire,  
	      			0 as nc_d, 0 as nc_c, q.debit - q.credit as qc_d,
	         		q.credit - q.debit as qc_c, 0 as bq_d, 0 as bq_c, q.debit as sum_od, q.credit as sum_oc
	      		from q_vouch_data q
	      		union
	      		select b.group_id,b.hos_id,b.copy_code,b.acc_year,b.subj_code, b.subj_type_code,b.subj_type_name,b.is_last,b.subj_dire, 
	      			0 as nc_d, 0 as nc_c, 0 as qc_d,
	        		0 as qc_c, b.debit as bq_d, b.credit as bq_c, b.debit as sum_od, b.credit as sum_oc
	      		from b_vouch_data b
    		) a
    		group by a.group_id,a.hos_id,a.copy_code,a.acc_year,a.subj_code,a.subj_dire,a.subj_type_code,a.subj_type_name,a.is_last
    	),result_2 as (
	 		select r1.group_id,r1.hos_id,r1.copy_code,r1.acc_year,r1.subj_code as obj_code, ck.subj_name as obj_name,ck.subj_name_all as obj_name_all, 
	 			case when r1.subj_dire = 0 then nc_d else 0 end as nc_d, 
	 			case when r1.subj_dire = 1 then nc_c else 0 end as nc_c, 
	 			case when r1.subj_dire = 0 then nc_d + qc_d else 0 end as qc_d,
      			case when r1.subj_dire = 1 then nc_c + qc_c else 0 end as qc_c, 
      			bq_d, bq_c, sum_od, sum_oc,
      			case when r1.subj_dire = 0 then nc_d + qc_d + bq_d - bq_c else 0 end as end_d, 
      			case when r1.subj_dire = 1 then nc_c + qc_c + bq_c - bq_d else 0 end as end_c, 
      			ck.is_check, r1.subj_type_code,r1.subj_type_name,r1.is_last,r1.subj_dire
    		from result_1 r1  
    		left join subj_temp ck  on r1.group_id = ck.group_id
	     		and r1.hos_id = ck.hos_id
	     		and r1.copy_code = ck.copy_code 
	     		and r1.acc_year = ck.acc_year 
	     		and r1.subj_code = ck.subj_code
   			order by ck.subj_code 
   		)
select r.subj_code, s.subj_name, r.preMonth_bal as tell_bal_os, r.debit as tell_debit, r.credit as tell_credit
  , r.curMonth_bal as  tell_end_os , nvl(aa.qc_d - aa.qc_c, 0) as acc_bal_os
  , nvl(aa.bq_d, 0) as acct_debit
  , nvl(aa.bq_c, 0) as acct_credit
  , (r.preMonth_bal + r.debit) - r.credit as  tell_end_os
  ,nvl(aa.qc_d - aa.qc_c, 0)+nvl(aa.bq_d, 0)-nvl(aa.bq_c, 0) acct_end_os
  ,(nvl(aa.qc_d - aa.qc_c, 0)+nvl(aa.bq_d, 0)-nvl(aa.bq_c, 0))- r.curMonth_bal   as end_os
from (
  select r2.obj_code as obj_code, to_char(r2.obj_name) as obj_name, to_char(r2.obj_name_all) as obj_name_all
    , nc_d as nc_d, nc_c as nc_c, qc_d as qc_d, qc_c as qc_c, bq_d as bq_d
    , bq_c as bq_c, sum_od as sum_od, sum_oc as sum_oc, end_d as end_d, end_c as end_c
    , r2.is_check
  from result_2 r2
    left join subj_temp c on r2.obj_code = c.subj_code 
) aa
left join resultData r on aa.obj_code = r.subj_code 
  left join subj s on r.subj_code = s.subj_code 
order by ord
	</select> 
</mapper>

