<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.acc.dao.InternetBank.AccBankNetBuyerMapper">
	<!-- 主表MAP -->   
	<resultMap id="accBankNetBuyer" type="java.util.Map">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="acc_year" column="acc_year" />
		<result property="vouch_no" column="vouch_no" />
		<result property="vouch_id" column="vouch_id" />
		<result property="vouch_state" column="vouch_state" />
		<result property="state_name" column="state_name" />
		<result property="pay_id" column="pay_id" />
		<result property="pay_bill_no" column="pay_bill_no" />
		<result property="fseqno" column="fseqno" />
		<result property="serialno" column="serialno" />
		<result property="retcode" column="retcode" />
		<result property="retmsg" column="retmsg" />
		<result property="trandate" column="trandate" />
		<result property="trantime" column="trantime" />
		<result property="onlbatf" column="onlbatf" />
		<result property="settlemode" column="settlemode" />
		<result property="totalnum" column="totalnum" />
		<result property="totalamt" column="totalamt" />
		<result property="reqreserved1" column="reqreserved1" />
		<result property="reqreserved2" column="reqreserved2" />

		<result property="iseqno" column="iseqno" />
		<result property="orderno" column="orderno" />
		<result property="reimburseno" column="reimburseno" />
		<result property="reimbursenum" column="reimbursenum" />
		<result property="startdate" column="startdate" />
		<result property="starttime" column="starttime" />
		<result property="paytype" column="paytype" />
		<result property="payaccno" column="payaccno" />
		<result property="payaccnamecn" column="payaccnamecn" />
		<result property="payaccnameen" column="payaccnameen" />
		<result property="recaccno" column="recaccno" />
		<result property="recaccnamecn" column="recaccnamecn" />
		<result property="recaccnameen" column="recaccnameen" />
		<result property="sysioflg" column="sysioflg" />
		<result property="issamecity" column="issamecity" />
		<result property="prop" column="prop" />
		<result property="recicbccode" column="recicbccode" />
		<result property="reccityname" column="reccityname" />
		<result property="recbankno" column="recbankno" />
		<result property="recbankname" column="recbankname" />
		<result property="currtype" column="currtype" />
		<result property="payamt" column="payamt" />
		<result property="usecode" column="usecode" />
		<result property="usecn" column="usecn" />
		<result property="ensummary" column="ensummary" />
		<result property="postscript" column="postscript" />
		<result property="summary" column="summary" />
		<result property="ref" column="ref" />
		<result property="oref" column="oref" />
		<result property="erpsqn" column="erpsqn" />
		<result property="buscode" column="buscode" />
		<result property="erpcheckno" column="erpcheckno" />
		<result property="crvouhtype" column="crvouhtype" />
		<result property="crvouhname" column="crvouhname" />
		<result property="crvouhno" column="crvouhno" />
		<result property="result" column="result" />
		<result property="iretcode" column="iretcode" />
		<result property="iretmsg" column="iretmsg" />
		<result property="represerved3" column="represerved3" />
		<result property="represerved4" column="represerved4" />
		
		<result property="pay_bill_no" column="pay_bill_no" />
		<result property="pay_date" column="pay_date" />
		<result property="sup_code" column="sup_code" />
		<result property="sup_name" column="sup_name" />
		<result property="sup_id" column="sup_id" />
	</resultMap>

	<!-- 明细MAP -->
	<resultMap id="accBankNetBuyerRd" type="java.util.Map">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="acc_year" column="acc_year" />
		<result property="fseqno" column="fseqno" />
		<result property="iseqno" column="iseqno" />
		<result property="orderno" column="orderno" />
		<result property="reimburseno" column="reimburseno" />
		<result property="reimbursenum" column="reimbursenum" />
		<result property="startdate" column="startdate" />
		<result property="starttime" column="starttime" />
		<result property="paytype" column="paytype" />
		<result property="payaccno" column="payaccno" />
		<result property="payaccnamecn" column="payaccnamecn" />
		<result property="payaccnameen" column="payaccnameen" />
		<result property="recaccno" column="recaccno" />
		<result property="recaccnamecn" column="recaccnamecn" />
		<result property="recaccnameen" column="recaccnameen" />
		<result property="sysioflg" column="sysioflg" />
		<result property="issamecity" column="issamecity" />
		<result property="prop" column="prop" />
		<result property="recicbccode" column="recicbccode" />
		<result property="reccityname" column="reccityname" />
		<result property="recbankno" column="recbankno" />
		<result property="recbankname" column="recbankname" />
		<result property="currtype" column="currtype" />
		<result property="payamt" column="payamt" />
		<result property="usecode" column="usecode" />
		<result property="usecn" column="usecn" />
		<result property="ensummary" column="ensummary" />
		<result property="postscript" column="postscript" />
		<result property="summary" column="summary" />
		<result property="ref" column="ref" />
		<result property="oref" column="oref" />
		<result property="erpsqn" column="erpsqn" />
		<result property="buscode" column="buscode" />
		<result property="erpcheckno" column="erpcheckno" />
		<result property="crvouhtype" column="crvouhtype" />
		<result property="crvouhname" column="crvouhname" />
		<result property="crvouhno" column="crvouhno" />
		<result property="result" column="result" />
		<result property="iretcode" column="iretcode" />
		<result property="iretmsg" column="iretmsg" />
		<result property="represerved3" column="represerved3" />
		<result property="represerved4" column="represerved4" />
		
		<result property="pay_bill_no" column="pay_bill_no" />
		<result property="pay_date" column="pay_date" />
		<result property="sup_code" column="sup_code" />
		<result property="sup_name" column="sup_name" />
		<result property="res_state" column="res_state" />
	</resultMap>
	
	<!-- 材料付款MAP -->
	<resultMap id="matPayMain" type="java.util.Map">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="pay_id" column="pay_id" />
		<result property="vouch_no" column="vouch_no" />
		<result property="vouch_id" column="vouch_id" />
		<result property="vouch_state" column="vouch_state" />
		<result property="pay_bill_no" column="pay_bill_no" />
		<result property="pay_date" column="pay_date" />
		<result property="pay_bill_type" column="pay_bill_type" />
		<result property="sup_id" column="sup_id" />
		<result property="sup_no" column="sup_no" />
		<result property="sup_code" column="sup_code" />
		<result property="sup_name" column="sup_name" />
		<result property="pay_code" column="pay_code" />
		<result property="pay_type_code" column="pay_type_code" />
		<result property="acct_code" column="acct_code" />
		<result property="cheq_no" column="cheq_no" />
		<result property="payable_money" column="payable_money" />
		<result property="payed_money" column="payed_money" />
		<result property="pay_money" column="pay_money" />
		<result property="maker" column="maker" />
		<result property="maker_name" column="maker_name" />
		<result property="make_date" column="make_date" />
		<result property="checker" column="checker" />
		<result property="checker_name" column="checker_name" />
		<result property="chk_date" column="chk_date" />
		<result property="state" column="state" />
		<result property="is_init" column="is_init" />
		<result property="note" column="note" />
		<result property="result_state" column="result_state" />
	</resultMap>

	<select id="queryMatPayMain" parameterType="java.util.Map" resultMap="matPayMain">

   
   select t1.*, acc_vouch_type.vouch_type_short || '-' || acc_vouch.vouch_no as VOUCH_NO, acc_vouch.vouch_id,acc_vouch.state as vouch_state
		from (
select * from (with tmp1 as
 (
  
  select abnb.group_id,
          abnb.hos_id,
          abnb.copy_code,
          max(abnb.acc_year) as acc_year,
          max(abnb.fseqno) as fseqno,
          max(abnbr.iseqno) as iseqno,
          abnbr.erpsqn
    from acc_bank_net_buyer abnb
    left join acc_bank_net_buyer_rd abnbr
      on abnb.fseqno = abnbr.fseqno
     and abnbr.group_id = #{group_id}
     and abnbr.hos_id = #{hos_id}
     and abnbr.copy_code = #{copy_code} 

		<where>

			abnb.group_id= #{group_id} and abnb.hos_id= #{hos_id} and abnb.copy_code= #{copy_code} 

			<if test="beginDate != null and beginDate != '' and endDate !=null and endDate !=''">
				AND abnb.trandate between
				to_date(#{beginDate,jdbcType=DATE},'yyyy-MM-dd') and
				to_date(#{endDate,jdbcType=DATE},'yyyy-MM-dd')
			</if>
			
			<if test="fseqno != null and fseqno != ''">
				and abnb.fseqno = #{fseqno}
			</if>
			<if test="sup_id != null and sup_id != ''">
				and abnbr.crvouhno = #{sup_id}
			</if>
			
			
		</where>
		group by abnb.group_id, abnb.hos_id, abnb.copy_code, abnbr.erpsqn
		
		 )
			select null as group_id, null as hos_id, null as copy_code, null as pay_id, '合计' as pay_bill_no
      , null as pay_date, null as pay_bill_type, null as sup_id,null as sup_no, null as sup_code
      , null as sup_name, null as pay_code,null as pay_type_code, null as acct_code, null as cheq_no
      , sum(mpm.payable_money) as payable_money, sum(mpm.payed_money) as payed_money, sum(mpm.pay_money) as pay_money, null as maker, null as maker_name
      , null as make_date, null as checker, null as checker_name, null as chk_date, null as state,null as state_name
      , null as is_init, null as note,null result_state
    from MAT_PAY_MAIN mpm
	left join tmp1 tmp1 on tmp1.erpsqn = mpm.pay_id
			and mpm.group_id = tmp1.group_id
			and mpm.hos_id = tmp1.hos_id
			and mpm.copy_code = tmp1.copy_code 
			left join acc_bank_net_buyer abnb
            on tmp1.fseqno = abnb.fseqno
           and abnb.group_id = #{group_id}
           and abnb.hos_id = #{hos_id}
           and abnb.copy_code = #{copy_code}
          left join acc_bank_net_buyer_rd abnbr
            on tmp1.fseqno = abnbr.fseqno
           and tmp1.iseqno = abnbr.iseqno
           and tmp1.erpsqn = abnbr.erpsqn
           and abnb.group_id = #{group_id}
           and abnb.hos_id = #{hos_id}
           and abnb.copy_code = #{copy_code}
    <where>         mpm.pay_bill_type = '0' and mpm.state = '2'            
		<if test="group_id != null and group_id != ''">
		AND mpm.group_id = #{group_id,jdbcType=INTEGER}
		</if>
		<if test="hos_id != null and hos_id != ''">
		AND mpm.hos_id = #{hos_id,jdbcType=INTEGER}
		</if>
		<if test="copy_code != null and copy_code != ''">
		AND mpm.copy_code = #{copy_code,jdbcType=VARCHAR}
		</if>
		<if test="pay_id != null and pay_id != ''">
		AND mpm.pay_id = #{pay_id,jdbcType=INTEGER}
		</if>
		<if test="pay_bill_no != null and pay_bill_no != ''">
		AND mpm.pay_bill_no like '${pay_bill_no}%'
		</if>
		<if test="beginDate != null and beginDate != '' and endDate !=null and endDate !=''">
		AND mpm.pay_date between to_date(#{beginDate,jdbcType=DATE},'yyyy-MM-dd') and to_date(#{endDate,jdbcType=DATE},'yyyy-MM-dd')
		</if>
		<if test="makeBeginDate != null and makeBeginDate != '' and makeEndDate !=null and makeEndDate !=''">
		AND mpm.make_date between to_date(#{makeBeginDate,jdbcType=DATE},'yyyy-MM-dd') and to_date(#{makeEndDate,jdbcType=DATE},'yyyy-MM-dd')
		</if>
		<if test="pay_bill_type != null and pay_bill_type != ''">
		AND mpm.pay_bill_type = #{pay_bill_type,jdbcType=VARCHAR}
		</if>
		<if test="sup_id != null and sup_id != ''">
		AND mpm.sup_id = #{sup_id,jdbcType=INTEGER}
		</if>
		<if test="sup_no != null and sup_no != ''">
		AND mpm.sup_no = #{sup_no,jdbcType=INTEGER}
		</if>
		<if test="pay_code != null and pay_code != ''">
		AND mpm.pay_code = #{pay_code,jdbcType=VARCHAR}
		</if>
		<if test="pay_type_code != null and pay_type_code != ''">
		AND mpm.pay_type_code = #{pay_type_code,jdbcType=VARCHAR}
		</if>
		<if test="acct_code != null and acct_code != ''">
		AND mpm.acct_code = #{acct_code,jdbcType=VARCHAR}
		</if>
		<if test="cheq_no != null and cheq_no != ''">
		AND mpm.cheq_no = #{cheq_no,jdbcType=VARCHAR}
		</if>
		<if test="payable_money != null and payable_money != '' ">
		AND mpm.payable_money = #{payable_money,jdbcType=INTEGER} 
		</if>
		<if test="payed_money != null and payed_money != '' ">
		AND mpm.payed_money = #{payed_money,jdbcType=INTEGER} 
		</if>
		<if test="pay_money != null and pay_money != '' ">
		AND mpm.pay_money = #{pay_money,jdbcType=INTEGER} 
		</if>
		<if test="maker != null and maker != ''">
		AND mpm.maker = #{maker,jdbcType=INTEGER}
		</if>
		
		<if test="checker != null and checker != ''">
		AND mpm.checker = #{checker,jdbcType=INTEGER}
		</if>
		<if test="chk_date != null and chk_date != ''">
		AND mpm.chk_date = #{chk_date,jdbcType=DATE}
		</if>
		<if test="state != null and state != ''">
		AND mpm.state = #{state,jdbcType=INTEGER}
		</if>
		<if test="is_init != null and is_init != ''">
		AND mpm.is_init = #{is_init,jdbcType=INTEGER}
		</if>
		<if test="note != null and note != ''">
		AND mpm.note = #{note,jdbcType=VARCHAR}
		</if>
		<if test="result_state != null and result_state != '' and result_state==3">
				and (abnbr.result is null or abnbr.result in (5,6,8,95,96))
		</if>
		<if test="result_state != null and result_state != '' and result_state==2">
				and abnbr.result in (7,11)
		</if>
		<if test="result_state != null and result_state != '' and result_state==4">
				and abnbr.result in (0,1,2,3,4,9,10,86)
		</if>
		</where>)   
union 
select * from (with tmp1 as
 (
  
  select abnb.group_id,
          abnb.hos_id,
          abnb.copy_code,
          max(abnb.acc_year) as acc_year,
          max(abnb.fseqno) as fseqno,
          max(abnbr.iseqno) as iseqno,
          abnbr.erpsqn
    from acc_bank_net_buyer abnb
    left join acc_bank_net_buyer_rd abnbr
      on abnb.fseqno = abnbr.fseqno
     and abnbr.group_id = #{group_id}
     and abnbr.hos_id = #{hos_id}
     and abnbr.copy_code = #{copy_code} 

		<where>

			abnb.group_id= #{group_id} and abnb.hos_id= #{hos_id} and abnb.copy_code= #{copy_code} 

			<if test="beginDate != null and beginDate != '' and endDate !=null and endDate !=''">
				AND abnb.trandate between
				to_date(#{beginDate,jdbcType=DATE},'yyyy-MM-dd') and
				to_date(#{endDate,jdbcType=DATE},'yyyy-MM-dd')
			</if>
			
			<if test="fseqno != null and fseqno != ''">
				and abnb.fseqno = #{fseqno}
			</if>
			<if test="sup_id != null and sup_id != ''">
				and abnbr.crvouhno = #{sup_id}
			</if>
			
			
		</where>
		group by abnb.group_id, abnb.hos_id, abnb.copy_code, abnbr.erpsqn
		
		 )
			select mpm.group_id, mpm.hos_id, mpm.copy_code, mpm.pay_id, to_char(mpm.pay_bill_no) as pay_bill_no
			, mpm.pay_date, mpm.pay_bill_type, mpm.sup_id, mpm.sup_no, hsd.sup_code
			, hsd.sup_name, mpm.pay_code, mpm.pay_type_code, mpm.acct_code, mpm.cheq_no
			, (mpm.payable_money) as payable_money , (mpm.payed_money) as payed_money, (mpm.pay_money) as pay_money, mpm.maker, su.user_name as maker_name
			, mpm.make_date, mpm.checker, sysu.user_name as checker_name, mpm.chk_date, mpm.state,
			case when mpm.state = 1 then '未审核'
				when mpm.state = 2 then '已审核'
				when mpm.state = '' then ''
			else '记账' end state_name,
			mpm.is_init, mpm.note, case 
					when abnbr.result = 0
					or abnbr.result = 1
					or abnbr.result = 2
					or abnbr.result = 3
					or abnbr.result = 4
					or abnbr.result = 9
					or abnbr.result = 10
					or abnbr.result = 86 then '正在处理'
					when abnbr.result = 5
					or abnbr.result = 6
					or abnbr.result = 8
					or abnbr.result = 95
					or abnbr.result = 96 then '支付失败'
					when abnbr.result = 7
					or abnbr.result = 11 then '支付成功'
					else '未支付'
				end as result_state
		from MAT_PAY_MAIN mpm
		left join tmp1 tmp1 on tmp1.erpsqn = mpm.pay_id
			and mpm.group_id = tmp1.group_id
			and mpm.hos_id = tmp1.hos_id
			and mpm.copy_code = tmp1.copy_code 
			left join acc_bank_net_buyer abnb
            on tmp1.fseqno = abnb.fseqno
           and abnb.group_id = #{group_id}
           and abnb.hos_id = #{hos_id}
           and abnb.copy_code = #{copy_code}
          left join acc_bank_net_buyer_rd abnbr
            on tmp1.fseqno = abnbr.fseqno
           and tmp1.iseqno = abnbr.iseqno
           and tmp1.erpsqn = abnbr.erpsqn
           and abnb.group_id = #{group_id}
           and abnb.hos_id = #{hos_id}
           and abnb.copy_code = #{copy_code}
		 left join Mat_Pay_Detail mpd on mpm.group_id = mpd.group_id
			and mpm.hos_id = mpd.hos_id
			and mpm.copy_code = mpd.copy_code
			and mpm.pay_id = mpd.pay_id 
      and mpm.pay_bill_no=mpd.pay_bill_no
      
      	left join MAT_BILL_DETAIL mbd on mpd.group_id = mbd.group_id
			and mpd.hos_id = mpd.hos_id
			and mpd.copy_code = mbd.copy_code
			and mpd.bill_id = mbd.bill_id 
     		 and mpd.bill_detail_id=mbd.bill_detail_id
      
			left join MAT_IN_MAIN mim on mbd.group_id = mim.group_id
			and mbd.hos_id = mim.hos_id
			and mbd.copy_code = mim.copy_code
			and mbd.in_id = mim.in_id 
      
			left join hos_store_dict hs on mim.group_id = hs.group_id
			and mim.hos_id = hs.hos_id
			and mim.store_id = hs.store_id
			and mim.store_no = hs.store_no 
      
    left join mat_store_detail msd on hs.group_id = msd.group_id
		      and hs.hos_id = msd.hos_id
		      and hs.store_id = msd.store_id
      
		left join hos_sup_dict hsd on mpm.group_id = hsd.group_id
		and mpm.hos_id = hsd.hos_id
		and mpm.sup_id = hsd.sup_id
		and mpm.sup_no = hsd.sup_no
		<!-- and hsd.is_stop = 0  -->
		left join sys_user su on mpm.group_id = su.group_id
		and mpm.hos_id = su.hos_id
		and mpm.maker = su.user_id 
			left join sys_user sysu on mpm.group_id = sysu.group_id
		and mpm.hos_id = sysu.hos_id
		and mpm.checker = sysu.user_id 
		<where>   mpm.pay_bill_type = '0' and mpm.state = '2'                   
		<if test="group_id != null and group_id != ''">
		AND mpm.group_id = #{group_id,jdbcType=INTEGER}
		</if>
		<if test="hos_id != null and hos_id != ''">
		AND mpm.hos_id = #{hos_id,jdbcType=INTEGER}
		</if>
		<if test="copy_code != null and copy_code != ''">
		AND mpm.copy_code = #{copy_code,jdbcType=VARCHAR}
		</if>
		  <if test="store_id != null and store_id != '' ">
			 and hs.store_id = #{store_id}
		 </if>
		  <if test="set_id != null and set_id != '' ">
			 and msd.set_id = #{set_id}
			 </if>
		<if test="pay_id != null and pay_id != ''">
		AND mpm.pay_id = #{pay_id,jdbcType=INTEGER}
		</if>
		<if test="pay_bill_no != null and pay_bill_no != ''">
		AND mpm.pay_bill_no like '${pay_bill_no}%'
		</if>
		<if test="beginDate != null and beginDate != '' and endDate !=null and endDate !=''">
		AND mpm.pay_date between to_date(#{beginDate,jdbcType=DATE},'yyyy-MM-dd') and to_date(#{endDate,jdbcType=DATE},'yyyy-MM-dd')
		</if>
		<if test="makeBeginDate != null and makeBeginDate != '' and makeEndDate !=null and makeEndDate !=''">
		AND mpm.make_date between to_date(#{makeBeginDate,jdbcType=DATE},'yyyy-MM-dd') and to_date(#{makeEndDate,jdbcType=DATE},'yyyy-MM-dd')
		</if>
		<if test="pay_bill_type != null and pay_bill_type != ''">
		AND mpm.pay_bill_type = #{pay_bill_type,jdbcType=VARCHAR}
		</if>
		<if test="sup_id != null and sup_id != ''">
		AND mpm.sup_id = #{sup_id,jdbcType=INTEGER}
		</if>
		<if test="sup_no != null and sup_no != ''">
		AND mpm.sup_no = #{sup_no,jdbcType=INTEGER}
		</if>
		<if test="pay_code != null and pay_code != ''">
		AND mpm.pay_code = #{pay_code,jdbcType=VARCHAR}
		</if>
		<if test="pay_type_code != null and pay_type_code != ''">
		AND mpm.pay_type_code = #{pay_type_code,jdbcType=VARCHAR}
		</if>
		<if test="acct_code != null and acct_code != ''">
		AND mpm.acct_code = #{acct_code,jdbcType=VARCHAR}
		</if>
		<if test="cheq_no != null and cheq_no != ''">
		AND mpm.cheq_no = #{cheq_no,jdbcType=VARCHAR}
		</if>
		<if test="payable_money != null and payable_money != '' ">
		AND mpm.payable_money = #{payable_money,jdbcType=INTEGER} 
		</if>
		<if test="payed_money != null and payed_money != '' ">
		AND mpm.payed_money = #{payed_money,jdbcType=INTEGER} 
		</if>
		<if test="pay_money != null and pay_money != '' ">
		AND mpm.pay_money = #{pay_money,jdbcType=INTEGER} 
		</if>
		<if test="maker != null and maker != ''">
		AND mpm.maker = #{maker,jdbcType=INTEGER}
		</if>
		
		<if test="checker != null and checker != ''">
		AND mpm.checker = #{checker,jdbcType=INTEGER}
		</if>
		<if test="chk_date != null and chk_date != ''">
		AND mpm.chk_date = #{chk_date,jdbcType=DATE}
		</if>
		<if test="state != null and state != ''">
		AND mpm.state = #{state,jdbcType=INTEGER}
		</if>
		<if test="is_init != null and is_init != ''">
		AND mpm.is_init = #{is_init,jdbcType=INTEGER}
		</if>
		<if test="note != null and note != ''">
		AND mpm.note = #{note,jdbcType=VARCHAR}
		</if>
		<if test="result_state != null and result_state != '' and result_state==3">
				and (abnbr.result is null or abnbr.result in (5,6,8,95,96))
		</if>
		<if test="result_state != null and result_state != '' and result_state==2">
				and abnbr.result in (7,11)
		</if>
		<if test="result_state != null and result_state != '' and result_state==4">
				and abnbr.result in (0,1,2,3,4,9,10,86)
		</if>
		</where> 
			)
		) t1
		left join ACC_BUSI_LOG_0408 on ACC_BUSI_LOG_0408.group_id = #{group_id,jdbcType=INTEGER}
		and ACC_BUSI_LOG_0408.hos_id = #{hos_id,jdbcType=INTEGER}
		and ACC_BUSI_LOG_0408.copy_code = #{copy_code,jdbcType=VARCHAR}
		and t1.pay_id = ACC_BUSI_LOG_0408.BUSINESS_NO 
		left join acc_vouch on acc_vouch.group_id = ACC_BUSI_LOG_0408.group_id
		and acc_vouch.hos_id = ACC_BUSI_LOG_0408.hos_id
		and acc_vouch.copy_code = ACC_BUSI_LOG_0408.copy_code
		and acc_vouch.vouch_id = ACC_BUSI_LOG_0408.vouch_id 
			left join acc_vouch_type on acc_vouch_type.group_id = acc_vouch.group_id
		and acc_vouch_type.hos_id = acc_vouch.hos_id
		and acc_vouch_type.copy_code = acc_vouch.copy_code
		and acc_vouch_type.vouch_type_code = acc_vouch.vouch_type_code 
	
		order by t1.pay_bill_no desc, t1.pay_date desc, t1.make_date desc 
		
	</select>

	<insert id="addBatchAccBankNetBuyer" parameterType="java.util.List">

		insert into acc_bank_net_buyer
		(group_id, hos_id, copy_code, acc_year,
		fseqno, serialno, retcode, retmsg,
		trandate, trantime, onlbatf,
		settlemode, totalnum, totalamt,
		reqreserved1, reqreserved2)
		<foreach collection="list" item="item" index="index"
			separator=" union all ">
			select
			#{item.group_id,jdbcType=INTEGER},
			#{item.hos_id,jdbcType=INTEGER},
			#{item.copy_code,jdbcType=VARCHAR},
			#{item.acc_year,jdbcType=VARCHAR},
			#{item.fseqno,jdbcType=VARCHAR},
			#{item.serialno,jdbcType=VARCHAR},
			#{item.retcode,jdbcType=VARCHAR},
			#{item.retmsg,jdbcType=VARCHAR},
			#{item.trandate,jdbcType=DATE},
			#{item.trantime,jdbcType=TIMESTAMP},
			#{item.onlbatf,jdbcType=INTEGER},
			#{item.settlemode,jdbcType=INTEGER},
			#{item.totalnum,jdbcType=INTEGER},
			#{item.totalamt,jdbcType=INTEGER},
			#{item.reqreserved1,jdbcType=VARCHAR},
			#{item.reqreserved2,jdbcType=VARCHAR}
			from dual
		</foreach>
	</insert>

	<insert id="addBatchAccBankNetBuyerRd" parameterType="java.util.List">

		insert into acc_bank_net_buyer_rd
		(group_id, hos_id, copy_code,
		acc_year, fseqno, iseqno, orderno, reimburseno,
		reimbursenum,
		startdate, starttime, paytype, payaccno,
		payaccnamecn, payaccnameen,
		recaccno, recaccnamecn, recaccnameen, sysioflg,
		issamecity,prop,
		recicbccode, reccityname, recbankno, recbankname,
		currtype, payamt,
		usecode, usecn, ensummary, postscript, summary, ref,
		oref, erpsqn,
		buscode, erpcheckno, crvouhtype, crvouhname, crvouhno,
		result,
		iretcode, iretmsg, represerved3, represerved4)
		<foreach collection="list" item="item" index="index"
			separator=" union all ">
			select
			#{item.group_id,jdbcType=INTEGER},
			#{item.hos_id,jdbcType=INTEGER},
			#{item.copy_code,jdbcType=VARCHAR},
			#{item.acc_year,jdbcType=VARCHAR},
			#{item.fseqno,jdbcType=VARCHAR},
			#{item.iseqno,jdbcType=VARCHAR},
			#{item.orderno,jdbcType=VARCHAR},
			#{item.reimburseno,jdbcType=VARCHAR},
			#{item.reimbursenum,jdbcType=VARCHAR},
			#{item.startdate,jdbcType=VARCHAR},
			#{item.starttime,jdbcType=VARCHAR},
			#{item.paytype,jdbcType=INTEGER},
			#{item.payaccno,jdbcType=INTEGER},
			#{item.payaccnamecn,jdbcType=VARCHAR},
			#{item.payaccnameen,jdbcType=VARCHAR},
			#{item.recaccno,jdbcType=VARCHAR},
			#{item.recaccnamecn,jdbcType=VARCHAR},
			#{item.recaccnameen,jdbcType=VARCHAR},
			#{item.sysioflg,jdbcType=INTEGER},
			#{item.issamecity,jdbcType=INTEGER},
			#{item.prop,jdbcType=INTEGER},
			#{item.recicbccode,jdbcType=INTEGER},
			#{item.reccityname,jdbcType=VARCHAR},
			#{item.recbankno,jdbcType=VARCHAR},
			#{item.recbankname,jdbcType=VARCHAR},
			#{item.currtype,jdbcType=VARCHAR},
			#{item.payamt,jdbcType=INTEGER},
			#{item.usecode,jdbcType=VARCHAR},
			#{item.usecn,jdbcType=VARCHAR},
			#{item.ensummary,jdbcType=VARCHAR},
			#{item.postscript,jdbcType=VARCHAR},
			#{item.summary,jdbcType=VARCHAR},
			#{item.ref,jdbcType=VARCHAR},
			#{item.oref,jdbcType=VARCHAR},
			#{item.erpsqn,jdbcType=VARCHAR},
			#{item.buscode,jdbcType=VARCHAR},
			#{item.erpcheckno,jdbcType=VARCHAR},
			#{item.crvouhtype,jdbcType=VARCHAR},
			#{item.crvouhname,jdbcType=VARCHAR},
			#{item.crvouhno,jdbcType=VARCHAR},
			#{item.result,jdbcType=VARCHAR},
			#{item.iretcode,jdbcType=VARCHAR},
			#{item.iretmsg,jdbcType=VARCHAR},
			#{item.represerved3,jdbcType=VARCHAR},
			#{item.represerved4,jdbcType=VARCHAR}
			from dual
		</foreach>
	</insert>
	
	<update id="updateAccBankNetBuyer">
		update acc_bank_net_buyer
		   set 
		       retcode = #{retcode,jdbcType=VARCHAR},
		       retmsg = #{retmsg,jdbcType=VARCHAR}
		       <if test="serialno != null and serialno != ''">
				, serialno = #{serialno,jdbcType=VARCHAR}
			   </if>
		 where group_id = #{group_id,jdbcType=INTEGER}
		   and hos_id = #{hos_id,jdbcType=INTEGER}
		   and copy_code = #{copy_code,jdbcType=VARCHAR}
		   and acc_year = #{acc_year,jdbcType=VARCHAR}
		   and fseqno = #{fseqno,jdbcType=VARCHAR}
	</update>
	<update id="updateBatchAccBankNetBuyerRd" parameterType="java.util.List">

		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			UPDATE acc_bank_net_Buyer_rd
			<trim prefix="SET" suffixOverrides=",">
				<if test="item.orderno != null ">
					orderno = #{item.orderno,jdbcType=VARCHAR},
				</if>
				<if test="item.iretcode != null ">
					iretcode = #{item.iretcode,jdbcType=VARCHAR},
				</if>
				<if test="item.iretmsg != null ">
					iretmsg = #{item.iretmsg,jdbcType=VARCHAR},
				</if>
				<if test="item.result != null ">
					result = #{item.result,jdbcType=VARCHAR},
				</if>
			</trim>
			<where>
			group_id = #{item.group_id,jdbcType=INTEGER}
			AND hos_id = #{item.hos_id,jdbcType=INTEGER}
			AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
			<if test="item.acc_year != null and item.acc_year != ''">
				and acc_year = #{item.acc_year,jdbcType=VARCHAR}
			</if>
			<if test="item.fseqno != null and item.fseqno != ''">
				and fseqno = #{item.fseqno,jdbcType=VARCHAR}
			</if>
			
			<if test="item.ref != null and item.ref != ''">
				and ref = #{item.ref,jdbcType=VARCHAR}
			</if>
			<if test="item.oref != null and item.oref != ''">
				and oref = #{item.oref,jdbcType=VARCHAR}
			</if>
			<if test="item.erpsqn != null and item.erpsqn != ''">
				and erpsqn = #{item.erpsqn,jdbcType=VARCHAR}
			</if>
			<if test="item.buscode != null and item.buscode != ''">
				and buscode = #{item.buscode,jdbcType=VARCHAR}
			</if>	
			</where>
		</foreach>
	</update>

	<select id="queryAccBankNetBuyer" parameterType="java.util.Map" resultMap="accBankNetBuyer">

with tmp1 as
 (
  
  select abnb.group_id,
          abnb.hos_id,
          abnb.copy_code,
          max(abnb.acc_year) as acc_year,
          max(abnb.fseqno) as fseqno,
          max(abnbr.iseqno) as iseqno,
          abnbr.erpsqn
    from acc_bank_net_buyer abnb
    left join acc_bank_net_buyer_rd abnbr
      on abnb.fseqno = abnbr.fseqno
     and abnbr.group_id = #{group_id}
     and abnbr.hos_id = #{hos_id}
     and abnbr.copy_code = #{copy_code} 

		<where>

			abnb.group_id= #{group_id} and abnb.hos_id= #{hos_id} and abnb.copy_code= #{copy_code} 

			<if test="beginDate != null and beginDate != '' and endDate !=null and endDate !=''">
				AND abnb.trandate between
				to_date(#{beginDate,jdbcType=DATE},'yyyy-MM-dd') and
				to_date(#{endDate,jdbcType=DATE},'yyyy-MM-dd')
			</if>
			
			<if test="fseqno != null and fseqno != ''">
				and abnb.fseqno = #{fseqno}
			</if>
			<if test="sup_id != null and sup_id != ''">
				and abnbr.crvouhno = #{sup_id}
			</if>
			
			
		</where>
		group by abnb.group_id, abnb.hos_id, abnb.copy_code, abnbr.erpsqn
		
		 )

select t1.*,
       acc_vouch_type.vouch_type_short || '-' || acc_vouch.vouch_no as VOUCH_NO,
       acc_vouch.vouch_id,
       acc_vouch.state as vouch_state,avs.state_name
  from (select tmp1.group_id,
               tmp1.hos_id,
               tmp1.copy_code,
               tmp1.fseqno,
               tmp1.iseqno,
               tmp1.erpsqn,
               tmp1.acc_year,
               abnb.serialno,
               abnb.retcode,
               abnb.retmsg,
               to_char(abnb.trandate, 'yyyy-mm-dd') as trandate,
               to_char(abnb.trantime, 'hh24:mi:ss') as trantime,
               abnb.onlbatf,
               abnb.settlemode,
               abnb.totalnum,
               abnb.totalamt / 100 as totalamt,
               abnbr.result,
               abnbr.iretcode,
               abnbr.iretmsg,
               mpm.BUSINESS_ID as pay_id,
               mpm.BUSINESS_NO as pay_bill_no,
               mpm.BUSI_DATE as pay_date,
               hsd.sup_code,
               hsd.sup_name,
               hsd.sup_id,
               abnbr.payamt
          from tmp1 tmp1
          left join acc_bank_net_buyer abnb
            on tmp1.fseqno = abnb.fseqno
           and abnb.group_id = #{group_id}
           and abnb.hos_id = #{hos_id}
           and abnb.copy_code = #{copy_code}
          left join acc_bank_net_buyer_rd abnbr
            on tmp1.fseqno = abnbr.fseqno
           and tmp1.iseqno = abnbr.iseqno
           and tmp1.erpsqn = abnbr.erpsqn
           and abnb.group_id = #{group_id}
           and abnb.hos_id = #{hos_id}
           and abnb.copy_code = #{copy_code}
          left join V_MAT_PAY_MAIN mpm
            on tmp1.erpsqn = mpm.BUSINESS_ID
           and mpm.group_id = #{group_id}
           and mpm.hos_id = #{hos_id}
           and mpm.copy_code = #{copy_code}
          left join hos_sup_dict hsd
            on mpm.sup_id = hsd.sup_id
           and mpm.sup_no = hsd.sup_no
           --and hsd.is_stop = 0
           and hsd.group_id = #{group_id}
           and hsd.hos_id = #{hos_id}
           <where>
			<if test="result != null and result != ''">
				and abnbr.result in ('5','6','8','95','96')
			</if>
			<if test="pay_bill_no != null and pay_bill_no != ''">
				and mpm.BUSINESS_NO = #{pay_bill_no}
			</if>
		</where>
         order by abnb.trandate desc) t1
  left join ACC_BUSI_LOG_0408
    on ACC_BUSI_LOG_0408.group_id = #{group_id}
   and ACC_BUSI_LOG_0408.hos_id = #{hos_id}
   and ACC_BUSI_LOG_0408.copy_code = #{copy_code}
   and t1.pay_id = ACC_BUSI_LOG_0408.BUSINESS_NO
  left join acc_vouch
    on acc_vouch.group_id = ACC_BUSI_LOG_0408.group_id
   and acc_vouch.hos_id = ACC_BUSI_LOG_0408.hos_id
   and acc_vouch.copy_code = ACC_BUSI_LOG_0408.copy_code
   and acc_vouch.vouch_id = ACC_BUSI_LOG_0408.vouch_id
  left join acc_vouch_type
    on acc_vouch_type.group_id = acc_vouch.group_id
   and acc_vouch_type.hos_id = acc_vouch.hos_id
   and acc_vouch_type.copy_code = acc_vouch.copy_code
   and acc_vouch_type.vouch_type_code = acc_vouch.vouch_type_code
	left join ACC_VOUCH_STATE avs on acc_vouch.state = avs.state
    and avs.group_id = #{group_id}
    and avs.hos_id = #{hos_id}
    and avs.copy_code= #{copy_code}
 order by t1.trandate desc, t1.trantime desc

	</select>

	<select id="queryAccBankNetBuyerRd" parameterType="java.util.Map" resultMap="accBankNetBuyerRd">

		select abnbr.group_id,
       abnbr.hos_id,
       abnbr.copy_code,
       abnbr.acc_year,
       abnbr.fseqno,
       abnbr.iseqno,
       abnbr.orderno,
       abnbr.reimburseno,
       abnbr.reimbursenum,
       abnbr.startdate,
       abnbr.starttime,
       abnbr.paytype,
       abnbr.payaccno,
       abnbr.payaccnamecn,
       abnbr.payaccnameen,
       abnbr.recaccno,
       abnbr.recaccnamecn,
       abnbr.recaccnameen,
       abnbr.sysioflg,
       abnbr.issamecity,
       abnbr.prop,
       abnbr.recicbccode,
       abnbr.reccityname,
       abnbr.recbankno,
       abnbr.recbankname,
       abnbr.currtype,
       abnbr.payamt/100 as payamt,
       abnbr.usecode,
       abnbr.usecn,
       abnbr.ensummary,
       abnbr.postscript,
       abnbr.summary,
       abnbr.ref,
       abnbr.oref,
       abnbr.erpsqn,
       abnbr.buscode,
       abnbr.erpcheckno,
       abnbr.crvouhtype,
       abnbr.crvouhname,
       abnbr.crvouhno,
	   abnbr.result res_state,
	case when abnbr.result = 0 then '提交成功,等待银行处理'
       when abnbr.result = 1 then '授权成功, 等待银行处理'
       when abnbr.result = 2 then '等待授权'
       when abnbr.result = 3 then '等待二次授权'
       when abnbr.result = 4 then '等待银行答复'
       when abnbr.result = 5 then '主机返回待处理'
       when abnbr.result = 6 then '被银行拒绝'
       when abnbr.result = 7 then '处理成功'
       when abnbr.result = 8 then '指令被拒绝授权'
       when abnbr.result = 9 then '银行正在处理'
       when abnbr.result = 10 then '预约指令'
       when abnbr.result = 11 then '预约取消'
       when abnbr.result = 86 then '等待电话核实'
       when abnbr.result = 95 then '待核查'
       when abnbr.result = 96 then '区域中心通讯可疑'        
      end as result
       ,abnbr.iretcode,
       abnbr.iretmsg,
       abnbr.represerved3,
       abnbr.represerved4,
       mpm.pay_bill_no,
	   mpm.pay_date,
       hsd.sup_code,
       hsd.sup_name
  from acc_bank_net_buyer_rd abnbr
  left join mat_pay_main mpm on abnbr.erpsqn = mpm.pay_id
		and mpm.group_id= #{group_id} and mpm.hos_id= #{hos_id} and mpm.copy_code=#{copy_code}
  left join hos_sup_dict hsd ON mpm.sup_id = hsd.sup_id 
  and mpm.sup_no = hsd.sup_no 
  --and hsd.is_stop = 0
  		and hsd.group_id= #{group_id} and hsd.hos_id= #{hos_id}

		<where>
			abnbr.group_id= #{group_id} and abnbr.hos_id= #{hos_id} and abnbr.copy_code=#{copy_code}

			<if test="acc_year != null and acc_year != ''">
				and abnbr.acc_year = #{acc_year}
			</if>
			<if test="fseqno != null and fseqno != ''">
				and abnbr.fseqno = #{fseqno}
			</if>
			<if test="pay_bill_no != null and pay_bill_no != ''">
				and mpm.pay_bill_no = #{pay_bill_no}
			</if>
			<if test="iseqno != null and iseqno != ''">
				and abnbr.iseqno = #{iseqno}
			</if>
			<if test="erpsqn != null and erpsqn != ''">
				and abnbr.erpsqn = #{erpsqn}
			</if>
			<if test="apply_code != null and apply_code != ''">
				and mpm.pay_bill_no = #{apply_code}
			</if>
		</where>
		order by abnbr.fseqno desc
	</select>

	<select id="queryMaxFSeqNo" resultType="java.lang.String">
		select nvl(max(fseqno),0)
		from acc_bank_net_buyer
		where group_id =#{group_id}
	</select>

	<select id="queryMaxISeqNo" resultType="java.lang.String">
		select nvl(max(iseqno),0)
		from acc_bank_net_buyer_rd
		where 
		group_id =#{group_id} and 
		hos_id=#{hos_id} and 
		copy_code=#{copy_code}
	</select>
	
	<select id="sumTotalAmtByDay" parameterType="java.util.Map" resultType="double">

select sum(a.totalamt) from (
select nvl(SUM(totalamt),0)/100 as totalamt  from acc_bank_net_payment
		<where>
		
		group_id= #{group_id} and hos_id= #{hos_id} and copy_code= #{copy_code} and retcode='0'

		AND trandate = to_date(#{nowDate,jdbcType=DATE},'yyyy-MM-dd')

		</where>
union all 
select nvl(SUM(totalamt),0)/100 as totalamt from acc_bank_net_borr
		<where>
		
		group_id= #{group_id} and hos_id= #{hos_id} and copy_code= #{copy_code} and retcode='0'

		AND trandate = to_date(#{nowDate,jdbcType=DATE},'yyyy-MM-dd')

		</where>
union all 
select nvl(SUM(totalamt),0)/100 as totalamt from acc_bank_net_wage
		<where>
		
		group_id= #{group_id} and hos_id= #{hos_id} and copy_code= #{copy_code} and retcode='0'

		AND trandate = to_date(#{nowDate,jdbcType=DATE},'yyyy-MM-dd')

		</where>
union all 
select nvl(SUM(totalamt),0)/100 as totalamt from acc_bank_net_charge
		<where>
		
		group_id= #{group_id} and hos_id= #{hos_id} and copy_code= #{copy_code} and retcode='0'

		AND trandate = to_date(#{nowDate,jdbcType=DATE},'yyyy-MM-dd')

		</where>
union all 
select nvl(SUM(totalamt),0)/100 as totalamt from acc_bank_net_buyer
		<where>
		
		group_id= #{group_id} and hos_id= #{hos_id} and copy_code= #{copy_code} and retcode='0'

		AND trandate = to_date(#{nowDate,jdbcType=DATE},'yyyy-MM-dd')

		</where>
) a
	</select>

</mapper>

	