<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.med.dao.affi.tran.MedAffiTranDetailMapper">

	<resultMap id="medAffiTranDetail" type="com.chd.hrp.med.entity.MedAffiTranDetail">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="tran_id" column="tran_id" />
		<result property="tran_no" column="tran_no" />
		<result property="year" column="year" />
		<result property="month" column="month" />
		<result property="out_store_id" column="out_store_id" />
		<result property="in_store_id" column="in_store_id" />
		<result property="tran_detail_id" column="tran_detail_id" />
		<result property="inv_id" column="inv_id" />
		<result property="inv_no" column="inv_no" />
		<result property="inv_code" column="inv_code" />
		<result property="inv_name" column="inv_name" />
		<result property="batch_sn" column="batch_sn" />
		<result property="batch_no" column="batch_no" />
		<result property="amount" column="amount" />
		<result property="price" column="price" />
		<result property="amount_money" column="amount_money" />
		<result property="sale_price" column="sale_price" />
		<result property="sale_money" column="sale_money" />
		<result property="sell_price" column="sell_price" />
		<result property="sell_money" column="sell_money" />
		<result property="allot_price" column="allot_price" />
		<result property="allot_money" column="allot_money" />
		<result property="pack_code" column="pack_code" />
		<result property="num_exchange" column="num_exchange" />
		<result property="pack_price" column="pack_price" />
		<result property="num" column="num" />
		<result property="bar_code" column="bar_code" />
		<result property="inva_date" column="inva_date" />
		<result property="disinfect_date" column="disinfect_date" />
		<result property="location_out_id" column="location_out_id" />
		<result property="location_in_id" column="location_in_id" />
		<result property="note" column="note" />
	</resultMap>

	<select id="queryMedAffiTranDetailSeq"  resultType="java.lang.Long" useCache="false" flushCache="true">		
		select MED_AFFI_TRAN_DETAIL_SEQ.nextval from dual
	</select>

	<insert id="add" useGeneratedKeys="true">

		INSERT INTO med_affi_tran_detail (
		<trim suffix="" suffixOverrides=",">
			<if test="group_id != null and group_id != ''">
				group_id
				,
			</if>
			<if test="hos_id != null and hos_id != ''">
				hos_id
				,
			</if>
			<if test="copy_code != null and copy_code != ''">
				copy_code
				,
			</if>
			<if test="tran_id != null and tran_id != ''">
				tran_id
				,
			</if>
			<if test="tran_no != null and tran_no != ''">
				tran_no
				,
			</if>
			<if test="tran_detail_id != null and tran_detail_id != ''">
				tran_detail_id
				,
			</if>
			<if test="inv_id != null and inv_id != ''">
				inv_id
				,
			</if>
			<if test="inv_no != null and inv_no != ''">
				inv_no
				,
			</if>
			<if test="batch_sn != null and batch_sn != ''">
				batch_sn
				,
			</if>
			<if test="batch_no != null and batch_no != ''">
				batch_no
				,
			</if>
			<if test="amount != null and amount != ''">
				amount
				,
			</if>
			<if test="price != null and price != ''">
				price
				,
			</if>
			<if test="amount_money != null and amount_money != ''">
				amount_money
				,
			</if>
			<if test="sale_price != null and sale_price != ''">
				sale_price
				,
			</if>
			<if test="sale_money != null and sale_money != ''">
				sale_money
				,
			</if>
			<if test="sell_price != null and sell_price != ''">
				sell_price
				,
			</if>
			<if test="sell_money != null and sell_money != ''">
				sell_money
				,
			</if>
			<if test="allot_price != null and allot_price != ''">
				allot_price
				,
			</if>
			<if test="allot_money != null and allot_money != ''">
				allot_money
				,
			</if>
			<if test="pack_code != null and pack_code != ''">
				pack_code
				,
			</if>
			<if test="num_exchange != null and num_exchange != ''">
				num_exchange
				,
			</if>
			<if test="pack_price != null and pack_price != ''">
				pack_price
				,
			</if>
			<if test="num != null and num != ''">
				num
				,
			</if>
			<if test="bar_code != null and bar_code != ''">
				bar_code
				,
			</if>
			<if test="inva_date != null and inva_date != ''">
				inva_date
				,
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				disinfect_date
				,
			</if>
			<if test="location_out_id != null and location_out_id != ''">
				location_out_id
				,
			</if>
			<if test="location_in_id != null and location_in_id != ''">
				location_in_id
				,
			</if>
			<if test="note != null and note != ''">
				note
				,
			</if>
		</trim>
		) VALUES (
		<trim suffix="" suffixOverrides=",">
			<if test="group_id != null and group_id != ''">
				#{group_id,jdbcType=INTEGER}
				,
			</if>
			<if test="hos_id != null and hos_id != ''">
				#{hos_id,jdbcType=INTEGER}
				,
			</if>
			<if test="copy_code != null and copy_code != ''">
				#{copy_code,jdbcType=VARCHAR}
				,
			</if>
			<if test="tran_id != null and tran_id != ''">
				#{tran_id,jdbcType=INTEGER}
				,
			</if>
			<if test="tran_no != null and tran_no != ''">
				#{tran_no,jdbcType=INTEGER}
				,
			</if>
			<if test="tran_detail_id != null and tran_detail_id != ''">
				#{tran_detail_id,jdbcType=INTEGER}
				,
			</if>
			<if test="inv_id != null and inv_id != ''">
				#{inv_id,jdbcType=INTEGER}
				,
			</if>
			<if test="inv_no != null and inv_no != ''">
				#{inv_no,jdbcType=INTEGER}
				,
			</if>
			<if test="batch_sn != null and batch_sn != ''">
				#{batch_sn,jdbcType=INTEGER}
				,
			</if>
			<if test="batch_no != null and batch_no != ''">
				#{batch_no,jdbcType=VARCHAR}
				,
			</if>
			<if test="amount != null and amount != ''">
				#{amount,jdbcType=INTEGER}
				,
			</if>
			<if test="price != null and price != ''">
				#{price,jdbcType=INTEGER}
				,
			</if>
			<if test="amount_money != null and amount_money != ''">
				#{amount_money,jdbcType=INTEGER}
				,
			</if>
			<if test="sale_price != null and sale_price != ''">
				#{sale_price,jdbcType=INTEGER}
				,
			</if>
			<if test="sale_money != null and sale_money != ''">
				#{sale_money,jdbcType=INTEGER}
				,
			</if>
			<if test="sell_price != null and sell_price != ''">
				#{sell_price,jdbcType=INTEGER}
				,
			</if>
			<if test="sell_money != null and sell_money != ''">
				#{sell_money,jdbcType=INTEGER}
				,
			</if>
			<if test="allot_price != null and allot_price != ''">
				#{allot_price,jdbcType=INTEGER}
				,
			</if>
			<if test="allot_money != null and allot_money != ''">
				#{allot_money,jdbcType=INTEGER}
				,
			</if>
			<if test="pack_code != null and pack_code != ''">
				#{pack_code,jdbcType=VARCHAR}
				,
			</if>
			<if test="num_exchange != null and num_exchange != ''">
				#{num_exchange,jdbcType=INTEGER}
				,
			</if>
			<if test="pack_price != null and pack_price != ''">
				#{pack_price,jdbcType=INTEGER}
				,
			</if>
			<if test="num != null and num != ''">
				#{num,jdbcType=INTEGER}
				,
			</if>
			<if test="bar_code != null and bar_code != ''">
				#{bar_code,jdbcType=VARCHAR}
				,
			</if>
			<if test="inva_date != null and inva_date != ''">
				#{inva_date,jdbcType=DATE}
				,
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				#{disinfect_date,jdbcType=DATE}
				,
			</if>
			<if test="location_out_id != null and location_out_id != ''">
				#{location_out_id,jdbcType=INTEGER}
				,
			</if>
			<if test="location_in_id != null and location_in_id != ''">
				#{location_in_id,jdbcType=CHAR}
				,
			</if>
			<if test="note != null and note != ''">
				#{note,jdbcType=VARCHAR}

			</if>
		</trim>
		)

	</insert>
	
	
	<insert id="addBatch" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			INSERT INTO med_affi_tran_detail (
				group_id, 
				hos_id, 
				copy_code, 
				tran_id,
				tran_no, 
				tran_detail_id 
				<if test="item.inv_id != null and item.inv_id != ''">, inv_id</if>
				<if test="item.inv_no != null and item.inv_no != ''">, inv_no</if>
				<if test="item.batch_no != null and item.batch_no != ''">, batch_no</if>
				<if test="item.batch_sn != null and item.batch_sn != ''">, batch_sn</if> 
				<if test="item.price != null">, price</if>
				<if test="item.amount != null and item.amount != ''">, amount</if> 
				<if test="item.amount_money != null">, amount_money</if>
				<if test="item.sale_price != null">, sale_price</if>
				<if test="item.sale_money != null">, sale_money</if>
				<if test="item.sell_price != null">, sell_price</if>
				<if test="item.sell_money != null">, sell_money</if>
				<if test="item.allot_price != null">, allot_price</if>
				<if test="item.allot_money != null">, allot_money</if>
				<if test="item.pack_code != null and item.pack_code != ''">, pack_code</if>
				<if test="item.num_exchange != null and item.num_exchange != ''">, num_exchange</if>
				<if test="item.pack_price != null and item.pack_price != ''">, pack_price</if>
				<if test="item.num != null and item.num != ''">, num</if>
				<if test="item.bar_code != null and item.bar_code != ''">, bar_code</if>
				<if test="item.inva_date != null and item.inva_date != ''">, inva_date</if>
				<if test="item.disinfect_date != null and item.disinfect_date != ''">, disinfect_date</if>
				<if test="item.location_out_id != null">, location_out_id</if>
				<if test="item.location_in_id != null">, location_in_id</if>
				<if test="item.note != null and item.note != ''">, note</if>
			)values( 
				#{item.group_id,jdbcType=INTEGER},
				#{item.hos_id,jdbcType=INTEGER},
				#{item.copy_code,jdbcType=VARCHAR},
				#{item.tran_id,jdbcType=INTEGER},
				#{item.tran_no,jdbcType=VARCHAR},
				#{item.tran_detail_id,jdbcType=INTEGER}
				<if test="item.inv_id != null and item.inv_id != ''">, #{item.inv_id,jdbcType=INTEGER}</if>
				<if test="item.inv_no != null and item.inv_no != ''">, #{item.inv_no,jdbcType=INTEGER}</if>
				<if test="item.batch_no != null and item.batch_no != ''">, #{item.batch_no,jdbcType=VARCHAR}</if>
				<if test="item.batch_sn != null and item.batch_sn != ''">, #{item.batch_sn,jdbcType=VARCHAR}</if>
				<if test="item.price != null">, #{item.price,jdbcType=FLOAT}</if>
				<if test="item.amount != null and item.amount != ''">, #{item.amount,jdbcType=FLOAT}</if>
				<if test="item.amount_money != null">, #{item.amount_money,jdbcType=FLOAT}</if>
				<if test="item.sale_price != null">, #{item.sale_price,jdbcType=FLOAT}</if>
				<if test="item.sale_money != null">, #{item.sale_money,jdbcType=FLOAT}</if>
				<if test="item.sell_price != null">, #{item.sell_price,jdbcType=FLOAT}</if>
				<if test="item.sell_money != null">, #{item.sell_money,jdbcType=FLOAT}</if>
				<if test="item.allot_price != null">, #{item.allot_price,jdbcType=FLOAT}</if>
				<if test="item.allot_money != null">, #{item.allot_money,jdbcType=FLOAT}</if>
				<if test="item.pack_code != null and item.pack_code != ''">, #{item.pack_code,jdbcType=VARCHAR}</if>
				<if test="item.num_exchange != null and item.num_exchange != ''">, #{item.num_exchange,jdbcType=INTEGER}</if>
				<if test="item.pack_price != null and item.pack_price != ''">, #{item.pack_price,jdbcType=INTEGER}</if>
				<if test="item.num != null and item.num != ''">, #{item.num,jdbcType=INTEGER}</if>
				<if test="item.bar_code != null and item.bar_code != ''">, #{item.bar_code,jdbcType=VARCHAR}</if>
				<if test="item.inva_date != null and item.inva_date != ''">, #{item.inva_date,jdbcType=DATE}</if>
				<if test="item.disinfect_date != null and item.disinfect_date != ''">, #{item.disinfect_date,jdbcType=DATE}</if>
				<if test="item.location_out_id != null">, #{item.location_out_id,jdbcType=INTEGER}</if>
				<if test="item.location_in_id != null">, #{item.location_in_id,jdbcType=INTEGER}</if>
				<if test="item.note != null and item.note != ''">, #{item.note,jdbcType=VARCHAR}</if>
			)
		</foreach>
	</insert>

	<update id="update" parameterType="java.util.Map">
		UPDATE med_affi_tran_detail
		<trim prefix="SET" suffixOverrides=",">
			<if test="inv_id != null and inv_id != ''">
				inv_id = #{inv_id,jdbcType=INTEGER}
				,
			</if>
			<if test="inv_no != null and inv_no != ''">
				inv_no = #{inv_no,jdbcType=INTEGER}
				,
			</if>
			<if test="batch_sn != null and batch_sn != ''">
				batch_sn = #{batch_sn,jdbcType=INTEGER}
				,
			</if>
			<if test="batch_no != null and batch_no != ''">
				batch_no = #{batch_no,jdbcType=VARCHAR}
				,
			</if>
			<if test="amount != null and amount != ''">
				amount = #{amount,jdbcType=INTEGER}
				,
			</if>
			<if test="price != null">
				price = #{price,jdbcType=INTEGER}
				,
			</if>
			<if test="amount_money != null">
				amount_money = #{amount_money,jdbcType=INTEGER}
				,
			</if>
			<if test="sale_price != null">
				sale_price = #{sale_price,jdbcType=INTEGER}
				,
			</if>
			<if test="sale_money != null">
				sale_money = #{sale_money,jdbcType=INTEGER}
				,
			</if>
			<if test="sell_price != null">
				sell_price = #{sell_price,jdbcType=INTEGER}
				,
			</if>
			<if test="sell_money != null">
				sell_money = #{sell_money,jdbcType=INTEGER}
				,
			</if>
			<if test="allot_price != null">
				allot_price = #{allot_price,jdbcType=INTEGER}
				,
			</if>
			<if test="allot_money != null">
				allot_money = #{allot_money,jdbcType=INTEGER}
				,
			</if>
			<if test="pack_code != null">
				pack_code = #{pack_code,jdbcType=VARCHAR}
				,
			</if>
			<if test="num_exchange != null">
				num_exchange = #{num_exchange,jdbcType=INTEGER}
				,
			</if>
			<if test="pack_price != null">
				pack_price = #{pack_price,jdbcType=INTEGER}
				,
			</if>
			<if test="num != null">
				num = #{num,jdbcType=INTEGER}
				,
			</if>
			<if test="bar_code != null and bar_code != ''">
				bar_code = #{bar_code,jdbcType=VARCHAR}
				,
			</if>
			<if test="inva_date != null">
				inva_date = #{inva_date,jdbcType=DATE}
				,
			</if>
			<if test="disinfect_date != null">
				disinfect_date = #{disinfect_date,jdbcType=DATE}
				,
			</if>
			<if test="location_out_id != null">
				location_out_id = #{location_out_id,jdbcType=INTEGER}
				,
			</if>
			<if test="location_in_id != null">
				location_in_id = #{location_in_id,jdbcType=CHAR}
				,
			</if>
			<if test="note != null">
				note = #{note,jdbcType=VARCHAR}
				,
			</if>
		</trim>
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id != ''">
				AND tran_id = #{tran_id,jdbcType=INTEGER}
			</if>
			<if test="tran_detail_id != null and tran_detail_id != ''">
				AND tran_detail_id = #{tran_detail_id,jdbcType=INTEGER}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_no != null and inv_no != ''">
				AND inv_no = #{inv_no,jdbcType=INTEGER}
			</if>
			<if test="batch_sn != null and batch_sn != ''">
				AND batch_sn = #{batch_sn,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null and batch_no != ''">
				AND batch_no = #{batch_no,jdbcType=VARCHAR}
			</if>
			<if test="amount != null and amount != ''">
				AND amount = #{amount,jdbcType=INTEGER}
			</if>
			<if test="price != null and price != ''">
				AND price = #{price,jdbcType=INTEGER}
			</if>
			<if test="amount_money != null and amount_money != ''">
				AND amount_money = #{amount_money,jdbcType=INTEGER}
			</if>
			<if test="sale_price != null and sale_price != ''">
				AND sale_price = #{sale_price,jdbcType=INTEGER}
			</if>
			<if test="sale_money != null and sale_money != ''">
				AND sale_money = #{sale_money,jdbcType=INTEGER}
			</if>
			<if test="sell_price != null and sell_price != ''">
				AND sell_price = #{sell_price,jdbcType=INTEGER}
			</if>
			<if test="sell_money != null and sell_money != ''">
				AND sell_money = #{sell_money,jdbcType=INTEGER}
			</if>
			<if test="allot_price != null and allot_price != ''">
				AND allot_price = #{allot_price,jdbcType=INTEGER}
			</if>
			<if test="allot_money != null and allot_money != ''">
				AND allot_money = #{allot_money,jdbcType=INTEGER}
			</if>
			<if test="pack_code != null and pack_code != ''">
				AND pack_code = #{pack_code,jdbcType=VARCHAR}
			</if>
			<if test="num_exchange != null and num_exchange != ''">
				AND num_exchange = #{num_exchange,jdbcType=INTEGER}
			</if>
			<if test="pack_price != null and pack_price != ''">
				AND pack_price = #{pack_price,jdbcType=INTEGER}
			</if>
			<if test="num != null and num != ''">
				AND num = #{num,jdbcType=INTEGER}
			</if>
			<if test="bar_code != null and bar_code != ''">
				AND bar_code = #{bar_code,jdbcType=VARCHAR}
			</if>
			<if test="inva_date != null and inva_date != ''">
				AND inva_date = #{inva_date,jdbcType=DATE}
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				AND disinfect_date = #{disinfect_date,jdbcType=DATE}
			</if>
			<if test="location_out_id != null and location_out_id != ''">
				AND location_out_id = #{location_out_id,jdbcType=INTEGER}
			</if>
			<if test="location_in_id != null and location_in_id != ''">
				AND location_in_id = #{location_in_id,jdbcType=CHAR}
			</if>
			<if test="note != null and note != ''">
				AND note = #{note,jdbcType=VARCHAR}
			</if>
		</where>
	</update>
	
	<update id="updateBatch" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			UPDATE med_affi_tran_detail
			<trim prefix="SET" suffixOverrides=",">
				<if test="item.inv_id != null and item.inv_id != ''">inv_id = #{item.inv_id,jdbcType=INTEGER},</if>
				<if test="item.inv_no != null and item.inv_no != ''">inv_no = #{item.inv_no,jdbcType=INTEGER},</if>
				<if test="item.batch_sn != null and item.batch_sn != ''">batch_sn = #{item.batch_sn,jdbcType=INTEGER},</if>
				<if test="item.batch_no != null and item.batch_no != ''">batch_no = #{item.batch_no,jdbcType=VARCHAR},</if>
				<if test="item.amount != null and item.amount != ''">amount = #{item.amount,jdbcType=INTEGER},</if>
				<if test="item.price != null">price = #{item.price,jdbcType=INTEGER},</if>
				<if test="item.amount_money != null">amount_money = #{item.amount_money,jdbcType=INTEGER},
				</if>
				<if test="item.sale_price != null">sale_price = #{item.sale_price,jdbcType=INTEGER},</if>
				<if test="item.sale_money != null">sale_money = #{item.sale_money,jdbcType=INTEGER},</if>
				<if test="item.sell_price != null">sell_price = #{item.sell_price,jdbcType=INTEGER},</if>
				<if test="item.sell_money != null">sell_money = #{item.sell_money,jdbcType=INTEGER},</if>
				<if test="item.allot_price != null">allot_price = #{item.allot_price,jdbcType=INTEGER},</if>
				<if test="item.allot_money != null">allot_money = #{item.allot_money,jdbcType=INTEGER},</if>
				<if test="item.pack_code != null">pack_code = #{item.pack_code,jdbcType=VARCHAR},</if>
				<if test="item.num_exchange != null">num_exchange = #{item.num_exchange,jdbcType=INTEGER},
				</if>
				<if test="item.pack_price != null">pack_price = #{item.pack_price,jdbcType=INTEGER},</if>
				<if test="item.num != null">num = #{item.num,jdbcType=INTEGER},</if>
				<if test="item.bar_code != null">bar_code = #{item.bar_code,jdbcType=VARCHAR},</if>
				<if test="item.inva_date != null">inva_date =
					to_date(#{item.inva_date,jdbcType=VARCHAR},'yyyy/MM/dd'),</if>
				<if test="item.disinfect_date != null">disinfect_date =
					to_date(#{item.disinfect_date,jdbcType=VARCHAR},'yyyy/MM/dd'),</if>
				<if test="item.location_out_id != null">location_out_id =
					#{item.location_out_id,jdbcType=INTEGER},</if>
				<if test="item.location_in_id != null">location_in_id = #{item.location_in_id,jdbcType=CHAR},
				</if>
				<if test="item.note != null">note = #{item.note,jdbcType=VARCHAR},</if>
			</trim>
			<where>
				<if test="item.group_id != null and item.group_id != ''">AND group_id = #{item.group_id,jdbcType=INTEGER}</if>
				<if test="item.hos_id != null and item.hos_id != ''">AND hos_id = #{item.hos_id,jdbcType=INTEGER}</if>
				<if test="item.copy_code != null and item.copy_code != ''">AND copy_code = #{item.copy_code,jdbcType=VARCHAR}</if>
				<if test="item.tran_id != null and item.tran_id != ''">AND tran_id = #{item.tran_id,jdbcType=INTEGER}</if>
				<if test="item.tran_detail_id != null and item.tran_detail_id != ''">AND tran_detail_id =
					#{item.tran_detail_id,jdbcType=INTEGER}</if>
			</where>
		</foreach>
	</update>

	<delete id="delete" parameterType="java.util.Map">
		DELETE FROM med_affi_tran_detail
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id != ''">
				AND tran_id = #{tran_id,jdbcType=INTEGER}
			</if>
			<if test="tran_detail_id != null and tran_detail_id != ''">
				AND tran_detail_id = #{tran_detail_id,jdbcType=INTEGER}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_no != null and inv_no != ''">
				AND inv_no = #{inv_no,jdbcType=INTEGER}
			</if>
			<if test="batch_sn != null and batch_sn != ''">
				AND batch_sn = #{batch_sn,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null and batch_no != ''">
				AND batch_no = #{batch_no,jdbcType=VARCHAR}
			</if>
			<if test="amount != null and amount != ''">
				AND amount = #{amount,jdbcType=INTEGER}
			</if>
			<if test="price != null and price != ''">
				AND price = #{price,jdbcType=INTEGER}
			</if>
			<if test="amount_money != null and amount_money != ''">
				AND amount_money = #{amount_money,jdbcType=INTEGER}
			</if>
			<if test="sale_price != null and sale_price != ''">
				AND sale_price = #{sale_price,jdbcType=INTEGER}
			</if>
			<if test="sale_money != null and sale_money != ''">
				AND sale_money = #{sale_money,jdbcType=INTEGER}
			</if>
			<if test="sell_price != null and sell_price != ''">
				AND sell_price = #{sell_price,jdbcType=INTEGER}
			</if>
			<if test="sell_money != null and sell_money != ''">
				AND sell_money = #{sell_money,jdbcType=INTEGER}
			</if>
			<if test="allot_price != null and allot_price != ''">
				AND allot_price = #{allot_price,jdbcType=INTEGER}
			</if>
			<if test="allot_money != null and allot_money != ''">
				AND allot_money = #{allot_money,jdbcType=INTEGER}
			</if>
			<if test="pack_code != null and pack_code != ''">
				AND pack_code = #{pack_code,jdbcType=VARCHAR}
			</if>
			<if test="num_exchange != null and num_exchange != ''">
				AND num_exchange = #{num_exchange,jdbcType=INTEGER}
			</if>
			<if test="pack_price != null and pack_price != ''">
				AND pack_price = #{pack_price,jdbcType=INTEGER}
			</if>
			<if test="num != null and num != ''">
				AND num = #{num,jdbcType=INTEGER}
			</if>
			<if test="bar_code != null and bar_code != ''">
				AND bar_code = #{bar_code,jdbcType=VARCHAR}
			</if>
			<if test="inva_date != null and inva_date != ''">
				AND inva_date = #{inva_date,jdbcType=DATE}
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				AND disinfect_date = #{disinfect_date,jdbcType=DATE}
			</if>
			<if test="location_out_id != null and location_out_id != ''">
				AND location_out_id = #{location_out_id,jdbcType=INTEGER}
			</if>
			<if test="location_in_id != null and location_in_id != ''">
				AND location_in_id = #{location_in_id,jdbcType=CHAR}
			</if>
			<if test="note != null and note != ''">
				AND note = #{note,jdbcType=VARCHAR}
			</if>
		</where>
	</delete>
	
	<delete id="deleteBatch" parameterType="java.util.List">
		DELETE FROM med_affi_tran_detail
		<where>
			<foreach collection="list" index="index" item="item" open="("
				separator="or" close=")">
				<if test="item.group_id != null and item.group_id != ''">
					group_id = #{item.group_id,jdbcType=INTEGER}
				</if>
				<if test="item.hos_id != null and item.hos_id != ''">
					AND hos_id = #{item.hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
				</if>
				<if test="item.tran_id != null and item.tran_id != ''">
					AND tran_id = #{item.tran_id,jdbcType=INTEGER}
				</if>
				<if test="item.tran_detail_id != null and item.tran_detail_id != ''">
					AND tran_detail_id = #{item.tran_detail_id,jdbcType=INTEGER}
				</if>
				<if test="item.inv_id != null and item.inv_id != ''">
					AND inv_id = #{item.inv_id,jdbcType=INTEGER}
				</if>
				<if test="item.inv_no != null and item.inv_no != ''">
					AND inv_no = #{item.inv_no,jdbcType=INTEGER}
				</if>
				<if test="item.batch_sn != null and item.batch_sn != ''">
					AND batch_sn = #{item.batch_sn,jdbcType=INTEGER}
				</if>
				<if test="item.batch_no != null and item.batch_no != ''">
					AND batch_no = #{item.batch_no,jdbcType=VARCHAR}
				</if>
				<if test="item.amount != null and item.amount != ''">
					AND amount = #{item.amount,jdbcType=INTEGER}
				</if>
				<if test="item.price != null and item.price != ''">
					AND price = #{item.price,jdbcType=INTEGER}
				</if>
				<if test="item.amount_money != null and item.amount_money != ''">
					AND amount_money = #{item.amount_money,jdbcType=INTEGER}
				</if>
				<if test="item.sale_price != null and item.sale_price != ''">
					AND sale_price = #{item.sale_price,jdbcType=INTEGER}
				</if>
				<if test="item.sale_money != null and item.sale_money != ''">
					AND sale_money = #{item.sale_money,jdbcType=INTEGER}
				</if>
				<if test="item.sell_price != null and item.sell_price != ''">
					AND sell_price = #{item.sell_price,jdbcType=INTEGER}
				</if>
				<if test="item.sell_money != null and item.sell_money != ''">
					AND sell_money = #{item.sell_money,jdbcType=INTEGER}
				</if>
				<if test="item.allot_price != null and item.allot_price != ''">
					AND allot_price = #{item.allot_price,jdbcType=INTEGER}
				</if>
				<if test="item.allot_money != null and item.allot_money != ''">
					AND allot_money = #{item.allot_money,jdbcType=INTEGER}
				</if>
				<if test="item.pack_code != null and item.pack_code != ''">
					AND pack_code = #{item.pack_code,jdbcType=VARCHAR}
				</if>
				<if test="item.num_exchange != null and item.num_exchange != ''">
					AND num_exchange = #{item.num_exchange,jdbcType=INTEGER}
				</if>
				<if test="item.pack_price != null and item.pack_price != ''">
					AND pack_price = #{item.pack_price,jdbcType=INTEGER}
				</if>
				<if test="item.num != null and item.num != ''">
					AND num = #{item.num,jdbcType=INTEGER}
				</if>
				<if test="item.bar_code != null and item.bar_code != ''">
					AND bar_code = #{item.bar_code,jdbcType=VARCHAR}
				</if>
				<if test="item.inva_date != null and item.inva_date != ''">
					AND inva_date = #{item.inva_date,jdbcType=DATE}
				</if>
				<if test="item.disinfect_date != null and item.disinfect_date != ''">
					AND disinfect_date = #{item.disinfect_date,jdbcType=DATE}
				</if>
				<if test="item.location_out_id != null and item.location_out_id != ''">
					AND location_out_id = #{item.location_out_id,jdbcType=INTEGER}
				</if>
				<if test="item.location_in_id != null and item.location_in_id != ''">
					AND location_in_id = #{item.location_in_id,jdbcType=CHAR}
				</if>
				<if test="item.note != null and item.note != ''">
					AND note = #{item.note,jdbcType=VARCHAR}
				</if>
			</foreach>
		</where>
	</delete>
	
	<select id="query" parameterType="java.util.Map" resultMap="medAffiTranDetail">
		SELECT
			group_id,
			hos_id,
			copy_code,
			tran_id,
			tran_no,
			tran_detail_id,
			inv_id,
			inv_no,
			batch_sn,
			batch_no,
			amount,
			price,
			amount_money,
			sale_price,
			sale_money,
			sell_price,
			sell_money,
			allot_price,
			allot_money,
			pack_code,
			num_exchange,
			pack_price,
			num,
			bar_code,
			inva_date,
			disinfect_date,
			location_out_id,
			location_in_id,
			note
		FROM med_affi_tran_detail
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id != ''">
				AND tran_id = #{tran_id,jdbcType=INTEGER}
			</if>
			<if test="tran_detail_id != null and tran_detail_id != ''">
				AND tran_detail_id = #{tran_detail_id,jdbcType=INTEGER}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_no != null and inv_no != ''">
				AND inv_no = #{inv_no,jdbcType=INTEGER}
			</if>
			<if test="batch_sn != null and batch_sn != ''">
				AND batch_sn = #{batch_sn,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null and batch_no != ''">
				AND batch_no = #{batch_no,jdbcType=VARCHAR}
			</if>
			<if test="amount != null and amount != ''">
				AND amount = #{amount,jdbcType=INTEGER}
			</if>
			<if test="price != null and price != ''">
				AND price = #{price,jdbcType=INTEGER}
			</if>
			<if test="amount_money != null and amount_money != ''">
				AND amount_money = #{amount_money,jdbcType=INTEGER}
			</if>
			<if test="sale_price != null and sale_price != ''">
				AND sale_price = #{sale_price,jdbcType=INTEGER}
			</if>
			<if test="sale_money != null and sale_money != ''">
				AND sale_money = #{sale_money,jdbcType=INTEGER}
			</if>
			<if test="sell_price != null and sell_price != ''">
				AND sell_price = #{sell_price,jdbcType=INTEGER}
			</if>
			<if test="sell_money != null and sell_money != ''">
				AND sell_money = #{sell_money,jdbcType=INTEGER}
			</if>
			<if test="allot_price != null and allot_price != ''">
				AND allot_price = #{allot_price,jdbcType=INTEGER}
			</if>
			<if test="allot_money != null and allot_money != ''">
				AND allot_money = #{allot_money,jdbcType=INTEGER}
			</if>
			<if test="pack_code != null and pack_code != ''">
				AND pack_code = #{pack_code,jdbcType=VARCHAR}
			</if>
			<if test="num_exchange != null and num_exchange != ''">
				AND num_exchange = #{num_exchange,jdbcType=INTEGER}
			</if>
			<if test="pack_price != null and pack_price != ''">
				AND pack_price = #{pack_price,jdbcType=INTEGER}
			</if>
			<if test="num != null and num != ''">
				AND num = #{num,jdbcType=INTEGER}
			</if>
			<if test="bar_code != null and bar_code != ''">
				AND bar_code = #{bar_code,jdbcType=VARCHAR}
			</if>
			<if test="inva_date != null and inva_date != ''">
				AND inva_date = #{inva_date,jdbcType=DATE}
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				AND disinfect_date = #{disinfect_date,jdbcType=DATE}
			</if>
			<if test="location_out_id != null and location_out_id != ''">
				AND location_out_id = #{location_out_id,jdbcType=INTEGER}
			</if>
			<if test="location_in_id != null and location_in_id != ''">
				AND location_in_id = #{location_in_id,jdbcType=CHAR}
			</if>
			<if test="note != null and note != ''">
				AND note = #{note,jdbcType=VARCHAR}
			</if>
		</where>
		order by tran_detail_id asc
	</select>
	
	<select id="queryByCode" resultMap="medAffiTranDetail" parameterType="java.util.Map">
		SELECT
			group_id,
			hos_id,
			copy_code,
			tran_id,
			tran_no,
			tran_detail_id,
			inv_id,
			inv_no,
			batch_sn,
			batch_no,
			amount,
			price,
			amount_money,
			sale_price,
			sale_money,
			sell_price,
			sell_money,
			allot_price,
			allot_money,
			pack_code,
			num_exchange,
			pack_price,
			num,
			bar_code,
			inva_date,
			disinfect_date,
			location_out_id,
			location_in_id,
			note
		FROM med_affi_tran_detail
		WHERE group_id = #{group_id,jdbcType=INTEGER} and
			hos_id = #{hos_id,jdbcType=INTEGER} and
			copy_code = #{copy_code,jdbcType=VARCHAR} and
			tran_id = #{tran_id,jdbcType=INTEGER} and
			tran_detail_id = #{tran_detail_id,jdbcType=INTEGER}

	</select>
	
	<select id="queryByUniqueness" resultMap="medAffiTranDetail" parameterType="java.util.Map">
		SELECT
			group_id,
			hos_id,
			copy_code,
			tran_id,
			tran_no,
			tran_detail_id,
			inv_id,
			inv_no,
			batch_sn,
			batch_no,
			amount,
			price,
			amount_money,
			sale_price,
			sale_money,
			sell_price,
			sell_money,
			allot_price,
			allot_money,
			pack_code,
			num_exchange,
			pack_price,
			num,
			bar_code,
			inva_date,
			disinfect_date,
			location_out_id,
			location_in_id,
			note
		FROM med_affi_tran_detail
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id != ''">
				AND tran_id = #{tran_id,jdbcType=INTEGER}
			</if>
			<if test="tran_detail_id != null and tran_detail_id != ''">
				AND tran_detail_id = #{tran_detail_id,jdbcType=INTEGER}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_no != null and inv_no != ''">
				AND inv_no = #{inv_no,jdbcType=INTEGER}
			</if>
			<if test="batch_sn != null and batch_sn != ''">
				AND batch_sn = #{batch_sn,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null and batch_no != ''">
				AND batch_no = #{batch_no,jdbcType=VARCHAR}
			</if>
			<if test="amount != null and amount != ''">
				AND amount = #{amount,jdbcType=INTEGER}
			</if>
			<if test="price != null and price != ''">
				AND price = #{price,jdbcType=INTEGER}
			</if>
			<if test="amount_money != null and amount_money != ''">
				AND amount_money = #{amount_money,jdbcType=INTEGER}
			</if>
			<if test="sale_price != null and sale_price != ''">
				AND sale_price = #{sale_price,jdbcType=INTEGER}
			</if>
			<if test="sale_money != null and sale_money != ''">
				AND sale_money = #{sale_money,jdbcType=INTEGER}
			</if>
			<if test="sell_price != null and sell_price != ''">
				AND sell_price = #{sell_price,jdbcType=INTEGER}
			</if>
			<if test="sell_money != null and sell_money != ''">
				AND sell_money = #{sell_money,jdbcType=INTEGER}
			</if>
			<if test="allot_price != null and allot_price != ''">
				AND allot_price = #{allot_price,jdbcType=INTEGER}
			</if>
			<if test="allot_money != null and allot_money != ''">
				AND allot_money = #{allot_money,jdbcType=INTEGER}
			</if>
			<if test="pack_code != null and pack_code != ''">
				AND pack_code = #{pack_code,jdbcType=VARCHAR}
			</if>
			<if test="num_exchange != null and num_exchange != ''">
				AND num_exchange = #{num_exchange,jdbcType=INTEGER}
			</if>
			<if test="pack_price != null and pack_price != ''">
				AND pack_price = #{pack_price,jdbcType=INTEGER}
			</if>
			<if test="num != null and num != ''">
				AND num = #{num,jdbcType=INTEGER}
			</if>
			<if test="bar_code != null and bar_code != ''">
				AND bar_code = #{bar_code,jdbcType=VARCHAR}
			</if>
			<if test="inva_date != null and inva_date != ''">
				AND inva_date = #{inva_date,jdbcType=DATE}
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				AND disinfect_date = #{disinfect_date,jdbcType=DATE}
			</if>
			<if test="location_out_id != null and location_out_id != ''">
				AND location_out_id = #{location_out_id,jdbcType=INTEGER}
			</if>
			<if test="location_in_id != null and location_in_id != ''">
				AND location_in_id = #{location_in_id,jdbcType=CHAR}
			</if>
			<if test="note != null and note != ''">
				AND note = #{note,jdbcType=VARCHAR}
			</if>
		</where>
		order by tran_detail_id asc
	</select>
	
	<select id="queryExists" resultMap="medAffiTranDetail" parameterType="java.util.Map">
		SELECT
			group_id,
			hos_id,
			copy_code,
			tran_id,
			tran_no,
			tran_detail_id,
			inv_id,
			inv_no,
			batch_sn,
			batch_no,
			amount,
			price,
			amount_money,
			sale_price,
			sale_money,
			sell_price,
			sell_money,
			allot_price,
			allot_money,
			pack_code,
			num_exchange,
			pack_price,
			num,
			bar_code,
			inva_date,
			disinfect_date,
			location_out_id,
			location_in_id,
			note
		FROM med_affi_tran_detail
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id != ''">
				AND tran_id = #{tran_id,jdbcType=INTEGER}
			</if>
			<if test="tran_detail_id != null and tran_detail_id != ''">
				AND tran_detail_id = #{tran_detail_id,jdbcType=INTEGER}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND inv_id = #{inv_id,jdbcType=INTEGER}
			</if>
			<if test="inv_no != null and inv_no != ''">
				AND inv_no = #{inv_no,jdbcType=INTEGER}
			</if>
			<if test="batch_sn != null and batch_sn != ''">
				AND batch_sn = #{batch_sn,jdbcType=INTEGER}
			</if>
			<if test="batch_no != null and batch_no != ''">
				AND batch_no = #{batch_no,jdbcType=VARCHAR}
			</if>
			<if test="amount != null and amount != ''">
				AND amount = #{amount,jdbcType=INTEGER}
			</if>
			<if test="price != null and price != ''">
				AND price = #{price,jdbcType=INTEGER}
			</if>
			<if test="amount_money != null and amount_money != ''">
				AND amount_money = #{amount_money,jdbcType=INTEGER}
			</if>
			<if test="sale_price != null and sale_price != ''">
				AND sale_price = #{sale_price,jdbcType=INTEGER}
			</if>
			<if test="sale_money != null and sale_money != ''">
				AND sale_money = #{sale_money,jdbcType=INTEGER}
			</if>
			<if test="sell_price != null and sell_price != ''">
				AND sell_price = #{sell_price,jdbcType=INTEGER}
			</if>
			<if test="sell_money != null and sell_money != ''">
				AND sell_money = #{sell_money,jdbcType=INTEGER}
			</if>
			<if test="allot_price != null and allot_price != ''">
				AND allot_price = #{allot_price,jdbcType=INTEGER}
			</if>
			<if test="allot_money != null and allot_money != ''">
				AND allot_money = #{allot_money,jdbcType=INTEGER}
			</if>
			<if test="pack_code != null and pack_code != ''">
				AND pack_code = #{pack_code,jdbcType=VARCHAR}
			</if>
			<if test="num_exchange != null and num_exchange != ''">
				AND num_exchange = #{num_exchange,jdbcType=INTEGER}
			</if>
			<if test="pack_price != null and pack_price != ''">
				AND pack_price = #{pack_price,jdbcType=INTEGER}
			</if>
			<if test="num != null and num != ''">
				AND num = #{num,jdbcType=INTEGER}
			</if>
			<if test="bar_code != null and bar_code != ''">
				AND bar_code = #{bar_code,jdbcType=VARCHAR}
			</if>
			<if test="inva_date != null and inva_date != ''">
				AND inva_date = #{inva_date,jdbcType=DATE}
			</if>
			<if test="disinfect_date != null and disinfect_date != ''">
				AND disinfect_date = #{disinfect_date,jdbcType=DATE}
			</if>
			<if test="location_out_id != null and location_out_id != ''">
				AND location_out_id = #{location_out_id,jdbcType=INTEGER}
			</if>
			<if test="location_in_id != null and location_in_id != ''">
				AND location_in_id = #{location_in_id,jdbcType=CHAR}
			</if>
			<if test="note != null and note != ''">
				AND note = #{note,jdbcType=VARCHAR}
			</if>
		</where>
		order by tran_detail_id asc
	</select>

	<select id="queryMedAffiTranDetailByTranID" parameterType="java.util.Map" resultType="java.util.TreeMap">
		with w_mtd as(
			SELECT 
				mtd.group_id as group_id,
				mtd.hos_id as hos_id,
				mtd.copy_code as copy_code,
				mtd.tran_id as tran_id,
				mtd.tran_detail_id as tran_detail_id,
				mtd.inv_id as inv_id,
				mtd.inv_no as inv_no,
				mtd.batch_sn as batch_sn,
				mtd.batch_no as batch_no,
				mtd.price as price,
				mtd.amount as amount,
				mtd.sale_price as sale_price,
				mtd.sale_money as sale_money,
				mtd.sell_price as sell_price,
				mtd.sell_money as sell_money,
				mtd.allot_price as allot_price,
				mtd.allot_money as allot_money,
				mtd.amount_money as amount_money,
				mtd.bar_code as bar_code,
				mtd.inva_date as inva_date,
				mtd.disinfect_date as disinfect_date,
				mtd.location_out_id as location_out_id,
				mtd.location_in_id as location_in_id,
				mtd.note as note,
				mid.inv_code as inv_code,
				mid.inv_name as inv_name,
				mid.inv_model as inv_model,
				mid.unit_code as unit_code,
				hu.unit_name as unit_name,
				mldout.location_code as location_out_code,
				mldout.location_name as location_out_name,
				mldin.location_code as location_in_code,
				mldin.location_name as location_in_name,
				mfb.left_amount as cur_amount
			FROM med_affi_tran_detail mtd
			left join med_inv_dict mid 
				on mtd.group_id = mid.group_id and mtd.hos_id = mid.hos_id 
				and mtd.copy_code = mid.copy_code and mtd.inv_id = mid.inv_id 
				and mtd.inv_no = mid.inv_no
			LEFT JOIN hos_unit hu 
				ON mid.group_id = hu.group_id and mid.hos_id = hu.hos_id 
				and mid.unit_code = hu.unit_code 
			LEFT JOIN med_location_dict mldout 
				on mtd.group_id = mldout.group_id and mtd.hos_id = mldout.hos_id 
				and mtd.copy_code = mldout.copy_code and mtd.location_out_id = mldout.location_id 
				and mldout.is_stop=0
			LEFT JOIN med_location_dict mldin 
				on mtd.group_id = mldin.group_id and mtd.hos_id = mldin.hos_id 
				and mtd.copy_code = mldin.copy_code and mtd.location_in_id = mldin.location_id 
				and mldin.is_stop=0
			left join med_affi_fifo mfb 
				on mtd.group_id = mfb.group_id and mtd.hos_id = mfb.hos_id 
				and mtd.copy_code = mfb.copy_code and mtd.inv_id = mfb.inv_id 
				and mtd.batch_sn= mfb.batch_sn and mtd.batch_no = mfb.batch_no 
				and mtd.bar_code = mfb.bar_code and mfb.store_id = #{store_id,jdbcType=INTEGER}
			where mtd.group_id = #{group_id,jdbcType=INTEGER}
				AND mtd.hos_id = #{hos_id,jdbcType=INTEGER}
				AND mtd.copy_code = #{copy_code,jdbcType=VARCHAR}
				AND mtd.tran_id = #{tran_id,jdbcType=INTEGER}
			order by mtd.tran_detail_id asc             
		),
		w_mod as(
			select 
				inv_id,
				batch_sn,
				batch_no,
				bar_code,
				sum(amount) as amount
			from(
				--出库未确认单据
				select 
					inv_id as inv_id,
					batch_sn as batch_sn,
					batch_no as batch_no,
					bar_code as bar_code,
					sum(nvl(amount, 0)) as amount
				from med_affi_out mom 
				left join med_affi_out_detail medod
					on mom.group_id = medod.group_id and mom.hos_id = medod.hos_id 
					and mom.copy_code = medod.copy_code and mom.out_id = medod.out_id
				where medod.group_id = #{group_id,jdbcType=INTEGER}
					AND medod.hos_id = #{hos_id,jdbcType=INTEGER}
					AND medod.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND mom.store_id = #{store_id,jdbcType=INTEGER}
					AND NOT EXISTS(
						select 1 from med_affi_tran_rela 
						where group_id = #{group_id,jdbcType=INTEGER}
							and hos_id = #{hos_id,jdbcType=INTEGER}
							and copy_code = #{copy_code,jdbcType=VARCHAR}
							and tran_id = #{tran_id,jdbcType=INTEGER}
							and out_id = medod.out_id )
					<![CDATA[ 
					AND mom.state < 3 
					AND mom.bus_type_code <> '30' 
					]]>
				group by inv_id,batch_sn,batch_no,bar_code
				--退货未确认单据
				union all
				select 
					inv_id as inv_id,
					batch_sn as batch_sn,
					batch_no as batch_no,
					bar_code as bar_code,
					sum(nvl(amount, 0)) as amount
				from med_affi_in mim 
				left join med_affi_in_detail medid 
					on mim.group_id = medid.group_id and mim.hos_id = medid.hos_id 
					and mim.copy_code = medid.copy_code and mim.in_id = medid.in_id
				where medid.group_id = #{group_id,jdbcType=INTEGER}
					AND medid.hos_id = #{hos_id,jdbcType=INTEGER}
					AND medid.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND mim.store_id = #{store_id,jdbcType=INTEGER}
					<![CDATA[ 
					AND mim.state < 3 
					]]>
					AND mim.bus_type_code = '29'
				group by inv_id,batch_sn,batch_no,bar_code
			)
			group by inv_id, batch_sn, batch_no, bar_code
			order by inv_id asc
		)
		select 
			w_mtd.group_id as group_id,
			w_mtd.hos_id as hos_id,
			w_mtd.copy_code as copy_code,
			w_mtd.tran_id as tran_id,
			w_mtd.inv_id as inv_id,
			w_mtd.inv_no as inv_no,
			w_mtd.batch_no as batch_no,
			w_mtd.price as price,
			sum(nvl(w_mtd.cur_amount, 0)) as cur_amount, 
			sum(nvl(w_mtd.cur_amount, 0) - nvl(w_mod.amount, 0)) AS imme_amount,
			sum(nvl(w_mtd.amount, 0)) as amount,
			sum(nvl(w_mtd.amount_money, 0)) as amount_money,
			w_mtd.sale_price as sale_price,
			sum(nvl(w_mtd.sale_money, 0)) as sale_money,
			w_mtd.sell_price as sell_price,
			sum(nvl(w_mtd.sell_money, 0)) as sell_money,
			w_mtd.allot_price as allot_price,
			sum(nvl(w_mtd.allot_money, 0)) as allot_money,
			w_mtd.bar_code as bar_code,
			w_mtd.inva_date as inva_date,
			w_mtd.disinfect_date as disinfect_date,
			w_mtd.location_out_id as location_out_id,
			w_mtd.location_in_id as location_in_id,
			w_mtd.note as note,
			w_mtd.inv_code as inv_code,
			w_mtd.inv_name as inv_name,
			w_mtd.inv_model as inv_model,
			w_mtd.unit_code as unit_code,
			w_mtd.unit_name as unit_name,
			w_mtd.location_out_code as location_out_code,
			w_mtd.location_out_name as location_out_name,
			w_mtd.location_in_code as location_in_code,
			w_mtd.location_in_name as location_in_name,
			sum(nvl(w_mtd.amount, 0)) as sum_amount,
			'['||to_char(wm_concat('{"tran_detail_id":'||w_mtd.tran_detail_id||',"inv_id":'||w_mtd.inv_id
			||',"inv_code":"'||to_char(w_mtd.inv_code)||'","inv_name":"'||to_char(w_mtd.inv_name)
			||'","batch_sn":'||w_mtd.batch_sn||',"cur_amount":'||w_mtd.cur_amount
			||',"imme_amount":'||(nvl(w_mtd.cur_amount,0)-nvl(w_mod.amount,0))
			||',"amount":'||w_mtd.amount
			||',"price":'||w_mtd.price||',"amount_money":'||w_mtd.amount_money
			||',"sale_price":'||w_mtd.sale_price||',"sale_money":'||w_mtd.sale_money
			||',"sell_price":'||w_mtd.sell_price||',"sell_money":'||w_mtd.sell_money
			||'}'))||']' inv_detail_data
		from w_mtd w_mtd
		left join w_mod w_mod 
			on w_mtd.inv_id = w_mod.inv_id and  w_mtd.batch_sn= w_mod.batch_sn 
			and w_mtd.batch_no= w_mod.batch_no and w_mtd.bar_code= w_mod.bar_code
		group by
			w_mtd.group_id, w_mtd.hos_id, w_mtd.copy_code, w_mtd.tran_id, w_mtd.inv_id,
			w_mtd.inv_no, w_mtd.batch_no, w_mtd.price, w_mtd.sale_price, w_mtd.sell_price,
			w_mtd.allot_price, w_mtd.bar_code, w_mtd.inva_date, w_mtd.disinfect_date,
			w_mtd.location_out_id, w_mtd.location_in_id, w_mtd.note, w_mtd.inv_code, w_mtd.inv_name, 
			w_mtd.inv_model, w_mtd.unit_code, w_mtd.unit_name, w_mtd.location_out_code, 
			w_mtd.location_out_name, w_mtd.location_in_code, w_mtd.location_in_name
		order by inv_detail_data
	</select>
	
	<!-- 整单调拨  组装明细数据-->
	<select id="queryMedAffiTranDetailBySingle" parameterType="java.util.Map" resultType="java.util.TreeMap">
		with w_mod as(
			select 
				inv_id,
				batch_sn,
				batch_no,
				bar_code,
				sum(amount) as amount
			from(
				--出库未确认单据
				select 
					inv_id as inv_id,
					batch_sn as batch_sn,
					batch_no as batch_no,
					bar_code as bar_code,
					sum(nvl(amount, 0)) as amount
				from med_affi_out mom 
				left join med_affi_out_detail medod
					on mom.group_id = medod.group_id and mom.hos_id = medod.hos_id 
					and mom.copy_code = medod.copy_code and mom.out_id = medod.out_id
				where medod.group_id = #{group_id,jdbcType=INTEGER}
					AND medod.hos_id = #{hos_id,jdbcType=INTEGER}
					AND medod.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND mom.store_id = #{store_id,jdbcType=INTEGER}
					<![CDATA[ 
					AND mom.state < 3 
					AND mom.bus_type_code <> '30' 
					]]>
				group by inv_id,batch_sn,batch_no,bar_code
				--退货未确认单据
				union all
				select 
					inv_id as inv_id,
					batch_sn as batch_sn,
					batch_no as batch_no,
					bar_code as bar_code,
					sum(nvl(amount, 0)) as amount
				from med_affi_in mim 
				left join med_affi_in_detail medid 
					on mim.group_id = medid.group_id and mim.hos_id = medid.hos_id 
					and mim.copy_code = medid.copy_code and mim.in_id = medid.in_id
				where medid.group_id = #{group_id,jdbcType=INTEGER}
					AND medid.hos_id = #{hos_id,jdbcType=INTEGER}
					AND medid.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND mim.store_id = #{store_id,jdbcType=INTEGER}
					<![CDATA[ 
					AND mim.state < 3 
					]]>
					AND mim.bus_type_code = '29'
				group by inv_id,batch_sn,batch_no,bar_code
			)
			group by inv_id, batch_sn, batch_no, bar_code
			order by inv_id asc
		), 
		w_midet as(
			select midet.inv_id, 
			mid.inv_no, 
			mid.inv_code, 
			mid.inv_name,
			mtd.med_type_name, 
			mid.inv_model,
			hu.unit_name, 
			midet.batch_no, 
			midet.batch_sn, 
			midet.bar_code, 
			midet.price,
			nvl(midet.sale_price, 0) as sale_price,
			nvl(midet.sell_price, 0) as sell_price, 
			midet.inva_date, midet.disinfect_date,
			hfd.fac_name,
			midet.location_id as location_out_id, 
			mld.location_code as location_out_code,
			mld.location_name as location_out_name, 
			sum(nvl(mfb.left_amount, 0)) as cur_amount,
			sum(nvl(mfb.left_amount, 0) - nvl(w_mod.amount, 0)) as imme_amount,
			sum(nvl(mfb.left_amount, 0) - nvl(w_mod.amount, 0)) as amount
		from med_affi_in_detail midet
		left join med_affi_fifo mfb on midet.group_id = mfb.group_id 
			and midet.hos_id = mfb.hos_id
			and midet.copy_code = mfb.copy_code 
			and mfb.store_id = #{store_id,jdbcType=INTEGER}
			and midet.inv_id = mfb.inv_id 
			and midet.batch_no = mfb.batch_no
			and midet.batch_sn = mfb.batch_sn 
			and midet.bar_code = mfb.bar_code
		left join w_mod 
			on midet.inv_id = w_mod.inv_id 
			and midet.batch_no = w_mod.batch_no
			and midet.batch_sn = w_mod.batch_sn 
			and midet.bar_code = w_mod.bar_code
		left join med_inv_dict mid on midet.group_id = mid.group_id 
			and midet.hos_id = mid.hos_id
			and midet.copy_code = mid.copy_code 
			and midet.inv_id = mid.inv_id
			and mid.is_stop = 0
		left join med_type_dict mtd on midet.group_id = mtd.group_id 
			and midet.hos_id = mtd.hos_id
			and midet.copy_code = mtd.copy_code 
			and mid.med_type_id = mtd.med_type_id
			and mtd.is_stop = 0
		left join hos_fac_dict hfd on midet.group_id = hfd.group_id 
			and midet.hos_id = hfd.hos_id
			and mid.fac_id = hfd.fac_id and mid.fac_no = hfd.fac_no 
		LEFT JOIN hos_unit hu ON midet.group_id = hu.group_id 
			and midet.hos_id = hu.hos_id
			and mid.unit_code = hu.unit_code
		LEFT JOIN med_location_dict mld on midet.group_id = mld.group_id and midet.hos_id = mld.hos_id
			and midet.copy_code = mld.copy_code and midet.location_id = mld.location_id
			and mld.is_stop=0
		where midet.group_id = #{group_id,jdbcType=INTEGER}
			and midet.hos_id = #{hos_id,jdbcType=INTEGER}
			and midet.copy_code = #{copy_code,jdbcType=VARCHAR}
			<if test="sql!= null and sql != ''">
				${sql}
			</if>
		group by midet.inv_id, mid.inv_no, mid.inv_code, mid.inv_name, mtd.med_type_name, mid.inv_model,
			hu.unit_name, midet.batch_no, midet.batch_sn, midet.bar_code, midet.price,
			midet.sale_price, midet.sell_price, midet.inva_date, midet.disinfect_date, hfd.fac_name,
			midet.location_id, mld.location_code, mld.location_name
		having sum(nvl(mfb.left_amount, 0) - nvl(w_mod.amount, 0)) > 0
		order by mid.inv_code, midet.inva_date, midet.bar_code, midet.batch_sn
		)
		
		select inv_id, 
			inv_no, 
			inv_code, 
			inv_name, 
			med_type_name, 
			inv_model,
			unit_name, 
			batch_no,
			bar_code, 
			price, 
			sale_price, 
			sell_price, 
			inva_date, 
			disinfect_date, 
			fac_name,
			location_out_id,
			location_out_code, 
			location_out_name, 
			sum(cur_amount) cur_amount, 
			sum(imme_amount) as
			imme_amount,
			sum(amount) amount, 
			sum(amount * price) as amount_money, 
			sum(amount * sale_price) as sale_money,
			sum(amount * sell_price) as sell_money, sum(amount) sum_amount,
			'['||to_char(wm_concat('{"inv_id":'||inv_id||',"inv_code":"'||to_char(inv_code)||'","inv_name":"'||to_char(inv_name)
			||'","batch_sn":'||batch_sn||',"cur_amount":'||cur_amount
			||',"imme_amount":'||imme_amount||',"amount":'||amount
			||',"price":'||price||',"amount_money":'||(amount * price)
			||',"sale_price":'||sale_price||',"sale_money":'||(amount * sale_price)
			||',"sell_price":'||sell_price||',"sell_money":'||(amount * sell_price)
			||'}'))||']' inv_detail_data
		from w_midet
		group by inv_id, inv_no, inv_code, inv_name, med_type_name, inv_model, unit_name, batch_no, bar_code,
		price, sale_price, sell_price, inva_date, disinfect_date, fac_name, location_out_id, location_out_code, location_out_name
	</select>
	
	<!-- 查询要确认的出库数据 -->
	<select id="queryMedTranDetailForOutConfirm" parameterType="java.util.List" resultMap="medAffiTranDetail">
		SELECT
			a.group_id, a.hos_id, a.copy_code, a.out_store_id, 
			<!-- 如果确认日期走编制日期则放开注释
			a.year, 
			a.month, 
			 --> 
			b.inv_id, b.inv_no, c.inv_code, c.inv_name,
			b.batch_sn, b.batch_no, b.price, sum(b.amount) as amount, sum(b.amount_money) as
			amount_money,
			nvl(b.sell_price, 0) as sell_price, sum(nvl(b.sell_money, 0)) sell_money,
			nvl(b.sale_price, 0) as sale_price,
			sum(nvl(b.sale_money, 0)) as sale_money, b.bar_code, b.inva_date, b.disinfect_date,
			b.location_out_id, b.location_in_id
		FROM med_affi_tran_main a
		LEFT JOIN med_affi_tran_detail b on a.group_id = b.group_id and a.hos_id = b.hos_id
			and a.copy_code = b.copy_code and a.tran_id = b.tran_id
		LEFT JOIN MED_INV_DICT c on b.group_id = c.group_id and b.hos_id = c.hos_id
			and b.copy_code = c.copy_code and b.inv_id = c.inv_id
			and c.is_stop = 0
		WHERE
		<foreach collection="list" index="index" item="item" open="("
			separator="or" close=")">
			a.group_id = #{item.group_id,jdbcType=INTEGER}
			and a.hos_id = #{item.hos_id,jdbcType=INTEGER}
			and a.copy_code = #{item.copy_code,jdbcType=VARCHAR}
			and a.tran_id = #{item.tran_id,jdbcType=INTEGER}
		</foreach>
		group by a.group_id, a.hos_id, a.copy_code, a.out_store_id,
			<!-- 如果确认日期走编制日期则放开注释
			a.year, 
			a.month, 
			 --> 
			b.inv_id, b.inv_no, c.inv_code, c.inv_name, b.batch_sn,
			b.batch_no, b.price, b.sell_price, b.sale_price, b.bar_code,
			b.inva_date, b.disinfect_date, b.location_out_id, b.location_in_id
		order by b.inv_id asc
	</select>
	
	<!-- 查询要确认的入库数据 -->
	<select id="queryMedTranDetailForInConfirm" parameterType="java.util.List" resultMap="medAffiTranDetail">
		SELECT
			a.group_id, a.hos_id, a.copy_code, a.in_store_id, 
			<!-- 如果确认日期走编制日期则放开注释
			a.year, 
			a.month, 
			 --> 
			b.inv_id, b.inv_no, c.inv_code, c.inv_name,
			b.batch_sn, b.batch_no, b.price, sum(b.amount) as amount, sum(b.amount_money) as
			amount_money,
			nvl(b.sell_price, 0) as sell_price, sum(nvl(b.sell_money, 0)) sell_money,
			nvl(b.sale_price, 0) as sale_price,
			sum(nvl(b.sale_money, 0)) as sale_money, b.bar_code, b.inva_date, b.disinfect_date,
			b.location_out_id, b.location_in_id
		FROM med_affi_tran_main a
		LEFT JOIN med_affi_tran_detail b on a.group_id = b.group_id and a.hos_id = b.hos_id
			and a.copy_code = b.copy_code and a.tran_id = b.tran_id
		LEFT JOIN MED_INV_DICT c on b.group_id = c.group_id and b.hos_id = c.hos_id
			and b.copy_code = c.copy_code and b.inv_id = c.inv_id
			and c.is_stop = 0
		WHERE
		<foreach collection="list" index="index" item="item" open="("
			separator="or" close=")">
			a.group_id = #{item.group_id,jdbcType=INTEGER}
			and a.hos_id = #{item.hos_id,jdbcType=INTEGER}
			and a.copy_code = #{item.copy_code,jdbcType=VARCHAR}
			and a.tran_id = #{item.tran_id,jdbcType=INTEGER}
		</foreach>
		group by a.group_id, a.hos_id, a.copy_code, a.in_store_id, 
			<!-- 如果确认日期走编制日期则放开注释
			a.year, 
			a.month, 
			 --> 
			b.inv_id, b.inv_no, c.inv_code, c.inv_name, b.batch_sn,
			b.batch_no, b.price, b.sell_price, b.sale_price, b.bar_code,
			b.inva_date, b.disinfect_date, b.location_out_id, b.location_in_id
		order by b.inv_id asc
	</select>
	
</mapper>

