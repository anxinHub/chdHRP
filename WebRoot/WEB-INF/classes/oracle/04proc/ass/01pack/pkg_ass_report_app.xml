<?xml version="1.0" encoding="UTF-8" ?>
<root>

	<sql id="PKG_ASS_REPORT_APP" type="proc"><![CDATA[
	CREATE OR REPLACE PACKAGE pkg_ass_report_app AS
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_rep_submit
  || 功能描述 ：生成当月数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_rep_submit(prm_group_id  IN NUMBER --集团
                          ,prm_hos_id    IN NUMBER --医院
                          ,prm_copy_code IN VARCHAR2 --账套
                          ,prm_acc_year  IN VARCHAR2 --年度
                          ,prm_acc_month IN VARCHAR2 --月份
                           );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_load_data
  || 功能描述 ：加载当期卡片
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_load_data(prm_group_id  IN NUMBER --集团
                             ,prm_hos_id    IN NUMBER --医院
                             ,prm_copy_code IN VARCHAR2 --账套
                             ,prm_acc_year  IN VARCHAR2 --年度
                             ,prm_acc_month IN VARCHAR2 --月份
                              );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_price_in_add
  || 功能描述 ：生成当月采购入库增加数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_price_in_add(prm_group_id  IN NUMBER --集团
                                ,prm_hos_id    IN NUMBER --医院
                                ,prm_copy_code IN VARCHAR2 --账套
                                ,prm_acc_year  IN VARCHAR2 --年度
                                ,prm_acc_month IN VARCHAR2 --月份
                                 );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_price_out_dec
  || 功能描述 ：生成当月报废处置减少数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_price_out_dec(prm_group_id  IN NUMBER --集团
                                 ,prm_hos_id    IN NUMBER --医院
                                 ,prm_copy_code IN VARCHAR2 --账套
                                 ,prm_acc_year  IN VARCHAR2 --年度
                                 ,prm_acc_month IN VARCHAR2 --月份
                                  );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_price_change_add
  || 功能描述 ：生成当月原值变动增加数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_price_change_add(prm_group_id  IN NUMBER --集团
                                    ,prm_hos_id    IN NUMBER --医院
                                    ,prm_copy_code IN VARCHAR2 --账套
                                    ,prm_acc_year  IN VARCHAR2 --年度
                                    ,prm_acc_month IN VARCHAR2 --月份
                                     );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_price_change_dec
  || 功能描述 ：生成当月发送数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_price_change_dec(prm_group_id  IN NUMBER --集团
                                    ,prm_hos_id    IN NUMBER --医院
                                    ,prm_copy_code IN VARCHAR2 --账套
                                    ,prm_acc_year  IN VARCHAR2 --年度
                                    ,prm_acc_month IN VARCHAR2 --月份
                                     );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_depre_add
  || 功能描述 ：生成当月发送数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_depre_add(prm_group_id  IN NUMBER --集团
                             ,prm_hos_id    IN NUMBER --医院
                             ,prm_copy_code IN VARCHAR2 --账套
                             ,prm_acc_year  IN VARCHAR2 --年度
                             ,prm_acc_month IN VARCHAR2 --月份
                              );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_depre_dec
  || 功能描述 ：生成当月发送数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_depre_dec(prm_group_id  IN NUMBER --集团
                             ,prm_hos_id    IN NUMBER --医院
                             ,prm_copy_code IN VARCHAR2 --账套
                             ,prm_acc_year  IN VARCHAR2 --年度
                             ,prm_acc_month IN VARCHAR2 --月份
                              );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_depre_in_add
  || 功能描述 ：生成当月发送数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_depre_in_add(prm_group_id  IN NUMBER --集团
                                ,prm_hos_id    IN NUMBER --医院
                                ,prm_copy_code IN VARCHAR2 --账套
                                ,prm_acc_year  IN VARCHAR2 --年度
                                ,prm_acc_month IN VARCHAR2 --月份
                                 );

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_load_begin
  || 功能描述 ：更新当月期初数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_load_begin(prm_group_id  IN NUMBER --集团
                              ,prm_hos_id    IN NUMBER --医院
                              ,prm_copy_code IN VARCHAR2 --账套
                              ,prm_acc_year  IN VARCHAR2 --年度
                              ,prm_acc_month IN VARCHAR2 --月份
                               );
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_load_end
  || 功能描述 ：更新当月期末数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_load_end(prm_group_id  IN NUMBER --集团
                            ,prm_hos_id    IN NUMBER --医院
                            ,prm_copy_code IN VARCHAR2 --账套
                            ,prm_acc_year  IN VARCHAR2 --年度
                            ,prm_acc_month IN VARCHAR2 --月份
                             );

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_clear
  || 功能描述 ：清除无效数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_clear(prm_group_id  IN NUMBER --集团
                         ,prm_hos_id    IN NUMBER --医院
                         ,prm_copy_code IN VARCHAR2 --账套
                         ,prm_acc_year  IN VARCHAR2 --年度
                         ,prm_acc_month IN VARCHAR2 --月份
                          );
END pkg_ass_report_app;
	
	]]></sql>
	<sql id="PKG_ASS_REPORT_APP_BODY" type="proc"><![CDATA[
	CREATE OR REPLACE PACKAGE BODY pkg_ass_report_app AS

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_submit
  || 功能描述 ：生成当月数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_rep_submit(prm_group_id  IN NUMBER --集团
                          ,prm_hos_id    IN NUMBER --医院
                          ,prm_copy_code IN VARCHAR2 --账套
                          ,prm_acc_year  IN VARCHAR2 --年度
                          ,prm_acc_month IN VARCHAR2 --月份
                           ) IS
  BEGIN
    --加载数据 有先后顺序
    prc_ass_load_data(prm_group_id
                     ,prm_hos_id
                     ,prm_copy_code
                     ,prm_acc_year
                     ,prm_acc_month);
    --入库增加业务
    prc_ass_price_in_add(prm_group_id
                        ,prm_hos_id
                        ,prm_copy_code
                        ,prm_acc_year
                        ,prm_acc_month);
    --入库减少业务
    prc_ass_price_out_dec(prm_group_id
                         ,prm_hos_id
                         ,prm_copy_code
                         ,prm_acc_year
                         ,prm_acc_month);
    --原值变动增加业务                     
    prc_ass_price_change_add(prm_group_id
                            ,prm_hos_id
                            ,prm_copy_code
                            ,prm_acc_year
                            ,prm_acc_month);
    --原值变动减少业务
    prc_ass_price_change_dec(prm_group_id
                            ,prm_hos_id
                            ,prm_copy_code
                            ,prm_acc_year
                            ,prm_acc_month);
    --当期折旧增加
    prc_ass_depre_add(prm_group_id
                     ,prm_hos_id
                     ,prm_copy_code
                     ,prm_acc_year
                     ,prm_acc_month);
    --当期折旧减少
    prc_ass_depre_dec(prm_group_id
                     ,prm_hos_id
                     ,prm_copy_code
                     ,prm_acc_year
                     ,prm_acc_month);
    --当期入库折旧增加
    prc_ass_depre_in_add(prm_group_id
                        ,prm_hos_id
                        ,prm_copy_code
                        ,prm_acc_year
                        ,prm_acc_month);
    --载入期初数据
    prc_ass_load_begin(prm_group_id
                      ,prm_hos_id
                      ,prm_copy_code
                      ,prm_acc_year
                      ,prm_acc_month);
    --核算期末数据                  
    prc_ass_load_end(prm_group_id
                    ,prm_hos_id
                    ,prm_copy_code
                    ,prm_acc_year
                    ,prm_acc_month);
    --清理冗余垃圾数据
    prc_ass_clear(prm_group_id
                 ,prm_hos_id
                 ,prm_copy_code
                 ,prm_acc_year
                 ,prm_acc_month);
  
  END;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_load_data
  || 功能描述 ：加载当期卡片
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_load_data(prm_group_id  IN NUMBER --集团
                             ,prm_hos_id    IN NUMBER --医院
                             ,prm_copy_code IN VARCHAR2 --账套
                             ,prm_acc_year  IN VARCHAR2 --年度
                             ,prm_acc_month IN VARCHAR2 --月份
                              ) IS
  BEGIN
    --清除当期核算表 卡片表
    DELETE FROM ASS_SHARE_SOURCE_CARD;
    --原值变动表
    DELETE FROM ASS_SHARE_SOURCE_PRICE_CHANGE;
    --当期折旧表
    DELETE FROM ASS_SHARE_SOURCE_DEPRE;
  
    DELETE FROM ASS_COLLECT_MAIN_BUS_TYPE
     WHERE GROUP_ID = prm_group_id
       AND HOS_ID = prm_hos_id
       AND COPY_CODE = prm_copy_code
       AND acc_year || '' || acc_month =
           prm_acc_year || '' || prm_acc_month;
  
    --本期增加业务
    INSERT INTO ASS_SHARE_SOURCE_CARD（ASS_CARD_NO, SOURCE_ID, PRICE, USE_STATE, STORE_ID, ASS_TYPE_ID, BUY_TYPE)
      SELECT t1.ASS_CARD_NO
            ,t2.SOURCE_ID
            ,t2.PRICE
            ,t1.USE_STATE
            ,t1.proc_store_id
            ,t3.ass_type_id
            ,CASE
               WHEN use_state = 7 THEN
                to_char(t1.DISPOSE_TYPE)
               ELSE
                t1.BUY_TYPE
             END
        FROM v_ass_card t1
       INNER JOIN v_ass_resource t2
          ON t1.group_id = t2.group_id
         AND t1.hos_id = t2.hos_id
         AND t1.copy_code = t2.copy_code
         AND t1.ass_naturs = t2.ass_naturs
         AND t1.ASS_CARD_NO = t2.ASS_CARD_NO
        LEFT JOIN ass_dict t3
          ON t1.GROUP_ID = t3.group_id
         AND t1.HOS_ID = t3.hos_id
         AND t1.COPY_CODE = t3.copy_code
         AND t1.ASS_ID = t3.ass_id
       WHERE t1.USE_STATE > 0
         AND t1.GROUP_ID = prm_group_id
         AND t1.HOS_ID = prm_hos_id
         AND t1.COPY_CODE = prm_copy_code
         AND to_char(t1.in_date, 'yyyyMM') = prm_acc_year || prm_acc_month;
  
    INSERT INTO ASS_SHARE_SOURCE_PRICE_CHANGE
      (ASS_CARD_NO, SOURCE_ID, CHANGE_PRICE, CHANGE_DATE)
    
      SELECT b.ASS_CARD_NO, b.SOURCE_ID, sum(b.CHANGE_PRICE) CHANGE_PRICE, a.CHANGE_DATE
        FROM v_ass_change_main a
       INNER JOIN v_ass_change_source b
          ON a.group_id = b.group_id
         AND a.hos_id = b.hos_id
         AND a.copy_code = b.copy_code
         AND a.ass_naturs = b.ass_naturs
         AND a.CHANGE_NO = b.CHANGE_NO
       WHERE a.STATE = 2
         AND a.GROUP_ID = prm_group_id
         AND a.HOS_ID = prm_hos_id
         AND a.COPY_CODE = prm_copy_code
         AND to_char(a.CHANGE_DATE, 'yyyyMM') >=
             prm_acc_year || prm_acc_month
             group by b.ASS_CARD_NO, b.SOURCE_ID,a.CHANGE_DATE;
  
    --更新 仓库 资产分类  业务类型
    FOR re IN (SELECT ass_card_no, proc_store_id, ass_type_id, t1.BUY_TYPE
               
                 FROM v_ass_card t1
                 LEFT JOIN ass_dict t3
                   ON t1.GROUP_ID = t3.group_id
                  AND t1.HOS_ID = t3.hos_id
                  AND t1.COPY_CODE = t3.copy_code
                  AND t1.ASS_ID = t3.ass_id
                WHERE EXISTS (SELECT 1
                         FROM ASS_SHARE_SOURCE_PRICE_CHANGE t2
                        WHERE t1.ASS_CARD_NO = t2.ass_card_no)
                  AND t1.GROUP_ID = prm_group_id
                  AND t1.HOS_ID = prm_hos_id
                  AND t1.COPY_CODE = prm_copy_code)
    LOOP
    
      UPDATE ASS_SHARE_SOURCE_PRICE_CHANGE
         SET store_id    = re.proc_store_id
            ,ass_type_id = re.ass_type_id
            ,buy_type    = re.buy_type
      
       WHERE ass_card_no = re.ass_card_no;
    END LOOP;
    --加载本期折旧数据
    INSERT INTO ASS_SHARE_SOURCE_DEPRE
      (ASS_CARD_NO, SOURCE_ID, NOW_DEPRE_AMOUNT, ADD_DEPRE_AMOUNT)
      SELECT t1.ASS_CARD_NO
            ,t1.SOURCE_ID
            ,SUM(t1.NOW_DEPRE_AMOUNT)
            ,SUM(t1.ADD_DEPRE_AMOUNT)
      
        FROM V_ASS_DEPRE_ACC t1
      
       WHERE t1.GROUP_ID = prm_group_id
         AND t1.HOS_ID = prm_hos_id
         AND t1.COPY_CODE = prm_copy_code
         AND t1.DEPRE_YEAR = prm_acc_year
         AND t1.depre_month = prm_acc_month
       GROUP BY t1.ASS_CARD_NO, t1.SOURCE_ID;
  
    --更新仓库 和资产分类
    FOR re IN (SELECT ass_card_no, proc_store_id, ass_type_id, in_date
                 FROM v_ass_card t1
                 LEFT JOIN ass_dict t3
                   ON t1.GROUP_ID = t3.group_id
                  AND t1.HOS_ID = t3.hos_id
                  AND t1.COPY_CODE = t3.copy_code
                  AND t1.ASS_ID = t3.ass_id
                WHERE EXISTS (SELECT 1
                         FROM ASS_SHARE_SOURCE_DEPRE t2
                        WHERE t1.ASS_CARD_NO = t2.ass_card_no)
                  AND t1.GROUP_ID = prm_group_id
                  AND t1.HOS_ID = prm_hos_id
                  AND t1.COPY_CODE = prm_copy_code)
    LOOP
    
      UPDATE ASS_SHARE_SOURCE_DEPRE
         SET store_id    = re.proc_store_id
            ,ass_type_id = re.ass_type_id
            ,in_date     = re.in_date
       WHERE ass_card_no = re.ass_card_no;
    
    END LOOP;
  
  END;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_price_in_add
  || 功能描述 ：生成当月采购入库增加数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_price_in_add(prm_group_id  IN NUMBER --集团
                                ,prm_hos_id    IN NUMBER --医院
                                ,prm_copy_code IN VARCHAR2 --账套
                                ,prm_acc_year  IN VARCHAR2 --年度
                                ,prm_acc_month IN VARCHAR2 --月份
                                 ) IS
  BEGIN
    --还原当时原值
    FOR re IN (SELECT ASS_CARD_NO, SOURCE_ID, SUM(CHANGE_PRICE) CHANGE_PRICE
                 FROM ASS_SHARE_SOURCE_PRICE_CHANGE
                GROUP BY ASS_CARD_NO, SOURCE_ID)
    LOOP
      UPDATE ASS_SHARE_SOURCE_CARD
         SET price = price - re.change_price
       WHERE ASS_CARD_NO = re.ass_card_no
         AND SOURCE_ID = re.source_id;
    END LOOP;
  
    --添加增加业务
    INSERT INTO ASS_COLLECT_MAIN_BUS_TYPE
      (GROUP_ID
      ,HOS_ID
      ,COPY_CODE
      ,ACC_YEAR
      ,ACC_MONTH
      ,STORE_ID
      ,ASS_TYPE_ID
      ,BUS_TYPE
      ,BUS_NAME
      ,IN_OUT
      ,IS_FLAG
      ,ADD_MONEY
      ,DEC_MONEY)
      SELECT prm_group_id
            ,prm_hos_id
            ,prm_copy_code
            ,prm_acc_year
            ,prm_acc_month
            ,STORE_ID
            ,ASS_TYPE_ID
            ,buy_type
            ,bus_type_name
            ,0 IN_OUT
            ,0 IS_FLAG
            ,SUM(ADD_MONEY) ADD_MONEY
            ,SUM(DEC_MONEY) DEC_MONEY
        FROM (SELECT STORE_ID
                    ,ASS_TYPE_ID
                    ,buy_type
                    ,bus_type_name
                    ,price         ADD_MONEY
                    ,0             DEC_MONEY
                FROM ASS_SHARE_SOURCE_CARD card
                LEFT JOIN ass_bus_type_dict dict
                  ON card.buy_type = dict.bus_type_code
                 AND dict.group_id = prm_group_id
                 AND dict.hos_id = prm_hos_id
                 AND dict.copy_code = prm_copy_code
               WHERE card.use_state > 0
                 AND card.use_state < 7
              UNION ALL
              SELECT STORE_ID
                    ,ASS_TYPE_ID
                    ,'01' buy_type
                    ,'采购增加' bus_type_name
                    ,price ADD_MONEY
                    ,0 DEC_MONEY
                FROM ASS_SHARE_SOURCE_CARD card
               WHERE card.use_state = 7) t
       GROUP BY STORE_ID, ASS_TYPE_ID, BUY_TYPE, bus_type_name;
  
  END;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_price_out_dec
  || 功能描述 ：生成当月报废处置减少数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_price_out_dec(prm_group_id  IN NUMBER --集团
                                 ,prm_hos_id    IN NUMBER --医院
                                 ,prm_copy_code IN VARCHAR2 --账套
                                 ,prm_acc_year  IN VARCHAR2 --年度
                                 ,prm_acc_month IN VARCHAR2 --月份
                                  ) IS
  BEGIN
    --添加减少业务
    INSERT INTO ASS_COLLECT_MAIN_BUS_TYPE
      (GROUP_ID
      ,HOS_ID
      ,COPY_CODE
      ,ACC_YEAR
      ,ACC_MONTH
      ,STORE_ID
      ,ASS_TYPE_ID
      ,BUS_TYPE
      ,BUS_NAME
      ,IN_OUT
      ,IS_FLAG
      ,ADD_MONEY
      ,DEC_MONEY)
      SELECT prm_group_id
            ,prm_hos_id
            ,prm_copy_code
            ,prm_acc_year
            ,prm_acc_month
            ,STORE_ID
            ,ASS_TYPE_ID
            ,BUY_TYPE
            ,dispose_type_name
            ,1 IN_OUT
            ,0 IS_FLAG
            ,0 ADD_MONEY
            ,SUM(price) DEC_MONEY
        FROM ASS_SHARE_SOURCE_CARD card
        LEFT JOIN ass_dispose_type dict
          ON card.buy_type = dict.dispose_type_code
      
       WHERE card.use_state = 7
       GROUP BY STORE_ID, ASS_TYPE_ID, BUY_TYPE, dispose_type_name;
  
  END;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_price_change_add
  || 功能描述 ：生成当月原值变动增加数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_price_change_add(prm_group_id  IN NUMBER --集团
                                    ,prm_hos_id    IN NUMBER --医院
                                    ,prm_copy_code IN VARCHAR2 --账套
                                    ,prm_acc_year  IN VARCHAR2 --年度
                                    ,prm_acc_month IN VARCHAR2 --月份
                                     ) IS
  BEGIN
  
    --添加原值变动增加业务
    INSERT INTO ASS_COLLECT_MAIN_BUS_TYPE
      (GROUP_ID
      ,HOS_ID
      ,COPY_CODE
      ,ACC_YEAR
      ,ACC_MONTH
      ,STORE_ID
      ,ASS_TYPE_ID
      ,BUS_TYPE
      ,BUS_NAME
      ,IN_OUT
      ,IS_FLAG
      ,ADD_MONEY
      ,DEC_MONEY)
      SELECT prm_group_id
            ,prm_hos_id
            ,prm_copy_code
            ,prm_acc_year
            ,prm_acc_month
            ,STORE_ID
            ,ASS_TYPE_ID
            ,'24' buy_type
            ,'原值增加' buy_name
            ,0 IN_OUT
            ,0 IS_FLAG
            ,SUM(card.change_price) ADD_MONEY
            ,0 DEC_MONEY
        FROM ASS_SHARE_SOURCE_PRICE_CHANGE card
      
       WHERE to_char(card.CHANGE_DATE, 'yyyyMM') =
             prm_acc_year || '' || prm_acc_month
         AND card.change_price > 0
       GROUP BY STORE_ID, ASS_TYPE_ID;
  END;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_price_change_dec
  || 功能描述 ：生成当月发送数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_price_change_dec(prm_group_id  IN NUMBER --集团
                                    ,prm_hos_id    IN NUMBER --医院
                                    ,prm_copy_code IN VARCHAR2 --账套
                                    ,prm_acc_year  IN VARCHAR2 --年度
                                    ,prm_acc_month IN VARCHAR2 --月份
                                     ) IS
  BEGIN
    --添加原值变动减少业务
    INSERT INTO ASS_COLLECT_MAIN_BUS_TYPE
      (GROUP_ID
      ,HOS_ID
      ,COPY_CODE
      ,ACC_YEAR
      ,ACC_MONTH
      ,STORE_ID
      ,ASS_TYPE_ID
      ,BUS_TYPE
      ,BUS_NAME
      ,IN_OUT
      ,IS_FLAG
      ,ADD_MONEY
      ,DEC_MONEY)
      SELECT prm_group_id
            ,prm_hos_id
            ,prm_copy_code
            ,prm_acc_year
            ,prm_acc_month
            ,STORE_ID
            ,ASS_TYPE_ID
            ,'25' buy_type
            ,'原值减少' buy_name
            ,1 IN_OUT
            ,0 IS_FLAG
            ,0 ADD_MONEY
            ,SUM(card.change_price) DEC_MONEY
      
        FROM ASS_SHARE_SOURCE_PRICE_CHANGE card
      
       WHERE to_char(card.CHANGE_DATE, 'yyyyMM') =
             prm_acc_year || '' || prm_acc_month
         AND card.change_price < 0
       GROUP BY STORE_ID, ASS_TYPE_ID;
  END;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_depre_add
  || 功能描述 ：生成当月发送数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_depre_add(prm_group_id  IN NUMBER --集团
                             ,prm_hos_id    IN NUMBER --医院
                             ,prm_copy_code IN VARCHAR2 --账套
                             ,prm_acc_year  IN VARCHAR2 --年度
                             ,prm_acc_month IN VARCHAR2 --月份
                              ) IS
  BEGIN
    --添加折旧增加
    INSERT INTO ASS_COLLECT_MAIN_BUS_TYPE
      (GROUP_ID
      ,HOS_ID
      ,COPY_CODE
      ,ACC_YEAR
      ,ACC_MONTH
      ,STORE_ID
      ,ASS_TYPE_ID
      ,BUS_TYPE
      ,BUS_NAME
      ,IN_OUT
      ,IS_FLAG
      ,ADD_MONEY
      ,DEC_MONEY)
      SELECT prm_group_id
            ,prm_hos_id
            ,prm_copy_code
            ,prm_acc_year
            ,prm_acc_month
            ,STORE_ID
            ,ASS_TYPE_ID
            ,'26' buy_type
            ,'本期折旧增加' buy_name
            ,0 IN_OUT
            ,1 IS_FLAG
            ,SUM(card.now_depre_amount) ADD_MONEY
            ,0 DEC_MONEY
        FROM ASS_SHARE_SOURCE_DEPRE card
      
       WHERE card.now_depre_amount > 0
       GROUP BY STORE_ID, ASS_TYPE_ID;
  
  END;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_depre_dec
  || 功能描述 ：生成当月发送数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_depre_dec(prm_group_id  IN NUMBER --集团
                             ,prm_hos_id    IN NUMBER --医院
                             ,prm_copy_code IN VARCHAR2 --账套
                             ,prm_acc_year  IN VARCHAR2 --年度
                             ,prm_acc_month IN VARCHAR2 --月份
                              ) IS
  BEGIN
    --添加折旧减少
    INSERT INTO ASS_COLLECT_MAIN_BUS_TYPE
      (GROUP_ID
      ,HOS_ID
      ,COPY_CODE
      ,ACC_YEAR
      ,ACC_MONTH
      ,STORE_ID
      ,ASS_TYPE_ID
      ,BUS_TYPE
      ,BUS_NAME
      ,IN_OUT
      ,IS_FLAG
      ,ADD_MONEY
      ,DEC_MONEY)
      SELECT prm_group_id
            ,prm_hos_id
            ,prm_copy_code
            ,prm_acc_year
            ,prm_acc_month
            ,STORE_ID
            ,ASS_TYPE_ID
            ,'27' buy_type
            ,'本期折旧减少' buy_name
            ,1 IN_OUT
            ,1 IS_FLAG
            ,0 ADD_MONEY
            ,SUM(card.now_depre_amount) DEC_MONEY
        FROM ASS_SHARE_SOURCE_DEPRE card
      
       WHERE card.now_depre_amount < 0
       GROUP BY STORE_ID, ASS_TYPE_ID;
  END;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_depre_in_add
  || 功能描述 ：生成当月发送数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_depre_in_add(prm_group_id  IN NUMBER --集团
                                ,prm_hos_id    IN NUMBER --医院
                                ,prm_copy_code IN VARCHAR2 --账套
                                ,prm_acc_year  IN VARCHAR2 --年度
                                ,prm_acc_month IN VARCHAR2 --月份
                                 ) IS
  BEGIN
  
    --入库累计折旧增加
    INSERT INTO ASS_COLLECT_MAIN_BUS_TYPE
      (GROUP_ID
      ,HOS_ID
      ,COPY_CODE
      ,ACC_YEAR
      ,ACC_MONTH
      ,STORE_ID
      ,ASS_TYPE_ID
      ,BUS_TYPE
      ,BUS_NAME
      ,IN_OUT
      ,IS_FLAG
      ,ADD_MONEY
      ,DEC_MONEY)
      SELECT prm_group_id
            ,prm_hos_id
            ,prm_copy_code
            ,prm_acc_year
            ,prm_acc_month
            ,STORE_ID
            ,ASS_TYPE_ID
            ,'28' buy_type
            ,'入库折旧增加' buy_name
            ,0 IN_OUT
            ,1 IS_FLAG
            ,SUM(card.add_depre_amount - card.now_depre_amount) ADD_MONEY
            ,0 DEC_MONEY
        FROM ASS_SHARE_SOURCE_DEPRE card
       WHERE to_char(card.in_date, 'yyyyMM') =
             prm_acc_year || '' || prm_acc_month
         AND card.now_depre_amount <> card.add_depre_amount
      
       GROUP BY STORE_ID, ASS_TYPE_ID;
  
  END;

  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_load_begin
  || 功能描述 ：更新当月期初数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_load_begin(prm_group_id  IN NUMBER --集团
                              ,prm_hos_id    IN NUMBER --医院
                              ,prm_copy_code IN VARCHAR2 --账套
                              ,prm_acc_year  IN VARCHAR2 --年度
                              ,prm_acc_month IN VARCHAR2 --月份
                               ) IS
  
    up_year_month VARCHAR2(6); --上个月
    IS_FLAG       INTEGER;
  BEGIN
  
    --删除当月数据
    DELETE ASS_COLLECT_MAIN
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code
       AND acc_year = prm_acc_year
       AND acc_month = prm_acc_month;
  
    --初始化
    up_year_month := prm_acc_year || prm_acc_month;
  
    --取上一个年月
    SELECT get_year_or_month(prm_acc_year, prm_acc_month, -1, 'yyyyMM')
      INTO up_year_month
      FROM DUAL;
  
    --判断上一个月是否有数据 有数据则取上个月的期末数据，没有则取期初数据
  
    SELECT COUNT(*)
      INTO IS_FLAG
      FROM ASS_COLLECT_MAIN
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code
       AND acc_year = substr(up_year_month, 0, 4)
       AND acc_month = substr(up_year_month, 5, 6);
  
    IF IS_FLAG > 0
    THEN
      --插入期初数据
      INSERT INTO ASS_COLLECT_MAIN
        (GROUP_ID
        ,HOS_ID
        ,COPY_CODE
        ,ACC_YEAR
        ,ACC_MONTH
        ,STORE_ID
        ,ASS_TYPE_ID
        ,IS_FLAG
        ,BEGIN_MONEY
        ,ADD_MONEY
        ,DEC_MONEY
        ,END_MONEY)
        SELECT GROUP_ID
              ,HOS_ID
              ,COPY_CODE
              ,prm_acc_year
              ,prm_acc_month
              ,STORE_ID
              ,ASS_TYPE_ID
              ,IS_FLAG
              ,END_MONEY
              ,0
              ,0
              ,0
          FROM ASS_COLLECT_MAIN t2
         WHERE acc_year = substr(up_year_month, 0, 4)
           AND acc_month = substr(up_year_month, 5, 6);
    ELSE
      --原值
      INSERT INTO ASS_COLLECT_MAIN
        (GROUP_ID
        ,HOS_ID
        ,COPY_CODE
        ,ACC_YEAR
        ,ACC_MONTH
        ,STORE_ID
        ,ASS_TYPE_ID
        ,IS_FLAG
        ,BEGIN_MONEY
        ,ADD_MONEY
        ,DEC_MONEY
        ,END_MONEY)
        SELECT prm_group_id
              ,prm_hos_id
              ,prm_copy_code
              ,prm_acc_year
              ,prm_acc_month
              ,t2.proc_store_id
              ,t1.ass_type_id
              ,0
              ,SUM(t2.PRICE) price
              ,0
              ,0
              ,0
          FROM ass_no_dict t1
          LEFT JOIN v_ass_card_init t2
            ON t1.group_id = t2.GROUP_ID
           AND t1.hos_id = t2.HOS_ID
           AND t1.copy_code = t2.COPY_CODE
           AND t1.ass_id = t2.ASS_ID
           AND t1.ass_no = t2.ASS_NO
         WHERE t1.group_id = prm_group_id
           AND t1.hos_id = prm_hos_id
           AND t1.copy_code = prm_copy_code
           AND t2.USE_STATE NOT IN (6, 7, 8)
         GROUP BY t2.proc_store_id, t1.ass_type_id;
      --累计折旧
      INSERT INTO ASS_COLLECT_MAIN
        (GROUP_ID
        ,HOS_ID
        ,COPY_CODE
        ,ACC_YEAR
        ,ACC_MONTH
        ,STORE_ID
        ,ASS_TYPE_ID
        ,IS_FLAG
        ,BEGIN_MONEY
        ,ADD_MONEY
        ,DEC_MONEY
        ,END_MONEY)
        SELECT prm_group_id
              ,prm_hos_id
              ,prm_copy_code
              ,prm_acc_year
              ,prm_acc_month
              ,t2.proc_store_id
              ,t1.ass_type_id
              ,1
              ,SUM(t2.DEPRE_MONEY) DEPRE_MONEY
              ,0
              ,0
              ,0
          FROM ass_no_dict t1
          LEFT JOIN v_ass_card_init t2
            ON t1.group_id = t2.GROUP_ID
           AND t1.hos_id = t2.HOS_ID
           AND t1.copy_code = t2.COPY_CODE
           AND t1.ass_id = t2.ASS_ID
           AND t1.ass_no = t2.ASS_NO
         WHERE t1.group_id = prm_group_id
           AND t1.hos_id = prm_hos_id
           AND t1.copy_code = prm_copy_code
           AND t2.USE_STATE NOT IN (6, 7, 8)
         GROUP BY t2.proc_store_id, t1.ass_type_id;
    END IF;
  
    --插入不存在的分类和仓库 原值增加部分
    INSERT INTO ASS_COLLECT_MAIN
      (GROUP_ID
      ,HOS_ID
      ,COPY_CODE
      ,ACC_YEAR
      ,ACC_MONTH
      ,STORE_ID
      ,ASS_TYPE_ID
      ,IS_FLAG
      ,BEGIN_MONEY
      ,ADD_MONEY
      ,DEC_MONEY
      ,END_MONEY)
      SELECT GROUP_ID
            ,HOS_ID
            ,COPY_CODE
            ,prm_acc_year
            ,prm_acc_month
            ,STORE_ID
            ,ASS_TYPE_ID
            ,0
            ,0
            ,0
            ,0
            ,0
        FROM (SELECT a.group_id
                    ,a.hos_id
                    ,a.copy_code
                    ,ass_type_id
                    ,store_id
                FROM ass_type_dict a, hos_store b
               WHERE a.group_id = prm_group_id
                 AND a.hos_id = prm_hos_id
                 AND a.copy_code = prm_copy_code
                 AND a.is_last = 1
                 AND a.is_stop = 0) t1
       WHERE NOT EXISTS (SELECT 1
                FROM ASS_COLLECT_MAIN t2
               WHERE t1.group_id = t2.group_id
                 AND t1.hos_id = t2.hos_id
                 AND t1.copy_code = t2.copy_code
                 AND t1.store_id = t2.store_id
                 AND t1.ass_type_id = t2.ass_type_id
                 AND t2.group_id = prm_group_id
                 AND t2.hos_id = prm_hos_id
                 AND t2.copy_code = prm_copy_code
                 AND acc_year = prm_acc_year
                 AND acc_month = prm_acc_month);
    --复制 新增分类或者仓库 累计折旧增加部分
    INSERT INTO ASS_COLLECT_MAIN
      (GROUP_ID
      ,HOS_ID
      ,COPY_CODE
      ,ACC_YEAR
      ,ACC_MONTH
      ,STORE_ID
      ,ASS_TYPE_ID
      ,IS_FLAG
      ,BEGIN_MONEY
      ,ADD_MONEY
      ,DEC_MONEY
      ,END_MONEY)
      SELECT GROUP_ID
            ,HOS_ID
            ,COPY_CODE
            ,prm_acc_year
            ,prm_acc_month
            ,STORE_ID
            ,ASS_TYPE_ID
            ,1
            ,0
            ,0
            ,0
            ,0
        FROM ASS_COLLECT_MAIN
       WHERE hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND is_flag = 0
         AND begin_money = 0
         AND add_money = 0
         AND dec_money = 0
         AND end_money = 0;
  
  END;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_load_end
  || 功能描述 ：更新当月期末数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_load_end(prm_group_id  IN NUMBER --集团
                            ,prm_hos_id    IN NUMBER --医院
                            ,prm_copy_code IN VARCHAR2 --账套
                            ,prm_acc_year  IN VARCHAR2 --年度
                            ,prm_acc_month IN VARCHAR2 --月份
                             ) IS
  BEGIN
    FOR re IN (
               
               SELECT *
                 FROM ASS_COLLECT_MAIN_BUS_TYPE
                WHERE group_id = prm_group_id
                  AND hos_id = prm_hos_id
                  AND copy_code = prm_copy_code
                  AND acc_year = prm_acc_year
                  AND acc_month = prm_acc_month)
    LOOP
    
      UPDATE ASS_COLLECT_MAIN
         SET add_money = nvl(add_money, 0) + re.add_money
            ,dec_money = nvl(dec_money, 0) + re.dec_money
       WHERE group_id = prm_group_id
         AND hos_id = prm_hos_id
         AND copy_code = prm_copy_code
         AND acc_year = prm_acc_year
         AND acc_month = prm_acc_month
         AND ass_type_id = re.ass_type_id
         AND store_id = re.store_id
         AND is_flag = re.is_flag;
    
    END LOOP;
  
    --更新期末数据
    UPDATE ASS_COLLECT_MAIN
       SET end_money = nvl(begin_money, 0) + nvl(add_money, 0) -
                       nvl(dec_money, 0)
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code
       AND acc_year = prm_acc_year
       AND acc_month = prm_acc_month;
  
  END;
  /*-------------------------------------------------------------------------
  || 过程名称 ：prc_ass_clear
  || 功能描述 ：清除无效数据
  || 参数描述 ：参数标识          名称             输入/输出    类型
  ||            -------------------------------------------------------------
  ||            prm_group_id        集团             IN           NUMBER
  ||            prm_hos_id          医院             IN           NUMBER
  ||            prm_copy_code       账套             IN           VARCHAR2
  ||            prm_acc_year        年度             IN           VARCHAR2
  ||            prm_acc_month       月份             IN           VARCHAR2
  ||
  || 作    者 ：           完成日期 ：
  ||-------------------------------------------------------------------------
  || 修改记录 ：           修改日期：
  ||-------------------------------------------------------------------------*/
  PROCEDURE prc_ass_clear(prm_group_id  IN NUMBER --集团
                         ,prm_hos_id    IN NUMBER --医院
                         ,prm_copy_code IN VARCHAR2 --账套
                         ,prm_acc_year  IN VARCHAR2 --年度
                         ,prm_acc_month IN VARCHAR2 --月份
                          ) IS
  BEGIN
  
    DELETE ASS_COLLECT_MAIN
     WHERE group_id = prm_group_id
       AND hos_id = prm_hos_id
       AND copy_code = prm_copy_code
       AND acc_year = prm_acc_year
       AND acc_month = prm_acc_month
       AND begin_money = 0
       AND add_money = 0
       AND dec_money = 0
       AND end_money = 0;
  
  END;
END pkg_ass_report_app;
	]]></sql>
	
</root>

