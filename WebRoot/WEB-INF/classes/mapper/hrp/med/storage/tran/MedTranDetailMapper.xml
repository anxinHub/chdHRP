<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.med.dao.storage.tran.MedTranDetailMapper">
	
	<resultMap id="medTranDetail" type="com.chd.hrp.med.entity.MedTranDetail">
	<result property="group_id" column="group_id"/>
	<result property="hos_id" column="hos_id"/>
	<result property="copy_code" column="copy_code"/>
	<result property="bid_code" column="bid_code"/>
	<result property="year" column="year"/>
	<result property="month" column="month"/>
	<result property="tran_id" column="tran_id"/>
	<result property="tran_no" column="tran_no"/>
	<result property="out_store_id" column="out_store_id"/>
	<result property="in_store_id" column="in_store_id"/>
	<result property="tran_detail_id" column="tran_detail_id"/>
	<result property="inv_id" column="inv_id"/>
	<result property="inv_no" column="inv_no"/>
	<result property="inv_code" column="inv_code"/>
	<result property="inv_name" column="inv_name"/>
	<result property="batch_sn" column="batch_sn"/>
	<result property="batch_no" column="batch_no"/>
	<result property="amount" column="amount"/>
	<result property="price" column="price"/>
	<result property="amount_money" column="amount_money"/>
	<result property="sale_price" column="sale_price"/>
	<result property="sale_money" column="sale_money"/>
	<result property="sell_price" column="sell_price"/>
	<result property="sell_money" column="sell_money"/>
	<result property="allot_price" column="allot_price"/>
	<result property="allot_money" column="allot_money"/>
	<result property="pack_code" column="pack_code"/>
	<result property="num_exchange" column="num_exchange"/>
	<result property="pack_price" column="pack_price"/>
	<result property="num" column="num"/>
	<result property="bar_code" column="bar_code"/>
	<result property="inva_date" column="inva_date"/>
	<result property="disinfect_date" column="disinfect_date"/>
	<result property="location_out_id" column="location_out_id"/>
	<result property="location_in_id" column="location_in_id"/>
	<result property="note" column="note"/>
	</resultMap>
	
	<resultMap id="medTranDetailMap" type="java.util.Map">
		<result property="group_id" column="group_id"/>
		<result property="hos_id" column="hos_id"/>
		<result property="copy_code" column="copy_code"/>
		<result property="bid_code" column="bid_code"/>
		<result property="year" column="year"/>
		<result property="month" column="month"/>
		<result property="tran_id" column="tran_id"/>
		<result property="tran_no" column="tran_no"/>
		<result property="out_store_id" column="out_store_id"/>
		<result property="in_store_id" column="in_store_id"/>
		<result property="tran_detail_id" column="tran_detail_id"/>
		<result property="inv_id" column="inv_id"/>
		<result property="inv_no" column="inv_no"/>
		<result property="inv_code" column="inv_code"/>
		<result property="inv_name" column="inv_name"/>
		<result property="batch_sn" column="batch_sn"/>
		<result property="batch_no" column="batch_no"/>
		<result property="amount" column="amount"/>
		<result property="price" column="price"/>
		<result property="amount_money" column="amount_money"/>
		<result property="bar_code" column="bar_code"/>
		
		
		<!-- 主表数据列 -->
		<result property="brief" column="brief"/>
		<result property="tran_date" column="tran_date"/>
		<result property="out_hos_id" column="out_hos_id"/>
		<result property="out_hos_code" column="out_hos_code"/>
		<result property="out_hos_name" column="out_hos_name"/>
		<result property="out_store_id" column="out_store_id"/>
		<result property="out_store_no" column="out_store_no"/>
		<result property="out_store_code" column="out_store_code"/>
		<result property="out_store_name" column="out_store_name"/>
		<result property="out_id" column="out_id"/>
		<result property="out_no" column="out_no"/>
		<result property="in_hos_id" column="in_hos_id"/>
		<result property="in_hos_code" column="in_hos_code"/>
		<result property="in_hos_name" column="in_hos_name"/>
		<result property="in_store_id" column="in_store_id"/>
		<result property="in_store_no" column="in_store_no"/>
		<result property="in_store_code" column="in_store_code"/>
		<result property="in_store_name" column="in_store_name"/>
		<result property="in_id" column="in_id"/>
		<result property="in_no" column="in_no"/>
		<result property="maker" column="maker"/>
		<result property="maker_name" column="maker_name"/>
		<result property="checker" column="checker"/>
		<result property="checker_name" column="checker_name"/>
		<result property="check_date" column="check_date"/>
		<result property="confirmer_name" column="confirmer_name"/>
		<result property="confirm_date" column="confirm_date"/>
		<result property="state" column="state"/>
		<result property="inv_code" column="inv_code"/>
		<result property="inv_name" column="inv_name"/>
		<result property="inv_model" column="inv_model"/>
		<result property="unit_name" column="unit_name"/>
		<result property="fac_name" column="fac_name"/>
		<result property="batch_no" column="batch_no"/>
		<result property="bar_code" column="bar_code"/>
		<result property="amount" column="amount"/>
		<result property="price" column="price"/>
		<result property="amount_money" column="amount_money"/>
	</resultMap>
	
	<select id="queryMedTranDetailSeq"  resultType="java.lang.Long" useCache="false" flushCache="true">		
		select MED_TRAN_DETAIL_SEQ.nextval from dual
	</select>
	
	<insert id="add" useGeneratedKeys="true" >
	
		INSERT INTO MED_TRAN_DETAIL (
		<trim suffix="" suffixOverrides=",">
		<if test="group_id != null and group_id != ''">
		group_id
		,
		</if>
		<if test="hos_id != null and hos_id != ''">
		hos_id
		,
		</if>
		<if test="copy_code != null and copy_code != ''">
		copy_code
		,
		</if>
		<if test="tran_id != null and tran_id != ''">
		tran_id
		,
		</if>
		<if test="tran_no != null and tran_no != ''">
		tran_no
		,
		</if>
		<if test="tran_detail_id != null and tran_detail_id != ''">
		tran_detail_id
		,
		</if>
		<if test="inv_id != null and inv_id != ''">
		inv_id
		,
		</if>
		<if test="inv_no != null and inv_no != ''">
		inv_no
		,
		</if>
		<if test="batch_sn != null and batch_sn != ''">
		batch_sn
		,
		</if>
		<if test="batch_no != null and batch_no != ''">
		batch_no
		,
		</if>
		<if test="amount != null and amount != ''">
		amount
		,
		</if>
		<if test="price != null and price != ''">
		price
		,
		</if>
		<if test="amount_money != null and amount_money != ''">
		amount_money
		,
		</if>
		<if test="sale_price != null and sale_price != ''">
		sale_price
		,
		</if>
		<if test="sale_money != null and sale_money != ''">
		sale_money
		,
		</if>
		<if test="sell_price != null and sell_price != ''">
		sell_price
		,
		</if>
		<if test="sell_money != null and sell_money != ''">
		sell_money
		,
		</if>
		<if test="allot_price != null and allot_price != ''">
		allot_price
		,
		</if>
		<if test="allot_money != null and allot_money != ''">
		allot_money
		,
		</if>
		<if test="pack_code != null and pack_code != ''">
		pack_code
		,
		</if>
		<if test="num_exchange != null and num_exchange != ''">
		num_exchange
		,
		</if>
		<if test="pack_price != null and pack_price != ''">
		pack_price
		,
		</if>
		<if test="num != null and num != ''">
		num
		,
		</if>
		<if test="bar_code != null and bar_code != ''">
		bar_code
		,
		</if>
		<if test="inva_date != null and inva_date != ''">
		inva_date
		,
		</if>
		<if test="disinfect_date != null and disinfect_date != ''">
		disinfect_date
		,
		</if>
		<if test="location_out_id != null and location_out_id != ''">
		location_out_id
		,
		</if>
		<if test="location_in_id != null and location_in_id != ''">
		location_in_id
		,
		</if>
		<if test="note != null and note != ''">
		note
		,
		</if>
		</trim>
		) VALUES (
		<trim suffix="" suffixOverrides=",">
		<if test="group_id != null and group_id != ''">
		#{group_id,jdbcType=INTEGER}
		,
		</if>
		<if test="hos_id != null and hos_id != ''">
		#{hos_id,jdbcType=INTEGER}
		,
		</if>
		<if test="copy_code != null and copy_code != ''">
		#{copy_code,jdbcType=VARCHAR}
		,
		</if>
		<if test="tran_id != null and tran_id != ''">
		#{tran_id,jdbcType=INTEGER}
		,
		</if>
		<if test="tran_no != null and tran_no != ''">
		#{tran_no,jdbcType=INTEGER}
		,
		</if>
		<if test="tran_detail_id != null and tran_detail_id != ''">
		#{tran_detail_id,jdbcType=INTEGER}
		,
		</if>
		<if test="inv_id != null and inv_id != ''">
		#{inv_id,jdbcType=INTEGER}
		,
		</if>
		<if test="inv_no != null and inv_no != ''">
		#{inv_no,jdbcType=INTEGER}
		,
		</if>
		<if test="batch_sn != null and batch_sn != ''">
		#{batch_sn,jdbcType=INTEGER}
		,
		</if>
		<if test="batch_no != null and batch_no != ''">
		#{batch_no,jdbcType=VARCHAR}
		,
		</if>
		<if test="amount != null and amount != ''">
		#{amount,jdbcType=INTEGER}
		,
		</if>
		<if test="price != null and price != ''">
		#{price,jdbcType=INTEGER}
		,
		</if>
		<if test="amount_money != null and amount_money != ''">
		#{amount_money,jdbcType=INTEGER}
		,
		</if>
		<if test="sale_price != null and sale_price != ''">
		#{sale_price,jdbcType=INTEGER}
		,
		</if>
		<if test="sale_money != null and sale_money != ''">
		#{sale_money,jdbcType=INTEGER}
		,
		</if>
		<if test="sell_price != null and sell_price != ''">
		#{sell_price,jdbcType=INTEGER}
		,
		</if>
		<if test="sell_money != null and sell_money != ''">
		#{sell_money,jdbcType=INTEGER}
		,
		</if>
		<if test="allot_price != null and allot_price != ''">
		#{allot_price,jdbcType=INTEGER}
		,
		</if>
		<if test="allot_money != null and allot_money != ''">
		#{allot_money,jdbcType=INTEGER}
		,
		</if>
		<if test="pack_code != null and pack_code != ''">
		#{pack_code,jdbcType=VARCHAR}
		,
		</if>
		<if test="num_exchange != null and num_exchange != ''">
		#{num_exchange,jdbcType=INTEGER}
		,
		</if>
		<if test="pack_price != null and pack_price != ''">
		#{pack_price,jdbcType=INTEGER}
		,
		</if>
		<if test="num != null and num != ''">
		#{num,jdbcType=INTEGER}
		,
		</if>
		<if test="bar_code != null and bar_code != ''">
		#{bar_code,jdbcType=VARCHAR}
		,
		</if>
		<if test="inva_date != null and inva_date != ''">
		#{inva_date,jdbcType=DATE}
		,
		</if>
		<if test="disinfect_date != null and disinfect_date != ''">
		#{disinfect_date,jdbcType=DATE}
		,
		</if>
		<if test="location_out_id != null and location_out_id != ''">
		#{location_out_id,jdbcType=INTEGER}
		,
		</if>
		<if test="location_in_id != null and location_in_id != ''">
		#{location_in_id,jdbcType=CHAR}
		,
		</if>
		<if test="note != null and note != ''">
		#{note,jdbcType=VARCHAR}
		
		</if>
		</trim>		
		)
	
	</insert>
	<insert id="addBatch" parameterType="java.util.List" >
	
		INSERT INTO MED_TRAN_DETAIL (
		group_id,hos_id,copy_code,tran_id,tran_no,tran_detail_id,inv_id,inv_no,batch_sn,batch_no,amount,price,amount_money,sale_price,sale_money,sell_price,sell_money,
		allot_price,allot_money,pack_code,num_exchange,pack_price,num,bar_code,inva_date,disinfect_date,location_out_id,location_in_id,note
		) 
		<foreach collection="list" item="item" index="index" separator=" union all " >
			select 		
			#{item.group_id,jdbcType=INTEGER},
			#{item.hos_id,jdbcType=INTEGER},
			#{item.copy_code,jdbcType=VARCHAR},
			#{item.tran_id,jdbcType=INTEGER},
			#{item.tran_no,jdbcType=INTEGER},
			#{item.tran_detail_id,jdbcType=INTEGER},
			#{item.inv_id,jdbcType=INTEGER},
			#{item.inv_no,jdbcType=INTEGER},
			#{item.batch_sn,jdbcType=INTEGER},
			#{item.batch_no,jdbcType=VARCHAR},
			#{item.amount,jdbcType=INTEGER},
			#{item.price,jdbcType=INTEGER},
			#{item.amount_money,jdbcType=INTEGER},
			#{item.sale_price,jdbcType=INTEGER},
			#{item.sale_money,jdbcType=INTEGER},
			#{item.sell_price,jdbcType=INTEGER},
			#{item.sell_money,jdbcType=INTEGER},
			#{item.allot_price,jdbcType=INTEGER},
			#{item.allot_money,jdbcType=INTEGER},
			#{item.pack_code,jdbcType=VARCHAR},
			#{item.num_exchange,jdbcType=INTEGER},
			#{item.pack_price,jdbcType=INTEGER},
			#{item.num,jdbcType=INTEGER},
			#{item.bar_code,jdbcType=VARCHAR},
			to_date(#{item.inva_date},'yyyy/MM/dd'),
			to_date(#{item.disinfect_date},'yyyy/MM/dd'),
			#{item.location_out_id,jdbcType=INTEGER},
			#{item.location_in_id,jdbcType=INTEGER},
			#{item.note,jdbcType=VARCHAR}
		    from dual
		</foreach>
	</insert>
	
	<update id="update" parameterType="java.util.Map">
	
		UPDATE med_tran_detail 
		<trim prefix="SET"  suffixOverrides=","> 
		<if test="inv_id != null and inv_id != ''">
		inv_id = #{inv_id,jdbcType=INTEGER}
		,
		</if>
		<if test="inv_no != null and inv_no != ''">
		inv_no = #{inv_no,jdbcType=INTEGER}
		,
		</if>
		<if test="batch_sn != null and batch_sn != ''">
		batch_sn = #{batch_sn,jdbcType=INTEGER}
		,
		</if>
		<if test="batch_no != null and batch_no != ''">
		batch_no = #{batch_no,jdbcType=VARCHAR}
		,
		</if>
		<if test="amount != null and amount != ''">
		amount = #{amount,jdbcType=INTEGER}
		,
		</if>
		<if test="price != null">
		price = #{price,jdbcType=INTEGER}
		,
		</if>
		<if test="amount_money != null">
		amount_money = #{amount_money,jdbcType=INTEGER}
		,
		</if>
		<if test="sale_price != null">
		sale_price = #{sale_price,jdbcType=INTEGER}
		,
		</if>
		<if test="sale_money != null">
		sale_money = #{sale_money,jdbcType=INTEGER}
		,
		</if>
		<if test="sell_price != null">
		sell_price = #{sell_price,jdbcType=INTEGER}
		,
		</if>
		<if test="sell_money != null">
		sell_money = #{sell_money,jdbcType=INTEGER}
		,
		</if>
		<if test="allot_price != null">
		allot_price = #{allot_price,jdbcType=INTEGER}
		,
		</if>
		<if test="allot_money != null">
		allot_money = #{allot_money,jdbcType=INTEGER}
		,
		</if>
		<if test="pack_code != null">
		pack_code = #{pack_code,jdbcType=VARCHAR}
		,
		</if>
		<if test="num_exchange != null">
		num_exchange = #{num_exchange,jdbcType=INTEGER}
		,
		</if>
		<if test="pack_price != null">
		pack_price = #{pack_price,jdbcType=INTEGER}
		,
		</if>
		<if test="num != null">
		num = #{num,jdbcType=INTEGER}
		,
		</if>
		<if test="bar_code != null and bar_code != ''">
		bar_code = #{bar_code,jdbcType=VARCHAR}
		,
		</if>
		<if test="inva_date != null">
		inva_date = #{inva_date,jdbcType=DATE}
		,
		</if>
		<if test="disinfect_date != null">
		disinfect_date = #{disinfect_date,jdbcType=DATE}
		,
		</if>
		<if test="location_out_id != null">
		location_out_id = #{location_out_id,jdbcType=INTEGER}
		,
		</if>
		<if test="location_in_id != null">
		location_in_id = #{location_in_id,jdbcType=INTEGER}
		,
		</if>
		<if test="note != null">
		note = #{note,jdbcType=VARCHAR}
		,
		</if>
		</trim>
		<where>                     
		<if test="group_id != null and group_id != ''">
		AND group_id = #{group_id,jdbcType=INTEGER}
		</if>
		<if test="hos_id != null and hos_id != ''">
		AND hos_id = #{hos_id,jdbcType=INTEGER}
		</if>
		<if test="copy_code != null and copy_code != ''">
		AND copy_code = #{copy_code,jdbcType=VARCHAR}
		</if>
		<if test="tran_id != null and tran_id != ''">
		AND tran_id = #{tran_id,jdbcType=INTEGER}
		</if>
		<if test="tran_detail_id != null and tran_detail_id != ''">
		AND tran_detail_id = #{tran_detail_id,jdbcType=INTEGER}
		</if>
		<if test="inv_id != null and inv_id != ''">
		AND inv_id = #{inv_id,jdbcType=INTEGER}
		</if>
		<if test="inv_no != null and inv_no != ''">
		AND inv_no = #{inv_no,jdbcType=INTEGER}
		</if>
		<if test="batch_sn != null and batch_sn != ''">
		AND batch_sn = #{batch_sn,jdbcType=INTEGER}
		</if>
		<if test="batch_no != null and batch_no != ''">
		AND batch_no = #{batch_no,jdbcType=VARCHAR}
		</if>
		<if test="amount != null and amount != ''">
		AND amount = #{amount,jdbcType=INTEGER}
		</if>
		<if test="price != null and price != ''">
		AND price = #{price,jdbcType=INTEGER}
		</if>
		<if test="amount_money != null and amount_money != ''">
		AND amount_money = #{amount_money,jdbcType=INTEGER}
		</if>
		<if test="sale_price != null and sale_price != ''">
		AND sale_price = #{sale_price,jdbcType=INTEGER}
		</if>
		<if test="sale_money != null and sale_money != ''">
		AND sale_money = #{sale_money,jdbcType=INTEGER}
		</if>
		<if test="sell_price != null and sell_price != ''">
		AND sell_price = #{sell_price,jdbcType=INTEGER}
		</if>
		<if test="sell_money != null and sell_money != ''">
		AND sell_money = #{sell_money,jdbcType=INTEGER}
		</if>
		<if test="allot_price != null and allot_price != ''">
		AND allot_price = #{allot_price,jdbcType=INTEGER}
		</if>
		<if test="allot_money != null and allot_money != ''">
		AND allot_money = #{allot_money,jdbcType=INTEGER}
		</if>
		<if test="pack_code != null and pack_code != ''">
		AND pack_code = #{pack_code,jdbcType=VARCHAR}
		</if>
		<if test="num_exchange != null and num_exchange != ''">
		AND num_exchange = #{num_exchange,jdbcType=INTEGER}
		</if>
		<if test="pack_price != null and pack_price != ''">
		AND pack_price = #{pack_price,jdbcType=INTEGER}
		</if>
		<if test="num != null and num != ''">
		AND num = #{num,jdbcType=INTEGER}
		</if>
		<if test="bar_code != null and bar_code != ''">
		AND bar_code = #{bar_code,jdbcType=VARCHAR}
		</if>
		<if test="inva_date != null and inva_date != ''">
		AND inva_date = #{inva_date,jdbcType=DATE}
		</if>
		<if test="disinfect_date != null and disinfect_date != ''">
		AND disinfect_date = #{disinfect_date,jdbcType=DATE}
		</if>
		<if test="location_out_id != null and location_out_id != ''">
		AND location_out_id = #{location_out_id,jdbcType=INTEGER}
		</if>
		<if test="location_in_id != null and location_in_id != ''">
		AND location_in_id = #{location_in_id,jdbcType=CHAR}
		</if>
		<if test="note != null and note != ''">
		AND note = #{note,jdbcType=VARCHAR}
		</if>
		</where>  
	</update>
	<update id="updateBatch" parameterType="java.util.List">
	
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			UPDATE med_tran_detail 
			<trim prefix="SET"  suffixOverrides=","> 
			<if test="item.inv_id != null and item.inv_id != ''">inv_id = #{item.inv_id,jdbcType=INTEGER},</if>
			<if test="item.inv_no != null and item.inv_no != ''">inv_no = #{item.inv_no,jdbcType=INTEGER},</if>
			<if test="item.batch_sn != null and item.batch_sn != ''">batch_sn = #{item.batch_sn,jdbcType=INTEGER},</if>
			<if test="item.batch_no != null and item.batch_no != ''">batch_no = #{item.batch_no,jdbcType=VARCHAR},</if>
			<if test="item.amount != null and item.amount != ''">amount = #{item.amount,jdbcType=INTEGER},</if>
			<if test="item.price != null">price = #{item.price,jdbcType=INTEGER},</if>
			<if test="item.amount_money != null">amount_money = #{item.amount_money,jdbcType=INTEGER},</if>
			<if test="item.sale_price != null">sale_price = #{item.sale_price,jdbcType=INTEGER},</if>
			<if test="item.sale_money != null">sale_money = #{item.sale_money,jdbcType=INTEGER},</if>
			<if test="item.sell_price != null">sell_price = #{item.sell_price,jdbcType=INTEGER},</if>
			<if test="item.sell_money != null">sell_money = #{item.sell_money,jdbcType=INTEGER},</if>
			<if test="item.allot_price != null">allot_price = #{item.allot_price,jdbcType=INTEGER},</if>
			<if test="item.allot_money != null">allot_money = #{item.allot_money,jdbcType=INTEGER},</if>
			<if test="item.pack_code != null">pack_code = #{item.pack_code,jdbcType=VARCHAR},</if>
			<if test="item.num_exchange != null">num_exchange = #{item.num_exchange,jdbcType=INTEGER},</if>
			<if test="item.pack_price != null">pack_price = #{item.pack_price,jdbcType=INTEGER},</if>
			<if test="item.num != null">num = #{item.num,jdbcType=INTEGER},</if>
			<if test="item.bar_code != null and item.bar_code != ''">bar_code = #{item.bar_code,jdbcType=VARCHAR},</if>
			<if test="item.inva_date != null">inva_date = to_date(#{item.inva_date,jdbcType=VARCHAR},'yyyy/MM/dd'),</if>
			<if test="item.disinfect_date != null">disinfect_date = to_date(#{item.disinfect_date,jdbcType=VARCHAR},'yyyy/MM/dd'),</if>
			<if test="item.location_out_id != null">location_out_id = #{item.location_out_id,jdbcType=INTEGER},</if>
			<if test="item.location_in_id != null">location_in_id = #{item.location_in_id,jdbcType=CHAR},</if>
			<if test="item.note != null">note = #{item.note,jdbcType=VARCHAR},</if>
			</trim>
			<where>                     
			<if test="item.group_id != null and item.group_id != ''">AND group_id = #{item.group_id,jdbcType=INTEGER}</if>  
			<if test="item.hos_id != null and item.hos_id != ''">AND hos_id = #{item.hos_id,jdbcType=INTEGER}</if>  
			<if test="item.copy_code != null and item.copy_code != ''">AND copy_code = #{item.copy_code,jdbcType=VARCHAR}</if>  
			<if test="item.tran_id != null and item.tran_id != ''">AND tran_id = #{item.tran_id,jdbcType=INTEGER}</if>  
			<if test="item.tran_detail_id != null and item.tran_detail_id != ''">AND tran_detail_id = #{item.tran_detail_id,jdbcType=INTEGER}</if>  
			</where>  			
		</foreach>
	</update>
	
	<delete id="delete" parameterType="java.util.Map">
	
		DELETE FROM med_tran_detail 
		<where>                     
		<if test="group_id != null and group_id != ''">
		AND group_id = #{group_id,jdbcType=INTEGER}
		</if>
		<if test="hos_id != null and hos_id != ''">
		AND hos_id = #{hos_id,jdbcType=INTEGER}
		</if>
		<if test="copy_code != null and copy_code != ''">
		AND copy_code = #{copy_code,jdbcType=VARCHAR}
		</if>
		<if test="tran_id != null and tran_id != ''">
		AND tran_id = #{tran_id,jdbcType=INTEGER}
		</if>
		<if test="tran_detail_id != null and tran_detail_id != ''">
		AND tran_detail_id = #{tran_detail_id,jdbcType=INTEGER}
		</if>
		<if test="inv_id != null and inv_id != ''">
		AND inv_id = #{inv_id,jdbcType=INTEGER}
		</if>
		<if test="inv_no != null and inv_no != ''">
		AND inv_no = #{inv_no,jdbcType=INTEGER}
		</if>
		<if test="batch_sn != null and batch_sn != ''">
		AND batch_sn = #{batch_sn,jdbcType=INTEGER}
		</if>
		<if test="batch_no != null and batch_no != ''">
		AND batch_no = #{batch_no,jdbcType=VARCHAR}
		</if>
		<if test="amount != null and amount != ''">
		AND amount = #{amount,jdbcType=INTEGER}
		</if>
		<if test="price != null and price != ''">
		AND price = #{price,jdbcType=INTEGER}
		</if>
		<if test="amount_money != null and amount_money != ''">
		AND amount_money = #{amount_money,jdbcType=INTEGER}
		</if>
		<if test="sale_price != null and sale_price != ''">
		AND sale_price = #{sale_price,jdbcType=INTEGER}
		</if>
		<if test="sale_money != null and sale_money != ''">
		AND sale_money = #{sale_money,jdbcType=INTEGER}
		</if>
		<if test="sell_price != null and sell_price != ''">
		AND sell_price = #{sell_price,jdbcType=INTEGER}
		</if>
		<if test="sell_money != null and sell_money != ''">
		AND sell_money = #{sell_money,jdbcType=INTEGER}
		</if>
		<if test="allot_price != null and allot_price != ''">
		AND allot_price = #{allot_price,jdbcType=INTEGER}
		</if>
		<if test="allot_money != null and allot_money != ''">
		AND allot_money = #{allot_money,jdbcType=INTEGER}
		</if>
		<if test="pack_code != null and pack_code != ''">
		AND pack_code = #{pack_code,jdbcType=VARCHAR}
		</if>
		<if test="num_exchange != null and num_exchange != ''">
		AND num_exchange = #{num_exchange,jdbcType=INTEGER}
		</if>
		<if test="pack_price != null and pack_price != ''">
		AND pack_price = #{pack_price,jdbcType=INTEGER}
		</if>
		<if test="num != null and num != ''">
		AND num = #{num,jdbcType=INTEGER}
		</if>
		<if test="bar_code != null and bar_code != ''">
		AND bar_code = #{bar_code,jdbcType=VARCHAR}
		</if>
		<if test="inva_date != null and inva_date != ''">
		AND inva_date = #{inva_date,jdbcType=DATE}
		</if>
		<if test="disinfect_date != null and disinfect_date != ''">
		AND disinfect_date = #{disinfect_date,jdbcType=DATE}
		</if>
		<if test="location_out_id != null and location_out_id != ''">
		AND location_out_id = #{location_out_id,jdbcType=INTEGER}
		</if>
		<if test="location_in_id != null and location_in_id != ''">
		AND location_in_id = #{location_in_id,jdbcType=CHAR}
		</if>
		<if test="note != null and note != ''">
		AND note = #{note,jdbcType=VARCHAR}
		</if>
		</where>  
	</delete>
	<delete id="deleteBatch" parameterType="java.util.List">
		DELETE FROM med_tran_detail 
		<where>
			<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
				<if test="item.group_id != null and item.group_id != ''">
					group_id = #{item.group_id,jdbcType=INTEGER}
				</if>
				<if test="item.hos_id != null and item.hos_id != ''">
				AND hos_id = #{item.hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
				AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
				</if>
				<if test="item.tran_id != null and item.tran_id != ''">
				AND tran_id = #{item.tran_id,jdbcType=INTEGER}
				</if>
				<if test="item.tran_detail_id != null and item.tran_detail_id != ''">
				AND tran_detail_id = #{item.tran_detail_id,jdbcType=INTEGER}
				</if>
				<if test="item.inv_id != null and item.inv_id != ''">
				AND inv_id = #{item.inv_id,jdbcType=INTEGER}
				</if>
				<if test="item.inv_no != null and item.inv_no != ''">
				AND inv_no = #{item.inv_no,jdbcType=INTEGER}
				</if>
				<if test="item.batch_sn != null and item.batch_sn != ''">
				AND batch_sn = #{item.batch_sn,jdbcType=INTEGER}
				</if>
				<if test="item.batch_no != null and item.batch_no != ''">
				AND batch_no = #{item.batch_no,jdbcType=VARCHAR}
				</if>
				<if test="item.amount != null and item.amount != ''">
				AND amount = #{item.amount,jdbcType=INTEGER}
				</if>
				<if test="item.price != null and item.price != ''">
				AND price = #{item.price,jdbcType=INTEGER}
				</if>
				<if test="item.amount_money != null and item.amount_money != ''">
				AND amount_money = #{item.amount_money,jdbcType=INTEGER}
				</if>
				<if test="item.sale_price != null and item.sale_price != ''">
				AND sale_price = #{item.sale_price,jdbcType=INTEGER}
				</if>
				<if test="item.sale_money != null and item.sale_money != ''">
				AND sale_money = #{item.sale_money,jdbcType=INTEGER}
				</if>
				<if test="item.sell_price != null and item.sell_price != ''">
				AND sell_price = #{item.sell_price,jdbcType=INTEGER}
				</if>
				<if test="item.sell_money != null and item.sell_money != ''">
				AND sell_money = #{item.sell_money,jdbcType=INTEGER}
				</if>
				<if test="item.allot_price != null and item.allot_price != ''">
				AND allot_price = #{item.allot_price,jdbcType=INTEGER}
				</if>
				<if test="item.allot_money != null and item.allot_money != ''">
				AND allot_money = #{item.allot_money,jdbcType=INTEGER}
				</if>
				<if test="item.pack_code != null and item.pack_code != ''">
				AND pack_code = #{item.pack_code,jdbcType=VARCHAR}
				</if>
				<if test="item.num_exchange != null and item.num_exchange != ''">
				AND num_exchange = #{item.num_exchange,jdbcType=INTEGER}
				</if>
				<if test="item.pack_price != null and item.pack_price != ''">
				AND pack_price = #{item.pack_price,jdbcType=INTEGER}
				</if>
				<if test="item.num != null and item.num != ''">
				AND num = #{item.num,jdbcType=INTEGER}
				</if>
				<if test="item.bar_code != null and item.bar_code != ''">
				AND bar_code = #{item.bar_code,jdbcType=VARCHAR}
				</if>
				<if test="item.inva_date != null and item.inva_date != ''">
				AND inva_date = #{item.inva_date,jdbcType=DATE}
				</if>
				<if test="item.disinfect_date != null and item.disinfect_date != ''">
				AND disinfect_date = #{item.disinfect_date,jdbcType=DATE}
				</if>
				<if test="item.location_out_id != null and item.location_out_id != ''">
				AND location_out_id = #{item.location_out_id,jdbcType=INTEGER}
				</if>
				<if test="item.location_in_id != null and item.location_in_id != ''">
				AND location_in_id = #{item.location_in_id,jdbcType=CHAR}
				</if>
				<if test="item.note != null and item.note != ''">
				AND note = #{item.note,jdbcType=VARCHAR}
				</if>
			</foreach>
	    </where>  
	</delete>
	<select id="query" parameterType="java.util.Map" resultMap="medTranDetail" >
	
		SELECT 
		group_id,
		hos_id,
		copy_code,
		tran_id,
		tran_no,
		tran_detail_id,
		inv_id,
		inv_no,
		batch_sn,
		batch_no,
		amount,
		price,
		amount_money,
		sale_price,
		sale_money,
		sell_price,
		sell_money,
		allot_price,
		allot_money,
		pack_code,
		num_exchange,
		pack_price,
		num,
		bar_code,
		inva_date,
		disinfect_date,
		location_out_id,
		location_in_id,
		note
		FROM MED_TRAN_DETAIL 
		<where>                     
		<if test="group_id != null and group_id != ''">
		AND group_id = #{group_id,jdbcType=INTEGER}
		</if>
		<if test="hos_id != null and hos_id != ''">
		AND hos_id = #{hos_id,jdbcType=INTEGER}
		</if>
		<if test="copy_code != null and copy_code != ''">
		AND copy_code = #{copy_code,jdbcType=VARCHAR}
		</if>
		<if test="tran_id != null and tran_id != ''">
		AND tran_id = #{tran_id,jdbcType=INTEGER}
		</if>
		<if test="tran_detail_id != null and tran_detail_id != ''">
		AND tran_detail_id = #{tran_detail_id,jdbcType=INTEGER}
		</if>
		<if test="inv_id != null and inv_id != ''">
		AND inv_id = #{inv_id,jdbcType=INTEGER}
		</if>
		<if test="inv_no != null and inv_no != ''">
		AND inv_no = #{inv_no,jdbcType=INTEGER}
		</if>
		<if test="batch_sn != null and batch_sn != ''">
		AND batch_sn = #{batch_sn,jdbcType=INTEGER}
		</if>
		<if test="batch_no != null and batch_no != ''">
		AND batch_no = #{batch_no,jdbcType=VARCHAR}
		</if>
		<if test="amount != null and amount != ''">
		AND amount = #{amount,jdbcType=INTEGER}
		</if>
		<if test="price != null and price != ''">
		AND price = #{price,jdbcType=INTEGER}
		</if>
		<if test="amount_money != null and amount_money != ''">
		AND amount_money = #{amount_money,jdbcType=INTEGER}
		</if>
		<if test="sale_price != null and sale_price != ''">
		AND sale_price = #{sale_price,jdbcType=INTEGER}
		</if>
		<if test="sale_money != null and sale_money != ''">
		AND sale_money = #{sale_money,jdbcType=INTEGER}
		</if>
		<if test="sell_price != null and sell_price != ''">
		AND sell_price = #{sell_price,jdbcType=INTEGER}
		</if>
		<if test="sell_money != null and sell_money != ''">
		AND sell_money = #{sell_money,jdbcType=INTEGER}
		</if>
		<if test="allot_price != null and allot_price != ''">
		AND allot_price = #{allot_price,jdbcType=INTEGER}
		</if>
		<if test="allot_money != null and allot_money != ''">
		AND allot_money = #{allot_money,jdbcType=INTEGER}
		</if>
		<if test="pack_code != null and pack_code != ''">
		AND pack_code = #{pack_code,jdbcType=VARCHAR}
		</if>
		<if test="num_exchange != null and num_exchange != ''">
		AND num_exchange = #{num_exchange,jdbcType=INTEGER}
		</if>
		<if test="pack_price != null and pack_price != ''">
		AND pack_price = #{pack_price,jdbcType=INTEGER}
		</if>
		<if test="num != null and num != ''">
		AND num = #{num,jdbcType=INTEGER}
		</if>
		<if test="bar_code != null and bar_code != ''">
		AND bar_code = #{bar_code,jdbcType=VARCHAR}
		</if>
		<if test="inva_date != null and inva_date != ''">
		AND inva_date = #{inva_date,jdbcType=DATE}
		</if>
		<if test="disinfect_date != null and disinfect_date != ''">
		AND disinfect_date = #{disinfect_date,jdbcType=DATE}
		</if>
		<if test="location_out_id != null and location_out_id != ''">
		AND location_out_id = #{location_out_id,jdbcType=INTEGER}
		</if>
		<if test="location_in_id != null and location_in_id != ''">
		AND location_in_id = #{location_in_id,jdbcType=CHAR}
		</if>
		<if test="note != null and note != ''">
		AND note = #{note,jdbcType=VARCHAR}
		</if>
		</where>   
		order by tran_detail_id asc
	</select>
	<select id="queryByCode" resultMap="medTranDetail"  parameterType="java.util.Map" >
	
		SELECT 
		group_id,
		hos_id,
		copy_code,
		tran_id,
		tran_no,
		tran_detail_id,
		inv_id,
		inv_no,
		batch_sn,
		batch_no,
		amount,
		price,
		amount_money,
		sale_price,
		sale_money,
		sell_price,
		sell_money,
		allot_price,
		allot_money,
		pack_code,
		num_exchange,
		pack_price,
		num,
		bar_code,
		inva_date,
		disinfect_date,
		location_out_id,
		location_in_id,
		note
		FROM med_tran_detail 
		WHERE 
		group_id = #{group_id,jdbcType=INTEGER}   and 
		hos_id = #{hos_id,jdbcType=INTEGER}   and 
		copy_code = #{copy_code,jdbcType=VARCHAR}   and 
		tran_id = #{tran_id,jdbcType=INTEGER}   and 
		tran_detail_id = #{tran_detail_id,jdbcType=INTEGER} 
	
	</select>
	<select id="queryByUniqueness" resultMap="medTranDetail"  parameterType="java.util.Map" >
	
		SELECT 
		group_id,
		hos_id,
		copy_code,
		tran_id,
		tran_no,
		tran_detail_id,
		inv_id,
		inv_no,
		batch_sn,
		batch_no,
		amount,
		price,
		amount_money,
		sale_price,
		sale_money,
		sell_price,
		sell_money,
		allot_price,
		allot_money,
		pack_code,
		num_exchange,
		pack_price,
		num,
		bar_code,
		inva_date,
		disinfect_date,
		location_out_id,
		location_in_id,
		note
		FROM MED_TRAN_DETAIL 
		<where>                     
		<if test="group_id != null and group_id != ''">
		AND group_id = #{group_id,jdbcType=INTEGER}
		</if>
		<if test="hos_id != null and hos_id != ''">
		AND hos_id = #{hos_id,jdbcType=INTEGER}
		</if>
		<if test="copy_code != null and copy_code != ''">
		AND copy_code = #{copy_code,jdbcType=VARCHAR}
		</if>
		<if test="tran_id != null and tran_id != ''">
		AND tran_id = #{tran_id,jdbcType=INTEGER}
		</if>
		<if test="tran_detail_id != null and tran_detail_id != ''">
		AND tran_detail_id = #{tran_detail_id,jdbcType=INTEGER}
		</if>
		<if test="inv_id != null and inv_id != ''">
		AND inv_id = #{inv_id,jdbcType=INTEGER}
		</if>
		<if test="inv_no != null and inv_no != ''">
		AND inv_no = #{inv_no,jdbcType=INTEGER}
		</if>
		<if test="batch_sn != null and batch_sn != ''">
		AND batch_sn = #{batch_sn,jdbcType=INTEGER}
		</if>
		<if test="batch_no != null and batch_no != ''">
		AND batch_no = #{batch_no,jdbcType=VARCHAR}
		</if>
		<if test="amount != null and amount != ''">
		AND amount = #{amount,jdbcType=INTEGER}
		</if>
		<if test="price != null and price != ''">
		AND price = #{price,jdbcType=INTEGER}
		</if>
		<if test="amount_money != null and amount_money != ''">
		AND amount_money = #{amount_money,jdbcType=INTEGER}
		</if>
		<if test="sale_price != null and sale_price != ''">
		AND sale_price = #{sale_price,jdbcType=INTEGER}
		</if>
		<if test="sale_money != null and sale_money != ''">
		AND sale_money = #{sale_money,jdbcType=INTEGER}
		</if>
		<if test="sell_price != null and sell_price != ''">
		AND sell_price = #{sell_price,jdbcType=INTEGER}
		</if>
		<if test="sell_money != null and sell_money != ''">
		AND sell_money = #{sell_money,jdbcType=INTEGER}
		</if>
		<if test="allot_price != null and allot_price != ''">
		AND allot_price = #{allot_price,jdbcType=INTEGER}
		</if>
		<if test="allot_money != null and allot_money != ''">
		AND allot_money = #{allot_money,jdbcType=INTEGER}
		</if>
		<if test="pack_code != null and pack_code != ''">
		AND pack_code = #{pack_code,jdbcType=VARCHAR}
		</if>
		<if test="num_exchange != null and num_exchange != ''">
		AND num_exchange = #{num_exchange,jdbcType=INTEGER}
		</if>
		<if test="pack_price != null and pack_price != ''">
		AND pack_price = #{pack_price,jdbcType=INTEGER}
		</if>
		<if test="num != null and num != ''">
		AND num = #{num,jdbcType=INTEGER}
		</if>
		<if test="bar_code != null and bar_code != ''">
		AND bar_code = #{bar_code,jdbcType=VARCHAR}
		</if>
		<if test="inva_date != null and inva_date != ''">
		AND inva_date = #{inva_date,jdbcType=DATE}
		</if>
		<if test="disinfect_date != null and disinfect_date != ''">
		AND disinfect_date = #{disinfect_date,jdbcType=DATE}
		</if>
		<if test="location_out_id != null and location_out_id != ''">
		AND location_out_id = #{location_out_id,jdbcType=INTEGER}
		</if>
		<if test="location_in_id != null and location_in_id != ''">
		AND location_in_id = #{location_in_id,jdbcType=CHAR}
		</if>
		<if test="note != null and note != ''">
		AND note = #{note,jdbcType=VARCHAR}
		</if>
		</where>   
		order by tran_detail_id asc
	</select>
	<select id="queryExists" resultMap="medTranDetail"  parameterType="java.util.Map" >
	
		SELECT 
		group_id,
		hos_id,
		copy_code,
		tran_id,
		tran_no,
		tran_detail_id,
		inv_id,
		inv_no,
		batch_sn,
		batch_no,
		amount,
		price,
		amount_money,
		sale_price,
		sale_money,
		sell_price,
		sell_money,
		allot_price,
		allot_money,
		pack_code,
		num_exchange,
		pack_price,
		num,
		bar_code,
		inva_date,
		disinfect_date,
		location_out_id,
		location_in_id,
		note
		FROM MED_TRAN_DETAIL 
		<where>                     
		<if test="group_id != null and group_id != ''">
		AND group_id = #{group_id,jdbcType=INTEGER}
		</if>
		<if test="hos_id != null and hos_id != ''">
		AND hos_id = #{hos_id,jdbcType=INTEGER}
		</if>
		<if test="copy_code != null and copy_code != ''">
		AND copy_code = #{copy_code,jdbcType=VARCHAR}
		</if>
		<if test="tran_id != null and tran_id != ''">
		AND tran_id = #{tran_id,jdbcType=INTEGER}
		</if>
		<if test="tran_detail_id != null and tran_detail_id != ''">
		AND tran_detail_id = #{tran_detail_id,jdbcType=INTEGER}
		</if>
		<if test="inv_id != null and inv_id != ''">
		AND inv_id = #{inv_id,jdbcType=INTEGER}
		</if>
		<if test="inv_no != null and inv_no != ''">
		AND inv_no = #{inv_no,jdbcType=INTEGER}
		</if>
		<if test="batch_sn != null and batch_sn != ''">
		AND batch_sn = #{batch_sn,jdbcType=INTEGER}
		</if>
		<if test="batch_no != null and batch_no != ''">
		AND batch_no = #{batch_no,jdbcType=VARCHAR}
		</if>
		<if test="amount != null and amount != ''">
		AND amount = #{amount,jdbcType=INTEGER}
		</if>
		<if test="price != null and price != ''">
		AND price = #{price,jdbcType=INTEGER}
		</if>
		<if test="amount_money != null and amount_money != ''">
		AND amount_money = #{amount_money,jdbcType=INTEGER}
		</if>
		<if test="sale_price != null and sale_price != ''">
		AND sale_price = #{sale_price,jdbcType=INTEGER}
		</if>
		<if test="sale_money != null and sale_money != ''">
		AND sale_money = #{sale_money,jdbcType=INTEGER}
		</if>
		<if test="sell_price != null and sell_price != ''">
		AND sell_price = #{sell_price,jdbcType=INTEGER}
		</if>
		<if test="sell_money != null and sell_money != ''">
		AND sell_money = #{sell_money,jdbcType=INTEGER}
		</if>
		<if test="allot_price != null and allot_price != ''">
		AND allot_price = #{allot_price,jdbcType=INTEGER}
		</if>
		<if test="allot_money != null and allot_money != ''">
		AND allot_money = #{allot_money,jdbcType=INTEGER}
		</if>
		<if test="pack_code != null and pack_code != ''">
		AND pack_code = #{pack_code,jdbcType=VARCHAR}
		</if>
		<if test="num_exchange != null and num_exchange != ''">
		AND num_exchange = #{num_exchange,jdbcType=INTEGER}
		</if>
		<if test="pack_price != null and pack_price != ''">
		AND pack_price = #{pack_price,jdbcType=INTEGER}
		</if>
		<if test="num != null and num != ''">
		AND num = #{num,jdbcType=INTEGER}
		</if>
		<if test="bar_code != null and bar_code != ''">
		AND bar_code = #{bar_code,jdbcType=VARCHAR}
		</if>
		<if test="inva_date != null and inva_date != ''">
		AND inva_date = #{inva_date,jdbcType=DATE}
		</if>
		<if test="disinfect_date != null and disinfect_date != ''">
		AND disinfect_date = #{disinfect_date,jdbcType=DATE}
		</if>
		<if test="location_out_id != null and location_out_id != ''">
		AND location_out_id = #{location_out_id,jdbcType=INTEGER}
		</if>
		<if test="location_in_id != null and location_in_id != ''">
		AND location_in_id = #{location_in_id,jdbcType=CHAR}
		</if>
		<if test="note != null and note != ''">
		AND note = #{note,jdbcType=VARCHAR}
		</if>
		</where>   
		order by tran_detail_id asc
	</select>
	
	<select id="queryMedTranDetailByTranID"  parameterType="java.util.Map"  resultType="java.util.TreeMap">
		with tmp_imme as(
			select 
				inv_id, batch_sn, batch_no, bar_code, sum(amount) as amount
			from(
				--出库未确认单据
				select 
					inv_id, batch_sn, batch_no, bar_code, sum(nvl(amount, 0)) as amount
				from med_out_main mom 
				left join med_out_detail medod 
					on mom.group_id = medod.group_id and mom.hos_id = medod.hos_id 
					and mom.copy_code = medod.copy_code and mom.out_id = medod.out_id
				where medod.group_id = #{group_id,jdbcType=INTEGER}
					AND medod.hos_id = #{hos_id,jdbcType=INTEGER}
					AND medod.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND mom.store_id = #{store_id,jdbcType=INTEGER}
					AND NOT EXISTS(
						select 1 from med_tran_rela 
						where group_id = #{group_id,jdbcType=INTEGER}
							and hos_id = #{hos_id,jdbcType=INTEGER}
							and copy_code = #{copy_code,jdbcType=VARCHAR}
							and tran_id = #{tran_id,jdbcType=INTEGER}
							and out_id = medod.out_id )
					<![CDATA[
					AND mom.state < 3 
					AND mom.bus_type_code <> '21'
					AND medod.amount_money > 0
					]]>
				group by inv_id, batch_sn, batch_no, bar_code
				--退货未确认单据
				union all
				select 
					inv_id, batch_sn, batch_no, bar_code, -1 * sum(nvl(amount, 0)) as amount
				from med_in_main mim
				left join  med_in_detail medid
					on mim.group_id = medid.group_id and mim.hos_id = medid.hos_id 
					and mim.copy_code = medid.copy_code and mim.in_id = medid.in_id
				where medid.group_id = #{group_id,jdbcType=INTEGER}
					AND medid.hos_id = #{hos_id,jdbcType=INTEGER}
					AND medid.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND mim.store_id = #{store_id,jdbcType=INTEGER}
					<![CDATA[ AND mim.state < 3 ]]>
					AND mim.bus_type_code in ('10','12','16','22')
					<![CDATA[ AND medid.amount_money < 0 ]]>
				group by inv_id, batch_sn, batch_no, bar_code
			)
			group by inv_id, batch_sn, batch_no, bar_code
			order by inv_id asc
		), 
		tmp_detail as(
			SELECT 
				mtd.group_id,
				mtd.hos_id,
				mtd.copy_code,
				mtd.tran_id,
				mtd.tran_detail_id,
				mtd.inv_id,
				mtd.inv_no,
				mtd.batch_sn,
				mtd.batch_no,
				mtd.price,
				mtd.amount,
				mtd.sale_price,
				mtd.sale_money,
				mtd.sell_price,
				mtd.sell_money,
				mtd.allot_price,
				mtd.allot_money,
				mtd.amount_money,
				mtd.bar_code,
				mtd.inva_date,
				mtd.disinfect_date,
				mtd.location_out_id,
				mtd.location_in_id,
				mtd.note as note,
				mfb.left_amount as cur_amount, 
				mfb.left_amount - nvl(imme.amount, 0) AS imme_amount
			FROM med_tran_detail mtd
			left join med_fifo_balance mfb 
				on mtd.group_id = mfb.group_id and mtd.hos_id = mfb.hos_id 
				and mtd.copy_code = mfb.copy_code and mtd.inv_id = mfb.inv_id 
				and mtd.batch_sn= mfb.batch_sn and mtd.batch_no = mfb.batch_no 
				and mtd.bar_code = mfb.bar_code and mfb.store_id = #{store_id,jdbcType=INTEGER}
			LEFT JOIN tmp_imme imme
				on mtd.inv_id = imme.inv_id and mtd.batch_no = imme.batch_no 
				and mtd.batch_sn = imme.batch_sn and mtd.bar_code = imme.bar_code
			where mtd.group_id = #{group_id,jdbcType=INTEGER}
				AND mtd.hos_id = #{hos_id,jdbcType=INTEGER}
				AND mtd.copy_code = #{copy_code,jdbcType=VARCHAR}
				AND mtd.tran_id = #{tran_id,jdbcType=INTEGER}
			order by mtd.tran_detail_id asc             
		), 
		tmp_main AS(
			SELECT main.group_id, main.hos_id, main.copy_code, main.tran_id, main.inv_id, main.inv_no, 
				main.batch_no, main.bar_code, main.inva_date, main.disinfect_date, main.location_out_id, 
				main.location_in_id, main.note, main.price, main.amount, main.amount_money, main.sale_price, 
				main.sale_money, main.sell_price, main.sell_money, main.allot_price, main.allot_money, 
				SUM(mfb.left_amount) AS cur_amount, SUM(mfb.left_amount) - main.out_amount as imme_amount
			FROM (
				SELECT detail.*, nvl(imme.amount, 0) as out_amount
				FROM (
					SELECT group_id, hos_id, copy_code, tran_id, inv_id, inv_no, batch_no, bar_code, inva_date, 
						disinfect_date, location_out_id, location_in_id, note, price, SUM(amount) AS amount, 
						SUM(amount_money) AS amount_money, sale_price, SUM(sale_money) AS sale_money, sell_price, 
						SUM(sell_money) AS sell_money, allot_price, SUM(allot_money) AS allot_money 
					FROM tmp_detail
					GROUP BY group_id, hos_id, copy_code, tran_id, inv_id, inv_no, batch_no, bar_code, inva_date, 
						disinfect_date, location_out_id, location_in_id, note, price, sell_price, sale_price, allot_price
				) detail
				LEFT JOIN (
					SELECT inv_id, batch_no, bar_code, SUM(amount) AS amount 
					FROM tmp_imme 
					GROUP BY inv_id, batch_no, bar_code
				) imme
					ON detail.inv_id = imme.inv_id
					AND detail.batch_no = imme.batch_no
					AND detail.bar_code = imme.bar_code
			) main
			LEFT JOIN med_fifo_balance mfb 
				ON main.group_id = mfb.group_id
				AND main.hos_id = mfb.hos_id
				AND main.copy_code = mfb.copy_code
				AND main.inv_id = mfb.inv_id
				AND main.batch_no = mfb.batch_no
				AND main.bar_code = mfb.bar_code
				AND mfb.store_id = #{store_id,jdbcType=INTEGER}
			GROUP BY main.group_id, main.hos_id, main.copy_code, main.tran_id, main.inv_id, main.inv_no, 
				main.batch_no, main.bar_code, main.inva_date, main.disinfect_date, main.location_out_id, 
				main.location_in_id, main.note, main.price, main.amount, main.amount_money, main.sale_price, 
				main.sale_money, main.sell_price, main.sell_money, main.allot_price, main.allot_money, main.out_amount
		)
		select main.group_id, main.hos_id, main.copy_code, mid.bid_code, main.tran_id
	, main.inv_id, main.inv_no, main.batch_no, main.price, main.cur_amount
	, main.imme_amount, main.amount, main.amount_money, main.sale_price, main.sale_money
	, main.sell_price, main.sell_money, main.allot_price, main.allot_money, main.bar_code
	, main.inva_date, main.disinfect_date, msi.location_id location_new_id, main.location_in_id, main.note
	, mid.inv_code, mid.inv_name, mid.inv_model, mid.unit_code, hu.unit_name
	, hf.fac_name, mldout.location_code as location_new_code, mldout.location_name as location_new_name, mldin.location_code as location_in_code, mldin.location_name as location_in_name
	, main.amount as sum_amount, '[' || to_char(wm_concat('{"tran_detail_id":' || detail.tran_detail_id || ',"inv_id":' || detail.inv_id || ',"inv_code":"' || to_char(mid.inv_code) || '","inv_name":"' || to_char(mid.inv_name) || '","batch_sn":' || detail.batch_sn || ',"cur_amount":' || detail.cur_amount || ',"imme_amount":' || detail.imme_amount || ',"amount":' || detail.amount || ',"price":' || detail.price || ',"amount_money":' || detail.amount_money || ',"sale_price":' || detail.sale_price || ',"sale_money":' || detail.sale_money || ',"sell_price":' || detail.sell_price || ',"sell_money":' || detail.sell_money || '}')) || ']' as inv_detail_data
			from tmp_main main
			left join med_inv_dict mid on main.group_id = mid.group_id
			and main.hos_id = mid.hos_id
			and main.copy_code = mid.copy_code
			and main.inv_id = mid.inv_id
			and main.inv_no = mid.inv_no 
			left join hos_fac_dict hf on hf.group_id = mid.group_id
			and hf.hos_id = mid.hos_id
			and hf.fac_id = mid.fac_id
			and hf.fac_no = mid.fac_no
			left join hos_unit hu on mid.group_id = hu.group_id
			and mid.hos_id = hu.hos_id
			and mid.unit_code = hu.unit_code 
			left join med_store_inv msi on main.group_id = msi.group_id
			and main.hos_id = msi.hos_id and main.copy_code = msi.copy_code
			and main.inv_id = msi.inv_id and msi.store_id = #{store_id,jdbcType=INTEGER}
			
			left join med_store_inv msi1 on main.group_id = msi1.group_id
			and main.hos_id = msi1.hos_id and main.copy_code = msi1.copy_code
			and main.inv_id = msi1.inv_id and msi1.store_id = #{in_store_id,jdbcType=INTEGER}
			
			left join med_location_dict mldout on msi.group_id = mldout.group_id
			and msi.hos_id = mldout.hos_id
			and msi.copy_code = mldout.copy_code
			and msi.location_id = mldout.location_id
			and msi.store_id = mldout.store_id
			and mldout.is_stop = 0 
		LEFT JOIN med_location_dict mldin 
			on msi1.group_id = mldin.group_id 
			and msi1.hos_id = mldin.hos_id 
			and msi1.copy_code = mldin.copy_code 
			and msi1.location_id = mldin.location_id 
			and mldin.is_stop=0
		LEFT JOIN tmp_detail detail
			ON main.inv_id = detail.inv_id
			AND main.batch_no = detail.batch_no
			AND main.bar_code = detail.bar_code 
		group by main.group_id, main.hos_id, main.copy_code, mid.bid_code, main.tran_id, 
		main.inv_id, main.inv_no, main.batch_no, main.price, main.cur_amount, main.imme_amount, 
		main.amount, main.amount_money, main.sale_price, main.sale_money, main.sell_price, main.sell_money, 
		main.allot_price, main.allot_money, main.bar_code, main.inva_date, main.disinfect_date, msi.location_id,
		main.location_in_id, main.note, mid.inv_code, mid.inv_name, mid.inv_model, mid.unit_code, hf.fac_name, 
		hu.unit_name, mldout.location_code, mldout.location_name, mldin.location_code, mldin.location_name
		order by inv_detail_data
	</select>
	
	<select id="queryMedTranDetailBySingle"  parameterType="java.util.Map"  resultType="java.util.TreeMap">
		with w_mod as(
			select 
				inv_id,
				batch_sn,
				batch_no,
				bar_code,
				sum(amount) as amount
			from(
				--出库未确认单据
				select 
					inv_id,
					batch_sn,
					batch_no,
					bar_code,
					sum(nvl(amount, 0)) as amount
				from med_out_main mom 
				left join med_out_detail medod 
					on mom.group_id = medod.group_id and mom.hos_id = medod.hos_id 
					and mom.copy_code = medod.copy_code and mom.out_id = medod.out_id
				where medod.group_id = #{group_id,jdbcType=INTEGER}
					AND medod.hos_id = #{hos_id,jdbcType=INTEGER}
					AND medod.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND mom.store_id = #{store_id,jdbcType=INTEGER}
					<![CDATA[
					AND mom.state < 3 
					AND mom.bus_type_code <> '21'
					AND medod.amount_money > 0
					]]>
				group by inv_id, batch_sn, batch_no, bar_code
				--退货未确认单据
				union all
				select 
					inv_id as inv_id,
					batch_sn as batch_sn,
					batch_no as batch_no,
					bar_code as bar_code,
					-1 * sum(nvl(amount, 0)) as amount
				from med_in_main mim
				left join  med_in_detail medid
					on mim.group_id = medid.group_id and mim.hos_id = medid.hos_id 
					and mim.copy_code = medid.copy_code and mim.in_id = medid.in_id
				where medid.group_id = #{group_id,jdbcType=INTEGER}
					AND medid.hos_id = #{hos_id,jdbcType=INTEGER}
					AND medid.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND mim.store_id = #{store_id,jdbcType=INTEGER}
					<![CDATA[ AND mim.state < 3  ]]>
					AND mim.bus_type_code in ('10','12','16','22')
					<![CDATA[ AND medid.amount_money < 0  ]]>
				group by inv_id, batch_sn, batch_no, bar_code
			)
			group by inv_id, batch_sn, batch_no, bar_code
			order by inv_id asc
		), 
		w_midet as(  
			select midet.inv_id, mid.inv_no, mid.inv_code, mid.inv_name, mtd.med_type_name, mid.inv_model, 
				hu.unit_name, midet.batch_no, midet.batch_sn, midet.bar_code, midet.price, nvl(midet.sale_price, 0) as sale_price, 
				nvl(midet.sell_price, 0) as sell_price, midet.inva_date, midet.disinfect_date, hfd.fac_name, 
				midet.location_id as location_out_id, mld.location_code as location_out_code, 
				mld.location_name as location_out_name, sum(nvl(mfb.left_amount, 0)) as cur_amount, 
				sum(nvl(mfb.left_amount, 0) - nvl(w_mod.amount, 0)) as imme_amount, 
				sum(nvl(mfb.left_amount, 0) - nvl(w_mod.amount, 0)) as amount
			from med_in_detail midet
			left join med_fifo_balance mfb
				on midet.group_id = mfb.group_id and midet.hos_id = mfb.hos_id
				and midet.copy_code = mfb.copy_code and mfb.store_id = #{store_id,jdbcType=INTEGER}
				and midet.inv_id = mfb.inv_id and midet.batch_no = mfb.batch_no
				and midet.batch_sn = mfb.batch_sn and midet.bar_code = mfb.bar_code
			left join w_mod
				on midet.inv_id = w_mod.inv_id and midet.batch_no = w_mod.batch_no
				and midet.batch_sn = w_mod.batch_sn and midet.bar_code = w_mod.bar_code 
			left join med_inv_dict mid
				on midet.group_id = mid.group_id and midet.hos_id = mid.hos_id
				and midet.copy_code = mid.copy_code and midet.inv_id = mid.inv_id
				and mid.is_stop = 0
			left join med_type_dict mtd
				on midet.group_id = mtd.group_id and midet.hos_id = mtd.hos_id
				and midet.copy_code = mtd.copy_code and mid.med_type_id = mtd.med_type_id
				and mtd.is_stop = 0
			left join hos_fac_dict hfd
				on midet.group_id = hfd.group_id and midet.hos_id = hfd.hos_id
				and mid.fac_id = hfd.fac_id and mid.fac_no = hfd.fac_no
			LEFT JOIN hos_unit hu 
				ON midet.group_id = hu.group_id and midet.hos_id = hu.hos_id 
				and mid.unit_code = hu.unit_code 
			LEFT JOIN med_location_dict mld 
				on midet.group_id = mld.group_id and midet.hos_id = mld.hos_id 
				and midet.copy_code = mld.copy_code and midet.location_id = mld.location_id 
				and mld.is_stop=0
			where midet.group_id = #{group_id,jdbcType=INTEGER}
				and midet.hos_id = #{hos_id,jdbcType=INTEGER}
				and midet.copy_code = #{copy_code,jdbcType=VARCHAR} 
				<if test="sql!= null and sql != ''">
					${sql}
				</if>
			group by midet.inv_id, mid.inv_no, mid.inv_code, mid.inv_name, mtd.med_type_name, mid.inv_model, 
				hu.unit_name, midet.batch_no, midet.batch_sn, midet.bar_code, midet.price, midet.sale_price, 
				midet.sell_price, midet.inva_date, midet.disinfect_date, hfd.fac_name, midet.location_id, 
				mld.location_code, mld.location_name
			having sum(nvl(mfb.left_amount, 0) - nvl(w_mod.amount, 0)) > 0
			order by mid.inv_code, midet.inva_date, midet.bar_code, midet.batch_sn
		)
		select inv_id, inv_no, inv_code, inv_name, med_type_name, inv_model, unit_name, batch_no, 
			bar_code, price, sale_price, sell_price, inva_date, disinfect_date, fac_name, location_out_id, 
			location_out_code, location_out_name, sum(cur_amount) cur_amount, sum(imme_amount) as imme_amount, 
			sum(amount) amount, sum(amount * price) as amount_money, sum(amount * sale_price) as sale_money, 
			sum(amount * sell_price) as sell_money, sum(amount) sum_amount, 
			'['||to_char(wm_concat('{"inv_id":'||inv_id||',"inv_code":"'||to_char(inv_code)||'","inv_name":"'||to_char(inv_name)
			||'","batch_sn":'||batch_sn||',"cur_amount":'||cur_amount
			||',"imme_amount":'||imme_amount||',"amount":'||amount
			||',"price":'||price||',"amount_money":'||(amount * price)
			||',"sale_price":'||sale_price||',"sale_money":'||(amount * sale_price)
			||',"sell_price":'||sell_price||',"sell_money":'||(amount * sell_price)
			||'}'))||']' inv_detail_data
		from w_midet
		group by inv_id, inv_no, inv_code, inv_name, med_type_name, inv_model, unit_name, batch_no, bar_code, 
			price, sale_price, sell_price, inva_date, disinfect_date, fac_name, location_out_id, location_out_code, location_out_name
	</select>
	
	<select id="queryMedTranDetailForOutConfirm" parameterType="java.util.List" resultMap="medTranDetail" >
		SELECT 
			a.group_id, a.hos_id, a.copy_code, a.out_store_id, 
			<!-- 如果确认日期走编制日期则放开注释
			a.year, 
			a.month, 
			 --> 
			b.inv_id, c.inv_code, c.inv_name, b.batch_sn, b.batch_no, b.price, 
			sum(b.amount) as amount, sum(b.amount_money) as amount_money,   
			nvl(b.sale_price, 0) as sale_price, sum(nvl(b.sale_money, 0)) as sale_money, 
			b.bar_code, b.location_out_id 
		FROM MED_TRAN_MAIN a
		LEFT JOIN MED_TRAN_DETAIL b
			on a.group_id = b.group_id and a.hos_id = b.hos_id
			and a.copy_code = b.copy_code and a.tran_id = b.tran_id
		LEFT JOIN MED_INV c
			on b.group_id = c.group_id and b.hos_id = c.hos_id
			and b.copy_code = c.copy_code and b.inv_id = c.inv_id
		WHERE
		<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
			a.group_id = #{item.group_id,jdbcType=INTEGER}
			and a.hos_id = #{item.hos_id,jdbcType=INTEGER}
			and a.copy_code = #{item.copy_code,jdbcType=VARCHAR}
			and a.tran_id = #{item.tran_id,jdbcType=INTEGER}
			and a.state &lt;&gt; 3
		</foreach>
		group by a.group_id, a.hos_id, a.copy_code, a.out_store_id, 
			<!-- 如果确认日期走编制日期则放开注释
			a.year, 
			a.month, 
			 --> 
			b.inv_id, c.inv_code, c.inv_name, b.batch_sn, b.batch_no, b.price, 
			b.sale_price, b.bar_code, b.location_out_id 
		order by b.inv_id asc
	</select>
	
	<select id="queryMedTranDetailForInConfirm" parameterType="java.util.List" resultMap="medTranDetail" >
		SELECT 
			a.group_id, a.hos_id, a.copy_code, a.in_store_id, 
			<!-- 如果确认日期走编制日期则放开注释
			a.year, 
			a.month, 
			 --> 
			b.inv_id, c.inv_code, c.inv_name, b.batch_sn, b.batch_no, b.price, 
			sum(b.amount) as amount, sum(b.amount_money) as amount_money,   
			nvl(b.sale_price, 0) as sale_price, sum(nvl(b.sale_money, 0)) as sale_money, 
			b.bar_code, b.location_in_id 
		FROM MED_TRAN_MAIN a
		LEFT JOIN MED_TRAN_DETAIL b
			on a.group_id = b.group_id and a.hos_id = b.hos_id
			and a.copy_code = b.copy_code and a.tran_id = b.tran_id
		LEFT JOIN MED_INV c
			on b.group_id = c.group_id and b.hos_id = c.hos_id
			and b.copy_code = c.copy_code and b.inv_id = c.inv_id
		WHERE
		<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
			a.group_id = #{item.group_id,jdbcType=INTEGER}
			and a.hos_id = #{item.hos_id,jdbcType=INTEGER}
			and a.copy_code = #{item.copy_code,jdbcType=VARCHAR}
			and a.tran_id = #{item.tran_id,jdbcType=INTEGER}
			and a.state &lt;&gt; 3
		</foreach>
		group by a.group_id, a.hos_id, a.copy_code, a.in_store_id, 
			<!-- 如果确认日期走编制日期则放开注释
			a.year, 
			a.month, 
			 --> 
			b.inv_id, c.inv_code, c.inv_name, b.batch_sn, b.batch_no, b.price, 
			b.sale_price, b.bar_code, b.location_in_id
		order by b.inv_id asc
	</select>
	
	<!-- 主页面明细查询 -->
	<select id="queryTranDetails" parameterType="java.util.Map" resultMap="medTranDetailMap">
		SELECT 
			NULL AS group_id,NULL AS hos_id,NULL AS copy_code,NULL AS tran_id,'合计' AS tran_no
		    ,NULL AS tran_detail_id,NULL AS brief,NULL AS tran_date,NULL AS out_hos_id,NULL AS out_hos_code
		    ,NULL AS out_hos_name,NULL AS out_store_id,NULL AS out_store_no,NULL AS out_store_code, NULL AS out_store_name
		    ,NULL AS out_id,NULL AS out_no,NULL AS in_hos_id,NULL AS in_hos_code,NULL AS in_hos_name
		    ,NULL AS in_store_id,NULL AS in_store_no, NULL AS in_store_code,NULL AS in_store_name,NULL AS in_id
		    ,NULL AS in_no,NULL AS maker,NULL AS maker_name,NULL AS checker,NULL AS checker_name
		    ,NULL AS check_date,NULL AS confirmer_name,NULL AS confirm_date,NULL AS state,NULL AS inv_code
		    ,NULL AS inv_name,NULL AS inv_model,NULL AS unit_name,NULL AS fac_name,NULL AS batch_sn
		    ,NULL AS batch_no,NULL AS bar_code,sum(mtd.amount) AS amount,NULL AS price,sum(mtd.amount_money) AS amount_money
		FROM MED_TRAN_DETAIL mtd
		LEFT JOIN MED_TRAN_MAIN mtm ON mtd.group_id = mtm.group_id
			AND mtd.hos_id = mtm.hos_id
			AND mtd.copy_code = mtm.copy_code
			AND mtd.tran_id = mtm.tran_id
			AND mtd.tran_no = mtm.tran_no
		LEFT JOIN MED_INV_DICT mid
		ON
		     mtd.group_id = mid.group_id AND mtd.hos_id = mid.hos_id
		     AND mtd.copy_code = mid.copy_code AND mtd.inv_id = mid.inv_id
		     AND mtd.inv_no = mid.inv_no
		<where>
			mtd.group_id = #{group_id}
			AND mtd.hos_id = #{hos_id}
		    AND mtd.copy_code = #{copy_code}
		    
		    <if test="begin_tran_date != null and begin_tran_date != ''">
				<![CDATA[AND mtm.tran_date >= #{begin_tran_date,jdbcType=DATE}]]>
			</if>
			<if test="end_tran_date != null and end_tran_date != ''">
				<![CDATA[AND mtm.tran_date <= #{end_tran_date,jdbcType=DATE}]]>
			</if>
			
		    <if test="tran_type != null and tran_type != '' ">
			     AND mtm.tran_type = #{tran_type}
		    </if>
		    
		    <if test="bus_type != null and bus_type != '' ">
			     AND mtm.bus_type = #{bus_type}
		    </if>
		    
		    <if test="begin_check_date != null and begin_check_date != ''">
				<![CDATA[AND mtm.check_date >= #{begin_check_date,jdbcType=DATE}]]>
			</if>
			<if test="end_check_date != null and end_check_date != ''">
				<![CDATA[AND mtm.check_date <= #{end_check_date,jdbcType=DATE}]]>
			</if>
		    
		    <if test="out_hos_id != null and out_hos_id != '' ">
			     AND mtm.out_hos_id = #{out_hos_id}
		    </if>
		    
		    <if test="out_store_id != null and out_store_id != '' ">
			     AND mtm.out_store_id = #{out_store_id}
		    </if>
		    
		    <if test="begin_confirm_date != null and begin_confirm_date != ''">
				<![CDATA[AND mtm.confirm_date >= #{begin_confirm_date,jdbcType=DATE}]]>
			</if>
			<if test="end_confirm_date != null and end_confirm_date != ''">
				<![CDATA[AND mtm.confirm_date <= #{end_confirm_date,jdbcType=DATE}]]>
			</if>
		    
		    <if test="in_hos_id != null and in_hos_id != '' ">
			     AND mtm.in_hos_id = #{in_hos_id}
		    </if>
		    
		    <if test="in_store_id != null and in_store_id != '' ">
			     AND mtm.in_store_id = #{in_store_id}
		    </if>
		    
		    <if test="tran_no != null and tran_no != '' ">
			     AND mtd.tran_no like '${tran_no}%'
		    </if>
		    
		    <if test="state != null and state != '' ">
			     AND mtm.state = #{state}
		    </if>
		    
		    <if test="brief != null and brief != '' ">
			     AND mtm.brief like '${brief}%'
		    </if>
		    
		    <if test="inv_info != null and inv_info != '' ">
		    	AND (
		    		mid.inv_code like '${inv_info}%'
		    		or
		    		mid.inv_name like '${inv_info}%'
		    		or
		    		mid.wbx_code like '${inv_info}%'
		    		or
		    		mid.spell_code like '${inv_info}%' 
		    	)
		    </if>
		</where>
		UNION ALL
		SELECT temp.* FROM (
			SELECT
			  mtd.group_id,mtd.hos_id,mtd.copy_code,mtd.tran_id,to_char(mtd.tran_no) as tran_no,mtd.tran_detail_id,
			  mtm.brief,mtm.tran_date,mtm.out_hos_id,out_hid.hos_code as out_hos_code,out_hid.hos_name as out_hos_name,
			  mtm.out_store_id,mtm.out_store_no,out_hsd.store_code as out_store_code,out_hsd.store_name as out_store_name,
			  mtr.out_id,mtr.out_no,mtm.in_hos_id,in_hid.hos_code as in_hos_code,in_hid.hos_name as in_hos_name,mtm.in_store_id,
			  mtm.in_store_no,in_hsd.store_code as in_store_code,in_hsd.store_name as in_store_name,mtr.in_id,mtr.in_no,
			  mtm.maker,makeruser.user_name as maker_name,mtm.checker,checkuser.user_name as checker_name,
			  mtm.check_date,confirmuser.user_name as confirmer_name,mtm.confirm_date,mtm.state,
			  mid.inv_code,mid.inv_name,mid.inv_model,hu.unit_name,hfd.fac_name,mtd.batch_sn,mtd.batch_no,mtd.bar_code,
			  mtd.amount,mtd.price,mtd.amount_money
			FROM MED_TRAN_DETAIL mtd
			LEFT JOIN MED_TRAN_MAIN mtm
			ON
			     mtd.group_id = mtm.group_id AND mtd.hos_id = mtm.hos_id
			     AND mtd.copy_code = mtm.copy_code AND mtd.tran_id = mtm.tran_id
			     AND mtd.tran_no = mtm.tran_no
			LEFT JOIN V_HOS_DICT out_hid
			ON
			     mtm.group_id = out_hid.group_id AND mtm.out_hos_id = out_hid.hos_id
			     AND out_hid.is_stop = 0
			LEFT JOIN HOS_STORE_DICT out_hsd
			ON
			     mtm.group_id = out_hsd.group_id AND mtm.hos_id = out_hsd.hos_id
			     AND mtm.out_store_id = out_hsd.store_id AND mtm.out_store_no = out_hsd.store_no
			LEFT JOIN MED_TRAN_RELA mtr
			ON
			     mtm.group_id = mtr.group_id AND mtm.hos_id = mtr.hos_id
			     AND mtm.copy_code = mtr.copy_code AND mtm.tran_id = mtr.tran_id
			     AND mtm.tran_no = mtr.tran_no
			LEFT JOIN V_HOS_DICT in_hid
			ON
			     mtm.group_id = in_hid.group_id AND mtm.in_hos_id = in_hid.hos_id
			     AND in_hid.is_stop = 0
			LEFT JOIN HOS_STORE_DICT in_hsd
			ON
			     mtm.group_id = in_hsd.group_id AND mtm.hos_id = in_hsd.hos_id
			     AND mtm.in_store_id = in_hsd.store_id AND mtm.in_store_no = in_hsd.store_no
			LEFT JOIN SYS_USER makeruser
			ON
			     mtm.group_id = makeruser.group_id AND mtm.hos_id = makeruser.hos_id
			     AND mtm.copy_code = makeruser.copy_code AND mtm.maker = makeruser.user_id
			     AND makeruser.is_stop = 0
			LEFT JOIN SYS_USER checkuser
			ON
			     mtm.group_id = checkuser.group_id AND mtm.hos_id = checkuser.hos_id
			     AND mtm.copy_code = checkuser.copy_code AND mtm.checker = checkuser.user_id
			     AND checkuser.is_stop = 0
			LEFT JOIN SYS_USER confirmuser
			ON
			     mtm.group_id = confirmuser.group_id AND mtm.hos_id = confirmuser.hos_id
			     AND mtm.copy_code = confirmuser.copy_code AND mtm.confirmer = confirmuser.user_id
			     AND confirmuser.is_stop = 0
			LEFT JOIN MED_INV_DICT mid
			ON
			     mtd.group_id = mid.group_id AND mtd.hos_id = mid.hos_id
			     AND mtd.copy_code = mid.copy_code AND mtd.inv_id = mid.inv_id
			     AND mtd.inv_no = mid.inv_no
			LEFT JOIN HOS_UNIT hu
			ON
			     mid.group_id = hu.group_id AND mid.hos_id = hu.hos_id
			     AND mid.unit_code = hu.unit_code AND hu.is_stop = 0
			LEFT JOIN HOS_FAC_DICT hfd
			ON
			     mid.group_id = hfd.group_id AND mid.hos_id = hfd.hos_id
			     AND mid.fac_id = hfd.fac_id AND mid.fac_no = hfd.fac_no
			<where>
				mtd.group_id = #{group_id}
				AND mtd.hos_id = #{hos_id}
			    AND mtd.copy_code = #{copy_code}
			    
			    <if test="begin_tran_date != null and begin_tran_date != ''">
					<![CDATA[AND mtm.tran_date >= #{begin_tran_date,jdbcType=DATE}]]>
				</if>
				<if test="end_tran_date != null and end_tran_date != ''">
					<![CDATA[AND mtm.tran_date <= #{end_tran_date,jdbcType=DATE}]]>
				</if>
				
			    <if test="tran_type != null and tran_type != '' ">
				     AND mtm.tran_type = #{tran_type}
			    </if>
			    
			    <if test="bus_type != null and bus_type != '' ">
				     AND mtm.bus_type = #{bus_type}
			    </if>
			    
			    <if test="begin_check_date != null and begin_check_date != ''">
					<![CDATA[AND mtm.check_date >= #{begin_check_date,jdbcType=DATE}]]>
				</if>
				<if test="end_check_date != null and end_check_date != ''">
					<![CDATA[AND mtm.check_date <= #{end_check_date,jdbcType=DATE}]]>
				</if>
			    
			    <if test="out_hos_id != null and out_hos_id != '' ">
				     AND mtm.out_hos_id = #{out_hos_id}
			    </if>
			    
			    <if test="out_store_id != null and out_store_id != '' ">
				     AND mtm.out_store_id = #{out_store_id}
			    </if>
			    
			    <if test="begin_confirm_date != null and begin_confirm_date != ''">
					<![CDATA[AND mtm.confirm_date >= #{begin_confirm_date,jdbcType=DATE}]]>
				</if>
				<if test="end_confirm_date != null and end_confirm_date != ''">
					<![CDATA[AND mtm.confirm_date <= #{end_confirm_date,jdbcType=DATE}]]>
				</if>
			    
			    <if test="in_hos_id != null and in_hos_id != '' ">
				     AND mtm.in_hos_id = #{in_hos_id}
			    </if>
			    
			    <if test="in_store_id != null and in_store_id != '' ">
				     AND mtm.in_store_id = #{in_store_id}
			    </if>
			    
			    <if test="tran_no != null and tran_no != '' ">
				     AND mtd.tran_no like '${tran_no}%'
			    </if>
			    
			    <if test="state != null and state != '' ">
				     AND mtm.state = #{state}
			    </if>
			    
			    <if test="brief != null and brief != '' ">
				     AND mtm.brief like '${brief}%'
			    </if>
			    
			    <if test="inv_info != null and inv_info != '' ">
			    	AND (
			    		mid.inv_code like '${inv_info}%'
			    		or
			    		mid.inv_name like '${inv_info}%'
			    		or
			    		mid.wbx_code like '${inv_info}%'
			    		or
			    		mid.spell_code like '${inv_info}%' 
			    	)
			    </if>
			</where>
			     ORDER BY mtd.tran_id
		)temp
		
	</select>
	
	<!-- 查询对应关系表中的明细 -->
	<select id="queryMedTranOutRela" parameterType="java.util.Map" resultType="java.util.Map">
		
		select t.group_id,t.hos_id,t.copy_code,t.rela_id,t.rela_detail_id
		from (
		      select a.group_id,a.hos_id,a.copy_code,a.rela_id,a.rela_detail_id
		      from  med_apply_out_rela  a
		      join  (
		      	select group_id,hos_id,copy_code,tran_id,tran_detail_id
		      	from MED_TRAN_DETAIL 
		      	<where>
		      			group_id = #{group_id,jdbcType=INTEGER}
					AND hos_id = #{hos_id,jdbcType=INTEGER}
					AND copy_code = #{copy_code,jdbcType=VARCHAR}
					AND tran_id = #{tran_id,jdbcType=INTEGER}
		      	</where>
		      ) b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
		      	and a.rela_id=b.tran_id
		      where a.rela_type=2
		      minus
		      select group_id,hos_id,to_char(copy_code) copy_code,tran_id,tran_detail_id
		      from MED_TRAN_DETAIL 
		      <where>
		      		group_id = #{group_id,jdbcType=INTEGER}
				AND hos_id = #{hos_id,jdbcType=INTEGER}
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
				AND tran_id = #{tran_id,jdbcType=INTEGER}
		      </where> 
		)t
		
	</select>
	<!-- 删除对应关系表中的明细 -->
	<delete id="deleteMedTranRela" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			DELETE FROM med_apply_out_rela
			<where>
				<if test="item.group_id != null ">
					AND group_id = #{item.group_id,jdbcType=INTEGER}
				</if>
				<if test="item.hos_id != null ">
					AND hos_id = #{item.hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
				</if>
				<if test="item.rela_id != null ">
					AND rela_id = #{item.rela_id,jdbcType=INTEGER}
				</if>
				<if test="item.rela_detail_id != null ">
					AND rela_detail_id = #{item.rela_detail_id,jdbcType=INTEGER}
				</if>
				and rela_type = 2
			</where>
		</foreach>
	</delete>
	
	<select id="queryMedTranMainIsApply" parameterType="java.util.List" resultType="Integer">
		select count(0) counts
		from med_apply_out_rela
		<where>
			<if test="group_id != null and group_id !='' ">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id !='' ">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id !='' ">
				AND rela_id = #{tran_id,jdbcType=INTEGER}
			</if>
			and rela_type = 2
		</where>
	</select>
</mapper>

