<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.hpm.dao.AphiDeptBonusDataMapper">

	<resultMap id="deptBonusData" type="com.chd.hrp.hpm.entity.AphiDeptBonusData">  
		<result property="group_id" column="group_id" /> 
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="acct_year" column="acct_year" />
		<result property="acct_month" column="acct_month" /> 
		<result property="item_code" column="item_code" />
		<result property="dept_id" column="dept_id" />
		<result property="dept_no" column="dept_no" />
		<result property="emp_code" column="emp_code" />
		<result property="item_name" column="item_name" />
		<result property="dept_name" column="dept_name" />
		<result property="bonus_money" column="bonus_money" />
		<result property="dept_kind_code" column="dept_kind_code" />
		<result property="dept_kind_name" column="dept_kind_name" />
		<result property="formula_code" column="formula_code" />
		<result property="method_code" column="method_code" />
		<result property="formula_name" column="formula_name" />
		<result property="formula_method_chs" column="formula_method_chs" />
		<result property="formula_method_eng" column="formula_method_eng" />
		<result property="target_value_hosp" column="target_value_hosp" />
		<result property="target_value_dept_kind" column="target_value_dept_kind" />
		<result property="target_value_dept" column="target_value_dept" />
		<result property="target_code" column="target_code" />
		<result property="target_name" column="target_name" />
		<result property="target_nature" column="target_nature" />
		<result property="is_audit" column="is_audit" />
		<result property="user_code" column="user_code" />
		<result property="audit_date" column="audit_date" />
		<result property="note" column="note" />
	</resultMap>

	<insert id="add" useGeneratedKeys="true">
	insert into aphi_dept_bonus_data
		(
		group_id,
		hos_id,
		copy_code,
		acct_year,
		acct_month,
		item_code,
		dept_id,
		dept_no ,
		bonus_money,
		is_audit
		<if test="note != null and note !=''">
		, note
		</if>
		) VALUES ( 
		#{group_id,jdbcType=INTEGER} ,
		#{hos_id,jdbcType=INTEGER} ,
		#{copy_code,jdbcType=VARCHAR} ,
		#{acct_year,jdbcType=VARCHAR} ,
		#{acct_month,jdbcType=VARCHAR} ,
		#{item_code,jdbcType=VARCHAR} ,
		#{dept_id,jdbcType=INTEGER} ,
		#{dept_no,jdbcType=INTEGER},
		#{bonus_money,jdbcType=DOUBLE},
		#{is_audit,jdbcType=INTEGER}
		<if test="note != null and note !=''">
		,#{note,jdbcType=VARCHAR} 
		</if>
		)
	
	</insert>
	
	<insert id="addBatchDeptBonusData" parameterType="java.util.List">

		insert into aphi_dept_bonus_data
		(
		group_id,
		hos_id,
		copy_code,
		acct_year,
		acct_month,
		item_code,
		dept_id,
		dept_no ,
		bonus_money,
		is_audit
		)

		<foreach collection="list" item="item" index="index"
			separator=" union all ">
			select
			#{item.group_id},
			#{item.hos_id},
			#{item.copy_code},
			#{item.acct_year},
			#{item.acct_month},
			#{item.item_code},
			#{item.dept_id},
			#{item.dept_no},
			#{item.bonus_money},
			0
			from dual
		</foreach>

	</insert>
	
	<insert id="addBatchDeptBonusDataByListMap" parameterType="java.util.List">

		insert into aphi_dept_bonus_data
		(
		group_id,
		hos_id,
		copy_code,
		acct_year,
		acct_month,
		item_code,
		dept_id,
		dept_no ,
		bonus_money,
		is_audit,
		note
		)

		<foreach collection="list" item="item" index="index"
			separator=" union all ">
			select
			#{item.group_id},
			#{item.hos_id},
			#{item.copy_code},
			#{item.acct_year},
			#{item.acct_month},
			#{item.item_code},
			#{item.dept_id},
			#{item.dept_no},
			#{item.bonus_money},
			#{item.is_audit},
			#{item.note}
			from dual
		</foreach>

	</insert>

	<update id="updateDeptBonusData" parameterType="java.util.Map">

		UPDATE
		aphi_dept_bonus_data SET
		bonus_money = #{bonus_money}
		<if test="note != null and note != ''">
		,note = #{note}
		</if>
		WHERE
		group_id = #{group_id,jdbcType=INTEGER} and
		hos_id = #{hos_id,jdbcType=INTEGER} and
		copy_code = #{copy_code,jdbcType=VARCHAR} and
		acct_year = #{acct_year,jdbcType=VARCHAR} and
		acct_month = #{acct_month,jdbcType=VARCHAR} and
		item_code = #{item_code,jdbcType=VARCHAR} AND 
		dept_id = #{dept_id,jdbcType=INTEGER} AND 
		dept_no = #{dept_no,jdbcType=INTEGER}

	</update>
	
	<update id="updateBatchDeptBonusData" parameterType="java.util.Map">

		<foreach collection="list" item="item" index="index" open="begin"
			close=";end;" separator=";">
			UPDATE aphi_dept_bonus_data
			<trim prefix="SET" suffixOverrides=",">
				<if test="item.bonus_money != null">  
					bonus_money = #{item.bonus_money},
				</if>
				<if test="item.note != null and item.note != ''">
					note = #{item.note}
				</if>
				<if test="item.is_audit != null">
					is_audit = #{item.is_audit}
				</if>
				<if test="item.audit_date != null">
					audit_date = #{item.audit_date}
				</if>
				<if test="item.user_code != null">
					user_code = #{item.user_code}
				</if>
			</trim>
			<where>
				<if test="item.group_id != null and item.group_id != ''">
					AND group_id = #{item.group_id}
				</if>
				<if test="item.hos_id != null and item.hos_id != ''">
					AND hos_id = #{item.hos_id}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					AND copy_code = #{item.copy_code}
				</if>
				<if test="item.acct_month != null and item.acct_month != ''">
					AND acct_month = #{item.acct_month}
				</if>
				<if test="item.acc_year != null and item.acc_year != ''">
					AND acc_year = #{item.acc_year}
				</if>
				<if test="item.item_code != null and item.item_code != ''">
					AND item_code = #{item.item_code}
				</if>
				<if test="item.dept_id != null and item.dept_id != ''">
					AND dept_id = #{item.dept_id}
				</if>
				<if test="item.dept_no != null and item.dept_no != ''">
					AND dept_no = #{item.dept_no}
				</if>
			</where>
		</foreach>

	</update>

	<delete id="deleteBatch" parameterType="java.util.List">
		DELETE FROM aphi_dept_bonus_data adbd
	<where>
	<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
			<if test="item.group_id != null and item.group_id != ''">
				 adbd.group_id = #{item.group_id}
			</if>
			<if test="item.hos_id != null and item.hos_id != ''">
				AND adbd.hos_id = #{item.hos_id}
			</if>
			<if test="item.copy_code != null and item.copy_code != ''">
				AND adbd.copy_code = #{item.copy_code}
			</if>
			<if test="item.acct_year != null and item.acct_year != ''">
				AND adbd.acct_year = #{item.acct_year}
			</if>
			<if test="item.acct_month != null and item.acct_month != ''">
				AND adbd.acct_month = #{item.acct_month}
			</if>
			<if test="item.item_code != null and item.item_code != ''">
				AND adbd.item_code=#{item.item_code}
			</if>
			<if test="item.dept_id != null and item.dept_id != ''">
				AND adbd.dept_id = #{item.dept_id}
			</if>
			<if test="item.dept_no != null and item.dept_no != ''">
				AND adbd.dept_no = #{item.dept_no}
			</if>
			</foreach>
		</where>
	
	
	</delete>

	<delete id="deleteDeptBonusData" parameterType="java.util.Map">

		DELETE FROM aphi_dept_bonus_data adbd

 		<where>
			<if test="group_id != null and group_id != ''">
				AND adbd.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND adbd.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND adbd.copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND adbd.acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND adbd.acct_month = #{acct_month}
			</if>
			<if test="item_code != null and item_code != ''">
				AND adbd.item_code=#{item_code}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND adbd.dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				AND adbd.dept_no = #{dept_no}
			</if>
		</where>
 		and adbd.dept_id || adbd.dept_no in
       (select dept_id || dept_no
          from aphi_dept_dict ad

	   <where>
	   		
			<if test="group_id != null and group_id != ''">
				ad.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND ad.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND ad.copy_code = #{copy_code}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND ad.dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				AND ad.dept_no = #{dept_no}
			</if>
			<if test="nature_code != null and nature_code != ''">
				and ad.nature_code in (${nature_code})
			</if>
			<if test="dept_kind_code != null and dept_kind_code != ''">
				and ad.dept_kind_code = #{dept_kind_code}
			</if>
			 and exists(
		        select 1 from v_user_data_perm a where a.group_id = #{group_id,jdbcType = INTEGER}
		        and a.hos_id = #{hos_id,jdbcType = INTEGER} and a.copy_code = #{copy_code,jdbcType = VARCHAR}
		        and a.user_id = #{user_id,jdbcType = INTEGER}
		        and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
		        and a.perm_code = ad.dept_id and a.is_read = 1 and a.is_write = 1
		      )
		</where>
		)
	</delete>

	<select id="queryHpmDeptBonusDataByCode" resultMap="deptBonusData"
		parameterType="string">

		select adbd.group_id,
       adbd.hos_id,
       adbd.copy_code,
       adbd.item_code,
       adbd.dept_id,
       adbd.dept_no,
       adbd.item_code,
       ai.item_name,
       adss.method_code,
       adss.formula_code,
       adss.fun_code,
       ad.dept_name,
       ad.dept_kind_code,
       adk.dept_kind_name,
       af.formula_name,
       to_char(af.formula_method_chs) formula_method_chs,
       af.formula_method_eng,
       adbd.bonus_money,
        adbd.is_audit
  from aphi_dept_bonus_data adbd
  left join aphi_dept_scheme_seq adss
    on adbd.group_id = adss.group_id
   and adbd.hos_id = adss.hos_id
   and adbd.copy_code = adss.copy_code
   and adbd.dept_id = adss.dept_id
   and adbd.dept_no = adss.dept_no
   and adbd.item_code = adss.item_code
  left join aphi_dept_dict ad
    on adss.group_id = ad.group_id
   and adss.hos_id = ad.hos_id
   and adss.copy_code = ad.copy_code
   and adss.dept_id = ad.dept_id
   and adss.dept_no = ad.dept_no
  left join aphi_dept_kind adk
    on adss.group_id = adk.group_id
   and adss.hos_id = adk.hos_id
   and adss.copy_code = adk.copy_code
   and ad.dept_kind_code = adk.dept_kind_code
  left join aphi_formula af
    on adss.group_id = af.group_id
   and adss.hos_id = af.hos_id
   and adss.copy_code = af.copy_code
   and adss.formula_code = af.formula_code
   left join aphi_item ai
   on adbd.group_id = ai.group_id
   and adbd.hos_id = ai.hos_id
   and adbd.copy_code = ai.copy_code
   and adbd.item_code = ai.item_code

		<where>
			<if test="group_id != null and group_id != ''">
				AND adbd.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND adbd.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND adbd.copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND adbd.acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND adbd.acct_month = #{acct_month}
			</if>
			<if test="scheme_seq_no != null and scheme_seq_no != ''">
				AND adss.scheme_seq_no=#{scheme_seq_no}
			</if>
			<if test="item_code != null and item_code != ''">
				AND adbd.item_code=#{item_code}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND adbd.dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				AND adbd.dept_no = #{dept_no}
			</if>
			<if test="formula_code != null and formula_code != ''">
				AND adss.formula_code =#{formula_code}
			</if>
			and exists(
				select 1 from v_user_data_perm a where a.group_id = #{group_id}
				and a.hos_id = #{hos_id} and a.copy_code = #{copy_code}
				and a.user_id = #{user_id}
				and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
				and a.perm_code = adbd.dept_id and a.is_read = 1 and a.is_write = 1
			)
		</where>

	</select>


	<select id="queryDeptBonusDataForGrant" resultMap="deptBonusData"
		parameterType="java.util.Map">

		select
		group_id as group_id,
		hos_id as hos_id,
		copy_code as copy_code,
		acct_year as
		acct_year,
		acct_month as acct_month,
		item_code as item_code,
		dept_id as
		dept_id,
		sum(bonus_money) as bonus_money,is_audit
		from
		aphi_dept_bonus_data
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND acct_month = #{acct_month}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				AND dept_no = #{dept_no}
			</if>
			<if test="item_code != null and item_code != ''">
				AND item_code = #{item_code}
			</if>
			<if test="is_audit != null and is_audit != ''">
				AND is_audit = #{is_audit}
			</if>
			 and exists(
		        select 1 from v_user_data_perm a where a.group_id = #{group_id,jdbcType = INTEGER}
		        and a.hos_id = #{hos_id,jdbcType = INTEGER} and a.copy_code = #{copy_code,jdbcType = VARCHAR}
		        and a.user_id = #{user_id,jdbcType = INTEGER}
		        and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
		        and a.perm_code = dept_id and a.is_read = 1 and a.is_write = 1
		      )
		</where>
		group by group_id,hos_id,
		copy_code,
		acct_year,
		acct_month,
		item_code,
		dept_id,
		is_audit
		order by group_id asc
	</select>


	<select id="queryDeptBonusDataByFormulaCode" parameterType="java.util.List"
		resultMap="deptBonusData">

		select
		at.target_code ,
		at.target_name,
		atn.nature_name,
		af.fun_code,
		afl.source_name,
		ahtd.target_value as target_value_hosp,
		adktd.target_value as target_value_dept_kind,
		adtd.target_value as
		target_value_dept

		from aphi_target at
		left join APHI_TARGET_NATURE atn
		on at.nature_code=atn.nature_code and
		at.group_id = atn.group_id and
		at.hos_id = atn.hos_id and
		at.copy_code=atn.copy_code
		left join
		APHI_TARGET_METHOD atm on
		at.target_code=atm.target_code and
		at.group_id=atm.group_id and
		at.hos_id=atm.hos_id and
		at.copy_code=atm.copy_code
		left join APHI_FUN af on
		atm.fun_code=af.fun_code and
		at.group_id=atm.group_id and
		at.hos_id=atm.hos_id and
		at.copy_code=atm.copy_code
		left join
		APHI_FUN_LINK afl on
		atm.fun_code=afl.fun_code and
		at.group_id=afl.group_id and
		at.hos_id=afl.hos_id and
		at.copy_code=afl.copy_code
		left join aphi_hosp_target_data ahtd on
		at.target_code=ahtd.target_code
		and at.group_id=ahtd.group_id and
		at.hos_id=ahtd.hos_id and
		at.copy_code=ahtd.copy_code and
		ahtd.acct_year=#{acct_year} and
		ahtd.acct_month=#{acct_month}
		left join
		APHI_DEPT_KIND_TARGET_DATA
		adktd on at.target_code =
		adktd.target_code
		and
		at.group_id=adktd.group_id and
		at.hos_id=adktd.hos_id and
		at.copy_code=adktd.copy_code and
		adktd.dept_kind_code=#{dept_kind_code} and
		adktd.acct_month=#{acct_year} and adktd.acct_year=#{acct_month}
		left
		join APHI_DEPT_TARGET_DATA adtd on at.target_code = adtd.target_code
		and at.group_id=adtd.group_id
		and at.hos_id=adtd.hos_id
		and at.copy_code
		= adtd.copy_code and
		adtd.dept_id = #{dept_id} and
		adtd.acct_year=#{acct_year} and
		adtd.acct_month=#{acct_month}

		<where>
			<if test="group_id != null and group_id != ''">
				at.group_id= #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				at.hos_id= #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and at.copy_code =#{copy_code}
			</if>

			<if test="sql != null and sql != ''">
				${sql}
			</if>
 			and exists(
		        select 1 from v_user_data_perm a where a.group_id = #{group_id,jdbcType = INTEGER}
		        and a.hos_id = #{hos_id,jdbcType = INTEGER} and a.copy_code = #{copy_code,jdbcType = VARCHAR}
		        and a.user_id = #{user_id,jdbcType = INTEGER}
		        and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
		        and a.perm_code = adtd.dept_id and a.is_read = 1 and a.is_write = 1
		      )
		</where>

	</select>

	<select id="queryDeptSchemeSeqForDeptBonusData" parameterType="java.util.List"
		resultMap="deptBonusData">
		select adss.group_id,
		adss.hos_id,
		adss.copy_code,
		adss.dept_id,
		adss.dept_no,
		'${acct_year}' as acct_year,
		'${acct_month}' as
		acct_month,
		ai.item_code,
		'0'
		from aphi_dept_scheme_Seq adss
		left join aphi_dept_dict ad
		on adss.group_id = ad.group_id
		and adss.hos_id = ad.hos_id
		and adss.copy_code = ad.copy_code
		and adss.dept_id = ad.dept_id
		and adss.dept_no = ad.dept_no 
		left join aphi_item ai
		on adss.group_id = ai.group_id
		and adss.hos_id = ai.hos_id
		and adss.copy_code = ai.copy_code
		and adss.item_code = ai.item_code
		<where>
			adss.scheme_seq_no = '${scheme_seq_no}'
			<if test="group_id != null and group_id != ''">
				and adss.group_id= #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and adss.hos_id= #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and adss.copy_code =#{copy_code}
			</if>
			<if test="nature_code != null and nature_code != ''">
				and ad.nature_code in (${nature_code})
			</if>
			<if test="app_mod_code != null and app_mod_code != ''">
				and ai.app_mod_code in (${app_mod_code})
			</if>
			<if test="dept_id != null and dept_id != ''">
				and adss.dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				and adss.dept_no = #{dept_no}
			</if>
			<if test="dept_kind_code != null and dept_kind_code != ''">
				and ad.dept_kind_code = #{dept_kind_code}
			</if>
			 and exists(
		        select 1 from v_user_data_perm a where a.group_id = #{group_id,jdbcType = INTEGER}
		        and a.hos_id = #{hos_id,jdbcType = INTEGER} and a.copy_code = #{copy_code,jdbcType = VARCHAR}
		        and a.user_id = #{user_id,jdbcType = INTEGER}
		        and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
		        and a.perm_code = ad.dept_id and a.is_read = 1 and a.is_write = 1
		      )
		</where>
		order by adss.dept_id
	</select>



	<select id="queryDeptBonus" parameterType="java.util.Map"
		resultMap="deptBonusData">

		SELECT
		a.group_id,
		a.hos_id,
		a.copy_code,
		a.acct_year,
		a.acct_month,
		a.item_code,
		a.dept_id,
		a.dept_no,
		a.bonus_money
		FROM aphi_dept_bonus_data a
		<where>
			<if test="group_id != null and group_id != ''">
				AND a.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND a.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND a.copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND a.acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND a.acct_month = #{acct_month}
			</if>
			<if test="item_code != null and item_code != ''">
				AND a.item_code = #{item_code}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND a.dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				AND a.dept_no = #{dept_no}
			</if>
			 and exists(
		        select 1 from v_user_data_perm a where a.group_id = #{group_id,jdbcType = INTEGER}
		        and a.hos_id = #{hos_id,jdbcType = INTEGER} and a.copy_code = #{copy_code,jdbcType = VARCHAR}
		        and a.user_id = #{user_id,jdbcType = INTEGER}
		        and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
		        and a.perm_code = a.dept_id and a.is_read = 1 and a.is_write = 1
		      )
		</where>
		order by a.group_id asc
	</select>

	<select id="queryDeptBonusForBonusMoney" resultType="java.util.TreeMap">
		SELECT
		adbd.acct_year,
		adbd.acct_month,
		<if test="sql != null and sql != ''"> 
			${sql}
		</if>
		<if test="sql_sum != null and sql_sum != ''">
			${sql_sum}
		</if>
		adbd.dept_id,
		adbd.dept_no,
		ad.dept_code,
		ad.dept_name
		<if test="sql_item !=null and sql_item !=''">
			${sql_item}
		</if>
		FROM
		aphi_dept_bonus_data adbd
		left join aphi_dept_dict ad
		on
		adbd.group_id =
		ad.group_id
		and adbd.hos_id = ad.hos_id
		and
		adbd.copy_code = ad.copy_code
		and adbd.dept_id = ad.dept_id
		and
		adbd.dept_no = ad.dept_no 
		 left join sys_user su on
	    su.group_id = adbd.group_id
	    and su.hos_id = adbd.hos_id
	    and su.copy_code = adbd.copy_code
	    and su.user_id = adbd.user_code
	    and su.is_stop = 0 
    
		<where>
			<if test="group_id != null and group_id != ''">
				AND adbd.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND adbd.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND adbd.copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND adbd.acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND adbd.acct_month = #{acct_month}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND adbd.dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				AND adbd.dept_no = #{dept_no}
			</if>
			<if test="nature_code != null and nature_code != ''">
				AND ad.nature_code in (${nature_code})
			</if>
			<if test="dept_kind_code != null and dept_kind_code != ''">
				AND ad.dept_kind_code = #{dept_kind_code}
			</if>
			<if test="item_code != null and item_code != ''">
				AND adbd.item_code = #{item_code}
			</if>
			<if test="is_audits != null and is_audits != ''">
				AND adbd.is_audit = #{is_audits}
			</if>
			<if test="item_note != null and item_note != ''">
				And adbd.note like '%${item_note}%'
			</if>
			and exists(
				select 1 from v_user_data_perm perm where perm.group_id = #{group_id}
				and perm.hos_id = #{hos_id} and perm.copy_code = #{copy_code}
				and perm.user_id = #{user_id}
				and perm.mod_code = '09' and perm.table_code = 'APHI_DEPT_DICT'
				and perm.perm_code = ad.dept_id and perm.is_read = 1 and perm.is_write = 1
				)
		</where>
		group by
		adbd.acct_year,adbd.acct_month,adbd.dept_id,adbd.dept_no,ad.dept_code,ad.dept_name
		<if test="sql_group_by != null and sql_group_by != ''">
			${sql_group_by}
		</if>
		
		order by adbd.acct_year,adbd.acct_month,ad.dept_code asc
	</select>
	
	<select id="queryDeptBonusByItemForBonusMoney" resultType="java.util.TreeMap">
		SELECT
		adbd.acct_year,
		adbd.acct_month,
		adbd.dept_id,
		adbd.dept_no,
		ad.dept_code,
		adbd.item_code,
		sum(nvl(adbd.bonus_money,0)) as sum_money,
		adbd.is_audit,
	    adbd.audit_date,
	    adbd.user_code
		FROM
		aphi_dept_bonus_data adbd
		left join aphi_dept_dict ad
		on
		adbd.group_id =
		ad.group_id
		and adbd.hos_id = ad.hos_id
		and
		adbd.copy_code = ad.copy_code
		and adbd.dept_id = ad.dept_id
		and
		adbd.dept_no = ad.dept_no 
		<where>
			<if test="group_id != null and group_id != ''">
				AND adbd.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND adbd.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND adbd.copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND adbd.acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND adbd.acct_month = #{acct_month}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND adbd.dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				AND adbd.dept_no = #{dept_no}
			</if>
			<if test="nature_code != null and nature_code != ''">
				AND ad.nature_code in (${nature_code})
			</if>
			<if test="dept_kind_code != null and dept_kind_code != ''">
				AND ad.dept_kind_code = #{dept_kind_code}
			</if>
			 and exists(
		        select 1 from v_user_data_perm a where a.group_id = #{group_id,jdbcType = INTEGER}
		        and a.hos_id = #{hos_id,jdbcType = INTEGER} and a.copy_code = #{copy_code,jdbcType = VARCHAR}
		        and a.user_id = #{user_id,jdbcType = INTEGER}
		        and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
		        and a.perm_code = ad.dept_id and a.is_read = 1 and a.is_write = 1
		      )
		</where>
		group by
		adbd.acct_year,adbd.acct_month,adbd.dept_id,adbd.dept_no,ad.dept_code,adbd.item_code,adbd.is_audit,
	    adbd.audit_date,
	    adbd.user_code
		order by adbd.acct_year,adbd.acct_month,ad.dept_code asc
	</select>
	
	<select id="queryDeptBonusForBonusMoneyPrint" resultType="java.util.TreeMap">
		SELECT
		adbd.acct_year,
		adbd.acct_month,
		<if test="sql != null and sql != ''">
			${sql}
		</if>
		<if test="sql_sum != null and sql_sum != ''">
			${sql_sum}
		</if>
		adbd.dept_id,
		adbd.dept_no,
		ad.dept_code,
		ad.dept_name,
		adbd.is_audit,
	    adbd.audit_date,
	    adbd.user_code
		FROM
		aphi_dept_bonus_data adbd
		left join aphi_dept_dict ad
		on
		adbd.group_id =
		ad.group_id
		and adbd.hos_id = ad.hos_id
		and
		adbd.copy_code = ad.copy_code
		and adbd.dept_id = ad.dept_id
		and
		adbd.dept_no = ad.dept_no and
		ad.is_stop='0'

		<where>
			<if test="group_id != null and group_id != ''">
				AND adbd.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND adbd.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND adbd.copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND adbd.acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND adbd.acct_month = #{acct_month}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND adbd.dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				AND adbd.dept_no = #{dept_no}
			</if>
			<if test="nature_code != null and nature_code != ''">
				AND ad.nature_code in (${nature_code})
			</if>
			and exists(
				select 1 from v_user_data_perm perm where perm.group_id = #{group_id}
				and perm.hos_id = #{hos_id} and perm.copy_code = #{copy_code}
				and perm.user_id = #{user_id}
				and perm.mod_code = '09' and perm.table_code = 'APHI_DEPT_DICT'
				and perm.perm_code = ad.dept_id and perm.is_read = 1 and perm.is_write = 1
				)
		</where>
		group by
		adbd.acct_year,adbd.acct_month,adbd.dept_id,adbd.dept_no,ad.dept_code,ad.dept_name,adbd.is_audit,
	    adbd.audit_date,
	    adbd.user_code
		order by adbd.acct_year,adbd.acct_month,ad.dept_code asc
	</select>

	<select id="queryHpmDeptBonusDataForFormula" resultType="java.util.Map">
		select 
		afs.target_code,
       	t.target_name,
		atm.method_code,
       atn.nature_name,
       atm.formula_code,
       atm.fun_code,
       case
         when atm.method_code = '02' then
          (select to_char(to_char(formula_method_chs)) formula_method_chs
             from aphi_formula
            where afs.group_id = group_id
              and afs.hos_id = hos_id
              and afs.copy_code = copy_code
              and atm.formula_code = formula_code)
         when atm.method_code = '03' then
          (select fun_method_chs
             from aphi_fun
            where afs.group_id = group_id
              and afs.hos_id = hos_id
              and afs.copy_code = copy_code
              and atm.fun_code = fun_code)
       end as method_name,
       case
         when t.target_nature = '01' then
          (select target_value
             from aphi_hosp_target_data
            where afs.group_id = group_id
              and afs.hos_id = hos_id
              and afs.copy_code = copy_code
              and afs.target_code = target_code AND acct_year = #{acct_year} AND acct_month = #{acct_month})
         when t.target_nature = '02' then
          (select target_value
             from aphi_dept_kind_target_data
            where afs.group_id = group_id
              and afs.hos_id = hos_id
              and afs.copy_code = copy_code
              and afs.target_code = target_code AND acct_year = #{acct_year} AND acct_month = #{acct_month} and dept_kind_code = #{dept_kind_code})
          when t.target_nature = '03' then
          (select target_value
             from aphi_dept_target_data
            where afs.group_id = group_id
              and afs.hos_id = hos_id
              and afs.copy_code = copy_code
              and afs.target_code = target_code AND acct_year = #{acct_year} AND acct_month = #{acct_month} and dept_id = #{dept_id} and dept_no = #{dept_no})
		       end as target_value
		  from aphi_formula_stack afs
		  left join aphi_target t
		    on afs.group_id = t.group_id
		   and afs.hos_id = t.hos_id
		   and afs.copy_code = t.copy_code
		   and afs.target_code = t.target_code
		  left join aphi_target_method atm
		    on afs.group_id = atm.group_id
		   and afs.hos_id = atm.hos_id
		   and afs.copy_code = atm.copy_code
		   and afs.target_code = atm.target_code
		  left join aphi_target_nature atn
		    on afs.group_id = atn.group_id
		   and afs.hos_id = atn.hos_id
		   and afs.copy_code = atn.copy_code
		   and t.target_nature = atn.nature_code
		<where>
			<if test="group_id != null and group_id != ''">
				AND afs.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND afs.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND afs.copy_code = #{copy_code}
			</if>
			<if test="formula_code != null and formula_code != ''">
				AND afs.formula_code = #{formula_code}
			</if>
		</where>
		order by afs.stack_seq_no
	</select>
	<select id="queryHpmDeptBonusDataForTarget" resultType="java.util.TreeMap">
		
	</select>
	<select id="queryHpmDeptBonusDataForTargetGrid" parameterType="java.util.Map"
		resultMap="deptBonusData">

		select t.target_code, t.target_name, t.target_nature
		from
		aphi_dept_bonus_data adbd
		left join aphi_dept_scheme_seq adss
		on
		adbd.group_id = adss.group_id
		and adbd.hos_id = adss.hos_id
		and
		adbd.copy_code = adss.copy_code
		and adbd.dept_id = adss.dept_id
		and
		adbd.dept_no = adss.dept_no
		and adbd.item_code = adss.item_code
		and
		adss.scheme_seq_no = '${scheme_seq_no}'
		left join aphi_formula_stack
		afs
		on adbd.group_id = afs.group_id
		and adbd.hos_id = afs.hos_id
		and
		adbd.copy_code = afs.copy_code
		and adss.formula_code = afs.formula_code
		left join aphi_target t
		on adbd.group_id = t.group_id
		and adbd.hos_id =
		t.hos_id
		and adbd.copy_code = t.copy_code
		and afs.target_code =
		t.target_code
		left join aphi_dept_dict ad
		on adbd.group_id = ad.group_id
		and adbd.hos_id = ad.hos_id
		and adbd.copy_code = ad.copy_code
		and
		adbd.dept_id = ad.dept_id
		and adbd.dept_no = ad.dept_no
		<where>

			<if test="group_id != null and group_id != ''">
				AND adss.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND adss.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND adss.copy_code = #{copy_code}
			</if>
			<if test="item_code != null and item_code != ''">
				AND adss.item_code = #{item_code}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND adss.dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				AND adss.dept_no = #{dept_no}
			</if>
			<if test="nature_code != null and nature_code != ''">
				AND ad.nature_code in (${nature_code})
			</if>
			<if test="sql != null and sql != ''">
				AND ${sql}
			</if>
			and exists(
				select 1 from v_user_data_perm perm where perm.group_id = #{group_id}
				and perm.hos_id = #{hos_id} and perm.copy_code = #{copy_code}
				and perm.user_id = #{user_id}
				and perm.mod_code = '09' and perm.table_code = 'APHI_DEPT_DICT'
				and perm.perm_code = ad.dept_id and perm.is_read = 1 and perm.is_write = 1
				)
			
		</where>
		group by t.target_code, t.target_name, t.target_nature
		
	</select>

	<select id="queryDeptBonusData" parameterType="java.util.Map"
		resultMap="deptBonusData">

		select adbd.group_id,
		       adbd.hos_id,
		       adbd.copy_code,
		       adbd.dept_id,
		       adbd.dept_no,
		       adbd.acct_year,
		       adbd.acct_month,
		       adbd.item_code,
		       ads.formula_code,
		       ad.dept_code,
		       ad.dept_name,
		       adk.dept_kind_code,
		       adk.dept_kind_name,
		       ai.item_name
		  from aphi_dept_bonus_data adbd
		  left join aphi_dept_scheme ads 
		  on adbd.group_id = ads.group_id
		  and adbd.hos_id = ads.hos_id
		  and adbd.copy_code = ads.copy_code
		  and adbd.dept_id = ads.dept_id
		  and adbd.dept_no = ads.dept_no
		  and adbd.item_code = ads.item_code
		  left join aphi_dept_dict ad
		    on adbd.group_id = ad.group_id
		   and adbd.hos_id = ad.hos_id
		   and adbd.copy_code = ad.copy_code
		   and adbd.dept_id = ad.dept_id
		   and adbd.dept_no = ad.dept_no
		   and ad.is_stop = '0'
		  left join aphi_item ai
		    on adbd.group_id = ai.group_id
		   and adbd.hos_id = ai.hos_id
		   and adbd.copy_code = ai.copy_code
		   and adbd.item_code = ai.item_code
		  left join aphi_dept_kind adk
		    on adbd.group_id = adk.group_id
		   and adbd.hos_id = adk.hos_id
		   and adbd.copy_code = adk.copy_code
		   and ad.dept_kind_code = adk.dept_kind_code
		<where>

			<if test="group_id != null and group_id != ''">
				AND adbd.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND adbd.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND adbd.copy_code = #{copy_code}
			</if>
			<if test="item_code != null and item_code != ''">
				AND adbd.item_code = #{item_code}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND adbd.dept_id = #{dept_id}
			</if>
			<if test="dept_no != null and dept_no != ''">
				AND adbd.dept_no = #{dept_no}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND adbd.acct_year = #{acct_year}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND adbd.acct_month = #{acct_month}
			</if>
			<if test="nature_code != null and nature_code != ''">
				AND ad.nature_code in (${nature_code})
			</if>
			<if test="dept_kind_code != null and dept_kind_code != ''">
				AND ad.dept_kind_code = #{dept_kind_code}
			</if>
			<if test="app_mod_code != null and app_mod_code != ''">
				AND ai.app_mod_code in (${app_mod_code})
			</if>
			<if test="sql != null and sql != ''">
				AND ${sql}
			</if>
			 and exists(
		        select 1 from v_user_data_perm a where a.group_id = #{group_id,jdbcType = INTEGER}
		        and a.hos_id = #{hos_id,jdbcType = INTEGER} and a.copy_code = #{copy_code,jdbcType = VARCHAR}
		        and a.user_id = #{user_id,jdbcType = INTEGER}
		        and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
		        and a.perm_code = ad.dept_id and a.is_read = 1 and a.is_write = 1
		      )
		</where>
		order by ad.dept_code asc
	</select>
	
	
	<select id="queryAphiDeptSchemeItem" resultType="com.chd.hrp.hpm.entity.AphiItem" parameterType="java.util.Map">
		SELECT 
			ads.item_code,ai.item_name,ai.is_sum 
		FROM APHI_DEPT_SCHEME ads
		LEFT JOIN APHI_ITEM ai
		ON
		     ads.group_id = ai.group_id
		     AND ads.hos_id = ai.hos_id
		     AND ads.copy_code = ai.copy_code
		     AND ads.item_code = ai.item_code
		     AND ai.is_stop = 0
		LEFT JOIN APHI_DEPT_DICT AD
		ON
		     ads.group_id = ad.group_id
		     AND ads.hos_id = ad.hos_id
		     AND ads.copy_code = ad.copy_code
		     AND ads.dept_id = ad.dept_id
		     AND ads.dept_no = ad.dept_no
		WHERE
			ads.group_id = #{group_id}
			AND ads.hos_id = #{hos_id}
			AND ads.copy_code = #{copy_code}
			AND ad.nature_code = ${nature_code}
		    <if test="dept_id != null and dept_id != ''">
		    	AND ads.dept_id = #{dept_id}
		    </if> 
		    
		     <if test="dept_no != null and dept_no != ''">
		    	AND ads.dept_no = #{dept_no}
		    </if> 
		    
		    <if test="dept_kind_code != null and dept_kind_code != ''">
		    	AND ad.dept_kind_code = #{dept_kind_code}
		    </if>
		     and exists(
		        select 1 from v_user_data_perm a where a.group_id = #{group_id,jdbcType = INTEGER}
		        and a.hos_id = #{hos_id,jdbcType = INTEGER} and a.copy_code = #{copy_code,jdbcType = VARCHAR}
		        and a.user_id = #{user_id,jdbcType = INTEGER}
		        and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
		        and a.perm_code = ad.dept_id and a.is_read = 1 and a.is_write = 1
		      )
		GROUP BY ads.item_code,ai.item_name,ai.is_sum 
     	order by ads.item_code
     	
	</select>
	
	<select id="queryDeptName" resultMap="deptBonusData" parameterType="java.util.Map">
	select 
			   adbd.group_id,
		       adbd.hos_id,
		       adbd.copy_code,
		       ad.dept_code,
		        adbd.acct_year,
		       adbd.acct_month,
		       ad.dept_name,
		        ad.dept_code,
		        ad.dept_id,
		        ad.dept_no,
		        adbd.bonus_money,
		        adbd.item_code,
		        ai.item_name,
		        adbd.note
		  from aphi_dept_bonus_data adbd
		  left join aphi_dept_scheme ads 
		  on adbd.group_id = ads.group_id
		  and adbd.hos_id = ads.hos_id
		  and adbd.copy_code = ads.copy_code
		  and adbd.dept_id = ads.dept_id
		  and adbd.dept_no = ads.dept_no
		  and adbd.item_code = ads.item_code
		  left join aphi_dept_dict ad
		    on adbd.group_id = ad.group_id
		   and adbd.hos_id = ad.hos_id
		   and adbd.copy_code = ad.copy_code
		   and adbd.dept_id = ad.dept_id
		   and adbd.dept_no = ad.dept_no
		   and ad.is_stop = '0'
		    left join aphi_item ai on
		    adbd.group_id = ai.group_id
		    and adbd.hos_id = ai.hos_id
		    and adbd.copy_code = ai.copy_code
		    and adbd.item_code = ai.item_code
	<where>

			<if test="group_id != null and group_id != ''">
				 adbd.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND adbd.hos_id = #{hos_id,jdbcType=INTEGER} 
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND adbd.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND adbd.dept_id = #{dept_id,jdbcType=INTEGER}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND adbd.acct_year = #{acct_year,jdbcType=VARCHAR}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND adbd.acct_month = #{acct_month,jdbcType=VARCHAR}
			</if>
			<if test="item_code != null and item_code != ''">
				AND adbd.item_code = #{item_code,jdbcType=VARCHAR}
			</if>
			 and exists(
		        select 1 from v_user_data_perm a where a.group_id = #{group_id,jdbcType = INTEGER}
		        and a.hos_id = #{hos_id,jdbcType = INTEGER} and a.copy_code = #{copy_code,jdbcType = VARCHAR}
		        and a.user_id = #{user_id,jdbcType = INTEGER}
		        and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
		        and a.perm_code = ad.dept_id and a.is_read = 1 and a.is_write = 1
		      )
		</where>
	
	</select>
	
	<!-- 审核 -->
	<select id="queryListDeptBonusData" resultMap="deptBonusData" parameterType="java.util.Map">
	select 
			   adbd.group_id,
		       adbd.hos_id,
		       adbd.copy_code,
		       ad.dept_code,
		        adbd.acct_year,
		       adbd.acct_month,
		       ad.dept_name,
		        ad.dept_code,
		        ad.dept_id,
		        ad.dept_no,
		        adbd.bonus_money,
		         adbd.item_code,
		     adbd.is_audit,
		     adbd.note
		  from aphi_dept_bonus_data adbd
		  left join aphi_dept_scheme ads 
		  on adbd.group_id = ads.group_id
		  and adbd.hos_id = ads.hos_id
		  and adbd.copy_code = ads.copy_code
		  and adbd.dept_id = ads.dept_id
		  and adbd.dept_no = ads.dept_no
		  and adbd.item_code = ads.item_code
		  left join aphi_dept_dict ad
		    on adbd.group_id = ad.group_id
		   and adbd.hos_id = ad.hos_id
		   and adbd.copy_code = ad.copy_code
		   and adbd.dept_id = ad.dept_id
		   and adbd.dept_no = ad.dept_no
		   and ad.is_stop = '0'
		<where>
			<if test="group_id != null and group_id != ''">
				AND adbd.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND adbd.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND adbd.copy_code = #{copy_code}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND adbd.acct_year = #{acct_year}
			</if>
			<if test="list != null and list.size >0">
			AND
			<foreach collection="list" index="index" item="item"  open="(" separator="OR" close=")">
			<if test="item.dept_id != null and item.dept_id != ''">
				 adbd.dept_id = #{item.dept_id}
			</if>
			<if test="item.dept_no != null and item.dept_no != ''">
				AND adbd.dept_no = #{item.dept_no}
			</if>
			<if test="item.item_code != null and item.item_code != ''">
				AND adbd.item_code = #{item.item_code}
			</if>
			<if test="item.item_codes != null and item.item_codes != ''">
				AND adbd.item_code = #{item.item_codes}
			</if>
			<if test="item.acct_year != null and item.acct_year != ''">
				AND adbd.acct_year = #{item.acct_year}
			</if>
			<if test="item.acct_month != null and item.acct_month != ''">
				AND adbd.acct_month = #{item.acct_month}
			</if>
			</foreach></if>
			<if test="acct_month != null and acct_month != ''">
				AND adbd.acct_month = #{acct_month}
			</if>
			<if test="item_code != null and item_code != ''">
				AND adbd.item_code = #{item_code}
			</if>
			<if test="item_codes != null and item_codes != ''">
				AND adbd.item_code = #{item_codes}
			</if>
			 and exists(
        select 1 from v_user_data_perm a where a.group_id = #{group_id,jdbcType = INTEGER}
        and a.hos_id = #{hos_id,jdbcType = INTEGER} and a.copy_code = #{copy_code,jdbcType = VARCHAR}
        and a.user_id = #{user_id,jdbcType = INTEGER}
        and a.mod_code = '09' and a.table_code = 'APHI_DEPT_DICT'
        and a.perm_code = adbd.dept_id and a.is_read = 1 and a.is_write = 1
      )
      <if test="audit_state == 1 ">
      		and not exists (select 1
          from aphi_dept_bonus_grant b
         where b.group_id = adbd.group_id
           and b.hos_id = adbd.hos_id
           and b.copy_code = adbd.copy_code
           and b.acct_year = adbd.acct_year
           and b.acct_month = adbd.acct_month
           and b.item_code = adbd.item_code
           and b.dept_id = adbd.dept_id)
      </if>
		</where>
	</select>
	
	
	<!-- 审核状态 -->
	<update id="updateBatch" parameterType="java.util.List">
	
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			UPDATE aphi_dept_bonus_data 
			<trim prefix="SET" suffixOverrides=",">
				<if test="item.is_audit != null and item.is_audit != ''">
					is_audit = #{item.is_audit},
				</if> 
			    <if test="item.user_code != null and item.user_code != ''">
					user_code = #{item.user_code} ,
				</if>
				<if test="item.audit_date != null and item.audit_date != ''">
					audit_date = #{item.audit_date} ,
				</if>
			</trim>
		   <where>
					 is_audit = 0
				<if test="item.group_id != null and item.group_id != ''">
				and	 group_id = #{item.group_id}
				</if>
				<if test="item.hos_id != null and item.hos_id != ''">
					AND hos_id = #{item.hos_id}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					AND copy_code = #{item.copy_code}
				</if> 
				<if test="item.dept_id != null and item.dept_id != ''">
					AND dept_id = #{item.dept_id}
				</if>
				<if test="item.dept_no != null and item.dept_no != ''">
					AND dept_no = #{item.dept_no}
				</if>
				<if test="item.acct_year != null and item.acct_year != ''">
					AND acct_year = #{item.acct_year}
				</if>
				<if test="item.acct_month != null and item.acct_month != ''">
					AND acct_month = #{item.acct_month}
				</if>
				<if test="item.item_code != null and item.item_code != ''">
					AND item_code = #{item.item_code}
				</if>
				
			</where>		
		</foreach>
	
	</update>
	
	<!-- 消申 -->
	<update id="updateBatchBack" parameterType="java.util.List">
	
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			UPDATE aphi_dept_bonus_data
			<trim prefix="SET" suffixOverrides=",">
				<if test="item.is_audit != null and item.is_audit != ''">
					is_audit = #{item.is_audit,jdbcType=INTEGER},
				</if>
					user_code = #{item.user_code,jdbcType=VARCHAR} ,
				    audit_date = #{item.audit_date,jdbcType=DATE} ,
				 
			</trim>
			<where>
					is_audit=1
				<if test="item.group_id != null and item.group_id != ''">
				and	 group_id = #{item.group_id,jdbcType=INTEGER}
				</if>
				<if test="item.hos_id != null and item.hos_id != ''">
					AND hos_id = #{item.hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
				</if> 
				<if test="item.dept_id != null and item.dept_id != ''">
					AND dept_id = #{item.dept_id,jdbcType=INTEGER}
				</if>
				<if test="item.dept_no != null and item.dept_no != ''">
					AND dept_no = #{item.dept_no,jdbcType=INTEGER}
				</if>
				<if test="item.acct_year != null and item.acct_year != ''">
					AND acct_year = #{item.acct_year,jdbcType=VARCHAR}
				</if>
				<if test="item.acct_month != null and item.acct_month != ''">
					AND acct_month = #{item.acct_month,jdbcType=VARCHAR}
				</if>
				<if test="item.item_code != null and item.item_code != ''">
					AND item_code = #{item.item_code,jdbcType=VARCHAR}
				</if>
			</where>
			</foreach>
	</update>
	
	
	<select id="queryHpmDeptBonusDataByCode_Audit" resultMap="deptBonusData"
		parameterType="string">

		select 
        max( adbd.is_audit ) is_audit
	  from aphi_dept_bonus_data adbd
	 	<where>
				<if test="group_id != null and group_id != ''">
					AND adbd.group_id = #{group_id}
				</if>
				<if test="hos_id != null and hos_id != ''">
					AND adbd.hos_id = #{hos_id}
				</if>
				<if test="copy_code != null and copy_code != ''">
					AND adbd.copy_code = #{copy_code}
				</if>
				<if test="acct_year != null and acct_year != ''">
					AND adbd.acct_year = #{acct_year}
				</if>
				<if test="acct_month != null and acct_month != ''">
					AND adbd.acct_month = #{acct_month}
				</if>
				<if test="item_code != null and item_code != ''">  
					AND adbd.item_code = #{item_code}
				</if>
				<if test="dept_id != null and dept_id != ''">
					AND adbd.dept_id = #{dept_id}
				</if>
				<if test="dept_no != null and dept_no != ''">
					AND adbd.dept_no = #{dept_no}
				</if>
				<if test="list != null and list.size >0">
				AND
				<foreach collection="list" index="index" item="item"  open="(" separator="OR" close=")">
				
				<if test="item.dept_id != null and item.dept_id != ''">
					adbd.dept_id = #{item.dept_id} 
				</if>
				<if test="item.dept_no != null and item.dept_no != ''">
					AND adbd.dept_no = #{item.dept_no}  
				</if>
				</foreach></if>
			</where>

	</select>
	
	<select id="queryHpmDeptBonusDataByCode_AuditList" resultMap="deptBonusData" parameterType="java.util.Map">
	select adbd.acct_year, adbd.acct_month
			
      , adbd.dept_id, adbd.dept_no,adbd.is_audit
   		 from aphi_dept_bonus_data adbd
		<where>
			<if test="group_id != null and group_id != ''">
				AND adbd.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND adbd.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND adbd.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="acct_year != null and acct_year != ''">
				AND adbd.acct_year = #{acct_year,jdbcType=VARCHAR}
			</if>
			<if test="acct_month != null and acct_month != ''">
				AND adbd.acct_month = #{acct_month,jdbcType=VARCHAR}
			</if>
			<if test="item_codes != null and item_codes != ''">
				AND adbd.item_code = #{item_codes,jdbcType=VARCHAR}
			</if>
			<if test="list != null and list.size >0">
			AND
			<foreach collection="list" index="index" item="item"  open="(" separator="OR" close=")">
			
			<if test="item.dept_id != null and item.dept_id != ''">
				adbd.dept_id = #{item.dept_id,jdbcType=INTEGER} 
			</if>
			<if test="item.dept_no != null and item.dept_no != ''">
				AND adbd.dept_no = #{item.dept_no,jdbcType=INTEGER}  
			</if>
			<if test="item.item_codes != null and item.item_codes != ''">
				AND adbd.item_code = #{item.item_codes,jdbcType=INTEGER}  
			</if>
			</foreach></if>
			
		</where>
	
	</select>
	
</mapper>

