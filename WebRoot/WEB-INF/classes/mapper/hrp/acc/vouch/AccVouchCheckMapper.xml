<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.acc.dao.vouch.AccVouchCheckMapper">

	<resultMap id="accVouchCheck" type="com.chd.hrp.acc.entity.AccVouchCheck">
		<result property="veri_id" column="veri_id" />
		<result property="vouch_check_id" column="vouch_check_id" />
		<result property="bank_id" column="bank_id" />
		<result property="vouch_id" column="vouch_id" />
		<result property="vouch_detail_id" column="vouch_detail_id" />
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="acc_year" column="acc_year" />
		<result property="subj_name" column="subj_name" />
		<result property="summary" column="summary" />
		<result property="debit" column="debit" />
		<result property="credit" column="credit" />
		<result property="con_no" column="con_no" />
		<result property="check_no" column="check_no" />
		<result property="business_no" column="business_no" />
		<result property="occur_date" column="occur_date" />
		<result property="due_date" column="due_date" />
		<result property="pay_type_code" column="pay_type_code" />
		<result property="pay_name" column="pay_name" />
		<result property="debit_w" column="debit_w" />
		<result property="credit_w" column="credit_w" />
		<result property="check1_id" column="check1_id" />
		<result property="check1_no" column="check1_no" />
		<result property="check2_id" column="check2_id" />
		<result property="check2_no" column="check2_no" />
		<result property="check3_id" column="check3_id" />
		<result property="check3_no" column="check3_no" />
		<result property="check4_id" column="check4_id" />
		<result property="check4_no" column="check4_no" />
		<result property="check5_id" column="check5_id" />
		<result property="check5_no" column="check5_no" />
		<result property="check6_id" column="check6_id" />
		<result property="check6_no" column="check6_no" />
		<result property="check7_id" column="check7_id" />
		<result property="check1" column="check1" />
		<result property="check2" column="check2" />
		<result property="check3" column="check3" />
		<result property="check4" column="check4" />
		<result property="check5" column="check5" />
		<result property="check6" column="check6" />
		<result property="check7" column="check7" />
		<result property="is_init" column="is_init" />
		<result property="old_check_id" column="old_check_id" />
		<result property="balance" column="balance" />
		<result property="cus_code" column="cus_code" />
		<result property="cus_name" column="cus_name" />
		<result property="dept_code" column="dept_code" />
		<result property="dept_name" column="dept_name" />
		<result property="emp_code" column="emp_code" />
		<result property="emp_name" column="emp_name" />
		<result property="proj_code" column="proj_code" />
		<result property="proj_name" column="proj_name" />
		<result property="store_code" column="store_code" />
		<result property="store_name" column="store_name" />
		<result property="sup_code" column="sup_code" />
		<result property="sup_name" column="sup_name" />
		<result property="source_code" column="source_code" />
		<result property="source_name" column="source_name" />
		<result property="check_item_code" column="check_item_code" />
		<result property="check_item_name" column="check_item_name" />
		<result property="is_checks" column="is_checks" />
		<result property="is_auto" column="is_auto" />
		<result property="vouch_no" column="vouch_no"/>
		<result property="subj_dire" column="subj_dire"/>
		
		<result property="other_subj_name" column="other_subj_name"/>
		<result property="other_money" column="other_money"/>
		<result property="bal" column="bal"/>
		<result property="v_year" column="v_year"/>
		<result property="v_month" column="v_month"/>
		<result property="v_day" column="v_day"/>
		<result property="is_check" column="is_check"/>
		<result property="money" column="money"/>
	</resultMap>
	<resultMap id="accVouchVeri" type="java.util.Map">
		<result property="veri_id" column="veri_id" />
		<result property="debit_check_id" column="debit_check_id" />
		<result property="credit_check_id" column="credit_check_id" />
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="acc_year" column="acc_year" />
		<result property="veri_money" column="veri_money" />
		<result property="veri_money_w" column="veri_money_w" />
		<result property="create_user" column="create_user" />
		<result property="create_date" column="create_date" />
		<result property="veri_check_id" column="veri_check_id" />
	</resultMap>
	
	<insert id="addAccVouchCheck" useGeneratedKeys="true">

		INSERT INTO ACC_VOUCH_CHECK (
			vouch_check_id		,
			vouch_id		,
			vouch_detail_id		,
			group_id		,
			hos_id		,
			copy_code		,
			acc_year		,
			subj_code		,
			summary		,
			debit		,
			credit		,
			con_no		,
			check_no		,
			business_no		,
			occur_date		,
			due_date		,
			pay_type_code		,
			debit_w		,
			credit_w		,
			check1_id		,
			check1_no		,
			check2_id		,
			check2_no		,
			check3_id		,
			check3_no		,
			check4_id		,
			check4_no		,
			check5_id		,
			check5_no		,
			check6_id		,
			check6_no		,
			check7_id		,
			is_init		,
			old_check_id
		) VALUES (
		<!-- ACC_VOUCH_CHECK_SEQ.nextval , -->
			#{vouch_check_id} ,
			#{vouch_id} ,
			#{vouch_detail_id} ,
			#{group_id} ,
			#{hos_id} ,
			#{copy_code} ,
			#{acc_year} ,
			#{subj_code} ,
			#{summary} ,
			#{debit} ,
			#{credit} ,
			#{con_no} ,
			#{check_no} ,
			#{business_no} ,
			to_date(#{occur_date},'yyyy/MM/dd'),
			to_date(#{due_date},'yyyy/MM/dd'),
			
			#{pay_type_code} ,
			#{debit_w} ,
			#{credit_w} ,
			#{check1_id} ,
			#{check1_no} ,
			#{check2_id} ,
			#{check2_no} ,
			#{check3_id} ,
			#{check3_no} ,
			#{check4_id} ,
			#{check4_no} ,
			#{check5_id} ,
			#{check5_no} ,
			#{check6_id} ,
			#{check6_no} ,
			#{check7_id} ,
			#{is_init} ,
			#{old_check_id}
		)
	</insert>
	
	<insert id="addBatchAccVouchCheck" parameterType="java.util.List">
		INSERT INTO ACC_VOUCH_CHECK (
			vouch_check_id,vouch_id,vouch_detail_id,group_id,hos_id,copy_code,acc_year,
			subj_code,summary,debit,credit,con_no,check_no,business_no,occur_date,
	    	due_date, pay_type_code,debit_w,credit_w,
			check1_id,check1_no,
			check2_id,check2_no,
			check3_id,check3_no,
			check4_id,check4_no,
			check5_id,check5_no,
			check6_id,check6_no,
			check7_id,
			is_init,old_check_id
		)
		select
			ACC_VOUCH_CHECK_SEQ.nextval ,a.* from (
		<foreach collection="list" item="item" index="index" separator=" union all ">
			select
				#{item.vouch_id,jdbcType=NUMERIC} ,
				#{item.vouch_detail_id,jdbcType=NUMERIC} ,
				#{item.group_id,jdbcType=NUMERIC} ,
				#{item.hos_id,jdbcType=NUMERIC} ,
				#{item.copy_code,jdbcType=VARCHAR} ,
				#{item.acc_year,jdbcType=VARCHAR} ,
				#{item.subj_code,jdbcType=VARCHAR} ,
				#{item.summary,jdbcType=VARCHAR} ,
				#{item.debit,jdbcType=NUMERIC} ,
				#{item.credit,jdbcType=NUMERIC} ,
				#{item.con_no,jdbcType=VARCHAR} ,
				#{item.check_no,jdbcType=VARCHAR} ,
				#{item.business_no,jdbcType=VARCHAR} ,
				to_date(#{item.occur_date,jdbcType=DATE},'yyyy-MM-dd'),
				to_date(#{item.due_date,jdbcType=DATE},'yyyy-MM-dd'),
				#{item.pay_type_code,jdbcType=VARCHAR} ,
				#{item.debit_w,jdbcType=NUMERIC} ,
				#{item.credit_w,jdbcType=NUMERIC} ,
				#{item.check1_id,jdbcType=NUMERIC} ,
				#{item.check1_no,jdbcType=NUMERIC} ,
				#{item.check2_id,jdbcType=NUMERIC} ,
				#{item.check2_no,jdbcType=NUMERIC} ,
				#{item.check3_id,jdbcType=NUMERIC} ,
				#{item.check3_no,jdbcType=NUMERIC} ,
				#{item.check4_id,jdbcType=NUMERIC} ,
				#{item.check4_no,jdbcType=NUMERIC} ,
				#{item.check5_id,jdbcType=NUMERIC} ,
				#{item.check5_no,jdbcType=NUMERIC} ,
				#{item.check6_id,jdbcType=NUMERIC} ,
				#{item.check6_no,jdbcType=NUMERIC} ,
				#{item.check7_id,jdbcType=NUMERIC} ,
				#{item.is_init,jdbcType=NUMERIC} ,
				#{item.old_check_id,jdbcType=NUMERIC}
			from dual
		</foreach>
		) a 
	</insert>
	
	
	<insert id="addBatchAccVouchCheckImport" parameterType="java.util.Map">
		INSERT INTO ACC_VOUCH_CHECK (
			vouch_check_id,vouch_id,group_id,hos_id,copy_code,acc_year,
			subj_code,summary,debit,credit,con_no,business_no,occur_date,due_date,
			debit_w,credit_w,${sql}
			is_init
		)
		
		<foreach collection="itemList" item="item" index="index" separator=" union all ">
			select
				#{item.vouch_check_ids},
				#{item.vouch_id},
				#{item.group_id} ,
				#{item.hos_id} ,
				#{item.copy_code} ,
				#{item.acc_year} ,
				#{item.subj_code} ,
				#{item.summary} ,
				#{item.debit} ,
				#{item.credit} ,
				#{item.con_no} ,
				#{item.business_no} ,
				to_date(#{item.occur_date},'yyyy-MM-dd'),
				to_date(#{item.due_date},'yyyy-MM-dd'),
				0,
				0 ,
				${item.sqlValue} 
				1 
			from dual
		</foreach>
	</insert>

	<update id="updateAccVouchCheck" parameterType="java.util.Map">
		 UPDATE acc_vouch_check SET subj_code = #{subj_code} ,
			 summary = #{summary} ,
			 debit = #{debit} ,
			 credit = #{credit} ,
			 check_no = #{check_no} ,
			 occur_date = to_date(#{occur_date},'YYYY/MM/DD') ,
			 pay_type_code = #{pay_type_code}
        WHERE vouch_check_id = #{vouch_check_id}
	</update>
	
	<insert id="addBatchAccVouchCheckOfMoney" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			INSERT INTO ACC_VOUCH_CHECK (
				vouch_check_id,vouch_id,vouch_detail_id,group_id,hos_id,copy_code,acc_year,
				subj_code,summary,debit,credit,con_no,business_no,occur_date,due_date,
				debit_w,credit_w ${item.column_name}, is_init
			)
			select #{item.new_vouch_check_id},
				#{item.new_vouch_id},
				#{item.new_vouch_detail_id},
				group_id,hos_id,copy_code,acc_year,subj_code,summary,debit*-1,credit*-1,con_no,business_no,occur_date,due_date,
			debit_w,credit_w ${item.column_name}, is_init
			from ACC_VOUCH_CHECK
			where group_id=#{item.group_id} and hos_id =#{item.hos_id} and copy_code=#{item.copy_code}
				and acc_year=#{item.acc_year} and vouch_id =#{item.vouch_id} and vouch_detail_id =#{item.vouch_detail_id}
				and vouch_check_id =#{item.vouch_check_id}	
		</foreach>
	</insert>
	
	<update id="updateBatchAccVouchCheck" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			UPDATE acc_vouch_check SET
				vouch_id = #{item.vouch_id,jdbcType=NUMERIC},
				vouch_detail_id = #{item.vouch_detail_id,jdbcType=NUMERIC},
				group_id = #{item.group_id,jdbcType=NUMERIC},
				hos_id = #{item.hos_id,jdbcType=NUMERIC},
				copy_code = #{item.copy_code,jdbcType=VARCHAR},
				acc_year = #{item.acc_year,jdbcType=VARCHAR},
				subj_code = #{item.subj_code,jdbcType=VARCHAR},
				summary = #{item.summary,jdbcType=VARCHAR},
				debit = #{item.debit,jdbcType=NUMERIC},
				credit = #{item.credit,jdbcType=NUMERIC},
				con_no = #{item.con_no,jdbcType=VARCHAR},
				check_no = #{item.check_no,jdbcType=VARCHAR},
				business_no = #{item.business_no,jdbcType=VARCHAR},
				occur_date = to_date(#{item.occur_date,jdbcType=DATE},'yyyy/mm/dd'),
				due_date = to_date(#{item.due_date,jdbcType=DATE},'yyyy/mm/dd'),
				pay_type_code = #{item.pay_type_code,jdbcType=VARCHAR},
				debit_w = #{item.debit_w,jdbcType=NUMERIC},
				credit_w = #{item.credit_w,jdbcType=NUMERIC},
				check1_id = #{item.check1_id,jdbcType=NUMERIC},
				check1_no = #{item.check1_no,jdbcType=NUMERIC},
				check2_id = #{item.check2_id,jdbcType=NUMERIC},
				check2_no = #{item.check2_no,jdbcType=NUMERIC},
				check3_id = #{item.check3_id,jdbcType=NUMERIC},
				check3_no = #{item.check3_no,jdbcType=NUMERIC},
				check4_id = #{item.check4_id,jdbcType=NUMERIC},
				check4_no = #{item.check4_no,jdbcType=NUMERIC},
				check5_id = #{item.check5_id,jdbcType=NUMERIC},
				check5_no = #{item.check5_no,jdbcType=NUMERIC},
				check6_id = #{item.check6_id,jdbcType=NUMERIC},
				check6_no = #{item.check6_no,jdbcType=NUMERIC},
				check7_id = #{item.check7_id,jdbcType=NUMERIC},
				is_init = #{item.is_init,jdbcType=NUMERIC},
				old_check_id = #{item.old_check_id,jdbcType=NUMERIC}
			WHERE vouch_check_id = #{item.vouch_check_id,jdbcType=NUMERIC}
		</foreach>
	</update>

	<delete id="deleteAccVouchCheck" parameterType="java.util.Map">
		DELETE FROM acc_vouch_check 
		<where>
			<if test="vouch_check_id != null and vouch_check_id != ''">
				and vouch_check_id = #{vouch_check_id}
			</if> 
			<if test="vouch_id != null and vouch_id != ''">
			 	and vouch_id = #{vouch_id}
			</if>
			<if test="group_id != null and group_id != ''">
				and  group_id  = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and  hos_id  = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and  copy_code = #{copy_code}
			</if>
			<if test="acc_year != null and acc_year != ''">
				and acc_year=#{acc_year}
			</if>
			<if test="subj_code != null and subj_code != ''">
				and subj_code=#{subj_code}
			</if>
		</where>
	</delete>
	
	<delete id="deleteBatchAccVouchCheck" parameterType="java.util.List">
		<foreach collection="list" index="index" item="item" open="begin" close=";end;" separator=";">
			DELETE FROM acc_vouch_check 
			<where>
			 	<if test="item.vouch_check_id != null and item.vouch_check_id != ''">
					and vouch_check_id = #{item.vouch_check_id}
				</if> 
				<if test="item.vouch_id != null and item.vouch_id != ''">
				 	and vouch_id = #{item.vouch_id}
				</if>
				<if test="item.group_id != null and item.group_id != ''">
					and  group_id  = #{item.group_id}
				</if>
				<if test="item.hos_id != null and item.hos_id != ''">
					and  hos_id  = #{item.hos_id}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					and  copy_code = #{item.copy_code}
				</if>
				<if test="item.acc_year != null and item.acc_year != ''">
					and acc_year=#{item.acc_year}
				</if>
				<if test="item.subj_code != null and item.subj_code != ''">
					and subj_code=#{item.subj_code}
				</if>
			</where>
		</foreach>
	</delete>
	
	<select id="getIsAccFlag" resultType="com.chd.hrp.acc.entity.AccVouchCheck" parameterType="string">
		select hos_id,group_id,copy_code from (
			select hos_id,group_id,copy_code from acc_year_month 
			where acc_flag=1 
			and group_id  = #{group_id}
			and  hos_id    = #{hos_id}
			and  copy_code = #{copy_code}
		) where rownum=1 
	</select>
	
	<select id="queryAccVouchVeri" resultType="java.lang.Long">
 		select count(1) from  acc_vouch_veri
  		where 
         		(DEBIT_CHECK_ID = #{vouch_check_id} or  CREDIT_CHECK_ID = #{vouch_check_id})
			AND group_id = #{group_id}
			AND hos_id = #{hos_id}
			AND copy_code = #{copy_code}
	        and  acc_year=#{acc_year}
	  <!-- 
		select count(1) from acc_vouch_veri
		where 
	         vouch_check_id = #{vouch_check_id}
			AND group_id = #{group_id}
			AND hos_id = #{hos_id}
			AND copy_code = #{copy_code}
	       and debit_check_id = #{debit_check_id}
	       and credit_check_id =#{credit_check_id} -->
	</select> 
	
	<select id="queryAccVouchCheckByCode" resultMap="accVouchCheck" parameterType="java.util.Map">

		SELECT
		avc.vouch_check_id,
		avc.vouch_id,
		avc.vouch_detail_id,
		avc.group_id,
		avc.hos_id,
		avc.copy_code,
		avc.acc_year,
		avc.subj_code,
		avc.summary,
		avc.debit,
		avc.credit,
		avc.con_no,
		avc.check_no,
		avc.business_no,
		avc.occur_date,
		avc.due_date,
		avc.pay_type_code,
		avc.debit_w,
		avc.credit_w,
		avc.check1_id,
		avc.check1_no,
		avc.check2_id,
		avc.check2_no,
		avc.check3_id,
		avc.check3_no,
		avc.check4_id,
		avc.check4_no,
		avc.check5_id,
		avc.check5_no,
		avc.check6_id,
		avc.check6_no,
		avc.check7_id,
		avc.is_init,
		avc.old_check_id,
		sa.subj_name,
		apt.pay_name
		FROM acc_vouch_check avc
		LEFT JOIN acc_subj sa ON avc.group_id = sa.group_id
			AND avc.hos_id = sa.hos_id
			AND avc.copy_code = sa.copy_code
			AND avc.acc_year = sa.acc_year
			AND avc.subj_code = sa.subj_code
		LEFT JOIN acc_pay_type apt ON avc.group_id = apt.group_id
			AND avc.hos_id = apt.hos_id
			AND avc.copy_code = apt.copy_code
			AND avc.pay_type_code = apt.pay_code
		WHERE avc.vouch_check_id = #{vouch_check_id}
			AND avc.group_id = #{group_id}
			AND avc.hos_id = #{hos_id}
			AND avc.copy_code = #{copy_code}
	</select>

	<select id="queryAccVouchCheckBySubjCode" resultMap="accVouchCheck" parameterType="java.util.Map">

		SELECT
			vouch_check_id,
			vouch_id,
			vouch_detail_id,
			group_id,
			hos_id,
			copy_code,
			acc_year,
			subj_code,
			summary,
			debit,
			credit,
			con_no,
			check_no,
			business_no,
			occur_date,
			due_date,
			pay_type_code,
			debit_w,
			credit_w,
			check1_id,
			check1_no,
			check2_id,
			check2_no,
			check3_id,
			check3_no,
			check4_id,
			check4_no,
			check5_id,
			check5_no,
			check6_id,
			check6_no,
			check7_id,
			is_init,
			old_check_id
		FROM acc_vouch_check
		WHERE
				group_id = #{group_id}
			and hos_id = #{hos_id}
			and copy_code = #{copy_code}
			and acc_year = #{acc_year}
			and subj_code = #{subj_code}
	</select>

	<select id="queryVeriVouchCheck" parameterType="java.util.Map" resultMap="accVouchCheck">
		select
			hdd.dept_id,hdd.dept_name,hdd.dept_code,hed.emp_id,hed.emp_code,hed.emp_name,
			avc.occur_date,avt.vouch_type_name||'-'||av.vouch_no vouch_code,
			avc.summary,avc.debit,avv.veri_money,3 veri
		from ACC_VOUCH_CHECK avc
		inner join ACC_VOUCH_VERI avv on avc.vouch_check_id = avv.DEBIT_CHECK_ID and
			avc.vouch_check_id = avv.CREDIT_CHECK_ID and
			avc.group_id = avv.group_id and
			avc.hos_id = avv.hos_id and
			avc.copy_code = avv.copy_code and
			avc.acc_year = avv.acc_year
		left join HOS_EMP_DICT hed on avc.CHECK2_ID = hed.emp_id and
			hed.is_stop = 0 and avc.group_id = hed.group_id and avc.hos_id = hed.hos_id
		left join HOS_DEPT_DICT hdd on
			avc.CHECK1_ID = hdd.dept_id and
			hdd.is_stop = 0 and
			avc.group_id = hdd.group_id and
			avc.hos_id = hdd.hos_id
		left join ACC_VOUCH av on
			avc.group_id = av.group_id and
			avc.hos_id = av.hos_id and
			avc.copy_code = av.copy_code and
			avc.acc_year = av.acc_year and
			avc.vouch_id = av.vouch_id
		left join ACC_VOUCH_TYPE avt on
			av.group_id = avt.group_id and
			av.hos_id = avt.group_id and
			av.copy_code = avt.copy_code and
			av.vouch_type_code = avt.vouch_type_code
		<where>
			avc.occur_date = #{occur_date}
			AND avc.GROUP_ID = #{group_id}
			AND avc.HOS_ID = #{hos_id}
			AND avc.COPY_CODE = #{copy_code}
			AND avc.acc_year = #{acc_year}
			AND avc.SUBJ_CODE = #{subj_code}
			and ${state}
			<if test="emp_id != null and emp_id != ''">
				AND hed.emp_id = #{emp_id}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND hdd.dept_id = #{dept_id}
			</if>
		</where>
	</select>

	<select id="queryNotVeriVouchCheck" parameterType="java.util.Map" resultMap="accVouchCheck">
		select
			hdd.dept_id,hdd.dept_name,hdd.dept_code,hed.emp_id,hed.emp_code,hed.emp_name,
			avc.occur_date,avt.vouch_type_name||'-'||av.vouch_no vouch_code,
			avc.summary,avc.debit,avv.veri_money,1 veri
		from ACC_VOUCH_CHECK avc
		left join ACC_VOUCH_VERI avv on
			avc.vouch_check_id = avv.DEBIT_CHECK_ID and
			avc.vouch_check_id = avv.CREDIT_CHECK_ID and
			avc.group_id = avv.group_id and
			avc.hos_id = avv.hos_id and
			avc.copy_code = avv.copy_code and
			avc.acc_year = avv.acc_year
		left join HOS_EMP_DICT hed on
			avc.CHECK2_ID = hed.emp_id and
			hed.is_stop = 0 and
			avc.group_id = hed.group_id and
			avc.hos_id = hed.hos_id
		left join HOS_DEPT_DICT hdd on
			avc.CHECK1_ID = hdd.dept_id and
			hdd.is_stop = 0 and
			avc.group_id = hdd.group_id and
			avc.hos_id = hdd.hos_id
		left join ACC_VOUCH av on
			avc.group_id = av.group_id and
			avc.hos_id = av.hos_id and
			avc.copy_code = av.copy_code and
			avc.acc_year = av.acc_year and
			avc.vouch_id = av.vouch_id
		left join ACC_VOUCH_TYPE avt on
			av.group_id = avt.group_id and
			av.hos_id = avt.group_id and
			av.copy_code = avt.copy_code and
			av.vouch_type_code = avt.vouch_type_code
		<where>
			avv.DEBIT_CHECK_ID is null
			AND avc.occur_date = #{occur_date}
			AND avc.GROUP_ID = #{group_id}
			AND avc.HOS_ID = #{hos_id}
			AND avc.COPY_CODE = #{copy_code}
			AND avc.acc_year = #{acc_year}
			AND avc.SUBJ_CODE = #{subj_code}
			and ${state}
			<if test="emp_id != null and emp_id != ''">
				AND hed.emp_id = #{emp_id}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND hdd.dept_id = #{dept_id}
			</if>
		</where>
	</select>

	<select id="queryPartVeriVouchCheck" parameterType="java.util.Map" resultMap="accVouchCheck">
		select
			hdd.dept_id,hdd.dept_name,hdd.dept_code,hed.emp_id,hed.emp_code,hed.emp_name,
			avc.occur_date,avt.vouch_type_name||'-'||av.vouch_no vouch_code,
			avc.summary,avc.debit,avv.veri_money,2 veri
		from ACC_VOUCH_CHECK avc
		inner join ACC_VOUCH_VERI avv on
			avc.vouch_check_id = avv.DEBIT_CHECK_ID and
			avc.vouch_check_id = avv.CREDIT_CHECK_ID and
			avc.group_id = avv.group_id and
			avc.hos_id = avv.hos_id and
			avc.copy_code = avv.copy_code and
			avc.acc_year = avv.acc_year
		left join HOS_EMP_DICT hed on
			avc.CHECK2_ID = hed.emp_id and
			hed.is_stop = 0 and
			avc.group_id = hed.group_id and
			avc.hos_id = hed.hos_id
		left join HOS_DEPT_DICT hdd on
			avc.CHECK1_ID = hdd.dept_id and
			hdd.is_stop = 0 and
			avc.group_id = hdd.group_id and
			avc.hos_id = hdd.hos_id
		left join ACC_VOUCH av on
			avc.group_id = av.group_id and
			avc.hos_id = av.hos_id and
			avc.copy_code = av.copy_code and
			avc.acc_year = av.acc_year and
			avc.vouch_id = av.vouch_id
		left join ACC_VOUCH_TYPE avt on
			av.group_id = avt.group_id and
			av.hos_id = avt.group_id and
			av.copy_code = avt.copy_code and
			av.vouch_type_code = avt.vouch_type_code
		<where>
			avc.debit - avv.veri_money != 0
			AND avc.occur_date = #{occur_date}
			AND avc.GROUP_ID = #{group_id}
			AND avc.HOS_ID = #{hos_id}
			AND avc.COPY_CODE = #{copy_code}
			AND avc.acc_year = #{acc_year}
			AND avc.SUBJ_CODE = #{subj_code}
			and ${state}
			<if test="emp_id != null and emp_id != ''">
				AND hed.emp_id = #{emp_id}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND hdd.dept_id = #{dept_id}
			</if>
		</where>
	</select>

	<select id="queryAllVeriVouchCheck" parameterType="java.util.Map" resultMap="accVouchCheck">
		select
			hdd.dept_id,hdd.dept_name,hdd.dept_code,hed.emp_id,hed.emp_code,hed.emp_name,
			avc.occur_date,avt.vouch_type_name||'-'||av.vouch_no vouch_code,
			avc.summary,avc.debit,avv.veri_money,3 veri
		from ACC_VOUCH_CHECK avc
		inner join ACC_VOUCH_VERI avv on
			avc.vouch_check_id = avv.DEBIT_CHECK_ID and
			avc.vouch_check_id = avv.CREDIT_CHECK_ID and
			avc.group_id = avv.group_id and
			avc.hos_id = avv.hos_id and
			avc.copy_code = avv.copy_code and
			avc.acc_year = avv.acc_year
		left join HOS_EMP_DICT hed on
			avc.CHECK2_ID = hed.emp_id and
			hed.is_stop = 0 and
			avc.group_id = hed.group_id and
			avc.hos_id = hed.hos_id
		left join HOS_DEPT_DICT hdd on
			avc.CHECK1_ID = hdd.dept_id and
			hdd.is_stop = 0 and
			avc.group_id = hdd.group_id and
			avc.hos_id = hdd.hos_id
		left join ACC_VOUCH av on
			avc.group_id = av.group_id and
			avc.hos_id = av.hos_id and
			avc.copy_code = av.copy_code and
			avc.acc_year = av.acc_year and
			avc.vouch_id = av.vouch_id
		left join ACC_VOUCH_TYPE avt on
			av.group_id = avt.group_id and
			av.hos_id = avt.group_id and
			av.copy_code = avt.copy_code and
			av.vouch_type_code = avt.vouch_type_code
		<where>
			avc.occur_date = #{occur_date}
			AND avc.GROUP_ID = #{group_id}
			AND avc.HOS_ID = #{hos_id}
			AND avc.COPY_CODE = #{copy_code}
			AND avc.acc_year = #{acc_year}
			AND avc.SUBJ_CODE = #{subj_code}
			and ${state}
			<if test="emp_id != null and emp_id != ''">
				AND hed.emp_id = #{emp_id}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND hdd.dept_id = #{dept_id}
			</if>
		</where>
		union all
		select
			hdd.dept_id,hdd.dept_name,hdd.dept_code,hed.emp_id,hed.emp_code,hed.emp_name,
			avc.occur_date,avt.vouch_type_name||'-'||av.vouch_no vouch_code,
			avc.summary,avc.debit,avv.veri_money,1 veri
		from ACC_VOUCH_CHECK avc
		left join ACC_VOUCH_VERI avv on
			avc.vouch_check_id = avv.DEBIT_CHECK_ID and
			avc.vouch_check_id = avv.CREDIT_CHECK_ID and
			avc.group_id = avv.group_id and
			avc.hos_id = avv.hos_id and
			avc.copy_code = avv.copy_code and
			avc.acc_year = avv.acc_year
		left join HOS_EMP_DICT hed on
			avc.CHECK2_ID = hed.emp_id and
			hed.is_stop = 0 and
			avc.group_id = hed.group_id and
			avc.hos_id = hed.hos_id
		left join HOS_DEPT_DICT hdd on
			avc.CHECK1_ID = hdd.dept_id and
			hdd.is_stop = 0 and
			avc.group_id = hdd.group_id and
			avc.hos_id = hdd.hos_id
		left join ACC_VOUCH av on
			avc.group_id = av.group_id and
			avc.hos_id = av.hos_id and
			avc.copy_code = av.copy_code and
			avc.acc_year = av.acc_year and
			avc.vouch_id = av.vouch_id
		left join ACC_VOUCH_TYPE avt on
			av.group_id = avt.group_id and
			av.hos_id = avt.group_id and
			av.copy_code = avt.copy_code and
			av.vouch_type_code = avt.vouch_type_code
		<where>
			avv.DEBIT_CHECK_ID is null
			AND avc.occur_date = #{occur_date}
			AND avc.GROUP_ID = #{group_id}
			AND avc.HOS_ID = #{hos_id}
			AND avc.COPY_CODE = #{copy_code}
			AND avc.acc_year = #{acc_year}
			AND avc.subj_code = #{subj_code}
			and ${state}
			<if test="emp_id != null and emp_id != ''">
				AND hed.emp_id = #{emp_id}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND hdd.dept_id = #{dept_id}
			</if>
		</where>
		union all
		select
		hdd.dept_id,hdd.dept_name,hdd.dept_code,hed.emp_id,hed.emp_code,hed.emp_name,
		avc.occur_date,avt.vouch_type_name||'-'||av.vouch_no vouch_code,
		avc.summary,avc.debit,avv.veri_money,2 veri
		from ACC_VOUCH_CHECK avc

		inner join ACC_VOUCH_VERI avv on
			avc.vouch_check_id = avv.DEBIT_CHECK_ID and
			avc.vouch_check_id = avv.CREDIT_CHECK_ID and
			avc.group_id = avv.group_id and
			avc.hos_id = avv.hos_id and
			avc.copy_code = avv.copy_code and
			avc.acc_year = avv.acc_year
		left join HOS_EMP_DICT hed on
			avc.CHECK2_ID = hed.emp_id and
			hed.is_stop = 0 and
			avc.group_id = hed.group_id and
			avc.hos_id = hed.hos_id
		left join HOS_DEPT_DICT hdd on
			avc.CHECK1_ID = hdd.dept_id and
			hdd.is_stop = 0 and
			avc.group_id = hdd.group_id and
			avc.hos_id = hdd.hos_id
		left join ACC_VOUCH av on
			avc.group_id = av.group_id and
			avc.hos_id = av.hos_id and
			avc.copy_code = av.copy_code and
			avc.acc_year = av.acc_year and
			avc.vouch_id = av.vouch_id
		left join ACC_VOUCH_TYPE avt on
			av.group_id = avt.group_id and
			av.hos_id = avt.group_id and
			av.copy_code = avt.copy_code and
			av.vouch_type_code = avt.vouch_type_code
		<where>
			avc.debit - avv.veri_money != 0
			AND avc.occur_date = #{occur_date}
			AND avc.GROUP_ID = #{group_id}
			AND avc.HOS_ID = #{hos_id}
			AND avc.COPY_CODE = #{copy_code}
			AND avc.acc_year = #{acc_year}
			AND avc.subj_code = #{subj_code}
			and ${state}
			<if test="emp_id != null and emp_id != ''">
				AND hed.emp_id = #{emp_id}
			</if>
			<if test="dept_id != null and dept_id != ''">
				AND hdd.dept_id = #{dept_id}
			</if>
		</where>
	</select>

	<select id="queryReceivableAccount" parameterType="java.util.Map" resultMap="accVouchCheck">
		select ${checkCol} 
			abs(nvl(a.debit,0)-nvl(a.credit,0))-nvl(a.bal_amt,0) as balance,
			a.due_date, a.occur_date,
			
		from acc_vouch_check a
		 inner join ${tableName} b on a.hos_id = b.hos_id  and a.group_id = b.group_id  ${check} 
       	 left join acc_vouch av on av.vouch_id = a.vouch_id
       	 	and av.group_id = a.group_id
       	 	and av.hos_id = a.hos_id
       	 	and av.acc_year = a.acc_year
       	 	and av.copy_code = a.copy_code 
		 where a.copy_code = #{copy_code}
		 	and a.hos_id = #{hos_id}
		 	and a.group_id = #{group_id}
		 	and a.acc_year = #{acc_year} 
		 	<if test="subj_code != null and subj_code != ''">
		 		and a.subj_code = #{subj_code}
		 	</if>
		 	${date_check}
			${state}
	</select>

	<!-- select id="queryAccVouchCheck" parameterType="java.util.Map" resultMap="accVouchCheck">

		SELECT
		avc.vouch_check_id bank_id,
		avc.vouch_check_id,
		avc.vouch_id,
		avc.vouch_detail_id,
		avc.group_id,
		avc.hos_id,
		avc.copy_code,
		avc.acc_year,
		avc.subj_id,
		avc.summary,
		avc.debit,
		avc.credit,
		avc.con_no,
		avc.check_no,
		avc.business_no,
		avc.occur_date,
		avc.due_date,
		avc.pay_type_code,
		avc.debit_w,
		avc.credit_w,
		avc.check1_id||'.'||avc.check1_no check1,
		avc.check2_id||'.'||avc.check2_no check2,
		avc.check3_id||'.'||avc.check3_no check3,
		avc.check4_id||'.'||avc.check4_no check4,
		avc.check5_id||'.'||avc.check5_no check5,
		avc.check6_id||'.'||avc.check6_no check6,
		avc.check7_id||'.'||0 check7,
		avc.is_init,
		avc.old_check_id,
		sa.subj_name,
		apt.pay_name
		FROM ACC_VOUCH_CHECK avc
		LEFT JOIN acc_subj sa ON
		avc.group_id = sa.group_id
		AND avc.hos_id = sa.hos_id
		AND avc.copy_code = sa.copy_code
		AND avc.acc_year = sa.acc_year
		AND avc.subj_id = sa.subj_id
		LEFT JOIN acc_pay_type apt ON
		avc.group_id = apt.group_id
		AND avc.hos_id = apt.hos_id
		AND avc.copy_code = apt.copy_code
		AND avc.acc_year = apt.acc_year
		AND avc.pay_type_code = apt.pay_code
		<where>
			<if test="vouch_check_id != null and vouch_check_id != ''">
				AND avc.vouch_check_id = #{vouch_check_id}
			</if>
			<if test="vouch_id != null and vouch_id != ''">
				AND avc.vouch_id = #{vouch_id}
			</if>
			<if test="vouch_detail_id != null and vouch_detail_id != ''">
				AND avc.vouch_detail_id = #{vouch_detail_id}
			</if>
			<if test="group_id != null and group_id != ''">
				AND avc.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND avc.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND avc.copy_code = #{copy_code}
			</if>
			<if test="acc_year != null  and acc_year != ''">
				AND avc.acc_year =#{acc_year}
			</if>
			<if test="subj_id != null and subj_id != '' and subj_id !='undefined'">
				AND avc.subj_id = #{subj_id}
			</if>
			<if test="summary != null and summary != ''">
				AND avc.summary = #{summary}
			</if>
			<if
				test="acc_money != '' and acct_money != '' and acc_money != null and acct_money != null  and acc_money != 'undefined' and acct_money != 'undefined'">
				AND avc.debit between #{acc_money} and #{acct_money}
			</if>
			<if
				test="acc_money != '' and acct_money != ''  and acc_money != null and acct_money != null and acc_money != 'undefined' and acct_money != 'undefined'">
				AND avc.credit between #{acc_money} and #{acct_money}
			</if>
			<if test="con_no != null and con_no != ''">
				AND avc.con_no = #{con_no}
			</if>
			<if test="check_no != null and check_no != ''">
				AND avc.check_no = #{check_no}
			</if>
			<if test="business_no != null and business_no != ''">
				AND avc.business_no = #{business_no}
			</if>
			<if
				test="acc_date != null and acc_date != '' and acct_date != null and acct_date != '' and acc_date != 'undefined' and acct_date != 'undefined'">
				AND avc.occur_date between to_date(#{acc_date},'yyyyMMdd') and
				to_date(#{acct_date},'yyyyMMdd')
			</if>
			<if test="due_date != null and due_date != ''">
				AND avc.due_date = #{due_date}
			</if>
			<if test="pay_type_code != null and pay_type_code != ''">
				AND avc.pay_type_code = #{pay_type_code}
			</if>
			<if test="debit_w != null and debit_w != ''">
				AND avc.debit_w = #{debit_w}
			</if>
			<if test="credit_w != null and credit_w != ''">
				AND avc.credit_w = #{credit_w}
			</if>
			<if test="check1_id != null and check1_id != ''">
				AND avc.check1_id = #{check1_id}
			</if>
			<if test="check1_no != null and check1_no != ''">
				AND avc.check1_no = #{check1_no}
			</if>
			<if test="check2_id != null and check2_id != ''">
				AND avc.check2_id = #{check2_id}
			</if>
			<if test="check2_no != null and check2_no != ''">
				AND avc.check2_no = #{check2_no}
			</if>
			<if test="check3_id != null and check3_id != ''">
				AND avc.check3_id = #{check3_id}
			</if>
			<if test="check3_no != null and check3_no != ''">
				AND avc.check3_no = #{check3_no}
			</if>
			<if test="check4_id != null and check4_id != ''">
				AND avc.check4_id = #{check4_id}
			</if>
			<if test="check4_no != null and check4_no != ''">
				AND avc.check4_no = #{check4_no}
			</if>
			<if test="check5_id != null and check5_id != ''">
				AND avc.check5_id = #{check5_id}
			</if>
			<if test="check5_no != null and check5_no != ''">
				AND avc.check5_no = #{check5_no}
			</if>
			<if test="check6_id != null and check6_id != ''">
				AND avc.check6_id = #{check6_id}
			</if>
			<if test="check6_no != null and check6_no != ''">
				AND avc.check6_no = #{check6_no}
			</if>
			<if test="check7_id != null and check7_id != ''">
				AND avc.check7_id = #{check7_id}
			</if>
			<if test="is_init != null and is_init != ''">
				AND avc.is_init = #{is_init}
			</if>
			<if test="old_check_id != null and old_check_id != ''">
				AND avc.old_check_id = #{old_check_id}
			</if>
		</where>
		order by avc.vouch_check_id asc
	</select-->

	

	<select id="queryAccVouchCheck" parameterType="java.util.Map" resultMap="accVouchCheck" >
      
        SELECT 
        	abv.veri_id, avc.vouch_check_id AS bank_id, avc.vouch_check_id, avc.vouch_id, avc.vouch_detail_id
			, avc.group_id, avc.hos_id, avc.copy_code, avc.acc_year, avc.subj_code
			, avc.summary, avc.debit, avc.credit, avc.con_no, avc.check_no
			, avc.business_no, avc.occur_date, avc.due_date, avc.pay_type_code, avc.debit_w
			, avc.credit_w, act1.check_type_name AS check1
			, act2.check_type_name AS check2, act3.check_type_name AS check3, act4.check_type_name AS check4, avc.is_init, avc.old_check_id
      		, sa.subj_name, sa.subj_dire, apt.pay_name,avt.vouch_type_short || '-' || av.vouch_no AS vouch_no
      		,case when nvl(avc.debit,0)!=0 then nvl(avc.debit,0) else nvl(avc.credit,0) end money 
        FROM ACC_VOUCH_CHECK avc
	    LEFT JOIN acc_subj sa ON  avc.group_id = sa.group_id
					AND avc.hos_id = sa.hos_id
					AND avc.copy_code = sa.copy_code
					AND avc.acc_year = sa.acc_year
					AND avc.subj_code = sa.subj_code
				LEFT JOIN acc_pay_type apt ON
					 avc.group_id = apt.group_id
					AND avc.hos_id = apt.hos_id
					AND avc.copy_code = apt.copy_code
					AND avc.pay_type_code = apt.pay_code 
				left join ACC_BANK_VERI abv on
					avc.group_id = abv.group_id
					AND avc.hos_id = abv.hos_id
					AND avc.copy_code = abv.copy_code
					AND avc.acc_year = abv.acc_year
					and avc.vouch_check_id = abv.vouch_check_id	
					and avc.vouch_id = abv.vouch_id	
				left join acc_vouch av on
					 avc.hos_id = av.hos_id
					AND avc.copy_code = av.copy_code
					AND avc.acc_year = av.acc_year	
					and avc.vouch_id = av.vouch_id 
				left join acc_vouch_type avt on 
				 av.vouch_type_code = avt.vouch_type_code
				 and av.group_id = avt.group_id 
				 and av.hos_id = avt.hos_id 
				 and av.copy_code = avt.copy_code
				  LEFT JOIN ACC_CHECK_TYPE act1 ON sa.GROUP_ID = act1.GROUP_ID
			    AND sa.HOS_ID = act1.HOS_ID
			    AND sa.COPY_CODE = act1.COPY_CODE
			    AND sa.check1 = act1.CHECK_TYPE_ID 
			    LEFT JOIN ACC_CHECK_TYPE act2 ON sa.GROUP_ID = act2.GROUP_ID
			    AND sa.HOS_ID = act2.HOS_ID
			    AND sa.COPY_CODE = act2.COPY_CODE
			    AND sa.check2 = act2.CHECK_TYPE_ID 
			    LEFT JOIN ACC_CHECK_TYPE act3 ON sa.GROUP_ID = act3.GROUP_ID
			    AND sa.HOS_ID = act3.HOS_ID
			    AND sa.COPY_CODE = act3.COPY_CODE
			    AND sa.check3 = act3.CHECK_TYPE_ID 
			      LEFT JOIN ACC_CHECK_TYPE act4 ON sa.GROUP_ID = act4.GROUP_ID
			    AND sa.HOS_ID = act4.HOS_ID
			    AND sa.COPY_CODE = act4.COPY_CODE
			    AND sa.check4 = act4.CHECK_TYPE_ID	
            <where>                     
			    <if test="vouch_check_id != null and vouch_check_id != ''">
                    AND avc.vouch_check_id = #{vouch_check_id}
               </if>
			    <if test="vouch_id != null and vouch_id != ''">
                    AND avc.vouch_id = #{vouch_id}
               </if>
			    <if test="vouch_detail_id != null and vouch_detail_id != ''">
                    AND avc.vouch_detail_id = #{vouch_detail_id}
               </if>
			    <if test="group_id != null and group_id != ''">
                    AND avc.group_id = #{group_id}
               </if>
			    <if test="hos_id != null and hos_id != ''">
                    AND avc.hos_id = #{hos_id}
               </if>
			    <if test="copy_code != null and copy_code != ''">
                    AND avc.copy_code = #{copy_code}
               </if>
			    <if test="acc_year != null  and acc_year != ''">
                    AND avc.acc_year =#{acc_year}
               </if>
			    <if test="subj_code != null and subj_code != '' and subj_code !='undefined'">
                    AND avc.subj_code = #{subj_code}
               </if>
               <if test="subj_dire != null and subj_dire != ''">
					AND sa.subj_dire = #{subj_dire}
				</if>
			    <if test="summary != null and summary != ''">
                    AND avc.summary like '%${summary}%'
               </if>
			    <if test="price1 != '' and price1 != ''  and price2 != null and price2 != null and price1 != 'undefined' and price2 != 'undefined'">
                    AND (avc.debit between #{price1} and #{price2} OR avc.credit between #{price1} and #{price2})
               </if>
			    <if test="con_no != null and con_no != ''">
                    AND avc.con_no = #{con_no}
               </if>
			    <if test="check_no != null and check_no != ''">
                    AND avc.check_no like '%${check_no}%'
               </if>
			    <if test="business_no != null and business_no != ''">
                    AND avc.business_no = #{business_no}
               </if>
			    <if test="acc_time1 != null and acc_time1 != '' and acc_time2 != null and acc_time2 != '' and acc_time1 != 'undefined' and acc_time2 != 'undefined'">
               		 AND avc.occur_date between to_date(#{acc_time1},'yyyy/MM/dd') and to_date(#{acc_time2},'yyyy/MM/dd')
            	</if>
			    <if test="due_date != null and due_date != ''">
                    AND avc.due_date = #{due_date}
               </if>
			    <if test="pay_type_code != null and pay_type_code != ''">
                    AND avc.pay_type_code = #{pay_type_code}
               </if>
			    <if test="debit_w != null and debit_w != ''">
                    AND avc.debit_w = #{debit_w}
               </if>
			    <if test="credit_w != null and credit_w != ''">
                    AND avc.credit_w = #{credit_w}
               </if>
			    <if test="check1_id != null and check1_id != ''">
                    AND avc.check1_id = #{check1_id}
               </if>
			    <if test="check1_no != null and check1_no != ''">
                    AND avc.check1_no = #{check1_no}
               </if>
			    <if test="check2_id != null and check2_id != ''">
                    AND avc.check2_id = #{check2_id}
               </if>
			    <if test="check2_no != null and check2_no != ''">
                    AND avc.check2_no = #{check2_no}
               </if>
			    <if test="check3_id != null and check3_id != ''">
                    AND avc.check3_id = #{check3_id}
               </if>
			    <if test="check3_no != null and check3_no != ''">
                    AND avc.check3_no = #{check3_no}
               </if>
			    <if test="check4_id != null and check4_id != ''">
                    AND avc.check4_id = #{check4_id}
               </if>
			    <if test="check4_no != null and check4_no != ''">
                    AND avc.check4_no = #{check4_no}
               </if>
			    <if test="check5_id != null and check5_id != ''">
                    AND avc.check5_id = #{check5_id}
               </if>
			    <if test="check5_no != null and check5_no != ''">
                    AND avc.check5_no = #{check5_no}
               </if>
			    <if test="check6_id != null and check6_id != ''">
                    AND avc.check6_id = #{check6_id}
               </if>
			    <if test="check6_no != null and check6_no != ''">
                    AND avc.check6_no = #{check6_no}
               </if>
			    <if test="check7_id != null and check7_id != ''">
                    AND avc.check7_id = #{check7_id}
               </if>
			    <if test="is_init != null and is_init != ''">
                    AND avc.is_init = #{is_init}
               </if>
			    <if test="old_check_id != null and old_check_id != ''">
                    AND avc.old_check_id = #{old_check_id}
               </if>
               <if test="state == 0">
				and not exists(select 1 from ACC_BANK_VERI b where avc.group_id = b.group_id
							    AND avc.hos_id = b.hos_id
							    AND avc.copy_code = b.copy_code
							    AND avc.acc_year = b.acc_year
							    and avc.vouch_check_id = b.vouch_check_id	
								and avc.vouch_id = b.vouch_id	 )
	   			</if>
				<if test="state == 1">
				and  exists(select 1 from ACC_BANK_VERI b where avc.group_id = b.group_id
							    AND avc.hos_id = b.hos_id
							    AND avc.copy_code = b.copy_code
							    AND avc.acc_year = b.acc_year
							    and avc.vouch_check_id = b.vouch_check_id	
								and avc.vouch_id = b.vouch_id)
	   			</if>
        </where>   
				order by avc.vouch_check_id asc
    </select>
    
    
    <select id="queryAccVouchCheckNextval"  parameterType="java.util.Map"  resultType="java.lang.Integer">
		select ACC_VOUCH_CHECK_SEQ.nextval from dual
	</select>
	
	<select id="queryAccBankJournal" parameterType="java.util.Map"	resultMap="accVouchCheck">
	
		WITH v_table AS(    
    		<!-- 昨日结转=本年年初余额加小于开始日期的余额 -->
        	<!-- 昨日结转 -->
	        SELECT 
	              0 as group_id, 0 as hos_id, '' as copy_code, 0 as vouch_id, 0 as vouch_detail_id, '' as vouch_date, '' as v_year, 
	              '' as v_month, '' as v_day, '' as vouch_no, '期初余额' as summary, null as is_check,to_char('') as subj_name, 
	              '' as other_subj_name, 0 as other_bal, 0 as debit,0 as credit, a.subj_dire, a.bal+b.bal as bal 
			FROM (
				<!-- 年初余额 -->
				SELECT 
					al.end_os  as bal,subj.subj_dire
				FROM ACC_LEDER al
				LEFT JOIN ACC_SUBJ subj
				ON 
					al.group_id = subj.group_id
                    and al.hos_id = subj.hos_id
                    and al.copy_code = subj.copy_code
                    and al.acc_year = subj.acc_year
                    and al.subj_code = subj.subj_code
				WHERE 
               		al.group_id = #{group_id}
               		and al.hos_id = #{hos_id}
                    and al.copy_code = #{copy_code}
                    and al.subj_code = #{subj_code}
                    and al.acc_year = #{acc_year}
                    and al.acc_month = '00'
			) a,   
			  
			<!-- 小于开始日期的余额 -->
			(
				SELECT nvl(sum(avd.debit),0)-nvl(sum(avd.credit),0) as bal
				FROM ACC_VOUCH av
                LEFT JOIN ACC_VOUCH_DETAIL avd
	            ON 
	            	av.group_id = avd.group_id
	                AND av.hos_id = avd.hos_id
	                AND av.copy_code = avd.copy_code
	                AND av.acc_year = avd.acc_year
	                AND av.vouch_id = avd.vouch_id
               <where>
					av.group_id = #{group_id}
					AND av.hos_id = #{hos_id}
					AND av.copy_code = #{copy_code}
                   <if test="acc_year != null and acc_year != ''">
						AND av.acc_year = #{acc_year}
                   </if>
                   <if test="begin_date != null and begin_date !=''">
						AND av.vouch_date&lt;to_date(#{begin_date},'yyyy/MM/dd')
                   </if>
                   <if test="subj_code != null and subj_code != '' ">
						AND avd.subj_code = #{subj_code}
                   </if>
               </where>                                  
			) b 
		),
		
		
      	<!-- 每日凭证明细 --> 
      	a_table AS(
            SELECT 
				avd.group_id, avd.hos_id, avd.copy_code, avd.vouch_id, avd.vouch_detail_id, to_char(av.vouch_date,'yyyy/MM/dd') as vouch_date,
				to_char(av.vouch_date,'yyyy') as v_year, to_char(av.vouch_date,'MM') as v_month, to_char(av.vouch_date,'dd') as v_day,
				avt.vouch_type_short||'-'||av.vouch_no as vouch_no,avd.summary,'否' as is_check,to_char(subj.subj_name_all) as subj_name,
				'' as other_subj_name, 0 as other_bal, avd.debit, avd.credit, subj.subj_dire, avd.debit-avd.credit as bal 
            FROM ACC_VOUCH_DETAIL avd
            
            LEFT JOIN ACC_VOUCH av
            ON 
	            avd.group_id = av.group_id
	            AND avd.hos_id = av.hos_id
	            AND avd.copy_code = av.copy_code
	            AND avd.acc_year = av.acc_year
	            AND avd.vouch_id = av.vouch_id
	            
			LEFT JOIN ACC_SUBJ subj
            ON 
	            avd.group_id = subj.group_id
	            and avd.hos_id = subj.hos_id
	            and avd.copy_code = subj.copy_code
	            and avd.acc_year = subj.acc_year
	            and avd.subj_code = subj.subj_code
	            
            LEFT JOIN ACC_VOUCH_TYPE avt
			ON 
				av.group_id = avt.group_id
				AND av.hos_id = avt.hos_id
                AND av.copy_code = avt.copy_code
                AND av.vouch_type_code = avt.vouch_type_code
            
            <where>
				avd.group_id = #{group_id}
				and avd.hos_id = #{hos_id}
				and avd.copy_code = #{copy_code}
				
                <if test="acc_year != null and acc_year != ''">
                    and avd.acc_year = #{acc_year}
                </if>
                <if test="subj_code != null and subj_code != ''">
                    and avd.subj_code = #{subj_code}
                </if>
                <if test="money != null and money != '' and sumMoney!= null and sumMoney != ''">
                    and ((avd.debit between #{money} and  #{sumMoney}) or (avd.credit between  #{money}  and #{sumMoney}))
                </if>
                <if test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
                    and av.vouch_no between  #{vouch_no_b}  and  #{vouch_no_e} 
                </if>
                <if test="state != null and state != '' ">
                    and av.state>=#{state}
                </if>
                <if test="begin_date != null and begin_date != '' and end_date != null and end_date != ''">
                    and av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
                    and to_date(#{end_date},'yyyy/MM/dd')
                </if>
                <if test="vouch_type_code != null and vouch_type_code != ''">
                     and av.vouch_type_code = #{vouch_type_code}
                </if>
                <if test="create_user != null and create_user != ''">
                     and av.create_user = #{create_user}
                </if>
                <if test="summary != null and summary != ''">
                     and avd.summary like '%${summary}%'
                </if>
            </where>
			order by av.vouch_date,vouch_no,avd.vouch_detail_id
      ),
      
      
      b_table AS (
              <!-- 本日合计 -->
		SELECT 
        	0 as group_id, 0 as hos_id, null as copy_code, null as vouch_id, null as vouch_detail_id, null as vouch_date,
        	to_char(t.vouch_date,'yyyy') as v_year, to_char(t.vouch_date,'MM') as v_month, to_char(t.vouch_date,'dd') as v_day,
			null as vouch_no, '本日合计' as summary, null as is_check, to_char('') as subj_name, '' as other_subj_name, 0 as other_bal,
			sum(t.debit) as debit, sum(t.credit) as credit, t.subj_dire, 0 as bal 
		FROM (
			<!-- 凭证明细数据 -->
			SELECT 
            	av.vouch_date, to_char(av.vouch_date,'yyyy') as v_year, to_char(av.vouch_date,'MM') as v_month, to_char(av.vouch_date,'dd') as v_day,
				avd.debit, avd.credit, subj.subj_dire, avd.debit-avd.credit as bal 
			FROM ACC_VOUCH_DETAIL avd
            
            LEFT JOIN ACC_VOUCH av
            ON 
	            avd.group_id = av.group_id
	            AND avd.hos_id = av.hos_id
	            AND avd.copy_code = av.copy_code
	            AND avd.acc_year = av.acc_year
	            AND avd.vouch_id = av.vouch_id
                             
			LEFT JOIN ACC_SUBJ subj
            on 
            	avd.group_id = subj.group_id
                AND avd.hos_id = subj.hos_id
                AND avd.copy_code = subj.copy_code
                AND avd.acc_year = subj.acc_year
                AND avd.subj_code = subj.subj_code
			
			LEFT JOIN ACC_VOUCH_TYPE avt
			ON 
				av.group_id = avt.group_id
	            AND av.hos_id = avt.hos_id
	            AND av.copy_code = avt.copy_code
	            AND av.vouch_type_code = avt.vouch_type_code
			
			<where>
				avd.group_id = #{group_id}
                AND avd.hos_id = #{hos_id}
                AND avd.copy_code = #{copy_code}
                
                <if test="acc_year != null and acc_year != ''">
                    AND avd.acc_year = #{acc_year}
                </if>
                <if test="subj_code != null and subj_code != ''">
                    AND avd.subj_code = #{subj_code}
                </if>
                <if test="money != null and money != '' and sumMoney!= null and sumMoney != ''">
					AND ((avd.debit between #{money} and  #{sumMoney}) or (avd.credit between  #{money}  and #{sumMoney}))
                </if>
                <if test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
                    AND av.vouch_no between  #{vouch_no_b}  and  #{vouch_no_e} 
                </if>
                <if test="state != null and state != '' ">
                    AND av.state>=#{state}
                </if>
                <if test="begin_date != null and begin_date != '' and end_date != null and end_date != ''">
                    AND av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
                    AND to_date(#{end_date},'yyyy/MM/dd')
                </if>
                <if test="vouch_type_code != null and vouch_type_code != ''">
					AND av.vouch_type_code = #{vouch_type_code}
                </if>
                <if test="create_user != null and create_user != ''">
					AND av.create_user = #{create_user}
                </if>
                <if test="summary != null and summary != ''">
					AND avd.summary like '%${summary}%'
                </if>
            </where>
			ORDER BY av.vouch_date,avd.vouch_detail_id
		) t 
		GROUP BY t.v_day,t.vouch_date,t.subj_dire
      ),
      
      c_table as (
      	<!-- 本月合计 -->
		SELECT 
			0 as group_id, 0 as hos_id, null as copy_code, null as vouch_id, null as vouch_detail_id, null as vouch_date, t.v_year, t.v_month,
			'' as v_day, null as vouch_no, '本月合计' as summary, null as is_check, to_char('') as subj_name, '' as other_subj_name,0 as other_bal,
			SUM(t.debit) as debit,  SUM(t.credit) as credit, t.subj_dire,0 as bal 
		FROM (
			SELECT 
				to_char(av.vouch_date,'yyyy') as v_year, to_char(av.vouch_date,'MM') as v_month, sum(avd.debit) as debit,
				sum(avd.credit) as credit, subj.subj_dire
			FROM ACC_VOUCH_DETAIL avd
			
			LEFT JOIN ACC_VOUCH av
			ON 
				avd.group_id = av.group_id
                AND avd.hos_id = av.hos_id
                AND avd.copy_code = av.copy_code
                AND avd.acc_year = av.acc_year
                AND avd.vouch_id= av.vouch_id
                
			LEFT JOIN ACC_SUBJ subj
            on 
	            avd.group_id = subj.group_id
	            AND avd.hos_id = subj.hos_id
	            AND avd.copy_code = subj.copy_code
	            AND avd.acc_year = subj.acc_year
	            AND avd.subj_code = subj.subj_code
			<where>
				avd.group_id = #{group_id}
                and avd.hos_id = #{hos_id}
                and avd.copy_code = #{copy_code}
                
                <if test="acc_year != null and acc_year != ''">
                	and avd.acc_year = #{acc_year}
                </if>
                <if test="subj_code != null and subj_code != ''">
                    and avd.subj_code = #{subj_code}
                </if>
                <if test="money != null and money != '' and sumMoney!= null and sumMoney != ''">
                    and ((avd.debit between #{money} and  #{sumMoney}) or (avd.credit between  #{money}  and #{sumMoney}))
                </if>
                <if test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
                    and av.vouch_no between  #{vouch_no_b}  and  #{vouch_no_e} 
                </if>
                <if test="state != null and state != '' ">
                    and av.state>=#{state}
                </if>
                <if test="begin_date != null and begin_date != '' and end_date != null and end_date != ''">
                    and av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
                    and to_date(#{end_date},'yyyy/MM/dd')
                </if>
                <if test="vouch_type_code != null and vouch_type_code != ''">
                     and av.vouch_type_code = #{vouch_type_code}
                </if>
                <if test="create_user != null and create_user != ''">
                     and av.create_user = #{create_user}
                </if>
                <if test="summary != null and summary != ''">
                     and avd.summary like '%${summary}%'
                </if>
			</where>
				group by av.vouch_date, subj.subj_dire
			) t group by  t.v_year,v_month,t.subj_dire
       	),    
       	
       	
		<!-- 本年累计 -->
       	d_table AS (
			SELECT 
				0 as group_id, 0 as hos_id, null as copy_code, null as vouch_id, null as vouch_detail_id, null as vouch_date, t.v_year, t.v_month,
				'' as v_day, null as vouch_no, '本年累计' as summary, null as is_check, to_char('') as subj_name, '' as other_subj_name,0 as other_bal,
				SUM(t.debit) over(order by t.v_month) AS debit, SUM(t.credit)over(order by t.v_month) AS credit, t.subj_dire, 0 as bal 
			FROM (
				<!-- 每月合计 -->
				SELECT 
					t.v_year, t.v_month, SUM(t.debit) as debit, SUM(t.credit) as credit, t.subj_dire
				FROM (
					<!-- 每日合计 -->
						SELECT 
                        	to_char(av.vouch_date,'yyyy') as v_year,to_char(av.vouch_date,'MM') as v_month,
                            SUM(avd.debit) as debit, SUM(avd.credit) as credit, subj.subj_dire
						FROM ACC_VOUCH_DETAIL avd
                        LEFT JOIN ACC_VOUCH av
						ON 
							avd.group_id = av.group_id
  							AND avd.hos_id = av.hos_id
                            AND avd.copy_code = av.copy_code
                            AND avd.acc_year = av.acc_year
                            AND avd.vouch_id = av.vouch_id
						LEFT JOIN ACC_SUBJ subj
                        ON 
	                        avd.group_id = subj.group_id
	                        AND avd.hos_id = subj.hos_id
	                        AND avd.copy_code = subj.copy_code
	                        AND avd.acc_year = subj.acc_year
	                        AND avd.subj_code = subj.subj_code
                        <where>
                        		avd.group_id = #{group_id}
	                            and avd.hos_id = #{hos_id}
	                            and avd.copy_code = #{copy_code}
	                          	<if test="acc_year != null and acc_year != ''">
	                            	and avd.acc_year = #{acc_year}
	                          	</if>
	                          	<if test="subj_code != null and subj_code != ''">
	                              	and avd.subj_code = #{subj_code}
	                          	</if>
	                          	<if test="money != null and money != '' and sumMoney!= null and sumMoney != ''">
	                               	and ((avd.debit between #{money} and  #{sumMoney}) or (avd.credit between  #{money}  and #{sumMoney}))
	                          	</if>
	                          	<if test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
	                               	and av.vouch_no between  #{vouch_no_b}  and  #{vouch_no_e} 
	                          	</if>
	                          	<if test="state != null and state != '' ">
	                               	and av.state>=#{state}
	                          	</if>
	                          	<if test="begin_date != null and begin_date != '' and end_date != null and end_date != ''">
	                              	and av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
	                              	and to_date(#{end_date},'yyyy/MM/dd')
	                          	</if>
	                          	<if test="vouch_type_code != null and vouch_type_code != ''">
	                               	and av.vouch_type_code = #{vouch_type_code}
	                          	</if>
	                          	<if test="create_user != null and create_user != ''">
	                               	and av.create_user = #{create_user}
	                          	</if>
	                          	<if test="summary != null and summary != ''">
	                               	and avd.summary like '%${summary}%'
	                          	</if>
                    	</where>
                        GROUP BY av.vouch_date,subj.subj_dire
				) t group by  t.v_year,v_month,t.subj_dire
			)t
      	),
      	
      	<!-- 下日结转 -->
      	e_table AS(
			SELECT 
            	0 as group_id, 0 as hos_id, null as copy_code, null as vouch_id, null as vouch_detail_id, null as vouch_date,
				to_char(t.vouch_date,'yyyy') as v_year, to_char(t.vouch_date,'MM') as v_month, to_char(t.vouch_date,'dd') as v_day,
				null as vouch_no, '结转下日' as summary, null as is_check, to_char('') as subj_name,'' as other_subj_name, 0 as other_bal,
				0 as debit, 0 as credit, t.subj_dire, 0 as bal 
			FROM (
				<!-- 凭证明细数据 -->
				SELECT 
                	av.vouch_date, to_char(av.vouch_date,'yyyy') as v_year, to_char(av.vouch_date,'MM') as v_month, to_char(av.vouch_date,'dd') as v_day,
                    avd.debit, avd.credit, subj.subj_dire, avd.debit-avd.credit as bal 
				FROM ACC_VOUCH_DETAIL avd
				
                LEFT JOIN ACC_VOUCH av
                on 
                	avd.group_id = av.group_id
					AND avd.hos_id = av.hos_id
					AND avd.copy_code = av.copy_code
					AND avd.acc_year = av.acc_year
					AND avd.vouch_id = av.vouch_id
                      
                LEFT JOIN ACC_SUBJ subj
				ON 
					avd.group_id = subj.group_id
					AND avd.hos_id = subj.hos_id
					AND avd.copy_code = subj.copy_code
                    AND avd.acc_year = subj.acc_year
                    AND avd.subj_code = subj.subj_code
                    
                LEFT JOIN ACC_VOUCH_TYPE avt
                     on av.group_id = avt.group_id
                     AND av.hos_id = avt.hos_id
                     AND av.copy_code = avt.copy_code
                     AND av.vouch_type_code = avt.vouch_type_code
                <where>
                		avd.group_id = #{group_id}
                		AND avd.hos_id = #{hos_id}
                		AND avd.copy_code = #{copy_code}
                		
                        <if test="acc_year != null and acc_year != ''">
                        	AND avd.acc_year = #{acc_year}
                        </if>
                        <if test="subj_code != null and subj_code != ''">
                            AND avd.subj_code = #{subj_code}
                        </if>
                        <if test="money != null and money != '' and sumMoney!= null and sumMoney != ''">
                            AND ((avd.debit between #{money} and  #{sumMoney}) or (avd.credit between  #{money}  and #{sumMoney}))
                        </if>
                        <if test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
                            AND av.vouch_no between  #{vouch_no_b}  and  #{vouch_no_e} 
                        </if>
                        <if test="state != null and state != '' ">
                            AND av.state>=#{state}
                        </if>
                        <if test="begin_date != null and begin_date != '' and end_date != null and end_date != ''">
                            AND av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
                            AND to_date(#{end_date},'yyyy/MM/dd')
                        </if>
                        <if test="vouch_type_code != null and vouch_type_code != ''">
                            AND av.vouch_type_code = #{vouch_type_code}
                        </if>
                        <if test="create_user != null and create_user != ''">
                            AND av.create_user = #{create_user}
                        </if>
                        <if test="summary != null and summary != ''">
                            AND avd.summary like '%${summary}%'
                        </if>
                    </where>
                    ORDER BY av.vouch_date,avd.vouch_detail_id
			) t 
			GROUP BY t.v_day,t.vouch_date,t.subj_dire
		)
		
		
    	<!-- 查询所有数据 -->
        SELECT 
			t.group_id, t.hos_id, t.copy_code, t.vouch_id, t.vouch_detail_id, t.vouch_date, t.v_year, t.v_month, t.v_day,
			t.vouch_no, t.summary, t.is_check t_is_check, t.subj_name,
			( 
				SELECT s.subj_name_all
        		FROM acc_vouch_detail d
        		
         		LEFT JOIN acc_subj s 
         		ON 
          			d.group_id = s.group_id
			        AND d.hos_id = s.hos_id
			        AND d.copy_code = s.copy_code
			        AND d.acc_year = s. acc_year
			        AND d.subj_code = s.subj_code  
			        
        		WHERE 
        			d.vouch_id = t.vouch_id
          			AND rownum = 1
          			AND CASE WHEN t.debit = 0 THEN d.debit ELSE d.credit END &lt;&gt; 0
          			AND d.vouch_detail_id &lt;&gt; t.vouch_detail_id
        			<!--   AND nvl(d.debit, 0) + nvl(d.credit, 0) = nvl(t.debit, 0) + nvl(t.credit, 0) -->
        	)  other_subj_name,
        	
        	(
        		SELECT 
        			CASE WHEN t.debit = 0 THEN d.debit ELSE d.credit END AS o_money
        		FROM ACC_VOUCH_DETAIL d
        		WHERE 
        			d.vouch_id = t.vouch_id
          			AND rownum = 1
          			AND CASE WHEN t.debit = 0 THEN d.debit ELSE d.credit END &lt;&gt; 0
          			AND d.vouch_detail_id &lt;&gt; t.vouch_detail_id
          		<!-- and nvl(d.debit, 0) + nvl(d.credit, 0) = nvl(t.debit, 0) + nvl(t.credit, 0) -->
        	) other_bal,
        	
             t.debit, t.credit, t.subj_dire,sum(t.bal) over(order by t.numNo,t.vouch_date,t.vouch_no,vouch_detail_id) as bal,t.numNo
       FROM (
             <!-- 昨日结转 -->
             SELECT
                 0 as group_id, 0 as hos_id, '' as copy_code, 0 as vouch_id,null as vouch_detail_id,'' as vouch_date,
                 '' as v_year, '' as v_month,'' as v_day, '' as vouch_no, v.summary,null as is_check,
                 to_char('') as subj_name,'' as other_subj_name,0 as other_bal,0 as debit,0 as credit,
                 v.subj_dire, v.bal,'0' as numNo 
			FROM v_table v
		    UNION ALL
		    	<!-- 每日凭证 -->
	            SELECT
					a.group_id, a.hos_id,a.copy_code, a.vouch_id,a.vouch_detail_id,a.vouch_date,
	                a.v_year, a.v_month,a.v_day,a.vouch_no, a.summary,a.is_check,
	                a.subj_name,a.other_subj_name,a.other_bal,a.debit,a.credit,
	                a.subj_dire, a.bal,a.v_year||a.v_month||a.v_day|| '41' as numNo 
	            FROM a_table a
	            
		    UNION ALL
		    	<!-- 本日合计 -->   
	            SELECT 
	                0 as group_id, 0 as hos_id,null as copy_code, null as vouch_id,null as vouch_detail_id,null as vouch_date,
	                b.v_year,b.v_month,b.v_day,null as vouch_no,b.summary,null as is_check, to_char('') as subj_name,'' as other_subj_name,
	                0 as other_bal,b.debit, b.credit, b.subj_dire,b.bal,b.v_year||b.v_month||b.v_day|| '42' as numNo 
	            FROM b_table b
	            
			UNION ALL
				<!-- 本月合计 --> 
				SELECT 
		            0 as group_id,0 as hos_id, null as copy_code, null as vouch_id,null as vouch_detail_id,null as vouch_date,c.v_year,
		            c.v_month, '' as v_day,null as vouch_no,c.summary,null as is_check,to_char('') as subj_name,'' as other_subj_name,
		            0 as other_bal, c.debit,c.credit,c.subj_dire,c.bal,c.v_year||c.v_month|| '44' as numNo 
				FROM c_table c
				
			UNION ALL
				<!-- 本年累计 -->
				SELECT 
		            0 as group_id,0 as hos_id, null as copy_code, null as vouch_id,null as vouch_detail_id,null as vouch_date,d.v_year,
		            d.v_month, '' as v_day,null as vouch_no,d.summary,null as is_check,to_char('') as subj_name,'' as other_subj_name,
		            0 as other_bal, d.debit,d.credit,d.subj_dire,d.bal,d.v_year||d.v_month|| '45' as numNo 
				FROM d_table d 
		         
			UNION ALL
				
				<!-- 下日结转 -->
				SELECT 
					0 as group_id,0 as hos_id,null as copy_code,null as vouch_id,null as vouch_detail_id,
					null as vouch_date,e.v_year,e.v_month,e.v_day,null as vouch_no,
					e.summary,null as is_check,to_char('') as subj_name,'' as other_subj_name,0 as other_bal,
					0 as debit,0 as credit,e.subj_dire,0 as bal,
					e.v_year||e.v_month||e.v_day||'43' as numNo  
				FROM e_table e                
		) t 
     	ORDER BY t.numNo,t.vouch_date,t.vouch_no,t.vouch_detail_id
		
	</select>
	
	
	<select id="queryAccVouchCheckAndSum" parameterType="java.util.Map" resultMap="accVouchCheck" >
      	with a_table as (
      	<!-- 业务数据 -->
      		SELECT 
        	abv.veri_id, avc.vouch_check_id AS bank_id, avc.vouch_check_id, avc.vouch_id, avc.vouch_detail_id
			, avc.group_id, avc.hos_id, avc.copy_code, avc.acc_year, avc.subj_code
			, avc.summary, avc.debit, avc.credit, avc.con_no, avc.check_no
			, avc.business_no, avc.occur_date, avc.due_date, avc.pay_type_code, avc.debit_w
			, avc.credit_w, act1.check_type_name AS check1
			, act2.check_type_name as check2, act3.check_type_name as check3, act4.check_type_name as check4, avc.is_init, avc.old_check_id
            , sa.subj_name, sa.subj_dire, apt.pay_name,avt.vouch_type_short || '-' || av.vouch_no as vouch_no,case (
						select 1
						from acc_bank_veri a
						where a.group_id = #{group_id, jdbcType=INTEGER}
							and a.hos_id = #{hos_id, jdbcType=INTEGER}
							and a.copy_code = #{copy_code, jdbcType=VARCHAR}
							and a.acc_year = #{acc_year, jdbcType=VARCHAR}
							and a.vouch_check_id = #{vouch_check_id, jdbcType=INTEGER}
<!-- 						where avc.group_id = a.group_id -->
<!-- 							and avc.hos_id = a.hos_id -->
<!-- 							and avc.copy_code = a.copy_code -->
<!-- 							and avc.acc_year = a.acc_year -->
<!-- 							and avc.vouch_check_id = a.vouch_check_id -->
						) when 1 then '已对账' else '未对账' end is_checks
        from acc_vouch_check avc
	        LEFT JOIN acc_subj sa ON 
					avc.group_id = sa.group_id
					AND avc.hos_id = sa.hos_id
					AND avc.copy_code = sa.copy_code
					AND avc.acc_year = sa.acc_year
					AND avc.subj_code = sa.subj_code 
				LEFT JOIN acc_pay_type apt ON
					 avc.group_id = apt.group_id
					AND avc.hos_id = apt.hos_id
					AND avc.copy_code = apt.copy_code
					AND avc.pay_type_code = apt.pay_code 
				left join ACC_BANK_VERI abv on
					avc.group_id = abv.group_id
					AND avc.hos_id = abv.hos_id
					AND avc.copy_code = abv.copy_code
					AND avc.acc_year = abv.acc_year
					and avc.vouch_check_id = abv.vouch_check_id	
					and avc.vouch_id = abv.vouch_id	
				left join acc_vouch av on
					 avc.hos_id = av.hos_id
					AND avc.copy_code = av.copy_code
					AND avc.acc_year = av.acc_year	
					and avc.vouch_id = av.vouch_id 
				left join acc_vouch_type avt on 
				 av.vouch_type_code = avt.vouch_type_code
				 and av.group_id = avt.group_id 
				 and av.hos_id = avt.hos_id 
				 and av.copy_code = avt.copy_code
				  LEFT JOIN ACC_CHECK_TYPE act1 ON sa.GROUP_ID = act1.GROUP_ID
			    AND sa.HOS_ID = act1.HOS_ID
			    AND sa.COPY_CODE = act1.COPY_CODE
			    AND sa.check1 = act1.CHECK_TYPE_ID 
			    LEFT JOIN ACC_CHECK_TYPE act2 ON sa.GROUP_ID = act2.GROUP_ID
			    AND sa.HOS_ID = act2.HOS_ID
			    AND sa.COPY_CODE = act2.COPY_CODE
			    AND sa.check2 = act2.CHECK_TYPE_ID 
			    LEFT JOIN ACC_CHECK_TYPE act3 ON sa.GROUP_ID = act3.GROUP_ID
			    AND sa.HOS_ID = act3.HOS_ID
			    AND sa.COPY_CODE = act3.COPY_CODE
			    AND sa.check3 = act3.CHECK_TYPE_ID 
			      LEFT JOIN ACC_CHECK_TYPE act4 ON sa.GROUP_ID = act4.GROUP_ID
			    AND sa.HOS_ID = act4.HOS_ID
			    AND sa.COPY_CODE = act4.COPY_CODE
			    AND sa.check4 = act4.CHECK_TYPE_ID	
            <where>                     
			    <if test="vouch_check_id != null and vouch_check_id != ''">
                    AND avc.vouch_check_id = #{vouch_check_id}
               </if>
			    <if test="vouch_id != null and vouch_id != ''">
                    AND avc.vouch_id = #{vouch_id}
               </if>
			    <if test="vouch_detail_id != null and vouch_detail_id != ''">
                    AND avc.vouch_detail_id = #{vouch_detail_id}
               </if>
			    <if test="group_id != null and group_id != ''">
                    AND avc.group_id = #{group_id}
               </if>
			    <if test="hos_id != null and hos_id != ''">
                    AND avc.hos_id = #{hos_id}
               </if>
			    <if test="copy_code != null and copy_code != ''">
                    AND avc.copy_code = #{copy_code}
               </if>
			    <if test="acc_year != null  and acc_year != ''">
                    AND avc.acc_year =#{acc_year}
               </if>
			    <if test="subj_code != null and subj_code != '' and subj_code !='undefined'">
                    AND avc.subj_code = #{subj_code}
               </if>
               <if test="subj_dire != null and subj_dire != ''">
					AND sa.subj_dire = #{subj_dire}
				</if>
			    <if test="summary != null and summary != ''">
                    AND avc.summary like '%${summary}%'
               </if>
			    <if test="price1 != '' and price1 != ''  and price2 != null and price2 != null and price1 != 'undefined' and price2 != 'undefined'">
                    AND (avc.debit between #{price1} and #{price2} OR avc.credit between #{price1} and #{price2})
               </if>
			    <if test="con_no != null and con_no != ''">
                    AND avc.con_no = #{con_no}
               </if>
			    <if test="check_no != null and check_no != ''">
                    AND avc.check_no like '%${check_no}%'
               </if>
			    <if test="business_no != null and business_no != ''">
                    AND avc.business_no = #{business_no}
               </if>
            	<if test="acc_time1 != null and acc_time1 != '' ">
					AND avc.occur_date &gt;= to_date(#{acc_time1},'yyyy/MM/dd')
				</if>
				<if test="acc_time2 != null and acc_time2 != '' ">
					AND avc.occur_date &lt;= to_date(#{acc_time2},'yyyy/MM/dd')
				</if>
			    <if test="due_date != null and due_date != ''">
                    AND avc.due_date = #{due_date}
               </if>
			    <if test="pay_type_code != null and pay_type_code != ''">
                    AND avc.pay_type_code = #{pay_type_code}
               </if>
			    <if test="debit_w != null and debit_w != ''">
                    AND avc.debit_w = #{debit_w}
               </if>
			    <if test="credit_w != null and credit_w != ''">
                    AND avc.credit_w = #{credit_w}
               </if>
			    <if test="check1_id != null and check1_id != ''">
                    AND avc.check1_id = #{check1_id}
               </if>
			    <if test="check1_no != null and check1_no != ''">
                    AND avc.check1_no = #{check1_no}
               </if>
			    <if test="check2_id != null and check2_id != ''">
                    AND avc.check2_id = #{check2_id}
               </if>
			    <if test="check2_no != null and check2_no != ''">
                    AND avc.check2_no = #{check2_no}
               </if>
			    <if test="check3_id != null and check3_id != ''">
                    AND avc.check3_id = #{check3_id}
               </if>
			    <if test="check3_no != null and check3_no != ''">
                    AND avc.check3_no = #{check3_no}
               </if>
			    <if test="check4_id != null and check4_id != ''">
                    AND avc.check4_id = #{check4_id}
               </if>
			    <if test="check4_no != null and check4_no != ''">
                    AND avc.check4_no = #{check4_no}
               </if>
			    <if test="check5_id != null and check5_id != ''">
                    AND avc.check5_id = #{check5_id}
               </if>
			    <if test="check5_no != null and check5_no != ''">
                    AND avc.check5_no = #{check5_no}
               </if>
			    <if test="check6_id != null and check6_id != ''">
                    AND avc.check6_id = #{check6_id}
               </if>
			    <if test="check6_no != null and check6_no != ''">
                    AND avc.check6_no = #{check6_no}
               </if>
			    <if test="check7_id != null and check7_id != ''">
                    AND avc.check7_id = #{check7_id}
               </if>
			    <if test="is_init != null and is_init != ''">
                    AND avc.is_init = #{is_init}
               </if>
			    <if test="old_check_id != null and old_check_id != ''">
                    AND avc.old_check_id = #{old_check_id}
               </if>
               <if test="state == 0">
				and not exists(select 1 from ACC_BANK_VERI b where avc.group_id = b.group_id
							    AND avc.hos_id = b.hos_id
							    AND avc.copy_code = b.copy_code
							    AND avc.acc_year = b.acc_year
							    and avc.vouch_check_id = b.vouch_check_id	
								and avc.vouch_id = b.vouch_id	 )
	   			</if>
				<if test="state == 1">
				and  exists(select 1 from ACC_BANK_VERI b where avc.group_id = b.group_id
							    AND avc.hos_id = b.hos_id
							    AND avc.copy_code = b.copy_code
							    AND avc.acc_year = b.acc_year
							    and avc.vouch_check_id = b.vouch_check_id	
								and avc.vouch_id = b.vouch_id)
	   			</if>
        </where>   
				order by avc.vouch_check_id asc
      	),
      	b_table as (
      	<!-- 合计借贷方 -->
      		SELECT 
		       null as veri_id,null as bank_id,null as vouch_check_id,null as vouch_id,null as vouch_detail_id
		      ,null as group_id,null as hos_id,null as copy_code,null as acc_year,null as subj_code
		      ,'合计' as summary,nvl(sum(debit),0) as debit,nvl(sum(credit),0) as credit,null as con_no,null as check_no
		      ,null as business_no,null as occur_date,null as due_date, null as pay_type_code,null as debit_w
		      ,null as credit_w,null as check1
		      ,null as check2,null as check3,null as check4,null as is_init,null as old_check_id
		      ,null as subj_name, null as subj_dire,null as pay_name,null as vouch_no,null is_checks
			FROM ACC_VOUCH_CHECK avc
			LEFT JOIN acc_subj sa ON 
					avc.group_id = sa.group_id
					AND avc.hos_id = sa.hos_id
					AND avc.copy_code = sa.copy_code
					AND avc.acc_year = sa.acc_year
					AND avc.subj_code = sa.subj_code 
			<where>                     
			    <if test="vouch_check_id != null and vouch_check_id != ''">
                    AND avc.vouch_check_id = #{vouch_check_id}
               </if>
			    <if test="vouch_id != null and vouch_id != ''">
                    AND avc.vouch_id = #{vouch_id}
               </if>
			    <if test="vouch_detail_id != null and vouch_detail_id != ''">
                    AND avc.vouch_detail_id = #{vouch_detail_id}
               </if>
			    <if test="group_id != null and group_id != ''">
                    AND avc.group_id = #{group_id}
               </if>
			    <if test="hos_id != null and hos_id != ''">
                    AND avc.hos_id = #{hos_id}
               </if>
			    <if test="copy_code != null and copy_code != ''">
                    AND avc.copy_code = #{copy_code}
               </if>
			    <if test="acc_year != null  and acc_year != ''">
                    AND avc.acc_year =#{acc_year}
               </if>
			    <if test="subj_code != null and subj_code != '' and subj_code !='undefined'">
                    AND avc.subj_code = #{subj_code}
               </if>
               <if test="subj_dire != null and subj_dire != ''">
					AND sa.subj_dire = #{subj_dire}
				</if>
			    <if test="summary != null and summary != ''">
                    AND avc.summary like '%${summary}%'
               </if>
			    <if test="price1 != '' and price1 != ''  and price2 != null and price2 != null and price1 != 'undefined' and price2 != 'undefined'">
                    AND (avc.debit between #{price1} and #{price2} OR avc.credit between #{price1} and #{price2})
               </if>
			    <if test="con_no != null and con_no != ''">
                    AND avc.con_no = #{con_no}
               </if>
			    <if test="check_no != null and check_no != ''">
                    AND avc.check_no like '%${check_no}%'
               </if>
			    <if test="business_no != null and business_no != ''">
                    AND avc.business_no = #{business_no}
               </if>
			    <if test="acc_time1 != null and acc_time1 != '' ">
					AND avc.occur_date &gt;= to_date(#{acc_time1},'yyyy/MM/dd')
				</if>
				<if test="acc_time2 != null and acc_time2 != '' ">
					AND avc.occur_date &lt;= to_date(#{acc_time2},'yyyy/MM/dd')
				</if>
			    <if test="due_date != null and due_date != ''">
                    AND avc.due_date = #{due_date}
               </if>
			    <if test="pay_type_code != null and pay_type_code != ''">
                    AND avc.pay_type_code = #{pay_type_code}
               </if>
			    <if test="debit_w != null and debit_w != ''">
                    AND avc.debit_w = #{debit_w}
               </if>
			    <if test="credit_w != null and credit_w != ''">
                    AND avc.credit_w = #{credit_w}
               </if>
			    <if test="check1_id != null and check1_id != ''">
                    AND avc.check1_id = #{check1_id}
               </if>
			    <if test="check1_no != null and check1_no != ''">
                    AND avc.check1_no = #{check1_no}
               </if>
			    <if test="check2_id != null and check2_id != ''">
                    AND avc.check2_id = #{check2_id}
               </if>
			    <if test="check2_no != null and check2_no != ''">
                    AND avc.check2_no = #{check2_no}
               </if>
			    <if test="check3_id != null and check3_id != ''">
                    AND avc.check3_id = #{check3_id}
               </if>
			    <if test="check3_no != null and check3_no != ''">
                    AND avc.check3_no = #{check3_no}
               </if>
			    <if test="check4_id != null and check4_id != ''">
                    AND avc.check4_id = #{check4_id}
               </if>
			    <if test="check4_no != null and check4_no != ''">
                    AND avc.check4_no = #{check4_no}
               </if>
			    <if test="check5_id != null and check5_id != ''">
                    AND avc.check5_id = #{check5_id}
               </if>
			    <if test="check5_no != null and check5_no != ''">
                    AND avc.check5_no = #{check5_no}
               </if>
			    <if test="check6_id != null and check6_id != ''">
                    AND avc.check6_id = #{check6_id}
               </if>
			    <if test="check6_no != null and check6_no != ''">
                    AND avc.check6_no = #{check6_no}
               </if>
			    <if test="check7_id != null and check7_id != ''">
                    AND avc.check7_id = #{check7_id}
               </if>
			    <if test="is_init != null and is_init != ''">
                    AND avc.is_init = #{is_init}
               </if>
			    <if test="old_check_id != null and old_check_id != ''">
                    AND avc.old_check_id = #{old_check_id}
               </if>
               <if test="state == 0">
				and not exists(select 1 from ACC_BANK_VERI b where avc.group_id = b.group_id
							    AND avc.hos_id = b.hos_id
							    AND avc.copy_code = b.copy_code
							    AND avc.acc_year = b.acc_year
							    and avc.vouch_check_id = b.vouch_check_id	
								and avc.vouch_id = b.vouch_id	 )
	   			</if>
				<if test="state == 1">
				and  exists(select 1 from ACC_BANK_VERI b where avc.group_id = b.group_id
							    AND avc.hos_id = b.hos_id
							    AND avc.copy_code = b.copy_code
							    AND avc.acc_year = b.acc_year
							    and avc.vouch_check_id = b.vouch_check_id	
								and avc.vouch_id = b.vouch_id)
	   			</if>
        </where>
      	)
      	select * from a_table
      	union all
      	select * from b_table
        
    </select>
    
    <select id="queryAccVouchCheckCountByVouchId" parameterType="java.util.Map" resultMap="accVouchCheck">
		select vouch_check_id from ACC_VOUCH_CHECK 
		where group_id =#{group_id} and hos_id = #{hos_id} and copy_code = #{copy_code} and vouch_id =#{vouch_id} and vouch_detail_id=#{vouch_detail_id}
	</select>
	
	<insert id="addBatchAccCashVouchOfMoney" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			INSERT INTO ACC_CASH_FLOW (
				cash_id,vouch_detail_id,group_id,hos_id,copy_code,summary,
				cash_item_id,cash_money,create_user,create_date
			)
			select #{item.new_cash_id},#{item.new_vouch_detail_id},group_id,hos_id,copy_code,summary,
				cash_item_id,cash_money*-1,create_user,#{item.create_date}
			from ACC_CASH_FLOW
			where group_id=#{item.group_id} and hos_id =#{item.hos_id} and copy_code=#{item.copy_code}
				and vouch_detail_id =#{item.vouch_detail_id} and cash_id =#{item.cash_id}	
		</foreach>
	</insert>
	
	<insert id="addAccCashVouchOfCopy" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			INSERT INTO ACC_CASH_FLOW (
				cash_id,vouch_detail_id,group_id,hos_id,copy_code,summary,
				cash_item_id,cash_money,create_user,create_date,vouch_id
			)
			select #{item.new_cash_id},#{item.new_vouch_detail_id},group_id,hos_id,copy_code,summary,
				cash_item_id,cash_money,#{item.create_user},#{item.create_date},#{item.new_vouch_id}
			from ACC_CASH_FLOW
			where group_id=#{item.group_id} and hos_id =#{item.hos_id} and copy_code=#{item.copy_code}
				and vouch_detail_id =#{item.vouch_detail_id} and cash_id =#{item.cash_id}	
		</foreach>
	</insert>
	
	<insert id="addAccVouchCheckOfCopy" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			INSERT INTO ACC_VOUCH_CHECK (
				vouch_check_id,vouch_id,vouch_detail_id,group_id,hos_id,copy_code,acc_year,
				subj_code,summary,debit,credit,con_no,business_no,occur_date,due_date,
				debit_w,credit_w ${item.column_name}, is_init
			)
			select #{item.new_vouch_check_id},#{item.new_vouch_id},#{item.new_vouch_detail_id},group_id,hos_id,
				copy_code,#{item.acc_year},subj_code,summary,debit,credit,con_no,business_no,#{item.vouch_date},${item.column_value},
				debit_w,credit_w ${item.column_name}, is_init
			from ACC_VOUCH_CHECK
			where group_id=#{item.group_id} and hos_id =#{item.hos_id} and copy_code=#{item.copy_code}
				and acc_year=#{item.acc_year} and vouch_id =#{item.vouch_id} and vouch_detail_id =#{item.vouch_detail_id}
				and vouch_check_id =#{item.vouch_check_id}	
		</foreach>
	</insert>
	
	
	<select id="queryAccVouchCheckCountByEmpId" parameterType="java.util.Map" resultType="java.lang.Integer">
		select count(0) from ACC_VOUCH_CHECK  where group_id =#{group_id} and hos_id = #{hos_id}  and check2_id = #{emp_id}
	</select>
	
	<select id="queryAccVouchCheckAndSumPrint" parameterType="java.util.Map" resultType="java.util.Map" >
      	with a_table as (
      	<!-- 业务数据 -->
      		SELECT 
        	abv.veri_id, avc.vouch_check_id AS bank_id, avc.vouch_check_id, avc.vouch_id, avc.vouch_detail_id
			, avc.group_id, avc.hos_id, avc.copy_code, avc.acc_year, avc.subj_code
			, avc.summary, avc.debit, avc.credit, avc.con_no, avc.check_no
			, avc.business_no, avc.occur_date, avc.due_date, avc.pay_type_code, avc.debit_w
			, avc.credit_w, act1.check_type_name AS check1
			, act2.check_type_name as check2, act3.check_type_name as check3, act4.check_type_name as check4, avc.is_init, avc.old_check_id
            , sa.subj_name, sa.subj_dire, apt.pay_name,avt.vouch_type_short || '-' || av.vouch_no as vouch_no,case (
						select 1
						from acc_bank_veri a
						where avc.group_id = a.group_id
							and avc.hos_id = a.hos_id
							and avc.copy_code = a.copy_code
							and avc.acc_year = a.acc_year
							and avc.vouch_check_id = a.vouch_check_id
						) when 1 then '已对账' else '未对账' end is_checks
        from acc_vouch_check avc
	        LEFT JOIN acc_subj sa ON 
					avc.group_id = sa.group_id
					AND avc.hos_id = sa.hos_id
					AND avc.copy_code = sa.copy_code
					AND avc.acc_year = sa.acc_year
					AND avc.subj_code = sa.subj_code 
				LEFT JOIN acc_pay_type apt ON
					 avc.group_id = apt.group_id
					AND avc.hos_id = apt.hos_id
					AND avc.copy_code = apt.copy_code
					AND avc.pay_type_code = apt.pay_code 
				left join ACC_BANK_VERI abv on
					avc.group_id = abv.group_id
					AND avc.hos_id = abv.hos_id
					AND avc.copy_code = abv.copy_code
					AND avc.acc_year = abv.acc_year
					and avc.vouch_check_id = abv.vouch_check_id	
					and avc.vouch_id = abv.vouch_id	
				left join acc_vouch av on
					 avc.hos_id = av.hos_id
					AND avc.copy_code = av.copy_code
					AND avc.acc_year = av.acc_year	
					and avc.vouch_id = av.vouch_id 
				left join acc_vouch_type avt on 
				 av.vouch_type_code = avt.vouch_type_code
				 and av.group_id = avt.group_id 
				 and av.hos_id = avt.hos_id 
				 and av.copy_code = avt.copy_code
				  LEFT JOIN ACC_CHECK_TYPE act1 ON sa.GROUP_ID = act1.GROUP_ID
			    AND sa.HOS_ID = act1.HOS_ID
			    AND sa.COPY_CODE = act1.COPY_CODE
			    AND sa.check1 = act1.CHECK_TYPE_ID 
			    LEFT JOIN ACC_CHECK_TYPE act2 ON sa.GROUP_ID = act2.GROUP_ID
			    AND sa.HOS_ID = act2.HOS_ID
			    AND sa.COPY_CODE = act2.COPY_CODE
			    AND sa.check2 = act2.CHECK_TYPE_ID 
			    LEFT JOIN ACC_CHECK_TYPE act3 ON sa.GROUP_ID = act3.GROUP_ID
			    AND sa.HOS_ID = act3.HOS_ID
			    AND sa.COPY_CODE = act3.COPY_CODE
			    AND sa.check3 = act3.CHECK_TYPE_ID 
			      LEFT JOIN ACC_CHECK_TYPE act4 ON sa.GROUP_ID = act4.GROUP_ID
			    AND sa.HOS_ID = act4.HOS_ID
			    AND sa.COPY_CODE = act4.COPY_CODE
			    AND sa.check4 = act4.CHECK_TYPE_ID	
            <where>                     
			    <if test="vouch_check_id != null and vouch_check_id != ''">
                    AND avc.vouch_check_id = #{vouch_check_id}
               </if>
			    <if test="vouch_id != null and vouch_id != ''">
                    AND avc.vouch_id = #{vouch_id}
               </if>
			    <if test="vouch_detail_id != null and vouch_detail_id != ''">
                    AND avc.vouch_detail_id = #{vouch_detail_id}
               </if>
			    <if test="group_id != null and group_id != ''">
                    AND avc.group_id = #{group_id}
               </if>
			    <if test="hos_id != null and hos_id != ''">
                    AND avc.hos_id = #{hos_id}
               </if>
			    <if test="copy_code != null and copy_code != ''">
                    AND avc.copy_code = #{copy_code}
               </if>
			    <if test="acc_year != null  and acc_year != ''">
                    AND avc.acc_year =#{acc_year}
               </if>
			    <if test="subj_code != null and subj_code != '' and subj_code !='undefined'">
                    AND avc.subj_code = #{subj_code}
               </if>
               <if test="subj_dire != null and subj_dire != ''">
					AND sa.subj_dire = #{subj_dire}
				</if>
			    <if test="summary != null and summary != ''">
                    AND avc.summary like '%${summary}%'
               </if>
			    <if test="price1 != '' and price1 != ''  and price2 != null and price2 != null and price1 != 'undefined' and price2 != 'undefined'">
                    AND (avc.debit between #{price1} and #{price2} OR avc.credit between #{price1} and #{price2})
               </if>
			    <if test="con_no != null and con_no != ''">
                    AND avc.con_no = #{con_no}
               </if>
			    <if test="check_no != null and check_no != ''">
                    AND avc.check_no like '%${check_no}%'
               </if>
			    <if test="business_no != null and business_no != ''">
                    AND avc.business_no = #{business_no}
               </if>
            	<if test="acc_time1 != null and acc_time1 != '' ">
					AND avc.occur_date &gt;= to_date(#{acc_time1},'yyyy/MM/dd')
				</if>
				<if test="acc_time2 != null and acc_time2 != '' ">
					AND avc.occur_date &lt;= to_date(#{acc_time2},'yyyy/MM/dd')
				</if>
			    <if test="due_date != null and due_date != ''">
                    AND avc.due_date = #{due_date}
               </if>
			    <if test="pay_type_code != null and pay_type_code != ''">
                    AND avc.pay_type_code = #{pay_type_code}
               </if>
			    <if test="debit_w != null and debit_w != ''">
                    AND avc.debit_w = #{debit_w}
               </if>
			    <if test="credit_w != null and credit_w != ''">
                    AND avc.credit_w = #{credit_w}
               </if>
			    <if test="check1_id != null and check1_id != ''">
                    AND avc.check1_id = #{check1_id}
               </if>
			    <if test="check1_no != null and check1_no != ''">
                    AND avc.check1_no = #{check1_no}
               </if>
			    <if test="check2_id != null and check2_id != ''">
                    AND avc.check2_id = #{check2_id}
               </if>
			    <if test="check2_no != null and check2_no != ''">
                    AND avc.check2_no = #{check2_no}
               </if>
			    <if test="check3_id != null and check3_id != ''">
                    AND avc.check3_id = #{check3_id}
               </if>
			    <if test="check3_no != null and check3_no != ''">
                    AND avc.check3_no = #{check3_no}
               </if>
			    <if test="check4_id != null and check4_id != ''">
                    AND avc.check4_id = #{check4_id}
               </if>
			    <if test="check4_no != null and check4_no != ''">
                    AND avc.check4_no = #{check4_no}
               </if>
			    <if test="check5_id != null and check5_id != ''">
                    AND avc.check5_id = #{check5_id}
               </if>
			    <if test="check5_no != null and check5_no != ''">
                    AND avc.check5_no = #{check5_no}
               </if>
			    <if test="check6_id != null and check6_id != ''">
                    AND avc.check6_id = #{check6_id}
               </if>
			    <if test="check6_no != null and check6_no != ''">
                    AND avc.check6_no = #{check6_no}
               </if>
			    <if test="check7_id != null and check7_id != ''">
                    AND avc.check7_id = #{check7_id}
               </if>
			    <if test="is_init != null and is_init != ''">
                    AND avc.is_init = #{is_init}
               </if>
			    <if test="old_check_id != null and old_check_id != ''">
                    AND avc.old_check_id = #{old_check_id}
               </if>
               <if test="state == 0">
				and not exists(select 1 from ACC_BANK_VERI b where avc.group_id = b.group_id
							    AND avc.hos_id = b.hos_id
							    AND avc.copy_code = b.copy_code
							    AND avc.acc_year = b.acc_year
							    and avc.vouch_check_id = b.vouch_check_id	
								and avc.vouch_id = b.vouch_id	 )
	   			</if>
				<if test="state == 1">
				and  exists(select 1 from ACC_BANK_VERI b where avc.group_id = b.group_id
							    AND avc.hos_id = b.hos_id
							    AND avc.copy_code = b.copy_code
							    AND avc.acc_year = b.acc_year
							    and avc.vouch_check_id = b.vouch_check_id	
								and avc.vouch_id = b.vouch_id)
	   			</if>
        </where>   
				order by avc.vouch_check_id asc
      	),
      	b_table as (
      	<!-- 合计借贷方 -->
      		SELECT 
		       null as veri_id,null as bank_id,null as vouch_check_id,null as vouch_id,null as vouch_detail_id
		      ,null as group_id,null as hos_id,null as copy_code,null as acc_year,null as subj_code
		      ,'合计' as summary,nvl(sum(debit),0) as debit,nvl(sum(credit),0) as credit,null as con_no,null as check_no
		      ,null as business_no,null as occur_date,null as due_date, null as pay_type_code,null as debit_w
		      ,null as credit_w,null as check1
		      ,null as check2,null as check3,null as check4,null as is_init,null as old_check_id
		      ,null as subj_name, null as subj_dire,null as pay_name,null as vouch_no,null is_checks
			FROM ACC_VOUCH_CHECK avc
			LEFT JOIN acc_subj sa ON 
					avc.group_id = sa.group_id
					AND avc.hos_id = sa.hos_id
					AND avc.copy_code = sa.copy_code
					AND avc.acc_year = sa.acc_year
					AND avc.subj_code = sa.subj_code 
			<where>                     
			    <if test="vouch_check_id != null and vouch_check_id != ''">
                    AND avc.vouch_check_id = #{vouch_check_id}
               </if>
			    <if test="vouch_id != null and vouch_id != ''">
                    AND avc.vouch_id = #{vouch_id}
               </if>
			    <if test="vouch_detail_id != null and vouch_detail_id != ''">
                    AND avc.vouch_detail_id = #{vouch_detail_id}
               </if>
			    <if test="group_id != null and group_id != ''">
                    AND avc.group_id = #{group_id}
               </if>
			    <if test="hos_id != null and hos_id != ''">
                    AND avc.hos_id = #{hos_id}
               </if>
			    <if test="copy_code != null and copy_code != ''">
                    AND avc.copy_code = #{copy_code}
               </if>
			    <if test="acc_year != null  and acc_year != ''">
                    AND avc.acc_year =#{acc_year}
               </if>
			    <if test="subj_code != null and subj_code != '' and subj_code !='undefined'">
                    AND avc.subj_code = #{subj_code}
               </if>
               <if test="subj_dire != null and subj_dire != ''">
					AND sa.subj_dire = #{subj_dire}
				</if>
			    <if test="summary != null and summary != ''">
                    AND avc.summary like '%${summary}%'
               </if>
			    <if test="price1 != '' and price1 != ''  and price2 != null and price2 != null and price1 != 'undefined' and price2 != 'undefined'">
                    AND (avc.debit between #{price1} and #{price2} OR avc.credit between #{price1} and #{price2})
               </if>
			    <if test="con_no != null and con_no != ''">
                    AND avc.con_no = #{con_no}
               </if>
			    <if test="check_no != null and check_no != ''">
                    AND avc.check_no like '%${check_no}%'
               </if>
			    <if test="business_no != null and business_no != ''">
                    AND avc.business_no = #{business_no}
               </if>
			    <if test="acc_time1 != null and acc_time1 != '' ">
					AND avc.occur_date &gt;= to_date(#{acc_time1},'yyyy/MM/dd')
				</if>
				<if test="acc_time2 != null and acc_time2 != '' ">
					AND avc.occur_date &lt;= to_date(#{acc_time2},'yyyy/MM/dd')
				</if>
			    <if test="due_date != null and due_date != ''">
                    AND avc.due_date = #{due_date}
               </if>
			    <if test="pay_type_code != null and pay_type_code != ''">
                    AND avc.pay_type_code = #{pay_type_code}
               </if>
			    <if test="debit_w != null and debit_w != ''">
                    AND avc.debit_w = #{debit_w}
               </if>
			    <if test="credit_w != null and credit_w != ''">
                    AND avc.credit_w = #{credit_w}
               </if>
			    <if test="check1_id != null and check1_id != ''">
                    AND avc.check1_id = #{check1_id}
               </if>
			    <if test="check1_no != null and check1_no != ''">
                    AND avc.check1_no = #{check1_no}
               </if>
			    <if test="check2_id != null and check2_id != ''">
                    AND avc.check2_id = #{check2_id}
               </if>
			    <if test="check2_no != null and check2_no != ''">
                    AND avc.check2_no = #{check2_no}
               </if>
			    <if test="check3_id != null and check3_id != ''">
                    AND avc.check3_id = #{check3_id}
               </if>
			    <if test="check3_no != null and check3_no != ''">
                    AND avc.check3_no = #{check3_no}
               </if>
			    <if test="check4_id != null and check4_id != ''">
                    AND avc.check4_id = #{check4_id}
               </if>
			    <if test="check4_no != null and check4_no != ''">
                    AND avc.check4_no = #{check4_no}
               </if>
			    <if test="check5_id != null and check5_id != ''">
                    AND avc.check5_id = #{check5_id}
               </if>
			    <if test="check5_no != null and check5_no != ''">
                    AND avc.check5_no = #{check5_no}
               </if>
			    <if test="check6_id != null and check6_id != ''">
                    AND avc.check6_id = #{check6_id}
               </if>
			    <if test="check6_no != null and check6_no != ''">
                    AND avc.check6_no = #{check6_no}
               </if>
			    <if test="check7_id != null and check7_id != ''">
                    AND avc.check7_id = #{check7_id}
               </if>
			    <if test="is_init != null and is_init != ''">
                    AND avc.is_init = #{is_init}
               </if>
			    <if test="old_check_id != null and old_check_id != ''">
                    AND avc.old_check_id = #{old_check_id}
               </if>
               <if test="state == 0">
				and not exists(select 1 from ACC_BANK_VERI b where avc.group_id = b.group_id
							    AND avc.hos_id = b.hos_id
							    AND avc.copy_code = b.copy_code
							    AND avc.acc_year = b.acc_year
							    and avc.vouch_check_id = b.vouch_check_id	
								and avc.vouch_id = b.vouch_id	 )
	   			</if>
				<if test="state == 1">
				and  exists(select 1 from ACC_BANK_VERI b where avc.group_id = b.group_id
							    AND avc.hos_id = b.hos_id
							    AND avc.copy_code = b.copy_code
							    AND avc.acc_year = b.acc_year
							    and avc.vouch_check_id = b.vouch_check_id	
								and avc.vouch_id = b.vouch_id)
	   			</if>
        </where>
      	)
      	select * from a_table
      	union all
      	select * from b_table
        
    </select>
    
    <select id="queryAccBankJournalPrint" parameterType="java.util.Map"	resultType="java.util.Map">
		
with v_table as(  	
		<!-- 昨日结转=本年年初余额加小于开始日期的余额 -->
			  <!-- 昨日结转 -->
			  select 
			        0 as group_id,
			        0 as hos_id,
			        '' as copy_code,
			        0 as vouch_id,
			        0 as vouch_detail_id,
			        '' as vouch_date,
			        '' as v_year,
			        '' as v_month,
			        '' as v_day,
			        '' as vouch_no,
			        '期初余额' as summary,
			        null as is_check,
			        to_char('') as subj_name,
			        '' as other_subj_name,
			        0 as other_bal,
			        0 as debit,
			        0 as credit,
			        a.subj_dire, 
			        a.bal+b.bal as bal 
			   from 
			    <!-- 年初余额 -->
			      (select al.end_os  as bal,subj.subj_dire
			             from acc_leder al
			               left join acc_subj subj
			                 on al.group_id = subj.group_id
			                   and al.hos_id = subj.hos_id
			                   and al.copy_code = subj.copy_code
			                   and al.acc_year = subj.acc_year
			                   and al.subj_code = subj.subj_code 
			             where  al.group_id = #{group_id}
			               and al.hos_id = #{hos_id}
			               and al.copy_code = #{copy_code}
			               and al.subj_code = #{subj_code}
			               and al.acc_year = #{acc_year}
			               and al.acc_month = '00'
			        ) a,     
			    <!-- 小于开始日期的余额 -->
			        (
			        select nvl(sum(avc.debit),0)-nvl(sum(avc.credit),0) as bal
			               from acc_vouch av
			               left join acc_vouch_check avc
			                    on av.group_id = avc.group_id
			                    and av.hos_id = avc.hos_id
			                    and av.copy_code = avc.copy_code
			                    and av.acc_year = avc.acc_year
			                    and av.vouch_id = avc.vouch_id
						   <where>
						   		<if test="group_id != null and group_id !=''">
			               			av.group_id = #{group_id}
						   		</if>
						   		<if test="hos_id != null and hos_id != ''">
					               and av.hos_id = #{hos_id}
						   		</if>
						   		<if test="copy_code != null and copy_code != ''">
						           and av.copy_code = #{copy_code}
						   		</if>
						   		<if test="acc_year != null and acc_year != ''">
					               and av.acc_year = #{acc_year}
						   		</if>
						   		<if test="begin_date != null and begin_date !=''">
					               and av.vouch_date&lt;to_date(#{begin_date},'yyyy/MM/dd')
						   		</if>
						   		<if test="subj_code != null and subj_code != '' ">
			               			and avc.subj_code = #{subj_code}
						   		</if>
						   </where>							                    
			         ) b 

			),
			<!-- 每日凭证明细 --> 
			a_table as(
			      select 
			           avc.group_id,
			           avc.hos_id,
			           avc.copy_code,
			           avc.vouch_id,
			           avc.vouch_detail_id,
			           to_char(av.vouch_date,'yyyy/MM/dd') as vouch_date,
			           to_char(av.vouch_date,'yyyy') as v_year,
			           to_char(av.vouch_date,'MM') as v_month,
			           to_char(av.vouch_date,'dd') as v_day,
			           avt.vouch_type_short||'-'||av.vouch_no as vouch_no,
			           avc.summary,
			           (case when abv.vouch_check_id is not null then '是' else '否' end) as is_check,
			           to_char(subj.subj_name_all) as subj_name,
			           '' as other_subj_name,
			           0 as other_bal,
			           avc.debit,
			           avc.credit,
			           subj.subj_dire,
			           avc.debit-avc.credit as bal 
			      from 
			          acc_vouch_check avc
			             left join acc_vouch av
			                   on avc.group_id = av.group_id
			                   and avc.hos_id = av.hos_id
			                   and avc.copy_code = av.copy_code
			                   and avc.acc_year = av.acc_year
			                   and avc.vouch_id = av.vouch_id
			             left join acc_subj subj
			                   on avc.group_id = subj.group_id
			                   and avc.hos_id = subj.hos_id
			                   and avc.copy_code = subj.copy_code
			                   and avc.acc_year = subj.acc_year
			                   and avc.subj_code = subj.subj_code 
			             left join acc_vouch_type avt
			                  on av.group_id = avt.group_id
			                  and av.hos_id = avt.hos_id
			                  and av.copy_code = avt.copy_code
			                  and av.vouch_type_code = avt.vouch_type_code
			             left join acc_bank_veri abv
			                  on avc.group_id = abv.group_id
			                  and avc.hos_id = abv.hos_id
			                  and avc.copy_code = abv.copy_code
			                  and avc.acc_year = abv.acc_year
			                  and avc.vouch_check_id = abv.vouch_check_id
			              <where>
			              		<if test="group_id != null and group_id != ''">
			                   		avc.group_id = #{group_id}
			              		</if>
			              		<if test="hos_id != null and hos_id !=''">
					                and avc.hos_id = #{hos_id}
			              		</if>
			              		<if test="copy_code != null and copy_code != ''">
					                and avc.copy_code = #{copy_code}
			              		</if>
			              		<if test="acc_year != null and acc_year != ''">
				                    and avc.acc_year = #{acc_year}
			              		</if>
			              		<if test="subj_code != null and subj_code != ''">
				                    and avc.subj_code = #{subj_code}
			              		</if>
			              		<if test="money != null and money != '' and sumMoney!= null and sumMoney != ''">
			                   		and ((avc.debit between #{money} and  #{sumMoney}) or (avc.credit between  #{money}  and #{sumMoney}))
			              		</if>
			              		<if test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
			                   		and av.vouch_no between  #{vouch_no_b}  and  #{vouch_no_e} 
			              		</if>
			              		<if test="state != null and state != '' ">
			                   		and av.state>=#{state}
			              		</if>
			              		<if test="begin_date != null and begin_date != '' and end_date != null and end_date != ''">
				                    and av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
				                    and to_date(#{end_date},'yyyy/MM/dd')
			              		</if>
			              		<if test="vouch_type_code != null and vouch_type_code != ''">
			                   		and av.vouch_type_code = #{vouch_type_code}
			              		</if>
			              		<if test="create_user != null and create_user != ''">
			                   		and av.create_user = #{create_user}
			              		</if>
			              		<if test="summary != null and summary != ''">
			                   		and avc.summary like '%${summary}%'
			              		</if>
			              </where>
			              order by av.vouch_date,vouch_no,avc.vouch_detail_id
			),
			b_table as (
			        <!-- 本日合计 -->
			        select 
			             0 as group_id,
			             0 as hos_id,
			             null as copy_code,
			             null as vouch_id,
			             null as vouch_detail_id,
			             null as vouch_date,
			             to_char(t.vouch_date,'yyyy') as v_year,
			             to_char(t.vouch_date,'MM') as v_month,
			             to_char(t.vouch_date,'dd') as v_day,
			             null as vouch_no,
			             '本日合计' as summary,
			             null as is_check,
			             to_char('') as subj_name,
			             '' as other_subj_name,
			             0 as other_bal,
			             sum(t.debit) as debit,
			             sum(t.credit) as credit,
			             t.subj_dire,
			             0 as bal 
			         from(
			             <!-- 凭证明细数据 -->
			              select 
			                     
			                     av.vouch_date,
			                     to_char(av.vouch_date,'yyyy') as v_year,
			                     to_char(av.vouch_date,'MM') as v_month,
			                     to_char(av.vouch_date,'dd') as v_day,
			                     avc.debit,
			                     avc.credit,
			                     subj.subj_dire,
			                     avc.debit-avc.credit as bal 
			                from 
			                    acc_vouch_check avc
			                       left join acc_vouch av
			                             on avc.group_id = av.group_id
			                             and avc.hos_id = av.hos_id
			                             and avc.copy_code = av.copy_code
			                             and avc.acc_year = av.acc_year
			                             and avc.vouch_id = av.vouch_id
			                       left join acc_subj subj
			                             on avc.group_id = subj.group_id
			                             and avc.hos_id = subj.hos_id
			                             and avc.copy_code = subj.copy_code
			                             and avc.acc_year = subj.acc_year
			                             and avc.subj_code = subj.subj_code 
			                       left join acc_vouch_type avt
			                            on av.group_id = avt.group_id
			                            and av.hos_id = avt.hos_id
			                            and av.copy_code = avt.copy_code
			                            and av.vouch_type_code = avt.vouch_type_code
			                       <where>
			              		<if test="group_id != null and group_id != ''">
			                   		avc.group_id = #{group_id}
			              		</if>
			              		<if test="hos_id != null and hos_id !=''">
					                and avc.hos_id = #{hos_id}
			              		</if>
			              		<if test="copy_code != null and copy_code != ''">
					                and avc.copy_code = #{copy_code}
			              		</if>
			              		<if test="acc_year != null and acc_year != ''">
				                    and avc.acc_year = #{acc_year}
			              		</if>
			              		<if test="subj_code != null and subj_code != ''">
				                    and avc.subj_code = #{subj_code}
			              		</if>
			              		<if test="money != null and money != '' and sumMoney!= null and sumMoney != ''">
			                   		and ((avc.debit between #{money} and  #{sumMoney}) or (avc.credit between  #{money}  and #{sumMoney}))
			              		</if>
			              		<if test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
			                   		and av.vouch_no between  #{vouch_no_b}  and  #{vouch_no_e} 
			              		</if>
			              		<if test="state != null and state != '' ">
			                   		and av.state>=#{state}
			              		</if>
			              		<if test="begin_date != null and begin_date != '' and end_date != null and end_date != ''">
				                    and av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
				                    and to_date(#{end_date},'yyyy/MM/dd')
			              		</if>
			              		<if test="vouch_type_code != null and vouch_type_code != ''">
			                   		and av.vouch_type_code = #{vouch_type_code}
			              		</if>
			              		<if test="create_user != null and create_user != ''">
			                   		and av.create_user = #{create_user}
			              		</if>
			              		<if test="summary != null and summary != ''">
			                   		and avc.summary like '%${summary}%'
			              		</if>
			              </where>
			              order by av.vouch_date,avc.vouch_detail_id
			             ) t 
			             group by t.v_day,t.vouch_date,t.subj_dire
			
			),
			c_table as (
			<!-- 本月合计 -->
			            select 
			                 0 as group_id,
			                 0 as hos_id,
			                 null as copy_code,
			                 null as vouch_id,
			                 null as vouch_detail_id,
			                 null as vouch_date,
			                 t.v_year,
			                 t.v_month,
			                 '' as v_day,
			                 null as vouch_no,
			                 '本月合计' as summary,
			                 null as is_check,
			                 to_char('') as subj_name,
			                 '' as other_subj_name,
			                 0 as other_bal,
			                 sum(t.debit) as debit,
			                 sum(t.credit) as credit,
			                 t.subj_dire,
			                 0 as bal 
			             from(
			                 select 
			                    to_char(av.vouch_date,'yyyy') as v_year,
			                    to_char(av.vouch_date,'MM') as v_month,
			                    sum(avc.debit) as debit,
			                    sum(avc.credit) as credit,
			                    subj.subj_dire
			                 from acc_vouch_check avc
			               left join acc_vouch av
			                      on avc.group_id = av.group_id
			                      and avc.hos_id = av.hos_id
			                      and avc.copy_code = av.copy_code
			                      and avc.acc_year = av.acc_year
			                      and avc.vouch_id= av.vouch_id
			                left join acc_subj subj
			                      on avc.group_id = subj.group_id
			                      and avc.hos_id = subj.hos_id
			                      and avc.copy_code = subj.copy_code
			                      and avc.acc_year = subj.acc_year
			                      and avc.subj_code = subj.subj_code 
			               <where>
			              		<if test="group_id != null and group_id != ''">
			                   		avc.group_id = #{group_id}
			              		</if>
			              		<if test="hos_id != null and hos_id !=''">
					                and avc.hos_id = #{hos_id}
			              		</if>
			              		<if test="copy_code != null and copy_code != ''">
					                and avc.copy_code = #{copy_code}
			              		</if>
			              		<if test="acc_year != null and acc_year != ''">
				                    and avc.acc_year = #{acc_year}
			              		</if>
			              		<if test="subj_code != null and subj_code != ''">
				                    and avc.subj_code = #{subj_code}
			              		</if>
			              		<if test="money != null and money != '' and sumMoney!= null and sumMoney != ''">
			                   		and ((avc.debit between #{money} and  #{sumMoney}) or (avc.credit between  #{money}  and #{sumMoney}))
			              		</if>
			              		<if test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
			                   		and av.vouch_no between  #{vouch_no_b}  and  #{vouch_no_e} 
			              		</if>
			              		<if test="state != null and state != '' ">
			                   		and av.state>=#{state}
			              		</if>
			              		<if test="begin_date != null and begin_date != '' and end_date != null and end_date != ''">
				                    and av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
				                    and to_date(#{end_date},'yyyy/MM/dd')
			              		</if>
			              		<if test="vouch_type_code != null and vouch_type_code != ''">
			                   		and av.vouch_type_code = #{vouch_type_code}
			              		</if>
			              		<if test="create_user != null and create_user != ''">
			                   		and av.create_user = #{create_user}
			              		</if>
			              		<if test="summary != null and summary != ''">
			                   		and avc.summary like '%${summary}%'
			              		</if>
			              </where>
			                      group by av.vouch_date,
			                              subj.subj_dire
			                 ) t group by  t.v_year,v_month,t.subj_dire
			 ),    
			 <!-- 本年累计 -->
			 d_table as (
			               select 
			                   0 as group_id,
			                   0 as hos_id,
			                   null as copy_code,
			                   null as vouch_id,
			                   null as vouch_detail_id,
			                   null as vouch_date,
			                   t.v_year,
			                   t.v_month,
			                   '' as v_day,
			                   null as vouch_no,
			                   '本年累计' as summary,
			                   null as is_check,
			                   to_char('') as subj_name,
			                   '' as other_subj_name,
			                   0 as other_bal,
			                   sum(t.debit) over(order by t.v_month) as debit,
			                   sum(t.credit)over(order by t.v_month) as credit,
			                   t.subj_dire,
			                   0 as bal 
			              from(
			                   <!-- 每月合计 -->
			                   select 
			                       t.v_year,
			                       t.v_month,
			                       sum(t.debit) as debit,
			                       sum(t.credit) as credit,
			                       t.subj_dire
			                       
			                   from(
			                       <!-- 每日合计 -->
			                        select 
			                             to_char(av.vouch_date,'yyyy') as v_year,
			                             to_char(av.vouch_date,'MM') as v_month,
			                             sum(avc.debit) as debit,
			                             sum(avc.credit) as credit,
			                             subj.subj_dire
			                        from acc_vouch_check avc
			                        left join acc_vouch av
			                             on avc.group_id = av.group_id
			                             and avc.hos_id = av.hos_id
			                             and avc.copy_code = av.copy_code
			                             and avc.acc_year = av.acc_year
			                             and avc.vouch_id = av.vouch_id
			                        left join acc_subj subj
			                             on avc.group_id = subj.group_id
			                             and avc.hos_id = subj.hos_id
			                             and avc.copy_code = subj.copy_code
			                             and avc.acc_year = subj.acc_year
			                             and avc.subj_code = subj.subj_code 
			                  <where>
				              		<if test="group_id != null and group_id != ''">
				                   		avc.group_id = #{group_id}
				              		</if>
				              		<if test="hos_id != null and hos_id !=''">
						                and avc.hos_id = #{hos_id}
				              		</if>
				              		<if test="copy_code != null and copy_code != ''">
						                and avc.copy_code = #{copy_code}
				              		</if>
				              		<if test="acc_year != null and acc_year != ''">
					                    and avc.acc_year = #{acc_year}
				              		</if>
				              		<if test="subj_code != null and subj_code != ''">
					                    and avc.subj_code = #{subj_code}
				              		</if>
				              		<if test="money != null and money != '' and sumMoney!= null and sumMoney != ''">
				                   		and ((avc.debit between #{money} and  #{sumMoney}) or (avc.credit between  #{money}  and #{sumMoney}))
				              		</if>
				              		<if test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
				                   		and av.vouch_no between  #{vouch_no_b}  and  #{vouch_no_e} 
				              		</if>
				              		<if test="state != null and state != '' ">
				                   		and av.state>=#{state}
				              		</if>
				              		<if test="begin_date != null and begin_date != '' and end_date != null and end_date != ''">
					                    and av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
					                    and to_date(#{end_date},'yyyy/MM/dd')
				              		</if>
				              		<if test="vouch_type_code != null and vouch_type_code != ''">
				                   		and av.vouch_type_code = #{vouch_type_code}
				              		</if>
				              		<if test="create_user != null and create_user != ''">
				                   		and av.create_user = #{create_user}
				              		</if>
				              		<if test="summary != null and summary != ''">
				                   		and avc.summary like '%${summary}%'
				              		</if>
			              </where>
			                       group by av.vouch_date,subj.subj_dire
			               ) t group by  t.v_year,v_month,t.subj_dire
			       )t
			),
			<!-- 下日结转 -->
			e_table as(
			        select 
			             0 as group_id,
			             0 as hos_id,
			             null as copy_code,
			             null as vouch_id,
			             null as vouch_detail_id,
			             null as vouch_date,
			             to_char(t.vouch_date,'yyyy') as v_year,
			             to_char(t.vouch_date,'MM') as v_month,
			             to_char(t.vouch_date,'dd') as v_day,
			             null as vouch_no,
			             '结转下日' as summary,
			             null as is_check,
			             to_char('') as subj_name,
			             '' as other_subj_name,
			             0 as other_bal,
			             0 as debit,
			             0 as credit,
			             t.subj_dire,
			             0 as bal 
			         from(
			             <!-- 凭证明细数据 -->
			              select 
			                     
			                     av.vouch_date,
			                     to_char(av.vouch_date,'yyyy') as v_year,
			                     to_char(av.vouch_date,'MM') as v_month,
			                     to_char(av.vouch_date,'dd') as v_day,
			                     avc.debit,
			                     avc.credit,
			                     subj.subj_dire,
			                     avc.debit-avc.credit as bal 
			                from 
			                    acc_vouch_check avc
			                       left join acc_vouch av
			                             on avc.group_id = av.group_id
			                             and avc.hos_id = av.hos_id
			                             and avc.copy_code = av.copy_code
			                             and avc.acc_year = av.acc_year
			                             and avc.vouch_id = av.vouch_id
			                       left join acc_subj subj
			                             on avc.group_id = subj.group_id
			                             and avc.hos_id = subj.hos_id
			                             and avc.copy_code = subj.copy_code
			                             and avc.acc_year = subj.acc_year
			                             and avc.subj_code = subj.subj_code 
			                       left join acc_vouch_type avt
			                            on av.group_id = avt.group_id
			                            and av.hos_id = avt.hos_id
			                            and av.copy_code = avt.copy_code
			                            and av.vouch_type_code = avt.vouch_type_code
			                       <where>
			              		<if test="group_id != null and group_id != ''">
			                   		avc.group_id = #{group_id}
			              		</if>
			              		<if test="hos_id != null and hos_id !=''">
					                and avc.hos_id = #{hos_id}
			              		</if>
			              		<if test="copy_code != null and copy_code != ''">
					                and avc.copy_code = #{copy_code}
			              		</if>
			              		<if test="acc_year != null and acc_year != ''">
				                    and avc.acc_year = #{acc_year}
			              		</if>
			              		<if test="subj_code != null and subj_code != ''">
				                    and avc.subj_code = #{subj_code}
			              		</if>
			              		<if test="money != null and money != '' and sumMoney!= null and sumMoney != ''">
			                   		and ((avc.debit between #{money} and  #{sumMoney}) or (avc.credit between  #{money}  and #{sumMoney}))
			              		</if>
			              		<if test="vouch_no_b != null and vouch_no_b != '' and vouch_no_e != null and vouch_no_e != ''">
			                   		and av.vouch_no between  #{vouch_no_b}  and  #{vouch_no_e} 
			              		</if>
			              		<if test="state != null and state != '' ">
			                   		and av.state>=#{state}
			              		</if>
			              		<if test="begin_date != null and begin_date != '' and end_date != null and end_date != ''">
				                    and av.vouch_date between to_date(#{begin_date},'yyyy/MM/dd')
				                    and to_date(#{end_date},'yyyy/MM/dd')
			              		</if>
			              		<if test="vouch_type_code != null and vouch_type_code != ''">
			                   		and av.vouch_type_code = #{vouch_type_code}
			              		</if>
			              		<if test="create_user != null and create_user != ''">
			                   		and av.create_user = #{create_user}
			              		</if>
			              		<if test="summary != null and summary != ''">
			                   		and avc.summary like '%${summary}%'
			              		</if>
			              </where>
			              order by av.vouch_date,avc.vouch_detail_id
			             ) t 
			             group by t.v_day,t.vouch_date,t.subj_dire
			)
    <!-- 查询所有数据 -->
        select 
             t.group_id,
             t.hos_id,
             t.copy_code,
             t.vouch_id,
             t.vouch_detail_id,
             t.vouch_date,
             t.v_year,
             t.v_month,
             t.v_day,
             t.vouch_no,
             t.summary,
             t.is_check t_is_check,
             t.subj_name,
             ( SELECT s.subj_name_all
				FROM acc_vouch_detail d
					LEFT JOIN acc_subj s ON d.subj_code = s.subj_code  
				WHERE d.vouch_id = t.vouch_id
					AND rownum = 1
					AND CASE WHEN t.debit = 0 THEN d.debit ELSE d.credit END &lt;&gt; 0
					AND d.vouch_detail_id &lt;&gt; t.vouch_detail_id
				<!-- 	AND nvl(d.debit, 0) + nvl(d.credit, 0) = nvl(t.debit, 0) + nvl(t.credit, 0) -->
				)  other_subj_name,
				(
				SELECT CASE WHEN t.debit = 0 THEN d.debit ELSE d.credit END AS o_money
				FROM acc_vouch_detail d
				WHERE d.vouch_id = t.vouch_id
					AND rownum = 1
					AND CASE WHEN t.debit = 0 THEN d.debit ELSE d.credit END &lt;&gt; 0
					AND d.vouch_detail_id &lt;&gt; t.vouch_detail_id
					<!-- and nvl(d.debit, 0) + nvl(d.credit, 0) = nvl(t.debit, 0) + nvl(t.credit, 0) -->
				) other_bal,
             t.debit,
             t.credit,
             t.subj_dire,
             sum(t.bal) over(order by t.numNo,t.vouch_date,t.vouch_no,vouch_detail_id) as bal,
             t.numNo
       from(
             <!-- 昨日结转 -->
             select
                 0 as group_id, 0 as hos_id, '' as copy_code, 0 as vouch_id,null as vouch_detail_id,'' as vouch_date,
                 '' as v_year, '' as v_month,'' as v_day, '' as vouch_no, v.summary,null as is_check,
                 to_char('') as subj_name,'' as other_subj_name,0 as other_bal,0 as debit,0 as credit,
                 v.subj_dire, v.bal,'0' as numNo 
             from v_table v
      union all
             <!-- 每日凭证 -->
             select
                 a.group_id, a.hos_id,a.copy_code, a.vouch_id,a.vouch_detail_id,a.vouch_date,
                 a.v_year, a.v_month,a.v_day,a.vouch_no, a.summary,a.is_check,
                 a.subj_name,a.other_subj_name,a.other_bal,a.debit,a.credit,
                 a.subj_dire, a.bal,a.v_year||a.v_month||a.v_day|| '41' as numNo 
              from a_table a
      union all
             <!-- 本日合计 -->   
              select 
                 0 as group_id, 0 as hos_id,null as copy_code, null as vouch_id,null as vouch_detail_id,null as vouch_date,
                 b.v_year,b.v_month,b.v_day,null as vouch_no,b.summary,null as is_check, to_char('') as subj_name,'' as other_subj_name,
                 0 as other_bal,b.debit, b.credit, b.subj_dire,b.bal,b.v_year||b.v_month||b.v_day|| '42' as numNo 
              from b_table b
      union all
             <!-- 本月合计 --> 
              select 
                 0 as group_id,0 as hos_id, null as copy_code, null as vouch_id,null as vouch_detail_id,null as vouch_date,c.v_year,
                 c.v_month, '' as v_day,null as vouch_no,c.summary,null as is_check,to_char('') as subj_name,'' as other_subj_name,
                 0 as other_bal, c.debit,c.credit,c.subj_dire,c.bal,c.v_year||c.v_month|| '44' as numNo 
              from c_table c
             <!-- 本年累计 -->
      union all
              select 
                 0 as group_id,0 as hos_id, null as copy_code, null as vouch_id,null as vouch_detail_id,null as vouch_date,d.v_year,
                 d.v_month, '' as v_day,null as vouch_no,d.summary,null as is_check,to_char('') as subj_name,'' as other_subj_name,
                 0 as other_bal, d.debit,d.credit,d.subj_dire,d.bal,d.v_year||d.v_month|| '45' as numNo 
              from d_table d 
              <!-- 下日结转 -->
      union all
              select 
                 0 as group_id,0 as hos_id,null as copy_code,null as vouch_id,null as vouch_detail_id,
                 null as vouch_date,e.v_year,e.v_month,e.v_day,null as vouch_no,
                 e.summary,null as is_check,to_char('') as subj_name,'' as other_subj_name,0 as other_bal,
                 0 as debit,0 as credit,e.subj_dire,0 as bal,
                 e.v_year||e.v_month||e.v_day||'43' as numNo  
              from e_table e                
             ) t 
     order by t.numNo,t.vouch_date,t.vouch_no,t.vouch_detail_id
		
	</select>
	
	<insert id="saveAccVouchCheck" useGeneratedKeys="true">

		INSERT INTO ACC_VOUCH_CHECK (
			<if test="vouch_check_id != null and vouch_check_id != ''">
			vouch_check_id		,
			</if>
			<if test="vouch_id != null and vouch_id != ''">
			vouch_id,
			</if>
			<if test="vouch_detail_id != null and vouch_detail_id != ''">	
			vouch_detail_id		,
			</if>
			<if test="group_id != null and group_id != ''">
			group_id		,
			</if>
			<if test="hos_id != null and hos_id != ''">
			hos_id		,
			</if>
			<if test="copy_code != null and copy_code != ''">
			copy_code		,
			</if>
			<if test="acc_year != null and acc_year != ''">
			acc_year		,
			</if>
			<if test="cash_subj_code != null and cash_subj_code != ''">
			subj_code		,
			</if>
			<if test="summary != null and summary != ''">
			summary		,
			</if>
			<if test="debit != null and debit != ''">
			debit		,
			</if>
			<if test="credit != null and credit != ''">
			credit		,
			</if>
			<if test="con_no != null and con_no != ''">
			con_no		,
			</if>
			<if test="check_no != null and check_no != ''">
			check_no		,
			</if>
			<if test="business_no != null and business_no != ''">
			business_no		,
			</if>
			<if test="occur_date != null and occur_date != ''">
			occur_date		,
			</if>
			<if test="due_date != null and due_date != ''">
			due_date		,
			</if>
			<if test="pay_type_code != null and pay_type_code != ''">
			pay_type_code		,
			</if>
			<if test="is_init != null and is_init != ''">
			is_init	,	
			</if>
			debit_w,
			
			credit_w
		) VALUES (
			<if test="vouch_check_id != null and vouch_check_id != ''">
			#{vouch_check_id} ,
			</if>
			<if test="vouch_id != null and vouch_id != ''">
			#{vouch_id} ,
			</if>
			<if test="vouch_detail_id != null and vouch_detail_id != ''">
			#{vouch_detail_id} ,
			</if>
			<if test="group_id != null and group_id != ''">
			#{group_id} ,
			</if>
			<if test="hos_id != null and hos_id != ''">
			#{hos_id} ,
			</if>
			<if test="copy_code != null and copy_code != ''">
			#{copy_code} ,
			</if>
			<if test="acc_year != null and acc_year != ''">
			#{acc_year} ,
			</if>
			<if test="cash_subj_code != null and cash_subj_code != ''">
			#{cash_subj_code} ,
			</if>
			<if test="summary != null and summary != ''">
			#{summary} ,
			</if>
			<if test="debit != null and debit != ''">
			#{debit} ,
			</if>
			<if test="credit != null and credit != ''">
			#{credit} ,
			</if>
			<if test="con_no != null and con_no != ''">
			#{con_no} ,
			</if>
			<if test="check_no != null and check_no != ''">
			#{check_no} ,
			</if>
			<if test="business_no != null and business_no != ''">
			#{business_no} ,
			</if>
			<if test="occur_date != null and occur_date != ''">
			to_date(#{occur_date},'yyyy/MM/dd'),
			</if>
			<if test="due_date != null and due_date != ''">
			to_date(#{due_date},'yyyy/MM/dd'),
			</if>
			<if test="pay_type_code != null and pay_type_code != ''">
			#{pay_type_code} ,
			</if>
			<if test="is_init != null and is_init != ''">
			#{is_init},
			</if>
			
			#{debit_w},
			
			#{credit_w}

		)
	</insert>
	
	<!-- 往来核销初始账删除 -->
	<delete id="deleteAccVouchCheckByNostro" parameterType="java.util.Map">
		DELETE FROM acc_vouch_check 
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			AND acc_year = #{acc_year,jdbcType=INTEGER}
			AND subj_code = #{subj_code,jdbcType=VARCHAR}
			AND vouch_id IS NULL 
			AND is_init = 1 
			AND credit = 0 
			AND debit = 0 
	</delete>
</mapper>

