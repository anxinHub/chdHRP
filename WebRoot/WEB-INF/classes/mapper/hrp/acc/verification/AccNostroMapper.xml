<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.acc.dao.verification.AccNostroMapper">

	<resultMap id="accVouchCheckTest" type="com.chd.hrp.acc.entity.AccLederCheck">
        <result property="group_id" column="group_id"/>
        <result property="hos_id" column="hos_id"/>
        <result property="copy_code" column="copy_code"/>
        <result property="acc_year" column="acc_year"/>
        <result property="acc_month" column="acc_month"/>
        <result property="acc_day" column="acc_day"/>
        <result property="subj_code" column="subj_code"/>
        <result property="bal_os" column="bal_os"/>
        <result property="this_od" column="this_od"/>
        <result property="this_oc" column="this_oc"/>
        <result property="sum_od" column="sum_od"/>
        <result property="sum_oc" column="sum_oc"/>
        <result property="end_os" column="end_os"/>
        <result property="bal_os_w" column="bal_os_w"/>
        <result property="this_od_w" column="this_od_w"/>
        <result property="this_oc_w" column="this_oc_w"/>
        <result property="sum_od_w" column="sum_od_w"/>
        <result property="sum_oc_w" column="sum_oc_w"/>
        <result property="end_os_w" column="end_os_w"/>
        <result property="check1_id" column="check1_id"/>
        <result property="check1_no" column="check1_no"/>
        <result property="check2_id" column="check2_id"/>
        <result property="check2_no" column="check2_no"/>
        <result property="check3_id" column="check3_id"/>
        <result property="check3_no" column="check3_no"/>
        <result property="check4_id" column="check4_id"/>
        <result property="check4_no" column="check4_no"/>
        <result property="check5_id" column="check5_id"/>
        <result property="check5_no" column="check5_no"/>
        <result property="check6_id" column="check6_id"/>
        <result property="check6_no" column="check6_no"/>
        <result property="check7_id" column="check7_id"/>
        
        <result property="subj_dire" column="subj_dire"/>
        <result property="balance" column="balance"/>
        <result property="cus_code" column="cus_code"/>
        <result property="cus_name" column="cus_name"/>
        <result property="dept_code" column="dept_code"/>
        <result property="dept_name" column="dept_name"/>
        <result property="emp_code" column="emp_code"/>
        <result property="emp_name" column="emp_name"/>
        <result property="proj_code" column="proj_code"/>
        <result property="proj_name" column="proj_name"/>
        <result property="store_code" column="store_code"/>
        <result property="store_name" column="store_name"/>
        <result property="sup_code" column="sup_code"/>
        <result property="sup_name" column="sup_name"/>
        <result property="source_code" column="source_code"/>
		<result property="source_name" column="source_name"/>
	    <result property="check_item_code" column="check_item_code"/>
		<result property="check_item_name" column="check_item_name"/>
		
		<result property="check_code" column="check_code"/>
        <result property="check_name" column="check_name"/>
        <result property="vouch_no" column="vouch_no"/>
        <result property="summary" column="summary"/>
        <result property="state" column="state"/>
        <result property="con_no" column="con_no"/>
		<result property="business_no" column="business_no"/>
	    <result property="occur_date" column="occur_date"/>
		<result property="due_date" column="due_date"/>
		
		<result property="debit" column="debit"/>
        <result property="credit" column="credit"/>
        <result property="vouch_date" column="vouch_date"/>
        <result property="ver_date" column="ver_date"/>
        <result property="ver_person" column="ver_person"/>
        <result property="bal_amt" column="bal_amt"/>
        <result property="ybal_amt" column="ybal_amt"/>
		<result property="wbal_amt" column="wbal_amt"/>
		<result property="veri_check_id" column="veri_check_id"/>
	</resultMap>
	
	<resultMap id="accMaps" type="java.util.Map">
		<result property="check_code" column="check_code"/>
		<result property="check_name" column="check_name"/>
		<result property="end_os" column="end_os"/>
		<result property="col_1" column="col_1"/>
		<result property="col_2" column="col_2"/>
		<result property="col_3" column="col_3"/>
		<result property="col_4" column="col_4"/>
		<result property="col_5" column="col_5"/>
		<result property="col_6" column="col_6"/>
		<result property="col_7" column="col_7"/>
		
		<result property="acc_year" column="acc_year"/>
		<result property="acc_month" column="acc_month"/>
		<result property="acc_day" column="acc_day"/>
		<result property="vouch_no" column="vouch_no"/>
		<result property="check_code" column="check_code"/>
		<result property="check_name" column="check_name"/>
		<result property="summary" column="summary"/>
		<result property="state" column="state"/>
		<result property="con_no" column="con_no"/>
		<result property="business_no" column="business_no"/>
		
		<result property="occur_date" column="occur_date"/>
		<result property="due_date" column="due_date"/>
		<result property="debit" column="debit"/>
		<result property="credit" column="credit"/>
		<result property="con_no" column="con_no"/>
		<result property="subj_dire" column="subj_dire"/>
		<result property="end_os" column="end_os"/>
		<result property="vouch_id" column="vouch_id"/>
		
	</resultMap>
	
	<resultMap id="accSubjs"  type="com.chd.hrp.acc.entity.AccSubj">
		 <result property="group_id" column="group_id"/>
        <result property="hos_id" column="hos_id"/>
        <result property="copy_code" column="copy_code"/>
        <result property="acc_year" column="acc_year"/>
        <result property="subj_id" column="subj_id"/>
        <result property="subj_code" column="subj_code"/>
        <result property="cur_code" column="cur_code"/>
        <result property="subj_type_code" column="subj_type_code"/>
        <result property="subj_nature_code" column="subj_nature_code"/>
        <result property="subj_nature_name" column="subj_nature_name"/>
        <result property="vouch_type_code" column="vouch_type_code"/>
        <result property="super_code" column="super_code"/>
        <result property="subj_name" column="subj_name"/>
        <result property="subj_name_all" column="subj_name_all"/>
        <result property="subj_name_en" column="subj_name_en"/>
        <result property="is_cash" column="is_cash"/>
        <result property="subj_dire" column="subj_dire"/>
        <result property="subj_level" column="subj_level"/>
        <result property="is_last" column="is_last"/>
        <result property="spell_code" column="spell_code"/>
        <result property="wbx_code" column="wbx_code"/>
        <result property="is_stop" column="is_stop"/>
        <result property="is_remit" column="is_remit"/>
        <result property="is_check" column="is_check"/>
        <result property="check1" column="check1"/>
        <result property="check2" column="check2"/>
        <result property="check3" column="check3"/>
        <result property="check4" column="check4"/>
        <result property="check5" column="check5"/>
        <result property="check6" column="check6"/>
        <result property="check7" column="check7"/>
        <result property="check8" column="check8"/>
        <result property="check9" column="check9"/>
        <result property="check10" column="check10"/>
		<result property="debit" column="debit"/>	
		<result property="bal_os" column="bal_os"/>
		<result property="end_os" column="end_os"/>
		<result property="check1_str" column="check1_str"/>
        <result property="check2_str" column="check2_str"/>
        <result property="check3_str" column="check3_str"/>
        <result property="check4_str" column="check4_str"/>
        <result property="check5_str" column="check5_str"/>
        <result property="check6_str" column="check6_str"/>
        <result property="check7_str" column="check7_str"/>
        
        <result property="cus_code" column="cus_code" />
		<result property="cus_name" column="cus_name" />
		<result property="dept_code" column="dept_code" />
		<result property="dept_name" column="dept_name" />
		<result property="emp_code" column="emp_code" />
		<result property="emp_name" column="emp_name" />
		<result property="proj_code" column="proj_code" />
		<result property="proj_name" column="proj_name" />
		<result property="store_code" column="store_code" />
		<result property="store_name" column="store_name" />
		<result property="sup_code" column="sup_code" />
		<result property="sup_name" column="sup_name" />
		<result property="source_code" column="source_code" />
		<result property="source_name" column="source_name" />
		<result property="check_item_code" column="check_item_code" />
		<result property="check_item_name" column="check_item_name" />
        
        <!-- 以下用于返回科目挂的辅助核算信息 add by alfred-->
        <result property="check_type_name" column="check_type_name"/>
        <result property="column_id" column="column_id"/>
        <result property="column_no" column="column_no"/>
        <result property="column_code" column="column_code"/>
        <result property="column_name" column="column_name"/>
        <result property="column_check" column="column_check"/>
        <!-- 以下用于返回科目挂的辅助核算类型信息 -->
        <result property="check_type_code1" column="check_type_code1"/>
        <result property="check_type_code2" column="check_type_code2"/>
        <result property="check_type_code3" column="check_type_code3"/>
        <result property="check_type_code4" column="check_type_code4"/>
        <!-- 会计科目所挂部门支出性质 -->
        <result property="out_code" column="out_code"/>
        <result property="out_name" column="out_name"/>
        
        <result property="error_type" column="error_type"/>
	</resultMap>
	
	<resultMap type="java.util.Map" id="accAutoMap">
	</resultMap>
	
	<resultMap id="accVouchChecks" type="com.chd.hrp.acc.entity.AccVouchCheck">
		<result property="veri_id" column="veri_id" />
		<result property="vouch_check_id" column="vouch_check_id" />
		<result property="bank_id" column="bank_id" />
		<result property="vouch_id" column="vouch_id" />
		<result property="vouch_detail_id" column="vouch_detail_id" />
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="acc_year" column="acc_year" />
		<result property="subj_id" column="subj_id" />
		<result property="summary" column="summary" />
		<result property="debit" column="debit" />
		<result property="credit" column="credit" />
		<result property="con_no" column="con_no" />
		<result property="check_no" column="check_no" />
		<result property="business_no" column="business_no" />
		<result property="occur_date" column="occur_date" />
		<result property="due_date" column="due_date" />
		<result property="pay_type_code" column="pay_type_code" />
		<result property="pay_name" column="pay_name" />
		<result property="debit_w" column="debit_w" />
		<result property="credit_w" column="credit_w" />
		<result property="check1_id" column="check1_id" />
		<result property="check1_no" column="check1_no" />
		<result property="check2_id" column="check2_id" />
		<result property="check2_no" column="check2_no" />
		<result property="check3_id" column="check3_id" />
		<result property="check3_no" column="check3_no" />
		<result property="check4_id" column="check4_id" />
		<result property="check4_no" column="check4_no" />
		<result property="check5_id" column="check5_id" />
		<result property="check5_no" column="check5_no" />
		<result property="check6_id" column="check6_id" />
		<result property="check6_no" column="check6_no" />
		<result property="check7_id" column="check7_id" />
		<result property="check1" column="check1" />
		<result property="check2" column="check2" />
		<result property="check3" column="check3" />
		<result property="check4" column="check4" />
		<result property="check5" column="check5" />
		<result property="check6" column="check6" />
		<result property="check7" column="check7" />
		<result property="is_init" column="is_init" />
		<result property="old_check_id" column="old_check_id" />
		<result property="balance" column="balance" />
		<result property="cus_code" column="cus_code" />
		<result property="cus_name" column="cus_name" />
		<result property="dept_code" column="dept_code" />
		<result property="dept_name" column="dept_name" />
		<result property="emp_code" column="emp_code" />
		<result property="emp_name" column="emp_name" />
		<result property="proj_code" column="proj_code" />
		<result property="proj_name" column="proj_name" />
		<result property="store_code" column="store_code" />
		<result property="store_name" column="store_name" />
		<result property="sup_code" column="sup_code" />
		<result property="sup_name" column="sup_name" />
		<result property="source_code" column="source_code" />
		<result property="source_name" column="source_name" />
		<result property="check_item_code" column="check_item_code" />
		<result property="check_item_name" column="check_item_name" />
		<result property="is_checks" column="is_checks" />
		<result property="is_auto" column="is_auto" />
		<result property="vouch_no" column="vouch_no"/>
		<result property="subj_dire" column="subj_dire"/>
		
		<result property="other_subj_name" column="other_subj_name"/>
		<result property="other_money" column="other_money"/>
		<result property="bal" column="bal"/>
		<result property="v_year" column="v_year"/>
		<result property="v_month" column="v_month"/>
		<result property="v_day" column="v_day"/>
		<result property="is_check" column="is_check"/>
		<result property="money" column="money"/>
	</resultMap>
	
	
	<!-- 往来初始账 查询科目余额 -->
	<select id="queryAccLederCheckBySubjId" resultMap="accVouchCheckTest" parameterType="java.util.Map" >
        SELECT 
            a.group_id,
            a.hos_id,
            a.copy_code,
            a.acc_year,
            a.acc_month,
            a.subj_code,
            a.bal_os,
            a.this_od,
            a.this_oc,
            a.sum_od,
            a.sum_oc,
            a.end_os,
            a.bal_os_w,
            a.this_od_w,
            a.this_oc_w,
            a.sum_od_w,
            a.sum_oc_w,
            a.end_os_w,
            a.check1_id,
            a.check1_no,
            a.check2_id,
            a.check2_no,
            a.check3_id,
            a.check3_no,
            a.check4_id,
            a.check4_no,
            a.check5_id,
            a.check5_no,
            a.check6_id,
            a.check6_no,
            a.check7_id
    	FROM acc_leder_check a 
    	left join acc_subj b on  a.group_id=b.group_id
    		and a.hos_id=b.hos_id
    		and a.copy_code=b.copy_code
    		and a.acc_year=b.acc_year 
    		and a.subj_code=b.subj_code 
		WHERE  a.group_id = #{group_id,jdbcType=INTEGER} 
			and a.hos_id = #{hos_id,jdbcType=INTEGER} 
			and a.copy_code = #{copy_code,jdbcType=VARCHAR} 
	        and a.acc_year = #{acc_year,jdbcType=VARCHAR} 
	        and b.subj_code = #{subj_code,jdbcType=VARCHAR}
	        and a.acc_month='00'
	        and rownum=1
	</select>
	
	<!-- 往来初始账 -->
	<select id="queryCurrentAccount" parameterType="java.util.Map" resultMap="accSubjs">
    	select 
    			a.subj_code,
    			a.subj_name, 
				a.subj_dire,
				a.is_last,
				CASE a.subj_dire WHEN 0  
					THEN  sum(nvl(debit, 0.00)) - sum(nvl(credit, 0.00))  
					ELSE  sum(nvl(credit,0.00)) - sum(nvl(debit, 0.00))  
				END AS debit
					
		from ACC_SUBJ a 
		left join ACC_VOUCH_CHECK b  on a.group_id = b.group_id
				and a.hos_id = b.hos_id
				and a.copy_code = b.copy_code
				and a.acc_year = b.acc_year
				and a.subj_code = b.subj_code
				and b.IS_INIT = 1
		<where>
				a.subj_nature_code in('04','05')
				and a.group_id=#{group_id,jdbcType=INTEGER} 
				and a.hos_id=#{hos_id,jdbcType=INTEGER} 
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				<if test="subj_code != null and subj_code != '' and subj_code != 'undefined'">
                	and a.subj_code = #{subj_code,jdbcType=VARCHAR}
               	</if>
       	group by a.subj_code,a.subj_name,a.subj_dire,a.is_last
		</where>
		order by a.subj_code	
    </select>
    
    <!-- 往来初始账 更新页面查询 -->
    <select id="queryAccCurrentAccountInit" parameterType="java.util.Map" resultMap="accAutoMap">
    	select  avc.group_id, avc.hos_id, avc.copy_code, avc.acc_year, avc.subj_code,sa.subj_name, sa.subj_dire,
    		avc.vouch_check_id, avc.vouch_id,avc.vouch_detail_id, 
			avc.summary, avc.debit, avc.credit, avc.con_no, avc.check_no, 
			avc.business_no, avc.occur_date, avc.due_date, avc.pay_type_code, avc.debit_w,avc.credit_w,
			avc.is_init, avc.old_check_id,  avt.vouch_type_short || '-' || av.vouch_no AS vouch_no
      		,case when nvl(avc.debit,0)!=0 then nvl(avc.debit,0) else nvl(avc.credit,0) end money 
      		${colName}
        from acc_vouch_check avc
	    left join acc_subj sa on avc.group_id = sa.group_id
			and avc.hos_id = sa.hos_id
			and avc.copy_code = sa.copy_code
			and avc.acc_year = sa.acc_year
			and avc.subj_code = sa.subj_code
		left join acc_pay_type apt on avc.group_id = apt.group_id
			and avc.hos_id = apt.hos_id
			and avc.copy_code = apt.copy_code
			and avc.pay_type_code = apt.pay_code 
		left join acc_vouch av on avc.hos_id = av.hos_id
			and avc.copy_code = av.copy_code
			and avc.acc_year = av.acc_year	
			and avc.vouch_id = av.vouch_id 
		left join acc_vouch_type avt on av.vouch_type_code = avt.vouch_type_code
    		and av.group_id = avt.group_id
    		and av.hos_id = avt.hos_id
    		and av.copy_code = avt.copy_code 
	    ${whereSql}
        <where>
        	<if test="group_id != null and group_id != ''">
                and avc.group_id = #{group_id,jdbcType=INTEGER} 
            </if>
			<if test="hos_id != null and hos_id != ''">
                and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
            </if>
			<if test="copy_code != null and copy_code != ''">
                and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
            </if>
			<if test="acc_year != null  and acc_year != ''">
                and avc.acc_year =#{acc_year,jdbcType=VARCHAR}
            </if>
            <if test="subj_code != null and subj_code != '' and subj_code !='undefined'">
                and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
            </if>
            <if test="subj_dire != null and subj_dire != ''">
				and sa.subj_dire = #{subj_dire,jdbcType=INTEGER}
		    </if>
			<if test="summary != null and summary != ''">
                and avc.summary like '%${summary}%'
            </if>
				and avc.is_init = 1 
        </where>   
		order by avc.vouch_check_id asc
    </select>
    
    <!-- 往来初始校验主页面查询 -->
    <select id="queryCurrentAccountCheck" parameterType="java.util.Map" resultMap="accSubjs">
    	select distinct  
    		a.subj_code, 
    		a.subj_name,  
    		a.subj_dire,
    		a.is_check,
    		abs(c.end_os) as bal_os,
    		abs(d.debit) as debit
		from  ACC_SUBJ a 
		left join ACC_VOUCH_CHECK b on  a.group_id = b.group_id 
			and a.hos_id = b.hos_id 
			and a.copy_code = b.copy_code
			and a.acc_year = b.acc_year 
			and a.subj_code = b.subj_code
		left join ACC_LEDER c on  a.group_id = c.group_id 
			and a.hos_id = c.hos_id 
			and a.copy_code = c.copy_code
			and a.acc_year = c.acc_year 
			and a.subj_code = c.subj_code 
			and c.acc_month='00'
		left join (
			select  a.group_id,a.hos_id,a.copy_code,a.acc_year,
				a.subj_code,
				SUM(CASE a.subj_dire WHEN 0 THEN nvl(debit,0) - nvl(credit,0) ELSE nvl(credit,0) - nvl(debit,0) END) AS debit
			from acc_subj a
			left join acc_vouch_check b on a.group_id=b.group_id
				and a.hos_id=b.hos_id
				and a.copy_code=b.copy_code 
				and a.acc_year=b.acc_year
				and a.subj_code=b.subj_code 
				and b.is_init=1 
			where a.group_id = 	#{group_id,jdbcType=INTEGER} 
				and a.hos_id = #{hos_id,jdbcType=INTEGER} 
				and a.copy_code= #{copy_code,jdbcType=VARCHAR}
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				<if test="subj_code != null and subj_code != '' and subj_code != 'undefined'">
                	and a.subj_code = #{subj_code,jdbcType=VARCHAR}
               	</if> 
            	group by a.group_id,a.hos_id,a.copy_code,a.acc_year,a.subj_code
		)d on d.group_id = a.group_id and d.hos_id=a.hos_id and d.copy_code=a.copy_code 
			and d.acc_year = a.acc_year and d.subj_code=a.subj_code
		<where>  a.group_id = #{group_id,jdbcType=INTEGER} 
			and a.hos_id = #{hos_id,jdbcType=INTEGER} 
			and a.copy_code = #{copy_code,jdbcType=VARCHAR}
			and a.acc_year = #{acc_year,jdbcType=VARCHAR}
			and a.subj_nature_code in('04','05')
			<if test="subj_code != null and subj_code != '' and subj_code != 'undefined'">
            	and a.subj_code = #{subj_code,jdbcType=VARCHAR}
            </if>
		</where>
		order by a.subj_code
    </select>
    
    <!-- 往来初始账删除 -->
    <delete id="deleteBatchAccVouchCheck" parameterType="java.util.List">
    	<foreach collection="list" index="index" item="item" open="begin" close=";end;" separator=";">
			DELETE FROM acc_vouch_check 
			<where>
			 	<if test="item.vouch_check_id != null and item.vouch_check_id != ''">
					and vouch_check_id = #{item.vouch_check_id,jdbcType=INTEGER}
				</if> 
				<if test="item.group_id != null and item.group_id != ''">
					and  group_id  = #{item.group_id,jdbcType=INTEGER}
				</if>
				<if test="item.hos_id != null and item.hos_id != ''">
					and  hos_id  = #{item.hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					and  copy_code = #{item.copy_code,jdbcType=VARCHAR}
				</if>
				<if test="item.acc_year != null and item.acc_year != ''">
					and acc_year=#{item.acc_year,jdbcType=VARCHAR}
				</if>
				<if test="item.is_init != null and item.is_init != ''">
					and is_init=#{item.is_init,jdbcType=INTEGER}
				</if>
			</where>
		</foreach>
    </delete>
    
    <!-- 往来初始校验明细查询 -->
    <select id="queryCurrentAccountCheckDetail" parameterType="java.util.Map" resultMap="accAutoMap">
    	with l_check as(
    		select a.group_id,
    			a.hos_id,
    			a.copy_code,
    			a.acc_year,
            	a.subj_code, 
            	a.subj_name, 
            	a.subj_dire,
            	a.is_check, 
            	alc.end_os
            	${colName}
            from acc_subj a 
            left join acc_leder_check alc on a.group_id = alc.group_id  
		    	and a.hos_id = alc.hos_id
		    	and a.copy_code = alc.copy_code  
		    	and a.acc_year = alc.acc_year
		    	and a.subj_code = alc.subj_code 
		    	and alc.acc_month = '00'  
            	${whereSql}
            where a.subj_nature_code in ('04','05')
		    	and a.group_id = #{group_id,jdbcType=INTEGER} 
		    	and a.hos_id = #{hos_id,jdbcType=INTEGER} 
		    	and a.copy_code= #{copy_code,jdbcType=VARCHAR}
		    	and a.acc_year = #{acc_year,jdbcType=VARCHAR}  
		    	and a.subj_code = #{subj_code,jdbcType=VARCHAR} 
    	),v_check as (
    		select a.group_id,
    			a.hos_id,
    			a.copy_code,
    			a.acc_year,
    			a.subj_code,
    			a.subj_dire ,
              	CASE a.subj_dire WHEN 0 THEN sum(nvl(alc.debit, 0.00) - nvl(alc.credit, 0.00)) ELSE sum(nvl(alc.credit, 0.00) - nvl(alc.debit, 0.00)) END AS debit
	            ${colName}
           from acc_subj  a 
           left join acc_vouch_check alc on a.group_id=alc.group_id
           		and a.hos_id = alc.hos_id 
           		and a.copy_code = alc.copy_code
           		and a.acc_year = alc.acc_year
           		and a.subj_code = alc.subj_code
           		and alc.is_init = 1
              	${whereSql}
           where 
              	    a.group_id = #{group_id,jdbcType=INTEGER} 
              	and a.hos_id = #{hos_id,jdbcType=INTEGER} 
              	and a.copy_code= #{copy_code,jdbcType=VARCHAR}
              	and a.acc_year = #{acc_year,jdbcType=VARCHAR}  
              	and a.subj_code = #{subj_code,jdbcType=VARCHAR} 
              	and a.subj_nature_code in ('04','05') 
           group by a.group_id,a.hos_id,a.copy_code,a.acc_year, a.subj_code, a.subj_name, a.subj_dire
           		${orderBy}
    	)
    	select
    		l_check.subj_code,
    		l_check.subj_name,
    		l_check.subj_dire, 
    		v_check.debit,
    		l_check.is_check,
    		${selSql}
    		l_check.end_os
    	from l_check  l_check
        left join v_check v_check on l_check.group_id=v_check.group_id 
             and l_check.hos_id=v_check.hos_id and l_check.copy_code=v_check.copy_code
             and l_check.acc_year=v_check.acc_year and l_check.subj_code=v_check.subj_code 
    			${conntionSql}
   		order by ${selSql}l_check.subj_code
    </select>
    
    <select id="querySubjCheckColumnBySubjList" parameterType="java.util.Map" resultType="java.util.Map">
    	select * from (	
			select b.check_type_id,b.check_table, b.is_sys, b.column_id, b.column_no, b.column_code, b.column_name, b.is_change, b.column_check
			from acc_subj a
			left join acc_check_type b
				on a.group_id = b.group_id and a.hos_id = b.hos_id
				and a.copy_code = b.copy_code and a.check1 = b.check_type_id
			where a.group_id = #{group_id,jdbcType=INTEGER} 
				and a.hos_id = #{hos_id,jdbcType=INTEGER}
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				and a.subj_code = #{subj_code,jdbcType=VARCHAR}
			union all
			select b.check_type_id,b.check_table, b.is_sys, b.column_id, b.column_no, b.column_code, b.column_name, b.is_change, b.column_check
			from acc_subj a
			left join acc_check_type b
				on a.group_id = b.group_id and a.hos_id = b.hos_id
				and a.copy_code = b.copy_code and a.check2 = b.check_type_id
			where a.group_id = #{group_id,jdbcType=INTEGER} 
				and a.hos_id = #{hos_id,jdbcType=INTEGER}
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				and a.subj_code = #{subj_code,jdbcType=VARCHAR}
			union all
			select b.check_type_id,b.check_table, b.is_sys, b.column_id, b.column_no, b.column_code, b.column_name, b.is_change, b.column_check
			from acc_subj a
			left join acc_check_type b
				on a.group_id = b.group_id and a.hos_id = b.hos_id
				and a.copy_code = b.copy_code and a.check3 = b.check_type_id
			where a.group_id = #{group_id,jdbcType=INTEGER} 
				and a.hos_id = #{hos_id,jdbcType=INTEGER}
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				and a.subj_code = #{subj_code,jdbcType=VARCHAR}
			union all
			select b.check_type_id,b.check_table, b.is_sys, b.column_id, b.column_no, b.column_code, b.column_name, b.is_change, b.column_check
			from acc_subj a
			left join acc_check_type b
				on a.group_id = b.group_id and a.hos_id = b.hos_id
				and a.copy_code = b.copy_code and a.check4 = b.check_type_id
			where a.group_id = #{group_id,jdbcType=INTEGER} 
				and a.hos_id = #{hos_id,jdbcType=INTEGER}
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				and a.subj_code = #{subj_code,jdbcType=VARCHAR}
		) tmp
		where check_table is not null
    </select>
    <!-- 查看当前会计科目挂哪个辅助核算 -->
    <select id="querySubjCheckColumnBySubj" parameterType="java.util.Map" resultType="java.util.Map">
    	select * from (	
			select b.check_type_id,b.check_table, b.is_sys, b.column_id, b.column_no, b.column_code, b.column_name, b.is_change, b.column_check
			from acc_subj a
			left join acc_check_type b
				on a.group_id = b.group_id and a.hos_id = b.hos_id
				and a.copy_code = b.copy_code and a.check1 = b.check_type_id
			where a.group_id = #{group_id,jdbcType=INTEGER} 
				and a.hos_id = #{hos_id,jdbcType=INTEGER}
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.subj_code = #{subj_code,jdbcType=VARCHAR}
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				and b.check_type_id = #{check_type_id,jdbcType=INTEGER}
			union 
			select b.check_type_id,b.check_table, b.is_sys, b.column_id, b.column_no, b.column_code, b.column_name, b.is_change, b.column_check
			from acc_subj a
			left join acc_check_type b
				on a.group_id = b.group_id and a.hos_id = b.hos_id
				and a.copy_code = b.copy_code and a.check2 = b.check_type_id
			where a.group_id = #{group_id,jdbcType=INTEGER} 
				and a.hos_id = #{hos_id,jdbcType=INTEGER}
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				and a.subj_code = #{subj_code,jdbcType=VARCHAR}
			union 
			select b.check_type_id,b.check_table, b.is_sys, b.column_id, b.column_no, b.column_code, b.column_name, b.is_change, b.column_check
			from acc_subj a
			left join acc_check_type b
				on a.group_id = b.group_id and a.hos_id = b.hos_id
				and a.copy_code = b.copy_code and a.check3 = b.check_type_id
			where a.group_id = #{group_id,jdbcType=INTEGER} 
				and a.hos_id = #{hos_id,jdbcType=INTEGER}
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				and a.subj_code = #{subj_code,jdbcType=VARCHAR}
			union 
			select b.check_type_id,b.check_table, b.is_sys, b.column_id, b.column_no, b.column_code, b.column_name, b.is_change, b.column_check
			from acc_subj a
			left join acc_check_type b
				on a.group_id = b.group_id and a.hos_id = b.hos_id
				and a.copy_code = b.copy_code and a.check4 = b.check_type_id
			where a.group_id = #{group_id,jdbcType=INTEGER} 
				and a.hos_id = #{hos_id,jdbcType=INTEGER}
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				and a.subj_code = #{subj_code,jdbcType=VARCHAR}
		) tmp
		<where>
			check_table is not null
			<if test="check_type !=null and check_type!=''">
				and tmp.check_table = #{check_type}
			</if>
		</where>
		
    </select>
	
	<!-- 往来查询   余额查询  -->
	<select id="queryAccLederCheckBalanceO" parameterType="java.util.Map" resultMap="accVouchCheckTest" >
		with l_check as(
		     select avc.group_id,
		            avc.hos_id,
		            avc.copy_code,
		            avc.acc_year,
		            avc.acc_month,
		            avc.subj_code,
		           	nvl(avc.bal_os,0) as bal_os,
		            nvl(avc.this_oc,0) as this_oc,
		            nvl(avc.this_od,0) as this_od,
		            <if test="colName !=null and colName !='' ">
		             	${colName}
		            </if>
		            <if test="colName ==null or colName =='' ">
		            	'' as check_code,
		             	'' as check_name,
		            </if>
		            a.subj_dire
		     from acc_leder_check avc
		     <if test="whereSql !=null and whereSql !='' ">
		      	${whereSql}
		      </if>
		     left join acc_subj  a on avc.group_id = a.group_id
		          and avc.hos_id = a.hos_id
		          and avc.copy_code = a.copy_code
		          and avc.acc_year= a.acc_year
		          and avc.subj_code = a.subj_code
		     where avc.group_id = #{group_id,jdbcType=INTEGER} 
		           and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
		           and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
		           and avc.acc_year = #{acc_year,jdbcType=VARCHAR}
		           and avc.acc_month = '00'
		           and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
		),d_check as(
		      select avc.group_id, 
		             avc.hos_id,
		             avc.copy_code,
		             avc.acc_year,
		             av.acc_month,
		             avc.subj_code,
		             <if test="colName !=null and colName !='' ">
		             	${colName}
		             </if>
		             <if test="colName ==null or colName =='' ">
		             	'' as check_code,
		             	'' as check_name,
		             </if>
		             sum(nvl(avc.debit,0)) debit,
		             sum(nvl(avc.credit,0)) credit
		      from acc_vouch_check avc
		      <if test="whereSql !=null and whereSql !='' ">
		      	${whereSql}
		      </if>
		      left join acc_vouch_detail avd on avc.group_id = avd.group_id
		           and avc.hos_id = avd.hos_id
		           and avc.copy_code = avd.copy_code
		           and avc.acc_year = avd.acc_year
		           and avc.vouch_detail_id = avd.vouch_detail_id
		      left join acc_vouch av on avd.group_id =av.group_id
		           and avd.hos_id = av.hos_id
		           and avd.copy_code =av.copy_code
		           and avd.acc_year = av.acc_year
		           and avd.vouch_id = av.vouch_id
		      where  avc.group_id = #{group_id,jdbcType=INTEGER} 
		           and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
		           and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
		           and avc.acc_year = #{acc_year,jdbcType=VARCHAR}
		           and av.acc_month = #{acc_month,jdbcType=VARCHAR}
		           and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
		           ${state}
		           and avc.is_init = 0 
		       group by avc.group_id,avc.hos_id,avc.copy_code,avc.acc_year,av.acc_month, avc.subj_code
		       <if test="groupBy !=null and groupBy !='' ">
		       		${groupBy}
		       </if>                 
		)
		select 
		       a.group_id,
		       a.hos_id,
		       a.copy_code,
		       a.acc_year,
		       a.subj_code,
		       <if test="colName !=null and colName !='' ">
		           d_check.check_code,
		       	   d_check.check_name,
		       </if>
		       <if test="colName ==null or colName =='' ">
		           '' as check_code,
		       	   '' as check_name,
		       </if>
		       nvl(l_check.bal_os,0) as bal_os,
		       nvl(d_check.debit,0) as this_od,
		       nvl(l_check.this_od,0) + nvl(d_check.debit,0) as sum_od,
		       nvl(d_check.credit,0) as this_oc,
		       nvl(l_check.this_oc,0) + nvl(d_check.credit,0) as sum_oc,
		       case when nvl(l_check.this_od,0)>nvl(l_check.this_oc,0) then 0 else 1 end subj_dire,
		       nvl(l_check.bal_os,0) + nvl(d_check.debit, 0) - nvl(d_check.credit, 0) as balance
		from acc_subj  a
		left join d_check d_check on a.group_id = d_check.group_id and a.hos_id = d_check.hos_id
			and a.copy_code= d_check.copy_code and a.acc_year = d_check.acc_year 
			and a.subj_code = d_check.subj_code
		left join l_check l_check on  d_check.group_id = l_check.group_id 
		     and d_check.hos_id = l_check.hos_id
		     and d_check.copy_code = l_check.copy_code
		     and d_check.acc_year = l_check.acc_year
		     and d_check.subj_code = l_check.subj_code
		     <if test="aWhere !=null and aWhere !='' ">
		     	${aWhere}
		     </if>
			 <if test="showItem == '1' or showItem == 1">
				and l_check.bal_os + nvl(d_check.debit, 0) - nvl(d_check.credit, 0) > 0
			 </if>
		<where>
			<if test="group_id != null and group_id !='' ">
				and a.group_id =#{group_id,jdbcType=INTEGER} 
			</if>
			<if test="hos_id != null and hos_id !='' ">
				and a.hos_id =#{hos_id,jdbcType=INTEGER} 
			</if>
			<if test="copy_code != null and copy_code !='' ">
				and a.copy_code =#{copy_code,jdbcType=VARCHAR} 
			</if>
			<if test="acc_year != null and acc_year !='' ">
				and a.acc_year =#{acc_year,jdbcType=VARCHAR} 
			</if>
			<if test="subj_code != null and subj_code !='' ">
				and a.subj_code =#{subj_code,jdbcType=VARCHAR} 
			</if>
			and d_check.check_code is not null
		</where>
		<if test="colName !=null and colName !='' ">
			order by d_check.check_code
		</if>
	</select>
	
	<!-- 往来查询   余额查询(自定义)  -->
	<select id="queryAccLederCheckBalanceZ" parameterType="java.util.Map" resultMap="accVouchCheckTest">
		with l_check as (
		     select alc.group_id,               
		           alc.hos_id,               
		           alc.copy_code,               
		           alc.acc_year,               
		           alc.acc_month,               
		           alc.subj_code,               
		           aci.check_item_code as check_code,               
		           aci.check_item_name as check_name,               
		           nvl(alc.bal_os,0) bal_os,               
		           nvl(alc.this_od,0) this_od,               
		           nvl(alc.sum_od,0) sum_od,               
		           nvl(alc.this_oc,0) this_oc,               
		           nvl(alc.sum_oc,0) sum_oc,               
		           nvl(alc.bal_os,0) + nvl(alc.this_od,0) - nvl(alc.this_oc,0) as balance,               
		           au.subj_dire as subj_dire,               
		           aci.check_type_id as check_type_id，   
		           aci.check_item_id   
		    from acc_leder_check alc
		    left join acc_check_item aci on aci.group_id = alc.group_id
		          and aci.hos_id = alc.hos_id
		          and aci.copy_code = alc.copy_code
		          <if test="whereSqll != null and whereSqll !='' ">
		          	${whereSqll}
		          </if>
		     left join acc_subj au on au.group_id = alc.group_id
		          and au.hos_id = alc.hos_id
		          and au.copy_code = alc.copy_code
		          and au.acc_year = alc.acc_year
		          and au.subj_code  = alc.subj_code        
		     where alc.group_id = #{group_id,jdbcType=INTEGER} 
		           and alc.hos_id = #{hos_id,jdbcType=INTEGER} 
		           and alc.copy_code = #{copy_code,jdbcType=VARCHAR}
		           and alc.acc_year = #{acc_year,jdbcType=VARCHAR}
		           and alc.acc_month = '00'
		           and alc.subj_code = #{subj_code,jdbcType=VARCHAR} 
		           and aci.check_type_id = #{check_type_id,jdbcType=INTEGER} 
		),d_check as (
		     select  avc.group_id,             
                   avc.hos_id,             
                   avc.copy_code,             
                   avc.acc_year,             
                   av.acc_month,             
                   avc.subj_code,             
                   aci.check_type_id,             
                   sum(nvl(avc.debit,0)) as debit,             
                   sum(nvl(avc.credit,0)) as credit ,    
                   aci.check_item_id   
           from acc_vouch_check avc                     
           left join acc_check_item aci on aci.group_id = avc.group_id            
           	     and aci.hos_id = avc.hos_id            
                 and aci.copy_code = avc.copy_code
		         <if test="whereSql != null and whereSql !='' ">
		          	${whereSql}
		          </if> 
		     left join acc_vouch_detail avd on avc.group_id = avd.group_id
		         and avc.hos_id = avd.hos_id
		         and avc.copy_code = avd.copy_code
		         and avc.acc_year = avd.acc_year
		         and avc.vouch_detail_id = avd.vouch_detail_id
		         and avc.subj_code = avd.subj_code
		    left join acc_vouch av on av.group_id = avd.group_id
		         and av.hos_id = avd.hos_id
		         and av.copy_code = avd.copy_code
		         and av.acc_year = avd.acc_year
		         and av.vouch_id = avd.vouch_id
		     where avc.group_id = #{group_id,jdbcType=INTEGER} 
		         and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
		         and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
		         and av.acc_year = #{acc_year,jdbcType=VARCHAR}
		         and av.acc_month = #{acc_month,jdbcType=VARCHAR}
		         and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
		         and aci.check_type_id = #{check_type_id,jdbcType=INTEGER} 
		         ${state}
		     group by avc.group_id,avc.hos_id,avc.copy_code,avc.acc_year,av.acc_month,avc.subj_code,aci.check_type_id,aci.check_item_id
		)
		   select 
		     l_check.group_id,
		     l_check.hos_id,
		     l_check.copy_code,
		     l_check.acc_year,
		     l_check.acc_month,
		     l_check.subj_code,
		     l_check.check_code,
		     l_check.check_name,
		     nvl(l_check.bal_os,0) bal_os,
		     nvl(l_check.this_od,0) + nvl(d_check.debit,0) as this_od,
		     nvl(l_check.sum_od,0) + nvl(d_check.debit,0) as sum_od,
		     nvl(l_check.this_oc,0) + nvl(d_check.credit,0) as this_oc,
		     nvl(l_check.sum_oc,0) + nvl(d_check.credit,0) as sum_oc,
		     nvl(l_check.balance,0) + nvl(d_check.debit,0) - nvl(d_check.credit,0) as balance,
		     l_check.subj_dire
		 from acc_check_item  a
    	 left join d_check d_check on a.group_id = d_check.group_id and a.hos_id = d_check.hos_id 
    	 	and a.copy_code = d_check.copy_code and a.check_item_id = d_check.check_item_id
    	 left join l_check l_check on  d_check.group_id = l_check.group_id and d_check.hos_id =l_check.hos_id 
    	 	and d_check.copy_code=l_check.copy_code and d_check.check_item_id=l_check.check_item_id
		 <where>
		 	<if test="group_id != null and group_id !=''">
		 		and a.group_id = #{group_id,jdbcType=INTEGER} 
		 	</if>
		 	<if test="hos_id != null and hos_id !=''">
		 		and a.hos_id = #{hos_id,jdbcType=INTEGER} 
		 	</if>
		 	<if test="copy_code != null and copy_code !=''">
		 		and a.copy_code = #{copy_code,jdbcType=VARCHAR} 
		 	</if>
		 	<if test="showItem == '1' or showItem == 1">
				and l_check.balance + d_check.debit - d_check.credit > 0
			</if>
			and d_check.check_type_id is not null  
		 </where>		
		 order by l_check.group_id,l_check.hos_id,l_check.copy_code,l_check.acc_year,l_check.acc_month,l_check.check_code
	</select>
	
	<!-- 往来查询   明细账查询  -->
	
	<select id="queryAccDetailAccount" statementType="CALLABLE" parameterType="java.util.Map" resultType="java.util.Map">
		<![CDATA[
		{call PRC_ACC_VERI_DETAILQUERY(
			#{group_id,jdbcType=INTEGER, mode=IN},  
	        #{hos_id,jdbcType=INTEGER, mode=IN},  
	        #{copy_code,jdbcType=VARCHAR, mode=IN}, 
	        #{acc_year,jdbcType=VARCHAR, mode=IN}, 
	        #{subj_code,jdbcType=VARCHAR, mode=IN}, 
	        #{acc_year_b,jdbcType=VARCHAR, mode=IN},
	        #{acc_month_b,jdbcType=VARCHAR, mode=IN},
	        #{acc_year_e,jdbcType=VARCHAR, mode=IN},
	        #{acc_month_e,jdbcType=VARCHAR, mode=IN},
	        #{check_type,jdbcType=VARCHAR, mode=IN},
	        #{check_type_id,jdbcType=INTEGER, mode=IN},
	        #{vouch_no1,jdbcType=VARCHAR, mode=IN},
	        #{vouch_no2,jdbcType=VARCHAR, mode=IN},
	        #{zcheckName,jdbcType=VARCHAR, mode=IN},
	        #{proj1,jdbcType=VARCHAR, mode=IN},
	        #{proj2,jdbcType=VARCHAR, mode=IN},
	        #{veriState,jdbcType=INTEGER, mode=IN},
	        #{is_check,jdbcType=INTEGER, mode=IN},
	        #{check_table,jdbcType=VARCHAR, mode=IN},
	        #{column_no,jdbcType=VARCHAR, mode=IN},
	        #{column_id,jdbcType=VARCHAR, mode=IN},
	        #{column_code,jdbcType=VARCHAR, mode=IN},
	        #{column_name,jdbcType=VARCHAR, mode=IN},
	        #{column_check,jdbcType=VARCHAR, mode=IN},
	        #{is_change,jdbcType=INTEGER, mode=IN},
	        #{pagesize,jdbcType=INTEGER},
			#{page,jdbcType=INTEGER},
			#{tcount,mode=OUT,jdbcType=INTEGER},
			#{rst,jdbcType=CURSOR,mode=OUT,resultMap=com.chd.hrp.acc.dao.verification.AccNostroMapper.accAutoMap,javaType=java.sql.ResultSet})}
		]]>
	</select>
	
	<!-- 往来查询  核销清册查询  -->
	<select id="queryAccVerificationDetail" parameterType="java.util.Map" resultMap="accVouchCheckTest">
	  with detail_table as (
		select DISTINCT 
			avc.group_id,
			avc.hos_id,
			avc.copy_code,
			avc.vouch_check_id as check_id, 
			to_char(av.vouch_date, 'yyyy') as acc_year, 
			to_char(av.vouch_date, 'mm') as acc_month, 
			to_char(av.vouch_date, 'dd') as acc_day, 
			substr(avt.vouch_type_name, 0, 1) || '-' || av.vouch_no as vouch_no,
			<if test="colName !=null and colName !='' ">
		    	${colName}
		    </if>
		    <if test="colName ==null or colName =='' ">
		    	'' as check_code,
				'' as check_name,
		    </if>
			avc.summary, 
			avc.con_no, 
			avc.business_no ,
			case when nvl(avc.bal_amt,0)-nvl(avc.debit,0)-nvl(avc.credit,0)=0  then '已核销'
            	else 
            		case when nvl(avc.bal_amt,0) = 0 then '未核销'
                    else ''
                end
            end as state, 
     		to_char(avc.occur_date,'yyyy-mm-dd') as occur_date, 
     		to_char(avc.due_date,'yyyy-mm-dd') as due_date, 
     		nvl(avc.debit, 0) as debit, 
     		nvl(avc.credit, 0) as credit , 
     		nvl(avc.bal_amt, 0) as ybal_amt, 
     		(nvl(avc.debit, 0) +nvl(avc.credit, 0)) - nvl(avc.bal_amt, 0) as wbal_amt,
     		1 as id,
     		case when nvl(avc.debit,0) = 0 then 1 else 0 end subj_dire,
     		av.vouch_no as vouch_nos,
     		avc.vouch_id as vouch_id
		from acc_vouch_check avc
		<if test="whereSql !=null and whereSql !='' ">
			${whereSql}
		</if>
		left join acc_vouch_detail  avd on avc.group_id = avd.group_id 
		  	and avc.hos_id = avd.hos_id 
		  	and avc.copy_code = avd.copy_code 
		  	and avc.acc_year = avd.acc_year
		  	and avc.vouch_id = avd.vouch_id 
		  	and avc.vouch_detail_id = avd.vouch_detail_id 
		left join acc_vouch  av on av.group_id = avd.group_id
			and av.hos_id = avd.hos_id 
		  	and av.copy_code = avd.copy_code 
		  	and av.acc_year = avd.acc_year
		  	and av.vouch_id = avd.vouch_id
		left join acc_vouch_type  avt on avt.group_id = av.group_id
			and avt.hos_id = av.hos_id 
		  	and avt.copy_code = av.copy_code 
		  	and avt.vouch_type_code = av.vouch_type_code
		
		where avc.group_id = #{group_id,jdbcType=INTEGER}  
			and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
			and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
			and avc.acc_year = #{acc_year,jdbcType=VARCHAR}
			
			<if test="veriState ==2 ">
	        	and (nvl(avc.debit,0)+nvl(avc.credit,0)-nvl(avc.bal_amt,0)) = 0
	        </if>
	        <if test="veriState == 1 ">
	        	and (nvl(avc.debit,0)+nvl(avc.credit,0)-nvl(avc.bal_amt,0)) != 0
	        </if>
            <if test="subj_code != null and subj_code != ''">
            	and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
            </if>
            <if test="acc_year_b != null and acc_year_b != '' and acc_year_e != null and acc_year_e != ''">
            	and av.acc_year  between #{acc_year_b,jdbcType=VARCHAR} and #{acc_year_e,jdbcType=VARCHAR}
            </if>
            <if test="acc_month_b != null and acc_month_b != '' and acc_month_e != null and acc_month_e != ''">
            	and av.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
            </if>
			<if test="vouch_no1 != null and vouch_no1 != '' and vouch_no2 != null and vouch_no2 != ''">
            	and av.vouch_no between #{vouch_no1,jdbcType=VARCHAR} and #{vouch_no2,jdbcType=VARCHAR}
            </if>
			 ${state}
          ORDER BY acc_month
	   ),month_table as (
		SELECT 
			t.group_id,
			t.hos_id,
			t.copy_code,
			0 as check_id, 
			t.acc_year, 
			t.acc_month, 
			'' as acc_day, 
			'' as vouch_no, 
			'' as check_code, 
			'本月合计' as check_name, 
			'本月合计' as summary, 
			'' as con_no, 
			'' as  business_no, 
			'' as state, 
         	'' as occur_date, 
         	'' as due_date, 
         	sum(t.debit) as debit, 
         	sum(t.credit) as credit, 
         	sum(t.ybal_amt) as ybal_amt, 
         	sum(t.wbal_amt) as wbal_amt,
         	2 as id,
         	0 as subj_dire,
         	vouch_nos,
         	veri_check_id
    		from (
    			select  
    				avc.group_id,
    				avc.hos_id,
    				avc.copy_code,
    				av.acc_year as acc_year, 
    				av.acc_month as acc_month,
          			nvl(avc.debit, 0) as debit, 
          			nvl(avc.credit, 0) as credit,
          			nvl(avc.bal_amt, 0) as ybal_amt,
          			(nvl(avc.debit,0)+nvl(avc.credit,0))-(nvl(avc.bal_amt,0)) AS wbal_amt,
          			'999999999999' vouch_nos,
          			0 veri_check_id
          		FROM acc_vouch_check avc
          		<if test="whereSql !=null and whereSql !='' ">
					${whereSql}
				</if>
				left join acc_vouch_detail  avd on avc.group_id = avd.group_id 
				  	and avc.hos_id = avd.hos_id 
				  	and avc.copy_code = avd.copy_code 
				  	and avc.acc_year = avd.acc_year
				  	and avc.vouch_id = avd.vouch_id 
				  	and avc.vouch_detail_id = avd.vouch_detail_id
				left join acc_vouch  av on av.group_id = avd.group_id 
					and av.hos_id = avd.hos_id  
				  	and av.copy_code = avd.copy_code 
				  	and av.acc_year = avd.acc_year
				  	and av.vouch_id = avd.vouch_id
				
				where   avc.group_id = #{group_id,jdbcType=INTEGER} 
					and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
					and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
					and avc.acc_year = #{acc_year,jdbcType=VARCHAR} 
					<if test="veriState ==2 ">
			        	and (nvl(avc.debit,0)+nvl(avc.credit,0)-nvl(avc.bal_amt,0)) = 0
			        </if>
			        <if test="veriState == 1 ">
			        	and (nvl(avc.debit,0)+nvl(avc.credit,0)-nvl(avc.bal_amt,0)) != 0
			        </if> 
		            <if test="subj_code != null and subj_code != ''">
		            	and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
		            </if>
		            <if test="acc_year_b != null and acc_year_b != '' and acc_year_e != null and acc_year_e != ''">
		            	and av.acc_year  between #{acc_year_b,jdbcType=VARCHAR} and #{acc_year_e,jdbcType=VARCHAR}
		            </if>
		            <if test="acc_month_b != null and acc_month_b != '' and acc_month_e != null and acc_month_e != ''">
		            	and av.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
		            </if>
					<if test="vouch_no1 != null and vouch_no1 != '' and vouch_no2 != null and vouch_no2 != ''">
		            	and av.vouch_no between #{vouch_no1,jdbcType=VARCHAR} and #{vouch_no2,jdbcType=VARCHAR}
		            </if>
			 		${state}
    		   )t  group by t.group_id,t.hos_id,t.copy_code,t.acc_year,t.acc_month,t.vouch_nos,t.veri_check_id
    		   
		),sum_table as(
			SELECT  
				t.group_id,
				t.hos_id,
				t.copy_code,
				0 as check_id, 
				t.acc_year, 
				'99' as acc_month,
				'' as acc_day, 
				'' as vouch_no, 
				'' as check_code, 
				'总合计' AS check_name, 
				'总合计' as summary, 
				'' as con_no, 
				'' as  business_no, 
				'' as state, 
         		'' as occur_date, 
         		'' as due_date, 
         		sum(t.debit) as debit, 
         		sum(t.credit) as credit, 
         		sum(t.ybal_amt) as ybal_amt, 
         		sum(t.wbal_amt) as wbal_amt,
         		3 as id, 
         		0 as subj_dire,
         		vouch_nos,
         		veri_check_id
			    from (
			    	select  
			    		avc.group_id,
			    		avc.hos_id,
			    		avc.copy_code,
			    		avc.acc_year AS acc_year, 
			    		av.acc_month AS acc_month,
          				nvl(avc.debit, 0) AS debit, 
          				nvl(avc.credit, 0) AS credit,
          				nvl(avc.bal_amt, 0) AS ybal_amt,
          				(nvl(avc.debit,0)+nvl(avc.credit,0))-(nvl(avc.bal_amt,0)) AS wbal_amt,
          				'999999999999' vouch_nos,
          				0 veri_check_id
          			FROM acc_vouch_check avc
          			<if test="whereSql !=null and whereSql !='' ">
						${whereSql}
					</if>
					left join acc_vouch_detail  avd on avc.group_id = avd.group_id 
					  	and avc.hos_id = avd.hos_id 
					  	and avc.copy_code = avd.copy_code 
					  	and avc.acc_year = avd.acc_year 
					  	and avc.vouch_id = avd.vouch_id 
					  	and avc.vouch_detail_id = avd.vouch_detail_id
					left join acc_vouch  av on av.group_id = avd.group_id
						and av.hos_id = avd.hos_id 
					  	and av.copy_code = avd.copy_code 
					  	and av.acc_year = avd.acc_year 
					  	and av.vouch_id = avd.vouch_id
					
					where avc.group_id = #{group_id,jdbcType=INTEGER}  
						and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
						and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
						and avc.acc_year = #{acc_year,jdbcType=VARCHAR} 
						<if test="veriState ==2 ">
				        	and (nvl(avc.debit,0)+nvl(avc.credit,0)-nvl(avc.bal_amt,0)) = 0
				        </if>
				        <if test="veriState == 1 ">
				        	and (nvl(avc.debit,0)+nvl(avc.credit,0)-nvl(avc.bal_amt,0)) != 0
				        </if>
			            <if test="subj_code != null and subj_code != ''">
			            	and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
			            </if>
			            <if test="acc_year_b != null and acc_year_b != '' and acc_year_e != null and acc_year_e != ''">
			            	and av.acc_year  between #{acc_year_b,jdbcType=VARCHAR} and #{acc_year_e,jdbcType=VARCHAR}
			            </if>
			            <if test="acc_month_b != null and acc_month_b != '' and acc_month_e != null and acc_month_e != ''">
			            	and av.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
			            </if>
						<if test="vouch_no1 != null and vouch_no1 != '' and vouch_no2 != null and vouch_no2 != ''">
			            	and av.vouch_no between #{vouch_no1,jdbcType=VARCHAR} and #{vouch_no2,jdbcType=VARCHAR}
			            </if>
				 		${state}
			    )t group by t.group_id,t.hos_id,t.copy_code,t.acc_year,t.vouch_nos,t.veri_check_id
			)
			select  
				t.group_id,
				t.hos_id,
				t.copy_code,
				t.check_id,
				t.acc_year,
				t.acc_month, 
				t.acc_day, 
				t.vouch_no,
				t.check_code, 
				t.check_name, 
				t.summary, 
				t.con_no,
				t.business_no, 
				t.state,
				t.occur_date,
				t.due_date,
				t.debit,
				t.credit, 
				t.ybal_amt,
				t.wbal_amt ,
				subj_dire,
				vouch_id
			from (
		       select id,group_id,hos_id,copy_code,check_id,acc_year,acc_month,acc_day,vouch_no,check_code,check_name,summary,con_no,business_no,
		       		state,occur_date,due_date, debit,credit,ybal_amt,wbal_amt,subj_dire,vouch_nos,vouch_id
		       from detail_table  where detail_table.check_code is not null
		       union  
		       select id,group_id,hos_id,copy_code,check_id,acc_year,acc_month,acc_day,vouch_no,check_code,check_name,summary,con_no,business_no,
		       		state,occur_date,due_date,debit,credit,ybal_amt,wbal_amt ,subj_dire,vouch_nos,0 vouch_id
		       from month_table
		       union 
		       select id,group_id,hos_id,copy_code,check_id,acc_year,acc_month,acc_day,vouch_no,check_code,check_name,summary,con_no,business_no,
		       		state,occur_date,due_date,debit,credit,ybal_amt,wbal_amt ,subj_dire,vouch_nos,0 vouch_id
		       from sum_table
			)  t 
			order by group_id, hos_id, copy_code, acc_year, acc_month,acc_day, t.id, t.check_code asc, t.vouch_nos desc
		
	</select>
	
	<!-- 往来查询 核销清册查询 自定义 -->
	<select id="queryAccVerificationDetailZ" parameterType="java.util.Map" resultMap="accVouchCheckTest">
	  with detail_table as (
		select DISTINCT 
			avc.group_id,
			avc.hos_id,
			avc.copy_code,
			avc.vouch_check_id as check_id, 
			to_char(av.vouch_date, 'yyyy') as acc_year, 
			to_char(av.vouch_date, 'mm') as acc_month, 
			to_char(av.vouch_date, 'dd') as acc_day, 
			substr(avt.vouch_type_name, 0, 1) || '-' || av.vouch_no as vouch_no,
			aci.check_item_code as check_code,
			aci.check_item_name as check_name,
			avc.summary, 
			avc.con_no, 
			avc.business_no ,
			case when nvl(avv.veri_money,0)-nvl(avc.debit,0)-nvl(avc.credit,0)=0  then '已核销'
            	else 
            		case when nvl(avv.veri_money,0)=0 then '未核销'
                    else ''
                end
            end as state, 
     		to_char(avc.occur_date,'yyyy-mm-dd') as occur_date, 
     		to_char(avc.due_date,'yyyy-mm-dd') as due_date, 
     		nvl(avc.debit, 0) as debit, 
     		nvl(avc.credit, 0) as credit , 
     		nvl(avv.veri_money, 0) as ybal_amt, 
     		abs(nvl(avc.debit, 0) - nvl(avc.credit, 0)) - nvl(avv.veri_money, 0) as wbal_amt,
     		1 as id,
     		case when nvl(avc.debit,0) = 0 then 1 else 0 end subj_dire,
     		av.vouch_no as vouch_nos,
     		avv.veri_check_id as veri_check_id
		from acc_vouch_check avc
		left join acc_check_item aci on aci.group_id = avc.group_id            
        	and aci.hos_id = avc.hos_id            
        	and aci.copy_code = avc.copy_code
		<if test="whereSql != null and whereSql !='' ">
			${whereSql}
		</if>
		left join acc_vouch_detail  avd on avc.group_id = avc.group_id 
		  	and avc.hos_id = avd.hos_id 
		  	and avc.copy_code = avd.copy_code 
		  	and avc.acc_year = avd.acc_year
		  	and avc.vouch_id = avd.vouch_id 
		  	and avc.vouch_detail_id	= avd.vouch_detail_id 
		left join acc_vouch  av on av.group_id = avd.group_id
			and av.hos_id = avd.hos_id 
		  	and av.copy_code = avd.copy_code 
		  	and av.acc_year = avd.acc_year
		  	and av.vouch_id = avd.vouch_id
		left join acc_vouch_type  avt on avt.group_id = av.group_id
			and avt.hos_id = av.hos_id 
		  	and avt.copy_code = av.copy_code 
		  	and avt.vouch_type_code = av.vouch_type_code
		left join (
             select check_id,group_id,hos_id,copy_code,acc_year,veri_money ,veri_check_id from (
                  select credit_check_id as check_id,group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money ,veri_check_id 
                  from acc_vouch_veri 
                  where  group_id = #{group_id,jdbcType=INTEGER}  
                  	and hos_id = #{hos_id,jdbcType=INTEGER}  
                  	and copy_code = #{copy_code,jdbcType=VARCHAR} 
                  	and acc_year = #{acc_year,jdbcType=VARCHAR} 
                  	and nvl(credit_check_id,0) != 0 
                  union
                  select debit_check_id as check_id, group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money ,veri_check_id
                  from acc_vouch_veri 
                  where group_id = #{group_id,jdbcType=INTEGER}  
                  	and hos_id = #{hos_id,jdbcType=INTEGER}  
                  	and copy_code = #{copy_code,jdbcType=VARCHAR} 
                  	and acc_year = #{acc_year,jdbcType=VARCHAR} 
                  	and nvl(debit_check_id,0) != 0
             ) aa  
        ) avv on avv.group_id = avc.group_id 
        	and avv.hos_id = avc.hos_id 
        	and avv.copy_code = avc.copy_code  
        	and avv.acc_year = avc.acc_year 
        	and avv.check_id = avc.vouch_check_id
		where avc.group_id = #{group_id,jdbcType=INTEGER}  
			and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
			and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
			and avc.acc_year = #{acc_year,jdbcType=VARCHAR}
			and aci.check_type_id = #{check_type_id,jdbcType=INTEGER} 
			<if test="veriState ==2 ">
	        	and nvl(avv.veri_money,0) != 0
	        </if>
	        <if test="veriState == 1 ">
	        	and nvl(avv.veri_money,0) = 0
	        </if>
            <if test="subj_code != null and subj_code != ''">
            	and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
            </if>
            <if test="acc_year_b != null and acc_year_b != '' and acc_year_e != null and acc_year_e != ''">
            	and av.acc_year  between #{acc_year_b,jdbcType=VARCHAR} and #{acc_year_e,jdbcType=VARCHAR}
            </if>
            <if test="acc_month_b != null and acc_month_b != '' and acc_month_e != null and acc_month_e != ''">
            	and av.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
            </if>
			<if test="vouch_no1 != null and vouch_no1 != '' and vouch_no2 != null and vouch_no2 != ''">
            	and av.vouch_no between #{vouch_no1,jdbcType=VARCHAR} and #{vouch_no2,jdbcType=VARCHAR}
            </if>
			 ${state}
          ORDER BY acc_month
	   ),month_table as (
		SELECT 
			t.group_id,
			t.hos_id,
			t.copy_code,
			0 as check_id, 
			t.acc_year, 
			t.acc_month, 
			'' as acc_day, 
			'' as vouch_no, 
			'' as check_code, 
			'本月合计' as check_name, 
			'本月合计' as summary, 
			'' as con_no, 
			'' as  business_no, 
			'' as state, 
         	'' as occur_date, 
         	'' as due_date, 
         	sum(t.debit) as debit, 
         	sum(t.credit) as credit, 
         	sum(t.ybal_amt) as ybal_amt, 
         	sum(t.wbal_amt) as wbal_amt,
         	2 as id,
         	0 as subj_dire,
         	vouch_nos,
         	veri_check_id
    		from (
    			select  
    				avc.group_id,
    				avc.hos_id,
    				avc.copy_code,
    				av.acc_year as acc_year, 
    				av.acc_month as acc_month,
          			nvl(avc.debit, 0) as debit, 
          			nvl(avc.credit, 0) as credit,
          			nvl(avv.veri_money, 0) as ybal_amt,
          			abs(nvl(avc.debit,0)-nvl(avc.credit,0))-nvl(avv.veri_money,0) AS wbal_amt,
          			'999999999999' vouch_nos,
          			0 veri_check_id
          		FROM acc_vouch_check avc
          		left join acc_check_item aci on aci.group_id = avc.group_id            
		        	and aci.hos_id = avc.hos_id            
		        	and aci.copy_code = avc.copy_code
				<if test="whereSql != null and whereSql !='' ">
					${whereSql}
				</if>				
				left join acc_vouch_detail  avd on avc.group_id = avd.group_id 
				  	and avc.hos_id = avd.hos_id 
				  	and avc.copy_code = avd.copy_code 
				  	and avc.acc_year = avd.acc_year
				  	and avc.vouch_id = avd.vouch_id 
				  	and avc.vouch_detail_id = avd.vouch_detail_id
				left join acc_vouch  av on av.group_id = avd.group_id 
					and av.hos_id = avd.hos_id  
				  	and av.copy_code = avd.copy_code 
				  	and av.acc_year = avd.acc_year
				  	and av.vouch_id = avd.vouch_id
				left join (
		             select check_id,group_id,hos_id,copy_code,acc_year,veri_money from (
		                  select credit_check_id as check_id,group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money
		                  from acc_vouch_veri 
		                  where  group_id = #{group_id,jdbcType=INTEGER}  
		                  	and  hos_id = #{hos_id,jdbcType=INTEGER}  
		                  	and  copy_code = #{copy_code,jdbcType=VARCHAR} 
		                  	and  acc_year = #{acc_year,jdbcType=VARCHAR} 
		                  	and  nvl(credit_check_id,0) != 0 
		                  union
		                  select debit_check_id as check_id, group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money
		                  from acc_vouch_veri 
		                  where group_id = #{group_id,jdbcType=INTEGER}  
		                  	and hos_id = #{hos_id,jdbcType=INTEGER}  
		                  	and copy_code = #{copy_code,jdbcType=VARCHAR} 
		                  	and acc_year = #{acc_year,jdbcType=VARCHAR} 
		                  	and nvl(debit_check_id,0) != 0
		             ) aa 
		        ) avv on avv.group_id = avc.group_id 
		        	and avv.hos_id = avc.hos_id 
		        	and avv.copy_code = avc.copy_code  
		        	and avv.acc_year = avc.acc_year 
		        	and avv.check_id = avc.vouch_check_id
				where   avc.group_id = #{group_id,jdbcType=INTEGER} 
					and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
					and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
					and avc.acc_year = #{acc_year,jdbcType=VARCHAR} 
					and aci.check_type_id = #{check_type_id,jdbcType=INTEGER} 
					<if test="veriState ==2 ">
			        	and nvl(avv.veri_money,0) != 0
			        </if>
			        <if test="veriState == 1 ">
			        	and nvl(avv.veri_money,0) = 0
			        </if> 
		            <if test="subj_code != null and subj_code != ''">
		            	and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
		            </if>
		            <if test="acc_year_b != null and acc_year_b != '' and acc_year_e != null and acc_year_e != ''">
		            	and av.acc_year  between #{acc_year_b,jdbcType=VARCHAR} and #{acc_year_e,jdbcType=VARCHAR}
		            </if>
		            <if test="acc_month_b != null and acc_month_b != '' and acc_month_e != null and acc_month_e != ''">
		            	and av.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
		            </if>
					<if test="vouch_no1 != null and vouch_no1 != '' and vouch_no2 != null and vouch_no2 != ''">
		            	and av.vouch_no between #{vouch_no1,jdbcType=VARCHAR} and #{vouch_no2,jdbcType=VARCHAR}
		            </if>
			 		${state}
    		   )t  group by t.group_id,t.hos_id,t.copy_code,t.acc_year,t.acc_month,t.vouch_nos,t.veri_check_id
    		   
		),sum_table as(
			SELECT  
				t.group_id,
				t.hos_id,
				t.copy_code,
				0 as check_id, 
				t.acc_year, 
				'99' as acc_month,
				'' as acc_day, 
				'' as vouch_no, 
				'' as check_code, 
				'总合计' AS check_name, 
				'总合计' as summary, 
				'' as con_no, 
				'' as  business_no, 
				'' as state, 
         		'' as occur_date, 
         		'' as due_date, 
         		sum(t.debit) as debit, 
         		sum(t.credit) as credit, 
         		sum(t.ybal_amt) as ybal_amt, 
         		sum(t.wbal_amt) as wbal_amt,
         		3 as id, 
         		0 as subj_dire,
         		vouch_nos,
         		veri_check_id
			    from (
			    	select  
			    		avc.group_id,
			    		avc.hos_id,
			    		avc.copy_code,
			    		avc.acc_year AS acc_year, 
			    		av.acc_month AS acc_month,
          				nvl(avc.debit, 0) AS debit, 
          				nvl(avc.credit, 0) AS credit,
          				nvl(avv.veri_money, 0) AS ybal_amt,
          				abs(nvl(avc.debit,0)-nvl(avc.credit,0))-nvl(avv.veri_money,0) AS wbal_amt,
          				'999999999999' vouch_nos,
          				0 veri_check_id
          			FROM acc_vouch_check avc
          			left join acc_check_item aci on aci.group_id = avc.group_id            
			        	and aci.hos_id = avc.hos_id            
			        	and aci.copy_code = avc.copy_code
					<if test="whereSql != null and whereSql !='' ">
						${whereSql}
					</if>
					left join acc_vouch_detail  avd on avc.group_id = avd.group_id 
					  	and avc.hos_id = avd.hos_id 
					  	and avc.copy_code = avd.copy_code 
					  	and avc.acc_year = avd.acc_year 
					  	and avc.vouch_id = avd.vouch_id 
					  	and avc.vouch_detail_id = avd.vouch_detail_id
					left join acc_vouch  av on av.group_id = avd.group_id
						and av.hos_id = avd.hos_id 
					  	and av.copy_code = avd.copy_code 
					  	and av.acc_year = avd.acc_year 
					  	and av.vouch_id = avd.vouch_id
					left join (
			             select check_id,group_id,hos_id,copy_code,acc_year,veri_money from (
			                  select credit_check_id as check_id,group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money 
			                  from acc_vouch_veri 
			                  where  group_id = #{group_id,jdbcType=INTEGER}  
			                  	and  hos_id = #{hos_id,jdbcType=INTEGER}  
			                  	and  copy_code = #{copy_code,jdbcType=VARCHAR} 
			                  	and  acc_year = #{acc_year,jdbcType=VARCHAR} 
			                  	and  nvl(credit_check_id,0) != 0 
			                  union
			                  select debit_check_id as check_id, group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money 
			                  from acc_vouch_veri 
			                  where group_id = #{group_id,jdbcType=INTEGER}  
			                  	and hos_id = #{hos_id,jdbcType=INTEGER}  
			                  	and copy_code = #{copy_code,jdbcType=VARCHAR} 
			                  	and acc_year = #{acc_year,jdbcType=VARCHAR} 
			                  	and nvl(debit_check_id,0) != 0
			             ) aa 
			        ) avv on avv.group_id = avc.group_id 
			        	and avv.hos_id = avc.hos_id 
			        	and avv.copy_code = avc.copy_code  
			        	and avv.acc_year = avc.acc_year 
			        	and avv.check_id = avc.vouch_check_id
					where avc.group_id = #{group_id,jdbcType=INTEGER}  
						and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
						and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
						and avc.acc_year = #{acc_year,jdbcType=VARCHAR} 
						and aci.check_type_id = #{check_type_id,jdbcType=INTEGER} 
						<if test="veriState ==2 ">
				        	and nvl(avv.veri_money,0) != 0
				        </if>
				        <if test="veriState == 1 ">
				        	and nvl(avv.veri_money,0) = 0
				        </if>
			            <if test="subj_code != null and subj_code != ''">
			            	and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
			            </if>
			            <if test="acc_year_b != null and acc_year_b != '' and acc_year_e != null and acc_year_e != ''">
			            	and av.acc_year  between #{acc_year_b,jdbcType=VARCHAR} and #{acc_year_e,jdbcType=VARCHAR}
			            </if>
			            <if test="acc_month_b != null and acc_month_b != '' and acc_month_e != null and acc_month_e != ''">
			            	and av.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
			            </if>
						<if test="vouch_no1 != null and vouch_no1 != '' and vouch_no2 != null and vouch_no2 != ''">
			            	and av.vouch_no between #{vouch_no1,jdbcType=VARCHAR} and #{vouch_no2,jdbcType=VARCHAR}
			            </if>
				 		${state}
			    )t group by t.group_id,t.hos_id,t.copy_code,t.acc_year,t.vouch_nos,t.veri_check_id
			)
			select  
				t.group_id,
				t.hos_id,
				t.copy_code,
				t.check_id,
				t.acc_year,
				t.acc_month, 
				t.acc_day, 
				t.vouch_no,
				t.check_code, 
				t.check_name, 
				t.summary, 
				t.con_no,
				t.business_no, 
				t.state,
				t.occur_date,
				t.due_date,
				t.debit,
				t.credit,
				t.ybal_amt,
				t.wbal_amt ,
				subj_dire,
				veri_check_id
			from (
		       select id,group_id,hos_id,copy_code,check_id,acc_year,acc_month,acc_day,vouch_no,check_code,check_name,summary,con_no,business_no,
		       		state,occur_date,due_date, debit,credit,ybal_amt,wbal_amt,subj_dire,vouch_nos,veri_check_id
		       from detail_table 
		       union  
		       select id,group_id,hos_id,copy_code,check_id,acc_year,acc_month,acc_day,vouch_no,check_code,check_name,summary,con_no,business_no,
		       		state,occur_date,due_date,debit,credit,ybal_amt,wbal_amt ,subj_dire,vouch_nos,veri_check_id
		       from month_table
		       union 
		       select id,group_id,hos_id,copy_code,check_id,acc_year,acc_month,acc_day,vouch_no,check_code,check_name,summary,con_no,business_no,
		       		state,occur_date,due_date,debit,credit,ybal_amt,wbal_amt ,subj_dire,vouch_nos,veri_check_id
		       from sum_table
			)  t order by group_id,hos_id,copy_code,acc_year,acc_month,t.id,t.check_code,t.vouch_nos
		
	</select>
	
	
	
	<!-- 往来查询  个人往来催款单查询  -->
	<select id="queryContactsReminderDetail" parameterType="java.util.Map" resultMap="accVouchCheckTest">
	 with detail_table as ( 
		select 
			1 as idx,
			a.group_id as group_id,
			a.hos_id as hos_id,
			a.copy_code as copy_code,
			a.acc_year as acc_year,
			a.vouch_check_id as check_id,
			hd.dept_name as dept_name,
			b.emp_code as emp_code,
			b.emp_name as emp_name,
			to_char(av.vouch_date,'yyyy-mm-dd') as vouch_date,
  			substr(f.vouch_type_name,0,1)||'-'|| av.vouch_no as vouch_no,
  			a.summary,
  			nvl(a.debit,0) as debit,
  			nvl(avv.veri_money,0) as ybal_amt,
  			case when nvl(avv.veri_money,0)-nvl(a.debit,0)=0  then '已核销'
            	else case  when nvl(avv.veri_money,0)=0 then '未核销'
                	else ''
                end
            end as state,
            av.vouch_no as vouch_nos
 			from acc_vouch_check a
		    left join hos_emp_dict b on a.group_id = b.group_id  
		      	and a.hos_id = b.hos_id
		      	and a.check2_id = b.emp_id
		      	<if test="show_history == 1">
					and a.check2_no = b.emp_no 
				</if>
				<if test="show_history == 0">
					and b.is_stop = 0
				</if>
		    left join hos_dept_dict hd on hd.group_id = b.group_id 
		    	and hd.hos_id = b.hos_id
		        and hd.dept_id = b.dept_id
		    	<if test="show_history == 1">
					and hd.dept_no = b.dept_no
				</if>
				<if test="show_history == 0">
					and hd.is_stop = 0
				</if>
		     left join acc_vouch_detail avd on a.group_id = avd.group_id 
		     	and a.hos_id = avd.hos_id 
		      	and a.copy_code = avd.copy_code 
		      	and a.acc_year = avd.acc_year
		      	and a.vouch_id = avd.vouch_id 
		      	and avd.vouch_detail_id = a.vouch_detail_id
		    left join acc_vouch av on av.group_id = avd.group_id 
		    	and av.hos_id = avd.hos_id 
		      	and av.copy_code = avd.copy_code 
		      	and av.acc_year = avd.acc_year
		      	and av.vouch_id = avd.vouch_id
			left join acc_vouch_type  f on f.group_id = av.group_id
			  	and f.copy_code = av.copy_code 
			  	and f.hos_id = av.hos_id 
			  	and f.vouch_type_code=av.vouch_type_code
			  	and f.is_stop = 0
			left join (
				select check_id,group_id,hos_id,copy_code,acc_year,sum(veri_money) as veri_money from (
			    	select credit_check_id as check_id,group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money  
			    	from acc_vouch_veri 
			    	where  group_id = #{group_id,jdbcType=INTEGER}  
			        	and  hos_id = #{hos_id,jdbcType=INTEGER}  
			        	and  copy_code = #{copy_code,jdbcType=VARCHAR} 
			        	and  acc_year = #{acc_year,jdbcType=VARCHAR} 
			        	and  nvl(credit_check_id,0) != 0 
			        union
			        select debit_check_id as check_id, group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money 
			        from acc_vouch_veri 
			        where group_id = #{group_id,jdbcType=INTEGER}  
			        	and hos_id = #{hos_id,jdbcType=INTEGER}  
			       		and copy_code = #{copy_code,jdbcType=VARCHAR} 
			        	and acc_year = #{acc_year,jdbcType=VARCHAR} 
			        	and nvl(debit_check_id,0) != 0
			     ) aa  group by check_id,group_id,hos_id,copy_code,acc_year
			 ) avv on avv.group_id = a.group_id 
			 	and avv.hos_id = a.hos_id 
				and avv.copy_code = a.copy_code  
				and avv.acc_year = a.acc_year 
				and avv.check_id = a.vouch_check_id
		    where  a.group_id = #{group_id,jdbcType=INTEGER}  
			 	and a.hos_id = #{hos_id,jdbcType=INTEGER} 
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				and a.subj_code = #{subj_code,jdbcType=VARCHAR} 
				<if test="veriState ==2 ">
		        	and nvl(avv.veri_money,0) != 0
		        </if>
		        <if test="veriState == 1 ">
		        	and nvl(avv.veri_money,0) = 0
		        </if>
				<if test="dept_id != null and dept_id != ''">
					and b.dept_id = #{dept_id,jdbcType=INTEGER}
				</if>
				<if test="dept_no != null and dept_no != ''">
					and b.dept_no = #{dept_no,jdbcType=INTEGER}
				</if>
				<if test="emp_id != null and emp_id != ''">
					and b.emp_id = #{emp_id,jdbcType=INTEGER}
				</if>
				<if test="emp_no != null and emp_no != ''">
					and b.emp_no = #{emp_no,jdbcType=INTEGER}
				</if>
				and a.due_date = to_date(#{due_date},'yyyy/mm/dd') 
				${state}
				and hd.dept_id is not null
		      	and hd.dept_no is not null
		      order by b.emp_code,av.vouch_no
		),sum_table as(
			SELECT 
				2 as idx,
				a.group_id as group_id,
				a.hos_id as hos_id,
				a.copy_code as copy_code,
				a.acc_year as acc_year,
				0 as check_id,
				'' AS dept_name, 
				b.emp_code AS emp_code, 
				b.emp_name AS emp_name, 
				'' AS vouch_date, 
				'' AS vouch_no, 
				'' as summary, 
				sum(nvl(a.debit, 0)) AS debit, 
				sum(nvl(avv.veri_money, 0)) AS ybal_amt, 
				'' AS state,
				'99999999' vouch_nos
 			from acc_vouch_check a
		    left join hos_emp_dict b on a.group_id = b.group_id
		    	and a.hos_id = b.hos_id 
		      	and a.check2_id = b.emp_id  
		      	<if test="show_history == 1">
					and a.check2_no = b.emp_no 
				</if>
				<if test="show_history == 0">
					and b.is_stop = 0
				</if>
		    left join hos_dept_dict hd on hd.group_id = b.group_id
		       	and hd.hos_id = b.hos_id 
		       	and hd.dept_id = b.dept_id
		       	and hd.dept_id = b.dept_id
		    	<if test="show_history == 1">
					and hd.dept_no = b.dept_no
				</if>
				<if test="show_history == 0">
					and hd.is_stop = 0
				</if>
		     left join acc_vouch_detail avd on a.group_id = avd.group_id 
		      	and a.hos_id = avd.hos_id 
		      	and a.copy_code = avd.copy_code 
		      	and a.acc_year = avd.acc_year
		      	and a.vouch_id = avd.vouch_id 
		      	and a.vouch_detail_id = avd.vouch_detail_id
		    left join acc_vouch av on av.group_id = avd.group_id 
		      	and av.hos_id = avd.hos_id 
		      	and av.copy_code = avd.copy_code 
		      	and av.acc_year = avd.acc_year
		      	and av.vouch_id = avd.vouch_id
			left join acc_vouch_type  f on f.group_id = av.group_id
				and f.hos_id = av.hos_id
			  	and f.copy_code = av.copy_code 
			  	and f.vouch_type_code=av.vouch_type_code
			left join (
				select check_id,group_id,hos_id,copy_code,acc_year,sum(veri_money) as veri_money from (
			    	select credit_check_id as check_id,group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money  
			    	from acc_vouch_veri 
			    	where  group_id = #{group_id,jdbcType=INTEGER}  
			        	and  hos_id = #{hos_id,jdbcType=INTEGER}  
			        	and  copy_code = #{copy_code,jdbcType=VARCHAR} 
			        	and  acc_year = #{acc_year,jdbcType=VARCHAR} 
			        	and  nvl(credit_check_id,0) != 0 
			        union
			        select debit_check_id as check_id, group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money 
			        from acc_vouch_veri 
			        where group_id = #{group_id,jdbcType=INTEGER}  
			        	and hos_id = #{hos_id,jdbcType=INTEGER}  
			       		and copy_code = #{copy_code,jdbcType=VARCHAR} 
			        	and acc_year = #{acc_year,jdbcType=VARCHAR} 
			        	and nvl(debit_check_id,0) != 0
			     ) aa  group by check_id,group_id,hos_id,copy_code,acc_year
			 ) avv on avv.group_id = a.group_id 
			 	and avv.hos_id = a.hos_id 
				and avv.copy_code = a.copy_code  
				and avv.acc_year = a.acc_year 
				and avv.check_id = a.vouch_check_id
			 where  a.group_id = #{group_id,jdbcType=INTEGER}  
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.hos_id = #{hos_id,jdbcType=INTEGER} 
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				and a.subj_code = #{subj_code,jdbcType=VARCHAR} 
				<if test="veriState ==2 ">
		        	and nvl(avv.veri_money,0) != 0
		        </if>
		        <if test="veriState == 1 ">
		        	and nvl(avv.veri_money,0) = 0
		        </if>
				<if test="dept_id != null and dept_id != ''">
					and b.dept_id = #{dept_id,jdbcType=INTEGER}
				</if>
				<if test="emp_id != null and emp_id != ''">
					and b.emp_id = #{emp_id,jdbcType=INTEGER}
				</if>
				and a.due_date = to_date(#{due_date},'yyyy/mm/dd') 
				and hd.dept_id is not null
		      	and hd.dept_no is not null
				${state}
				group by a.group_id,a.hos_id,a.copy_code,a.acc_year,b.emp_code,b.emp_name
		),sumAll_table as(
			SELECT 
				3 as idx,
				a.group_id as group_id,
				a.hos_id as hos_id,
				a.copy_code as copy_code,
				a.acc_year as acc_year,
				0 as check_id,
				'' AS dept_name, 
				'' AS emp_code, 
				'' AS emp_name, 
				'' AS vouch_date, 
				'' AS vouch_no, 
				'' as summary, 
				sum(nvl(a.debit, 0)) AS debit, 
				sum(nvl(avv.veri_money, 0)) AS ybal_amt, 
				'' AS state,
				'99999999' vouch_nos
 			from acc_vouch_check a
		    left join hos_emp_dict b on a.group_id = b.group_id
		    	and a.hos_id = b.hos_id 
		      	and a.check2_id = b.emp_id  
		      	<if test="show_history == 1">
					and a.check2_no = b.emp_no 
				</if>
				<if test="show_history == 0">
					and b.is_stop = 0
				</if>
		    left join hos_dept_dict hd on hd.group_id = b.group_id
		       	and hd.hos_id = b.hos_id 
		       	and hd.dept_id = b.dept_id
		       	and hd.dept_id = b.dept_id
		    	<if test="show_history == 1">
					and hd.dept_no = b.dept_no
				</if>
				<if test="show_history == 0">
					and hd.is_stop = 0
				</if>
		     left join acc_vouch_detail avd on a.group_id = avd.group_id 
		      	and a.hos_id = avd.hos_id 
		      	and a.copy_code = avd.copy_code 
		      	and a.acc_year = avd.acc_year
		      	and a.vouch_id = avd.vouch_id 
		      	and a.vouch_detail_id = avd.vouch_detail_id
		    left join acc_vouch av on av.group_id = avd.group_id 
		      	and av.hos_id = avd.hos_id 
		      	and av.copy_code = avd.copy_code 
		      	and av.acc_year = avd.acc_year
		      	and av.vouch_id = avd.vouch_id
			left join acc_vouch_type  f on f.group_id = av.group_id
				and f.hos_id = av.hos_id
			  	and f.copy_code = av.copy_code 
			  	and f.vouch_type_code=av.vouch_type_code
			left join (
				select check_id,group_id,hos_id,copy_code,acc_year,sum(veri_money) as veri_money from (
			    	select credit_check_id as check_id,group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money  
			    	from acc_vouch_veri 
			    	where  group_id = #{group_id,jdbcType=INTEGER}  
			        	and  hos_id = #{hos_id,jdbcType=INTEGER}  
			        	and  copy_code = #{copy_code,jdbcType=VARCHAR} 
			        	and  acc_year = #{acc_year,jdbcType=VARCHAR} 
			        	and  nvl(credit_check_id,0) != 0 
			        union
			        select debit_check_id as check_id, group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money 
			        from acc_vouch_veri 
			        where group_id = #{group_id,jdbcType=INTEGER}  
			        	and hos_id = #{hos_id,jdbcType=INTEGER}  
			       		and copy_code = #{copy_code,jdbcType=VARCHAR} 
			        	and acc_year = #{acc_year,jdbcType=VARCHAR} 
			        	and nvl(debit_check_id,0) != 0
			     ) aa  group by check_id,group_id,hos_id,copy_code,acc_year
			 ) avv on avv.group_id = a.group_id 
			 	and avv.hos_id = a.hos_id 
				and avv.copy_code = a.copy_code  
				and avv.acc_year = a.acc_year 
				and avv.check_id = a.vouch_check_id
			 where  a.group_id = #{group_id,jdbcType=INTEGER}  
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.hos_id = #{hos_id,jdbcType=INTEGER} 
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				and a.subj_code = #{subj_code,jdbcType=VARCHAR} 
				<if test="veriState ==2 ">
		        	and nvl(avv.veri_money,0) != 0
		        </if>
		        <if test="veriState == 1 ">
		        	and nvl(avv.veri_money,0) = 0
		        </if>
				<if test="dept_id != null and dept_id != ''">
					and b.dept_id = #{dept_id,jdbcType=INTEGER}
				</if>
				<if test="emp_id != null and emp_id != ''">
					and b.emp_id = #{emp_id,jdbcType=INTEGER}
				</if>
				and a.due_date = to_date(#{due_date},'yyyy/mm/dd') 
				${state}
				and hd.dept_id is not null
		      	and hd.dept_no is not null
				group by a.group_id,a.hos_id,a.copy_code,a.acc_year
		)
		
		select group_id,hos_id,copy_code,dept_name,emp_code,emp_name,vouch_date,vouch_no,summary,debit,ybal_amt,state,check_id ,idx
		from (
		    select group_id,hos_id,copy_code,acc_year,dept_name,emp_code,emp_name,vouch_date,vouch_no,summary,debit,ybal_amt,state,idx,check_id,vouch_nos
			from detail_table 
			union
			select group_id,hos_id,copy_code,acc_year,dept_name,emp_code,emp_name,vouch_date,vouch_no, '合计' summary,debit,ybal_amt,state,idx,check_id,vouch_nos
			from sum_table
			union
			select group_id,hos_id,copy_code,acc_year,dept_name,emp_code,emp_name,vouch_date,vouch_no, '总合计' summary,debit,ybal_amt,state,idx,check_id,vouch_nos
			from sumAll_table 
		)  t order by emp_code, idx, vouch_nos,check_id	
	</select>
	
	<select id="queryCurrentAccountPrint" parameterType="java.util.Map" resultType="java.util.Map">
    	select 
    			a.subj_code,
    			a.subj_name, 
				case when a.subj_dire=0 then '借' else '贷' end subj_dire,
				a.is_last,
				CASE a.subj_dire WHEN 0  
					THEN  sum(nvl(debit, 0.00)) - sum(nvl(credit, 0.00))  
					ELSE  sum(nvl(credit,0.00)) - sum(nvl(debit, 0.00))  
				END AS debit
					
		from ACC_SUBJ a 
		left join ACC_VOUCH_CHECK b  on a.group_id = b.group_id
				and a.hos_id = b.hos_id
				and a.copy_code = b.copy_code
				and a.acc_year = b.acc_year
				and a.subj_code = b.subj_code
				and b.IS_INIT = 1
		<where>
				a.subj_nature_code in('04','05')
				and a.group_id=#{group_id,jdbcType=INTEGER} 
				and a.hos_id=#{hos_id,jdbcType=INTEGER} 
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				<if test="subj_code != null and subj_code != '' and subj_code != 'undefined'">
                	and a.subj_code = #{subj_code,jdbcType=VARCHAR}
               	</if>
       	group by a.subj_code,a.subj_name,a.subj_dire,a.is_last
		</where>
		order by a.subj_code	
    </select>
    
    <select id="queryCurrentAccountCheckPrint" parameterType="java.util.Map" resultType="java.util.Map">
    	select distinct  
    		a.subj_code, 
    		a.subj_name,  
    		case when a.subj_dire='0' then '借' else '贷' end subj_dire,
    		a.is_check,
    		abs(c.end_os) as bal_os,
    		abs(d.debit) as debit
		from  ACC_SUBJ a 
		left join ACC_VOUCH_CHECK b on  a.group_id = b.group_id 
			and a.hos_id = b.hos_id 
			and a.copy_code = b.copy_code
			and a.acc_year = b.acc_year 
			and a.subj_code = b.subj_code
		left join ACC_LEDER c on  a.group_id = c.group_id 
			and a.hos_id = c.hos_id 
			and a.copy_code = c.copy_code
			and a.acc_year = c.acc_year 
			and a.subj_code = c.subj_code 
			and c.acc_month='00'
		left join (
			select  a.group_id,a.hos_id,a.copy_code,a.acc_year,
				a.subj_code,
				SUM(CASE a.subj_dire WHEN 0 THEN nvl(debit,0) - nvl(credit,0) ELSE nvl(credit,0) - nvl(debit,0) END) AS debit
			from acc_subj a
			left join acc_vouch_check b on a.group_id=b.group_id
				and a.hos_id=b.hos_id
				and a.copy_code=b.copy_code 
				and a.acc_year=b.acc_year
				and a.subj_code=b.subj_code 
				and b.is_init=1 
			where a.group_id = 	#{group_id,jdbcType=INTEGER} 
				and a.hos_id = #{hos_id,jdbcType=INTEGER} 
				and a.copy_code= #{copy_code,jdbcType=VARCHAR}
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				<if test="subj_code != null and subj_code != '' and subj_code != 'undefined'">
                	and a.subj_code = #{subj_code,jdbcType=VARCHAR}
               	</if> 
            	group by a.group_id,a.hos_id,a.copy_code,a.acc_year,a.subj_code
		)d on d.group_id = a.group_id and d.hos_id=a.hos_id and d.copy_code=a.copy_code 
			and d.acc_year = a.acc_year and d.subj_code=a.subj_code
		<where>  a.group_id = #{group_id,jdbcType=INTEGER} 
			and a.hos_id = #{hos_id,jdbcType=INTEGER} 
			and a.copy_code = #{copy_code,jdbcType=VARCHAR}
			and a.acc_year = #{acc_year,jdbcType=VARCHAR}
			and a.subj_nature_code in('04','05')
			<if test="subj_code != null and subj_code != '' and subj_code != 'undefined'">
            	and a.subj_code = #{subj_code,jdbcType=VARCHAR}
            </if>
		</where>
		order by a.subj_code
    </select>
    
    <select id="queryAccLederCheckBalanceOPrint" parameterType="java.util.Map" resultType="java.util.Map">
		with l_check as(
		     select avc.group_id,
		            avc.hos_id,
		            avc.copy_code,
		            avc.acc_year,
		            avc.acc_month,
		            avc.subj_code,
		           	nvl(avc.bal_os,0) as bal_os,
		            nvl(avc.this_oc,0) as this_oc,
		            nvl(avc.this_od,0) as this_od,
		            <if test="colName !=null and colName !='' ">
		             	${colName}
		            </if>
		            <if test="colName ==null or colName =='' ">
		            	'' as check_code,
		             	'' as check_name,
		            </if>
		            a.subj_dire
		     from acc_leder_check avc
		     <if test="whereSql !=null and whereSql !='' ">
		      	${whereSql}
		      </if>
		     left join acc_subj  a on avc.group_id = a.group_id
		          and avc.hos_id = a.hos_id
		          and avc.copy_code = a.copy_code
		          and avc.acc_year= a.acc_year
		          and avc.subj_code = a.subj_code
		     where avc.group_id = #{group_id,jdbcType=INTEGER} 
		           and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
		           and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
		           and avc.acc_year = #{acc_year,jdbcType=VARCHAR}
		           and avc.acc_month = '00'
		           and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
		),d_check as(
		      select avc.group_id, 
		             avc.hos_id,
		             avc.copy_code,
		             avc.acc_year,
		             av.acc_month,
		             avc.subj_code,
		             <if test="colName !=null and colName !='' ">
		             	${colName}
		             </if>
		             <if test="colName ==null or colName =='' ">
		             	'' as check_code,
		             	'' as check_name,
		             </if>
		             sum(nvl(avc.debit,0)) debit,
		             sum(nvl(avc.credit,0)) credit
		      from acc_vouch_check avc
		      <if test="whereSql !=null and whereSql !='' ">
		      	${whereSql}
		      </if>
		      left join acc_vouch_detail avd on avc.group_id = avd.group_id
		           and avc.hos_id = avd.hos_id
		           and avc.copy_code = avd.copy_code
		           and avc.acc_year = avd.acc_year
		           and avc.vouch_detail_id = avd.vouch_detail_id
		      left join acc_vouch av on avd.group_id =av.group_id
		           and avd.hos_id = av.hos_id
		           and avd.copy_code =av.copy_code
		           and avd.acc_year = av.acc_year
		           and avd.vouch_id = av.vouch_id
		      where  avc.group_id = #{group_id,jdbcType=INTEGER} 
		           and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
		           and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
		           and avc.acc_year = #{acc_year,jdbcType=VARCHAR}
		           and av.acc_month = #{acc_month,jdbcType=VARCHAR}
		           and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
		           ${state}
		           and avc.is_init = 0 
		       group by avc.group_id,avc.hos_id,avc.copy_code,avc.acc_year,av.acc_month, avc.subj_code
		       <if test="groupBy !=null and groupBy !='' ">
		       		${groupBy}
		       </if>                 
		)
		select 
		       a.group_id,
		       a.hos_id,
		       a.copy_code,
		       a.acc_year,
		       a.subj_code,
		       <if test="colName !=null and colName !='' ">
		           d_check.check_code,
		       	   d_check.check_name,
		       </if>
		       <if test="colName ==null or colName =='' ">
		           '' as check_code,
		       	   '' as check_name,
		       </if>
		       nvl(l_check.bal_os,0) as bal_os,
		       nvl(d_check.debit,0) as this_od,
		       nvl(l_check.this_od,0) + nvl(d_check.debit,0) as sum_od,
		       nvl(d_check.credit,0) as this_oc,
		       nvl(l_check.this_oc,0) + nvl(d_check.credit,0) as sum_oc,
		       case when nvl(l_check.this_od,0)>nvl(l_check.this_oc,0) then '借' else '贷' end subj_dire,
		       nvl(l_check.bal_os,0) + nvl(d_check.debit, 0) - nvl(d_check.credit, 0) as balance
		from acc_subj  a
		left join d_check d_check on a.group_id = d_check.group_id and a.hos_id = d_check.hos_id
			and a.copy_code= d_check.copy_code and a.acc_year = d_check.acc_year 
			and a.subj_code = d_check.subj_code
		left join l_check l_check on  d_check.group_id = l_check.group_id 
		     and d_check.hos_id = l_check.hos_id
		     and d_check.copy_code = l_check.copy_code
		     and d_check.acc_year = l_check.acc_year
		     and d_check.subj_code = l_check.subj_code
		     <if test="aWhere !=null and aWhere !='' ">
		     	${aWhere}
		     </if>
			 <if test="showItem == '1' or showItem == 1">
				and l_check.bal_os + nvl(d_check.debit, 0) - nvl(d_check.credit, 0) > 0
			 </if>
		<where>
			<if test="group_id != null and group_id !='' ">
				and a.group_id =#{group_id,jdbcType=INTEGER} 
			</if>
			<if test="hos_id != null and hos_id !='' ">
				and a.hos_id =#{hos_id,jdbcType=INTEGER} 
			</if>
			<if test="copy_code != null and copy_code !='' ">
				and a.copy_code =#{copy_code,jdbcType=VARCHAR} 
			</if>
			<if test="acc_year != null and acc_year !='' ">
				and a.acc_year =#{acc_year,jdbcType=VARCHAR} 
			</if>
			<if test="subj_code != null and subj_code !='' ">
				and a.subj_code =#{subj_code,jdbcType=VARCHAR} 
			</if>
			and d_check.check_code is not null
		</where>
		<if test="colName !=null and colName !='' ">
			order by d_check.check_code
		</if>
	</select>
	
	<!-- 往来查询   余额查询(自定义)  -->
	<select id="queryAccLederCheckBalanceZPrint" parameterType="java.util.Map" resultType="java.util.Map">
		with l_check as (
		     select alc.group_id,               
		           alc.hos_id,               
		           alc.copy_code,               
		           alc.acc_year,               
		           alc.acc_month,               
		           alc.subj_code,               
		           aci.check_item_code as check_code,               
		           aci.check_item_name as check_name,               
		           nvl(alc.bal_os,0) bal_os,               
		           nvl(alc.this_od,0) this_od,               
		           nvl(alc.sum_od,0) sum_od,               
		           nvl(alc.this_oc,0) this_oc,               
		           nvl(alc.sum_oc,0) sum_oc,               
		           nvl(alc.bal_os,0) + nvl(alc.this_od,0) - nvl(alc.this_oc,0) as balance,               
		           au.subj_dire as subj_dire,               
		           aci.check_type_id as check_type_id，   
		           aci.check_item_id   
		    from acc_leder_check alc
		    left join acc_check_item aci on aci.group_id = alc.group_id
		          and aci.hos_id = alc.hos_id
		          and aci.copy_code = alc.copy_code
		          <if test="whereSqll != null and whereSqll !='' ">
		          	${whereSqll}
		          </if>
		     left join acc_subj au on au.group_id = alc.group_id
		          and au.hos_id = alc.hos_id
		          and au.copy_code = alc.copy_code
		          and au.acc_year = alc.acc_year
		          and au.subj_code  = alc.subj_code        
		     where alc.group_id = #{group_id,jdbcType=INTEGER} 
		           and alc.hos_id = #{hos_id,jdbcType=INTEGER} 
		           and alc.copy_code = #{copy_code,jdbcType=VARCHAR}
		           and alc.acc_year = #{acc_year,jdbcType=VARCHAR}
		           and alc.acc_month = '00'
		           and alc.subj_code = #{subj_code,jdbcType=VARCHAR}
		           and aci.check_type_id = #{check_type_id,jdbcType=INTEGER} 
		),d_check as (
		     select  avc.group_id,             
                   avc.hos_id,             
                   avc.copy_code,             
                   avc.acc_year,             
                   av.acc_month,             
                   avc.subj_code,             
                   aci.check_type_id,             
                   sum(nvl(avc.debit,0)) as debit,             
                   sum(nvl(avc.credit,0)) as credit ,    
                   aci.check_item_id   
           from acc_vouch_check avc                     
           left join acc_check_item aci on aci.group_id = avc.group_id            
           	     and aci.hos_id = avc.hos_id            
                 and aci.copy_code = avc.copy_code
		         <if test="whereSql != null and whereSql !='' ">
		          	${whereSql}
		          </if> 
		     left join acc_vouch_detail avd on avc.group_id = avd.group_id
		         and avc.hos_id = avd.hos_id
		         and avc.copy_code = avd.copy_code
		         and avc.acc_year = avd.acc_year
		         and avc.vouch_detail_id = avd.vouch_detail_id
		         and avc.subj_code = avd.subj_code
		    left join acc_vouch av on av.group_id = avd.group_id
		         and av.hos_id = avd.hos_id
		         and av.copy_code = avd.copy_code
		         and av.acc_year = avd.acc_year
		         and av.vouch_id = avd.vouch_id
		     where avc.group_id = #{group_id,jdbcType=INTEGER} 
		         and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
		         and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
		         and av.acc_year = #{acc_year,jdbcType=VARCHAR}
		         and av.acc_month = #{acc_month,jdbcType=VARCHAR}
		         and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
		         and aci.check_type_id = #{check_type_id,jdbcType=INTEGER} 
		         ${state}
		     group by avc.group_id,avc.hos_id,avc.copy_code,avc.acc_year,av.acc_month,avc.subj_code,aci.check_type_id,aci.check_item_id
		)
		   select 
		     l_check.group_id,
		     l_check.hos_id,
		     l_check.copy_code,
		     l_check.acc_year,
		     l_check.acc_month,
		     l_check.subj_code,
		     l_check.check_code,
		     l_check.check_name,
		     nvl(l_check.bal_os,0) bal_os,
		     nvl(l_check.this_od,0) + nvl(d_check.debit,0) as this_od,
		     nvl(l_check.sum_od,0) + nvl(d_check.debit,0) as sum_od,
		     nvl(l_check.this_oc,0) + nvl(d_check.credit,0) as this_oc,
		     nvl(l_check.sum_oc,0) + nvl(d_check.credit,0) as sum_oc,
		     nvl(l_check.balance,0) + nvl(d_check.debit,0) - nvl(d_check.credit,0) as balance,
		     l_check.subj_dire
		 from acc_check_item  a
    	 left join d_check d_check on a.group_id = d_check.group_id and a.hos_id = d_check.hos_id 
    	 	and a.copy_code = d_check.copy_code and a.check_item_id = d_check.check_item_id
    	 left join l_check l_check on  d_check.group_id = l_check.group_id and d_check.hos_id =l_check.hos_id 
    	 	and d_check.copy_code=l_check.copy_code and d_check.check_item_id=l_check.check_item_id
		 <where>
		 	<if test="group_id != null and group_id !=''">
		 		and a.group_id = #{group_id,jdbcType=INTEGER} 
		 	</if>
		 	<if test="hos_id != null and hos_id !=''">
		 		and a.hos_id = #{hos_id,jdbcType=INTEGER} 
		 	</if>
		 	<if test="copy_code != null and copy_code !=''">
		 		and a.copy_code = #{copy_code,jdbcType=VARCHAR} 
		 	</if>
		 	<if test="showItem == '1' or showItem == 1">
				and l_check.balance + d_check.debit - d_check.credit > 0
			</if>
			and d_check.check_type_id is not null  
		 </where>		
		 order by l_check.group_id,l_check.hos_id,l_check.copy_code,l_check.acc_year,l_check.acc_month,l_check.check_code
	</select>
	
	<select id="queryAccVerificationDetailPrint" parameterType="java.util.Map" resultType="java.util.Map">
	  with detail_table as (
		select DISTINCT 
			avc.group_id,
			avc.hos_id,
			avc.copy_code,
			avc.vouch_check_id as check_id, 
			to_char(av.vouch_date, 'yyyy') as acc_year, 
			to_char(av.vouch_date, 'mm') as acc_month, 
			to_char(av.vouch_date, 'dd') as acc_day, 
			substr(avt.vouch_type_name, 0, 1) || '-' || av.vouch_no as vouch_no,
			<if test="colName !=null and colName !='' ">
		    	${colName}
		    </if>
		    <if test="colName ==null or colName =='' ">
		    	'' as check_code,
				'' as check_name,
		    </if>
			avc.summary, 
			avc.con_no, 
			avc.business_no ,
			case when nvl(avv.veri_money,0)-nvl(avc.debit,0)-nvl(avc.credit,0)=0  then '已核销'
            	else 
            		case when nvl(avv.veri_money,0) = 0 then '未核销'
                    else ''
                end
            end as state, 
     		to_char(avc.occur_date,'yyyy-mm-dd') as occur_date, 
     		to_char(avc.due_date,'yyyy-mm-dd') as due_date, 
     		nvl(avc.debit, 0) as debit, 
     		nvl(avc.credit, 0) as credit , 
     		nvl(avv.veri_money, 0) as ybal_amt, 
     		abs(nvl(avc.debit, 0) - nvl(avc.credit, 0)) - nvl(avv.veri_money, 0) as wbal_amt,
     		1 as id,
     		case when nvl(avc.debit,0) = 0 then 1 else 0 end subj_dire,
     		av.vouch_no as vouch_nos,
     		avv.veri_check_id as veri_check_id,
     		avc.vouch_id as vouch_id
		from acc_vouch_check avc
		<if test="whereSql !=null and whereSql !='' ">
			${whereSql}
		</if>
		left join acc_vouch_detail  avd on avc.group_id = avd.group_id 
		  	and avc.hos_id = avd.hos_id 
		  	and avc.copy_code = avd.copy_code 
		  	and avc.acc_year = avd.acc_year
		  	and avc.vouch_id = avd.vouch_id 
		  	and avc.vouch_detail_id = avd.vouch_detail_id 
		left join acc_vouch  av on av.group_id = avd.group_id
			and av.hos_id = avd.hos_id 
		  	and av.copy_code = avd.copy_code 
		  	and av.acc_year = avd.acc_year
		  	and av.vouch_id = avd.vouch_id
		left join acc_vouch_type  avt on avt.group_id = av.group_id
			and avt.hos_id = av.hos_id 
		  	and avt.copy_code = av.copy_code 
		  	and avt.vouch_type_code = av.vouch_type_code
		left join (
             select check_id,group_id,hos_id,copy_code,acc_year,veri_money ,veri_check_id from (
                  select credit_check_id as check_id,group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money ,veri_check_id 
                  from acc_vouch_veri 
                  where  group_id = #{group_id,jdbcType=INTEGER}  
                  	and hos_id = #{hos_id,jdbcType=INTEGER}  
                  	and copy_code = #{copy_code,jdbcType=VARCHAR} 
                  	and acc_year = #{acc_year,jdbcType=VARCHAR} 
                  	and nvl(credit_check_id,0) != 0 
                  union
                  select debit_check_id as check_id, group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money ,veri_check_id
                  from acc_vouch_veri 
                  where group_id = #{group_id,jdbcType=INTEGER}  
                  	and hos_id = #{hos_id,jdbcType=INTEGER}  
                  	and copy_code = #{copy_code,jdbcType=VARCHAR} 
                  	and acc_year = #{acc_year,jdbcType=VARCHAR} 
                  	and nvl(debit_check_id,0) != 0
             ) aa  
        ) avv on avv.group_id = avc.group_id 
        	and avv.hos_id = avc.hos_id 
        	and avv.copy_code = avc.copy_code  
        	and avv.acc_year = avc.acc_year 
        	and avv.check_id = avc.vouch_check_id
		where avc.group_id = #{group_id,jdbcType=INTEGER}  
			and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
			and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
			and avc.acc_year = #{acc_year,jdbcType=VARCHAR}
			
			<if test="veriState ==2 ">
	        	and nvl(avv.veri_money,0) != 0
	        </if>
	        <if test="veriState == 1 ">
	        	and nvl(avv.veri_money,0) = 0
	        </if>
			<if test="subj_code != null and subj_code != ''">
			    and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
			</if>
            <if test="acc_year_b != null and acc_year_b != '' and acc_year_e != null and acc_year_e != ''">
            	and av.acc_year  between #{acc_year_b,jdbcType=VARCHAR} and #{acc_year_e,jdbcType=VARCHAR}
            </if>
            <if test="acc_month_b != null and acc_month_b != '' and acc_month_e != null and acc_month_e != ''">
            	and av.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
            </if>
			<if test="vouch_no1 != null and vouch_no1 != '' and vouch_no2 != null and vouch_no2 != ''">
            	and av.vouch_no between #{vouch_no1,jdbcType=VARCHAR} and #{vouch_no2,jdbcType=VARCHAR}
            </if>
			 ${state}
          ORDER BY acc_month
	   ),month_table as (
		SELECT 
			t.group_id,
			t.hos_id,
			t.copy_code,
			0 as check_id, 
			t.acc_year, 
			t.acc_month, 
			'' as acc_day, 
			'' as vouch_no, 
			'' as check_code, 
			'本月合计' as check_name, 
			'本月合计' as summary, 
			'' as con_no, 
			'' as  business_no, 
			'' as state, 
         	'' as occur_date, 
         	'' as due_date, 
         	sum(t.debit) as debit, 
         	sum(t.credit) as credit, 
         	sum(t.ybal_amt) as ybal_amt, 
         	sum(t.wbal_amt) as wbal_amt,
         	2 as id,
         	0 as subj_dire,
         	vouch_nos,
         	veri_check_id
    		from (
    			select  
    				avc.group_id,
    				avc.hos_id,
    				avc.copy_code,
    				av.acc_year as acc_year, 
    				av.acc_month as acc_month,
          			nvl(avc.debit, 0) as debit, 
          			nvl(avc.credit, 0) as credit,
          			nvl(avv.veri_money, 0) as ybal_amt,
          			abs(nvl(avc.debit,0)-nvl(avc.credit,0))-nvl(avv.veri_money,0) AS wbal_amt,
          			'999999999999' vouch_nos,
          			0 veri_check_id
          		FROM acc_vouch_check avc
          		<if test="whereSql !=null and whereSql !='' ">
					${whereSql}
				</if>
				left join acc_vouch_detail  avd on avc.group_id = avd.group_id 
				  	and avc.hos_id = avd.hos_id 
				  	and avc.copy_code = avd.copy_code 
				  	and avc.acc_year = avd.acc_year
				  	and avc.vouch_id = avd.vouch_id 
				  	and avc.vouch_detail_id = avd.vouch_detail_id
				left join acc_vouch  av on av.group_id = avd.group_id 
					and av.hos_id = avd.hos_id  
				  	and av.copy_code = avd.copy_code 
				  	and av.acc_year = avd.acc_year
				  	and av.vouch_id = avd.vouch_id
				left join (
		             select check_id,group_id,hos_id,copy_code,acc_year,veri_money from (
		                  select credit_check_id as check_id,group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money
		                  from acc_vouch_veri 
		                  where  group_id = #{group_id,jdbcType=INTEGER}  
		                  	and  hos_id = #{hos_id,jdbcType=INTEGER}  
		                  	and  copy_code = #{copy_code,jdbcType=VARCHAR} 
		                  	and  acc_year = #{acc_year,jdbcType=VARCHAR} 
		                  	and  nvl(credit_check_id,0) != 0 
		                  union
		                  select debit_check_id as check_id, group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money
		                  from acc_vouch_veri 
		                  where group_id = #{group_id,jdbcType=INTEGER}  
		                  	and hos_id = #{hos_id,jdbcType=INTEGER}  
		                  	and copy_code = #{copy_code,jdbcType=VARCHAR} 
		                  	and acc_year = #{acc_year,jdbcType=VARCHAR} 
		                  	and nvl(debit_check_id,0) != 0
		             ) aa 
		        ) avv on avv.group_id = avc.group_id 
		        	and avv.hos_id = avc.hos_id 
		        	and avv.copy_code = avc.copy_code  
		        	and avv.acc_year = avc.acc_year 
		        	and avv.check_id = avc.vouch_check_id
				where   avc.group_id = #{group_id,jdbcType=INTEGER} 
					and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
					and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
					and avc.acc_year = #{acc_year,jdbcType=VARCHAR} 
					<if test="veriState ==2 ">
			        	and nvl(avv.veri_money,0) != 0
			        </if>
			        <if test="veriState == 1 ">
			        	and nvl(avv.veri_money,0) = 0
			        </if> 
					<if test="subj_code != null and subj_code != ''">
			            and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
			        </if>
		            <if test="acc_year_b != null and acc_year_b != '' and acc_year_e != null and acc_year_e != ''">
		            	and av.acc_year  between #{acc_year_b,jdbcType=VARCHAR} and #{acc_year_e,jdbcType=VARCHAR}
		            </if>
		            <if test="acc_month_b != null and acc_month_b != '' and acc_month_e != null and acc_month_e != ''">
		            	and av.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
		            </if>
					<if test="vouch_no1 != null and vouch_no1 != '' and vouch_no2 != null and vouch_no2 != ''">
		            	and av.vouch_no between #{vouch_no1,jdbcType=VARCHAR} and #{vouch_no2,jdbcType=VARCHAR}
		            </if>
			 		${state}
    		   )t  group by t.group_id,t.hos_id,t.copy_code,t.acc_year,t.acc_month,t.vouch_nos,t.veri_check_id
    		   
		),sum_table as(
			SELECT  
				t.group_id,
				t.hos_id,
				t.copy_code,
				0 as check_id, 
				t.acc_year, 
				'99' as acc_month,
				'' as acc_day, 
				'' as vouch_no, 
				'' as check_code, 
				'总合计' AS check_name, 
				'总合计' as summary, 
				'' as con_no, 
				'' as  business_no, 
				'' as state, 
         		'' as occur_date, 
         		'' as due_date, 
         		sum(t.debit) as debit, 
         		sum(t.credit) as credit, 
         		sum(t.ybal_amt) as ybal_amt, 
         		sum(t.wbal_amt) as wbal_amt,
         		3 as id, 
         		0 as subj_dire,
         		vouch_nos,
         		veri_check_id
			    from (
			    	select  
			    		avc.group_id,
			    		avc.hos_id,
			    		avc.copy_code,
			    		avc.acc_year AS acc_year, 
			    		av.acc_month AS acc_month,
          				nvl(avc.debit, 0) AS debit, 
          				nvl(avc.credit, 0) AS credit,
          				nvl(avv.veri_money, 0) AS ybal_amt,
          				abs(nvl(avc.debit,0)-nvl(avc.credit,0))-nvl(avv.veri_money,0) AS wbal_amt,
          				'999999999999' vouch_nos,
          				0 veri_check_id
          			FROM acc_vouch_check avc
          			<if test="whereSql !=null and whereSql !='' ">
						${whereSql}
					</if>
					left join acc_vouch_detail  avd on avc.group_id = avd.group_id 
					  	and avc.hos_id = avd.hos_id 
					  	and avc.copy_code = avd.copy_code 
					  	and avc.acc_year = avd.acc_year 
					  	and avc.vouch_id = avd.vouch_id 
					  	and avc.vouch_detail_id = avd.vouch_detail_id
					left join acc_vouch  av on av.group_id = avd.group_id
						and av.hos_id = avd.hos_id 
					  	and av.copy_code = avd.copy_code 
					  	and av.acc_year = avd.acc_year 
					  	and av.vouch_id = avd.vouch_id
					left join (
			             select check_id,group_id,hos_id,copy_code,acc_year,veri_money from (
			                  select credit_check_id as check_id,group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money 
			                  from acc_vouch_veri 
			                  where  group_id = #{group_id,jdbcType=INTEGER}  
			                  	and  hos_id = #{hos_id,jdbcType=INTEGER}  
			                  	and  copy_code = #{copy_code,jdbcType=VARCHAR} 
			                  	and  acc_year = #{acc_year,jdbcType=VARCHAR} 
			                  	and  nvl(credit_check_id,0) != 0 
			                  union
			                  select debit_check_id as check_id, group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money 
			                  from acc_vouch_veri 
			                  where group_id = #{group_id,jdbcType=INTEGER}  
			                  	and hos_id = #{hos_id,jdbcType=INTEGER}  
			                  	and copy_code = #{copy_code,jdbcType=VARCHAR} 
			                  	and acc_year = #{acc_year,jdbcType=VARCHAR} 
			                  	and nvl(debit_check_id,0) != 0
			             ) aa 
			        ) avv on avv.group_id = avc.group_id 
			        	and avv.hos_id = avc.hos_id 
			        	and avv.copy_code = avc.copy_code  
			        	and avv.acc_year = avc.acc_year 
			        	and avv.check_id = avc.vouch_check_id
					where avc.group_id = #{group_id,jdbcType=INTEGER}  
						and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
						and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
						and avc.acc_year = #{acc_year,jdbcType=VARCHAR} 
						<if test="veriState ==2 ">
				        	and nvl(avv.veri_money,0) != 0
				        </if>
				        <if test="veriState == 1 ">
				        	and nvl(avv.veri_money,0) = 0
				        </if>
			            <if test="subj_code != null and subj_code != ''">
			            	and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
			            </if>
			            <if test="acc_year_b != null and acc_year_b != '' and acc_year_e != null and acc_year_e != ''">
			            	and av.acc_year  between #{acc_year_b,jdbcType=VARCHAR} and #{acc_year_e,jdbcType=VARCHAR}
			            </if>
			            <if test="acc_month_b != null and acc_month_b != '' and acc_month_e != null and acc_month_e != ''">
			            	and av.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
			            </if>
						<if test="vouch_no1 != null and vouch_no1 != '' and vouch_no2 != null and vouch_no2 != ''">
			            	and av.vouch_no between #{vouch_no1,jdbcType=VARCHAR} and #{vouch_no2,jdbcType=VARCHAR}
			            </if>
				 		${state}
			    )t group by t.group_id,t.hos_id,t.copy_code,t.acc_year,t.vouch_nos,t.veri_check_id
			)
			select  
				t.group_id,
				t.hos_id,
				t.copy_code,
				t.check_id,
				t.acc_year,
				t.acc_month, 
				t.acc_day, 
				t.vouch_no,
				t.check_code, 
				t.check_name, 
				t.summary, 
				t.con_no,
				t.business_no, 
				t.state,
				t.occur_date,
				t.due_date,
				t.debit,
				t.credit,
				t.ybal_amt,
				t.wbal_amt ,
				subj_dire,
				veri_check_id,
				vouch_id
			from (
		       select id,group_id,hos_id,copy_code,check_id,acc_year,acc_month,acc_day,vouch_no,check_code,check_name,summary,con_no,business_no,
		       		state,occur_date,due_date, debit,credit,ybal_amt,wbal_amt,subj_dire,vouch_nos,veri_check_id,vouch_id
		       from detail_table 
		       where detail_table.check_code is not null
		       union  
		       select id,group_id,hos_id,copy_code,check_id,acc_year,acc_month,acc_day,vouch_no,check_code,check_name,summary,con_no,business_no,
		       		state,occur_date,due_date,debit,credit,ybal_amt,wbal_amt ,subj_dire,vouch_nos,veri_check_id,0 vouch_id
		       from month_table
		       union 
		       select id,group_id,hos_id,copy_code,check_id,acc_year,acc_month,acc_day,vouch_no,check_code,check_name,summary,con_no,business_no,
		       		state,occur_date,due_date,debit,credit,ybal_amt,wbal_amt ,subj_dire,vouch_nos,veri_check_id,0 vouch_id
		       from sum_table
			)  t 
			order by group_id, hos_id, copy_code, acc_year, acc_month,acc_day, t.id, t.check_code asc, t.vouch_nos desc
		
	</select>
	
	<!-- 往来查询 核销清册查询 自定义 -->
	<select id="queryAccVerificationDetailZPrint" parameterType="java.util.Map" resultType="java.util.Map">
	  with detail_table as (
		select DISTINCT 
			avc.group_id,
			avc.hos_id,
			avc.copy_code,
			avc.vouch_check_id as check_id, 
			to_char(av.vouch_date, 'yyyy') as acc_year, 
			to_char(av.vouch_date, 'mm') as acc_month, 
			to_char(av.vouch_date, 'dd') as acc_day, 
			substr(avt.vouch_type_name, 0, 1) || '-' || av.vouch_no as vouch_no,
			aci.check_item_code as check_code,
			aci.check_item_name as check_name,
			avc.summary, 
			avc.con_no, 
			avc.business_no ,
			case when nvl(avv.veri_money,0)-nvl(avc.debit,0)-nvl(avc.credit,0)=0  then '已核销'
            	else 
            		case when nvl(avv.veri_money,0)=0 then '未核销'
                    else ''
                end
            end as state, 
     		to_char(avc.occur_date,'yyyy-mm-dd') as occur_date, 
     		to_char(avc.due_date,'yyyy-mm-dd') as due_date, 
     		nvl(avc.debit, 0) as debit, 
     		nvl(avc.credit, 0) as credit , 
     		nvl(avv.veri_money, 0) as ybal_amt, 
     		abs(nvl(avc.debit, 0) - nvl(avc.credit, 0)) - nvl(avv.veri_money, 0) as wbal_amt,
     		1 as id,
     		case when nvl(avc.debit,0) = 0 then 1 else 0 end subj_dire,
     		av.vouch_no as vouch_nos,
     		avv.veri_check_id as veri_check_id
		from acc_vouch_check avc
		left join acc_check_item aci on aci.group_id = avc.group_id            
        	and aci.hos_id = avc.hos_id            
        	and aci.copy_code = avc.copy_code
		<if test="whereSql != null and whereSql !='' ">
			${whereSql}
		</if>
		left join acc_vouch_detail  avd on avc.group_id = avc.group_id 
		  	and avc.hos_id = avd.hos_id 
		  	and avc.copy_code = avd.copy_code 
		  	and avc.acc_year = avd.acc_year
		  	and avc.vouch_id = avd.vouch_id 
		  	and avc.vouch_detail_id	= avd.vouch_detail_id 
		left join acc_vouch  av on av.group_id = avd.group_id
			and av.hos_id = avd.hos_id 
		  	and av.copy_code = avd.copy_code 
		  	and av.acc_year = avd.acc_year
		  	and av.vouch_id = avd.vouch_id
		left join acc_vouch_type  avt on avt.group_id = av.group_id
			and avt.hos_id = av.hos_id 
		  	and avt.copy_code = av.copy_code 
		  	and avt.vouch_type_code = av.vouch_type_code
		left join (
             select check_id,group_id,hos_id,copy_code,acc_year,veri_money ,veri_check_id from (
                  select credit_check_id as check_id,group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money ,veri_check_id 
                  from acc_vouch_veri 
                  where  group_id = #{group_id,jdbcType=INTEGER}  
                  	and hos_id = #{hos_id,jdbcType=INTEGER}  
                  	and copy_code = #{copy_code,jdbcType=VARCHAR} 
                  	and acc_year = #{acc_year,jdbcType=VARCHAR} 
                  	and nvl(credit_check_id,0) != 0 
                  union
                  select debit_check_id as check_id, group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money ,veri_check_id
                  from acc_vouch_veri 
                  where group_id = #{group_id,jdbcType=INTEGER}  
                  	and hos_id = #{hos_id,jdbcType=INTEGER}  
                  	and copy_code = #{copy_code,jdbcType=VARCHAR} 
                  	and acc_year = #{acc_year,jdbcType=VARCHAR} 
                  	and nvl(debit_check_id,0) != 0
             ) aa  
        ) avv on avv.group_id = avc.group_id 
        	and avv.hos_id = avc.hos_id 
        	and avv.copy_code = avc.copy_code  
        	and avv.acc_year = avc.acc_year 
        	and avv.check_id = avc.vouch_check_id
		where avc.group_id = #{group_id,jdbcType=INTEGER}  
			and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
			and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
			and avc.acc_year = #{acc_year,jdbcType=VARCHAR}
			and aci.check_type_id = #{check_type_id,jdbcType=INTEGER} 
			<if test="veriState ==2 ">
	        	and nvl(avv.veri_money,0) != 0
	        </if>
	        <if test="veriState == 1 ">
	        	and nvl(avv.veri_money,0) = 0
	        </if>
            <if test="subj_code != null and subj_code != ''">
            	and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
            </if>
            <if test="acc_year_b != null and acc_year_b != '' and acc_year_e != null and acc_year_e != ''">
            	and av.acc_year  between #{acc_year_b,jdbcType=VARCHAR} and #{acc_year_e,jdbcType=VARCHAR}
            </if>
            <if test="acc_month_b != null and acc_month_b != '' and acc_month_e != null and acc_month_e != ''">
            	and av.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
            </if>
			<if test="vouch_no1 != null and vouch_no1 != '' and vouch_no2 != null and vouch_no2 != ''">
            	and av.vouch_no between #{vouch_no1,jdbcType=VARCHAR} and #{vouch_no2,jdbcType=VARCHAR}
            </if>
			 ${state}
          ORDER BY acc_month
	   ),month_table as (
		SELECT 
			t.group_id,
			t.hos_id,
			t.copy_code,
			0 as check_id, 
			t.acc_year, 
			t.acc_month, 
			'' as acc_day, 
			'' as vouch_no, 
			'' as check_code, 
			'本月合计' as check_name, 
			'本月合计' as summary, 
			'' as con_no, 
			'' as  business_no, 
			'' as state, 
         	'' as occur_date, 
         	'' as due_date, 
         	sum(t.debit) as debit, 
         	sum(t.credit) as credit, 
         	sum(t.ybal_amt) as ybal_amt, 
         	sum(t.wbal_amt) as wbal_amt,
         	2 as id,
         	0 as subj_dire,
         	vouch_nos,
         	veri_check_id
    		from (
    			select  
    				avc.group_id,
    				avc.hos_id,
    				avc.copy_code,
    				av.acc_year as acc_year, 
    				av.acc_month as acc_month,
          			nvl(avc.debit, 0) as debit, 
          			nvl(avc.credit, 0) as credit,
          			nvl(avv.veri_money, 0) as ybal_amt,
          			abs(nvl(avc.debit,0)-nvl(avc.credit,0))-nvl(avv.veri_money,0) AS wbal_amt,
          			'999999999999' vouch_nos,
          			0 veri_check_id
          		FROM acc_vouch_check avc
          		left join acc_check_item aci on aci.group_id = avc.group_id            
		        	and aci.hos_id = avc.hos_id            
		        	and aci.copy_code = avc.copy_code
				<if test="whereSql != null and whereSql !='' ">
					${whereSql}
				</if>				
				left join acc_vouch_detail  avd on avc.group_id = avd.group_id 
				  	and avc.hos_id = avd.hos_id 
				  	and avc.copy_code = avd.copy_code 
				  	and avc.acc_year = avd.acc_year
				  	and avc.vouch_id = avd.vouch_id 
				  	and avc.vouch_detail_id = avd.vouch_detail_id
				left join acc_vouch  av on av.group_id = avd.group_id 
					and av.hos_id = avd.hos_id  
				  	and av.copy_code = avd.copy_code 
				  	and av.acc_year = avd.acc_year
				  	and av.vouch_id = avd.vouch_id
				left join (
		             select check_id,group_id,hos_id,copy_code,acc_year,veri_money from (
		                  select credit_check_id as check_id,group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money
		                  from acc_vouch_veri 
		                  where  group_id = #{group_id,jdbcType=INTEGER}  
		                  	and  hos_id = #{hos_id,jdbcType=INTEGER}  
		                  	and  copy_code = #{copy_code,jdbcType=VARCHAR} 
		                  	and  acc_year = #{acc_year,jdbcType=VARCHAR} 
		                  	and  nvl(credit_check_id,0) != 0 
		                  union
		                  select debit_check_id as check_id, group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money
		                  from acc_vouch_veri 
		                  where group_id = #{group_id,jdbcType=INTEGER}  
		                  	and hos_id = #{hos_id,jdbcType=INTEGER}  
		                  	and copy_code = #{copy_code,jdbcType=VARCHAR} 
		                  	and acc_year = #{acc_year,jdbcType=VARCHAR} 
		                  	and nvl(debit_check_id,0) != 0
		             ) aa 
		        ) avv on avv.group_id = avc.group_id 
		        	and avv.hos_id = avc.hos_id 
		        	and avv.copy_code = avc.copy_code  
		        	and avv.acc_year = avc.acc_year 
		        	and avv.check_id = avc.vouch_check_id
				where   avc.group_id = #{group_id,jdbcType=INTEGER} 
					and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
					and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
					and avc.acc_year = #{acc_year,jdbcType=VARCHAR} 
					and aci.check_type_id = #{check_type_id,jdbcType=INTEGER} 
					<if test="veriState ==2 ">
			        	and nvl(avv.veri_money,0) != 0
			        </if>
			        <if test="veriState == 1 ">
			        	and nvl(avv.veri_money,0) = 0
			        </if> 
		            <if test="subj_code != null and subj_code != ''">
		            	and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
		            </if>
		            <if test="acc_year_b != null and acc_year_b != '' and acc_year_e != null and acc_year_e != ''">
		            	and av.acc_year  between #{acc_year_b,jdbcType=VARCHAR} and #{acc_year_e,jdbcType=VARCHAR}
		            </if>
		            <if test="acc_month_b != null and acc_month_b != '' and acc_month_e != null and acc_month_e != ''">
		            	and av.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
		            </if>
					<if test="vouch_no1 != null and vouch_no1 != '' and vouch_no2 != null and vouch_no2 != ''">
		            	and av.vouch_no between #{vouch_no1,jdbcType=VARCHAR} and #{vouch_no2,jdbcType=VARCHAR}
		            </if>
			 		${state}
    		   )t  group by t.group_id,t.hos_id,t.copy_code,t.acc_year,t.acc_month,t.vouch_nos,t.veri_check_id
    		   
		),sum_table as(
			SELECT  
				t.group_id,
				t.hos_id,
				t.copy_code,
				0 as check_id, 
				t.acc_year, 
				'99' as acc_month,
				'' as acc_day, 
				'' as vouch_no, 
				'' as check_code, 
				'总合计' AS check_name, 
				'总合计' as summary, 
				'' as con_no, 
				'' as  business_no, 
				'' as state, 
         		'' as occur_date, 
         		'' as due_date, 
         		sum(t.debit) as debit, 
         		sum(t.credit) as credit, 
         		sum(t.ybal_amt) as ybal_amt, 
         		sum(t.wbal_amt) as wbal_amt,
         		3 as id, 
         		0 as subj_dire,
         		vouch_nos,
         		veri_check_id
			    from (
			    	select  
			    		avc.group_id,
			    		avc.hos_id,
			    		avc.copy_code,
			    		avc.acc_year AS acc_year, 
			    		av.acc_month AS acc_month,
          				nvl(avc.debit, 0) AS debit, 
          				nvl(avc.credit, 0) AS credit,
          				nvl(avv.veri_money, 0) AS ybal_amt,
          				abs(nvl(avc.debit,0)-nvl(avc.credit,0))-nvl(avv.veri_money,0) AS wbal_amt,
          				'999999999999' vouch_nos,
          				0 veri_check_id
          			FROM acc_vouch_check avc
          			left join acc_check_item aci on aci.group_id = avc.group_id            
			        	and aci.hos_id = avc.hos_id            
			        	and aci.copy_code = avc.copy_code
					<if test="whereSql != null and whereSql !='' ">
						${whereSql}
					</if>
					left join acc_vouch_detail  avd on avc.group_id = avd.group_id 
					  	and avc.hos_id = avd.hos_id 
					  	and avc.copy_code = avd.copy_code 
					  	and avc.acc_year = avd.acc_year 
					  	and avc.vouch_id = avd.vouch_id 
					  	and avc.vouch_detail_id = avd.vouch_detail_id
					left join acc_vouch  av on av.group_id = avd.group_id
						and av.hos_id = avd.hos_id 
					  	and av.copy_code = avd.copy_code 
					  	and av.acc_year = avd.acc_year 
					  	and av.vouch_id = avd.vouch_id
					left join (
			             select check_id,group_id,hos_id,copy_code,acc_year,veri_money from (
			                  select credit_check_id as check_id,group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money 
			                  from acc_vouch_veri 
			                  where  group_id = #{group_id,jdbcType=INTEGER}  
			                  	and  hos_id = #{hos_id,jdbcType=INTEGER}  
			                  	and  copy_code = #{copy_code,jdbcType=VARCHAR} 
			                  	and  acc_year = #{acc_year,jdbcType=VARCHAR} 
			                  	and  nvl(credit_check_id,0) != 0 
			                  union
			                  select debit_check_id as check_id, group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money 
			                  from acc_vouch_veri 
			                  where group_id = #{group_id,jdbcType=INTEGER}  
			                  	and hos_id = #{hos_id,jdbcType=INTEGER}  
			                  	and copy_code = #{copy_code,jdbcType=VARCHAR} 
			                  	and acc_year = #{acc_year,jdbcType=VARCHAR} 
			                  	and nvl(debit_check_id,0) != 0
			             ) aa 
			        ) avv on avv.group_id = avc.group_id 
			        	and avv.hos_id = avc.hos_id 
			        	and avv.copy_code = avc.copy_code  
			        	and avv.acc_year = avc.acc_year 
			        	and avv.check_id = avc.vouch_check_id
					where avc.group_id = #{group_id,jdbcType=INTEGER}  
						and avc.hos_id = #{hos_id,jdbcType=INTEGER} 
						and avc.copy_code = #{copy_code,jdbcType=VARCHAR}
						and avc.acc_year = #{acc_year,jdbcType=VARCHAR} 
						and aci.check_type_id = #{check_type_id,jdbcType=INTEGER} 
						<if test="veriState ==2 ">
				        	and nvl(avv.veri_money,0) != 0
				        </if>
				        <if test="veriState == 1 ">
				        	and nvl(avv.veri_money,0) = 0
				        </if>
			            <if test="subj_code != null and subj_code != ''">
			            	and avc.subj_code = #{subj_code,jdbcType=VARCHAR} 
			            </if>
			            <if test="acc_year_b != null and acc_year_b != '' and acc_year_e != null and acc_year_e != ''">
			            	and av.acc_year  between #{acc_year_b,jdbcType=VARCHAR} and #{acc_year_e,jdbcType=VARCHAR}
			            </if>
			            <if test="acc_month_b != null and acc_month_b != '' and acc_month_e != null and acc_month_e != ''">
			            	and av.acc_month between #{acc_month_b,jdbcType=VARCHAR} and #{acc_month_e,jdbcType=VARCHAR}
			            </if>
						<if test="vouch_no1 != null and vouch_no1 != '' and vouch_no2 != null and vouch_no2 != ''">
			            	and av.vouch_no between #{vouch_no1,jdbcType=VARCHAR} and #{vouch_no2,jdbcType=VARCHAR}
			            </if>
				 		${state}
			    )t group by t.group_id,t.hos_id,t.copy_code,t.acc_year,t.vouch_nos,t.veri_check_id
			)
			select  
				t.group_id,
				t.hos_id,
				t.copy_code,
				t.check_id,
				t.acc_year,
				t.acc_month, 
				t.acc_day, 
				t.vouch_no,
				t.check_code, 
				t.check_name, 
				t.summary, 
				t.con_no,
				t.business_no, 
				t.state,
				t.occur_date,
				t.due_date,
				t.debit,
				t.credit,
				t.ybal_amt,
				t.wbal_amt ,
				subj_dire,
				veri_check_id
			from (
		       select id,group_id,hos_id,copy_code,check_id,acc_year,acc_month,acc_day,vouch_no,check_code,check_name,summary,con_no,business_no,
		       		state,occur_date,due_date, debit,credit,ybal_amt,wbal_amt,subj_dire,vouch_nos,veri_check_id
		       from detail_table 
		       union  
		       select id,group_id,hos_id,copy_code,check_id,acc_year,acc_month,acc_day,vouch_no,check_code,check_name,summary,con_no,business_no,
		       		state,occur_date,due_date,debit,credit,ybal_amt,wbal_amt ,subj_dire,vouch_nos,veri_check_id
		       from month_table
		       union 
		       select id,group_id,hos_id,copy_code,check_id,acc_year,acc_month,acc_day,vouch_no,check_code,check_name,summary,con_no,business_no,
		       		state,occur_date,due_date,debit,credit,ybal_amt,wbal_amt ,subj_dire,vouch_nos,veri_check_id
		       from sum_table
			)  t order by group_id,hos_id,copy_code,acc_year,acc_month,t.id,t.check_code,t.vouch_nos
		
	</select>
	
	<select id="queryContactsReminderDetailPrint" parameterType="java.util.Map" resultType="java.util.Map">
	 with detail_table as ( 
		select 
			1 as idx,
			a.group_id as group_id,
			a.hos_id as hos_id,
			a.copy_code as copy_code,
			a.acc_year as acc_year,
			a.vouch_check_id as check_id,
			hd.dept_name as dept_name,
			b.emp_code as emp_code,
			b.emp_name as emp_name,
			to_char(av.vouch_date,'yyyy-mm-dd') as vouch_date,
  			substr(f.vouch_type_name,0,1)||'-'|| av.vouch_no as vouch_no,
  			a.summary,
  			nvl(a.debit,0) as debit,
  			nvl(avv.veri_money,0) as ybal_amt,
  			case when nvl(avv.veri_money,0)-nvl(a.debit,0)=0  then '已核销'
            	else case  when nvl(avv.veri_money,0)=0 then '未核销'
                	else ''
                end
            end as state,
            av.vouch_no as vouch_nos
 			from acc_vouch_check a
		    left join hos_emp_dict b on a.group_id = b.group_id  
		      	and a.hos_id = b.hos_id
		      	and a.check2_id = b.emp_id
		      	<if test="show_history == 1">
					and a.check2_no = b.emp_no 
				</if>
				<if test="show_history == 0">
					and b.is_stop = 0
				</if>
		    left join hos_dept_dict hd on hd.group_id = b.group_id 
		    	and hd.hos_id = b.hos_id
		        and hd.dept_id = b.dept_id
		    	<if test="show_history == 1">
					and hd.dept_no = b.dept_no
				</if>
				<if test="show_history == 0">
					and hd.is_stop = 0
				</if>
		     left join acc_vouch_detail avd on a.group_id = avd.group_id 
		     	and a.hos_id = avd.hos_id 
		      	and a.copy_code = avd.copy_code 
		      	and a.acc_year = avd.acc_year
		      	and a.vouch_id = avd.vouch_id 
		      	and avd.vouch_detail_id = a.vouch_detail_id
		    left join acc_vouch av on av.group_id = avd.group_id 
		    	and av.hos_id = avd.hos_id 
		      	and av.copy_code = avd.copy_code 
		      	and av.acc_year = avd.acc_year
		      	and av.vouch_id = avd.vouch_id
			left join acc_vouch_type  f on f.group_id = av.group_id
			  	and f.copy_code = av.copy_code 
			  	and f.hos_id = av.hos_id 
			  	and f.vouch_type_code=av.vouch_type_code
			  	and f.is_stop = 0
			left join (
				select check_id,group_id,hos_id,copy_code,acc_year,sum(veri_money) as veri_money from (
			    	select credit_check_id as check_id,group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money  
			    	from acc_vouch_veri 
			    	where  group_id = #{group_id,jdbcType=INTEGER}  
			        	and  hos_id = #{hos_id,jdbcType=INTEGER}  
			        	and  copy_code = #{copy_code,jdbcType=VARCHAR} 
			        	and  acc_year = #{acc_year,jdbcType=VARCHAR} 
			        	and  nvl(credit_check_id,0) != 0 
			        union
			        select debit_check_id as check_id, group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money 
			        from acc_vouch_veri 
			        where group_id = #{group_id,jdbcType=INTEGER}  
			        	and hos_id = #{hos_id,jdbcType=INTEGER}  
			       		and copy_code = #{copy_code,jdbcType=VARCHAR} 
			        	and acc_year = #{acc_year,jdbcType=VARCHAR} 
			        	and nvl(debit_check_id,0) != 0
			     ) aa  group by check_id,group_id,hos_id,copy_code,acc_year
			 ) avv on avv.group_id = a.group_id 
			 	and avv.hos_id = a.hos_id 
				and avv.copy_code = a.copy_code  
				and avv.acc_year = a.acc_year 
				and avv.check_id = a.vouch_check_id
		    where  a.group_id = #{group_id,jdbcType=INTEGER}  
			 	and a.hos_id = #{hos_id,jdbcType=INTEGER} 
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				and a.subj_code = #{subj_code,jdbcType=VARCHAR} 
				<if test="veriState ==2 ">
		        	and nvl(avv.veri_money,0) != 0
		        </if>
		        <if test="veriState == 1 ">
		        	and nvl(avv.veri_money,0) = 0
		        </if>
				<if test="dept_id != null and dept_id != ''">
					and b.dept_id = #{dept_id,jdbcType=INTEGER}
				</if>
				<if test="dept_no != null and dept_no != ''">
					and b.dept_no = #{dept_no,jdbcType=INTEGER}
				</if>
				<if test="emp_id != null and emp_id != ''">
					and b.emp_id = #{emp_id,jdbcType=INTEGER}
				</if>
				<if test="emp_no != null and emp_no != ''">
					and b.emp_no = #{emp_no,jdbcType=INTEGER}
				</if>
				and a.due_date = to_date(#{due_date},'yyyy/mm/dd') 
				${state}
				and hd.dept_id is not null
		      	and hd.dept_no is not null
		      order by b.emp_code,av.vouch_no
		),sum_table as(
			SELECT 
				2 as idx,
				a.group_id as group_id,
				a.hos_id as hos_id,
				a.copy_code as copy_code,
				a.acc_year as acc_year,
				0 as check_id,
				'' AS dept_name, 
				b.emp_code AS emp_code, 
				b.emp_name AS emp_name, 
				'' AS vouch_date, 
				'' AS vouch_no, 
				'' as summary, 
				sum(nvl(a.debit, 0)) AS debit, 
				sum(nvl(avv.veri_money, 0)) AS ybal_amt, 
				'' AS state,
				'99999999' vouch_nos
 			from acc_vouch_check a
		    left join hos_emp_dict b on a.group_id = b.group_id
		    	and a.hos_id = b.hos_id 
		      	and a.check2_id = b.emp_id  
		      	<if test="show_history == 1">
					and a.check2_no = b.emp_no 
				</if>
				<if test="show_history == 0">
					and b.is_stop = 0
				</if>
		    left join hos_dept_dict hd on hd.group_id = b.group_id
		       	and hd.hos_id = b.hos_id 
		       	and hd.dept_id = b.dept_id
		       	and hd.dept_id = b.dept_id
		    	<if test="show_history == 1">
					and hd.dept_no = b.dept_no
				</if>
				<if test="show_history == 0">
					and hd.is_stop = 0
				</if>
		     left join acc_vouch_detail avd on a.group_id = avd.group_id 
		      	and a.hos_id = avd.hos_id 
		      	and a.copy_code = avd.copy_code 
		      	and a.acc_year = avd.acc_year
		      	and a.vouch_id = avd.vouch_id 
		      	and a.vouch_detail_id = avd.vouch_detail_id
		    left join acc_vouch av on av.group_id = avd.group_id 
		      	and av.hos_id = avd.hos_id 
		      	and av.copy_code = avd.copy_code 
		      	and av.acc_year = avd.acc_year
		      	and av.vouch_id = avd.vouch_id
			left join acc_vouch_type  f on f.group_id = av.group_id
				and f.hos_id = av.hos_id
			  	and f.copy_code = av.copy_code 
			  	and f.vouch_type_code=av.vouch_type_code
			left join (
				select check_id,group_id,hos_id,copy_code,acc_year,sum(veri_money) as veri_money from (
			    	select credit_check_id as check_id,group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money  
			    	from acc_vouch_veri 
			    	where  group_id = #{group_id,jdbcType=INTEGER}  
			        	and  hos_id = #{hos_id,jdbcType=INTEGER}  
			        	and  copy_code = #{copy_code,jdbcType=VARCHAR} 
			        	and  acc_year = #{acc_year,jdbcType=VARCHAR} 
			        	and  nvl(credit_check_id,0) != 0 
			        union
			        select debit_check_id as check_id, group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money 
			        from acc_vouch_veri 
			        where group_id = #{group_id,jdbcType=INTEGER}  
			        	and hos_id = #{hos_id,jdbcType=INTEGER}  
			       		and copy_code = #{copy_code,jdbcType=VARCHAR} 
			        	and acc_year = #{acc_year,jdbcType=VARCHAR} 
			        	and nvl(debit_check_id,0) != 0
			     ) aa  group by check_id,group_id,hos_id,copy_code,acc_year
			 ) avv on avv.group_id = a.group_id 
			 	and avv.hos_id = a.hos_id 
				and avv.copy_code = a.copy_code  
				and avv.acc_year = a.acc_year 
				and avv.check_id = a.vouch_check_id
			 where  a.group_id = #{group_id,jdbcType=INTEGER}  
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.hos_id = #{hos_id,jdbcType=INTEGER} 
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				and a.subj_code = #{subj_code,jdbcType=VARCHAR} 
				<if test="veriState ==2 ">
		        	and nvl(avv.veri_money,0) != 0
		        </if>
		        <if test="veriState == 1 ">
		        	and nvl(avv.veri_money,0) = 0
		        </if>
				<if test="dept_id != null and dept_id != ''">
					and b.dept_id = #{dept_id,jdbcType=INTEGER}
				</if>
				<if test="emp_id != null and emp_id != ''">
					and b.emp_id = #{emp_id,jdbcType=INTEGER}
				</if>
				and a.due_date = to_date(#{due_date},'yyyy/mm/dd') 
				and hd.dept_id is not null
		      	and hd.dept_no is not null
				${state}
				group by a.group_id,a.hos_id,a.copy_code,a.acc_year,b.emp_code,b.emp_name
		),sumAll_table as(
			SELECT 
				3 as idx,
				a.group_id as group_id,
				a.hos_id as hos_id,
				a.copy_code as copy_code,
				a.acc_year as acc_year,
				0 as check_id,
				'' AS dept_name, 
				'' AS emp_code, 
				'' AS emp_name, 
				'' AS vouch_date, 
				'' AS vouch_no, 
				'' as summary, 
				sum(nvl(a.debit, 0)) AS debit, 
				sum(nvl(avv.veri_money, 0)) AS ybal_amt, 
				'' AS state,
				'99999999' vouch_nos
 			from acc_vouch_check a
		    left join hos_emp_dict b on a.group_id = b.group_id
		    	and a.hos_id = b.hos_id 
		      	and a.check2_id = b.emp_id  
		      	<if test="show_history == 1">
					and a.check2_no = b.emp_no 
				</if>
				<if test="show_history == 0">
					and b.is_stop = 0
				</if>
		    left join hos_dept_dict hd on hd.group_id = b.group_id
		       	and hd.hos_id = b.hos_id 
		       	and hd.dept_id = b.dept_id
		       	and hd.dept_id = b.dept_id
		    	<if test="show_history == 1">
					and hd.dept_no = b.dept_no
				</if>
				<if test="show_history == 0">
					and hd.is_stop = 0
				</if>
		     left join acc_vouch_detail avd on a.group_id = avd.group_id 
		      	and a.hos_id = avd.hos_id 
		      	and a.copy_code = avd.copy_code 
		      	and a.acc_year = avd.acc_year
		      	and a.vouch_id = avd.vouch_id 
		      	and a.vouch_detail_id = avd.vouch_detail_id
		    left join acc_vouch av on av.group_id = avd.group_id 
		      	and av.hos_id = avd.hos_id 
		      	and av.copy_code = avd.copy_code 
		      	and av.acc_year = avd.acc_year
		      	and av.vouch_id = avd.vouch_id
			left join acc_vouch_type  f on f.group_id = av.group_id
				and f.hos_id = av.hos_id
			  	and f.copy_code = av.copy_code 
			  	and f.vouch_type_code=av.vouch_type_code
			left join (
				select check_id,group_id,hos_id,copy_code,acc_year,sum(veri_money) as veri_money from (
			    	select credit_check_id as check_id,group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money  
			    	from acc_vouch_veri 
			    	where  group_id = #{group_id,jdbcType=INTEGER}  
			        	and  hos_id = #{hos_id,jdbcType=INTEGER}  
			        	and  copy_code = #{copy_code,jdbcType=VARCHAR} 
			        	and  acc_year = #{acc_year,jdbcType=VARCHAR} 
			        	and  nvl(credit_check_id,0) != 0 
			        union
			        select debit_check_id as check_id, group_id,hos_id,copy_code,acc_year,nvl(veri_money,0) veri_money 
			        from acc_vouch_veri 
			        where group_id = #{group_id,jdbcType=INTEGER}  
			        	and hos_id = #{hos_id,jdbcType=INTEGER}  
			       		and copy_code = #{copy_code,jdbcType=VARCHAR} 
			        	and acc_year = #{acc_year,jdbcType=VARCHAR} 
			        	and nvl(debit_check_id,0) != 0
			     ) aa  group by check_id,group_id,hos_id,copy_code,acc_year
			 ) avv on avv.group_id = a.group_id 
			 	and avv.hos_id = a.hos_id 
				and avv.copy_code = a.copy_code  
				and avv.acc_year = a.acc_year 
				and avv.check_id = a.vouch_check_id
			 where  a.group_id = #{group_id,jdbcType=INTEGER}  
				and a.copy_code = #{copy_code,jdbcType=VARCHAR}
				and a.hos_id = #{hos_id,jdbcType=INTEGER} 
				and a.acc_year = #{acc_year,jdbcType=VARCHAR}
				and a.subj_code = #{subj_code,jdbcType=VARCHAR} 
				<if test="veriState ==2 ">
		        	and nvl(avv.veri_money,0) != 0
		        </if>
		        <if test="veriState == 1 ">
		        	and nvl(avv.veri_money,0) = 0
		        </if>
				<if test="dept_id != null and dept_id != ''">
					and b.dept_id = #{dept_id,jdbcType=INTEGER}
				</if>
				<if test="emp_id != null and emp_id != ''">
					and b.emp_id = #{emp_id,jdbcType=INTEGER}
				</if>
				and a.due_date = to_date(#{due_date},'yyyy/mm/dd') 
				${state}
				and hd.dept_id is not null
		      	and hd.dept_no is not null
				group by a.group_id,a.hos_id,a.copy_code,a.acc_year
		)
		
		select group_id,hos_id,copy_code,dept_name,emp_code,emp_name,vouch_date,vouch_no,summary,debit,ybal_amt,state,check_id ,idx
		from (
		    select group_id,hos_id,copy_code,acc_year,dept_name,emp_code,emp_name,vouch_date,vouch_no,summary,debit,ybal_amt,state,idx,check_id,vouch_nos
			from detail_table 
			union
			select group_id,hos_id,copy_code,acc_year,dept_name,emp_code,emp_name,vouch_date,vouch_no, '合计' summary,debit,ybal_amt,state,idx,check_id,vouch_nos
			from sum_table
			union
			select group_id,hos_id,copy_code,acc_year,dept_name,emp_code,emp_name,vouch_date,vouch_no, '总合计' summary,debit,ybal_amt,state,idx,check_id,vouch_nos
			from sumAll_table 
		)  t order by emp_code, idx, vouch_nos,check_id	
	</select>
</mapper>

