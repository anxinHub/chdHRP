<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.ass.dao.check.other.AssCheckSdetailOtherMapper">
	 
	<resultMap id="assCheckSdetailOther" type="com.chd.hrp.ass.entity.check.other.AssCheckSdetailOther">
	<result property="group_id" column="group_id"/>
	<result property="hos_id" column="hos_id"/>
	<result property="copy_code" column="copy_code"/>
	<result property="check_plan_no" column="check_plan_no"/>
	<result property="check_no" column="check_no"/>
	<result property="store_id" column="store_id"/>
	<result property="store_no" column="store_no"/>
	<result property="ass_card_no" column="ass_card_no"/>
	<result property="ass_id" column="ass_id"/>
	<result property="ass_no" column="ass_no"/>
	<result property="acc_amount" column="acc_amount"/>
	<result property="check_amount" column="check_amount"/>
	<result property="pl_amount" column="pl_amount"/>
	<result property="pl_reason" column="pl_reason"/>
	<result property="ass_type_name" column="ass_type_name"/>
	<result property="ass_name" column="ass_name"/>
	<result property="store_name" column="store_name"/>
	<result property="ass_ori_card_no" column="ass_ori_card_no"/>
	
	</resultMap>
		
	<resultMap id="assCheckSdetailOtherMap" type="java.util.Map">
	<result property="group_id" column="group_id"/>
	<result property="hos_id" column="hos_id"/>
	<result property="copy_code" column="copy_code"/>
	<result property="check_plan_no" column="check_plan_no"/>
	<result property="check_no" column="check_no"/>
	<result property="store_id" column="store_id"/>
	<result property="store_no" column="store_no"/>
	<result property="ass_card_no" column="ass_card_no"/>
	<result property="ass_id" column="ass_id"/>
	<result property="ass_no" column="ass_no"/>
	<result property="acc_amount" column="acc_amount"/>
	<result property="check_amount" column="check_amount"/>
	<result property="pl_amount" column="pl_amount"/>
	<result property="pl_reason" column="pl_reason"/>
		<result property="ass_type_name" column="ass_type_name"/>
	<result property="ass_name" column="ass_name"/>
	<result property="store_name" column="store_name"/>
	<result property="ass_ori_card_no" column="ass_ori_card_no"/>
	</resultMap>
	
	<insert id="add" useGeneratedKeys="true" >
	
		INSERT INTO ASS_CHECK_S_DETAIL_Other (
		<trim suffix="" suffixOverrides=",">
		<if test="group_id != null and group_id != ''">
		group_id
		,
		</if>
		<if test="hos_id != null and hos_id != ''">
		hos_id
		,
		</if>
		<if test="copy_code != null and copy_code != ''">
		copy_code
		,
		</if>
		<if test="check_plan_no != null and check_plan_no != ''">
		check_plan_no
		,
		</if>
		<if test="check_no != null and check_no != ''">
		check_no
		,
		</if>
		<if test="store_id != null and store_id != ''">
		store_id
		,
		</if>
		<if test="store_no != null and store_no != ''">
		store_no
		,
		</if>
		<if test="ass_card_no != null and ass_card_no != ''">
		ass_card_no
		,
		</if>
		<if test="ass_id != null and ass_id != ''">
		ass_id
		,
		</if>
		<if test="ass_no != null and ass_no != ''">
		ass_no
		,
		</if>
		<if test="acc_amount != null and acc_amount != ''">
		acc_amount
		,
		</if>
		<if test="check_amount != null and check_amount != ''">
		check_amount
		,
		</if>
		<if test="pl_amount != null and pl_amount != ''">
		pl_amount
		,
		</if>
		<if test="pl_reason != null and pl_reason != ''">
		pl_reason
		,
		</if>
		</trim>
		) VALUES (
		<trim suffix="" suffixOverrides=",">
		<if test="group_id != null and group_id != ''">
		#{group_id,jdbcType=INTEGER}
		,
		</if>
		<if test="hos_id != null and hos_id != ''">
		#{hos_id,jdbcType=INTEGER}
		,
		</if>
		<if test="copy_code != null and copy_code != ''">
		#{copy_code,jdbcType=VARCHAR}
		,
		</if>
		<if test="check_plan_no != null and check_plan_no != ''">
		#{check_plan_no,jdbcType=VARCHAR}
		,
		</if>
		<if test="check_no != null and check_no != ''">
		#{check_no,jdbcType=VARCHAR}
		,
		</if>
		<if test="store_id != null and store_id != ''">
		#{store_id,jdbcType=INTEGER}
		,
		</if>
		<if test="store_no != null and store_no != ''">
		#{store_no,jdbcType=INTEGER}
		,
		</if>
		<if test="ass_card_no != null and ass_card_no != ''">
		#{ass_card_no,jdbcType=VARCHAR}
		,
		</if>
		<if test="ass_id != null and ass_id != ''">
		#{ass_id,jdbcType=INTEGER}
		,
		</if>
		<if test="ass_no != null and ass_no != ''">
		#{ass_no,jdbcType=INTEGER}
		,
		</if>
		<if test="acc_amount != null and acc_amount != ''">
		#{acc_amount,jdbcType=INTEGER}
		,
		</if>
		<if test="check_amount != null and check_amount != ''">
		#{check_amount,jdbcType=INTEGER}
		,
		</if>
		<if test="pl_amount != null and pl_amount != ''">
		#{pl_amount,jdbcType=INTEGER}
		,
		</if>
		<if test="pl_reason != null and pl_reason != ''">
		#{pl_reason,jdbcType=VARCHAR}
		
		</if>
		</trim>		
		)
	
	</insert>
	<insert id="addBatch" parameterType="java.util.List" >
	
		INSERT INTO ASS_CHECK_S_DETAIL_Other (
		group_id
		,
		hos_id
		,
		copy_code
		,
		check_plan_no
		,
		check_no
		,
		store_id
		,
		store_no
		,
		ass_card_no
		,
		ass_id
		,
		ass_no
		,
		acc_amount
		,
		check_amount
		,
		pl_amount
		,
		pl_reason
		
		) select  t.* from(
		<foreach collection="list" item="item" index="index" separator=" union all " >
			select 		
			#{item.group_id,jdbcType=INTEGER}
			,
			#{item.hos_id,jdbcType=INTEGER}
			,
			#{item.copy_code,jdbcType=VARCHAR}
			,
			#{item.check_plan_no,jdbcType=VARCHAR}
			,
			#{item.check_no,jdbcType=VARCHAR}
			,
			#{item.store_id,jdbcType=INTEGER}
			,
			#{item.store_no,jdbcType=INTEGER}
			,
			#{item.ass_card_no,jdbcType=VARCHAR}
			,
			#{item.ass_id,jdbcType=INTEGER}
			,
			#{item.ass_no,jdbcType=INTEGER}
			,
			#{item.acc_amount,jdbcType=INTEGER}
			,
			#{item.check_amount,jdbcType=INTEGER}
			,
			#{item.pl_amount,jdbcType=INTEGER}
			,
			#{item.pl_reason,jdbcType=VARCHAR}
			
		    from dual
		</foreach>
		)t
	</insert>
	
	<update id="update" parameterType="java.util.Map">
	
		UPDATE ass_check_s_detail_Other 
		<trim prefix="SET"  suffixOverrides=","> 
		<if test="ass_id != null and ass_id != ''">
		ass_id = #{ass_id,jdbcType=INTEGER}
		,
		</if>
		<if test="ass_no != null and ass_no != ''">
		ass_no = #{ass_no,jdbcType=INTEGER}
		,
		</if>
		<if test="acc_amount != null and acc_amount != ''">
		acc_amount = #{acc_amount,jdbcType=INTEGER}
		,
		</if>
		<if test="check_amount != null and check_amount != ''">
		check_amount = #{check_amount,jdbcType=INTEGER}
		,
		</if>
		<if test="pl_amount != null and pl_amount != ''">
		pl_amount = #{pl_amount,jdbcType=INTEGER}
		,
		</if>
		<if test="pl_reason != null and pl_reason != ''">
		pl_reason = #{pl_reason,jdbcType=VARCHAR}
		,
		</if>
		</trim>
		where                    
		 group_id = #{group_id,jdbcType=INTEGER}
		AND hos_id = #{hos_id,jdbcType=INTEGER}
		AND copy_code = #{copy_code,jdbcType=VARCHAR}
		AND check_plan_no = #{check_plan_no,jdbcType=VARCHAR}
		AND check_no = #{check_no,jdbcType=VARCHAR}
		AND store_id = #{store_id,jdbcType=INTEGER}
		AND store_no = #{store_no,jdbcType=INTEGER}
		AND ass_card_no = #{ass_card_no,jdbcType=VARCHAR}
		
	</update>
	<update id="updateBatch" parameterType="java.util.List">
	
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			UPDATE ass_check_s_detail_Other 
			<trim prefix="SET"  suffixOverrides=","> 
			<if test="item.ass_id != null and item.ass_id != ''">
			ass_id = #{item.ass_id,jdbcType=INTEGER}
			,
			</if>
			<if test="item.ass_no != null and item.ass_no != ''">
			ass_no = #{item.ass_no,jdbcType=INTEGER}
			,
			</if>
			<if test="item.acc_amount != null and item.acc_amount != ''">
			acc_amount = #{item.acc_amount,jdbcType=INTEGER}
			,
			</if>
			<if test="item.check_amount != null and item.check_amount != ''">
			check_amount = #{item.check_amount,jdbcType=INTEGER}
			,
			</if>
			<if test="item.pl_amount != null and item.pl_amount != ''">
			pl_amount = #{item.pl_amount,jdbcType=INTEGER}
			,
			</if>
			<if test="item.pl_reason != null and item.pl_reason != ''">
			pl_reason = #{item.pl_reason,jdbcType=VARCHAR}
			,
			</if>
			</trim>
			where 
			 group_id = #{group_id,jdbcType=INTEGER}
				AND hos_id = #{hos_id,jdbcType=INTEGER}
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
				AND check_plan_no = #{check_plan_no,jdbcType=VARCHAR}
				AND check_no = #{check_no,jdbcType=VARCHAR}
				AND dept_id = #{dept_id,jdbcType=INTEGER}
				AND dept_no = #{dept_no,jdbcType=INTEGER}
				AND ass_card_no = #{ass_card_no,jdbcType=VARCHAR}
		</foreach>
	</update>
	
	<delete id="delete" parameterType="java.util.Map">
	
		DELETE FROM ass_check_s_detail_Other 
		where                  
		 group_id = #{group_id,jdbcType=INTEGER}
		AND hos_id = #{hos_id,jdbcType=INTEGER}
		AND copy_code = #{copy_code,jdbcType=VARCHAR}
		AND check_plan_no = #{check_plan_no,jdbcType=VARCHAR}
		AND check_no = #{check_no,jdbcType=VARCHAR}
		AND store_id = #{store_id,jdbcType=INTEGER}
		AND store_no = #{store_no,jdbcType=INTEGER}
			<if test="ass_card_no != null and ass_card_no != ''">
		and ass_card_no = #{ass_card_no,jdbcType=VARCHAR}
		</if>
		<if test="ass_card_no_all != null and ass_card_no_all != ''">
		and	 ass_card_no in ${ass_card_no_all}
		</if>
		
	</delete>
	<delete id="deleteBatch" parameterType="java.util.List">
		DELETE FROM ass_check_s_detail_Other 
		<where>
			<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
				 group_id = #{item.group_id,jdbcType=INTEGER}
				AND hos_id = #{item.hos_id,jdbcType=INTEGER}
				AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
				AND check_plan_no = #{item.check_plan_no,jdbcType=VARCHAR}
				<if test="item.check_no != null and item.check_no != ''">
				AND check_no = #{item.check_no,jdbcType=VARCHAR}
				</if>
				<if test="item.store_id != null and item.store_id != ''">
				AND store_id = #{item.store_id,jdbcType=INTEGER}
				</if>
				<if test="item.store_no != null and item.store_no != ''">
				AND store_no = #{item.store_no,jdbcType=INTEGER}
				</if>
				<if test="item.ass_card_no != null and item.ass_card_no != ''">
				AND ass_card_no = #{item.ass_card_no,jdbcType=VARCHAR}
				</if>
				
			</foreach>
	    </where>  
	</delete>
	<select id="query" parameterType="java.util.Map" resultMap="assCheckSdetailOther" >
	 SELECT 
		t1.group_id,
		t1.hos_id,
		t1.copy_code,
		t1.check_plan_no,
		t1.check_no,
		t1.store_id,
		t1.store_no,
		t1.ass_card_no,
		t1.ass_id,
		t1.ass_no,
		acc_amount,
		nvl(check_amount,0) check_amount,
		pl_amount,
		pl_reason,
		t5.ass_spec||' '||t5.ass_mondl ass_spec,
			t5.price,
			t5.ass_seq_no,
			t5.in_date,
    ass_name,
    ass_type_name,
    store_name,
    t5.ass_ori_card_no,
    t5.bar_code,
     case when t6.state = 0 then '新建' when t6.state = 1 then '审核'  else '' end state 
		FROM ASS_CHECK_S_DETAIL_Other t1
    left join ass_no_dict t2 on t1.group_id=t2.group_id and t1.hos_id=t2.hos_id and t1.copy_code=t2.copy_code and t1.ass_id
    =t2.ass_id and t1.ass_no=t2.ass_no and t2.is_stop=0
    left join ass_type_dict t3 on t3.group_id=t2.group_id and t3.hos_id=t2.hos_id and t3.copy_code=t2.copy_code and
     t3.ass_type_id=t2.ass_type_id and t3.is_last=1 and t3.is_stop=0
    left join hos_store_dict t4 on t1.group_id=t4.group_id and t1.hos_id=t4.hos_id and t1.store_id=t4.store_id and t1.store_no=t4.store_no
    and t4.is_stop=0 and t4.is_ass=1
    left join ass_card_Other t5 on t1.group_id=t5.group_id and t1.hos_id=t5.hos_id and t1.copy_code=t5.copy_code
    and t1.ass_card_no=t5.ass_card_no 
        left join ass_check_s_Other t6 on
     t1.group_id=t6.group_id
       and t1.hos_id = t6.hos_id
    and t1.copy_code = t6.copy_code
    and t1.check_plan_no=t6.check_plan_no
    and t1.check_no=t6.check_no
		where                    
		 t1.group_id = #{group_id,jdbcType=INTEGER}
		AND t1.hos_id = #{hos_id,jdbcType=INTEGER}
		AND t1.copy_code = #{copy_code,jdbcType=VARCHAR}
		AND t1.check_plan_no = #{check_plan_no,jdbcType=VARCHAR}
		<if test="check_no != null and check_no != ''">
		AND t1.check_no = #{check_no,jdbcType=VARCHAR}
		</if>
		<if test="store_id != null and store_id != ''">
		AND t1.store_id = #{store_id,jdbcType=INTEGER}
		</if>
		<if test="store_no != null and store_no != ''">
		AND t1.store_no = #{store_no,jdbcType=INTEGER}
		</if>
		<if test="ass_card_no != null and ass_card_no != ''">
		AND t1.ass_card_no = #{ass_card_no,jdbcType=VARCHAR}
		</if>
		<if test="ass_ori_card_no != null and ass_ori_card_no != ''">
		AND t5.ass_ori_card_no = #{ass_ori_card_no,jdbcType=VARCHAR}
		</if>
		<if test="bar_code != null and bar_code != ''">
		AND t5.bar_code = #{bar_code,jdbcType=VARCHAR}
		</if>
		<if test="ass_id != null and ass_id != ''">
		AND t1.ass_id = #{ass_id,jdbcType=INTEGER}
		</if>
		<if test="ass_id != null and ass_id != ''">
			and (
				t2.ass_code like '%${ass_id}%' or
				t2.ass_name like
				'%${ass_id}%'
				or
				t2.spell_code like '%${ass_id}%' or
				t2.wbx_code like
				'%${ass_id}%'
				)

		</if>
		<if test="ass_type_id != null and ass_type_id != ''">
		AND t3.ass_type_id = #{ass_type_id,jdbcType=INTEGER}
		</if>
		order by check_no desc
		
	</select>
	<select id="queryByCode" resultMap="assCheckSdetailOther"  parameterType="java.util.Map" >
	
		SELECT 
		group_id,
		hos_id,
		copy_code,
		check_plan_no,
		check_no,
		store_id,
		store_no,
		ass_card_no,
		ass_id,
		ass_no,
		acc_amount,
		check_amount,
		pl_amount,
		pl_reason
		FROM ass_check_s_detail_Other 
		WHERE 
		group_id = #{group_id,jdbcType=INTEGER}   and 
		hos_id = #{hos_id,jdbcType=INTEGER}   and 
		copy_code = #{copy_code,jdbcType=VARCHAR}   and 
		check_plan_no = #{check_plan_no,jdbcType=VARCHAR}   and 
		check_no = #{check_no,jdbcType=VARCHAR}   and 
		store_id = #{store_id,jdbcType=INTEGER}   and 
		store_no = #{store_no,jdbcType=INTEGER}   and 
		ass_card_no = #{ass_card_no,jdbcType=VARCHAR} 
	
	</select>
	<select id="queryByUniqueness" resultMap="assCheckSdetailOther"  parameterType="java.util.Map" >
	
		SELECT 
		group_id,
		hos_id,
		copy_code,
		check_plan_no,
		check_no,
		store_id,
		store_no,
		ass_card_no,
		ass_id,
		ass_no,
		acc_amount,
		check_amount,
		pl_amount,
		pl_reason
		FROM ASS_CHECK_S_DETAIL_Other 
		where                     
		 group_id = #{group_id,jdbcType=INTEGER}
		AND hos_id = #{hos_id,jdbcType=INTEGER}
		AND copy_code = #{copy_code,jdbcType=VARCHAR}
		AND check_plan_no = #{check_plan_no,jdbcType=VARCHAR}
		AND check_no = #{check_no,jdbcType=VARCHAR}
		AND store_id = #{store_id,jdbcType=INTEGER}
		AND store_no = #{store_no,jdbcType=INTEGER}
		AND ass_card_no = #{ass_card_no,jdbcType=VARCHAR}
		<if test="ass_id != null and ass_id != ''">
		AND ass_id = #{ass_id,jdbcType=INTEGER}
		</if>
		<if test="ass_no != null and ass_no != ''">
		AND ass_no = #{ass_no,jdbcType=INTEGER}
		</if>
		order by check_no desc
	</select>
	<select id="queryExists" resultMap="assCheckSdetailOther"  parameterType="java.util.Map" >
	
		SELECT 
		group_id,
		hos_id,
		copy_code,
		check_plan_no,
		check_no,
		store_id,
		store_no,
		ass_card_no,
		ass_id,
		ass_no,
		acc_amount,
		check_amount,
		pl_amount,
		pl_reason
		FROM ASS_CHECK_S_DETAIL_Other 
		where                     
		 group_id = #{group_id,jdbcType=INTEGER}
		AND hos_id = #{hos_id,jdbcType=INTEGER}
		AND copy_code = #{copy_code,jdbcType=VARCHAR}
		AND check_plan_no = #{check_plan_no,jdbcType=VARCHAR}
		AND check_no = #{check_no,jdbcType=VARCHAR}
		AND store_id = #{store_id,jdbcType=INTEGER}
		AND store_no = #{store_no,jdbcType=INTEGER}
		AND ass_card_no = #{ass_card_no,jdbcType=VARCHAR}
		<if test="ass_id != null and ass_id != ''">
		AND ass_id = #{ass_id,jdbcType=INTEGER}
		</if>
		<if test="ass_no != null and ass_no != ''">
		AND ass_no = #{ass_no,jdbcType=INTEGER}
		</if>
		order by check_no desc
	</select>
	
	<update id="copyAmount" parameterType="java.util.Map">
	BEGIN
	UPDATE ass_check_s_detail_Other SET check_amount=acc_amount  
	WHERE
		group_id = #{group_id,jdbcType=INTEGER} and
		hos_id = #{hos_id,jdbcType=INTEGER} and
		copy_code = #{copy_code,jdbcType=VARCHAR} and
		check_plan_no = #{check_plan_no,jdbcType=VARCHAR} and
		check_no = #{check_no,jdbcType=VARCHAR} and
		store_id = #{store_id,jdbcType=INTEGER} and
		store_no = #{store_no,jdbcType=INTEGER} 
		<if test="ass_card_no != null and ass_card_no != ''">
		and ass_card_no = #{ass_card_no,jdbcType=VARCHAR}
		</if>
		<if test="ass_card_no_all_o != null and ass_card_no_all_o != ''">
		and	 ass_card_no in ${ass_card_no_all_o}
		</if>
		;
	UPDATE ass_check_s_detail_Other SET pl_amount= acc_amount - check_amount
	WHERE
		group_id = #{group_id,jdbcType=INTEGER} and
		hos_id = #{hos_id,jdbcType=INTEGER} and
		copy_code = #{copy_code,jdbcType=VARCHAR} and
		check_plan_no = #{check_plan_no,jdbcType=VARCHAR} and
		check_no = #{check_no,jdbcType=VARCHAR} and
		store_id = #{store_id,jdbcType=INTEGER} and
		store_no = #{store_no,jdbcType=INTEGER} 
		<if test="ass_card_no != null and ass_card_no != ''">
		and ass_card_no = #{ass_card_no,jdbcType=VARCHAR}
		</if>
		<if test="ass_card_no_all_o != null and ass_card_no_all_o != ''">
		and	 ass_card_no in ${ass_card_no_all_o}
		</if>	
		;
		END;
	</update>
	
		<!-- 查询主表 -->
	<select id="queryAssInSpecialPrintTemlateByMain"  parameterType="java.util.Map" resultType="java.util.Map">
	select t1.check_no,t1.check_plan_no,t1.check_date,t1.store_no,t1.store_id,t1.summary,
  case when t1.state = 0 then '新建' when t1.state = 1 then '审核' else '' end state,t1.note,t1.store_no,t2.user_name,t4.store_name  from  ASS_CHECK_S_other  t1
 left join sys_user t2 on t1.group_id = t2.group_id
  and t1.hos_id = t2.hos_id
 and t1.check_emp = t2.user_id 
 left join hos_store_dict t4 on t1.group_id = t4.group_id
    and t1.hos_id = t4.hos_id
    and t1.store_id = t4.store_id
    and t1.store_no = t4.store_no
    and t4.is_stop = 0
    	where                     
			t1.group_id = #{group_id}
			AND t1.hos_id = #{hos_id}
			AND t1.copy_code = #{copy_code}
			AND t1.check_no = #{check_no}
	</select>
	<select id="queryAssInSpecialPrintTemlateByDetail" parameterType="java.util.Map" resultType="java.util.Map">
	select t1.ass_card_no,t1.check_amount,t1.ass_id,t1.ass_no,t1.pl_amount,t1.pl_reason,t1.acc_amount,t2.ass_name,t2.ass_code,t3.price,t3.ass_seq_no,t3.in_date,t3.price,t3.ass_seq_no,t3.in_date
  from  ASS_CHECK_S_DETAIL_other  t1
		 left join ass_dict t2 on 
		 t1.group_id = t2.group_id 
		 and t1.hos_id = t2.hos_id
		 and t1.ass_id=t2.ass_id
		 and t2.is_stop = 0
		  
		left join ass_card_other t3 on
		t1.group_id = t3.group_id
        and t1.hos_id = t3.hos_id
        and t1.copy_code = t3.copy_code
        and t1.ass_card_no = t3.ass_card_no  
		 
	where                     
			t1.group_id = #{group_id}
			AND t1.hos_id = #{hos_id}
			AND t1.copy_code = #{copy_code}
			AND t1.check_no in  (#{check_no,jdbcType=VARCHAR})
	
	</select>
		
	<!-- 状态查询  （打印时校验数据专用） -->
	<select id="queryAssInSpecialState" parameterType="java.util.Map" resultType="java.lang.String" >
		SELECT check_no  FROM ASS_CHECK_S_other 
		WHERE
			group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			<if test="check_no != null and check_no != ''">
			AND check_no in  (#{check_no,jdbcType=VARCHAR})
			</if>
		
			<!-- 前台传参   2 确认 -->
			and state != #{state,jdbcType=INTEGER}
	</select>
</mapper>

