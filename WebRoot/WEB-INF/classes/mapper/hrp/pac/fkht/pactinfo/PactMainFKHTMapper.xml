<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.pac.dao.fkht.pactinfo.PactMainFKHTMapper">
	<resultMap id="pactMainFKHT"
		type="com.chd.hrp.pac.entity.fkht.pactinfo.PactMainFKHTEntity">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="pact_code" column="pact_code" />
		<result property="pact_type_code" column="pact_type_code" />
		<result property="state_code" column="state_code" />
		<result property="pact_name" column="pact_name" />
		<result property="original_code" column="original_code" />
		<result property="master_pact_code" column="master_pact_code" />
		<result property="sign_date" column="sign_date" />
		<result property="dept_id" column="dept_id" />
		<result property="dept_no" column="dept_no" />
		<result property="emp_id" column="emp_id" />
		<result property="sup_id" column="sup_id" />
		<result property="sup_no" column="sup_no" />
		<result property="opp_emp" column="opp_emp" />
		<result property="opp_phone" column="opp_phone" />
		<result property="trade_type" column="trade_type" />
		<result property="curr_code" column="curr_code" />
		<result property="pact_money_w" column="pact_money_w" />
		<result property="pact_money" column="pact_money" />
		<result property="start_date" column="start_date" />
		<result property="end_date" column="end_date" />
		<result property="is_bid" column="is_bid" />
		<result property="organ_type" column="organ_type" />
		<result property="buy_type" column="buy_type" />
		<result property="is_deposit" column="is_deposit" />
		<result property="deposit_type" column="deposit_type" />
		<result property="deposit_money" column="deposit_money" />
		<result property="is_init" column="is_init" />
		<result property="state" column="state" />
		<result property="maker" column="maker" />
		<result property="make_date" column="make_date" />
		<result property="checker" column="checker" />
		<result property="check_date" column="check_date" />
		<result property="confirmer" column="confirmer" />
		<result property="confirm_date" column="confirm_date" />
		<result property="stoper" column="stoper" />
		<result property="stop_date" column="stop_date" />
		<result property="filer" column="filer" />
		<result property="file_date" column="file_date" />
		<result property="sup_name" column="sup_name" />
		<result property="dept_name" column="dept_name" />
		<result property="trade_name" column="trade_name" />
		<result property="state_code_name" column="state_code_name" />
		<result property="state_name" column="state_name" />
		<result property="proj_id" column="proj_id" />
		<result property="proj_no" column="proj_no" />
		
		<result property="delivery_term" column="delivery_term" />
		<result property="server" column="server" />
		<result property="ser_emp" column="ser_emp" />
		<result property="ser_phone" column="trade_name" />
		<result property="cont_term1" column="cont_term1" />
		<result property="cont_term2" column="cont_term2" />
		<result property="cont_term3" column="cont_term3" />
		<result property="cont_term4" column="cont_term4" />
		<result property="cont_term5" column="cont_term5" />
		<result property="cont_term6" column="cont_term6" />
		<result property="note" column="note" />
		<result property="bid_id" column="bid_id" />
		<result property="bid_code" column="bid_code" />
	</resultMap>
	<resultMap id="warningMap" type="java.util.Map">
		<result property="type_name" column="type_name" />
		<result property="pact_code" column="pact_code" />
		<result property="pact_name" column="pact_name" />
		<result property="sup_name" column="sup_name" />
		<result property="sign_date" column="sign_date" />
		<result property="dept_name" column="dept_name" />
		<result property="pay_money" column="pay_money" />
		<result property="pact_money" column="pact_money" />
		<result property="end_date" column="end_date" />
		<result property="warning_day" column="warning_day" />
		<result property="ret_money" column="ret_money" />
		<result property="ret_date" column="ret_date" />
		<result property="ret_plan_date" column="ret_plan_date" />
		<result property="warning_ret_day" column="warning_ret_day" />
		<result property="source_name" column="source_name" />
		<result property="pay_date" column="pay_date" />
		<result property="pay_id" column="pay_id" />
		<result property="plan_money" column="plan_money" />
		<result property="end_repair_date" column="end_repair_date" />
		<result property="repair_months" column="repair_months" />
		<result property="arrive_date" column="arrive_date" />
	</resultMap>
	<resultMap id="pactFKHT" type="java.util.Map">
		<result property="pact_code" column="pact_code" />
		<result property="pact_type_code" column="pact_type_code" />
		<result property="pact_name" column="pact_name" />
	</resultMap>
	<select id="query" parameterType="java.util.Map"
		resultMap="pactMainFKHT">
		SELECT
		m.PACT_CODE,
		m.PACT_NAME,
		m.SUP_ID,
		m.SUP_NO,
		hs.SUP_NAME,
		m.SIGN_DATE,
		m.DEPT_ID,
		m.DEPT_NO,
		d.DEPT_NAME,
		m.TRADE_TYPE,
		data.value_name as trade_name,
		m.PACT_MONEY,
		m.STATE_CODE,
		s.STATE_NAME as state_code_name,
		m.STATE,
		data2.value_name as state_name,
		m.emp_id,
		m.opp_emp,m.opp_phone,m.proj_id,
		m.delivery_term,
		m.server,
		m.ser_emp,
		m.ser_phone,
		m.cont_term1,
		m.cont_term2,
		m.cont_term3,
		m.cont_term4,
		m.cont_term5,
		m.cont_term6,
		m.note
		FROM PACT_MAIN_FKHT m
		LEFT JOIN HOS_SUP_DICT hs ON m.SUP_ID = hs.SUP_ID AND hs.GROUP_ID = m.GROUP_ID AND hs.HOS_ID = m.HOS_ID
		LEFT JOIN HOS_DEPT_DICT d ON m.dept_id = d.dept_id AND d.GROUP_ID = m.GROUP_ID AND d.HOS_ID = m.HOS_ID
		LEFT JOIN PACT_DICT_DATA data ON m.TRADE_TYPE = data.VALUE_CODE AND data.F_CODE = 'TRADE_TYPE'
		LEFT JOIN PACT_DICT_DATA data2 ON m.STATE = data2.VALUE_CODE AND data2.F_CODE = 'STATE'
		LEFT JOIN PACT_STATE s ON m.STATE_CODE = s.STATE_CODE AND s.GROUP_ID = m.GROUP_ID AND s.HOS_ID = m.HOS_ID AND s.COPY_CODE=m.COPY_CODE
		<where>
			m.group_id=#{group_id,jdbcType=NUMERIC}
			and m.hos_id=#{hos_id,jdbcType=NUMERIC}
			and m.copy_code=#{copy_code,jdbcType=VARCHAR}
			<if test="is_init != null and is_init != ''">
				and m.is_init=#{is_init,jdbcType=NUMERIC}
			</if>
			<if test="state_code != null and state_code != ''">
				and m.state_code=#{state_code,jdbcType=VARCHAR}
			</if>
			<if test="pact_type_code != null and pact_type_code != ''">
				and m.pact_type_code=#{pact_type_code,jdbcType=VARCHAR}
			</if>
			<if test="sup_no != null and sup_no != ''">
				and m.sup_no=#{sup_no,jdbcType=VARCHAR}
			</if>
			<if test="pact_code != null and pact_code != ''">
				and m.pact_code like upper(#{pact_code})||'%'
			</if>
			<if test="pact_name != null and pact_name != ''">
				and m.pact_name like '%'||#{pact_name}||'%'
			</if>
			<if test="trade_type != null and trade_type != ''">
				and m.trade_type=#{trade_type,jdbcType=VARCHAR}
			</if>
			<if test="state != null and state != ''">
				and m.state=#{state,jdbcType=NUMERIC}
			</if>
			<if test="start_date != null and start_date != '' and end_date != null and end_date != ''">
				and m.sign_date BETWEEN to_date(#{start_date,jdbcType=TIMESTAMP},'yyyy-MM-dd') AND to_date(#{end_date,jdbcType=TIMESTAMP},'yyyy-MM-dd')
			</if>
			<if test="min_money != null and min_money != '' and max_money != null and max_money != ''">
				and m.pact_money BETWEEN #{min_money,jdbcType=NUMERIC} AND #{max_money,jdbcType=NUMERIC}
			</if>
			<if test="max_money != null and max_money != ''">
				and #{max_money,jdbcType=NUMERIC} >= m.pact_money
			</if>
			<if test="min_money != null and min_money != ''">
				and m.pact_money >= #{min_money,jdbcType=NUMERIC} 
			</if>
		</where>
		ORDER BY m.PACT_CODE
	</select>
	
	<select id="queryPactMainFKHTForWarning" parameterType="java.util.Map"
		resultMap="warningMap">
		SELECT
			ptf.TYPE_NAME,pmf.PACT_CODE,pmf.PACT_NAME,hs.SUP_NAME,to_char(pmf.SIGN_DATE,'yyyy-MM-dd') as SIGN_DATE,hd.DEPT_NAME ,SUM(ppm.PAY_MONEY) as pay_money,pmf.PACT_MONEY,to_char(pmf.END_DATE,'yyyy-MM-dd') as END_DATE,ceil(TO_NUMBER(pmf.END_DATE-SYSDATE)) as warning_day
		FROM
			PACT_MAIN_FKHT pmf
			LEFT JOIN PACT_TYPE_FKHT ptf ON pmf.GROUP_ID = ptf.GROUP_ID AND pmf.HOS_ID=ptf.HOS_ID AND pmf.COPY_CODE=ptf.COPY_CODE AND pmf.PACT_TYPE_CODE=ptf.TYPE_CODE
			LEFT JOIN HOS_SUP_DICT hs ON pmf.GROUP_ID = hs.GROUP_ID AND pmf.HOS_ID = hs.HOS_ID AND pmf.SUP_ID = hs.SUP_ID
			LEFT JOIN HOS_DEPT hd ON pmf.GROUP_ID = hd.GROUP_ID AND pmf.HOS_ID = hd.HOS_ID AND pmf.DEPT_ID = hd.DEPT_ID
			LEFT JOIN PACT_PAY_MAIN_FKHT ppm ON pmf.GROUP_ID = ppm.GROUP_ID AND pmf.HOS_ID=ppm.HOS_ID AND pmf.COPY_CODE=ppm.COPY_CODE AND pmf.PACT_CODE=ppm.PACT_CODE
			LEFT JOIN HOS_EMP he ON pmf.GROUP_ID = he.GROUP_ID AND pmf.HOS_ID = he.HOS_ID AND pmf.EMP_ID = he.EMP_ID
			LEFT JOIN PACT_WARN_SET_FKHT wsf ON pmf.GROUP_ID = wsf.GROUP_ID AND pmf.HOS_ID=wsf.HOS_ID AND pmf.COPY_CODE=wsf.COPY_CODE AND pmf.PACT_TYPE_CODE=wsf.PACT_TYPE
		<where>
			pmf.group_id = #{group_id,jdbcType=NUMERIC}
			and pmf.hos_id = #{hos_id,jdbcType=NUMERIC}
			and pmf.copy_code = #{copy_code,jdbcType=VARCHAR}
			and pmf.state_code=#{state_code,jdbcType=VARCHAR}
			and pmf.state=#{state,jdbcType=VARCHAR}
			<if test="pact_type_code != null and pact_type_code != ''">
				and pmf.pact_type_code=#{pact_type_code,jdbcType=VARCHAR}
			</if>
			<if test="sup_no != null and sup_no != ''">
				and pmf.sup_no=#{sup_no,jdbcType= NUMERIC}
			</if>
			<if test="dept_no != null and dept_no != ''">
				and pmf.dept_no=#{dept_no,jdbcType=NUMERIC}
			</if>
			<if test="emp_id != null and emp_id != ''">
				and ( he.emp_id like '%'||#{emp_id}||'%' or he.emp_name like '%'||#{emp_id}||'%' )
			</if>
			<if test="pact_code != null and pact_code != ''">
				and pmf.pact_code like upper(#{pact_code})||'%'
			</if>
			<if test="pact_name != null and pact_name != ''">
				and pmf.pact_name like '%'||#{pact_name}||'%'
			</if>
			<if test="opp_emp != null and opp_emp != ''">
				and pmf.opp_emp like '%'||#{opp_emp}||'%'
			</if>
			<if test="start_date != null and start_date != '' and end_date != null and end_date != ''">
				and pmf.sign_date BETWEEN to_date(#{start_date,jdbcType=TIMESTAMP},'yyyy-MM-dd') AND to_date(#{end_date,jdbcType=TIMESTAMP},'yyyy-MM-dd')
			</if>
			<if test="warn_state == 0 and warn_state!= null and warn_state != ''" >
				and pmf.end_date > TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-dd'),'YYYY-MM-dd')
			</if>
			<if test="warn_state == 1">
				and pmf.end_date = TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-dd'),'YYYY-MM-dd')
			</if>
			<if test="warn_state == 2">
				and TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-dd'),'YYYY-MM-dd') > pmf.end_date  
			</if>
			and wsf.PACT_END_W > ceil(TO_NUMBER(pmf.END_DATE-SYSDATE)) 
		</where>
		GROUP BY ptf.TYPE_NAME,pmf.PACT_CODE,pmf.PACT_NAME,hs.SUP_NAME,pmf.SIGN_DATE,hd.DEPT_NAME ,pmf.PACT_MONEY,pmf.END_DATE
		ORDER BY pmf.PACT_CODE
	</select>
	
	<select id="queryPactMainFKHTForRetWarning" parameterType="java.util.Map"
		resultMap="warningMap">
		SELECT
			ptf.TYPE_NAME,pmf.PACT_CODE,pmf.PACT_NAME,hs.SUP_NAME,to_char(pmf.SIGN_DATE,'yyyy-MM-dd') as SIGN_DATE,hd.DEPT_NAME ,SUM(ppm.PAY_MONEY) as pay_money,pmf.PACT_MONEY,drf.MONEY as ret_money ,
			to_char(drf.REC_DATE,'yyyy-MM-dd') AS ret_date,to_char(drf.RET_PLAN_DATE,'yyyy-MM-dd') as ret_plan_date, 
			ceil(TO_NUMBER(drf.RET_PLAN_DATE-SYSDATE)) as warning_ret_day
		FROM
			PACT_MAIN_FKHT pmf
			LEFT JOIN PACT_TYPE_FKHT ptf ON pmf.GROUP_ID = ptf.GROUP_ID AND pmf.HOS_ID=ptf.HOS_ID AND pmf.COPY_CODE=ptf.COPY_CODE AND pmf.PACT_TYPE_CODE=ptf.TYPE_CODE
			LEFT JOIN HOS_SUP_DICT hs ON pmf.GROUP_ID = hs.GROUP_ID AND pmf.HOS_ID = hs.HOS_ID AND pmf.SUP_ID = hs.SUP_ID
			LEFT JOIN HOS_DEPT hd ON pmf.GROUP_ID = hd.GROUP_ID AND pmf.HOS_ID = hd.HOS_ID AND pmf.DEPT_ID = hd.DEPT_ID
			LEFT JOIN PACT_PAY_MAIN_FKHT ppm ON pmf.GROUP_ID = ppm.GROUP_ID AND pmf.HOS_ID=ppm.HOS_ID AND pmf.COPY_CODE=ppm.COPY_CODE AND pmf.PACT_CODE=ppm.PACT_CODE
			LEFT JOIN HOS_EMP he ON pmf.GROUP_ID = he.GROUP_ID AND pmf.HOS_ID = he.HOS_ID AND pmf.EMP_ID = he.EMP_ID
			LEFT JOIN PACT_DEP_REC_FKHT drf ON pmf.GROUP_ID = drf.GROUP_ID AND pmf.HOS_ID=drf.HOS_ID AND pmf.COPY_CODE=drf.COPY_CODE AND pmf.PACT_CODE=drf.PACT_CODE and drf.state = '03'
			LEFT JOIN PACT_WARN_SET_FKHT wsf ON pmf.GROUP_ID = wsf.GROUP_ID AND pmf.HOS_ID=wsf.HOS_ID AND pmf.COPY_CODE=wsf.COPY_CODE AND pmf.PACT_TYPE_CODE=wsf.PACT_TYPE
		<where>
			pmf.group_id = #{group_id,jdbcType=NUMERIC}
			and pmf.hos_id = #{hos_id,jdbcType=NUMERIC}
			and pmf.copy_code = #{copy_code,jdbcType=VARCHAR}
			and pmf.state_code=#{state_code,jdbcType=VARCHAR}
			and pmf.state=#{state,jdbcType=NUMERIC}
			and pmf.PACT_CODE in (
				SELECT rec.PACT_CODE from PACT_DEP_REC_FKHT rec
				LEFT JOIN PACT_DEP_RET_FKHT ret on rec.GROUP_ID = ret.GROUP_ID and rec.HOS_ID = ret.HOS_ID and rec.COPY_CODE = ret.COPY_CODE and rec.PACT_CODE = ret.PACT_CODE
				WHERE 
				rec.group_id = #{group_id,jdbcType=NUMERIC}
				and rec.hos_id = #{hos_id,jdbcType=NUMERIC}
				and rec.copy_code = #{copy_code,jdbcType=VARCHAR}
				and rec.state = '03'
				and NVL(rec.MONEY, 0) - NVL(ret.MONEY, 0)  >= 0
				MINUS 
				SELECT PACT_CODE from PACT_DEP_RET_FKHT 
				WHERE GROUP_ID = #{group_id,jdbcType=NUMERIC} 
				and HOS_ID = #{hos_id,jdbcType=NUMERIC}
				AND COPY_CODE = #{copy_code,jdbcType=VARCHAR}
				and STATE = '03'
			)
			<if test="pact_type_code != null and pact_type_code != ''">
				and pmf.pact_type_code=#{pact_type_code,jdbcType=VARCHAR}
			</if>
			<if test="sup_no != null and sup_no != ''">
				and pmf.sup_no=#{sup_no,jdbcType= NUMERIC}
			</if>
			<if test="dept_no != null and dept_no != ''">
				and pmf.dept_no=#{dept_no,jdbcType=NUMERIC}
			</if>
			<if test="emp_id != null and emp_id != ''">
				and (he.emp_id like '%'||#{emp_id}||'%' or he.emp_name like '%'||#{emp_id}||'%')
			</if>
			<if test="pact_code != null and pact_code != ''">
				and pmf.pact_code like upper(#{pact_code})||'%'
			</if>
			<if test="pact_name != null and pact_name != ''">
				and pmf.pact_name like '%'||#{pact_name}||'%'
			</if>
			<if test="opp_emp != null and opp_emp != ''">
				and pmf.opp_emp like '%'||#{opp_emp}||'%'
			</if>
			<if test="start_date != null and start_date != '' and end_date != null and end_date != ''">
				and pmf.sign_date BETWEEN to_date(#{start_date,jdbcType=TIMESTAMP},'yyyy-MM-dd') AND to_date(#{end_date,jdbcType=TIMESTAMP},'yyyy-MM-dd')
			</if>
			<if test="warn_state == 0 and warn_state != null and warn_state != ''">
				and drf.RET_PLAN_DATE > TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-dd'),'YYYY-MM-dd')
			</if>
			<if test="warn_state == 1">
				and drf.RET_PLAN_DATE = TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-dd'),'YYYY-MM-dd')
			</if>
			<if test="warn_state == 2">
				and TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-dd'),'YYYY-MM-dd') > drf.RET_PLAN_DATE
			</if>
			and wsf.DEPOSIT_RET_W > ceil(TO_NUMBER(drf.RET_PLAN_DATE-SYSDATE)) 
		</where>
		GROUP BY ptf.TYPE_NAME,pmf.PACT_CODE,pmf.PACT_NAME,hs.SUP_NAME,pmf.SIGN_DATE,hd.DEPT_NAME ,pmf.PACT_MONEY,drf.MONEY,drf.REC_DATE,drf.RET_PLAN_DATE
		ORDER BY pmf.PACT_CODE
	</select>
	<select id="queryPactMainFKHTForPayWarning" parameterType="java.util.Map"
		resultMap="warningMap">
		SELECT
			ptf.TYPE_NAME,pmf.PACT_CODE,pmf.PACT_NAME,hs.SUP_NAME,to_char(pmf.SIGN_DATE,'yyyy-MM-dd') as SIGN_DATE,hd.DEPT_NAME ,
			ppf.pay_id,hso.SOURCE_NAME,ppf.plan_money,
			to_char(ppf.PAY_DATE,'yyyy-MM-dd') as PAY_DATE,
			ceil(TO_NUMBER(ppf.PAY_DATE-SYSDATE)) as warning_day
		FROM
			PACT_MAIN_FKHT pmf
			LEFT JOIN PACT_TYPE_FKHT ptf ON pmf.GROUP_ID = ptf.GROUP_ID AND pmf.HOS_ID=ptf.HOS_ID AND pmf.COPY_CODE=ptf.COPY_CODE AND pmf.PACT_TYPE_CODE=ptf.TYPE_CODE
			LEFT JOIN HOS_SUP_DICT hs ON pmf.GROUP_ID = hs.GROUP_ID AND pmf.HOS_ID = hs.HOS_ID AND pmf.SUP_ID = hs.SUP_ID
			LEFT JOIN HOS_DEPT hd ON pmf.GROUP_ID = hd.GROUP_ID AND pmf.HOS_ID = hd.HOS_ID AND pmf.DEPT_ID = hd.DEPT_ID
			LEFT JOIN PACT_WARN_SET_FKHT wsf ON pmf.GROUP_ID = wsf.GROUP_ID AND pmf.HOS_ID=wsf.HOS_ID AND pmf.COPY_CODE=wsf.COPY_CODE AND pmf.PACT_TYPE_CODE=wsf.PACT_TYPE
			LEFT JOIN PACT_PLAN_FKHT ppf ON pmf.GROUP_ID = ppf.GROUP_ID AND pmf.HOS_ID = ppf.HOS_ID AND pmf.COPY_CODE=ppf.COPY_CODE AND pmf.PACT_CODE=ppf.PACT_CODE
			inner JOIN (
				select GROUP_ID,HOS_ID,COPY_CODE,PACT_CODE,PLAN_DETAIL_ID  from PACT_PLAN_FKHT 
				WHERE GROUP_ID = #{group_id,jdbcType=NUMERIC} 
				and hos_id = #{hos_id,jdbcType=NUMERIC}
				and copy_code = #{copy_code,jdbcType=VARCHAR}
				minus 
				select ppdf.GROUP_ID,ppdf.HOS_ID,ppdf.COPY_CODE,ppdf.PACT_CODE,ppdf.DETAIL_ID 
				from PACT_PAY_DET_FKHT ppdf
				LEFT JOIN PACT_PAY_MAIN_FKHT ppmf on ppdf.GROUP_ID= ppmf.GROUP_ID and ppdf.HOS_ID = ppmf.HOS_ID and ppdf.COPY_CODE = ppmf.COPY_CODE and ppdf.PACT_CODE = ppmf.PACT_CODE
				WHERE ppmf.group_id = #{group_id,jdbcType=NUMERIC}
				and ppmf.hos_id = #{hos_id,jdbcType=NUMERIC}
				and ppmf.copy_code = #{copy_code,jdbcType=VARCHAR}
				and ppmf.state= '03'
			) temp on temp.GROUP_ID = ppf.group_id and temp.hos_id = ppf.hos_id and temp.copy_code = ppf.copy_code and temp.pact_code = ppf.pact_code and temp.PLAN_DETAIL_ID = ppf.PLAN_DETAIL_ID 
			LEFT JOIN HOS_SOURCE hso ON ppf.GROUP_ID=hso.GROUP_ID AND ppf.HOS_ID=hso.HOS_ID AND hso.source_id = ppf.source_id
		<where>
			pmf.group_id = #{group_id,jdbcType=NUMERIC}
			and pmf.hos_id = #{hos_id,jdbcType=NUMERIC}
			and pmf.copy_code = #{copy_code,jdbcType=VARCHAR}
			and pmf.state_code=#{state_code,jdbcType=VARCHAR}
			and pmf.state=#{state,jdbcType=NUMERIC}
			<if test="pact_type_code != null and pact_type_code != ''">
				and pmf.pact_type_code=#{pact_type_code,jdbcType=VARCHAR}
			</if>
			<if test="sup_no != null and sup_no != ''">
				and pmf.sup_no=#{sup_no,jdbcType= NUMERIC}
			</if>
			<if test="dept_no != null and dept_no != ''">
				and pmf.dept_no=#{dept_no,jdbcType=NUMERIC}
			</if>
			<if test="hos_source != null and hos_source != ''">
				and ppf.source_id=#{hos_source,jdbcType=NUMERIC}
			</if>
			<if test="pact_code != null and pact_code != ''">
				and pmf.pact_code like upper(#{pact_code})||'%'
			</if>
			<if test="pact_name != null and pact_name != ''">
				and pmf.pact_name like '%'||#{pact_name}||'%'
			</if>
			<if test="opp_emp != null and opp_emp != ''">
				and pmf.opp_emp like '%'||#{opp_emp}||'%'
			</if>
			<if test="start_date != null and start_date != '' and end_date != null and end_date != ''">
				and pmf.sign_date BETWEEN to_date(#{start_date,jdbcType=TIMESTAMP},'yyyy-MM-dd') AND to_date(#{end_date,jdbcType=TIMESTAMP},'yyyy-MM-dd')
			</if>
			<if test="warn_state == '0'.toString()">
				and ppf.PAY_DATE > TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-dd'),'YYYY-MM-dd')
			</if>
			<if test="warn_state == 1">
				and ppf.PAY_DATE = TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-dd'),'YYYY-MM-dd')
			</if>
			<if test="warn_state == 2">
				and TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-dd'),'YYYY-MM-dd') > ppf.PAY_DATE
			</if>
			and wsf.PAY_W > ceil(TO_NUMBER(ppf.PAY_DATE-SYSDATE)) 
		</where>
		ORDER BY pmf.PACT_CODE
	</select>
	<select id="queryPactMainFKHTForNearRepairWarning" parameterType="java.util.Map"
		resultMap="warningMap">
		SELECT
			pmf.PACT_CODE,pmf.PACT_NAME,hs.SUP_NAME,to_char(pmf.SIGN_DATE,'yyyy-MM-dd') as SIGN_DATE,
			to_char(pdf.ARRIVE_DATE,'yyyy-MM-dd') as ARRIVE_DATE,pdf.REPAIR_MONTHS as repair_months,
			to_char(ADD_MONTHS(pdf.ARRIVE_DATE, pdf.REPAIR_MONTHS),'yyyy-MM-dd') as end_repair_date
		FROM
			PACT_MAIN_FKHT pmf
			LEFT JOIN HOS_SUP_DICT hs ON pmf.GROUP_ID = hs.GROUP_ID AND pmf.HOS_ID = hs.HOS_ID AND pmf.SUP_ID = hs.SUP_ID
			LEFT JOIN PACT_DET_FKHT pdf ON  pmf.GROUP_ID = pdf.GROUP_ID AND pmf.HOS_ID = pdf.HOS_ID AND pmf.COPY_CODE = pdf.COPY_CODE AND pmf.PACT_CODE = pdf.PACT_CODE
		<where>
			pmf.group_id = #{group_id,jdbcType=NUMERIC}
			and pmf.hos_id = #{hos_id,jdbcType=NUMERIC}
			and pmf.copy_code = #{copy_code,jdbcType=VARCHAR}
			and pmf.state_code=#{state_code,jdbcType=VARCHAR}
			and pmf.state=#{state,jdbcType=NUMERIC}
			<if test="pact_type_code != null and pact_type_code != ''">
				and pmf.pact_type_code=#{pact_type_code,jdbcType=VARCHAR}
			</if>
			<if test="sup_no != null and sup_no != ''">
				and pmf.sup_no=#{sup_no,jdbcType= NUMERIC}
			</if>
			<if test="dept_no != null and dept_no != ''">
				and pmf.dept_no=#{dept_no,jdbcType=NUMERIC}
			</if>
			<if test="hos_source != null and hos_source != ''">
				and ppf.source_id=#{hos_source,jdbcType=NUMERIC}
			</if>
			<if test="pact_code != null and pact_code != ''">
				and pmf.pact_code like upper(#{pact_code})||'%'
			</if>
			<if test="pact_name != null and pact_name != ''">
				and pmf.pact_name like '%'||#{pact_name}||'%'
			</if>
			<if test="opp_emp != null and opp_emp != ''">
				and pmf.opp_emp like '%'||#{opp_emp}||'%'
			</if>
			<if test="start_date != null and start_date != '' and end_date != null and end_date != ''">
				and pmf.sign_date BETWEEN to_date(#{start_date,jdbcType=TIMESTAMP},'yyyy-MM-dd') AND to_date(#{end_date,jdbcType=TIMESTAMP},'yyyy-MM-dd')
			</if>
			and #{warning_day} >= ceil(TO_NUMBER(ADD_MONTHS(pdf.ARRIVE_DATE, pdf.REPAIR_MONTHS)-SYSDATE)) 
			and ADD_MONTHS(pdf.ARRIVE_DATE, pdf.REPAIR_MONTHS) > SYSDATE 
		</where>
		ORDER BY pmf.PACT_CODE
	</select>
	
	<select id="queryByStateCode" parameterType="java.util.Map"
		resultMap="pactMainFKHT">
		SELECT
		m.PACT_CODE, m.PACT_NAME, m.SUP_ID, m.SUP_NO, hs.SUP_NAME, m.SIGN_DATE, m.DEPT_ID, m.DEPT_NO, d.DEPT_NAME, 
		m.TRADE_TYPE, m.PACT_MONEY,  m.STATE_CODE, m.STATE, m.emp_id, m.opp_emp, m.opp_phone,
		data.value_name as trade_name, 
		s.STATE_NAME as state_code_name,
		data2.value_name as state_name
		FROM PACT_MAIN_FKHT m
		LEFT JOIN HOS_SUP_DICT hs ON m.SUP_ID = hs.SUP_ID AND hs.GROUP_ID = m.GROUP_ID AND hs.HOS_ID = m.HOS_ID
		LEFT JOIN HOS_DEPT_DICT d ON m.dept_id = d.dept_id AND d.GROUP_ID = m.GROUP_ID AND d.HOS_ID = m.HOS_ID
		LEFT JOIN PACT_DICT_DATA data ON m.TRADE_TYPE = data.VALUE_CODE AND data.F_CODE = 'TRADE_TYPE'
		LEFT JOIN PACT_DICT_DATA data2 ON m.STATE = data2.VALUE_CODE AND data2.F_CODE = 'STATE'
		LEFT JOIN PACT_STATE s ON m.STATE_CODE = s.STATE_CODE AND s.GROUP_ID = m.GROUP_ID AND s.HOS_ID = m.HOS_ID AND s.COPY_CODE=m.COPY_CODE
		<where>
			m.group_id = #{group_id,jdbcType=NUMERIC}
			and m.hos_id = #{hos_id,jdbcType=NUMERIC}
			and m.copy_code = #{copy_code,jdbcType=VARCHAR}
			and m.state_code in
			<foreach collection="list" item="item" index="index" open="("
				close=")" separator=",">
				#{item}
			</foreach>
			<if test="pact_type_code != null and pact_type_code != ''">
				and m.pact_type_code=#{pact_type_code,jdbcType=VARCHAR}
			</if>
			<if test="sup_no != null and sup_no != ''">
				and m.sup_no=#{sup_no,jdbcType=VARCHAR}
			</if>
			<if test="pact_code != null and pact_code != ''">
				and m.pact_code like upper(#{pact_code})||'%'
			</if>
			<if test="pact_name != null and pact_name != ''">
				and m.pact_name like '%'||#{pact_name}||'%'
			</if>
			<if test="trade_type != null and trade_type != ''">
				and m.trade_type=#{trade_type,jdbcType=VARCHAR}
			</if>
			<if test="state != null and state != ''">
				and m.state=#{state,jdbcType=NUMERIC}
			</if>
			<if test="start_date != null and start_date != '' and end_date != null and end_date != ''">
				and m.sign_date BETWEEN to_date(#{start_date,jdbcType=TIMESTAMP},'yyyy-MM-dd') AND to_date(#{end_date,jdbcType=TIMESTAMP},'yyyy-MM-dd')
			</if>
			<if test="min_money != null and min_money != '' and max_money != null and max_money != ''">
				and m.pact_money BETWEEN #{min_money,jdbcType=NUMERIC} AND #{max_money,jdbcType=NUMERIC}
			</if>
			<if test="max_money != null and max_money != ''">
				and #{max_money,jdbcType=NUMERIC} >= m.pact_money
			</if>
			<if test="min_money != null and min_money != ''">
				and m.pact_money >= #{min_money,jdbcType=NUMERIC} 
			</if>
		</where>
		ORDER BY m.PACT_CODE
	</select>

	<select id="queryByCode" parameterType="java.util.Map"		resultMap="pactMainFKHT">
		SELECT
			a.PACT_CODE,a.PACT_TYPE_CODE,a.STATE_CODE,a.PACT_NAME,a.ORIGINAL_CODE,a.MASTER_PACT_CODE,a.SIGN_DATE,a.DEPT_ID,a.DEPT_NO,a.EMP_ID,
			a.sup_id,a.SUP_NO,a.OPP_EMP,a.OPP_PHONE,a.TRADE_TYPE,a.CURR_CODE,a.PACT_MONEY_W,a.PACT_MONEY,a.START_DATE,
			a.END_DATE,a.IS_BID,a.ORGAN_TYPE,a.BUY_TYPE,a.IS_DEPOSIT,a.DEPOSIT_TYPE,a.DEPOSIT_MONEY,a.IS_INIT,
			a.STATE,a.proj_id,a.proj_no,a.DELIVERY_TERM,a.SERVER,a.SER_EMP,a.SER_PHONE,a.CONT_TERM1,a.CONT_TERM2,a.CONT_TERM3,
			a.CONT_TERM4,a.CONT_TERM5,	a.CONT_TERM6, a.NOTE,a.BID_ID, b.bid_code
		FROM
			PACT_MAIN_FKHT a
		left join ASS_TEND_MAIN b
			on
				a.group_id = b.group_id
				and a.hos_id = b.hos_id
				and a.copy_code = b.copy_code
				and a.bid_id = b.bid_id
		WHERE
			a.group_id = #{group_id,jdbcType=NUMERIC}
		and a.hos_id = #{hos_id,jdbcType=NUMERIC}
		and a.copy_code = #{copy_code,jdbcType=VARCHAR}
		and a.pact_code = #{pact_code,jdbcType=VARCHAR}
	</select>
	<!--  变更页面 链接合同查看 数据查询（查询备份表数据) -->
	<select id="queryByCodeCopy" parameterType="java.util.Map"		resultMap="pactMainFKHT">
		SELECT
			a.PACT_CODE,a.PACT_TYPE_CODE,a.STATE_CODE,a.PACT_NAME,a.ORIGINAL_CODE,a.MASTER_PACT_CODE,a.SIGN_DATE,a.DEPT_ID,a.DEPT_NO,a.EMP_ID,
			a.sup_id,a.SUP_NO,a.OPP_EMP,a.OPP_PHONE,a.TRADE_TYPE,a.CURR_CODE,a.PACT_MONEY_W,a.PACT_MONEY,a.START_DATE,
			a.END_DATE,a.IS_BID,a.ORGAN_TYPE,a.BUY_TYPE,a.IS_DEPOSIT,a.DEPOSIT_TYPE,a.DEPOSIT_MONEY,a.IS_INIT,
			a.STATE,a.proj_id,a.proj_no,a.DELIVERY_TERM,a.SERVER,a.SER_EMP,a.SER_PHONE,a.CONT_TERM1,a.CONT_TERM2,a.CONT_TERM3,
			a.CONT_TERM4,a.CONT_TERM5,	a.CONT_TERM6, a.NOTE,a.BID_ID, b.bid_code
		FROM
			PACT_MAIN_FKHT_C a
		left join ASS_TEND_MAIN b
			on
				a.group_id = b.group_id
				and a.hos_id = b.hos_id
				and a.copy_code = b.copy_code
				and a.bid_id = b.bid_id
		WHERE
			a.group_id = #{group_id,jdbcType=NUMERIC}
		and a.hos_id = #{hos_id,jdbcType=NUMERIC}
		and a.copy_code = #{copy_code,jdbcType=VARCHAR}
		and a.pact_code = #{pact_code,jdbcType=VARCHAR}
		and a.change_code = #{change_code,jdbcType=VARCHAR}
	</select>
	
	<select id="queryForDepRec" parameterType="java.util.Map"
		resultType="java.util.Map">
		SELECT
		mf.END_DATE+0 as "end_date",
		mf.DEPOSIT_MONEY as "deposit_money",
		tf.START_DATE as "start_date",
		mf.pact_type_code as "pact_type_code"
		FROM
		PACT_MAIN_FKHT mf
		LEFT JOIN PACT_TYPE_FKHT tf ON mf.GROUP_ID = tf.GROUP_ID AND mf.HOS_ID = tf.HOS_ID AND mf.COPY_CODE = tf.COPY_CODE AND mf.PACT_TYPE_CODE = tf.TYPE_CODE
		WHERE
		mf.group_id=#{group_id,jdbcType=NUMERIC}
		AND mf.hos_id=#{hos_id,jdbcType=NUMERIC}
		AND mf.copy_code = #{copy_code,jdbcType=VARCHAR}
		AND mf.pact_code = #{pact_code,jdbcType=VARCHAR}
	</select>
	
	<select id="queryPactFKHTSelectForLetter"
		parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
		mf.pact_code AS "id",
		mf.pact_name AS "text",
		mf.pact_name AS "label"
		FROM
		PACT_MAIN_FKHT mf
		WHERE
		mf.group_id=#{group_id,jdbcType=NUMERIC}
		AND mf.hos_id=#{hos_id,jdbcType=NUMERIC}
		AND mf.copy_code=#{copy_code,jdbcType=VARCHAR}
		<if test="state != null and state != ''">
			and mf.state=#{state,jdbcType=NUMERIC}
		</if>
		<if test="state_code != null and state_code != ''">
			and mf.state_code=#{state_code,jdbcType=VARCHAR}
		</if>
		<if test="deposit_type != null and deposit_type != ''">
			and mf.deposit_type=#{deposit_type,jdbcType=VARCHAR}
		</if>
		<if test="sup_no != null and sup_no != ''">
			and mf.sup_no=#{sup_no,jdbcType=NUMERIC}
		</if>
		and mf.pact_code not in(
			select lf.pact_code from PACT_LETTER_FKHT lf 
			where 
			lf.group_id=#{group_id,jdbcType=NUMERIC}
			AND lf.hos_id=#{hos_id,jdbcType=NUMERIC}
			AND lf.copy_code=#{copy_code,jdbcType=VARCHAR}
		)
	</select>

	<insert id="add" parameterType="java.util.Map">
		INSERT INTO PACT_MAIN_FKHT (
		GROUP_ID, HOS_ID, COPY_CODE, PACT_CODE, PACT_TYPE_CODE, STATE_CODE,
		PACT_NAME, ORIGINAL_CODE, MASTER_PACT_CODE, SIGN_DATE, DEPT_ID,
		DEPT_NO, EMP_ID, SUP_ID, SUP_NO, OPP_EMP, OPP_PHONE,
		TRADE_TYPE, CURR_CODE, PACT_MONEY_W, PACT_MONEY,
		START_DATE, END_DATE, IS_BID,
		ORGAN_TYPE, BUY_TYPE, IS_DEPOSIT, DEPOSIT_TYPE, DEPOSIT_MONEY,
		IS_INIT, STATE, MAKER, MAKE_DATE, CHECKER, CHECK_DATE,
		CONFIRMER, CONFIRM_DATE, STOPER, STOP_DATE, FILER, FILE_DATE,PROJ_ID,PROJ_NO,
		DELIVERY_TERM, SERVER,	SER_EMP, SER_PHONE,	CONT_TERM1,CONT_TERM2,	CONT_TERM3,
		CONT_TERM4,CONT_TERM5,	CONT_TERM6, NOTE,BID_ID
		)
		VALUES(
		#{group_id,jdbcType=NUMERIC},
		#{hos_id,jdbcType=NUMERIC},
		#{copy_code,jdbcType=VARCHAR},
		#{pact_code,jdbcType=VARCHAR},
		#{pact_type_code,jdbcType=VARCHAR},
		#{state_code,jdbcType=VARCHAR},
		#{pact_name,jdbcType=VARCHAR},
		#{original_code,jdbcType=VARCHAR},
		#{master_pact_code,jdbcType=VARCHAR},
		to_date(#{sign_date,jdbcType=TIMESTAMP},'yyyy-MM-dd'),
		#{dept_id,jdbcType=NUMERIC},
		#{dept_no,jdbcType=NUMERIC},
		#{emp_id,jdbcType=NUMERIC},
		#{sup_id,jdbcType=NUMERIC},
		#{sup_no,jdbcType=NUMERIC},
		#{opp_emp,jdbcType=VARCHAR},
		#{opp_phone,jdbcType=VARCHAR},
		#{trade_type,jdbcType=VARCHAR},
		#{curr_code,jdbcType=VARCHAR},
		#{pact_money_w,jdbcType=NUMERIC},
		#{pact_money,jdbcType=NUMERIC},
		to_date(#{start_date,jdbcType=TIMESTAMP},'yyyy-MM-dd'),
		to_date(#{end_date,jdbcType=TIMESTAMP},'yyyy-MM-dd'),
		#{is_bid,jdbcType=NUMERIC},
		#{organ_type,jdbcType=VARCHAR},
		#{buy_type,jdbcType=VARCHAR},
		#{is_deposit,jdbcType=NUMERIC},
		#{deposit_type,jdbcType=VARCHAR},
		#{deposit_money,jdbcType=NUMERIC},
		#{is_init,jdbcType=NUMERIC},
		#{state,jdbcType=NUMERIC},
		#{maker,jdbcType=NUMERIC},
		to_date(#{make_date,jdbcType=TIMESTAMP},'yyyy-MM-dd'),
		#{checker,jdbcType=NUMERIC},
		to_date(#{check_date,jdbcType=TIMESTAMP},'yyyy-MM-dd'),
		#{confirmer,jdbcType=NUMERIC},
		to_date(#{confirm_date,jdbcType=TIMESTAMP},'yyyy-MM-dd'),
		#{stoper,jdbcType=NUMERIC},
		to_date(#{stop_date,jdbcType=TIMESTAMP},'yyyy-MM-dd'),
		#{filer,jdbcType=NUMERIC},
		to_date(#{file_date,jdbcType=TIMESTAMP},'yyyy-MM-dd'),
		#{proj_id},
		#{proj_no},
		#{delivery_term}, 
		#{server},	
		#{ser_emp}, 
		#{ser_phone},	
		#{cont_term1},
		#{cont_term2},	
		#{cont_term3},
		#{cont_term4},
		#{cont_term5},	
		#{cont_term6}, 
		#{note},
		#{bid_id}
		)
	</insert>

	<update id="update" parameterType="java.util.Map">
		UPDATE PACT_MAIN_FKHT SET
		<if test="state_code != null and state_code != ''">
			state_code=#{state_code,jdbcType=VARCHAR},
		</if>
		<if test="pact_name != null and pact_name != ''">
			pact_name=#{pact_name,jdbcType=VARCHAR},
		</if>
		<if test="original_code != null and original_code != ''">
			original_code=#{original_code,jdbcType=VARCHAR},
		</if>
			master_pact_code=#{master_pact_code,jdbcType=VARCHAR},
		<if test="sign_date != null and sign_date != ''">
			sign_date=to_date(#{sign_date,jdbcType=TIMESTAMP},'yyyy-MM-dd'),
		</if>
		<if test="dept_id != null and dept_id != ''">
			dept_id=#{dept_id,jdbcType=NUMERIC},
		</if>
		<if test="dept_no != null and dept_no != ''">
			dept_no=#{dept_no,jdbcType=NUMERIC},
		</if>
		<if test="emp_id != null and emp_id != ''">
			emp_id=#{emp_id,jdbcType=NUMERIC},
		</if>
		<if test="sup_id != null and sup_id != ''">
			sup_id=#{sup_id,jdbcType=NUMERIC},
		</if>
		<if test="sup_no != null and sup_no != ''">
			sup_no=#{sup_no,jdbcType=NUMERIC},
		</if>
		<if test="opp_emp != null and opp_emp != ''">
			opp_emp=#{opp_emp,jdbcType=VARCHAR},
		</if>
		<if test="curr_code != null and curr_code != ''">
			curr_code=#{curr_code,jdbcType=VARCHAR},
		</if>
			pact_money_w=#{pact_money_w,jdbcType=NUMERIC},
		<if test="pact_money != null and pact_money != ''">
			pact_money=#{pact_money,jdbcType=NUMERIC},
		</if>
		<if test="start_date != null and start_date != ''">
			start_date=to_date(#{start_date,jdbcType=TIMESTAMP},'yyyy-MM-dd'),
		</if>
		<if test="end_date != null and end_date != ''">
			end_date=to_date(#{end_date,jdbcType=TIMESTAMP},'yyyy-MM-dd'),
		</if>
		<if test="state != null and state != ''">
			state=#{state,jdbcType=NUMERIC},
		</if>
		trade_type=#{trade_type,jdbcType=VARCHAR},
		organ_type=#{organ_type,jdbcType=VARCHAR},
		buy_type=#{buy_type,jdbcType=VARCHAR},
		deposit_type=#{deposit_type,jdbcType=VARCHAR},
		deposit_money=#{deposit_money,jdbcType=NUMERIC},
		proj_id =#{proj_id},
		proj_no =#{proj_no},
		opp_phone=#{opp_phone,jdbcType=VARCHAR},
		is_deposit=#{is_deposit,jdbcType=NUMERIC},
		is_bid=#{is_bid,jdbcType=NUMERIC},
		delivery_term = #{delivery_term}, 
		server = #{server},	
		ser_emp = #{ser_emp}, 
		ser_phone = #{ser_phone},	
		cont_term1 = #{cont_term1},
		cont_term2 = #{cont_term2},	
		cont_term3 = #{cont_term3},
		cont_term4 = #{cont_term4},
		cont_term5 = #{cont_term5},	
		cont_term6 = #{cont_term6}, 
		note = #{note}
		WHERE
		GROUP_ID = #{group_id,jdbcType=NUMERIC}
		AND HOS_ID = #{hos_id,jdbcType=NUMERIC}
		AND COPY_CODE = #{copy_code,jdbcType=VARCHAR}
		AND pact_code = #{pact_code,jdbcType=VARCHAR}
		and is_init = #{is_init,jdbcType=NUMERIC}
	</update>
	
	<update id="updateState" parameterType="java.util.Map">
		UPDATE PACT_MAIN_FKHT SET
		<if test="state_code != null and state_code != ''">
			state_code=#{state_code,jdbcType=VARCHAR},
		</if>
		<if test="checker != null and checker != ''">
			checker=#{checker,jdbcType=NUMERIC},
		</if>
		<if test="check_date != null and check_date != ''">
			check_date=#{check_date,jdbcType=TIMESTAMP},
		</if>
		<if test="confirmer != null and confirmer != ''">
			confirmer=#{confirmer,jdbcType=NUMERIC},
		</if>
		<if test="confirm_date != null and confirm_date != ''">
			confirm_date=#{confirm_date,jdbcType=TIMESTAMP},
		</if>
		<if test="stoper != null and stoper != ''">
			stoper=#{stoper,jdbcType=NUMERIC},
		</if>
		<if test="stop_date != null and stop_date != ''">
			stop_date=#{stop_date,jdbcType=TIMESTAMP},
		</if>
		<if test="filer != null and filer != ''">
			filer=#{filer,jdbcType=NUMERIC},
		</if>
		<if test="file_date != null and file_date != ''">
			file_date=#{file_date,jdbcType=TIMESTAMP},
		</if>
		state=#{state,jdbcType=NUMERIC}
		WHERE
		GROUP_ID = #{group_id,jdbcType=NUMERIC}
		AND HOS_ID = #{hos_id,jdbcType=NUMERIC}
		AND COPY_CODE = #{copy_code,jdbcType=VARCHAR}
		AND pact_code in
		<foreach collection="list" item="item" index="index" open="("
			close=")" separator=",">
			#{item,jdbcType=VARCHAR}
		</foreach>
	</update>

	<delete id="deleteAllBatch">
		DELETE FROM PACT_MAIN_FKHT
		<where>
			<foreach collection="list" index="index" item="item" open="("
				separator="or" close=")">
				GROUP_ID = #{item.group_id,jdbcType=NUMERIC}
				and HOS_ID = #{item.hos_id,jdbcType=NUMERIC}
				AND COPY_CODE = #{item.copy_code,jdbcType=VARCHAR}
				AND pact_code = #{item.pact_code,jdbcType=VARCHAR}
			</foreach>
		</where>
	</delete>
	
	<!-- 引入资产购置申请查询 -->
	<select id="queryPactAssApplyFKHT" parameterType="java.util.Map" resultType="java.util.Map">
		with temp as (
		    select group_id , hos_id , copy_code , apply_id , apply_det_id, nvl(sum(pact_amount),0) pact_amount
		    from pact_ass_apply_fkht 
		    where group_id = ${group_id} and hos_id = ${hos_id} and copy_code = ${copy_code}
		    group by  group_id , hos_id , copy_code , apply_id , apply_det_id
		)

		SELECT  2 source ,  a.apply_id,  a.apply_no,  a.detail_id apply_det_id,  b.create_date, a.emp_dept_id dept_id, 
			case nvl(a.emp_dept_id,-1) when -1 then null else a.emp_dept_id || '@' ||a.emp_dept_no end dept_no,
			hdd.dept_code , hdd.dept_name , a.ass_id subject_id , a.ass_no subject_no , c.ass_code subject_code , c.ass_name subject_name ,
			c.ass_name item_name ,a.ass_model item_model, a.ass_spec item_spec,a.fac_id , a.fac_no , d.fac_code , d.fac_name , 
			a.ass_brand as item_brand, a.features_req ,g.unit_name,g.unit_code, a.apply_amount ,  a.budg_price price, nvl(e.pact_amount,0) pact_amount , 
		    (a.apply_amount - nvl(e.pact_amount,0)) left_amount , a.proj_id , a.proj_no , f.proj_code , f.proj_name,
		    (a.apply_amount - nvl(e.pact_amount,0)) amount  , a.budg_price*(a.apply_amount - nvl(e.pact_amount,0)) money
	    FROM ass_apply_dept_detail a
	    left join ass_apply_dept b
	      on
	          a.group_id = b.group_id
	          and a.hos_id = b.hos_id
	          and a.copy_code = b.copy_code
	          and a.apply_id = b.apply_id
	     left join ass_no_dict c
	     	on
	          a.group_id = c.group_id
	          and a.hos_id = c.hos_id
	          and a.copy_code = c.copy_code
	          and a.ass_id = c.ass_id
	          and a.ass_no = c.ass_no
	     left join hos_fac_dict d
	     	on
	          a.group_id = d.group_id
	          and a.hos_id = d.hos_id
	          and a.fac_id = d.fac_id
	          and a.fac_no = d.fac_no
	     left join temp e
	      	on
	          a.group_id = e.group_id
	          and a.hos_id = e.hos_id
	          and a.copy_code = e.copy_code
	          and a.apply_id = e.apply_id
	          and a.detail_id = e.apply_det_id
	     left join hos_proj_dict f
	     	on
	          a.group_id = f.group_id
	          and a.hos_id = f.hos_id
	          and a.proj_id = f.proj_id
	          and a.proj_no = f.proj_no
	     left join hos_dept_dict hdd
	     	on a.group_id = hdd.group_id
	          and a.hos_id = hdd.hos_id
	          and a.emp_dept_id = hdd.dept_id
	          and a.emp_dept_no = hdd.dept_no
	     left join hos_unit g on c.ass_unit = g.unit_code
			  and a.group_id = g.group_id
		      and a.hos_id = g.hos_id
		where
			a.group_id=#{group_id,jdbcType=NUMERIC}
			and a.hos_id=#{hos_id,jdbcType=NUMERIC}
			and a.copy_code=#{copy_code,jdbcType=VARCHAR}
			and b.state = 1
			and a.apply_amount - nvl(e.pact_amount,0) > 0
			<if test="start_date != null and start_date != '' and end_date != null and end_date != ''">
				and b.b.create_date BETWEEN to_date(#{start_date,jdbcType=TIMESTAMP},'yyyy-MM-dd') AND to_date(#{end_date,jdbcType=TIMESTAMP},'yyyy-MM-dd')
			</if>
			<if test="dept_id != null and dept_id != ''">
				and b.dept_id = #{dept_id,jdbcType=NUMERIC} 
			</if>
			<if test="apply_no != null and apply_no != ''">
				and a.apply_no like #{apply_no,jdbcType=VARCHAR}||'%'
			</if>
			<if test="proj_id != null and proj_id != ''">
				and a.proj_id = #{proj_id,jdbcType=NUMERIC} 
			</if>
			<if test="emp_dept_id != null and emp_dept_id != ''">
				and a.emp_dept_id = #{emp_dept_id,jdbcType=NUMERIC} 
			</if>
			<if test="ass_id != null and ass_id != ''">
				and a.ass_id = #{ass_id,jdbcType=NUMERIC} 
			</if>
			<if test="fac_id != null and fac_id != ''">
				and a.fac_id = #{fac_id,jdbcType=NUMERIC} 
			</if>
		ORDER BY a.apply_no
	</select>
	
	<!-- 引入招标查询 -->
	<select id="queryPactBidFKHT" parameterType="java.util.Map" resultType="java.util.Map">
		with temp as (
		    select group_id , hos_id , copy_code , bid_id , bid_det_id, nvl(sum(pact_amount),0) pact_amount
		    from pact_bid_fkht 
		    where group_id = ${group_id} and hos_id = ${hos_id} and copy_code = ${copy_code}
		    group by  group_id , hos_id , copy_code , bid_id , bid_det_id
		)

		SELECT  1 source ,  a.bid_id,  a.detail_id bid_det_id,  a.bidd_usedept dept_id, 
			case nvl(a.bidd_usedept,-1) when -1 then null else a.bidd_usedept || '@' ||hdd.dept_no end dept_no,
			hdd.dept_code , hdd.dept_name , a.ass_id subject_id , a.ass_no subject_no , c.ass_code subject_code , c.ass_name subject_name ,
			c.ass_name item_name ,a.ass_model item_model, a.ass_spec item_spec,a.fac_id , d.fac_no , d.fac_code , d.fac_name , 
			a.ass_brand as item_brand , g.unit_name ,g.unit_code, a.bidd_no apply_amount,  a.bidd_price price, nvl(e.pact_amount,0) pact_amount , 
		    (a.bidd_no - nvl(e.pact_amount,0)) left_amount , f.proj_no , f.proj_code , f.proj_name,
		    (a.bidd_no - nvl(e.pact_amount,0)) amount  , a.bidd_price*(a.bidd_no - nvl(e.pact_amount,0)) money,
		    bidd_budgreachdate as arrive_date
	    FROM ass_tend_detail a
	    left join ass_tend_main b
	    	on
	    		a.group_id = b.group_id
	          and a.hos_id = b.hos_id
	          and a.copy_code = b.copy_code
	          and a.bid_id = b.bid_id
	    left join ass_no_dict c
	     	on
	          a.group_id = c.group_id
	          and a.hos_id = c.hos_id
	          and a.copy_code = c.copy_code
	          and a.ass_id = c.ass_id
	          and a.ass_no = c.ass_no
	    left join hos_fac_dict d
	     	on
	          a.group_id = d.group_id
	          and a.hos_id = d.hos_id
	          and a.fac_id = d.fac_id
	          and d.is_stop = 0
	    left join temp e
	      	on
	          a.group_id = e.group_id
	          and a.hos_id = e.hos_id
	          and a.copy_code = e.copy_code
	          and a.bid_id = e.bid_id 
	          and a.detail_id = e.bid_det_id
	    left join hos_proj_dict f
	     	on
	          a.group_id = f.group_id
	          and a.hos_id = f.hos_id
	          and a.prj_name = f.proj_name
	          and f.is_stop = 0
	    left join hos_dept_dict hdd
	     	on a.group_id = hdd.group_id
	          and a.hos_id = hdd.hos_id
	          and a.bidd_usedept = hdd.dept_id
	          and hdd.is_stop = 0
	    left join hos_unit g
			on c.ass_unit = g.unit_code
			and a.group_id = g.group_id
			and a.hos_id = g.hos_id
		where
			a.group_id=#{group_id,jdbcType=NUMERIC}
			and a.hos_id=#{hos_id,jdbcType=NUMERIC}
			and a.copy_code=#{copy_code,jdbcType=VARCHAR}
			and b.bid_state = '03'
			and a.bidd_no - nvl(e.pact_amount,0) > 0
			<if test="bid_code != null and bid_code != ''">
				and b.bid_code = #{bid_code,jdbcType=VARCHAR} 
			</if>
			<if test="ven_id != null and ven_id != ''">
				and b.ven_id = #{ven_id,jdbcType=NUMERIC} 
			</if>
			<if test="ass_id != null and ass_id != ''">
				and (c.ass_code like #{ass_id} || '%' or
					c.ass_name like #{ass_id} || '%' or
					c.spell_code like #{ass_id} || '%' or
					c.wbx_code like #{ass_id} || '%' 
				)
			</if>
		ORDER BY a.bid_id
	</select>
	<!-- 复制主表数据 -->
	<insert id="copyMainData" parameterType="java.util.Map" >
		
    	INSERT INTO   PACT_MAIN_FKHT_C (
            GROUP_ID, HOS_ID, COPY_CODE, PACT_CODE, PACT_TYPE_CODE, STATE_CODE,
			PACT_NAME, ORIGINAL_CODE, MASTER_PACT_CODE, SIGN_DATE, DEPT_ID,
			DEPT_NO, EMP_ID, SUP_ID, SUP_NO, OPP_EMP, OPP_PHONE,
			TRADE_TYPE, CURR_CODE, PACT_MONEY_W, PACT_MONEY,
			START_DATE, END_DATE, IS_BID,
			ORGAN_TYPE, BUY_TYPE, IS_DEPOSIT, DEPOSIT_TYPE, DEPOSIT_MONEY,
			IS_INIT, STATE, MAKER, MAKE_DATE, CHECKER, CHECK_DATE,
			CONFIRMER, CONFIRM_DATE, STOPER, STOP_DATE, FILER, FILE_DATE,PROJ_ID,
			DELIVERY_TERM, SERVER,	SER_EMP, SER_PHONE,	CONT_TERM1,CONT_TERM2,	CONT_TERM3,
			CONT_TERM4,CONT_TERM5,	CONT_TERM6, NOTE,BID_ID
         )
        select 	
	    	GROUP_ID, HOS_ID, COPY_CODE, PACT_CODE, PACT_TYPE_CODE, STATE_CODE,
			PACT_NAME, ORIGINAL_CODE, MASTER_PACT_CODE, SIGN_DATE, DEPT_ID,
			DEPT_NO, EMP_ID, SUP_ID, SUP_NO, OPP_EMP, OPP_PHONE,
			TRADE_TYPE, CURR_CODE, PACT_MONEY_W, PACT_MONEY,
			START_DATE, END_DATE, IS_BID,
			ORGAN_TYPE, BUY_TYPE, IS_DEPOSIT, DEPOSIT_TYPE, DEPOSIT_MONEY,
			IS_INIT, STATE, MAKER, MAKE_DATE, CHECKER, CHECK_DATE,
			CONFIRMER, CONFIRM_DATE, STOPER, STOP_DATE, FILER, FILE_DATE,PROJ_ID,
			DELIVERY_TERM, SERVER,	SER_EMP, SER_PHONE,	CONT_TERM1,CONT_TERM2,	CONT_TERM3,
			CONT_TERM4,CONT_TERM5,	CONT_TERM6, NOTE,BID_ID
	     from PACT_MAIN_FKHT	 
	     where
	          group_id = #{group_id,jdbcType=INTEGER}
	          AND hos_id = #{hos_id,jdbcType=INTEGER}
	          AND copy_code = #{copy_code,jdbcType=VARCHAR}
	          AND PACT_CODE = #{PACT_CODE,jdbcType=VARCHAR}
	 </insert>
	 <!-- 复制明细表数据 -->
	 <insert id="copyDetData" parameterType="java.util.Map" >
	     INSERT INTO   PACT_DET_FKHT_C (
            GROUP_ID,HOS_ID,COPY_CODE,PACT_CODE,DETAIL_ID,SUBJECT_TYPE,SUBJECT_ID,SUBJECT_NO,ITEM_SPEC,
			ITEM_MODEL,AMOUNT,PRICE,MONEY,ARRIVE_DATE,REPAIR_MONTHS,NOTE,DEPT_ID,DEPT_NO,fac_id,fac_no,
			UNIT_CODE,ITEM_NAME , ITEM_BRAND , SOURCE
         )
        select 	
	    	GROUP_ID,HOS_ID,COPY_CODE,PACT_CODE,DETAIL_ID,SUBJECT_TYPE,SUBJECT_ID,SUBJECT_NO,ITEM_SPEC,
			ITEM_MODEL,AMOUNT,PRICE,MONEY,ARRIVE_DATE,REPAIR_MONTHS,NOTE,DEPT_ID,DEPT_NO,fac_id,fac_no,
			UNIT_CODE,ITEM_NAME , ITEM_BRAND , SOURCE
	     from PACT_DET_FKHT	 
	     where
	          group_id = #{group_id,jdbcType=INTEGER}
	          AND hos_id = #{hos_id,jdbcType=INTEGER}
	          AND copy_code = #{copy_code,jdbcType=VARCHAR}
	          AND PACT_CODE = #{PACT_CODE,jdbcType=VARCHAR}
	 </insert>	
	 <!-- 复制付款计划表数据 -->
	 <insert id="copyPlanData" parameterType="java.util.Map" >
	     INSERT INTO   PACT_PLAN_FKHT_C (
            GROUP_ID,HOS_ID,COPY_CODE,PACT_CODE,PLAN_DETAIL_ID,
			PAY_ID,SUMMARY,PAY_DATE,PAY_COND,SOURCE_ID,PLAN_MONEY,
			PAY_TYPE ,RATE ,PAYED_MONEY
         )
        select 	
	    	GROUP_ID,HOS_ID,COPY_CODE,PACT_CODE,PLAN_DETAIL_ID,
			PAY_ID,SUMMARY,PAY_DATE,PAY_COND,SOURCE_ID,PLAN_MONEY,
			PAY_TYPE ,RATE ,PAYED_MONEY
	     from PACT_PLAN_FKHT	 
	     where
	          group_id = #{group_id,jdbcType=INTEGER}
	          AND hos_id = #{hos_id,jdbcType=INTEGER}
	          AND copy_code = #{copy_code,jdbcType=VARCHAR}
	          AND PACT_CODE = #{PACT_CODE,jdbcType=VARCHAR}
	     ;
	</insert>	
	
	<select id="queryIsExeChange" parameterType="java.util.Map"	resultType="java.lang.Integer">
		SELECT count(1)
		FROM PACT_CHANGE_FKHT 
		WHERE
			GROUP_ID = #{group_id,jdbcType=NUMERIC}
			AND HOS_ID = #{hos_id,jdbcType=NUMERIC}
			AND COPY_CODE = #{copy_code,jdbcType=VARCHAR}
			AND pact_code in
			<foreach collection="list" item="item" index="index" open="("
				close=")" separator=",">
				#{item,jdbcType=VARCHAR}
			</foreach>
			AND is_exe = 1
	</select>
	
	<select id="queryPactFKHTMainByTypeAndName" parameterType="java.util.Map" resultMap="pactFKHT">
		SELECT 
			pact_code,
			pact_type_code,
			pact_name
		FROM PACT_MAIN_FKHT 
		WHERE
			GROUP_ID = #{group_id,jdbcType=NUMERIC}
			AND HOS_ID = #{hos_id,jdbcType=NUMERIC}
			AND COPY_CODE = #{copy_code,jdbcType=VARCHAR}
			AND PACT_TYPE_CODE =  #{pact_type_code,jdbcType=VARCHAR}
			AND PACT_NAME = #{pact_name,jdbcType=VARCHAR}
	</select>
	
	
</mapper>