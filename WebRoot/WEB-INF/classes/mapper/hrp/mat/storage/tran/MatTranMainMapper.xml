<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.mat.dao.storage.tran.MatTranMainMapper">
 
	<resultMap id="matTranMain" type="com.chd.hrp.mat.entity.MatTranMain">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="tran_id" column="tran_id" />
		<result property="tran_no" column="tran_no" />
		<result property="year" column="year" />
		<result property="month" column="month" />
		<result property="tran_type" column="tran_type" />
		<result property="bus_type" column="bus_type" />
		<result property="tran_method" column="tran_method" />
		<result property="out_hos_id" column="out_hos_id" />
		<result property="out_hos_code" column="out_hos_code" />
		<result property="out_hos_name" column="out_hos_name" />
		<result property="out_store_id" column="out_store_id" />
		<result property="out_store_no" column="out_store_no" />
		<result property="out_store_code" column="out_store_code" />
		<result property="out_store_name" column="out_store_name" />
		<result property="in_hos_id" column="in_hos_id" />
		<result property="in_hos_code" column="in_hos_code" />
		<result property="in_hos_name" column="in_hos_name" />
		<result property="in_store_id" column="in_store_id" />
		<result property="in_store_no" column="in_store_no" />
		<result property="in_store_code" column="in_store_code" />
		<result property="in_store_name" column="in_store_name" />
		<result property="brief" column="brief" />
		<result property="tran_date" column="tran_date" />
		<result property="maker" column="maker" />
		<result property="checker" column="checker" />
		<result property="check_date" column="check_date" />
		<result property="confirmer" column="confirmer" />
		<result property="confirm_date" column="confirm_date" />
		<result property="state" column="state" />
		<result property="amount_money" column="amount_money" />
	</resultMap>

	<select id="queryMatTranMainSeq" resultType="java.lang.Long" useCache="false" flushCache="true">

		select MAT_TRAN_MAIN_SEQ.nextval from dual
	</select>

	<insert id="add" useGeneratedKeys="true">

		INSERT INTO MAT_TRAN_MAIN (
		<trim suffix="" suffixOverrides=",">
			<if test="group_id != null and group_id != ''">group_id,</if>
			<if test="hos_id != null and hos_id != ''">hos_id,</if>
			<if test="copy_code != null and copy_code != ''">copy_code,</if>
			<if test="tran_id != null and tran_id != ''">tran_id,</if>
			<if test="tran_no != null and tran_no != ''">tran_no,</if>
			<if test="year != null and year != ''">year,</if>
			<if test="month != null and month != ''">month,</if>
			<if test="bus_type != null and bus_type != ''">bus_type,</if>
			<if test="tran_method != null and tran_method != ''">tran_method,</if>
			<if test="tran_type != null and tran_type != ''">tran_type,</if>
			<if test="out_hos_id != null and out_hos_id != ''">out_hos_id,</if>
			<if test="out_store_id != null and out_store_id != ''">out_store_id,</if>
			<if test="out_store_no != null and out_store_no != ''">out_store_no,</if>
			<if test="in_hos_id != null and in_hos_id != ''">in_hos_id,</if>
			<if test="in_store_id != null and in_store_id != ''">in_store_id,</if>
			<if test="in_store_no != null and in_store_no != ''">in_store_no,</if>
			<if test="brief != null and brief != ''">brief,</if>
			<if test="tran_date != null and tran_date != ''">tran_date,</if>
			<if test="maker != null and maker != ''">maker,</if>
			<if test="checker != null and checker != ''">checker,</if>
			<if test="check_date != null and check_date != ''">check_date,</if>
			<if test="confirmer != null and confirmer != ''">confirmer,</if>
			<if test="confirm_date != null and confirm_date != ''">confirm_date,</if>
			<if test="state != null and state != ''">state,</if>
			<if test="amount_money != null">amount_money,</if>
		</trim>
		) VALUES (
		<trim suffix="" suffixOverrides=",">
			<if test="group_id != null and group_id != ''">#{group_id,jdbcType=INTEGER},</if>
			<if test="hos_id != null and hos_id != ''">#{hos_id,jdbcType=INTEGER},</if>
			<if test="copy_code != null and copy_code != ''">#{copy_code,jdbcType=VARCHAR},</if>
			<if test="tran_id != null and tran_id != ''">#{tran_id,jdbcType=INTEGER},</if>
			<if test="tran_no != null and tran_no != ''">#{tran_no,jdbcType=VARCHAR},</if>
			<if test="year != null and year != ''">#{year,jdbcType=VARCHAR},</if>
			<if test="month != null and month != ''">#{month,jdbcType=VARCHAR},</if>
			<if test="bus_type != null and bus_type != ''">#{bus_type,jdbcType=INTEGER},</if>
			<if test="tran_method != null and tran_method != ''">#{tran_method,jdbcType=INTEGER},</if>
			<if test="tran_type != null and tran_type != ''">#{tran_type,jdbcType=INTEGER},</if>
			<if test="out_hos_id != null and out_hos_id != ''">#{out_hos_id,jdbcType=INTEGER},</if>
			<if test="out_store_id != null and out_store_id != ''">#{out_store_id,jdbcType=INTEGER},</if>
			<if test="out_store_no != null and out_store_no != ''">#{out_store_no,jdbcType=INTEGER},</if>
			<if test="in_hos_id != null and in_hos_id != ''">#{in_hos_id,jdbcType=INTEGER},</if>
			<if test="in_store_id != null and in_store_id != ''">#{in_store_id,jdbcType=INTEGER},</if>
			<if test="in_store_no != null and in_store_no != ''">#{in_store_no,jdbcType=INTEGER},</if>
			<if test="brief != null and brief != ''">#{brief,jdbcType=VARCHAR},</if>
			<if test="tran_date != null and tran_date != ''">to_date(#{tran_date,jdbcType=DATE},'yyyy/MM/dd'),</if>
			<if test="maker != null and maker != ''">#{maker,jdbcType=INTEGER},</if>
			<if test="checker != null and checker != ''">#{checker,jdbcType=INTEGER},</if>
			<if test="check_date != null and check_date != ''">to_date(#{check_date,jdbcType=DATE},'yyyy/MM/dd'),</if>
			<if test="confirmer != null and confirmer != ''">#{confirmer,jdbcType=INTEGER},</if>
			<if test="confirm_date != null and confirm_date != ''">to_date(#{confirm_date,jdbcType=DATE},'yyyy/MM/dd'),</if>
			<if test="state != null and state != ''">#{state,jdbcType=INTEGER},</if>
			<if test="amount_money != null">#{amount_money,jdbcType=NUMERIC}</if>
		</trim>
		)

	</insert>
	<insert id="addBatch" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
			INSERT INTO MAT_TRAN_MAIN (
				group_id,
				hos_id,
				copy_code,
				tran_id,
				tran_no,
				year,
				month,
				bus_type,
				tran_method,
				tran_type,
				out_hos_id,
				out_store_id,
				out_store_no,
				in_hos_id,
				in_store_id,
				in_store_no,
				brief,
				tran_date,
				maker,
				checker,
				check_date,
				confirmer,
				confirm_date,
				state, 
				amount_money
			)
			select
				#{item.group_id,jdbcType=INTEGER},
				#{item.hos_id,jdbcType=INTEGER},
				#{item.copy_code,jdbcType=VARCHAR},
				#{item.tran_id,jdbcType=INTEGER},
				#{item.tran_no,jdbcType=VARCHAR},
				#{item.year,jdbcType=VARCHAR},
				#{item.month,jdbcType=VARCHAR},
				#{item.bus_type,jdbcType=INTEGER},
				#{item.tran_method,jdbcType=INTEGER},
				#{item.tran_type,jdbcType=INTEGER},
				#{item.out_hos_id,jdbcType=INTEGER},
				#{item.out_store_id,jdbcType=INTEGER},
				#{item.out_store_no,jdbcType=INTEGER},
				#{item.in_hos_id,jdbcType=INTEGER},
				#{item.in_store_id,jdbcType=INTEGER},
				#{item.in_store_no,jdbcType=INTEGER},
				#{item.brief,jdbcType=VARCHAR},
				to_date(#{item.tran_date},'yyyy/MM/dd'),
				#{item.maker,jdbcType=INTEGER},
				#{item.checker,jdbcType=INTEGER},
				to_date(#{item.check_date},'yyyy/MM/dd'),
				#{item.confirmer,jdbcType=INTEGER},
				to_date(#{item.confirm_date},'yyyy/MM/dd'),
				#{item.state,jdbcType=INTEGER}, 
				#{item.amount_money,jdbcType=NUMERIC}
			from dual
		</foreach>
	</insert>

	<update id="update" parameterType="java.util.Map">
		UPDATE mat_tran_main
		<trim prefix="SET" suffixOverrides=",">
			<if test="year != null and year != ''">year = #{year,jdbcType=VARCHAR},</if>
			<if test="month != null and month != ''">month = #{month,jdbcType=VARCHAR},</if>
			<if test="bus_type != null">bus_type = #{bus_type,jdbcType=INTEGER},</if>
			<if test="tran_method != null and tran_method != ''">tran_method = #{tran_method,jdbcType=INTEGER},</if>
			<if test="tran_type != null and tran_type != ''">tran_type = #{tran_type,jdbcType=INTEGER},</if>
			<if test="out_hos_id != null and out_hos_id != ''">out_hos_id = #{out_hos_id,jdbcType=INTEGER},</if>
			<if test="out_store_id != null and out_store_id != ''">out_store_id = #{out_store_id,jdbcType=INTEGER},</if>
			<if test="out_store_no != null and out_store_no != ''">out_store_no = #{out_store_no,jdbcType=INTEGER},</if>
			<if test="in_hos_id != null and in_hos_id != ''">in_hos_id = #{in_hos_id,jdbcType=INTEGER},</if>
			<if test="in_store_id != null and in_store_id != ''">in_store_id = #{in_store_id,jdbcType=INTEGER},</if>
			<if test="in_store_no != null and in_store_no != ''">in_store_no = #{in_store_no,jdbcType=INTEGER},</if>
			<if test="brief != null">brief = #{brief,jdbcType=VARCHAR},</if>
			<if test="tran_date != null and tran_date != ''">tran_date =
				to_date(#{tran_date,jdbcType=VARCHAR},'yyyy/MM/dd'),
			</if>
			<if test="maker != null and maker != ''">maker = #{maker,jdbcType=INTEGER},</if>
			<if test="checker != null and checker != ''">checker = #{checker,jdbcType=INTEGER},</if>
			<if test="check_date != null and check_date != ''">check_date =
				to_date(#{check_date,jdbcType=VARCHAR},'yyyy/MM/dd'),
			</if>
			<if test="confirmer != null and confirmer != ''">confirmer = #{confirmer,jdbcType=INTEGER},</if>
			<if test="confirm_date != null and confirm_date != ''">confirm_date =
				to_date(#{confirm_date,jdbcType=VARCHAR},'yyyy/MM/dd'),
			</if>
			<if test="state != null and state != ''">state = #{state,jdbcType=INTEGER},</if>
			<if test="amount_money != null">amount_money = #{amount_money,jdbcType=NUMERIC},</if>
		</trim>
		<where>
			<if test="group_id != null and group_id != ''">AND group_id = #{group_id,jdbcType=INTEGER}</if>
			<if test="hos_id != null and hos_id != ''">AND hos_id = #{hos_id,jdbcType=INTEGER}</if>
			<if test="copy_code != null and copy_code != ''">AND copy_code = #{copy_code,jdbcType=VARCHAR}</if>
			<if test="tran_id != null and tran_id != ''">AND tran_id = #{tran_id,jdbcType=INTEGER}</if>
		</where>
	</update>
	<update id="updateAuditBatch" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin"
			close=";end;" separator=";">
			UPDATE mat_tran_main set
				check_date = fun_date_same_year_month(tran_date, sysdate),
				checker = #{item.checker,jdbcType=INTEGER},
				state = #{item.state,jdbcType=INTEGER}
			where hos_id = #{item.hos_id,jdbcType=INTEGER}
				AND group_id = #{item.group_id,jdbcType=INTEGER}
				AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
				AND tran_id = #{item.tran_id,jdbcType=INTEGER}
		</foreach>
	</update>
	<update id="updateConfirmBatch" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin"
			close=";end;" separator=";">
			UPDATE mat_tran_main set
				year = #{item.year,jdbcType=VARCHAR},
				month = #{item.month,jdbcType=VARCHAR}, 
				confirm_date = fun_date_same_year_month(tran_date, sysdate),
				confirmer = #{item.confirmer,jdbcType=INTEGER},
				state = #{item.state,jdbcType=INTEGER}
			where hos_id = #{item.hos_id,jdbcType=INTEGER}
				AND group_id = #{item.group_id,jdbcType=INTEGER}
				AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
				AND tran_id = #{item.tran_id,jdbcType=INTEGER}
		</foreach>
	</update>
	<update id="updateBatch" parameterType="java.util.List">

		<foreach collection="list" item="item" index="index" open="begin"
			close=";end;" separator=";">
			UPDATE mat_tran_main
			<trim prefix="SET" suffixOverrides=",">
				<if test="item.year != null and item.year != ''">year = #{item.year,jdbcType=VARCHAR},</if>
				<if test="item.month != null and item.month != ''">month = #{item.month,jdbcType=VARCHAR},</if>
				<if test="item.bus_type != null">bus_type = #{item.bus_type,jdbcType=INTEGER},</if>
				<if test="item.tran_method != null and item.tran_method != ''">tran_method = #{item.tran_method,jdbcType=INTEGER},</if>
				<if test="item.tran_type != null and item.tran_type != ''">tran_type = #{item.tran_type,jdbcType=INTEGER},</if>
				<if test="item.out_hos_id != null and item.out_hos_id != ''">out_hos_id = #{item.out_hos_id,jdbcType=INTEGER},</if>
				<if test="item.out_store_id != null and item.out_store_id != ''">out_store_id = #{item.out_store_id,jdbcType=INTEGER},
				</if>
				<if test="item.out_store_no != null and item.out_store_no != ''">out_store_no = #{item.out_store_no,jdbcType=INTEGER},
				</if>
				<if test="item.in_hos_id != null and item.in_hos_id != ''">in_hos_id = #{item.in_hos_id,jdbcType=INTEGER},</if>
				<if test="item.in_store_id != null and item.in_store_id != ''">in_store_id = #{item.in_store_id,jdbcType=INTEGER},</if>
				<if test="item.in_store_no != null and item.in_store_no != ''">in_store_no = #{item.in_store_no,jdbcType=INTEGER},</if>
				<if test="item.brief != null">brief = #{item.brief,jdbcType=VARCHAR},</if>
				<if test="item.tran_date != null and item.tran_date != ''">tran_date =
					to_date(#{item.tran_date,jdbcType=VARCHAR},'yyyy/MM/dd'),
				</if>
				<if test="item.maker != null and item.maker != ''">maker = #{item.maker,jdbcType=INTEGER},</if>
				<if test="item.checker != null and item.checker != ''">checker = #{item.checker,jdbcType=INTEGER},</if>
				<if test="item.check_date != null and item.check_date != ''">check_date =
					to_date(#{item.check_date,jdbcType=VARCHAR},'yyyy/MM/dd'),
				</if>
				<if test="item.confirmer != null and item.confirmer != ''">confirmer = #{item.confirmer,jdbcType=INTEGER},</if>
				<if test="item.confirm_date != null and item.confirm_date != ''">confirm_date =
					to_date(#{item.confirm_date,jdbcType=VARCHAR},'yyyy/MM/dd'),
				</if>
				<if test="item.state != null and item.state != ''">state = #{item.state,jdbcType=INTEGER},</if>
				<if test="item.amount_money != null ">amount_money = #{item.amount_money,jdbcType=NUMERIC},</if>
			</trim>
			<where>
				<if test="item.group_id != null and item.group_id != ''">AND group_id = #{item.group_id,jdbcType=INTEGER}</if>
				<if test="item.hos_id != null and item.hos_id != ''">AND hos_id = #{item.hos_id,jdbcType=INTEGER}</if>
				<if test="item.copy_code != null and item.copy_code != ''">AND copy_code = #{item.copy_code,jdbcType=VARCHAR}</if>
				<if test="item.tran_id != null and item.tran_id != ''">AND tran_id = #{item.tran_id,jdbcType=INTEGER}</if>
			</where>
		</foreach>
	</update>

	<delete id="delete" parameterType="java.util.Map">

		DELETE FROM mat_tran_main
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id != ''">
				AND tran_id = #{tran_id,jdbcType=INTEGER}
			</if>
			<if test="tran_no != null and tran_no != ''">
				AND tran_no = #{tran_no,jdbcType=VARCHAR}
			</if>
			<if test="year != null and year != ''">
				AND year = #{year,jdbcType=VARCHAR}
			</if>
			<if test="month != null and month != ''">
				AND month = #{month,jdbcType=VARCHAR}
			</if>
			<if test="bus_type != null and bus_type != ''">
				AND bus_type = #{bus_type,jdbcType=INTEGER}
			</if>
			<if test="tran_method != null and tran_method != ''">
				AND tran_method = #{tran_method,jdbcType=INTEGER}
			</if>
			<if test="tran_type != null and tran_type != ''">
				AND tran_type = #{tran_type,jdbcType=INTEGER}
			</if>
			<if test="out_hos_id != null and out_hos_id != ''">
				AND out_hos_id = #{out_hos_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_id != null and out_store_id != ''">
				AND out_store_id = #{out_store_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_no != null and out_store_no != ''">
				AND out_store_no = #{out_store_no,jdbcType=INTEGER}
			</if>
			<if test="in_hos_id != null and in_hos_id != ''">
				AND in_hos_id = #{in_hos_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_id != null and in_store_id != ''">
				AND in_store_id = #{in_store_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_no != null and in_store_no != ''">
				AND in_store_no = #{in_store_no,jdbcType=INTEGER}
			</if>
			<if test="brief != null and brief != ''">
				AND brief = #{brief,jdbcType=VARCHAR}
			</if>
			<if test="tran_date != null and tran_date != ''">
				AND tran_date = #{tran_date,jdbcType=DATE}
			</if>
			<if test="maker != null and maker != ''">
				AND maker = #{maker,jdbcType=INTEGER}
			</if>
			<if test="checker != null and checker != ''">
				AND checker = #{checker,jdbcType=INTEGER}
			</if>
			<if test="check_date != null and check_date != ''">
				AND check_date = #{check_date,jdbcType=DATE}
			</if>
			<if test="confirmer != null and confirmer != ''">
				AND confirmer = #{confirmer,jdbcType=INTEGER}
			</if>
			<if test="confirm_date != null and confirm_date != ''">
				AND confirm_date = #{confirm_date,jdbcType=DATE}
			</if>
			<if test="state != null and state != ''">
				AND state = #{state,jdbcType=INTEGER}
			</if>
		</where>
	</delete>
	<delete id="deleteBatch" parameterType="java.util.List">
		DELETE FROM mat_tran_main
		<where>
			<foreach collection="list" index="index" item="item" open="("
				separator="or" close=")">
				<if test="item.group_id != null and item.group_id != ''">
					group_id = #{item.group_id,jdbcType=INTEGER}
				</if>
				<if test="item.hos_id != null and item.hos_id != ''">
					AND hos_id = #{item.hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					AND copy_code = #{item.copy_code,jdbcType=VARCHAR}
				</if>
				<if test="item.tran_id != null and item.tran_id != ''">
					AND tran_id = #{item.tran_id,jdbcType=INTEGER}
				</if>
				<if test="item.tran_no != null and item.tran_no != ''">
					AND tran_no = #{item.tran_no,jdbcType=VARCHAR}
				</if>
				<if test="item.year != null and item.year != ''">
					AND year = #{item.year,jdbcType=VARCHAR}
				</if>
				<if test="item.month != null and item.month != ''">
					AND month = #{item.month,jdbcType=VARCHAR}
				</if>
				<if test="item.bus_type != null and item.bus_type != ''">
					AND bus_type = #{item.bus_type,jdbcType=INTEGER}
				</if>
				<if test="item.tran_method != null and item.tran_method != ''">
					AND tran_method = #{item.tran_method,jdbcType=INTEGER}
				</if>
				<if test="item.tran_type != null and item.tran_type != ''">
					AND tran_type = #{item.tran_type,jdbcType=INTEGER}
				</if>
				<if test="item.out_hos_id != null and item.out_hos_id != ''">
					AND out_hos_id = #{item.out_hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.out_store_id != null and item.out_store_id != ''">
					AND out_store_id = #{item.out_store_id,jdbcType=INTEGER}
				</if>
				<if test="item.out_store_no != null and item.out_store_no != ''">
					AND out_store_no = #{item.out_store_no,jdbcType=INTEGER}
				</if>
				<if test="item.in_hos_id != null and item.in_hos_id != ''">
					AND in_hos_id = #{item.in_hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.in_store_id != null and item.in_store_id != ''">
					AND in_store_id = #{item.in_store_id,jdbcType=INTEGER}
				</if>
				<if test="item.in_store_no != null and item.in_store_no != ''">
					AND in_store_no = #{item.in_store_no,jdbcType=INTEGER}
				</if>
				<if test="item.brief != null and item.brief != ''">
					AND brief = #{item.brief,jdbcType=VARCHAR}
				</if>
				<if test="item.tran_date != null and item.tran_date != ''">
					AND tran_date = #{item.tran_date,jdbcType=DATE}
				</if>
				<if test="item.maker != null and item.maker != ''">
					AND maker = #{item.maker,jdbcType=INTEGER}
				</if>
				<if test="item.checker != null and item.checker != ''">
					AND checker = #{item.checker,jdbcType=INTEGER}
				</if>
				<if test="item.check_date != null and item.check_date != ''">
					AND check_date = #{item.check_date,jdbcType=DATE}
				</if>
				<if test="item.confirmer != null and item.confirmer != ''">
					AND confirmer = #{item.confirmer,jdbcType=INTEGER}
				</if>
				<if test="item.confirm_date != null and item.confirm_date != ''">
					AND confirm_date = #{item.confirm_date,jdbcType=DATE}
				</if>
				<if test="item.state != null and item.state != ''">
					AND state = #{item.state,jdbcType=INTEGER}
				</if>
			</foreach>
		</where>
	</delete>
	<select id="query" parameterType="java.util.Map" resultMap="matTranMain">

		SELECT
		group_id,
		hos_id,
		copy_code,
		tran_id,
		tran_no,
		year,
		month,
		bus_type,
		tran_method,
		tran_type,
		out_hos_id,
		out_store_id,
		out_store_no,
		in_hos_id,
		in_store_id,
		in_store_no,
		brief,
		tran_date,
		maker,
		checker,
		check_date,
		confirmer,
		confirm_date,
		state, 
		amount_money
		FROM MAT_TRAN_MAIN
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id != ''">
				AND tran_id = #{tran_id,jdbcType=INTEGER}
			</if>
			<if test="tran_no != null and tran_no != ''">
				AND tran_no = #{tran_no,jdbcType=VARCHAR}
			</if>
			<if test="year != null and year != ''">
				AND year = #{year,jdbcType=VARCHAR}
			</if>
			<if test="month != null and month != ''">
				AND month = #{month,jdbcType=VARCHAR}
			</if>
			<if test="bus_type != null and bus_type != ''">
				AND bus_type = #{bus_type,jdbcType=INTEGER}
			</if>
			<if test="tran_method != null and tran_method != ''">
				AND tran_method = #{tran_method,jdbcType=INTEGER}
			</if>
			<if test="tran_type != null and tran_type != ''">
				AND tran_type = #{tran_type,jdbcType=INTEGER}
			</if>
			<if test="out_hos_id != null and out_hos_id != ''">
				AND out_hos_id = #{out_hos_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_id != null and out_store_id != ''">
				AND out_store_id = #{out_store_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_no != null and out_store_no != ''">
				AND out_store_no = #{out_store_no,jdbcType=INTEGER}
			</if>
			<if test="in_hos_id != null and in_hos_id != ''">
				AND in_hos_id = #{in_hos_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_id != null and in_store_id != ''">
				AND in_store_id = #{in_store_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_no != null and in_store_no != ''">
				AND in_store_no = #{in_store_no,jdbcType=INTEGER}
			</if>
			<if test="brief != null and brief != ''">
				AND brief = #{brief,jdbcType=VARCHAR}
			</if>
			<if test="tran_date != null and tran_date != ''">
				AND tran_date = #{tran_date,jdbcType=DATE}
			</if>
			<if test="maker != null and maker != ''">
				AND maker = #{maker,jdbcType=INTEGER}
			</if>
			<if test="checker != null and checker != ''">
				AND checker = #{checker,jdbcType=INTEGER}
			</if>
			<if test="check_date != null and check_date != ''">
				AND check_date = #{check_date,jdbcType=DATE}
			</if>
			<if test="confirmer != null and confirmer != ''">
				AND confirmer = #{confirmer,jdbcType=INTEGER}
			</if>
			<if test="confirm_date != null and confirm_date != ''">
				AND confirm_date = #{confirm_date,jdbcType=DATE}
			</if>
			<if test="state != null and state != ''">
				AND state = #{state,jdbcType=INTEGER}
			</if>
		</where>
		order by group_id asc
	</select>
	<select id="queryByCode" resultMap="matTranMain" parameterType="java.util.Map">

		SELECT
		group_id,
		hos_id,
		copy_code,
		tran_id,
		tran_no,
		year,
		month,
		bus_type,
		tran_method,
		tran_type,
		bus_type,
		tran_method,
		out_hos_id,
		out_store_id,
		out_store_no,
		in_hos_id,
		in_store_id,
		in_store_no,
		brief,
		tran_date,
		maker,
		checker,
		check_date,
		confirmer,
		confirm_date,
		state, 
		amount_money
		FROM mat_tran_main
		WHERE
		group_id = #{group_id,jdbcType=INTEGER} and
		hos_id =
		#{hos_id,jdbcType=INTEGER} and
		copy_code =
		#{copy_code,jdbcType=VARCHAR} and
		tran_id = #{tran_id,jdbcType=INTEGER}

	</select>
	<select id="queryByUniqueness" resultMap="matTranMain"
		parameterType="java.util.Map">

		SELECT
		group_id,
		hos_id,
		copy_code,
		tran_id,
		tran_no,
		year,
		month,
		bus_type,
		tran_method,
		tran_type,
		out_hos_id,
		out_store_id,
		out_store_no,
		in_hos_id,
		in_store_id,
		in_store_no,
		brief,
		tran_date,
		maker,
		checker,
		check_date,
		confirmer,
		confirm_date,
		state, 
		amount_money
		FROM MAT_TRAN_MAIN
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id != ''">
				AND tran_id = #{tran_id,jdbcType=INTEGER}
			</if>
			<if test="tran_no != null and tran_no != ''">
				AND tran_no = #{tran_no,jdbcType=VARCHAR}
			</if>
			<if test="year != null and year != ''">
				AND year = #{year,jdbcType=VARCHAR}
			</if>
			<if test="month != null and month != ''">
				AND month = #{month,jdbcType=VARCHAR}
			</if>
			<if test="bus_type != null and bus_type != ''">
				AND bus_type = #{bus_type,jdbcType=INTEGER}
			</if>
			<if test="tran_method != null and tran_method != ''">
				AND tran_method = #{tran_method,jdbcType=INTEGER}
			</if>
			<if test="tran_type != null and tran_type != ''">
				AND tran_type = #{tran_type,jdbcType=INTEGER}
			</if>
			<if test="out_hos_id != null and out_hos_id != ''">
				AND out_hos_id = #{out_hos_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_id != null and out_store_id != ''">
				AND out_store_id = #{out_store_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_no != null and out_store_no != ''">
				AND out_store_no = #{out_store_no,jdbcType=INTEGER}
			</if>
			<if test="in_hos_id != null and in_hos_id != ''">
				AND in_hos_id = #{in_hos_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_id != null and in_store_id != ''">
				AND in_store_id = #{in_store_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_no != null and in_store_no != ''">
				AND in_store_no = #{in_store_no,jdbcType=INTEGER}
			</if>
			<if test="brief != null and brief != ''">
				AND brief = #{brief,jdbcType=VARCHAR}
			</if>
			<if test="tran_date != null and tran_date != ''">
				AND tran_date = #{tran_date,jdbcType=DATE}
			</if>
			<if test="maker != null and maker != ''">
				AND maker = #{maker,jdbcType=INTEGER}
			</if>
			<if test="checker != null and checker != ''">
				AND checker = #{checker,jdbcType=INTEGER}
			</if>
			<if test="check_date != null and check_date != ''">
				AND check_date = #{check_date,jdbcType=DATE}
			</if>
			<if test="confirmer != null and confirmer != ''">
				AND confirmer = #{confirmer,jdbcType=INTEGER}
			</if>
			<if test="confirm_date != null and confirm_date != ''">
				AND confirm_date = #{confirm_date,jdbcType=DATE}
			</if>
			<if test="state != null and state != ''">
				AND state = #{state,jdbcType=INTEGER}
			</if>
		</where>
		order by group_id asc
	</select>
	<select id="queryExists" resultMap="matTranMain" parameterType="java.util.Map">

		SELECT
		group_id,
		hos_id,
		copy_code,
		tran_id,
		tran_no,
		year,
		month,
		bus_type,
		tran_method,
		tran_type,
		out_hos_id,
		out_store_id,
		out_store_no,
		in_hos_id,
		in_store_id,
		in_store_no,
		brief,
		tran_date,
		maker,
		checker,
		check_date,
		confirmer,
		confirm_date,
		state, 
		amount_money
		FROM MAT_TRAN_MAIN
		<where>
			<if test="group_id != null and group_id != ''">
				AND group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="tran_id != null and tran_id != ''">
				AND tran_id = #{tran_id,jdbcType=INTEGER}
			</if>
			<if test="tran_no != null and tran_no != ''">
				AND tran_no = #{tran_no,jdbcType=VARCHAR}
			</if>
			<if test="year != null and year != ''">
				AND year = #{year,jdbcType=VARCHAR}
			</if>
			<if test="month != null and month != ''">
				AND month = #{month,jdbcType=VARCHAR}
			</if>
			<if test="bus_type != null and bus_type != ''">
				AND bus_type = #{bus_type,jdbcType=INTEGER}
			</if>
			<if test="tran_method != null and tran_method != ''">
				AND tran_method = #{tran_method,jdbcType=INTEGER}
			</if>
			<if test="tran_type != null and tran_type != ''">
				AND tran_type = #{tran_type,jdbcType=INTEGER}
			</if>
			<if test="out_hos_id != null and out_hos_id != ''">
				AND out_hos_id = #{out_hos_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_id != null and out_store_id != ''">
				AND out_store_id = #{out_store_id,jdbcType=INTEGER}
			</if>
			<if test="out_store_no != null and out_store_no != ''">
				AND out_store_no = #{out_store_no,jdbcType=INTEGER}
			</if>
			<if test="in_hos_id != null and in_hos_id != ''">
				AND in_hos_id = #{in_hos_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_id != null and in_store_id != ''">
				AND in_store_id = #{in_store_id,jdbcType=INTEGER}
			</if>
			<if test="in_store_no != null and in_store_no != ''">
				AND in_store_no = #{in_store_no,jdbcType=INTEGER}
			</if>
			<if test="brief != null and brief != ''">
				AND brief = #{brief,jdbcType=VARCHAR}
			</if>
			<if test="tran_date != null and tran_date != ''">
				AND tran_date = #{tran_date,jdbcType=DATE}
			</if>
			<if test="maker != null and maker != ''">
				AND maker = #{maker,jdbcType=INTEGER}
			</if>
			<if test="checker != null and checker != ''">
				AND checker = #{checker,jdbcType=INTEGER}
			</if>
			<if test="check_date != null and check_date != ''">
				AND check_date = #{check_date,jdbcType=DATE}
			</if>
			<if test="confirmer != null and confirmer != ''">
				AND confirmer = #{confirmer,jdbcType=INTEGER}
			</if>
			<if test="confirm_date != null and confirm_date != ''">
				AND confirm_date = #{confirm_date,jdbcType=DATE}
			</if>
			<if test="state != null and state != ''">
				AND state = #{state,jdbcType=INTEGER}
			</if>
		</where>
		order by group_id asc
	</select>

	<select id="queryMatTranMain" parameterType="java.util.Map" resultType="java.util.HashMap">
		WITH tmp AS(
			SELECT 
				mtm.group_id as group_id, 
				mtm.hos_id as hos_id, 
				mtm.copy_code as copy_code, 
				mtm.tran_id as tran_id, 
				mtm.tran_no as tran_no, 
				mtm.year as year, 
				mtm.month as month,
				mtm.tran_date as tran_date,
				mtm.out_hos_id as out_hos_id,
				out_hid.hos_code as out_hos_code,
				out_hid.hos_name as out_hos_name,
				mtm.in_hos_id as in_hos_id,
				in_hid.hos_code as in_hos_code,
				in_hid.hos_name as in_hos_name,
				mtm.out_store_id as out_store_id,
				mtm.out_store_no as out_store_no,
				out_hsd.store_code as out_store_code,
				out_hsd.store_name as out_store_name,
				mtm.in_store_id as in_store_id,
				mtm.in_store_no as in_store_no,
				in_hsd.store_code as in_store_code,
				in_hsd.store_name as in_store_name,
				mtm.maker as maker,
				sumaker.user_name as maker_name,
				mtm.checker as checker,
				suchecker.user_name as checker_name,
				mtm.check_date as check_date,
				mtr.out_no as out_no,
				mtr.out_id as out_id,
				mtm.confirmer as confirmer,
				suconfirmer.user_name as confirmer_name,
				mtm.confirm_date as confirm_date,
				mtr.in_no as in_no,
				mtr.in_id as in_id,
				mtm.state as state,
				case 
					when mtm.state = 1 then '未确认'
					when mtm.state = 2 then '调出确认'
					when mtm.state = 3 then '调入确认'
				end as state_name,
				mtm.brief as brief,
				mtm.amount_money as amount_money,
				case 
					when nvl(spc.print_count, 0) &gt; 0 then 1
					else 0
				end as print_state,
				case 
					when nvl(spc.print_count, 0) &gt; 0 then '是'
					else '否'
				end as print_state_name
			FROM mat_tran_main  mtm   
			LEFT JOIN v_hos_dict out_hid 
				ON mtm.group_id = out_hid.group_id
				AND mtm.out_hos_id = out_hid.hos_id
				AND out_hid.is_stop = 0
			LEFT JOIN v_hos_dict in_hid 
				ON mtm.group_id = in_hid.group_id 
				AND mtm.in_hos_id = in_hid.hos_id
				AND in_hid.is_stop = 0
			LEFT JOIN hos_store_dict out_hsd
				ON mtm.group_id = out_hsd.group_id 
				AND mtm.hos_id = out_hsd.hos_id 
				AND mtm.out_store_id = out_hsd.store_id 
				AND mtm.out_store_no = out_hsd.store_no
			LEFT JOIN hos_store_dict in_hsd
				ON mtm.group_id = in_hsd.group_id 
				AND mtm.hos_id = in_hsd.hos_id
				AND mtm.in_store_id = in_hsd.store_id 
				AND mtm.in_store_no = in_hsd.store_no
			LEFT JOIN sys_user sumaker
				ON mtm.group_id = sumaker.group_id 
				AND mtm.hos_id = sumaker.hos_id
				AND mtm.maker = sumaker.user_id
			LEFT JOIN sys_user suchecker
				ON mtm.group_id = suchecker.group_id 
				AND mtm.hos_id = suchecker.hos_id
				AND mtm.checker = suchecker.user_id 
			LEFT JOIN sys_user suconfirmer 
				ON mtm.group_id = suconfirmer.group_id 
				AND mtm.hos_id = suconfirmer.hos_id 
				AND mtm.confirmer = suconfirmer.user_id
			LEFT JOIN mat_tran_rela mtr 
				ON mtm.group_id = mtr.group_id 
				AND mtm.hos_id = mtr.hos_id
				AND mtm.copy_code = mtr.copy_code 
				AND mtm.tran_id = mtr.tran_id
			LEFT JOIN sys_print_count spc 
				ON mtm.group_id = spc.group_id
				AND mtm.hos_id = spc.hos_id
				AND mtm.copy_code = spc.copy_code
				AND mtm.tran_no = spc.business_no
			WHERE mtm.group_id = #{group_id,jdbcType=INTEGER}
				AND mtm.hos_id = #{hos_id,jdbcType=INTEGER}
				AND mtm.copy_code = #{copy_code,jdbcType=VARCHAR}
				<if test="tran_no != null and tran_no != ''">
					AND mtm.tran_no like '%${tran_no}%'
				</if>
				<if test="tran_type != null and tran_type != ''">
					AND mtm.tran_type = #{tran_type,jdbcType=INTEGER}
				</if>
				<if test="bus_type != null and bus_type != ''">
					AND mtm.bus_type = #{bus_type,jdbcType=INTEGER}
				</if>
				<if test="tran_method != null and tran_method != ''">
					AND mtm.tran_method = #{tran_method,jdbcType=INTEGER}
				</if>
				<if test="out_hos_id != null and out_hos_id != ''">
					AND mtm.out_hos_id = #{out_hos_id,jdbcType=INTEGER}
				</if>
				<if test="out_store_id != null and out_store_id != ''">
					AND mtm.out_store_id = #{out_store_id,jdbcType=INTEGER}
				</if>
				<if test="in_hos_id != null and in_hos_id != ''">
					AND mtm.in_hos_id = #{in_hos_id,jdbcType=INTEGER}
				</if>
				<if test="in_store_id != null and in_store_id != ''">
					AND mtm.in_store_id = #{in_store_id,jdbcType=INTEGER}
				</if>
				<if test="begin_tran_date != null and begin_tran_date != ''">
					<![CDATA[AND to_char(mtm.tran_date,'yyyy-MM-dd') >= #{begin_tran_date}  ]]>
				</if>
				<if test="end_tran_date != null and end_tran_date != ''">
					<![CDATA[AND to_char(mtm.tran_date,'yyyy-MM-dd') <= #{end_tran_date}  ]]>
				</if>
				<if test="begin_check_date != null and begin_check_date != ''">
					<![CDATA[AND to_char(mtm.check_date,'yyyy-MM-dd') >= #{begin_check_date} ]]>
				</if>
				<if test="end_check_date != null and end_check_date != ''">
					<![CDATA[AND to_char(mtm.check_date,'yyyy-MM-dd') <= #{end_check_date} ]]>
				</if>
				<if test="begin_confirm_date != null and begin_confirm_date != ''">
					<![CDATA[AND to_char(mtm.confirm_date,'yyyy-MM-dd') >= #{begin_confirm_date} ]]>
				</if>
				<if test="end_confirm_date != null and end_confirm_date != ''">
					<![CDATA[AND to_char(mtm.confirm_date,'yyyy-MM-dd') <= #{end_confirm_date} ]]>
				</if>
				<if test="state != null and state != ''">
					AND mtm.state = #{state,jdbcType=INTEGER}
				</if>
				<if test="tran_no != null and tran_no != ''">
					AND mtm.tran_no like '${tran_no}%'
				</if>
				<if test="brief != null and brief != ''"> 
					and mtm.brief like '%${brief}%'
				</if>
				<if test="maker != null and maker != ''">
					AND mtm.maker = #{maker,jdbcType=INTEGER}
				</if>
				<if test="in_confirmer != null and in_confirmer != ''">
					AND mtm.confirmer = #{in_confirmer}
				</if>
				<if test="out_confirmer != null and out_confirmer != ''">
					AND mtm.checker = #{out_confirmer}
				</if>
				<if test="print_state != null and print_state != ''">
					and case when  nvl(spc.print_count,0) &gt; 0 then 1 else 0 end  = #{print_state}
				</if>
				<if test="out_store_id == ''  and in_store_id == '' ">
					AND ( to_char(mtm.out_store_id) in (
							select perm_code from v_user_data_perm
							where group_id = ${group_id}
							and hos_id = ${hos_id} and user_id = ${user_id} 
							and table_code = 'HOS_STORE_DICT' 
							and is_read = 1 and is_write = 1
						) 
						or 
						to_char(mtm.in_store_id) in (
							select perm_code from v_user_data_perm
							where group_id = ${group_id}
							and hos_id = ${hos_id} and user_id = ${user_id} 
							and table_code = 'HOS_STORE_DICT' 
							and is_read = 1 and is_write = 1
						)
					)
				</if>
				<if test="mat_type_code != null and mat_type_code != ''">
					AND exists(
						SELECT 1 
						FROM mat_tran_detail mtdd 
						LEFT JOIN mat_inv_dict mid 
							ON mtdd.group_id = mid.group_id
							AND mtdd.hos_id = mid.hos_id
							AND mtdd.copy_code = mid.copy_code
							AND mtdd.inv_id = mid.inv_id
							AND mid.is_stop = 0
						LEFT JOIN mat_type_dict mt 
							ON mid.group_id = mt.group_id
							AND mid.hos_id = mt.hos_id
							AND mid.copy_code = mt.copy_code 
							AND mid.mat_type_id = mt.mat_type_id
							AND mid.mat_type_no = mt.mat_type_no 
						WHERE mtm.group_id = mtdd.group_id
							AND mtm.hos_id = mtdd.hos_id
							AND mtm.copy_code = mtdd.copy_code
							AND mtm.tran_id = mtdd.tran_id 
							AND mt.mat_type_code like '${mat_type_code}%'
					)
				</if>
			ORDER BY mtm.tran_no desc
		)
		SELECT 
			null group_id,null hos_id,null copy_code,null tran_id, '合计' tran_no
      		,null year, null month,null tran_date,null out_hos_id,null out_hos_code
			,null out_hos_name,null in_hos_id, null in_hos_code,null in_hos_name, null out_store_id
		    ,null out_store_no,null out_store_code,null out_store_name,null in_store_id,null in_store_no
		    ,null in_store_code,null in_store_name,null AS maker,null maker_name,null checker
		    ,null checker_name, null check_date,null out_no,null out_id, null confirmer
		    ,null confirmer_name,null confirm_date,null in_no,null in_id,null state,null as state_name
		    ,null brief, sum(amount_money) AS amount_money,
		    null as print_state,
            null as print_state_name
		FROM tmp
		UNION ALL 
		SELECT 
			group_id, hos_id, copy_code, tran_id, tran_no, 
			year,  month, tran_date, 
			out_hos_id, out_hos_code, out_hos_name, 
			in_hos_id, in_hos_code, in_hos_name, 
			out_store_id, out_store_no, out_store_code, out_store_name, 
			in_store_id, in_store_no, in_store_code, in_store_name, 
			maker, maker_name, checker, checker_name,  check_date, 
			out_no, out_id, confirmer, confirmer_name, confirm_date, 
			in_no, in_id, state, state_name, brief, amount_money,
		    print_state, print_state_name 
		FROM tmp
	</select>

	<select id="queryMatInMainBySingle" parameterType="java.util.Map" resultType="java.util.TreeMap">
		with tmp_imme as(
			select 
				inv_id, batch_sn, batch_no, bar_code, sum(amount) as amount
			from(
				--出库未确认单据
				select 
					inv_id, batch_sn, batch_no, bar_code, sum(nvl(amount, 0)) as amount
				from mat_out_main mom 
				left join mat_out_detail matod 
					on mom.group_id = matod.group_id and mom.hos_id = matod.hos_id 
					and mom.copy_code = matod.copy_code and mom.out_id = matod.out_id
				where matod.group_id = #{group_id,jdbcType=INTEGER}
					AND matod.hos_id = #{hos_id,jdbcType=INTEGER}
					AND matod.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND mom.store_id = #{store_id,jdbcType=INTEGER}
					AND NOT EXISTS(
						select 1 from mat_tran_rela 
						where group_id = #{group_id,jdbcType=INTEGER}
							and hos_id = #{hos_id,jdbcType=INTEGER}
							and copy_code = #{copy_code,jdbcType=VARCHAR}
							and tran_id = #{tran_id,jdbcType=INTEGER}
							and out_id = matod.out_id )
					<![CDATA[
					AND mom.state < 3 
					AND mom.bus_type_code <> '21'
					AND matod.amount_money > 0
					]]>
				group by inv_id, batch_sn, batch_no, bar_code
				--退货未确认单据
				union all
				select 
					inv_id, batch_sn, batch_no, bar_code, -1 * sum(nvl(amount, 0)) as amount
				from mat_in_main mim
				left join  mat_in_detail matid
					on mim.group_id = matid.group_id and mim.hos_id = matid.hos_id 
					and mim.copy_code = matid.copy_code and mim.in_id = matid.in_id
				where matid.group_id = #{group_id,jdbcType=INTEGER}
					AND matid.hos_id = #{hos_id,jdbcType=INTEGER}
					AND matid.copy_code = #{copy_code,jdbcType=VARCHAR}
					AND mim.store_id = #{store_id,jdbcType=INTEGER}
					<![CDATA[
					AND mim.state < 3 
					]]>
					AND mim.bus_type_code in ('10','12','16','22')
					<![CDATA[ AND matid.amount_money < 0  ]]>
				group by inv_id, batch_sn, batch_no, bar_code
			)
			group by inv_id, batch_sn, batch_no, bar_code
			order by inv_id asc
		)
		select mim.group_id, mim.hos_id, mim.copy_code, mim.in_id, mim.in_no, mim.brief, hsd.sup_name,
			su.user_name as maker_name, mim.in_date, suc.user_name as confirmer_name, mim.confirm_date,mim.check_date,
			sum(nvl(mfb.left_amount, 0) - nvl(tmp_imme.amount, 0)) as imme_amount,
     		 sum(mid.amount_money) money
		from mat_in_main mim
		left join mat_in_detail mid
			on mim.group_id =mid.group_id and mim.hos_id = mid.hos_id
			and mim.copy_code = mid.copy_code and mim.in_id = mid.in_id
		left join mat_fifo_balance mfb
			on mim.group_id = mfb.group_id and mim.hos_id = mfb.hos_id
			and mim.copy_code = mfb.copy_code and mim.store_id = mfb.store_id
			and mid.inv_id = mfb.inv_id and mid.batch_no = mfb.batch_no
			and mid.batch_sn = mfb.batch_sn and mid.bar_code = mfb.bar_code
		left join tmp_imme 
			ON mid.inv_id = tmp_imme.inv_id and mid.batch_no = tmp_imme.batch_no
			and mid.batch_sn = tmp_imme.batch_sn and mid.bar_code = tmp_imme.bar_code
		left join hos_sup_dict hsd
			on mim.group_id = hsd.group_id and mim.hos_id = hsd.hos_id
			and mim.sup_id = hsd.sup_id and hsd.is_stop = 0
		left join sys_user su
			on mim.group_id = su.group_id and su.hos_id = su.hos_id
			and mim.maker = su.user_id
		left join sys_user suc
			on mim.group_id = suc.group_id and mim.hos_id = suc.hos_id
			and mim.confirmer = suc.user_id
		where mim.group_id = #{group_id,jdbcType=INTEGER}
			and mim.hos_id = #{hos_id,jdbcType=INTEGER}
			and mim.copy_code = #{copy_code,jdbcType=VARCHAR}
			and mim.store_id = #{store_id,jdbcType=INTEGER}
			<if test="in_no != null and in_no != ''">
				AND mim.in_no = #{in_no,jdbcType=VARCHAR}
			</if>
			<if test="brief != null and brief != ''">
				AND  mim.brief like '%${brief}%' 
			</if>
			<if test="sup_name != null and sup_name != ''"> 
					 and ( 
							hsd.sup_code like '%${sup_name}%'
							or hsd.sup_name like '%${sup_name}%' 
							or upper(hsd.spell_code) like '%${sup_name}%'
							or upper(hsd.wbx_code) like '%${sup_name}%'
							or lower(hsd.spell_code) like '%${sup_name}%'
							or lower(hsd.wbx_code) like '%${sup_name}%' 
						)
			</if>
			<if test="maker_name != null and maker_name != ''"> 
				 and ( 
							su.user_code like '%${maker_name}%'
							or su.user_name like '%${maker_name}%' 
							or upper(su.spell_code) like '%${maker_name}%'
							or upper(su.wbx_code) like '%${maker_name}%'
							or lower(su.spell_code) like '%${maker_name}%'
							or lower(su.wbx_code) like '%${maker_name}%'  
						)
						
			</if>
			<if test="in_date_start != null and in_date_start != ''">
					<![CDATA[AND mim.in_date >= #{in_date_start,jdbcType=DATE}]]>   
			</if>
			<if test="in_date_end != null and in_date_end != ''">
					<![CDATA[AND mim.in_date <= #{in_date_end,jdbcType=DATE}]]>
			</if>
			<if test="begin_confirm_date != null and begin_confirm_date != ''">
					AND to_char( mim.confirm_date,'yyyy-mm-dd') &gt;= #{begin_confirm_date}
			</if>
				<if test="end_confirm_date != null and end_confirm_date != ''">
					AND   to_char(mim.confirm_date,'yyyy-mm-dd') &lt;=  #{end_confirm_date}
			</if>
			and mim.state = 3
		group by mim.group_id, mim.hos_id, mim.copy_code, mim.in_id, mim.in_no, mim.brief, hsd.sup_name,
			su.user_name, mim.in_date, suc.user_name, mim.confirm_date,mim.check_date
		having sum(nvl(mfb.left_amount, 0) - nvl(tmp_imme.amount, 0)) > 0
		order by mim.in_id desc
	</select>

	<select id="queryMatInDetailBySingle" parameterType="java.util.Map"
		resultType="java.util.TreeMap">
		select mid.in_detail_id, mid.inv_id, inv.inv_no, inv.inv_code,
		inv.inv_name, inv.inv_model, mid.batch_no,
		mid.batch_sn, mid.bar_code,
		mid.price, sum(nvl(mfb.left_amount, 0) -
		nvl(modet.amount, 0)) as
		imme_amount
		from mat_in_detail mid
		left join
		mat_fifo_balance mfb
		on
		mid.group_id = mfb.group_id and mid.hos_id = mfb.hos_id
		and
		mid.copy_code = mfb.copy_code and mfb.store_id =
		#{store_id,jdbcType=INTEGER}
		and mid.inv_id = mfb.inv_id and
		mid.batch_no = mfb.batch_no
		and mid.batch_sn = mfb.batch_sn and
		mid.bar_code = mfb.bar_code
		left join(
		select detail.inv_id,
		detail.batch_no, detail.batch_sn,
		detail.bar_code, sum(amount) as
		amount
		from mat_out_main mom
		left join mat_out_detail detail
		on
		mom.group_id = detail.group_id and mom.hos_id = detail.hos_id
		and
		mom.copy_code = detail.copy_code and mom.out_id = detail.out_id
		where
		mom.group_id = #{group_id,jdbcType=INTEGER}
		and mom.hos_id =
		#{hos_id,jdbcType=INTEGER}
		and mom.copy_code =
		#{copy_code,jdbcType=VARCHAR}
		and mom.store_id =
		#{store_id,jdbcType=INTEGER}
				<![CDATA[and mom.state < 3]]>
		group by detail.inv_id, detail.batch_no, detail.batch_sn,
		detail.bar_code
		)modet
		on mid.inv_id = modet.inv_id and mid.batch_no =
		modet.batch_no
		and mid.batch_sn = modet.batch_sn and mid.bar_code =
		modet.bar_code
		left join mat_inv_dict inv
		on mid.group_id = inv.group_id
		and mid.hos_id = inv.hos_id
		and mid.copy_code = inv.copy_code and
		mid.inv_id = inv.inv_id
		and inv.is_stop = 0
		where mid.group_id =
		#{group_id,jdbcType=INTEGER}
		and mid.hos_id =
		#{hos_id,jdbcType=INTEGER}
		and mid.copy_code =
		#{copy_code,jdbcType=VARCHAR}
		and mid.in_id = #{in_id,jdbcType=INTEGER}
		group by mid.in_detail_id,
		mid.inv_id, inv.inv_no, inv.inv_code,
		inv.inv_name, inv.inv_model,
		mid.batch_no, mid.batch_sn, mid.bar_code,
		mid.price
		<!-- 如果不显示即时库存为0的材料，取消注释 -->
		--having sum(nvl(mfb.left_amount, 0) - nvl(modet.amount, 0)) > 0
		order
		by mid.in_detail_id
	</select>
	
	<select id="queryMatTranMainByMatInv" parameterType="java.util.Map"
		resultType="java.util.TreeMap">
		SELECT
		mid.group_id as group_id,
		mid.hos_id as hos_id,
		mid.copy_code as
		copy_code,
		mid.inv_id as inv_id,
		mid.inv_no as inv_no,
		mid.inv_code as
		inv_code,
		mid.inv_name as inv_name,
		mid.inv_model as inv_model,--规格型号
		mid.unit_code as unit_code,
		hu.unit_name as unit_name,
		mfb.price as
		price,--单价
		mfb.batch_sn as batch_sn,
		mfb.batch_no as batch_no,
		mfb.bar_code as bar_code,
		mfb.left_amount as left_amount, -- 账面数量
		mbv.inva_date as inva_date,
		mid.sup_id as sup_id,
		hsd.sup_code as
		sup_code,
		hsd.sup_name as sup_name,
		mid.fac_id as fac_id,
		mid.fac_no as
		fac_no,
		hfd.fac_code as fac_code,
		hfd.fac_name as fac_name,
		mfb.location_id as location_id,
		mld.location_code as location_code,
		mld.location_name as location_name

		FROM mat_inv_dict mid
		LEFT JOIN
		hos_unit hu ON mid.group_id = hu.group_id
		and mid.hos_id = hu.hos_id
		and mid.unit_code = hu.unit_code
		left join mat_fifo_balance mfb on
		mid.group_id = mfb.group_id and
		mid.hos_id = mfb.hos_id and
		mid.copy_code = mfb.copy_code and
		mid.inv_id = mfb.inv_id
		left join
		mat_batch_validity mbv on
		mfb.group_id = mbv.group_id and mfb.hos_id =
		mbv.hos_id and
		mfb.copy_code = mbv.copy_code and mfb.inv_id =
		mbv.inv_id and
		mfb.batch_no = mbv.batch_no
		left join hos_sup_dict hsd on
		mid.group_id
		= hsd.group_id and mid.hos_id = hsd.group_id and
		mid.sup_id =
		hsd.sup_id and hsd.is_stop=0
		LEFT JOIN hos_fac_dict hfd ON mid.group_id = hfd.group_id and mid.hos_id = hfd.hos_id and mid.fac_id = hfd.fac_id
			and mid.fac_no = hfd.fac_no
		LEFT JOIN mat_location_dict mld
		on mfb.group_id = mld.group_id and
		mfb.hos_id = mld.hos_id and
		mfb.copy_code = mld.copy_code and
		mfb.location_id = mld.location_id and
		mld.is_stop=0

		<where>
			<if test="hos_id != null and hos_id != ''">
				AND mid.hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="group_id != null and group_id != ''">
				AND mid.group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND mid.copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="inv_id != null and inv_id != ''">
				AND mid.inv_id = #{inv_id,jdbcType=VARCHAR}
			</if>
			<if test="inv_no != null and inv_no != ''">
				AND mid.inv_no = #{inv_no,jdbcType=VARCHAR}
			</if>
			<if test="store_id != null and store_id != ''">
				AND mid.store_id = #{store_id,jdbcType=VARCHAR}
			</if>
		</where>
		order by inv_no
	</select>

	<select id="queryMatTranMainByCode" resultMap="matTranMain" parameterType="java.util.Map">
		SELECT
		mtm.group_id as group_id,
		mtm.hos_id as hos_id,
		mtm.copy_code as copy_code,
		mtm.tran_id as tran_id,
		mtm.tran_no as 	tran_no,
		mtm.year as year,
		mtm.month as month,
		mtm.bus_type as bus_type,
		mtm.tran_method as 	tran_method,
		mtm.tran_type as tran_type,
		mtm.out_hos_id as out_hos_id,
		mtm.out_store_id as out_store_id,
		mtm.out_store_no as out_store_no,
		hsdo.store_code as out_store_code,
		hsdo.store_name as out_store_name,
		mtm.in_hos_id as in_hos_id,
		mtm.in_store_id as in_store_id,
		mtm.in_store_no as in_store_no,
		hsdi.store_code as in_store_code,
		hsdi.store_name as in_store_name,
		mtm.brief as brief,
		mtm.tran_date as tran_date,
		mtm.maker as maker,
		mtm.checker as checker,
		mtm.check_date as check_date,
		mtm.confirmer as confirmer,
		mtm.confirm_date as confirm_date,
		mtm.state as state,
		hidi.hos_no as in_hos_no,
		hidi.hos_code as in_hos_code,
		hidi.hos_name as in_hos_name,
		hido.hos_no as out_hos_no,
		hido.hos_code as out_hos_code ,
		hido.hos_name as out_hos_name
		FROM mat_tran_main 	mtm
		left join v_hos_dict hidi 
		on 
			mtm.group_id = hidi.group_id and
			mtm.in_hos_id = hidi.hos_id 
			and hidi.is_stop=0
		left join v_hos_dict hido
		on 
			mtm.group_id = hido.group_id and
			mtm.out_hos_id = hido.hos_id
			and hido.is_stop=0
		left join hos_store_dict hsdi
		on 
			mtm.group_id = hsdi.group_id 
			and	mtm.hos_id = hsdi.hos_id
			and	mtm.in_store_id = hsdi.store_id
			and hido.is_stop=0
		left join hos_store_dict hsdo
		on 
			mtm.group_id = hsdo.group_id 
			and	mtm.hos_id = hsdo.hos_id
			and	mtm.out_store_id = hsdo.store_id
			and hido.is_stop=0
		WHERE
		mtm.group_id = #{group_id,jdbcType=INTEGER} and
		mtm.hos_id = #{hos_id,jdbcType=INTEGER} and
		mtm.copy_code =
		#{copy_code,jdbcType=VARCHAR} and
		mtm.tran_id =
		#{tran_id,jdbcType=INTEGER}

	</select>

	<!-- 维护发票明细列表 -->
	<select id="queryMatInMainByInvoice" parameterType="java.util.Map"
		resultType="java.util.TreeMap">
		select mim.group_id, mim.hos_id,
		mim.copy_code, mim.in_id,
		mim.in_no, mim.bus_type_code,
		mbt.bus_type_name, 0 init,
		hsupd.sup_code, hsupd.sup_name,
		hsd.store_code, hsd.store_name,
		hdd.dept_code, hdd.dept_name, sustock.user_name as stocker_name,
		sumake.user_name as
		maker_name,
		sucheck.user_name as checker_name,
		sucon.user_name as confirmer_name, mim.confirm_date,
		mim.brief,
		sum(mid.amount_money) as payable_money, sum(mid.amount_money) as
		bill_money
		from mat_in_main
		mim
		left join mat_in_detail mid
		on
		mim.group_id = mid.group_id and mim.hos_id = mid.hos_id
		and
		mim.copy_code = mid.copy_code and mim.in_id = mid.in_id
		left join
		mat_bus_type mbt
		on mim.bus_type_code = mbt.bus_type_code
		left join
		hos_sup_dict hsupd
		on mim.group_id = hsupd.group_id and mim.hos_id =
		hsupd.hos_id
		and mim.sup_id = hsupd.sup_id and hsupd.is_stop = 0
		left
		join
		hos_store_dict hsd
		on mim.group_id = hsd.group_id and mim.hos_id =
		hsd.hos_id
		and mim.store_id = hsd.store_id and hsd.is_stop = 0
		left join
		hos_dept_dict hdd
		on mim.group_id = hdd.group_id and mim.hos_id =
		hdd.hos_id
		and mim.app_dept = hdd.dept_id and hdd.is_stop = 0
		left join
		sys_user
		sustock
		on mim.group_id = sustock.group_id and mim.hos_id =
		sustock.hos_id
		and mim.stocker = sustock.user_id
		left join sys_user
		sumake
		on mim.group_id = sumake.group_id and mim.hos_id = sumake.hos_id
		and mim.maker = sumake.user_id
		left join sys_user sucheck
		on
		mim.group_id = sucheck.group_id and mim.hos_id = sucheck.hos_id
		and
		mim.checker = sucheck.user_id
		left join sys_user sucon
		on mim.group_id =
		sucon.group_id and mim.hos_id = sucon.hos_id
		and mim.confirmer =
		sucon.user_id
		where mim.group_id =
		#{group_id,jdbcType=INTEGER}
		and
		mim.hos_id = #{hos_id,jdbcType=INTEGER}
		and mim.copy_code =
		#{copy_code,jdbcType=VARCHAR}
		and mim.in_id = #{in_id,jdbcType=INTEGER}
		AND mid.in_detail_id NOT IN (
		SELECT DISTINCT in_detail_id
		FROM
		mat_bill_detail
		WHERE group_id = #{group_id,jdbcType=INTEGER}
		AND hos_id
		= #{hos_id,jdbcType=INTEGER}
		AND copy_code =
		#{copy_code,jdbcType=VARCHAR}
		AND in_id = #{in_id,jdbcType=INTEGER})
		group by mim.group_id, mim.hos_id,
		mim.copy_code, mim.in_id, mim.in_no,
		mim.bus_type_code,
		mbt.bus_type_name, hsupd.sup_code, hsupd.sup_name,
		hsd.store_code,
		hsd.store_name, hdd.dept_code,
		hdd.dept_name,
		sustock.user_name, sumake.user_name, sucheck.user_name,
		sucon.user_name, mim.confirm_date, mim.brief
	</select>

	<!-- 入库主表模板打印 -->
	<select id="queryMatTranPrintTemlateByMain" parameterType="java.util.Map" resultType="java.util.Map">
		select mtm.tran_id as ID,mtm.tran_no AS TRAN_NO,mbt.bus_type_name BUS_TYPE_CODE,
			case mtm.tran_method when 1 then '同价调拨' when 2 then '异价调拨' end TRAN_METHOD,
			case mtm.tran_type when 1 then '院内调拨' when 2 then '院外调拨' end TRAN_TYPE,
			out_hos.hos_name OUT_HOS, out_stroe.store_name OUT_STORE,in_hos.hos_name IN_HOS ,
			in_stroe.store_name IN_STORE, mtm.brief BRIEF ,su_maker.user_name MAKER, 
			to_char(mtm.tran_date, 'yyyy-MM-dd hh24:mi:ss') TRAN_DATE,
			su_checker.user_name CHECKER,to_char(mtm.check_date, 'yyyy-MM-dd hh24:mi:ss') CHECK_DATE,
			su_confirmer.user_name CONFIRMER,to_char(mtm.confirm_date, 'yyyy-MM-dd hh24:mi:ss') CONFIRM_DATE,
			mtd.money_sum as MONEY_SUM, mtd.money_sum MONEY_SUM_UPPER
		from mat_tran_main mtm
		left join mat_bus_type mbt on mtm.bus_type = mtm.bus_type
		left join v_hos_dict out_hos 
			on mtm.group_id = out_hos.group_id
			and mtm.in_hos_id = out_hos.hos_id
			and out_hos.is_stop = '0'
		left join hos_store_dict out_stroe 
			on mtm.group_id = out_stroe.group_id
			and mtm.hos_id = out_stroe.hos_id 
			and mtm.out_store_id = out_stroe.store_id
			and mtm.out_store_no = out_stroe.store_no
			and out_stroe.is_stop = '0'
		left join v_hos_dict in_hos 
			on mtm.group_id = in_hos.group_id
			and mtm.in_hos_id = in_hos.hos_id
			and in_hos.is_stop = '0'
		left join hos_store_dict in_stroe 
			on mtm.group_id = in_stroe.group_id
			and mtm.hos_id = in_stroe.hos_id 
			and mtm.in_store_id = in_stroe.store_id
			and mtm.in_store_no = in_stroe.store_no
			and in_stroe.is_stop = '0'
		left join sys_user su_maker 
			on mtm.group_id = su_maker.group_id
			and mtm.hos_id = su_maker.hos_id 
			and mtm.maker = su_maker.user_id
		left join sys_user su_checker 
			on mtm.group_id = su_checker.group_id
			and mtm.hos_id = su_checker.hos_id 
			and mtm.checker = su_checker.user_id
		left join sys_user su_confirmer 
			on mtm.group_id = su_confirmer.group_id
			and mtm.hos_id = su_confirmer.hos_id 
			and mtm.confirmer = su_confirmer.user_id
		left join (
			select tran_id, sum(amount_money) money_sum 
			from mat_tran_detail 
			where group_id = #{group_id,jdbcType=NUMERIC}
				and hos_id = #{hos_id,jdbcType=NUMERIC}
				and copy_code = #{copy_code,jdbcType=VARCHAR}
				and tran_id=#{tran_id,jdbcType=NUMERIC}
			group by tran_id
		)mtd
			on mtm.tran_id = mtd.tran_id
		where mtm.group_id = #{group_id,jdbcType=NUMERIC}
			and mtm.hos_id = #{hos_id,jdbcType=NUMERIC}
			and mtm.copy_code = #{copy_code,jdbcType=VARCHAR}
			and mtm.tran_id=#{tran_id,jdbcType=NUMERIC}
	</select>
	<select id="queryMatTranPrintTemlateByMainBatch" parameterType="java.util.Map" resultType="java.util.Map">
		select mtm.tran_id as ID, mtm.tran_no AS TRAN_NO,mbt.bus_type_name BUS_TYPE_CODE,
			case mtm.tran_method when 1 then '同价调拨' when 2 then '异价调拨' end TRAN_METHOD,
			case mtm.tran_type when 1 then '院内调拨' when 2 then '院外调拨' end TRAN_TYPE,
			out_hos.hos_name OUT_HOS, out_stroe.store_name OUT_STORE,in_hos.hos_name IN_HOS ,
			in_stroe.store_name IN_STORE, mtm.brief BRIEF ,su_maker.user_name MAKER, 
			to_char(mtm.tran_date, 'yyyy-MM-dd hh24:mi:ss') TRAN_DATE,
			su_checker.user_name CHECKER,to_char(mtm.check_date, 'yyyy-MM-dd hh24:mi:ss') CHECK_DATE,
			su_confirmer.user_name CONFIRMER,to_char(mtm.confirm_date, 'yyyy-MM-dd hh24:mi:ss') CONFIRM_DATE,
			mtd.money_sum AS MONEY_SUM, 
			mtd.money_sum MONEY_SUM_UPPER
		from mat_tran_main mtm
		left join mat_bus_type mbt on mtm.bus_type = mtm.bus_type
		left join v_hos_dict out_hos 
			on mtm.group_id = out_hos.group_id
			and mtm.in_hos_id = out_hos.hos_id
			and out_hos.is_stop = '0'
		left join hos_store_dict out_stroe 
			on mtm.group_id = out_stroe.group_id
			and mtm.hos_id = out_stroe.hos_id 
			and mtm.out_store_id = out_stroe.store_id
			and mtm.out_store_no = out_stroe.store_no
			and out_stroe.is_stop = '0'
		left join v_hos_dict in_hos 
			on mtm.group_id = in_hos.group_id
			and mtm.in_hos_id = in_hos.hos_id
			and in_hos.is_stop = '0'
		left join hos_store_dict in_stroe 
			on mtm.group_id = in_stroe.group_id
			and mtm.hos_id = in_stroe.hos_id 
			and mtm.in_store_id = in_stroe.store_id
			and mtm.in_store_no = in_stroe.store_no
			and in_stroe.is_stop = '0'
		left join sys_user su_maker 
			on mtm.group_id = su_maker.group_id
			and mtm.hos_id = su_maker.hos_id 
			and mtm.maker = su_maker.user_id
		left join sys_user su_checker 
			on mtm.group_id = su_checker.group_id
			and mtm.hos_id = su_checker.hos_id 
			and mtm.checker = su_checker.user_id
		left join sys_user su_confirmer 
			on mtm.group_id = su_confirmer.group_id
			and mtm.hos_id = su_confirmer.hos_id 
			and mtm.confirmer = su_confirmer.user_id
		left join (
			select tran_id, sum(amount_money) money_sum 
			from mat_tran_detail 
			where group_id = #{group_id,jdbcType=NUMERIC}
				and hos_id = #{hos_id,jdbcType=NUMERIC}
				and copy_code = #{copy_code,jdbcType=VARCHAR}
				and tran_id in  (${paraId})
			group by tran_id
		)mtd
			on mtm.tran_id = mtd.tran_id
		where mtm.group_id = #{group_id,jdbcType=NUMERIC}
			and mtm.hos_id = #{hos_id,jdbcType=NUMERIC}
			and mtm.copy_code = #{copy_code,jdbcType=VARCHAR}
			and mtm.tran_id in  (${paraId})
	</select>

	<!-- 入库明细表模板打印 -->
	<select id="queryMatTranPrintTemlateByDetail" parameterType="java.util.Map" resultType="java.util.Map">
		select mtd.tran_id as id,
			mid.inv_code INV_CODE,mid.inv_name INV_NAME,mid.inv_model INV_MODEL,hu.unit_name UNIT_CODE,
			mtd.price PRICE,mtd.amount AMOUNT,mtd.amount_money MONEY,hfd.fac_name FAC_NAME ,mtd.note NOTE,
			hp.pack_name PACK_CODE,mtd.num_exchange NUM_EXCHANGE ,mtd.num NUM,mtd.batch_sn BATCH_SN,
			mtd.batch_no BATCH_NO, '' sn,mtd.bar_code BAR_CODE,to_char(mtd.inva_date, 'yyyy-MM-dd') INVA_DATE,
			mld.location_name LOCATION_NAME, to_char(mtd.disinfect_date, 'yyyy-MM-dd') DISINFECT_DATE, 
			mtd.sale_price,mtd.sale_money,mtd.sell_price,mtd.sell_money, mtd.allot_price,mtd.allot_money,mid.bid_code,
			 case when mtm.state = 3 then nvl(mfb.left_amount - nvl(vmsi.amount, 0), 0)
       		else nvl(mfb.left_amount - nvl(vmsi.amount, 0) + nvl(mtd.amount,0), 0) end as imme_amount,mldin.location_name as location_in_name,mldout.location_name as location_out_name
		from mat_tran_detail mtd
		left join mat_inv_dict mid 
			on mtd.group_id = mid.group_id
			and mtd.hos_id = mid.hos_id 
			and mtd.copy_code = mid.copy_code
			and mtd.inv_id = mid.inv_id 
			and mtd.inv_no = mid.inv_no
		left join hos_unit hu 
			on mtd.group_id = hu.group_id
			and mtd.hos_id = hu.hos_id
			and hu.unit_code = mid.unit_code
		left join hos_fac_dict hfd
			on hfd.group_id = mid.group_id
			and hfd.hos_id = mid.hos_id and
			hfd.fac_id = mid.fac_id
			and hfd.fac_no = mid.fac_no
		left join hos_package hp
			on mtd.group_id = hp.group_id 
			and mtd.hos_id = hp.hos_id
			and hp.pack_code = mtd.pack_code
		left join mat_tran_main mtm on mtd.tran_id=mtm.tran_id
		 
		left join mat_store_inv msi on 
		        mtd.group_id = msi.group_id
			and mtd.hos_id = msi.hos_id 
			and mtd.copy_code = msi.copy_code
			and mtd.inv_id = msi.inv_id 
			and msi.store_id = mtm.out_store_id
			
		left join mat_location_dict mld 
			on mld.group_id = mtd.group_id
			and mld.hos_id = mtd.hos_id 
			and mld.copy_code = mtd.copy_code
			and mld.location_id = msi.location_id
			and mld.is_stop = '0'
		left join mat_location_dict mldout on mldout.group_id = mtd.group_id
			and mldout.hos_id = mtd.hos_id
			and mldout.copy_code = mtd.copy_code
			and mldout.location_id = msi.location_id
			and mldout.is_stop = '0' 
		left join mat_location_dict mldin on mldin.group_id = mtd.group_id
			and mldin.hos_id = mtd.hos_id
			and mldin.copy_code = mtd.copy_code
			and mldin.location_id = msi.location_id
			and mldin.is_stop = '0' 
		left join mat_fifo_balance mfb
		   on mtd.group_id = mfb.group_id
		  and mtd.hos_id = mfb.hos_id
		  and mtd.copy_code = mfb.copy_code
		  and mtm.out_store_id = mfb.store_id
		  and mtd.inv_id = mfb.inv_id
		  and mtd.price = mfb.price
		  and mtd.batch_no = mfb.batch_no
		  and mtd.batch_sn = mfb.batch_sn
		  and mtd.bar_code = mfb.bar_code
		 left join v_mat_stock_imme vmsi
		   on mfb.group_id = vmsi.group_id
		  and mfb.hos_id = vmsi.hos_id
		  and mfb.copy_code = vmsi.copy_code
		  and mfb.store_id = vmsi.store_id
		  and mfb.inv_id = vmsi.inv_id
		  and mfb.price = vmsi.price
		  and mfb.batch_no = vmsi.batch_no
		  and mfb.batch_sn = vmsi.batch_sn
		  and mfb.bar_code = vmsi.bar_code
		  and mfb.location_id = vmsi.location_id	
		
		where mtd.group_id =#{group_id,jdbcType=NUMERIC}
			and mtd.hos_id = #{hos_id,jdbcType=NUMERIC}
			and mtd.copy_code = #{copy_code,jdbcType=VARCHAR}
			<if test="p_num ==1">
				and mtd.tran_id in (${paraId})
				
			</if>
			<if test="p_num ==0">
				and mtd.tran_id=#{tran_id,jdbcType=NUMERIC}
			</if>	
		<!-- order by mld.location_name,mid.inv_code desc -->
		
order by mld.location_name desc, mid.inv_code desc,mtd.bar_code asc
	</select>
	
	<!-- 确认前单据状态校验 -->
	<select id="existsMatTranStateForConfirm" parameterType="java.util.List" resultType="java.lang.Integer" >
		SELECT count(1)
		FROM MAT_TRAN_MAIN
		WHERE
		<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
			group_id = #{item.group_id,jdbcType=INTEGER}
			and hos_id = #{item.hos_id,jdbcType=INTEGER}
			and copy_code = #{item.copy_code,jdbcType=VARCHAR}
			and tran_id = #{item.tran_id,jdbcType=INTEGER}
			and state = 3
		</foreach>
	</select>
	
	<select id="queryMatTranMainForDura" parameterType="java.util.List" resultType="java.util.Map">
		SELECT
      a.group_id, a.hos_id, a.copy_code, a.out_store_id, d.store_no,
      b.inv_id, c.inv_no, c.inv_code, c.inv_name, b.price, b.bar_code, 
      sum(b.amount) as amount, sum(b.amount_money) as amount_money 
    FROM MAT_TRAN_MAIN a 
    LEFT JOIN MAT_TRAN_detail b 
      ON a.group_id = b.group_id AND a.hos_id = b.hos_id 
      AND a.copy_code = b.copy_code AND a.tran_id =b.tran_id
    LEFT JOIN mat_inv_dict c 
      ON b.group_id = c.group_id AND b.hos_id = c.hos_id 
      AND b.copy_code = c.copy_code AND b.inv_id = c.inv_id 
      AND c.is_stop = 0 
    LEFT JOIN hos_store_dict d 
      ON a.group_id = d.group_id AND a.hos_id = d.hos_id 
      AND a.out_store_id = d.store_id AND d.is_stop = 0
  group by  a.group_id, a.hos_id, a.copy_code, a.out_store_id, d.store_no,
      b.inv_id, c.inv_no, c.inv_code, c.inv_name, b.price, b.bar_code
     
		WHERE
		<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
				a.group_id = #{item.group_id,jdbcType=INTEGER}
			AND a.hos_id = #{item.hos_id,jdbcType=INTEGER}
			AND a.copy_code = #{item.copy_code,jdbcType=VARCHAR}
			AND a.tran_id = #{item.tran_id,jdbcType=INTEGER}
		</foreach>
		AND c.is_dura = 1
		group by  a.group_id, a.hos_id, a.copy_code, a.out_store_id, d.store_no,
      b.inv_id, c.inv_no, c.inv_code, c.inv_name, b.price, b.bar_code
		order by b.inv_id asc
	</select>
</mapper>

