<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.mat.dao.storage.query.MatInSupCountMapper">

	<resultMap id="queryMatStorageQueryMatInSupCountMap" type="java.util.Map">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="sup_code" column="sup_code" />
		<result property="sup_name" column="sup_name" />
		<result property="amount_money" column="amount_money" />
		<result property="mat_type_count" column="mat_type_count" />
		<result property="in_id_count" column="in_id_count" />
		<result property="store_name" column="store_name"/>
		<result property="set_name" column="set_name"/>
		<result property="money" column="money"/>
		<result property="mat_type_code" column="mat_type_code"/>
		<result property="mat_type_name" column="mat_type_name"/>
		<result property="is_last" column="is_last"/>
		<result property="type_level" column="type_level"/>
		<result property="bus_type_code" column="bus_type_code"/>
		<result property="bus_type_name" column="bus_type_name"/>
	</resultMap> 
	
	<select id="queryOccurMatTypeDictForVariableHead" parameterType="java.util.Map" resultMap="queryMatStorageQueryMatInSupCountMap">
		select distinct mtd.mat_type_code,mtd.mat_type_name
		from mat_type_dict mtd
		right join (
		  select distinct mtd.group_id,mtd.hos_id,mtd.copy_code,mtd.mat_type_code
		  from mat_in_main mim
		  left join mat_in_detail mid
		  on mid.group_id=mim.group_id
		  and mid.hos_id=mim.hos_id
		  and mid.copy_code=mim.copy_code
		  and mid.in_id=mim.in_id
		  left join mat_inv_dict midd 
		  on midd.group_id=mid.group_id
		  and midd.hos_id=mid.hos_id
		  and midd.copy_code=mid.copy_code
		  and midd.inv_id=mid.inv_id
		  and midd.is_stop=0
		  left join mat_type_dict mtd
		  on mtd.group_id=midd.group_id
		  and mtd.hos_id=midd.hos_id
		  and mtd.copy_code=midd.copy_code
		  and mtd.mat_type_id=midd.mat_type_id
		  and mtd.is_stop=0
		  left join mat_store_detail msd
		  on msd.group_id=mim.group_id
		  and msd.hos_id=mim.hos_id
		  and msd.store_id=mim.store_id
		  <where>
		  	mim.state = '3'
	  		and mim.group_id = #{group_id}
       		and mim.hos_id = #{hos_id}
       		and mim.copy_code = #{copy_code} 
		  	<!-- 只显示有权限的库房信息 -->
			and to_char(mim.store_id) in (
				select perm_code from v_user_data_perm  
				where group_id = #{group_id,jdbcType=INTEGER}
					and hos_id = #{hos_id,jdbcType=INTEGER}
					and table_code = 'HOS_STORE_DICT'
					and user_id = #{user_id,jdbcType=INTEGER}
					and is_read = 1 and is_write = 1 
			)
		  	<if test="begin_confirm_date!=null and begin_confirm_date!=''">
		  		and mim.confirm_date &gt;=to_date(#{begin_confirm_date},'yyyy-MM-dd')
		  	</if>
		  	<if test="end_confirm_date!=null and end_confirm_date!=''">
		  		and mim.confirm_date &lt;= to_date(#{end_confirm_date},'yyyy-MM-dd')
		  	</if>
		  	<if test="mat_type_code !=null and mat_type_code != ''">
				and mtd.mat_type_code like '%${mat_type_code}'
			</if>
			<if test="set_id==null or set_id == ''"> 
				<if test="store_id != null and store_id != ''">
					and mim.store_id = #{store_id}
				</if>
			</if>
			<if test="set_id!=null and set_id!=''">
		  		and msd.set_id=#{set_id}
		  	</if>
	  		<if test='bus_type_code !=null and bus_type_code == "2"'>
				and mim.bus_type_code in ('2','47')
			</if>
	         <if test='bus_type_code !=null and bus_type_code == "12"'>
				and mim.bus_type_code in ('12','48')
			</if>
	         <if test='bus_type_code !=null and bus_type_code != "" and bus_type_code!="2" and bus_type_code!="12"'>
				and mim.bus_type_code = #{bus_type_code}
			</if>
	         <if test="bus_type_code ==null or bus_type_code == ''">
				and mim.bus_type_code in ('10' ,'12' ,'2', '22' ,'4' ,'6', '47', '48' ,'8' ,'18','16')
			</if>
		  	<if test="sup_id!=null and sup_id!=''">
		  		and mim.sup_id!=#{sup_id}
		  	</if>
		  	<if test="is_charge!=null and is_charge!=''">
		  		and midd.is_charge=#{is_charge}
		  	</if>
		  </where>
		) tmp
		on tmp.group_id=mtd.group_id
		and tmp.hos_id=mtd.hos_id
		and tmp.copy_code=mtd.copy_code
		and mtd.is_stop=0
		and tmp.mat_type_code like mtd.mat_type_code||'%'
		<where>
			 <if test="type_level!= null and type_level!=''">
				 <if test="type_level==1">
				 	 and mtd.type_level= 1
				 </if>
				 <if test="type_level!=1">
				 	 and mtd.is_last=1
				 </if>
			 </if>
		</where>
		order by mtd.mat_type_code 
	
	</select>


	<select id="queryMatStorageQueryMatInSupCount" parameterType="java.util.Map"
		resultMap="queryMatStorageQueryMatInSupCountMap">
		<!-- wuzi  -->
 		with mat_in_type as (
			select b.bus_type_name ,a.mat_type_code, b.sup_code, b.sup_name, sum(b.money) as money, a.is_last
				, a.type_level, b.bus_type_code
			from mat_type_dict a
			right join (
				select mbt.bus_type_name, hsd.sup_code, hsd.sup_name, sum(mid.amount_money) as money, mtd.mat_type_code, mim.bus_type_code
				from MAT_IN_MAIN mim
				left join mat_in_detail mid on mim.group_id = mid.group_id
				and mim.hos_id = mid.hos_id
				and mim.copy_code = mid.copy_code
				and mim.in_id = mid.in_id 
				left join mat_inv_dict midd on midd.group_id = mim.group_id
				and midd.hos_id = mim.hos_id
				and midd.copy_code = mim.copy_code
				and midd.inv_id = mid.inv_id
				and midd.inv_no = mid.inv_no 
				left join mat_type_dict mtd on
				
				 midd.mat_type_id = mtd.mat_type_id
				 and  midd.mat_type_no = mtd.mat_type_no
				and mim.group_id = mtd.group_id
				and mim.hos_id = mtd.hos_id
				and mim.copy_code = mtd.copy_code
				
				left join hos_sup_dict hsd on mim.sup_id = hsd.sup_id
				and hsd.is_stop = 0
				and hsd.group_id = mim.group_id
				and hsd.hos_id = mim.hos_id 
        		left join mat_bus_type mbt  on mim.bus_type_code= mbt.bus_type_code
        		and mbt.is_stop=0
        	where mim.state = '3'
               	and mim.group_id = #{group_id}
          		and mim.hos_id = #{hos_id}
          		and mim.copy_code = #{copy_code} 
          		
          		<if test='bus_type_code !=null and bus_type_code == "2"'>
					and mim.bus_type_code in ('2','47')
				</if>
		         <if test='bus_type_code !=null and bus_type_code == "12"'>
					and mim.bus_type_code in ('12','48')
				</if>
		         <if test='bus_type_code !=null and bus_type_code != "" and bus_type_code!="2" and bus_type_code!="12"'>
					and mim.bus_type_code = #{bus_type_code}
				</if>
		         <if test="bus_type_code ==null or bus_type_code == ''">
					and mim.bus_type_code in ('10' ,'12' ,'2', '22' ,'4' ,'6', '47', '48' ,'8' ,'18','16')
				</if>
				<if test="begin_confirm_date != null and begin_confirm_date != '' and  end_confirm_date != null and end_confirm_date != ''">
					and to_char(mim.confirm_date, 'yyyy-MM-dd')  between #{begin_confirm_date} and #{end_confirm_date}
				</if>
				<if test="mat_type_code !=null and mat_type_code != ''">
					and mtd.mat_type_code like '%${mat_type_code}'
				</if>
				
				<!-- 只显示有权限的库房信息 -->
				and to_char(mim.store_id) in (
					select perm_code from v_user_data_perm  
					where group_id = #{group_id,jdbcType=INTEGER}
						and hos_id = #{hos_id,jdbcType=INTEGER}
						and table_code = 'HOS_STORE_DICT'
						and user_id = #{user_id,jdbcType=INTEGER}
						and is_read = 1 and is_write = 1 
				)
				<if test="set_id==null or set_id == ''"> 
					<if test="store_id != null and store_id != ''">
						and mim.store_id = #{store_id}
					</if>
				</if>
				<if test="set_id!=null and set_id!=''">
						and mim.store_id in (select distinct store_id from MAT_STORE_DETAIL  where set_id = #{set_id})
				</if>
				<if test="begin_in_date != null and begin_in_date != '' and end_in_date != null and end_in_date != ''">
					AND mim.in_date between to_date(#{begin_in_date},'yyyy-MM-dd') and to_date(#{end_in_date},'yyyy-MM-dd')
				</if>
				<if test="sup_id != null and sup_id != ''">
					and mim.sup_id = #{sup_id}
				</if>
				<if test="sup_no !=null and sup_no != ''">
					and mim.sup_no= #{sup_no}
				</if>
				<if test="is_charge !=null and is_charge != ''">
					and midd.is_charge= #{is_charge}
				</if>
        		group by  mbt.bus_type_name,hsd.sup_code,hsd.sup_name,mtd.mat_type_code,mim.bus_type_code
        		order by hsd.sup_code
        	) b on b.mat_type_code like a.mat_type_code||'%'
        <where>
			a.is_stop=0	
			and a.group_id = #{group_id}
            and a.hos_id = #{hos_id}
            and a.copy_code = #{copy_code}	
			and b.money != 0
		</where>  
            group by b.bus_type_name ,a.mat_type_code,b.sup_code,b.sup_name,a.is_last,a.type_level,b.bus_type_code
    	      order by mat_type_code), 
	  dataAll as(
	  	select to_char('采购入库') as bus_type_name, mat_type_code, sup_code, to_char(sup_name) as sup_name, sum(money) money
			, is_last, type_level, to_char('2') bus_type_code
		from mat_in_type
		where bus_type_code in ('2','47')
		group by mat_type_code, sup_code, to_char(sup_name), is_last, type_level 
		
		union all
		select to_char('采购退库') as bus_type_name, mat_type_code, sup_code, to_char(sup_name) as sup_name, sum(money)
			, is_last, type_level, to_char('12') bus_type_code
		from mat_in_type
		where bus_type_code in ('12','48')
		group by mat_type_code, sup_code, to_char(sup_name), is_last, type_level 
		union all
		select to_char(bus_type_name) as bus_type_name , mat_type_code, sup_code, to_char(sup_name) as sup_name, money
			, is_last, type_level, to_char(bus_type_code)
		from mat_in_type
		where bus_type_code in ( '10', '22',  '8',  '18',  '16','4','6' )
			  --and  sup_code != ' '
				),
				subtotal as(
<if test='bus_type_code != null and bus_type_code == "2"'>
select           
                 bus_type_name,
                 mat_type_code,
                 sup_code,
                 sup_name,
                 money,
                 is_last,
                 type_level,
                 bus_type_code
            from (select a2.*, rownum as rn
                    from (select null as sup_code,
                                 to_char(02) as mat_type_code,
                                 '采购入库(小计)' as bus_type_name,
                                 null as sup_name,
                                 0.00 as money,
                                 1 as is_last,
                                 1 as type_level,
                                 'cgrk' as bus_type_code
                            from dual 
                          union all
                          select null as sup_code,
                                 to_char(mat_type_code) as mat_type_code,
                                 '采购入库(小计)' as bus_type_name,
                                 null as sup_name,
                                 sum(money) as money,
                                 is_last,
                                 type_level,
                                 'cgrk' as bus_type_code
                            from mat_in_type
                           where bus_type_code = '2'
                           group by mat_type_code, is_last, type_level, bus_type_code) a2)
           where rn > case
                   when (select count(1) from mat_in_type where bus_type_code = '2') > 0 then
                    1
                   else
                    0
                 end
               union all  
                 select bus_type_name,
                 mat_type_code,
                 sup_code,
                 sup_name,
                 money,
                 is_last,
                 type_level,
                 bus_type_code
            from (select a47.*, rownum as rn
                    from (select null as sup_code,
                                 to_char(02) as mat_type_code,
                                 '采购入库(小计)' as bus_type_name,
                                 null as sup_name,
                                 0.00 as money,
                                 1 as is_last,
                                 1 as type_level,
                                 'cgrk' as bus_type_code
                            from dual
                          union all
                          select null as sup_code,
                                 to_char(mat_type_code) as mat_type_code,
                                 '采购入库(小计)' as bus_type_name,
                                 null as sup_name,
                                 sum(money) as money,
                                 is_last,
                                 type_level,
                                 'cgrk' as bus_type_code
                            from mat_in_type
                           where bus_type_code = '47'
                           group by mat_type_code, is_last, type_level, bus_type_code) a47)
           where rn > case
                   when (select count(1) from mat_in_type where bus_type_code = '47') > 0 then
                    1
                   else
                    0
                 end
</if>  
<if test='bus_type_code != null and bus_type_code == "12"'>
          select bus_type_name,
                 mat_type_code,
                 sup_code,
                 sup_name,
                 money,
                 is_last,
                 type_level,
                 bus_type_code
            from (select a12.*, rownum as rn
                    from (select null as sup_code,
                                 to_char(02) as mat_type_code,
                                 '采购退库(小计)' as bus_type_name,
                                 null as sup_name,
                                 0.00 as money,
                                 1 as is_last,
                                 1 as type_level,
                                 'cgtk' as bus_type_code
                            from dual
                          union all
                          select null as sup_code,
                                 to_char(mat_type_code) as mat_type_code,
                                 '采购退库(小计)' as bus_type_name,
                                 null as sup_name,
                                 sum(money) as money,
                                 is_last,
                                 type_level,
                                 'cgtk' as bus_type_code
                            from mat_in_type
                           where bus_type_code = '12'
                           group by mat_type_code, is_last, type_level, bus_type_code) a12)
           where rn > case
                   when (select count(1) from mat_in_type where bus_type_code = '12') > 0 then
                    1
                   else
                    0
                 end
                 
                 union all
                     select bus_type_name,
                 mat_type_code,
                 sup_code,
                 sup_name,
                 money,
                 is_last,
                 type_level,
                 bus_type_code
            from (select a48.*, rownum as rn
                    from (select null as sup_code,
                                 to_char(02) as mat_type_code,
                                 '采购退库(小计)' as bus_type_name,
                                 null as sup_name,
                                 0.00 as money,
                                 1 as is_last,
                                 1 as type_level,
                                 'cgtk' as bus_type_code
                            from dual
                          union all
                          select null as sup_code,
                                 to_char(mat_type_code) as mat_type_code,
                                 '采购退库(小计)' as bus_type_name,
                                 null as sup_name,
                                 sum(money) as money,
                                 is_last,
                                 type_level,
                                 'cgtk' as bus_type_code
                            from mat_in_type
                           where bus_type_code = '48'
                           group by mat_type_code, is_last, type_level, bus_type_code) a48)
           where rn > case
                   when (select count(1) from mat_in_type where bus_type_code = '48') > 0 then
                    1
                   else
                    0
                 end
</if>

<if test='bus_type_code != null and bus_type_code == "4"'>          
          select bus_type_name,
                 mat_type_code,
                 sup_code,
                 sup_name,
                 money,
                 is_last,
                 type_level,
                 bus_type_code
            from (select a4.*, rownum as rn
                    from (select null as sup_code,
                                 to_char(02) as mat_type_code,
                                 '有偿调入(小计)' as bus_type_name,
                                 null as sup_name,
                                 0.00 as money,
                                 1 as is_last,
                                 1 as type_level,
                                 'ycdr' as bus_type_code
                            from dual
                          union all
                          select null as sup_code,
                                 to_char(mat_type_code) as mat_type_code,
                                 '有偿调入(小计)' as bus_type_name,
                                 null as sup_name,
                                 sum(money) as money,
                                 is_last,
                                 type_level,
                                 'ycdr' as bus_type_code
                            from mat_in_type
                           where bus_type_code = '4'
                           group by mat_type_code, is_last, type_level, bus_type_code) a4)
           where rn > case
                   when (select count(1) from mat_in_type where bus_type_code = '4') > 0 then
                    1
                   else
                    0
                 end
</if>
<if test='bus_type_code != null and bus_type_code == "6"'>          
          select bus_type_name,
                 mat_type_code,
                 sup_code,
                 sup_name,
                 money,
                 is_last,
                 type_level,
                 bus_type_code
            from (select a6.*, rownum as rn
                    from (select null as sup_code,
                                 to_char(02) as mat_type_code,
                                 '无偿调入(小计)' as bus_type_name,
                                 null as sup_name,
                                 0.00 as money,
                                 1 as is_last,
                                 1 as type_level,
                                 'wcdr' as bus_type_code
                            from dual
                          union all
                          select null as sup_code,
                                 to_char(mat_type_code) as mat_type_code,
                                 '无偿调入(小计)' as bus_type_name,
                                 null as sup_name,
                                 sum(money) as money,
                                 is_last,
                                 type_level,
                                 'wcdr' as bus_type_code
                            from mat_in_type
                           where bus_type_code = '6'
                           group by mat_type_code, is_last, type_level, bus_type_code) a6)
           where rn > case
                   when (select count(1) from mat_in_type where bus_type_code = '6') > 0 then
                    1
                   else
                    0
                 end
                 </if> 
                 <if test='bus_type_code != null and bus_type_code == "8"'>          
          select bus_type_name,
                 mat_type_code,
                 sup_code,
                 sup_name,
                 money,
                 is_last,
                 type_level,
                 bus_type_code
            from (select a8.*, rownum as rn
                    from (select null as sup_code,
                                 to_char(02) as mat_type_code,
                                 '盘盈入库(小计)' as bus_type_name,
                                 null as sup_name,
                                 0.00 as money,
                                 1 as is_last,
                                 1 as type_level,
                                 'pyrk' as bus_type_code
                            from dual
                          union all
                          select null as sup_code,
                                 to_char(mat_type_code) as mat_type_code,
                                 '盘盈入库(小计)' as bus_type_name,
                                 null as sup_name,
                                 sum(money) as money,
                                 is_last,
                                 type_level,
                                 'pyrk' as bus_type_code
                            from mat_in_type
                           where bus_type_code = '8'
                           group by mat_type_code, is_last, type_level, bus_type_code) a8)
           where rn > case
                   when (select count(1) from mat_in_type where bus_type_code = '8') > 0 then
                    1
                   else
                    0
                 end
                 </if> 
                 <if test='bus_type_code != null and bus_type_code == "10"'>          
          select bus_type_name,
                 mat_type_code,
                 sup_code,
                 sup_name,
                 money,
                 is_last,
                 type_level,
                 bus_type_code
            from (select a10.*, rownum as rn
                    from (select null as sup_code,
                                 to_char(02) as mat_type_code,
                                 '其他入库(小计)' as bus_type_name,
                                 null as sup_name,
                                 0.00 as money,
                                 1 as is_last,
                                 1 as type_level,
                                 'qtrk' as bus_type_code
                            from dual
                          union all
                          select null as sup_code,
                                 to_char(mat_type_code) as mat_type_code,
                                 '其他入库(小计)' as bus_type_name,
                                 null as sup_name,
                                 sum(money) as money,
                                 is_last,
                                 type_level,
                                 'qtrk' as bus_type_code
                            from mat_in_type
                           where bus_type_code = '10'
                           group by mat_type_code, is_last, type_level, bus_type_code) a10)
           where rn > case
                   when (select count(1) from mat_in_type where bus_type_code = '10') > 0 then
                    1
                   else
                    0
                 end
                 </if>
                 <if test='bus_type_code != null and bus_type_code == "22"'>          
          select bus_type_name,
                 mat_type_code,
                 sup_code,
                 sup_name,
                 money,
                 is_last,
                 type_level,
                 bus_type_code
            from (select a22.*, rownum as rn
                    from (select null as sup_code,
                                 to_char(02) as mat_type_code,
                                 '捐赠入库(小计)' as bus_type_name,
                                 null as sup_name,
                                 0.00 as money,
                                 1 as is_last,
                                 1 as type_level,
                                 'jzrk' as bus_type_code
                            from dual
                          union all
                          select null as sup_code,
                                 to_char(mat_type_code) as mat_type_code,
                                 '捐赠入库(小计)' as bus_type_name,
                                 null as sup_name,
                                 sum(money) as money,
                                 is_last,
                                 type_level,
                                 'jzrk' as bus_type_code
                            from mat_in_type
                           where bus_type_code = '22'
                           group by mat_type_code, is_last, type_level, bus_type_code) a22)
           where rn > case
                   when (select count(1) from mat_in_type where bus_type_code = '22') > 0 then
                    1
                   else
                    0
                 end
                 </if>
                 <if test='bus_type_code != null and bus_type_code == "16"'>          
          select bus_type_name,
                 mat_type_code,
                 sup_code,
                 sup_name,
                 money,
                 is_last,
                 type_level,
                 bus_type_code
            from (select a16.*, rownum as rn
                    from (select null as sup_code,
                                 to_char(02) as mat_type_code,
                                 '自制品入库(小计)' as bus_type_name,
                                 null as sup_name,
                                 0.00 as money,
                                 1 as is_last,
                                 1 as type_level,
                                 'zzprk' as bus_type_code
                            from dual
                          union all
                          select null as sup_code,
                                 to_char(mat_type_code) as mat_type_code,
                                 '自制品入库(小计)' as bus_type_name,
                                 null as sup_name,
                                 sum(money) as money,
                                 is_last,
                                 type_level,
                                 'zzprk' as bus_type_code
                            from mat_in_type
                           where bus_type_code = '16'
                           group by mat_type_code, is_last, type_level, bus_type_code) a16)
           where rn > case
                   when (select count(1) from mat_in_type where bus_type_code = '16') > 0 then
                    1
                   else
                    0
                 end
                 </if>
                 <if test='bus_type_code != null and bus_type_code == "18"'>          
          select bus_type_name,
                 mat_type_code,
                 sup_code,
                 sup_name,
                 money,
                 is_last,
                 type_level,
                 bus_type_code
            from (select a18.*, rownum as rn
                    from (select null as sup_code,
                                 to_char(02) as mat_type_code,
                                 '委托加工入库(小计)' as bus_type_name,
                                 null as sup_name,
                                 0.00 as money,
                                 1 as is_last,
                                 1 as type_level,
                                 'wtjgrk' as bus_type_code
                            from dual
                          union all
                          select null as sup_code,
                                 to_char(mat_type_code) as mat_type_code,
                                 '委托加工入库(小计)' as bus_type_name,
                                 null as sup_name,
                                 sum(money) as money,
                                 is_last,
                                 type_level,
                                 'wtjgrk' as bus_type_code
                            from mat_in_type
                           where bus_type_code = '18'
                           group by mat_type_code, is_last, type_level, bus_type_code) a18)
           where rn > case
                   when (select count(1) from mat_in_type where bus_type_code = '18') > 0 then
                    1
                   else
                    0
                 end
                 </if> 
                 <if test="bus_type_code == null or bus_type_code == '' ">
select bus_type_name,
				         mat_type_code,
				         sup_code,
				         sup_name,
				         money,
				         is_last,
				         type_level,
				         bus_type_code
				    from (select a2.*, rownum as rn
				            from (select null as sup_code,
				                         to_char(02) as mat_type_code,
				                         '采购入库(小计)' as bus_type_name,
				                         null as sup_name,
				                         0.00 as money,
				                         1 as is_last,
				                         1 as type_level,
				                         'cgrk' as bus_type_code
				                    from dual 
				                  union all
				                  select null as sup_code,
				                         to_char(mat_type_code) as mat_type_code,
				                         '采购入库(小计)' as bus_type_name,
				                         null as sup_name,
				                         sum(money) as money,
				                         is_last,
				                         type_level,
				                         'cgrk' as bus_type_code
				                    from mat_in_type
				                   where bus_type_code = '2'
				                   group by mat_type_code, is_last, type_level, bus_type_code) a2)
				   where rn > case
				           when (select count(1) from mat_in_type where bus_type_code = '2') > 0 then
				            1
				           else
				            0
				         end
				  union all
				  select bus_type_name,
				         mat_type_code,
				         sup_code,
				         sup_name,
				         money,
				         is_last,
				         type_level,
				         bus_type_code
				    from (select a12.*, rownum as rn
				            from (select null as sup_code,
				                         to_char(02) as mat_type_code,
				                         '采购退库(小计)' as bus_type_name,
				                         null as sup_name,
				                         0.00 as money,
				                         1 as is_last,
				                         1 as type_level,
				                         'cgtk' as bus_type_code
				                    from dual
				                  union all
				                  select null as sup_code,
				                         to_char(mat_type_code) as mat_type_code,
				                         '采购退库(小计)' as bus_type_name,
				                         null as sup_name,
				                         sum(money) as money,
				                         is_last,
				                         type_level,
				                         'cgtk' as bus_type_code
				                    from mat_in_type
				                   where bus_type_code = '12'
				                   group by mat_type_code, is_last, type_level, bus_type_code) a12)
				   where rn > case
				           when (select count(1) from mat_in_type where bus_type_code = '12') > 0 then
				            1
				           else
				            0
				         end
				         union all
				  select bus_type_name,
				         mat_type_code,
				         sup_code,
				         sup_name,
				         money,
				         is_last,
				         type_level,
				         bus_type_code
				    from (select a47.*, rownum as rn
				            from (select null as sup_code,
				                         to_char(02) as mat_type_code,
				                         '采购入库(小计)' as bus_type_name,
				                         null as sup_name,
				                         0.00 as money,
				                         1 as is_last,
				                         1 as type_level,
				                         'cgrk' as bus_type_code
				                    from dual
				                  union all
				                  select null as sup_code,
				                         to_char(mat_type_code) as mat_type_code,
				                         '采购入库(小计)' as bus_type_name,
				                         null as sup_name,
				                         sum(money) as money,
				                         is_last,
				                         type_level,
				                         'cgrk' as bus_type_code
				                    from mat_in_type
				                   where bus_type_code = '47'
				                   group by mat_type_code, is_last, type_level, bus_type_code) a47)
				   where rn > case
				           when (select count(1) from mat_in_type where bus_type_code = '47') > 0 then
				            1
				           else
				            0
				         end
				  union all
				  select bus_type_name,
				         mat_type_code,
				         sup_code,
				         sup_name,
				         money,
				         is_last,
				         type_level,
				         bus_type_code
				    from (select a48.*, rownum as rn
				            from (select null as sup_code,
				                         to_char(02) as mat_type_code,
				                         '采购退库(小计)' as bus_type_name,
				                         null as sup_name,
				                         0.00 as money,
				                         1 as is_last,
				                         1 as type_level,
				                         'cgtk' as bus_type_code
				                    from dual
				                  union all
				                  select null as sup_code,
				                         to_char(mat_type_code) as mat_type_code,
				                         '采购退库(小计)' as bus_type_name,
				                         null as sup_name,
				                         sum(money) as money,
				                         is_last,
				                         type_level,
				                         'cgtk' as bus_type_code
				                    from mat_in_type
				                   where bus_type_code = '48'
				                   group by mat_type_code, is_last, type_level, bus_type_code) a48)
				   where rn > case
				           when (select count(1) from mat_in_type where bus_type_code = '48') > 0 then
				            1
				           else
				            0
				         end
				  union all
				  select bus_type_name,
				         mat_type_code,
				         sup_code,
				         sup_name,
				         money,
				         is_last,
				         type_level,
				         bus_type_code
				    from (select a4.*, rownum as rn
				            from (select null as sup_code,
				                         to_char(02) as mat_type_code,
				                         '有偿调入(小计)' as bus_type_name,
				                         null as sup_name,
				                         0.00 as money,
				                         1 as is_last,
				                         1 as type_level,
				                         'ycdr' as bus_type_code
				                    from dual
				                  union all
				                  select null as sup_code,
				                         to_char(mat_type_code) as mat_type_code,
				                         '有偿调入(小计)' as bus_type_name,
				                         null as sup_name,
				                         sum(money) as money,
				                         is_last,
				                         type_level,
				                         'ycdr' as bus_type_code
				                    from mat_in_type
				                   where bus_type_code = '4'
				                   group by mat_type_code, is_last, type_level, bus_type_code) a4)
				   where rn > case
				           when (select count(1) from mat_in_type where bus_type_code = '4') > 0 then
				            1
				           else
				            0
				         end
				  union all
				  select bus_type_name,
				         mat_type_code,
				         sup_code,
				         sup_name,
				         money,
				         is_last,
				         type_level,
				         bus_type_code
				    from (select a6.*, rownum as rn
				            from (select null as sup_code,
				                         to_char(02) as mat_type_code,
				                         '无偿调入(小计)' as bus_type_name,
				                         null as sup_name,
				                         0.00 as money,
				                         1 as is_last,
				                         1 as type_level,
				                         'wcdr' as bus_type_code
				                    from dual
				                  union all
				                  select null as sup_code,
				                         to_char(mat_type_code) as mat_type_code,
				                         '无偿调入(小计)' as bus_type_name,
				                         null as sup_name,
				                         sum(money) as money,
				                         is_last,
				                         type_level,
				                         'wcdr' as bus_type_code
				                    from mat_in_type
				                   where bus_type_code = '6'
				                   group by mat_type_code, is_last, type_level, bus_type_code) a6)
				   where rn > case
				           when (select count(1) from mat_in_type where bus_type_code = '6') > 0 then
				            1
				           else
				            0
				         end
				  union all
				  select bus_type_name,
				         mat_type_code,
				         sup_code,
				         sup_name,
				         money,
				         is_last,
				         type_level,
				         bus_type_code
				    from (select a8.*, rownum as rn
				            from (select null as sup_code,
				                         to_char(02) as mat_type_code,
				                         '盘盈入库(小计)' as bus_type_name,
				                         null as sup_name,
				                         0.00 as money,
				                         1 as is_last,
				                         1 as type_level,
				                         'pyrk' as bus_type_code
				                    from dual
				                  union all
				                  select null as sup_code,
				                         to_char(mat_type_code) as mat_type_code,
				                         '盘盈入库(小计)' as bus_type_name,
				                         null as sup_name,
				                         sum(money) as money,
				                         is_last,
				                         type_level,
				                         'pyrk' as bus_type_code
				                    from mat_in_type
				                   where bus_type_code = '8'
				                   group by mat_type_code, is_last, type_level, bus_type_code) a8)
				   where rn > case
				           when (select count(1) from mat_in_type where bus_type_code = '8') > 0 then
				            1
				           else
				            0
				         end
				  union all
				  select bus_type_name,
				         mat_type_code,
				         sup_code,
				         sup_name,
				         money,
				         is_last,
				         type_level,
				         bus_type_code
				    from (select a10.*, rownum as rn
				            from (select null as sup_code,
				                         to_char(02) as mat_type_code,
				                         '其他入库(小计)' as bus_type_name,
				                         null as sup_name,
				                         0.00 as money,
				                         1 as is_last,
				                         1 as type_level,
				                         'qtrk' as bus_type_code
				                    from dual
				                  union all
				                  select null as sup_code,
				                         to_char(mat_type_code) as mat_type_code,
				                         '其他入库(小计)' as bus_type_name,
				                         null as sup_name,
				                         sum(money) as money,
				                         is_last,
				                         type_level,
				                         'qtrk' as bus_type_code
				                    from mat_in_type
				                   where bus_type_code = '10'
				                   group by mat_type_code, is_last, type_level, bus_type_code) a10)
				   where rn > case
				           when (select count(1) from mat_in_type where bus_type_code = '10') > 0 then
				            1
				           else
				            0
				         end
				  union all
				  select bus_type_name,
				         mat_type_code,
				         sup_code,
				         sup_name,
				         money,
				         is_last,
				         type_level,
				         bus_type_code
				    from (select a22.*, rownum as rn
				            from (select null as sup_code,
				                         to_char(02) as mat_type_code,
				                         '捐赠入库(小计)' as bus_type_name,
				                         null as sup_name,
				                         0.00 as money,
				                         1 as is_last,
				                         1 as type_level,
				                         'jzrk' as bus_type_code
				                    from dual
				                  union all
				                  select null as sup_code,
				                         to_char(mat_type_code) as mat_type_code,
				                         '捐赠入库(小计)' as bus_type_name,
				                         null as sup_name,
				                         sum(money) as money,
				                         is_last,
				                         type_level,
				                         'jzrk' as bus_type_code
				                    from mat_in_type
				                   where bus_type_code = '22'
				                   group by mat_type_code, is_last, type_level, bus_type_code) a22)
				   where rn > case
				           when (select count(1) from mat_in_type where bus_type_code = '22') > 0 then
				            1
				           else
				            0
				         end
				  union all
				  select bus_type_name,
				         mat_type_code,
				         sup_code,
				         sup_name,
				         money,
				         is_last,
				         type_level,
				         bus_type_code
				    from (select a16.*, rownum as rn
				            from (select null as sup_code,
				                         to_char(02) as mat_type_code,
				                         '自制品入库(小计)' as bus_type_name,
				                         null as sup_name,
				                         0.00 as money,
				                         1 as is_last,
				                         1 as type_level,
				                         'zzprk' as bus_type_code
				                    from dual
				                  union all
				                  select null as sup_code,
				                         to_char(mat_type_code) as mat_type_code,
				                         '自制品入库(小计)' as bus_type_name,
				                         null as sup_name,
				                         sum(money) as money,
				                         is_last,
				                         type_level,
				                         'zzprk' as bus_type_code
				                    from mat_in_type
				                   where bus_type_code = '16'
				                   group by mat_type_code, is_last, type_level, bus_type_code) a16)
				   where rn > case
				           when (select count(1) from mat_in_type where bus_type_code = '16') > 0 then
				            1
				           else
				            0
				         end
				  union all
				  select bus_type_name,
				         mat_type_code,
				         sup_code,
				         sup_name,
				         money,
				         is_last,
				         type_level,
				         bus_type_code
				    from (select a18.*, rownum as rn
				            from (select null as sup_code,
				                         to_char(02) as mat_type_code,
				                         '委托加工入库(小计)' as bus_type_name,
				                         null as sup_name,
				                         0.00 as money,
				                         1 as is_last,
				                         1 as type_level,
				                         'wtjgrk' as bus_type_code
				                    from dual
				                  union all
				                  select null as sup_code,
				                         to_char(mat_type_code) as mat_type_code,
				                         '委托加工入库(小计)' as bus_type_name,
				                         null as sup_name,
				                         sum(money) as money,
				                         is_last,
				                         type_level,
				                         'wtjgrk' as bus_type_code
				                    from mat_in_type
				                   where bus_type_code = '18'
				                   group by mat_type_code, is_last, type_level, bus_type_code) a18)
				   where rn > case
				           when (select count(1) from mat_in_type where bus_type_code = '18') > 0 then
				            1
				           else
				            0
				         end
</if>         
                 )
				    select bus_type_name,
				     to_char(mat_type_code) as mat_type_code,
				     sup_code,
				     to_char(sup_name) as sup_name,
				     money,
				     is_last,
				     type_level,
				     to_char(bus_type_code) as bus_type_code
				      from dataAll
				    union all
				   select bus_type_name,  mat_type_code, sup_code,  sup_name, money ,is_last, type_level,  bus_type_code
					from (
					select bus_type_name, to_char(mat_type_code) as mat_type_code, sup_code, to_char(sup_name) as sup_name, sum(money)as money ,is_last, type_level, to_char(bus_type_code) as bus_type_code
					from subtotal
					group by bus_type_name, mat_type_code, sup_code, sup_name, is_last, type_level, bus_type_code
					order by bus_type_name
					)
					union all
				    select '总合计',
				           to_char(mat_type_code) as mat_type_code,
				           null,
				           null as sup_name,
				           sum(money),
				           is_last,
				           type_level,
				           to_char('99') as bus_type_code
				      from subtotal
				     group by mat_type_code, is_last, type_level
															
    </select>
</mapper>

