<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.mat.dao.storage.query.MatDeptOutReportMapper">

	<resultMap id="matStorageQueryWorkDetailMap" type="java.util.Map">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="fim_type_code" column="fim_type_code" />
		<result property="fim_type_name" column="fim_type_name" />
		<result property="one_kind" column="one_kind" />
		<result property="two_kind" column="two_kind" />
		<result property="three_kind" column="three_kind" />
		<result property="four_kind" column="four_kind" />
		<result property="dept_code" column="dept_code" />
		<result property="dept_name" column="dept_name" />
		<result property="amount_money" column="amount_money" />
		
		<result property="radiaiton_one_money" column="radiaiton_one_money" />
		<result property="radiaiton_two_money" column="radiaiton_two_money" />
		<result property="radiaiton_three_money" column="radiaiton_three_money" />
		<result property="radiaiton_four_money" column="radiaiton_four_money" />
		<result property="radiaiton_five_money" column="radiaiton_five_money" />
		<result property="radiaiton_six_money" column="radiaiton_six_money" />
		<result property="radiaiton_seven_money" column="radiaiton_seven_money" />
		<result property="radiaiton_eight_money" column="radiaiton_eight_money" />
		<result property="radiaiton_nine_money" column="radiaiton_nine_money" />
		<result property="radiaiton_ten_money" column="radiaiton_ten_money" />
		<result property="radiaiton_eleven_money" column="radiaiton_eleven_money" />
	</resultMap>
	<resultMap id="queryMatInSupCountMap" type="java.util.Map">
	<result property="mat_type_id" column="mat_type_id" />
	<result property="fim_type_name" column="fim_type_name" />
	<result property="begin_money" column="begin_money" />
	<result property="in_money" column="in_money" />
	<result property="py_money" column="py_money" />
	<result property="in_money" column="in_money" />
	<result property="py_money" column="py_money" />
	<result property="in_amountMoney" column="in_amountMoney" />
	<result property="out_money" column="out_money" />
	<result property="pk_money" column="pk_money" />
	<result property="bs_money" column="bs_money" />
	<result property="out_money" column="out_money" />
	<result property="pk_money" column="pk_money" />
	<result property="bs_money" column="bs_money" />
	<result property="begin_money" column="begin_money" />
	<result property="in_money" column="in_money" />
	<result property="py_money" column="py_money" />
	<result property="out_money" column="out_money" />
	<result property="pk_money" column="pk_money" />
	<result property="bs_money" column="bs_money" />
	<result property="out_money1" column="out_money1" />
	<result property="end_amountMoney" column="end_amountMoney" />
	<result property="set_id" column="set_id" />
	<result property="store_id" column="store_id" />
	<result property="confirm_date" column="confirm_date" />
	<result property="out_amountMoney" column="out_amountMoney" />
	
	</resultMap>

	<select id="queryMatDeptOutReport" parameterType="java.util.Map"
		resultMap="matStorageQueryWorkDetailMap">
		   with out_temp as
			 (select mtm.group_id,
			         mtm.hos_id,
			         mtm.copy_code,
			         mft.fim_type_code,
			         mft.fim_type_name,
			         ms.dept_id,
			         hdd.kind_code,
			         mtd.amount_money
			    from mat_tran_detail mtd
			    left join mat_tran_main mtm
			      on mtd.group_id = mtm.group_id
			     and mtd.hos_id = mtm.hos_id
			     and mtd.copy_code = mtm.copy_code
			     and mtd.tran_id = mtm.tran_id
			    left join mat_inv_dict mid
			      on mid.group_id = mtd.group_id
			     and mid.hos_id = mtd.hos_id
			     and mid.copy_code = mtd.copy_code
			     and mid.inv_id = mtd.inv_id
			     and mid.inv_no = mtd.inv_no
			    left join mat_type_dict mtdd
			      on mtdd.group_id = mid.group_id
			     and mtdd.hos_id = mid.hos_id
			     and mtdd.copy_code = mid.copy_code
			     and mtdd.mat_type_id = mid.mat_type_id
			     and mtdd.mat_type_no = mid.mat_type_no
			    left join mat_fim_type mft
			      on mft.group_id = mtdd.group_id
			     and mft.hos_id = mtdd.hos_id
			     and mft.copy_code = mtdd.copy_code
			     and mft.fim_type_code = mtdd.fim_type_code
			    left join mat_store ms
			      on ms.group_id = mtm.group_id
			     and ms.hos_id = mtm.hos_id
			     and ms.store_id = mtm.in_store_id
			    left join hos_dept_dict hdd
			      on hdd.group_id = ms.group_id
			     and hdd.hos_id = ms.hos_id
			     and hdd.dept_id = ms.dept_id
			   where mtm.state = 3
			     and mtm.group_id =  #{group_id}
			     and mtm.hos_id = #{hos_id}
			     and mtm.copy_code = #{copy_code} 
			     <if test="set_id==null or set_id == ''"> 
					<if test="store_id != null and store_id != ''">
					 	and mtm.out_store_id = #{store_id}
					</if>
				</if>
				<if test="set_id!=null and set_id!=''">
						and mtm.out_store_id in (select distinct store_id from MAT_STORE_DETAIL  where set_id = #{set_id})
				</if> 
			     <if test="begin_confirm_date != null and begin_confirm_date != '' and  end_confirm_date != null and end_confirm_date != ''">
			     and mtm.confirm_date between to_date(#{begin_confirm_date}, 'yyyy-MM-dd')   and to_date(#{end_confirm_date}, 'yyyy-MM-dd')
			     </if>
			     
			   union all
				  select mom.group_id,
				         mom.hos_id,
				         mom.copy_code,
				         mft.fim_type_code,
				         mft.fim_type_name,
				         mom.dept_id,
				         hdd.kind_code,
				         mod.amount_money
				    from mat_out_detail mod
				    left join mat_out_main mom
				      on mod.group_id = mom.group_id
				     and mod.hos_id = mom.hos_id
				     and mod.copy_code = mom.copy_code
				     and mod.out_id = mom.out_id
				    left join mat_inv_dict mid
				      on mid.group_id = mod.group_id
				     and mid.hos_id = mod.hos_id
				     and mid.copy_code = mod.copy_code
				     and mid.inv_id = mod.inv_id
				     and mid.inv_no = mod.inv_no
				    left join mat_type_dict mtd
				      on mtd.group_id = mid.group_id
				     and mtd.hos_id = mid.hos_id
				     and mtd.copy_code = mid.copy_code
				     and mtd.mat_type_id = mid.mat_type_id
				     and mtd.mat_type_no = mid.mat_type_no
				    left join mat_fim_type mft
				      on mft.group_id = mtd.group_id
				     and mft.hos_id = mtd.hos_id
				     and mft.copy_code = mtd.copy_code
				     and mft.fim_type_code = mtd.fim_type_code
				    left join hos_dept_dict hdd
				      on hdd.group_id = mom.group_id
				     and hdd.hos_id = mom.hos_id
				     and hdd.dept_id = mom.dept_id
			   where mom.bus_type_code not in (15)
			     and mom.state = 3
			     and mom.group_id =  #{group_id}
			     and mom.hos_id = #{hos_id}
			     and mom.copy_code = #{copy_code}
			      <if test="set_id==null or set_id == ''"> 
					<if test="store_id != null and store_id != ''">
					 	and mom.store_id = #{store_id}
					</if>
				</if>
				<if test="set_id!=null and set_id!=''">
						and mom.store_id in (select distinct store_id from MAT_STORE_DETAIL  where set_id = #{set_id})
				</if> 
			    <if test="begin_confirm_date != null and begin_confirm_date != '' and  end_confirm_date != null and end_confirm_date != ''">
			     and mom.confirm_date between to_date(#{begin_confirm_date}, 'yyyy-MM-dd')   and to_date(#{end_confirm_date}, 'yyyy-MM-dd')
			     </if>
			     ),
			in_tran_temp as
			 (
			 <!--  调入 -->
			  select mtm.group_id,
			         mtm.hos_id,
			         mtm.copy_code,
			         mft.fim_type_code,
			         mft.fim_type_name,
			         ms.dept_id,
			         hdd.kind_code,
			         sum(mtd.amount_money) as amount_money
			    from mat_tran_detail mtd
			    left join mat_tran_main mtm
			      on mtd.group_id = mtm.group_id
			     and mtd.hos_id = mtm.hos_id
			     and mtd.copy_code = mtm.copy_code
			     and mtd.tran_id = mtm.tran_id
			    left join mat_inv_dict mid
			      on mid.group_id = mtd.group_id
			     and mid.hos_id = mtd.hos_id
			     and mid.copy_code = mtd.copy_code
			     and mid.inv_id = mtd.inv_id
			     and mid.inv_no = mtd.inv_no
			    left join mat_type_dict mtdd
			      on mtdd.group_id = mid.group_id
			     and mtdd.hos_id = mid.hos_id
			     and mtdd.copy_code = mid.copy_code
			     and mtdd.mat_type_id = mid.mat_type_id
			     and mtdd.mat_type_no = mid.mat_type_no
			    left join mat_fim_type mft
			      on mft.group_id = mtdd.group_id
			     and mft.hos_id = mtdd.hos_id
			     and mft.copy_code = mtdd.copy_code
			     and mft.fim_type_code = mtdd.fim_type_code
			    left join mat_store ms
			      on ms.group_id = mtm.group_id
			     and ms.hos_id = mtm.hos_id
			     and ms.store_id = mtm.out_store_id
			    left join hos_dept_dict hdd
			      on hdd.group_id = ms.group_id
			     and hdd.hos_id = ms.hos_id
			     and hdd.dept_id = ms.dept_id
			   where mtm.state = 3
			     and mtm.group_id =  #{group_id}
			     and mtm.hos_id = #{hos_id}
			     and mtm.copy_code = #{copy_code}
			     
			     <if test="set_id==null or set_id == ''"> 
					<if test="store_id != null and store_id != ''">
					 	and mtm.in_store_id = #{store_id}
					</if>
				</if>
				<if test="set_id!=null and set_id!=''">
						and mtm.in_store_id in (select distinct store_id from MAT_STORE_DETAIL  where set_id = #{set_id})
				</if> 
			     <if test="begin_confirm_date != null and begin_confirm_date != '' and  end_confirm_date != null and end_confirm_date != ''">
			     and mtm.confirm_date between to_date(#{begin_confirm_date}, 'yyyy-MM-dd')   and to_date(#{end_confirm_date}, 'yyyy-MM-dd')
			     </if>
			     group by mtm.group_id,
			            mtm.hos_id,
			            mtm.copy_code,
			            mft.fim_type_code,
			            mft.fim_type_name,
			            ms.dept_id,
			            hdd.kind_code
			     ),
			  out_group_temp as
					 (select group_id,
					         hos_id, 
					         copy_code, 
					         fim_type_code,
					         fim_type_name,
					         dept_id,
					         kind_code,
					         sum(amount_money) as amount_money
					    from out_temp
					   where kind_code is not null 
					   group by group_id,
					            hos_id,
					            copy_code,
					            fim_type_code,
					            fim_type_name,
					            dept_id,
					            kind_code),
					temp as
					 (
					  select ot.group_id, ot.hos_id, ot.copy_code, ot.fim_type_code, ot.fim_type_name
          , ot.dept_id, ot.kind_code
          , nvl(ot.amount_money, 0)  as amount_money
        from out_group_temp ot
        union all
          select itt.group_id, itt.hos_id, itt.copy_code, itt.fim_type_code, itt.fim_type_name
          , itt.dept_id, itt.kind_code
          , -1* nvl(itt.amount_money, 0) as amount_money 
          from  in_tran_temp itt 
					     ),
					temp1 as
					 (select group_id,
					         hos_id,
					         copy_code,
					         fim_type_code,
					         fim_type_name,
					         kind_code,
					         sum(nvl(amount_money, 0)) as amount_money
					    from temp
					   group by group_id,
					            hos_id,
					            copy_code,
					            fim_type_code,
					            fim_type_name,
					            kind_code
					   order by group_id, hos_id, copy_code, fim_type_code)
					select group_id,
					       hos_id,
					       copy_code,
					       fim_type_code,
					       fim_type_name,
					       nvl(one_kind, 0) as one_kind,
					       nvl(two_kind, 0) as two_kind,
					       nvl(three_kind, 0) as three_kind,
					       nvl(one_kind, 0) + nvl(two_kind, 0) + nvl(three_kind, 0) as amount_money
					  from temp1 pivot(sum(nvl(amount_money, 0)) for kind_code in('01' as
					                                                              one_kind,
					                                                              '02' as
					                                                              two_kind,
					                                                              '03' as
					                                                              three_kind))
					union all
					select null as group_id,
					       null as hos_id,
					       null as copy_code,
					       to_char('合计') as fim_type_code,
					       null as fim_type_name,
					       sum(nvl(one_kind, 0)) as one_kind,
					       sum(nvl(two_kind, 0)) as two_kind,
					       sum(nvl(three_kind, 0)) as three_kind,
					       sum(nvl(one_kind, 0) + nvl(two_kind, 0) + nvl(three_kind, 0)) as amount_money
					  from temp1 pivot(sum(nvl(amount_money, 0)) for kind_code in('01' as
					                                                              one_kind,
					                                                              '02' as
					                                                              two_kind,
					                                                              '03' as
					                                                              three_kind))
					 order by group_id, hos_id, copy_code, fim_type_code



	</select>
	<select id="queryMatStoreOutFimType" resultMap="matStorageQueryWorkDetailMap" parameterType="java.util.Map">
	 select a.group_id, a.hos_id, a.copy_code, a.dept_code, a.dept_name
      , a.radiaiton_one_money
      , a.radiaiton_two_money
      , a.radiaiton_three_money
      , a.radiaiton_four_money
      , a.radiaiton_five_money
      , a.radiaiton_six_money
      , a.radiaiton_seven_money
      , a.radiaiton_eight_money
      , a.radiaiton_nine_money
      , a.radiaiton_ten_money
      , a.radiaiton_eleven_money
      ,  a.amount_money from (
      select group_id,
       hos_id,
       copy_code,
       dept_code,
       dept_name,
       nvl(radiaiton_one_money,0) as   radiaiton_one_money,
       nvl(radiaiton_two_money,0) as   radiaiton_two_money,
       nvl(radiaiton_three_money,0) as radiaiton_three_money,
       nvl(radiaiton_four_money,0) as  radiaiton_four_money,
       nvl(radiaiton_five_money,0) as  radiaiton_five_money,
       nvl(radiaiton_six_money,0)as    radiaiton_six_money,
       nvl(radiaiton_seven_money,0)as  radiaiton_seven_money,
       nvl(radiaiton_eight_money,0) as radiaiton_eight_money,
       nvl(radiaiton_nine_money,0)as   radiaiton_nine_money,
       nvl(radiaiton_ten_money,0) as   radiaiton_ten_money,
       nvl(radiaiton_eleven_money,0)as radiaiton_eleven_money,
       (nvl(radiaiton_one_money,0)+
       nvl(radiaiton_two_money,0)+
       nvl(radiaiton_three_money,0)+
       nvl(radiaiton_four_money,0)+
       nvl(radiaiton_five_money,0)+
       nvl(radiaiton_six_money,0)+
       nvl(radiaiton_seven_money,0)+
       nvl(radiaiton_eight_money,0)+
       nvl(radiaiton_nine_money,0)+
       nvl(radiaiton_ten_money,0)+
       nvl(radiaiton_eleven_money,0))as amount_money
       from (
with outData as
 (select mom.group_id,
         mom.hos_id,
         mom.copy_code,
         mom.dept_id,
         hdd.dept_code,
         hdd.dept_name, hsd.store_name,
         sum(mod.amount_money) as amount_money,
         mft.fim_type_code,
         mft.fim_type_name
    from mat_out_main mom
    left join mat_out_detail mod
      on mom.group_id = mod.group_id
     and mom.hos_id = mod.hos_id
     and mom.copy_code = mod.copy_code
     and mom.out_id = mod.out_id
    left join hos_store_dict hsd
      on mom.group_id = hsd.group_id
     and mom.hos_id = hsd.hos_id
     and mom.store_id = hsd.store_id
     and mom.store_no = hsd.store_no
    left join mat_bus_type mbt
      on mom.bus_type_code = mbt.bus_type_code
     and mbt.is_stop = 0
    left join mat_inv_dict mid
      on mod.group_id = mid.group_id
     and mod.hos_id = mid.hos_id
     and mod.copy_code = mid.copy_code
     and mod.inv_id = mid.inv_id
     and mod.inv_no = mid.inv_no
    left join mat_type_dict mtd
      on mid.group_id = mtd.group_id
     and mid.hos_id = mtd.hos_id
     and mid.copy_code = mtd.copy_code
     and mid.mat_type_id = mtd.mat_type_id
     and mid.mat_type_no = mtd.mat_type_no
    left join mat_fim_type mft
      on mtd.group_id = mft.group_id
     and mtd.hos_id = mft.hos_id
     and mtd.copy_code = mft.copy_code
     and mtd.fim_type_code = mft.fim_type_code
    left join hos_dept_dict hdd
      on mom.group_id = hdd.group_id
     and mom.hos_id = hdd.hos_id
     and mom.dept_id = hdd.dept_id
     and mom.dept_no = hdd.dept_no
   where mom.group_id=#{group_id}
     and mom.hos_id = #{hos_id}
     and mom.copy_code= #{copy_code}
   	 and mom.state = '3'
     and mom.bus_type_code != 15
      <if test="set_id==null or set_id == ''"> 
				<if test="store_id != null and store_id != ''">
				 	and mom.store_id = #{store_id}
				</if>
				</if>
				<if test="set_id!=null and set_id!=''">
						and mom.store_id in (select distinct store_id from MAT_STORE_DETAIL  where set_id = #{set_id})
				</if> 
			     <if test="begin_confirm_date != null and begin_confirm_date != '' and  end_confirm_date != null and end_confirm_date != ''">
			     and mom.confirm_date between to_date(#{begin_confirm_date}, 'yyyy-MM-dd')   and to_date(#{end_confirm_date}, 'yyyy-MM-dd')
	</if>
   group by mom.group_id,
            mom.hos_id,
            mom.copy_code,
            mom.dept_id,
            hdd.dept_code,
            hdd.dept_name， hsd.store_name,
            mft.fim_type_code,
            mft.fim_type_name)
<if test="is_tran==1">
,tan_main as
 (select mtm.group_id,
         mtm.hos_id,
         mtm.copy_code,
         hdd.dept_id,
         hdd.dept_code,
         hdd.dept_name,
         mft.fim_type_code,
         sum(mtdi.amount_money) as amount_money
    from mat_tran_main mtm
    left join mat_tran_detail mtdi
      on mtdi.group_id = mtm.group_id
     and mtdi.hos_id = mtm.hos_id
     and mtdi.copy_code = mtm.copy_code
     and mtdi.tran_id = mtm.tran_id
     left join mat_inv_dict mid 
     on mtdi.inv_id = mid.inv_id
     and mtdi.inv_no = mid.inv_no
     and mtdi.group_id = mid.group_id
     and mtdi.hos_id = mid.hos_id
     and mtdi.copy_code = mid.copy_code
     left join mat_type_dict mtd
     on mid.group_id = mtd.group_id
     and mid.hos_id = mtd.hos_id
     and mid.copy_code = mtd.copy_code
     and mid.mat_type_id = mtd.mat_type_id
     and mid.mat_type_no = mtd.mat_type_no
     left join mat_fim_type mft
     on mtd.group_id = mft.group_id
     and mtd.hos_id = mft.hos_id
     and mtd.copy_code = mft.copy_code
     and mtd.fim_type_code = mft.fim_type_code
    left join mat_store ms
      on mtm.in_store_id = ms.store_id
     and mtm.group_id = ms.group_id
     and mtm.hos_id = ms.hos_id
    left join hos_dept_dict hdd
      on ms.dept_id = hdd.dept_id
     and ms.group_id = hdd.group_id
     and ms.hos_id = hdd.hos_id
     where mtm.group_id=#{group_id}
     and mtm.hos_id = #{hos_id}
     and mtm.copy_code= #{copy_code}
   	 and mtm.state = '3'
   	 <if test="ex_store_id!=null and  ex_store_id!=''">
   	 	and mtm.in_store_id not in (${ex_store_id}) 
   	 </if>
     <if test="set_id==null or set_id == ''"> 
				<if test="store_id != null and store_id != ''">
				 	and mtm.out_store_id = #{store_id}
				</if>
				</if>
				<if test="set_id!=null and set_id!=''">
						and mtm.out_store_id in (select distinct store_id from MAT_STORE_DETAIL  where set_id = #{set_id})
				</if> 
			     <if test="begin_confirm_date != null and begin_confirm_date != '' and  end_confirm_date != null and end_confirm_date != ''">
			     and mtm.confirm_date between to_date(#{begin_confirm_date}, 'yyyy-MM-dd')   and to_date(#{end_confirm_date}, 'yyyy-MM-dd')
	</if>
   group by mtm.group_id,
            mtm.hos_id,
            mtm.copy_code,
            hdd.dept_id,
            hdd.dept_code,
            mft.fim_type_code,
            hdd.dept_name)
</if>
<if test="is_tran==1">
,in_main as
 (select mtm.group_id,
         mtm.hos_id,
         mtm.copy_code,
         hdd.dept_id,
         hdd.dept_code,
         mft.fim_type_code,
         hdd.dept_name,
         sum(mtdi.amount_money) as amount_money
    from mat_tran_main mtm
    left join mat_tran_detail mtdi
      on mtdi.group_id = mtm.group_id
     and mtdi.hos_id = mtm.hos_id
     and mtdi.copy_code = mtm.copy_code
     and mtdi.tran_id = mtm.tran_id
      left join mat_inv_dict mid 
     on mtdi.inv_id = mid.inv_id
     and mtdi.inv_no = mid.inv_no
     and mtdi.group_id = mid.group_id
     and mtdi.hos_id = mid.hos_id
     and mtdi.copy_code = mid.copy_code
     left join mat_type_dict mtd
     on mid.group_id = mtd.group_id
     and mid.hos_id = mtd.hos_id
     and mid.copy_code = mtd.copy_code
     and mid.mat_type_id = mtd.mat_type_id
     and mid.mat_type_no = mtd.mat_type_no
     left join mat_fim_type mft
     on mtd.group_id = mft.group_id
     and mtd.hos_id = mft.hos_id
     and mtd.copy_code = mft.copy_code
     and mtd.fim_type_code = mft.fim_type_code
    left join mat_store ms
      on mtm.out_store_id = ms.store_id
     and mtm.group_id = ms.group_id
     and mtm.hos_id = ms.hos_id
    left join hos_dept_dict hdd
      on ms.dept_id = hdd.dept_id
     and ms.group_id = hdd.group_id
     and ms.hos_id = hdd.hos_id
     where mtm.group_id=#{group_id}
     and mtm.hos_id = #{hos_id}
     and mtm.copy_code= #{copy_code}
   	 and mtm.state = '3'
   	 <if test="ex_store_id!=null and  ex_store_id!=''">
   	 	and mtm.out_store_id not in (${ex_store_id}) 
   	 </if>
      <if test="set_id==null or set_id == ''"> 
				<if test="store_id != null and store_id != ''">
				 	and mtm.in_store_id = #{store_id}
				</if>
				</if>
				<if test="set_id!=null and set_id!=''">
						and mtm.in_store_id in (select distinct store_id from MAT_STORE_DETAIL  where set_id = #{set_id})
				</if> 
			     <if test="begin_confirm_date != null and begin_confirm_date != '' and  end_confirm_date != null and end_confirm_date != ''">
			     and mtm.confirm_date between to_date(#{begin_confirm_date}, 'yyyy-MM-dd')   and to_date(#{end_confirm_date}, 'yyyy-MM-dd')
	</if>
   group by mtm.group_id,
            mtm.hos_id,
            mtm.copy_code,
            hdd.dept_id,
            hdd.dept_code,
            mft.fim_type_code,
            hdd.dept_name)
</if>
,out_tran as(
      select a.group_id, a.hos_id, to_char(a.copy_code) as copy_code, a.fim_type_code,a.dept_id ,a.dept_code
        , a.dept_name
        , a.amount_money 
      from outData a
      <if test="is_tran==1">
      union all  
      select  b.group_id, b.hos_id, b.copy_code, b.fim_type_code,b.dept_id, b.dept_code
        , b.dept_name
        ,  b.amount_money  
         from tan_main b  
      </if>
      <if test="is_tran==1">
      union all
          select b.group_id, b.hos_id, b.copy_code, b.fim_type_code, b.dept_id
            , b.dept_code, b.dept_name, -1*b.amount_money
          from in_main b
         where b.dept_id != 458
      </if>
         )
          select b.group_id, b.hos_id, b.copy_code, b.fim_type_code, b.dept_id
            , b.dept_code, b.dept_name, sum(b.amount_money) money from out_tran b
            group by b.group_id, b.hos_id, b.copy_code, b.fim_type_code, b.dept_id
            , b.dept_code, b.dept_name)
    pivot(sum(money) for fim_type_code in('01' as
             radiaiton_one_money,
             '02' as
             radiaiton_two_money,
             '03' as
             radiaiton_three_money,
             '04' as
             radiaiton_four_money,
             '05' as
             radiaiton_five_money,
             '06' as
             radiaiton_six_money,
             '07' as
             radiaiton_seven_money,
             '08' as
             radiaiton_eight_money,
             '09' as
             radiaiton_nine_money,
             '10' as
             radiaiton_ten_money,
             '11' as
             radiaiton_eleven_money
             ))
) a 
union all
   select 0 as group_id, 0 as hos_id, '' as copy_code, '' as  dept_code, '合计' as dept_name
      , sum(b.radiaiton_one_money) as radiaiton_one_money
      , sum(b.radiaiton_two_money) as radiaiton_two_money
      , sum(b.radiaiton_three_money) as radiaiton_three_money
      , sum(b.radiaiton_four_money) as radiaiton_four_money
      , sum(b.radiaiton_five_money) as radiaiton_five_money
      , sum(b.radiaiton_six_money) as radiaiton_six_money
      , sum(b.radiaiton_seven_money) as radiaiton_seven_money
      , sum(b.radiaiton_eight_money) as radiaiton_eight_money
      , sum(b.radiaiton_nine_money) as radiaiton_nine_money
      , sum(b.radiaiton_ten_money) as radiaiton_ten_money
      , sum(b.radiaiton_eleven_money) as radiaiton_eleven_money
      ,  sum(b.amount_money) as amount_money  from (
      
      
      select group_id,
       hos_id,
       copy_code,
       dept_code,
       dept_name,
       nvl(radiaiton_one_money,0) as   radiaiton_one_money,
       nvl(radiaiton_two_money,0) as   radiaiton_two_money,
       nvl(radiaiton_three_money,0) as radiaiton_three_money,
       nvl(radiaiton_four_money,0) as  radiaiton_four_money,
       nvl(radiaiton_five_money,0) as  radiaiton_five_money,
       nvl(radiaiton_six_money,0)as    radiaiton_six_money,
       nvl(radiaiton_seven_money,0)as  radiaiton_seven_money,
       nvl(radiaiton_eight_money,0) as radiaiton_eight_money,
       nvl(radiaiton_nine_money,0)as   radiaiton_nine_money,
       nvl(radiaiton_ten_money,0) as   radiaiton_ten_money,
       nvl(radiaiton_eleven_money,0)as radiaiton_eleven_money,
       (nvl(radiaiton_one_money,0)+
       nvl(radiaiton_two_money,0)+
       nvl(radiaiton_three_money,0)+
       nvl(radiaiton_four_money,0)+
       nvl(radiaiton_five_money,0)+
       nvl(radiaiton_six_money,0)+
       nvl(radiaiton_seven_money,0)+
       nvl(radiaiton_eight_money,0)+
       nvl(radiaiton_nine_money,0)+
       nvl(radiaiton_ten_money,0)+
       nvl(radiaiton_eleven_money,0))as amount_money
       from (
with outData as
 (select mom.group_id,
         mom.hos_id,
         mom.copy_code,
         mom.dept_id,
         hdd.dept_code,
         hdd.dept_name, hsd.store_name,
         sum(mod.amount_money) as amount_money,
         mft.fim_type_code,
         mft.fim_type_name
    from mat_out_main mom
    left join mat_out_detail mod
      on mom.group_id = mod.group_id
     and mom.hos_id = mod.hos_id
     and mom.copy_code = mod.copy_code
     and mom.out_id = mod.out_id
    left join hos_store_dict hsd
      on mom.group_id = hsd.group_id
     and mom.hos_id = hsd.hos_id
     and mom.store_id = hsd.store_id
     and mom.store_no = hsd.store_no
    left join mat_bus_type mbt
      on mom.bus_type_code = mbt.bus_type_code
     and mbt.is_stop = 0
    left join mat_inv_dict mid
      on mod.group_id = mid.group_id
     and mod.hos_id = mid.hos_id
     and mod.copy_code = mid.copy_code
     and mod.inv_id = mid.inv_id
     and mod.inv_no = mid.inv_no
    left join mat_type_dict mtd
      on mid.group_id = mtd.group_id
     and mid.hos_id = mtd.hos_id
     and mid.copy_code = mtd.copy_code
     and mid.mat_type_id = mtd.mat_type_id
     and mid.mat_type_no = mtd.mat_type_no
    left join mat_fim_type mft
      on mtd.group_id = mft.group_id
     and mtd.hos_id = mft.hos_id
     and mtd.copy_code = mft.copy_code
     and mtd.fim_type_code = mft.fim_type_code
    left join hos_dept_dict hdd
      on mom.group_id = hdd.group_id
     and mom.hos_id = hdd.hos_id
     and mom.dept_id = hdd.dept_id
     and mom.dept_no = hdd.dept_no
   where mom.group_id=#{group_id}
     and mom.hos_id = #{hos_id}
     and mom.copy_code= #{copy_code}
   	 and mom.state = '3'
     and mom.bus_type_code != 15
      <if test="set_id==null or set_id == ''"> 
				<if test="store_id != null and store_id != ''">
				 	and mom.store_id = #{store_id}
				</if>
				</if>
				<if test="set_id!=null and set_id!=''">
						and mom.store_id in (select distinct store_id from MAT_STORE_DETAIL  where set_id = #{set_id})
				</if> 
			     <if test="begin_confirm_date != null and begin_confirm_date != '' and  end_confirm_date != null and end_confirm_date != ''">
			     and mom.confirm_date between to_date(#{begin_confirm_date}, 'yyyy-MM-dd')   and to_date(#{end_confirm_date}, 'yyyy-MM-dd')
	</if>
   group by mom.group_id,
            mom.hos_id,
            mom.copy_code,
            mom.dept_id,
            hdd.dept_code,
            hdd.dept_name， hsd.store_name,
            mft.fim_type_code,
            mft.fim_type_name)
            
<if test="is_tran==1">            
,tan_main as
 (select mtm.group_id,
         mtm.hos_id,
         mtm.copy_code,
         hdd.dept_id,
         hdd.dept_code,
         hdd.dept_name,
         mft.fim_type_code,
         sum(mtdi.amount_money) as amount_money
    from mat_tran_main mtm
    left join mat_tran_detail mtdi
      on mtdi.group_id = mtm.group_id
     and mtdi.hos_id = mtm.hos_id
     and mtdi.copy_code = mtm.copy_code
     and mtdi.tran_id = mtm.tran_id
     left join mat_inv_dict mid 
     on mtdi.inv_id = mid.inv_id
     and mtdi.inv_no = mid.inv_no
     and mtdi.group_id = mid.group_id
     and mtdi.hos_id = mid.hos_id
     and mtdi.copy_code = mid.copy_code
     left join mat_type_dict mtd
     on mid.group_id = mtd.group_id
     and mid.hos_id = mtd.hos_id
     and mid.copy_code = mtd.copy_code
     and mid.mat_type_id = mtd.mat_type_id
     and mid.mat_type_no = mtd.mat_type_no
     left join mat_fim_type mft
     on mtd.group_id = mft.group_id
     and mtd.hos_id = mft.hos_id
     and mtd.copy_code = mft.copy_code
     and mtd.fim_type_code = mft.fim_type_code
    left join mat_store ms
      on mtm.in_store_id = ms.store_id
     and mtm.group_id = ms.group_id
     and mtm.hos_id = ms.hos_id
    left join hos_dept_dict hdd
      on ms.dept_id = hdd.dept_id
     and ms.group_id = hdd.group_id
     and ms.hos_id = hdd.hos_id
     where mtm.group_id=#{group_id}
     and mtm.hos_id = #{hos_id}
     and mtm.copy_code= #{copy_code}
   	 and mtm.state = '3'
   	 <if test="ex_store_id!=null and  ex_store_id!=''">
   	 	and mtm.in_store_id not in (${ex_store_id}) 
   	 </if>
     <if test="set_id==null or set_id == ''"> 
				<if test="store_id != null and store_id != ''">
				 	and mtm.out_store_id = #{store_id}
				</if>
				</if>
				<if test="set_id!=null and set_id!=''">
						and mtm.out_store_id in (select distinct store_id from MAT_STORE_DETAIL  where set_id = #{set_id})
				</if> 
			     <if test="begin_confirm_date != null and begin_confirm_date != '' and  end_confirm_date != null and end_confirm_date != ''">
			     and mtm.confirm_date between to_date(#{begin_confirm_date}, 'yyyy-MM-dd')   and to_date(#{end_confirm_date}, 'yyyy-MM-dd')
	</if>
   group by mtm.group_id,
            mtm.hos_id,
            mtm.copy_code,
            hdd.dept_id,
            hdd.dept_code,
            mft.fim_type_code,
            hdd.dept_name)
</if>
<if test="is_tran==1">            
,in_main as
 (select mtm.group_id,
         mtm.hos_id,
         mtm.copy_code,
         hdd.dept_id,
         hdd.dept_code,
         mft.fim_type_code,
         hdd.dept_name,
         sum(mtdi.amount_money) as amount_money
    from mat_tran_main mtm
    left join mat_tran_detail mtdi
      on mtdi.group_id = mtm.group_id
     and mtdi.hos_id = mtm.hos_id
     and mtdi.copy_code = mtm.copy_code
     and mtdi.tran_id = mtm.tran_id
      left join mat_inv_dict mid 
     on mtdi.inv_id = mid.inv_id
     and mtdi.inv_no = mid.inv_no
     and mtdi.group_id = mid.group_id
     and mtdi.hos_id = mid.hos_id
     and mtdi.copy_code = mid.copy_code
     left join mat_type_dict mtd
     on mid.group_id = mtd.group_id
     and mid.hos_id = mtd.hos_id
     and mid.copy_code = mtd.copy_code
     and mid.mat_type_id = mtd.mat_type_id
     and mid.mat_type_no = mtd.mat_type_no
     left join mat_fim_type mft
     on mtd.group_id = mft.group_id
     and mtd.hos_id = mft.hos_id
     and mtd.copy_code = mft.copy_code
     and mtd.fim_type_code = mft.fim_type_code
    left join mat_store ms
      on mtm.out_store_id = ms.store_id
     and mtm.group_id = ms.group_id
     and mtm.hos_id = ms.hos_id
    left join hos_dept_dict hdd
      on ms.dept_id = hdd.dept_id
     and ms.group_id = hdd.group_id
     and ms.hos_id = hdd.hos_id
     where mtm.group_id=#{group_id}
     and mtm.hos_id = #{hos_id}
     and mtm.copy_code= #{copy_code}
   	 and mtm.state = '3'
   	  <if test="ex_store_id!=null and  ex_store_id!=''">
   	 	and mtm.out_store_id not in (${ex_store_id}) 
   	 </if>
      <if test="set_id==null or set_id == ''"> 
				<if test="store_id != null and store_id != ''">
				 	and mtm.in_store_id = #{store_id}
				</if>
				</if>
				<if test="set_id!=null and set_id!=''">
						and mtm.in_store_id in (select distinct store_id from MAT_STORE_DETAIL  where set_id = #{set_id})
				</if> 
			     <if test="begin_confirm_date != null and begin_confirm_date != '' and  end_confirm_date != null and end_confirm_date != ''">
			     and mtm.confirm_date between to_date(#{begin_confirm_date}, 'yyyy-MM-dd')   and to_date(#{end_confirm_date}, 'yyyy-MM-dd')
	</if>
   group by mtm.group_id,
            mtm.hos_id,
            mtm.copy_code,
            hdd.dept_id,
            hdd.dept_code,
            mft.fim_type_code,
            hdd.dept_name)
</if>           
,out_tran as(
      select a.group_id, a.hos_id, to_char(a.copy_code) as copy_code, a.fim_type_code,a.dept_id ,a.dept_code
        , a.dept_name
        , a.amount_money 
      from outData a
      <if test="is_tran==1">
      union all  
      select  b.group_id, b.hos_id, b.copy_code, b.fim_type_code,b.dept_id, b.dept_code
        , b.dept_name
        ,  b.amount_money  
         from tan_main b 
      </if>
      <if test="is_tran==1"> 
      union all
          select b.group_id, b.hos_id, b.copy_code, b.fim_type_code, b.dept_id
            , b.dept_code, b.dept_name, -1*b.amount_money
          from in_main b
         where b.dept_id != 458
       </if> 
         ) 
          select b.group_id, b.hos_id, b.copy_code, b.fim_type_code, b.dept_id
            , b.dept_code, b.dept_name, sum(b.amount_money) money from out_tran b
            group by b.group_id, b.hos_id, b.copy_code, b.fim_type_code, b.dept_id
            , b.dept_code, b.dept_name)
    pivot(sum(money) for fim_type_code in('01' as
             radiaiton_one_money,
             '02' as
             radiaiton_two_money,
             '03' as
             radiaiton_three_money,
             '04' as
             radiaiton_four_money,
             '05' as
             radiaiton_five_money,
             '06' as
             radiaiton_six_money,
             '07' as
             radiaiton_seven_money,
             '08' as
             radiaiton_eight_money,
             '09' as
             radiaiton_nine_money,
             '10' as
             radiaiton_ten_money,
             '11' as
             radiaiton_eleven_money
             ))
      ) b
      
	</select>
	
	
	<select id="queryMatFinance" parameterType="java.util.Map" resultMap="queryMatInSupCountMap">
	with 
		hj_temp as(
			
				<!-- 查询期初金额 -->
				select 
					aa.group_id, aa.hos_id, aa.copy_code, 
					cc.fim_type_code,dd.fim_type_name, sum(aa.in_money-aa.out_money) as begin_money
				from mat_inv_balance aa
				left join 
					mat_inv_dict bb 
					on aa.group_id = bb.group_id
					and aa.hos_id = bb.hos_id
					and aa.copy_code = bb.copy_code
					and aa.inv_id = bb.inv_id 
					and bb.is_stop=0
				left join mat_type_dict cc 
				on 
					bb.group_id = cc.group_id
            		and bb.hos_id = cc.hos_id
            		and bb.copy_code = cc.copy_code
            		and bb.mat_type_no = cc.mat_type_no
            		and bb.mat_type_id = cc.mat_type_id
            	left join mat_fim_type dd on
                    cc.group_id = dd.group_id 
                    and cc.hos_id = dd.hos_id
				    and cc.copy_code = dd.copy_code
				    and cc.fim_type_code =dd.fim_type_code 
	            <where>
	              		and aa.group_id=#{group_id}
	            		and aa.hos_id=#{hos_id}
	            		and aa.copy_code=#{copy_code}
	    				and aa.year||aa.month  &lt;  #{b_year_month,jdbcType=VARCHAR} 
	    			<if test="set_id!=null and set_id!=''">
	  					  and aa.store_id in(
							select distinct store_id
							from MAT_STORE_DETAIL
							where set_id = #{set_id}
						)
					</if>
					group by aa.group_id, aa.hos_id, aa.copy_code, 
				cc.fim_type_code,dd.fim_type_name
	          	</where>
				
 			
		),
		in_temp as(
			       
	      	--入库
			select
			  mim.group_id,mim.hos_id,mim.copy_code,mft.fim_type_code,sum(mid.amount_money) as in_money
			from mat_in_main mim
			left join mat_in_detail mid
			on
			     mim.group_id = mid.group_id
			     and mim.hos_id = mid.hos_id
			     and mim.copy_code = mid.copy_code
			     and mim.in_id = mid.in_id
			left join mat_inv_dict midd
			on
			     mid.group_id = midd.group_id
			     and mid.hos_id = midd.hos_id
			     and mid.copy_code = midd.copy_code
			     and mid.inv_id = midd.inv_id
			     and mid.inv_no = midd.inv_no
			left join mat_type_dict mtd
			on
			     midd.group_id = mtd.group_id
			     and midd.hos_id = mtd.hos_id
			     and midd.copy_code = mtd.copy_code
			     and midd.mat_type_id = mtd.mat_type_id
			     and midd.mat_type_no = mtd.mat_type_no
			left join mat_fim_type mft
			on
			     mtd.group_id = mft.group_id
			     and mtd.hos_id = mft.hos_id
			     and mtd.copy_code = mft.copy_code
			     and mtd.fim_type_code = mft.fim_type_code
			     and mft.is_stop = 0
			where
			     mim.group_id  =#{group_id}
			     and mim.hos_id  =#{hos_id}
			     and mim.copy_code =#{copy_code}
			     and mim.state = 3
			     and mim.year || mim.month between #{b_year_month,jdbcType=VARCHAR} and #{e_year_month,jdbcType=VARCHAR}
			   
			     and mim.bus_type_code in(2,12,22,10,47,48)
			     <if test="set_id!=null and set_id!=''">
			     and mim.store_id in (
			          select distinct store_id
			           from MAT_STORE_DETAIL
			           where set_id =#{set_id}
			     )
	     		</if>
     			group by mim.group_id,mim.hos_id,mim.copy_code,mft.fim_type_code  
			     
		),
		py_temp as (
	      	<!-- 盘盈 -->
			select
			  mim.group_id,mim.hos_id,mim.copy_code,mft.fim_type_code,sum(mid.amount_money) as py_money
			from mat_in_main mim
			left join mat_in_detail mid
			on
			     mim.group_id = mid.group_id
			     and mim.hos_id = mid.hos_id
			     and mim.copy_code = mid.copy_code
			     and mim.in_id = mid.in_id
			left join mat_inv_dict midd
			on
			     mid.group_id = midd.group_id
			     and mid.hos_id = midd.hos_id
			     and mid.copy_code = midd.copy_code
			     and mid.inv_id = midd.inv_id
			     and mid.inv_no = midd.inv_no
			left join mat_type_dict mtd
			on
			     midd.group_id = mtd.group_id
			     and midd.hos_id = mtd.hos_id
			     and midd.copy_code = mtd.copy_code
			     and midd.mat_type_id = mtd.mat_type_id
			     and midd.mat_type_no = mtd.mat_type_no
			left join mat_fim_type mft
			on
			     mtd.group_id = mft.group_id
			     and mtd.hos_id = mft.hos_id
			     and mtd.copy_code = mft.copy_code
			     and mtd.fim_type_code = mft.fim_type_code
			     and mft.is_stop = 0
			where
			   mim.group_id  =#{group_id}
			     and mim.hos_id  =#{hos_id}
			     and mim.copy_code =#{copy_code}
			     and mim.state = 3
			     and mim.year || mim.month between #{b_year_month,jdbcType=VARCHAR} and #{e_year_month,jdbcType=VARCHAR}
			     and mim.bus_type_code in(8)
			     
			         <if test="set_id!=null and set_id!=''">
			     and mim.store_id in (
			          select distinct store_id
			           from MAT_STORE_DETAIL
			           where set_id =#{set_id}
			     )
			     </if>
			group by mim.group_id,mim.hos_id,mim.copy_code,mft.fim_type_code  
		),
		out_temp as (
			<!-- 出库 -->
			select
			  mim.group_id,mim.hos_id,mim.copy_code,mft.fim_type_code,sum(mid.amount_money) as out_money
			from mat_out_main mim
			left join mat_out_detail mid
			on
			     mim.group_id = mid.group_id
			     and mim.hos_id = mid.hos_id
			     and mim.copy_code = mid.copy_code
			     and mim.out_id = mid.out_id
			left join mat_inv_dict midd
			on
			     mid.group_id = midd.group_id
			     and mid.hos_id = midd.hos_id
			     and mid.copy_code = midd.copy_code
			     and mid.inv_id = midd.inv_id
			     and mid.inv_no = midd.inv_no
			left join mat_type_dict mtd
			on
			     midd.group_id = mtd.group_id
			     and midd.hos_id = mtd.hos_id
			     and midd.copy_code = mtd.copy_code
			     and midd.mat_type_id = mtd.mat_type_id
			     and midd.mat_type_no = mtd.mat_type_no
			left join mat_fim_type mft
			on
			     mtd.group_id = mft.group_id
			     and mtd.hos_id = mft.hos_id
			     and mtd.copy_code = mft.copy_code
			     and mtd.fim_type_code = mft.fim_type_code
			     and mft.is_stop = 0
			where
			     mim.group_id  =#{group_id}
			     and mim.hos_id  =#{hos_id}
			     and mim.copy_code =#{copy_code}
			     and mim.state = 3
			     and mim.year || mim.month between #{b_year_month,jdbcType=VARCHAR} and #{e_year_month,jdbcType=VARCHAR}
			     and mim.bus_type_code in(3,21,15,11,49,50)
			     <if test="set_id!=null and set_id!=''">
			     and mim.store_id in (
			          select distinct store_id
			           from MAT_STORE_DETAIL
			           where set_id =#{set_id}
     			) 
     			</if>
				group by mim.group_id,mim.hos_id,mim.copy_code,mft.fim_type_code
		),
      	out_ppp as ( 
      		<!-- 移入库 -->
      		select
  				mim.group_id,mim.hos_id,mim.copy_code,mft.fim_type_code,
  				sum(mid.amount_money) as out_money1
			from mat_in_main mim
			left join mat_in_detail mid
			on
			     mim.group_id = mid.group_id
			     and mim.hos_id = mid.hos_id
			     and mim.copy_code = mid.copy_code
			     and mim.in_id = mid.in_id
			left join mat_inv_dict midd
			on
			     mid.group_id = midd.group_id
			     and mid.hos_id = midd.hos_id
			     and mid.copy_code = midd.copy_code
			     and mid.inv_id = midd.inv_id
			     and mid.inv_no = midd.inv_no
			left join mat_type_dict mtd
			on
			     midd.group_id = mtd.group_id
			     and midd.hos_id = mtd.hos_id
			     and midd.copy_code = mtd.copy_code
			     and midd.mat_type_id = mtd.mat_type_id
			     and midd.mat_type_no = mtd.mat_type_no
			left join mat_fim_type mft
			on
			     mtd.group_id = mft.group_id
			     and mtd.hos_id = mft.hos_id
			     and mtd.copy_code = mft.copy_code
			     and mtd.fim_type_code = mft.fim_type_code
			     and mft.is_stop = 0
			where
			     mim.group_id  =#{group_id}
			     and mim.hos_id  =#{hos_id}
			     and mim.copy_code =#{copy_code}
			     and mim.state = 3
			     and mim.year || mim.month between #{b_year_month,jdbcType=VARCHAR} and #{e_year_month,jdbcType=VARCHAR}
			     and mim.bus_type_code in(14)
			     <if test="set_id!=null and set_id!=''">
			     and mim.store_id in (
			          select distinct store_id
			           from MAT_STORE_DETAIL
			           where set_id =#{set_id}
			     )
			     </if>
			group by mim.group_id,mim.hos_id,mim.copy_code,mft.fim_type_code
		),
		out_pk_temp as (
			<!-- 盘亏 -->
			select
			  mim.group_id,mim.hos_id,mim.copy_code,mft.fim_type_code,sum(mid.amount_money) as pk_money
			from mat_out_main mim
			left join mat_out_detail mid
			on
			     mim.group_id = mid.group_id
			     and mim.hos_id = mid.hos_id
			     and mim.copy_code = mid.copy_code
			     and mim.out_id = mid.out_id
			left join mat_inv_dict midd
			on
			     mid.group_id = midd.group_id
			     and mid.hos_id = midd.hos_id
			     and mid.copy_code = midd.copy_code
			     and mid.inv_id = midd.inv_id
			     and mid.inv_no = midd.inv_no
			left join mat_type_dict mtd
			on
			     midd.group_id = mtd.group_id
			     and midd.hos_id = mtd.hos_id
			     and midd.copy_code = mtd.copy_code
			     and midd.mat_type_id = mtd.mat_type_id
			     and midd.mat_type_no = mtd.mat_type_no
			left join mat_fim_type mft
			on
			     mtd.group_id = mft.group_id
			     and mtd.hos_id = mft.hos_id
			     and mtd.copy_code = mft.copy_code
			     and mtd.fim_type_code = mft.fim_type_code
			     and mft.is_stop = 0
			where
			     mim.group_id  =#{group_id}
			     and mim.hos_id  =#{hos_id}
			     and mim.copy_code =#{copy_code}
			     and mim.state = 3
			     and mim.year || mim.month between #{b_year_month,jdbcType=VARCHAR} and #{e_year_month,jdbcType=VARCHAR}
			     and mim.bus_type_code in(9)
			     <if test="set_id!=null and set_id!=''">
			     and mim.store_id in (
			          select distinct store_id
			           from MAT_STORE_DETAIL
			           where set_id =#{set_id}
     			)
     			</if>
				group by mim.group_id,mim.hos_id,mim.copy_code,mft.fim_type_code
		),
		
		out_bs_temp as (
			<!-- 报损 -->
			select
			  mim.group_id,mim.hos_id,mim.copy_code,mft.fim_type_code,sum(mid.amount_money) as bs_money
			from mat_out_main mim
			left join mat_out_detail mid
			on
			     mim.group_id = mid.group_id
			     and mim.hos_id = mid.hos_id
			     and mim.copy_code = mid.copy_code
			     and mim.out_id = mid.out_id
			left join mat_inv_dict midd
			on
			     mid.group_id = midd.group_id
			     and mid.hos_id = midd.hos_id
			     and mid.copy_code = midd.copy_code
			     and mid.inv_id = midd.inv_id
			     and mid.inv_no = midd.inv_no
			left join mat_type_dict mtd
			on
			     midd.group_id = mtd.group_id
			     and midd.hos_id = mtd.hos_id
			     and midd.copy_code = mtd.copy_code
			     and midd.mat_type_id = mtd.mat_type_id
			     and midd.mat_type_no = mtd.mat_type_no
			left join mat_fim_type mft
			on
			     mtd.group_id = mft.group_id
			     and mtd.hos_id = mft.hos_id
			     and mtd.copy_code = mft.copy_code
			     and mtd.fim_type_code = mft.fim_type_code
			     and mft.is_stop = 0
			where
			     mim.group_id  =#{group_id}
			     and mim.hos_id  =#{hos_id}
			     and mim.copy_code =#{copy_code}
			     and mim.state = 3
			     and mim.year || mim.month between #{b_year_month,jdbcType=VARCHAR} and #{e_year_month,jdbcType=VARCHAR}
			     and mim.bus_type_code in(39)
			         <if test="set_id!=null and set_id!=''">
			     and mim.store_id in (
			          select distinct store_id
			           from MAT_STORE_DETAIL
			           where set_id =#{set_id}
			     )
			     </if>
			group by mim.group_id,mim.hos_id,mim.copy_code,mft.fim_type_code
		),
		
		temp_temp as(
			<!-- 列连接 -->
			   select ht.fim_type_code, ht.fim_type_name, nvl(ht.begin_money, 0) as begin_money
          , nvl(it.in_money, 0) as in_money
          , nvl(pt.py_money, 0) as py_money
          , nvl(it.in_money, 0) + nvl(pt.py_money, 0) as in_amountMoney
          , nvl(ot.out_money, 0) - nvl(pp.out_money1, 0) as out_money
          , nvl(otp.pk_money, 0) as pk_money
          , nvl(obt.bs_money, 0) as bs_money
          , nvl(ot.out_money, 0) + nvl(otp.pk_money, 0) + nvl(obt.bs_money, 0)- nvl(pp.out_money1, 0) as out_amountMoney
          , nvl(ht.begin_money, 0) + (nvl(it.in_money, 0) + nvl(pt.py_money, 0)) - ( nvl(ot.out_money, 0) + nvl(otp.pk_money, 0) + nvl(obt.bs_money, 0)- nvl(pp.out_money1, 0) ) as end_amountMoney
        
			  from hj_temp ht
			  left join in_temp it
			    on ht.group_id = it.group_id
			   and ht.hos_id = it.hos_id
			   and ht.copy_code = it.copy_code
			   and ht.fim_type_code = it.fim_type_code
			  left join py_temp pt
			    on ht.group_id = pt.group_id
			   and ht.hos_id = pt.hos_id
			   and ht.copy_code = pt.copy_code
			   and ht.fim_type_code = pt.fim_type_code
			  left join out_temp ot
			    on ht.group_id = ot.group_id
			   and ht.hos_id = ot.hos_id
			   and ht.copy_code = ot.copy_code
			   and ht.fim_type_code = ot.fim_type_code
			  left join out_pk_temp otp
			    on ht.group_id = otp.group_id
			   and ht.hos_id = otp.hos_id
			   and ht.copy_code = otp.copy_code
			   and ht.fim_type_code = otp.fim_type_code
			  left join out_bs_temp obt
			    on ht.group_id = obt.group_id
			   and ht.hos_id = obt.hos_id
			   and ht.copy_code = obt.copy_code
			   and ht.fim_type_code = obt.fim_type_code
			   left join mat_in_main mid on ht.group_id=mid.group_id
			    and ht.hos_id = obt.hos_id
			    and ht.copy_code = obt.copy_code
			  left join out_ppp pp on ht.group_id = pp.group_id
       		 	and ht.hos_id = pp.hos_id
		        and ht.copy_code = pp.copy_code
		        and ht.fim_type_code = pp.fim_type_code 
				<where>
					and ht.group_id =  #{group_id}
					and ht.hos_id = #{hos_id}
					and ht.copy_code = #{copy_code}
				</where>
		) 
		
		select tt.* from temp_temp tt
		union all
		select 
			null ,to_char('合计') as mat_type_name,nvl(sum(tt.begin_money),0),
			nvl(sum(tt.in_money),0),nvl(sum(tt.py_money),0),nvl(sum(tt.in_amountmoney),0),
			nvl(sum(tt.out_money),0),nvl(sum(tt.pk_money),0),nvl(sum(tt.bs_money),0),nvl(sum(tt.out_amountmoney),0),
			nvl(sum(tt.end_amountMoney),0)
		from temp_temp tt
	</select>
</mapper>
			
