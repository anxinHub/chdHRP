<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.mat.dao.storage.query.MatWorkDetailMapper">

	<resultMap id="matStorageQueryWorkDetailMap" type="java.util.Map">
		<result property="group_id" column="group_id" />
		<result property="hos_id" column="hos_id" />
		<result property="copy_code" column="copy_code" />
		<result property="id" column="id" />
		<result property="no" column="no" />
		<result property="make_date" column="make_date" />
		<result property="maker_code" column="maker_code" />
		<result property="maker_name" column="maker_name" />
		<result property="stocker_code" column="stocker_code" />
		<result property="stocker_name" column="stocker_name" />
		<result property="inv_code" column="inv_code" />
		<result property="inv_id" column="inv_id" />
		<result property="inv_name" column="inv_name" />
		<result property="inv_model" column="inv_model" />
		<result property="unit_code" column="unit_code" />
		<result property="unit_name" column="unit_name" />  
		<result property="batch_no" column="batch_no" />
		<result property="batch_sn" column="batch_sn" />
		<result property="bar_code" column="bar_code" />
		<result property="bus_type_name" column="bus_type_name" />
		<result property="bus_type_code" column="bus_type_code" />
		<result property="in_id" column="in_id"/>
		<result property="in_no" column="in_no" />
		<result property="confirm_date" column="confirm_date" />
		<result property="init_amount" column="init_amount" />
		<result property="init_amount_money" column="init_amount_money" />
		<result property="in_amount" column="in_amount" />
		<result property="in_amount_money" column="in_amount_money" />
		<result property="out_amount" column="out_amount" />
		<result property="out_amount_money" column="out_amount_money" />
		<result property="end_amount" column="end_amount" />
		<result property="end_amount_money" column="end_amount_money" />
		<result property="price" column="price" />
		<result property="amount_money" column="amount_money" />
		<result property="amount" column="amount" />
		<result property="money" column="money" />
		<result property="dept_id" column="dept_id" />
		<result property="dept_name" column="dept_name" />
		<result property="sup_id" column="sup_id" />
		<result property="sup_name" column="sup_name" />
		<result property="fac_id" column="fac_id" />
		<result property="fac_name" column="fac_name" />
		<result property="store_id" column="store_id" />
		<result property="store_name" column="store_name" />
		<result property="cert_code" column="cert_code" />
		<result property="inva_date" column="inva_date" />
		<result property="bid_code" column="bid_code" />
		<result property="flag" column="flag" />
		<result property="mat_type_code" column="mat_type_code" />
		<result property="mat_type_name" column="mat_type_name" />
	</resultMap>
 

	<select id="queryMatStorageQueryWorkDetail" parameterType="java.util.Map"
		resultMap="matStorageQueryWorkDetailMap">

		with in_temp as
		(
		 select '1' as id, mid.group_id, mid.hos_id, mid.copy_code, mim.in_id as in_id
          , mim.store_id, mid.inv_id, to_char(mbt.bus_type_name) as bus_type_name, mim.bus_type_code, to_char(mim.in_no) as in_no
          , mim.confirm_date, mid.price<!-- , sum(mid.amount) as amount, sum(mid.amount_money) as amount_money,  -->
          , nvl(mid.amount,0) as amount, nvl(mid.amount_money,0) as amount_money,
          hsd.sup_name,mim.sup_id
          , hd.store_name as dept_name, mic.cert_code, mid.inva_date, mid.batch_no, hfd.fac_name
          , mi.bid_code, null as dept_id, mi.fac_id,mid.batch_sn,mid.bar_code
        from mat_in_detail mid
        left join mat_inv_cert mic on mic.group_id = mid.group_id
        and mic.hos_id = mid.hos_id
        and mic.copy_code = mid.copy_code
        and mic.cert_id = mid.cert_id
       <!--  and mic.cert_state = 1 -->
        left join mat_in_main mim on mid.group_id = mim.group_id
        and mid.hos_id = mim.hos_id
        and mid.copy_code = mim.copy_code
        and mid.in_id = mim.in_id 
        left join mat_bus_type mbt on mbt.bus_type_code = mim.bus_type_code 
        left join hos_sup_dict hsd on hsd.group_id = mim.group_id
        and hsd.hos_id = mim.hos_id
        and hsd.sup_id = mim.sup_id
        and hsd.is_stop = 0 
        left join hos_store_dict hd on hd.group_id = mim.group_id
        and hd.hos_id = mim.hos_id
        and hd.store_id = mim.store_id
        and hd.is_stop = 0 
        
         left join mat_store_detail msd on
        hd.group_id=msd.group_id
        and hd.hos_id=msd.hos_id
        and hd.store_id=msd.store_id
        left join mat_store_set mss on 
        msd.group_id=mss.group_id
        and msd.hos_id=mss.hos_id
        and msd.set_id=mss.set_id
        
        
        left join mat_inv_dict mi on mi.group_id = mid.group_id
        and mi.hos_id = mid.hos_id
        and mi.copy_code = mid.copy_code
        and mi.inv_id = mid.inv_id
        and mi.inv_no = mid.inv_no 
          left join hos_fac_dict hfd on mi.group_id = hfd.group_id
        and mi.hos_id = hfd.hos_id
        and mi.fac_id = hfd.fac_id
        and mi.fac_no = hfd.fac_no 
		<where>
		   <if test="group_id != null and group_id != ''">
				and mim.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and mim.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and mim.copy_code = #{copy_code}
			</if>
			<if test="year != null and year != ''">
				and mim.year = #{year}
			</if>
			<if test="month != null and month != ''">
				and mim.month = #{month}
			</if>
			<if test="startDate != null and startDate != '' ">
				and mim.confirm_date &gt;= to_date(#{startDate},'yyyy-MM-dd')
			</if>
			<if test="endDate != null and endDate != '' ">
				and mim.confirm_date &lt;=to_date( #{endDate},'yyyy-MM-dd')
			</if>
			<!-- 只显示有权限的库房信息 -->
			and to_char(mim.store_id) in (
				select perm_code from v_user_data_perm  
				where group_id = #{group_id,jdbcType=INTEGER}
					and hos_id = #{hos_id,jdbcType=INTEGER}
					and table_code = 'HOS_STORE_DICT'
					and user_id = #{user_id,jdbcType=INTEGER}
					and is_read = 1 and is_write = 1 
			)
			<if test="store_id != null and store_id != ''">
				and mim.store_id = #{store_id}
			</if>
			<if test="store_no != null and store_no != ''">
				and mim.store_no = #{store_no}
			</if>
			<if test="sup_id != null and sup_id != ''">
				and hsd.sup_id = #{sup_id}
			</if>
			<if test="set_id != null and set_id != ''">
				and msd.set_id = #{set_id}
				</if>
			and mim.state = 3
	   </where>
		 group by mid.group_id, mid.hos_id, mid.copy_code,mid.amount,mid.amount_money, mim.in_id, mim.store_id, mim.store_no, mid.inv_id, mid.inv_no, mim.bus_type_code, mbt.bus_type_name,
         mim.in_no, mim.confirm_date, hsd.sup_name, mic.cert_code, mid.inva_date, mid.price, mid.batch_no, hd.store_name, hfd.fac_name, mi.bid_code, mi.fac_id
         ,mid.batch_sn,mid.bar_code,mim.sup_id
        order by mim.store_id, mim.store_no, mid.inv_id, mid.inv_no
		), out_temp as
		(
		 select '1' as id, mod.group_id, mod.hos_id, mod.copy_code, mom.out_id as in_id
          , mom.store_id, mod.inv_id, to_char(mbt.bus_type_name) as bus_type_name, mom.bus_type_code, to_char(mom.out_no) as in_no
          , mom.confirm_date, mod.price,  nvl(-mod.amount,0) as amount, nvl(-mod.amount_money,0) as amount_money, 
          
  <!--         sum(-mod.amount) as amount, sum(-mod.amount_money) as amount_money,
        -->   
          null as sup_name, null as sup_id
          , hd.store_name || '' ||  hddd.store_name || '' || hdd.dept_name as dept_name, mr.cert_code, mod.inva_date, mod.batch_no, hfd.fac_name
          , mi.bid_code, mom.dept_id, mi.fac_id,mod.batch_sn,mod.bar_code
        from mat_out_detail mod
        left join mat_out_main mom on mom.group_id = mod.group_id
        and mom.hos_id = mod.hos_id
        and mom.copy_code = mod.copy_code
        and mom.out_id = mod.out_id 
        
         left join MAT_TRAN_RELA mtr on 
    mom.group_id=mtr.group_id
    and mom.hos_id=mtr.hos_id
    and mom.copy_code=mtr.copy_code
    and mom.out_id=mtr.out_id
    and mom.out_no=mtr.out_no
    left join mat_tran_main mtmm  on 
    mtr.group_id=mtmm.group_id
    and mtr.hos_id=mtmm.hos_id
    and mtr.copy_code=mtmm.copy_code
    and mtr.tran_id=mtmm.tran_id
    and mtr.tran_no=mtmm.tran_no
   left join hos_store_dict hddd on hddd.group_id = mtmm.group_id
		and hddd.hos_id = mtmm.hos_id
		and hddd.store_id = mtmm.in_store_id
		and hddd.is_stop = 0 
		
        
        left join mat_bus_type mbt on mbt.bus_type_code = mom.bus_type_code 
        left join hos_dept_dict hdd on mom.group_id = hdd.group_id
        and mom.hos_id = hdd.hos_id
        and hdd.dept_id = mom.dept_id
        and hdd.is_stop = 0 
        left join hos_store_dict hd on hd.group_id = mom.group_id
        and hd.hos_id = mom.hos_id
        and hd.store_id = mom.store_id
        and hd.is_stop = 0 
        
         left join mat_store_detail msd on
        hd.group_id=msd.group_id
        and hd.hos_id=msd.hos_id
        and hd.store_id=msd.store_id
        left join mat_store_set mss on 
        msd.group_id=mss.group_id
        and msd.hos_id=mss.hos_id
        and msd.set_id=mss.set_id
        
        left join mat_inv_dict mi on mi.group_id = mod.group_id
        and mi.hos_id = mod.hos_id
        and mi.copy_code = mod.copy_code
        and mi.inv_id = mod.inv_id 
        and mi.inv_no = mod.inv_no
        left join hos_fac_dict hfd on mi.group_id = hfd.group_id
        and mi.hos_id = hfd.hos_id
        and mi.fac_id = hfd.fac_id
        and mi.fac_no = hfd.fac_no
        LEFT JOIN (
     		SELECT micr.group_id, micr.hos_id, micr.copy_code, micr.inv_id, MAX(micr.cert_id) AS cert_id
   			from mat_inv_cert_rela  micr
  			left join mat_inv_cert mic on mic.cert_id=micr.cert_id 
        	where micr.group_id =#{group_id,jdbcType=INTEGER}
				and micr.hos_id = #{hos_id,jdbcType=INTEGER}
				and micr.copy_code = #{copy_code,jdbcType=VARCHAR} 
				<!-- and mic.cert_state=1 -->
       		GROUP BY micr.group_id,micr.hos_id,micr.copy_code,micr.inv_id
		)icert on icert.inv_id=mod.inv_id
        left join mat_inv_cert mr on mr.group_id = icert.group_id
        and mr.hos_id = icert.hos_id
        and mr.cert_id = icert.cert_id 
		<where>
		   <if test="group_id != null and group_id != ''">
				and mom.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and mom.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and mom.copy_code = #{copy_code}
			</if>
			<if test="year != null and year != ''">
				and mom.year = #{year}
			</if>
			<if test="month != null and month != ''">
				and mom.month = #{month}
			</if>
			<if test="startDate != null and startDate != '' ">
				and mom.confirm_date &gt;= to_date(#{startDate},'yyyy-MM-dd')
			</if>
			<if test="endDate != null and endDate != '' ">
				and mom.confirm_date &lt;= to_date(#{endDate},'yyyy-MM-dd')
			</if>
			<!-- 只显示有权限的库房信息 -->
			and to_char(mom.store_id) in ( 
				select perm_code from v_user_data_perm  
				where group_id = #{group_id,jdbcType=INTEGER}
					and hos_id = #{hos_id,jdbcType=INTEGER}
					and table_code = 'HOS_STORE_DICT'
					and user_id = #{user_id,jdbcType=INTEGER}
					and is_read = 1 and is_write = 1 
			)
			<if test="store_id != null and store_id != ''">
				and mom.store_id = #{store_id}
			</if>
			<if test="store_no != null and store_no != ''">
				and mom.store_no = #{store_no}
			</if>
				<if test="set_id != null and set_id != ''">
				and msd.set_id = #{set_id}
				</if>
				  and  mom.state = 3
			
	   </where>
			group by mod.group_id, mod.hos_id, mod.copy_code, mod.amount, mod.amount_money, mom.out_id,
     mom.store_id, mom.store_no, mod.inv_id, mod.inv_no, mom.bus_type_code, mbt.bus_type_name,
      mom.out_no, mom.confirm_date, hdd.dept_name, mod.price, mr.cert_code, mod.inva_date, mod.batch_no,
       hfd.fac_name, hd.store_name,  hddd.store_name,mi.bid_code, mom.dept_id, mi.fac_id, mod.batch_sn, mod.bar_code
        order by mom.store_id, mom.store_no, mod.inv_id, mod.inv_no
		),
		sup_temp
      as(
         select ot.id, ot.group_id, ot.hos_id, ot.copy_code, ot.in_id
          , ot.store_id, ot.inv_id, ot.bus_type_name, ot.bus_type_code, ot.in_no
          , ot.confirm_date, ot.price, ot.amount, ot.amount_money, it.sup_name,it.sup_id
          ,  ot.dept_name, ot.cert_code, ot.inva_date, ot.batch_no, ot.fac_name
          , ot.bid_code, ot.dept_id, ot.fac_id,ot.batch_sn,ot.bar_code
        from out_temp ot
          left join (
             select '1' as id, mid.group_id, mid.hos_id, mid.copy_code, mim.in_id as in_id
          , mim.store_id, mid.inv_id, to_char(mbt.bus_type_name) as bus_type_name, mim.bus_type_code, to_char(mim.in_no) as in_no
          , mim.confirm_date, mid.price, sum(mid.amount) as amount, sum(mid.amount_money) as amount_money, hsd.sup_name,mim.sup_id
          , hd.store_name as dept_name, mic.cert_code, mid.inva_date, mid.batch_no, hfd.fac_name
          , mi.bid_code, null as dept_id, mi.fac_id,mid.batch_sn,mid.bar_code
        from mat_in_detail mid
        left join mat_inv_cert mic on mic.group_id = mid.group_id
        and mic.hos_id = mid.hos_id
        and mic.copy_code = mid.copy_code
        and mic.cert_id = mid.cert_id
        and mic.cert_state = 1 
        left join mat_in_main mim on mid.group_id = mim.group_id
        and mid.hos_id = mim.hos_id
        and mid.copy_code = mim.copy_code
        and mid.in_id = mim.in_id 
        left join mat_bus_type mbt on mbt.bus_type_code = mim.bus_type_code 
        left join hos_sup_dict hsd on hsd.group_id = mim.group_id
        and hsd.hos_id = mim.hos_id
        and hsd.sup_id = mim.sup_id
        and hsd.is_stop = 0 
        left join hos_store_dict hd on hd.group_id = mim.group_id
        and hd.hos_id = mim.hos_id
        and hd.store_id = mim.store_id
        and hd.is_stop = 0 
        
         left join mat_store_detail msd on
        hd.group_id=msd.group_id
        and hd.hos_id=msd.hos_id
        and hd.store_id=msd.store_id
        left join mat_store_set mss on 
        msd.group_id=mss.group_id
        and msd.hos_id=mss.hos_id
        and msd.set_id=mss.set_id
        
        left join mat_inv_dict mi on mi.group_id = mid.group_id
        and mi.hos_id = mid.hos_id
        and mi.copy_code = mid.copy_code
        and mi.inv_id = mid.inv_id
        and mi.inv_no = mid.inv_no 
          left join hos_fac_dict hfd on mi.group_id = hfd.group_id
        and mi.hos_id = hfd.hos_id
        and mi.fac_id = hfd.fac_id
        and mi.fac_no = hfd.fac_no 
        <where>
		   <if test="group_id != null and group_id != ''">
				and mim.group_id = #{group_id}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and mim.hos_id = #{hos_id}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and mim.copy_code = #{copy_code}
			</if>
			<!-- 只显示有权限的库房信息 -->
			and to_char(mim.store_id) in (
				select perm_code from v_user_data_perm  
				where group_id = #{group_id,jdbcType=INTEGER}
					and hos_id = #{hos_id,jdbcType=INTEGER}
					and table_code = 'HOS_STORE_DICT'
					and user_id = #{user_id,jdbcType=INTEGER}
					and is_read = 1 and is_write = 1 
			)
			<if test="store_id != null and store_id != ''">
				and mim.store_id = #{store_id}
			</if>
			<if test="store_no != null and store_no != ''">
				and mim.store_no = #{store_no}
			</if>
				<if test="set_id != null and set_id != ''">
				and msd.set_id = #{set_id}
				</if>
				  and  mim.state = 3
			
	   </where>
         
        group by mid.group_id, mid.hos_id, mid.copy_code, mim.in_id, mim.store_id, mim.store_no, mid.inv_id, mid.inv_no, mim.bus_type_code, mbt.bus_type_name,
         mim.in_no, mim.confirm_date, hsd.sup_name, mic.cert_code, mid.inva_date, mid.price, mid.batch_no, hd.store_name, hfd.fac_name, mi.bid_code, mi.fac_id
         ,mid.batch_sn,mid.bar_code,mim.sup_id
        order by mim.store_id, mim.store_no, mid.inv_id, mid.inv_no
        ) it on ot.inv_id=it.inv_id and ot.batch_no=it.batch_no and ot.batch_sn=it.batch_sn and ot.bar_code=it.bar_code
           group by ot.id, ot.group_id, ot.hos_id, ot.copy_code, ot.in_id
      , ot.store_id, ot.inv_id, ot.bus_type_name, ot.bus_type_code, ot.in_no
      , ot.confirm_date, ot.price, ot.amount, ot.amount_money, it.sup_name
      , it.sup_id, ot.dept_name, ot.cert_code, ot.inva_date, ot.batch_no
      , ot.fac_name, ot.bid_code, ot.dept_id, ot.fac_id, ot.batch_sn
      , ot.bar_code
      
      ),temp as (
		  select id, group_id, hos_id, copy_code, in_id
          , store_id, inv_id, bus_type_name, bus_type_code, in_no
          , confirm_date, price, amount, amount_money, sup_name,sup_id
          , dept_name, cert_code, inva_date, batch_no, fac_name
          , bid_code, dept_id, fac_id,batch_sn,bar_code
        from in_temp
        <!--  union all
        select id, group_id, hos_id, copy_code, in_id
          , store_id, inv_id, bus_type_name, bus_type_code, in_no
          , in_date, price, amount, amount_money, sup_name
          , sup_id, dept_name, cert_code, inva_date, batch_no
          , fac_name, bid_code, dept_id, fac_id, batch_sn
          , bar_code
        from out_temp -->
        union all
        select id, group_id, hos_id, copy_code, in_id
          , store_id, inv_id, bus_type_name, bus_type_code, in_no
          , confirm_date, price, amount, amount_money, sup_name,sup_id
          , dept_name, cert_code, inva_date, batch_no, fac_name
          , bid_code, dept_id, fac_id,batch_sn,bar_code
        from sup_temp
	) 
	select null as id,null as group_id, null as hos_id, null as copy_code, null as in_id, to_char('合计') as inv_code
	      , null as inv_name, null as inv_model, null as unit_name, null as bus_type_name, null as bus_type_code
	      , null as in_no, null as confirm_date, null as price, sum(amount) as amount, sum(amount_money) as amount_money
	      , null as sup_name, null as sup_id, null as dept_name,null as cert_code, null as inva_date
	      , null as batch_no, null as fac_name, null as bid_code, null as dept_id, null as fac_id
	      , null as batch_sn, null as bar_code
    from temp a
    inner join mat_inv_dict midd on midd.inv_id = a.inv_id and a.group_id=midd.group_id and a.hos_id=midd.hos_id and a.copy_code=midd.copy_code
	inner join mat_type_dict mtd on midd.group_id=mtd.group_id and midd.hos_id=mtd.hos_id and midd.copy_code=mtd.copy_code 
		and midd.mat_type_id=mtd.mat_type_id and midd.mat_type_no=mtd.mat_type_no 
	inner join hos_unit hu on hu.group_id = midd.group_id and hu.hos_id = midd.hos_id 
		and hu.unit_code = midd.unit_code and hu.is_stop = 0
	left join hos_sup_dict hsd on hsd.group_id = a.group_id
        and hsd.hos_id = a.hos_id  and hsd.sup_id=a.sup_id and hsd.is_stop=0
    left join hos_dept_dict hdd on a.group_id = hdd.group_id
        and a.hos_id = hdd.hos_id  and hdd.dept_id=a.dept_id and hdd.is_stop=0 
	<where>
		    midd.is_stop = '0'
		    <if test="sup_id != null and sup_id != ''">
				and hsd.sup_id = #{sup_id}
			</if>
			<if test="dept_id != null and dept_id != ''">
				and a.dept_id = #{dept_id}
			</if>
			<if test="fac_id != null and fac_id != ''">
				and a.fac_id = #{fac_id}
			</if>
		    <if test="mat_type_code != null and mat_type_code != ''">
				and mtd.mat_type_code like '${mat_type_code}%'
			</if>
			<if test="mat_type_code == null or mat_type_code == ''">
				and to_char(mtd.mat_type_id) in (
					select perm_code from v_user_data_perm  
					where group_id = #{group_id,jdbcType=INTEGER}
						and hos_id = #{hos_id,jdbcType=INTEGER}
						and table_code = 'MAT_TYPE_DICT'
						and user_id = #{user_id,jdbcType=INTEGER}
						and is_read = 1 and is_write = 1 
				)
			</if>
			<if test="inv_id!= null and inv_id != ''">
				and midd.inv_id = #{inv_id}
			</if>
			<if test="inv_no != null and inv_no  != ''">
				and midd.inv_no = #{inv_no}
			</if>
			<if test="batch_no != null and batch_no  != ''">
				and a.batch_no like '%${batch_no}%'
			</if>
			<if test="is_charge != null and is_charge  != ''">
				and midd.is_charge  = #{is_charge}
			</if>
			<if test="cert_code != null and cert_code  != ''">
				and a.cert_code  like '%${cert_code}%'
			</if>
			<if test="bus_type_code != null and bus_type_code != ''"> 
				and a.bus_type_code in  (${bus_type_code})
			</if>
			
			<if test="tran_code != null and tran_code != ''"> 
				and a.bus_type_code in  (${tran_code})
			</if>
			
				<if test="in_out == 1 and in_out ==1"> 
					and a.bus_type_code in (2,4,6,8,10,16,18,22,47,48,12,14,45)
			</if>
					<if test="in_out == 2 and in_out ==2"> 
				and a.bus_type_code in (3,5,7,9,11,17,19,20,23,24,25,49,50,15,46)
			</if>
			
			
			<if test="inv_model != null and inv_model != ''">
					and (midd.inv_model like '%${inv_model}%'
						 or midd.inv_name like '%${inv_model}%'
				         or midd.inv_code like '%${inv_model}%'
				         or midd.bid_code like '%${inv_model}%'
					     or upper(midd.spell_code) like upper('%${inv_model}%')
					     or upper(midd.wbx_code) like upper('%${inv_model}%')
					     )
				</if>
		</where>
    union all 
	select a.id,a.group_id, a.hos_id, a.copy_code, a.in_id, to_char(midd.inv_code) as inv_code
      	, midd.inv_name, midd.inv_model, hu.unit_name, a.bus_type_name, a.bus_type_code
      	, a.in_no, a.confirm_date, a.price, a.amount, a.amount_money
      	, a.sup_name,a.sup_id, a.dept_name, a.cert_code, a.inva_date, a.batch_no
      	, a.fac_name, a.bid_code, a.dept_id, a.fac_id,a.batch_sn,a.bar_code
    from temp a
    inner join mat_inv_dict midd on midd.inv_id = a.inv_id and a.group_id=midd.group_id and a.hos_id=midd.hos_id and a.copy_code=midd.copy_code
	inner join mat_type_dict mtd on midd.group_id=mtd.group_id and midd.hos_id=mtd.hos_id and midd.copy_code=mtd.copy_code 
		and midd.mat_type_id=mtd.mat_type_id and midd.mat_type_no=mtd.mat_type_no 
	inner join hos_unit hu on hu.group_id = midd.group_id and hu.hos_id = midd.hos_id 
		and hu.unit_code = midd.unit_code and hu.is_stop = 0
	left join hos_sup_dict hsd on hsd.group_id = a.group_id
        and hsd.hos_id = a.hos_id  and hsd.sup_id=a.sup_id and hsd.is_stop=0
    left join hos_dept_dict hdd on a.group_id = hdd.group_id
        and a.hos_id = hdd.hos_id  and hdd.dept_id=a.dept_id and hdd.is_stop=0
		<where>
		    midd.is_stop = '0'
		    <if test="sup_id != null and sup_id != ''">
				and hsd.sup_id = #{sup_id}
			</if>
			<if test="dept_id != null and dept_id != ''">
				and a.dept_id = #{dept_id}
			</if>
			<if test="fac_id != null and fac_id != ''">
				and a.fac_id = #{fac_id}
			</if>
		    <if test="mat_type_code != null and mat_type_code != ''">
				and mtd.mat_type_code like '${mat_type_code}%'
			</if>
			<if test="mat_type_code == null or mat_type_code == ''">
				and to_char(mtd.mat_type_id) in (
					select perm_code from v_user_data_perm  
					where group_id = #{group_id,jdbcType=INTEGER}
						and hos_id = #{hos_id,jdbcType=INTEGER}
						and table_code = 'MAT_TYPE_DICT'
						and user_id = #{user_id,jdbcType=INTEGER}
						and is_read = 1 and is_write = 1 
				)
			</if>
		   <!-- <if test="mat_type_id != null and mat_type_id != ''">
				and midd.mat_type_id = #{mat_type_id}
			</if>
			<if test="mat_type_no != null and mat_type_no  != ''">
				and midd.mat_type_no = #{mat_type_no}
			</if> -->
			<if test="inv_id!= null and inv_id != ''">
				and midd.inv_id = #{inv_id}
			</if>
			<if test="inv_no != null and inv_no  != ''">
				and midd.inv_no = #{inv_no}
			</if>
			<if test="batch_no != null and batch_no  != ''">
				and a.batch_no like '%${batch_no}%'
			</if> 
			<if test="is_charge != null and is_charge  != ''">
				and midd.is_charge  = #{is_charge}
			</if>
			<if test="cert_code != null and cert_code  != ''">
				and a.cert_code  like '%${cert_code}%'
			</if>
			<if test="bus_type_code != null and bus_type_code != ''"> 
				and a.bus_type_code in  (${bus_type_code})
			</if>
			
			<if test="tran_code != null and tran_code != ''"> 
				and a.bus_type_code in  (${tran_code})
			</if>
			
			<if test="in_out == 1 and in_out ==1"> 
				and a.bus_type_code in (2,4,6,8,10,16,18,22,47,48,12,14,45)
			</if>
					<if test="in_out == 2 and in_out ==2"> 
						and a.bus_type_code in (3,5,7,9,11,17,19,20,23,24,25,49,50,15,46)
			</if>
			<if test="inv_model != null and inv_model != ''"> 
					and (midd.inv_model like '%${inv_model}%'
						 or upper(midd.inv_name) like '%${inv_model}%'
				         or upper(midd.inv_code) like '%${inv_model}%'
					     or upper(midd.spell_code) like '%${inv_model}%'
					     or upper(midd.wbx_code) like '%${inv_model}%'
					 	 or lower(midd.inv_name) like '%${inv_model}%'
				         or lower(midd.inv_code) like '%${inv_model}%'
					     or lower(midd.spell_code) like '%${inv_model}%'
					     or lower(midd.wbx_code) like '%${inv_model}%'
					     )
				</if>
		</where>
		group by a.id, a.group_id, a.hos_id, a.copy_code, a.in_id
    ,midd.inv_code, midd.inv_name, midd.inv_model
    , hu.unit_name, a.bus_type_name, a.bus_type_code, a.in_no, a.confirm_date
    , a.price, a.amount, a.amount_money, a.sup_name, a.sup_id
    , a.dept_name, a.cert_code, a.inva_date, a.batch_no, a.fac_name
    , a.bid_code, a.dept_id, a.fac_id, a.batch_sn, a.bar_code
		order by confirm_date, id desc,in_no,inv_code
	</select>
	
	<select id="queryMatInOutDetail" parameterType="java.util.Map"
		resultMap="matStorageQueryWorkDetailMap">
		
		with in_detail as(
		  select
		    mid.group_id,mid.hos_id,mid.copy_code,         
		    midd.inv_id, mid.price,
		    midd.inv_code,midd.inv_name,
		    midd.inv_model,mid.batch_no,
		    mid.batch_sn,mid.bar_code,
		    mim.sup_no,mim.sup_id,
		    midd.fac_id,midd.fac_no,midd.unit_code,    
		    sum(nvl(mid.amount,0)) in_amount,
		    sum(nvl(mid.amount_money,0)) in_amount_money,
		    0 out_amount,
		    0 out_amount_money     
		  from mat_in_detail mid
		  left join mat_in_main mim
		  on mim.group_id=mid.group_id
		  and mim.hos_id=mid.hos_id
		  and mim.copy_code=mid.copy_code
		  and mim.in_id=mid.in_id
		  left join mat_inv_dict midd
		  on midd.group_id=mid.group_id
		  and midd.hos_id=mid.hos_id
		  and midd.copy_code=mid.copy_code
		  and midd.inv_id=mid.inv_id
		  and midd.inv_no=mid.inv_no
		  left join mat_type_dict mtd
		  on midd.group_id=mtd.group_id
		  and midd.hos_id=mtd.hos_id
		  and midd.copy_code=mtd.copy_code
		  and midd.mat_type_id=mtd.mat_type_id
		  and mtd.is_stop=0
        
		  <where>
		        mim.state = 3 <!-- 已确认的入库单  -->
		  and mim.bus_type_code <![CDATA[<>]]>14  <!-- 不包括 移入库  的业务类型  -->
		    <if test="group_id != null and group_id != ''">
		        and mim.group_id = #{group_id}
		      </if>
		      <if test="hos_id != null and hos_id != ''">
		        and mim.hos_id = #{hos_id}
		      </if>
		      <if test="copy_code != null and copy_code != ''">
		        and mim.copy_code = #{copy_code}
		      </if>
		      <if test="inv_id!=null and inv_id!=''">
		        and mid.inv_id=#{inv_id}
		      </if>
		      <if test="startDate != null and startDate != '' ">
		        and mim.confirm_date &gt;= to_date(#{startDate},'yyyy-MM-dd')
		      </if>
		      <if test="endDate != null and endDate != '' ">
		        and mim.confirm_date &lt;=to_date( #{endDate},'yyyy-MM-dd')
		    </if>
		    <if test="store_id != null and store_id != ''">
		    and mim.store_id = #{store_id}
		    </if>
		    <if test="store_no != null and store_no != ''">
		    and mim.store_no = #{store_no}
		    </if>
		    <if test="sup_id != null and sup_id != ''">
		     and mim.sup_id = #{sup_id}
		    </if>
		    <if test="fac_id != null and fac_id != ''">
		     and midd.fac_id = #{fac_id}
		    </if>
		    <if test="bus_type_code != null and bus_type_code != ''">
		     and mim.bus_type_code=#{bus_type_code}
		    </if>
		    <if test="mat_type_code != null and mat_type_code != ''">
		     and mtd.mat_type_code like '${mat_type_code}%'
		    </if>
		    <if test="batch_no != null and batch_no != ''">
		     and mid.batch_no like  '%${batch_no}%'
		    </if>
		    <if test="store_id == null or store_id == ''">
			    and to_char(mim.store_id) in (
					select perm_code from v_user_data_perm  
					where group_id = #{group_id,jdbcType=INTEGER}
						and hos_id = #{hos_id,jdbcType=INTEGER}
						and table_code = 'HOS_STORE_DICT'
						and user_id = #{user_id,jdbcType=INTEGER}
						and (is_read = 1 or is_write = 1) 
				)
		    </if>
		    <if test="bus_type_code == null or bus_type_code == ''">
		     and to_char(mim.bus_type_code) in (
					select perm_code from v_user_data_perm  
					where group_id = #{group_id,jdbcType=INTEGER}
						and hos_id = #{hos_id,jdbcType=INTEGER}
						and table_code = 'MAT_BUS_TYPE'
						and user_id = #{user_id,jdbcType=INTEGER}
						and (is_read = 1 or is_write = 1) 
				)
		    </if>
		    <if test="mat_type_code == null or mat_type_code == ''">
		     
		     and to_char(midd.mat_type_id) in (
					select perm_code from v_user_data_perm  
					where group_id = #{group_id,jdbcType=INTEGER}
						and hos_id = #{hos_id,jdbcType=INTEGER}
						and table_code = 'MAT_TYPE_DICT'
						and user_id = #{user_id,jdbcType=INTEGER}
						and (is_read = 1 or is_write = 1) 
				)
		    </if>
		       <if test="inv_model != null and inv_model != ''">
					and (midd.inv_model like '%${inv_model}%'
						 or upper(midd.inv_name) like '%${inv_model}%'
				         or upper(midd.inv_code) like '%${inv_model}%'
					     or upper(midd.spell_code) like '%${inv_model}%'
					     or upper(midd.wbx_code) like '%${inv_model}%'
					 	 or lower(midd.inv_name) like '%${inv_model}%'
				         or lower(midd.inv_code) like '%${inv_model}%'
					     or lower(midd.spell_code) like '%${inv_model}%'
					     or lower(midd.wbx_code) like '%${inv_model}%'
					     )
			  </if>
		  </where>
		  group by
		    mid.group_id,mid.hos_id,mid.copy_code,         
		    midd.inv_id, mid.price,mid.batch_no,
		    mid.batch_sn,mid.bar_code,
		    midd.inv_code,midd.inv_name,
		    midd.inv_model,
		    mim.sup_no,mim.sup_id,
		    midd.fac_id,midd.fac_no,midd.unit_code  
		),
		out_detail as (
		  select
		    modd.group_id,modd.hos_id,modd.copy_code,         
		    modd.inv_id, modd.price,
		    modd.batch_no,modd.bar_code,
		    ind.inv_code,ind.inv_name,
		    ind.inv_model,
		    ind.sup_no,ind.sup_id,
		    ind.fac_id,ind.fac_no,ind.unit_code,  
		    0 in_amount,
		    0 in_amount_money,
		    sum(nvl(modd.amount,0)) out_amount,
		    sum(nvl(modd.amount_money,0)) out_amount_money     
		  from in_detail ind
		  left join mat_out_detail modd
		  on modd.group_id=ind.group_id
		  and modd.hos_id=ind.hos_id
		  and modd.copy_code=ind.copy_code
		  and modd.inv_id=ind.inv_id
		  and modd.batch_no=ind.batch_no
		  and modd.batch_sn=ind.batch_sn
		  and modd.price=ind.price
		  and modd.bar_code=ind.bar_code
		  left join mat_out_main mom
		  on mom.group_id=modd.group_id
		  and mom.hos_id=modd.hos_id
		  and mom.copy_code=modd.copy_code
		  and mom.out_id=modd.out_id
		  where
		      mom.state = 3 <!-- 已确认的入库单  -->
		  and mom.bus_type_code <![CDATA[<>]]>15  <!-- 不包括 移入库  的业务类型  -->
		  group by
		      modd.group_id,modd.hos_id,modd.copy_code,         
		      modd.inv_id, modd.price,
		      modd.batch_no,modd.bar_code,
		      ind.inv_code,ind.inv_name,
		      ind.inv_model,
		      ind.sup_no,ind.sup_id,
		      ind.fac_id,ind.fac_no,ind.unit_code
		),
		inv_msg as(
		  select 
		    group_id,hos_id,copy_code,inv_id, price,inv_code,inv_name,
	        inv_model, batch_no,bar_code,sup_no,sup_id,fac_id,fac_no,
	        unit_code,in_amount,in_amount_money,out_amount,out_amount_money  
		  from in_detail
		  union all
		  select 
		    group_id,hos_id,copy_code,inv_id, price,inv_code,inv_name,
	        inv_model, batch_no,bar_code,sup_no,sup_id,fac_id,fac_no,
	        unit_code,in_amount,in_amount_money,out_amount,out_amount_money  
		  from out_detail
		)
        
        select inv_id,inv_code,inv_name,
          inv_model,unit_name,
          case when in_amount!=0 then in_amount_money/in_amount else 0 end price,
          in_amount,in_amount_money,
          out_amount,out_amount_money,
          sup_name,fac_name,
          sup_id,fac_id
        from 
        (
		select 
		  inv.inv_id,inv.inv_code,inv.inv_name,
		  inv.inv_model,hu.unit_name,
		  --inv.price,
		  sum(nvl(in_amount,0)) as in_amount,
	      sum(nvl(in_amount_money,0)) as in_amount_money,
	      sum(nvl(out_amount,0)) as out_amount,
	      sum(nvl(out_amount_money,0)) as out_amount_money,
		  hsd.sup_name,hfd.fac_name,
		  hsd.sup_id,hfd.fac_id
				  
		from inv_msg inv
		
				
		left join hos_sup_dict hsd
		on hsd.group_id=inv.group_id
		and hsd.hos_id=inv.hos_id
		and hsd.sup_id=inv.sup_id
		and hsd.sup_no=inv.sup_no
		left join hos_unit hu
		on hu.group_id=inv.group_id
		and hu.hos_id=inv.hos_id
		and hu.unit_code=inv.unit_code
		and hu.is_stop=0
		left join hos_fac_dict hfd
		on hfd.group_id=inv.group_id
		and hfd.hos_id=inv.hos_id
		and hfd.fac_id=inv.fac_id
		and hfd.fac_no=inv.fac_no
		
				
		group	by  
		  inv.inv_id,     
		  inv.inv_code,inv.inv_name,
		  inv.inv_model,hu.unit_name,
		  --inv.price,
		  hsd.sup_name,hfd.fac_name,
		  hsd.sup_id,hsd.sup_no,
		  hfd.fac_id,hfd.fac_no
		

        ) basic_data
		  
		order by
          inv_name,inv_model,
          sup_id,fac_id
	</select>

	<select id="queryMatStoreInvBalanceDetail" parameterType="java.util.Map" resultMap="matStorageQueryWorkDetailMap">
	with init_data as(
  select 
      group_id, hos_id, copy_code, store_id, inv_id
     , sum(nvl(init_amount, 0)) + sum(nvl(init_in_amount, 0)) - sum(nvl(init_out_amount, 0)) as init_amount
     , sum(nvl(init_amount_money, 0)) + sum(nvl(init_in_amount_money, 0)) - sum(nvl(init_out_amount_money, 0)) as init_amount_money
  from (
       select group_id, hos_id, copy_code, store_id, inv_id
          , sum(nvl(begin_amount, 0)) + sum(nvl(in_amount, 0)) - sum(nvl(out_amount, 0)) as init_amount
          , sum(nvl(begin_money, 0)) + sum(nvl(in_money, 0)) - sum(nvl(out_money, 0)) as init_amount_money
          , null as init_in_amount, null as init_in_amount_money, null as init_out_amount, null as init_out_amount_money
        from mat_inv_balance mib
          <where>
		      <if test="group_id!=null and group_id!=''">
		        and mib.group_id=#{group_id}
		      </if>
		      <if test="hos_id!=null and hos_id!=''">
		        and mib.hos_id=#{hos_id}
		      </if>
		      <if test="copy_code!=null and copy_code!=''">
		        and mib.copy_code=#{copy_code}
		      </if>
		      <if test="store_id!=null and store_id!=''">
		        and mib.store_id=#{store_id}
		      </if>
		      <if test="inv_id!=null and inv_id!=''">
		        and mib.inv_id = #{inv_id}
		      </if>
		      <if test="preMonth!=null and preMonth!=''">
		        and mib.year||mib.month=#{preMonth}
		      </if>
		    </where>
        group by group_id, hos_id, copy_code, store_id, inv_id
        union all
        select mim.group_id, mim.hos_id, mim.copy_code, mim.store_id, mid.inv_id
          , null as init_amount, null as init_amount_money
          , sum(nvl(amount, 0)) as init_in_amount
          , sum(nvl(mid.amount_money, 0)) as init_in_amount_money
          , null as init_out_amount, null as init_out_amount_money
        from mat_in_main mim
          left join mat_in_detail mid on mid.group_id = mim.group_id
        and mid.hos_id = mim.hos_id
        and mid.copy_code = mim.copy_code
        and mid.in_id = mim.in_id 
        <where>
		      mid.inv_id is not null
		      and mim.bus_type_code!=1
		      <if test="group_id!=null and group_id!=''">
		        and mim.group_id=#{group_id}
		      </if>
		      <if test="hos_id!=null and hos_id!=''">
		        and mim.hos_id=#{hos_id}
		      </if>
		      <if test="copy_code!=null and copy_code!=''">
		        and mim.copy_code=#{copy_code}
		      </if>
		      <if test="store_id!=null and store_id!=''">
		        and mim.store_id=#{store_id}
		      </if>
		      <if test="inv_id!=null and inv_id!=''">
		        and mid.inv_id = #{inv_id}
		      </if>
		      <if test="preDate!=null and preDate!=''">
		        and to_char(mim.confirm_date,'yyyy-MM-dd')>=#{preDate}
		      </if>
		      <if test="startDate!=null and startDate!=''">
		        and  to_char(mim.confirm_date,'yyyy-MM-dd')<![CDATA[<]]>#{startDate}
		      </if>
		    </where>
        group by mim.group_id, mim.hos_id, mim.copy_code, mim.store_id, mid.inv_id
        union all
        select mom.group_id, mom.hos_id, mom.copy_code, mom.store_id, modd.inv_id
          , null as init_amount, null as init_amount_money, null as init_in_amount, null as init_in_amount_money
          , sum(nvl(modd.amount, 0)) as init_out_amount
          , sum(nvl(modd.amount_money, 0)) as init_out_amount_money
        from mat_out_main mom
          left join mat_out_detail modd on modd.group_id = mom.group_id
        and modd.hos_id = mom.hos_id
        and modd.copy_code = mom.copy_code
        and modd.out_id = mom.out_id 
        <where>
		      modd.inv_id is not null
		      <if test="group_id!=null and group_id!=''">
		        and mom.group_id=#{group_id}
		      </if>
		      <if test="hos_id!=null and hos_id!=''">
		        and mom.hos_id=#{hos_id}
		      </if>
		      <if test="copy_code!=null and copy_code!=''">
		        and mom.copy_code=#{copy_code}
		      </if>
		      <if test="store_id!=null and store_id!=''">
		        and mom.store_id=#{store_id}
		      </if>
		      <if test="inv_id!=null and inv_id!=''">
		        and modd.inv_id = #{inv_id}
		      </if>
		      <if test="preDate!=null and preDate!=''">
		        and to_char(mom.confirm_date,'yyyy-MM-dd')>=#{preDate}
		      </if>
		      <if test="startDate!=null and startDate!=''">
		        and to_char(mom.confirm_date,'yyyy-MM-dd')<![CDATA[<]]> #{startDate}
		      </if>
		    </where>
        group by mom.group_id, mom.hos_id, mom.copy_code, mom.store_id, modd.inv_id
    )
    group by group_id, hos_id, copy_code, store_id, inv_id
    having 
        sum(nvl(init_amount, 0)) + sum(nvl(init_in_amount, 0)) - sum(nvl(init_out_amount, 0)) >0
    and sum(nvl(init_amount_money, 0)) + sum(nvl(init_in_amount_money, 0)) - sum(nvl(init_out_amount_money, 0)) >0
),

 temp as (
        select
           group_id, hos_id, copy_code, store_id, inv_id,init_amount,init_amount_money,
           null as in_amount, 
           null as in_amount_money, 
           null as out_amount, 
           null as out_amount_money 
        from init_data
        union all
        select mim.group_id, mim.hos_id, mim.copy_code, mim.store_id, mid.inv_id
          , null as init_amount, null as init_amount_money
          , sum(nvl(amount, 0)) as in_amount
          , sum(nvl(mid.amount_money, 0)) as in_amount_money
          , null as out_amount, null as out_amount_money
        from mat_in_main mim
          left join mat_in_detail mid on mid.group_id = mim.group_id
        and mid.hos_id = mim.hos_id
        and mid.copy_code = mim.copy_code
        and mid.in_id = mim.in_id 
         <where>
		    mid.inv_id is not null
		    and mim.bus_type_code!=1
		    <if test="group_id!=null and group_id!=''">
		      and mim.group_id=#{group_id}
		    </if>
		    <if test="hos_id!=null and hos_id!=''">
		      and mim.hos_id=#{hos_id}
		    </if>
		    <if test="copy_code!=null and copy_code!=''">
		      and mim.copy_code=#{copy_code}
		    </if>
		    <if test="store_id!=null and store_id!=''">
		      and mim.store_id=#{store_id}
		    </if>
		    <if test="inv_id!=null and inv_id!=''">
		      and mid.inv_id = #{inv_id}
		    </if>
		    <if test="startDate!=null and startDate!=''">
		      and to_char(mim.confirm_date,'yyyy-MM-dd')>=#{startDate}
		    </if>
		    <if test="endDate!=null and endDate!=''">
		      and to_char(mim.confirm_date,'yyyy-MM-dd')<![CDATA[<=]]> #{endDate}
		    </if>
		  </where>
        group by mim.group_id, mim.hos_id, mim.copy_code, mim.store_id, mid.inv_id
        union all
        select mom.group_id, mom.hos_id, mom.copy_code, mom.store_id, modd.inv_id
          , null as init_amount, null as init_amount_money
          , null as in_amount, null as in_amount_money
          , sum(nvl(modd.amount, 0)) as out_amount
          , sum(nvl(modd.amount_money, 0)) as out_amount_money
        from mat_out_main mom
          left join mat_out_detail modd on modd.group_id = mom.group_id
        and modd.hos_id = mom.hos_id
        and modd.copy_code = mom.copy_code
        and modd.out_id = mom.out_id 
        <where>
		      modd.inv_id is not null
		      <if test="group_id!=null and group_id!=''">
		        and mom.group_id=#{group_id}
		      </if>
		      <if test="hos_id!=null and hos_id!=''">
		        and mom.hos_id=#{hos_id}
		      </if>
		      <if test="copy_code!=null and copy_code!=''">
		        and mom.copy_code=#{copy_code}
		      </if>
		      <if test="store_id!=null and store_id!=''">
		        and mom.store_id=#{store_id}
		      </if>
		      <if test="inv_id!=null and inv_id!=''">
		        and modd.inv_id = #{inv_id}
		      </if>
		      <if test="startDate!=null and startDate!=''">
		        and to_char(mom.confirm_date,'yyyy-MM-dd')>=#{startDate}
		      </if>
		      <if test="endDate!=null and endDate!=''">
		        and to_char(mom.confirm_date,'yyyy-MM-dd')<![CDATA[<=]]> #{endDate}
		      </if>
		    </where>
        group by mom.group_id, mom.hos_id, mom.copy_code, mom.store_id, modd.inv_id
      ), 
      inv_amount_data as (
        select group_id, hos_id, copy_code, store_id, inv_id
          , sum(nvl(init_amount, 0)) as init_amount
          , sum(nvl(init_amount_money, 0)) as init_amount_money
          , sum(nvl(in_amount, 0)) as in_amount
          , sum(nvl(in_amount_money, 0)) as in_amount_money
          , sum(nvl(out_amount, 0)) as out_amount
          , sum(nvl(out_amount_money, 0)) as out_amount_money
        from temp
        group by group_id, hos_id, copy_code, store_id, inv_id
      ),
      temp1 as (
    select hsd.store_id, hsd.store_code, hsd.store_name, mid.inv_id, decode(mid.inv_code, null, '0', mid.inv_code) as inv_code
      ,mid.inv_name, mid.inv_model, hu.unit_name, hfd.fac_code, hfd.fac_name
      ,mtd.mat_type_code, mtd.mat_type_name
      ,sum(nvl( iad.init_amount,0)) init_amount 
      ,sum(nvl( iad.init_amount_money,0))init_amount_money
      ,sum(nvl(  iad.in_amount,0)) in_amount
      ,sum(nvl( iad.in_amount_money,0)) in_amount_money
      ,sum(nvl(  iad.out_amount,0)) out_amount
      ,sum(nvl( iad.out_amount_money,0)) out_amount_money
      ,sum(nvl( iad.init_amount,0)) +sum(nvl(  iad.in_amount,0)) - sum(nvl( iad.out_amount,0)) as end_amount
      ,sum(nvl(  iad.init_amount_money,0)) +sum(nvl(  iad.in_amount_money,0)) - sum(nvl( iad.out_amount_money,0)) as end_amount_money
      

    from inv_amount_data iad
    left join hos_store_dict hsd on hsd.group_id = iad.group_id
    and hsd.hos_id = iad.hos_id
    and hsd.store_id = iad.store_id
    and hsd.is_stop = 0 
    left join mat_inv_dict mid on mid.group_id = iad.group_id
    and mid.hos_id = iad.hos_id
    and mid.copy_code = iad.copy_code
    and mid.inv_id = iad.inv_id
    and mid.is_stop = 0 
    left join mat_type_dict mtd
    on mtd.group_id=mid.group_id
    and mtd.hos_id=mid.hos_id
    and mtd.copy_code=mid.copy_code
    and mtd.mat_type_id=mid.mat_type_id
    and mtd.is_stop=0
    left join hos_fac_dict hfd on hfd.group_id = mid.group_id
    and hfd.hos_id = mid.hos_id
    and hfd.fac_id = mid.fac_id
    and hfd.is_stop = 0 
      left join hos_unit hu on hu.group_id = mid.group_id
    and hu.hos_id = mid.hos_id
    and hu.unit_code = mid.unit_code
    and hu.is_stop = 0 
     <where>
		    <if test="mat_type_code!=null and mat_type_code!=''">
		      and mid.mat_type_id=#{mat_type_code}
		    </if>
		    <if test="inv_model != null and inv_model != ''">
		    and (mid.inv_model like '%${inv_model}%'
		       or upper(mid.inv_name) like '%${inv_model}%'
		           or upper(mid.inv_code) like '%${inv_model}%'
		         or upper(mid.spell_code) like '%${inv_model}%'
		         or upper(mid.wbx_code) like '%${inv_model}%'
		       or lower(mid.inv_name) like '%${inv_model}%'
		           or lower(mid.inv_code) like '%${inv_model}%'
		         or lower(mid.spell_code) like '%${inv_model}%'
		         or lower(mid.wbx_code) like '%${inv_model}%'
		         )
		   </if>
		  </where>
    group by grouping sets((hsd.store_id, hsd.store_code, hsd.store_name, mid.inv_id, mid.inv_code
      , mid.inv_name, mid.inv_model, hu.unit_name
      , hfd.fac_code, hfd.fac_name, mtd.mat_type_code, mtd.mat_type_name),(mtd.mat_type_code, mtd.mat_type_name))
    order by mtd.mat_type_code,mtd.mat_type_name,mid.inv_name,mid.inv_model
	 ) 
  
  select store_id, store_code, store_name, inv_id，decode(inv_code, '0', '合计', inv_code) as inv_code
      , inv_name, inv_model, unit_name, fac_code, fac_name
      , mat_type_code, mat_type_name , init_amount  ,init_amount_money , in_amount
      ,in_amount_money ,out_amount ,  out_amount_money , end_amount,end_amount_money  from temp1
	</select>
	
	<select id="queryMatStoreInvInOutDetail" parameterType="java.util.Map" resultMap="matStorageQueryWorkDetailMap">
	
	with init_data_collection as (
        select group_id,
               hos_id,
               copy_code,
               store_id,
               inv_id,
               sum(nvl(begin_amount, 0)) + sum(nvl(in_amount, 0)) -
               sum(nvl(out_amount, 0)) as init_amount,
               sum(nvl(begin_money, 0)) + sum(nvl(in_money, 0)) -
               sum(nvl(out_money, 0)) as init_amount_money,
               null as init_in_amount,
               null as init_in_amount_money,
               null as init_out_amount,
               null as init_out_amount_money
          from mat_inv_balance mib
         <where>
            <if test="group_id!=null and group_id!=''">
              and mib.group_id=#{group_id}
            </if>
            <if test="hos_id!=null and hos_id!=''">
              and mib.hos_id=#{hos_id}
            </if>
            <if test="copy_code!=null and copy_code!=''">
              and mib.copy_code=#{copy_code}
            </if>
            <if test="store_id!=null and store_id!=''">
              and mib.store_id=#{store_id}
            </if>
            <if test="inv_id!=null and inv_id!=''">
              and mib.inv_id = #{inv_id}
            </if>
            <if test="preMonth!=null and preMonth!=''">
              and mib.year||mib.month=#{preMonth}
            </if>
          </where>
         group by group_id, hos_id, copy_code, store_id, inv_id
        union all
        select mim.group_id,
               mim.hos_id,
               mim.copy_code,
               mim.store_id,
               mid.inv_id,
               null as init_amount,
               null as init_amount_money,
               sum(nvl(amount, 0)) as init_in_amount,
               sum(nvl(amount_money, 0)) as init_in_amount_money,
               null as init_out_amount,
               null as init_out_amount_money
          from mat_in_main mim
          left join mat_in_detail mid
            on mid.group_id = mim.group_id
           and mid.hos_id = mim.hos_id
           and mid.copy_code = mim.copy_code
           and mid.in_id = mim.in_id
          <where>
            mid.inv_id is not null
            and mim.bus_type_code!=1
            <if test="group_id!=null and group_id!=''">
              and mim.group_id=#{group_id}
            </if>
            <if test="hos_id!=null and hos_id!=''">
              and mim.hos_id=#{hos_id}
            </if>
            <if test="copy_code!=null and copy_code!=''">
              and mim.copy_code=#{copy_code}
            </if>
            <if test="store_id!=null and store_id!=''">
              and mim.store_id=#{store_id}
            </if>
            <if test="inv_id!=null and inv_id!=''">
              and mid.inv_id = #{inv_id}
            </if>
            <if test="preDate!=null and preDate!=''">
              and mim.confirm_date>=to_date(#{preDate},'yyyy-MM-dd')
            </if>
            <if test="startDate!=null and startDate!=''">
              and mim.confirm_date<![CDATA[<]]> to_date(#{startDate},'yyyy-MM-dd')
            </if>
          </where>
         group by mim.group_id, mim.hos_id, mim.copy_code, mim.store_id, mid.inv_id
        union all
        select mom.group_id,
               mom.hos_id,
               mom.copy_code,
               mom.store_id,
               modd.inv_id,
               null as init_amount,
               null as init_amount_money,
               null as init_in_amount,
               null as init_in_amount_money,
               sum(nvl(modd.amount, 0)) as init_out_amount,
               sum(nvl(modd.amount_money, 0)) as init_out_amount_money
          from mat_out_main mom
          left join mat_out_detail modd
            on modd.group_id = mom.group_id
           and modd.hos_id = mom.hos_id
           and modd.copy_code = mom.copy_code
           and modd.out_id = mom.out_id
          <where>
            modd.inv_id is not null
            <if test="group_id!=null and group_id!=''">
              and mom.group_id=#{group_id}
            </if>
            <if test="hos_id!=null and hos_id!=''">
              and mom.hos_id=#{hos_id}
            </if>
            <if test="copy_code!=null and copy_code!=''">
              and mom.copy_code=#{copy_code}
            </if>
            <if test="store_id!=null and store_id!=''">
              and mom.store_id=#{store_id}
            </if>
            <if test="inv_id!=null and inv_id!=''">
              and modd.inv_id = #{inv_id}
            </if>
            <if test="preDate!=null and preDate!=''">
              and mom.confirm_date>=to_date(#{preDate},'yyyy-MM-dd')
            </if>
            <if test="startDate!=null and startDate!=''">
              and mom.confirm_date<![CDATA[<]]> to_date(#{startDate},'yyyy-MM-dd')
            </if>
          </where>
         group by mom.group_id,
                  mom.hos_id,
                  mom.copy_code,
                  mom.store_id,
                  modd.inv_id
    ),
    init_inv_data as (
         select  group_id,
                 hos_id,
                 copy_code,
                 null bus_type_code,
                 null as id,
                 null as no,
                 store_id,
                 null as price,
                 sum(nvl(init_amount,0))+sum(nvl(init_in_amount,0))-sum(nvl(init_out_amount,0)) amount,
                 sum(nvl(init_amount_money,0))+sum(nvl(init_in_amount_money,0))-sum(nvl(init_out_amount_money,0)) amount_money,
                 null as batch_no,
                 null as batch_sn,
                 null as bar_code,
                 null as make_date,
                 null as confirm_date,
                 null as maker,
                 null as stocker,
                 null as sup_id,
                 null as dept_id,
                 inv_id,
                 'init' as flag,
                 1 sort_code
        from init_data_collection
        group by group_id,
                 hos_id,
                 copy_code,
                 store_id,
                 inv_id
   ),
   in_inv_data as (
   select mim.group_id,
               mim.hos_id,
               mim.copy_code,
               mim.bus_type_code,
               mim.in_id id,
               mim.in_no no,
               mim.store_id,
               mid.price,
               mid.amount,
               mid.amount_money,
               mid.batch_no,
               mid.batch_sn,
               mid.bar_code,
               mim.in_date make_date,
               mim.confirm_date confirm_date,
               mim.maker,
               mim.stocker,          
               mim.sup_id,
               null as dept_id,
               mid.inv_id,
               'in' as flag,
               2 sort_code
          from mat_in_main mim
          left join mat_in_detail mid
            on mid.group_id = mim.group_id
           and mid.hos_id = mim.hos_id
           and mid.copy_code = mim.copy_code
           and mid.in_id = mim.in_id
        <where>
          mid.inv_id is not null
          and mim.bus_type_code!=1
          and mim.bus_type_code != 14
          <if test="group_id!=null and group_id!=''">
            and mim.group_id=#{group_id}
          </if>
          <if test="hos_id!=null and hos_id!=''">
            and mim.hos_id=#{hos_id}
          </if>
          <if test="copy_code!=null and copy_code!=''">
            and mim.copy_code=#{copy_code}
          </if>
          <if test="store_id!=null and store_id!=''">
            and mim.store_id=#{store_id}
          </if>
          <if test="inv_id!=null and inv_id!=''">
            and mid.inv_id = #{inv_id}
          </if>
          <if test="startDate!=null and startDate!=''">
            and mim.confirm_date>=to_date(#{startDate},'yyyy-MM-dd')
          </if>
          <if test="endDate!=null and endDate!=''">
            and mim.confirm_date<![CDATA[<=]]> to_date(#{endDate},'yyyy-MM-dd')
          </if>
        </where>
   
   ),
   move_in_data as (
         
      select mtm.group_id, mtm.hos_id, mtm.copy_code, mtm.bus_type bus_type_code, mtm.tran_id as id
            , mtm.tran_no as no, mtm.in_store_id store_id, mtd.price, mtd.amount, mtd.amount_money
            , mtd.batch_no, mtd.batch_sn, mtd.bar_code, mtm.tran_date as make_date, mtm.confirm_date as confirm_date
            , mtm.maker, null as stocker,mtm.out_store_id, null as dept_id, mtd.inv_id
            , 'in' as flag, 2 as sort_code
      from mat_tran_main mtm
      left join mat_tran_detail mtd
      on mtd.group_id=mtm.group_id
      and mtd.hos_id=mtm.hos_id
      and mtd.copy_code=mtm.copy_code
      and mtd.tran_id=mtm.tran_id
      and mtd.tran_no=mtm.tran_no
       <where>
          mtd.inv_id is not null
          <if test="group_id!=null and group_id!=''">
            and mtm.group_id=#{group_id}
          </if>
          <if test="hos_id!=null and hos_id!=''">
            and mtm.hos_id=#{hos_id}
          </if>
          <if test="copy_code!=null and copy_code!=''">
            and mtm.copy_code=#{copy_code}
          </if>
          <if test="store_id!=null and store_id!=''">
            and mtm.in_store_id=#{store_id}
          </if>
          <if test="inv_id!=null and inv_id!=''">
            and mtd.inv_id = #{inv_id}
          </if>
          <if test="startDate!=null and startDate!=''">
            and mtm.confirm_date>=to_date(#{startDate},'yyyy-MM-dd')
          </if>
          <if test="endDate!=null and endDate!=''">
            and mtm.confirm_date<![CDATA[<=]]> to_date(#{endDate},'yyyy-MM-dd')
          </if>
        </where>
      
   ),
   out_inv_data as (
        select mom.group_id,
               mom.hos_id,
               mom.copy_code,
               mom.bus_type_code,
               mom.out_id id,
               mom.out_no no,
               mom.store_id,
               modd.price,
               modd.amount,
               modd.amount_money,
               modd.batch_no,
               modd.batch_sn,
               modd.bar_code,
               mom.out_date make_date,
               mom.confirm_date confirm_date,
               mom.maker,
               null as stocker,
               null as sup_id,
               mom.dept_id,
               modd.inv_id,
               'out' as flag,
               2 sort_code
          from mat_out_main mom
          left join mat_out_detail modd
            on modd.group_id = mom.group_id
           and modd.hos_id = mom.hos_id
           and modd.copy_code = mom.copy_code
           and modd.out_id = mom.out_id
         <where>
            modd.inv_id is not null
            and mom.bus_type_code!=15
            <if test="group_id!=null and group_id!=''">
              and mom.group_id=#{group_id}
            </if>
            <if test="hos_id!=null and hos_id!=''">
              and mom.hos_id=#{hos_id}
            </if>
            <if test="copy_code!=null and copy_code!=''">
              and mom.copy_code=#{copy_code}
            </if>
            <if test="store_id!=null and store_id!=''">
              and mom.store_id=#{store_id}
            </if>
            <if test="inv_id!=null and inv_id!=''">
              and modd.inv_id = #{inv_id}
            </if>
            <if test="startDate!=null and startDate!=''">
              and mom.confirm_date>=to_date(#{startDate},'yyyy-MM-dd')
            </if>
            <if test="endDate!=null and endDate!=''">
              and mom.confirm_date<![CDATA[<=]]> to_date(#{endDate},'yyyy-MM-dd')
            </if>
          </where>
    ),
    move_out_data as (
       select mtm.group_id, mtm.hos_id, mtm.copy_code, mtm.bus_type bus_type_code, mtm.tran_id as id
            , mtm.tran_no as no, mtm.out_store_id store_id, mtd.price, mtd.amount, mtd.amount_money
            , mtd.batch_no, mtd.batch_sn, mtd.bar_code, mtm.tran_date as make_date, mtm.confirm_date as confirm_date
            , mtm.maker, null as stocker,mtm.in_store_id, null as dept_id, mtd.inv_id
            , 'out' as flag, 2 as sort_code
      from mat_tran_main mtm
      left join mat_tran_detail mtd
      on mtd.group_id=mtm.group_id
      and mtd.hos_id=mtm.hos_id
      and mtd.copy_code=mtm.copy_code
      and mtd.tran_id=mtm.tran_id
      and mtd.tran_no=mtm.tran_no
         <where>
            mtd.inv_id is not null
            
            <if test="group_id!=null and group_id!=''">
              and mtm.group_id=#{group_id}
            </if>
            <if test="hos_id!=null and hos_id!=''">
              and mtm.hos_id=#{hos_id}
            </if>
            <if test="copy_code!=null and copy_code!=''">
              and mtm.copy_code=#{copy_code}
            </if>
            <if test="store_id!=null and store_id!=''">
              and mtm.out_store_id=#{store_id}
            </if>
            <if test="inv_id!=null and inv_id!=''">
              and mtd.inv_id = #{inv_id}
            </if>
            <if test="startDate!=null and startDate!=''">
              and mtm.confirm_date>=to_date(#{startDate},'yyyy-MM-dd')
            </if>
            <if test="endDate!=null and endDate!=''">
              and mtm.confirm_date<![CDATA[<=]]> to_date(#{endDate},'yyyy-MM-dd')
            </if>
          </where>
    ),
    end_inv_data as (
    select     group_id,
               hos_id,
               copy_code,
               null as bus_type_code,
               null as id,
               null as no,
               store_id,
               null as price,
               sum(nvl(amount,0)) amount,
               sum(nvl(amount_money,0)) amount_money,
               null batch_no,
               null batch_sn,
               null bar_code,
               null make_date,
               null confirm_date,
               null maker,
               null stocker,
               null sup_id,
               null dept_id,
               inv_id,
               'end' flag,
               '3' sort_code
   
    from    (select
               inid.group_id,
               inid.hos_id,
               inid.copy_code,
               null as bus_type_code,
               null as id,
               null as no,
               inid.store_id,
               null as price,
               nvl(iid.amount,0)+nvl(inid.amount,0)+nvl(move_in.amount,0)-nvl(outid.amount,0)-nvl(move_out.amount,0) amount,
               nvl(iid.amount_money,0)+nvl(inid.amount_money,0)+nvl(move_in.amount_money,0)-nvl(outid.amount_money,0)-nvl(move_out.amount_money,0) amount_money,
               null batch_no,
               null batch_sn,
               null bar_code,
               null make_date,
               null confirm_date,
               null maker,
               null stocker,
               null sup_id,
               null dept_id,
               inid.inv_id,
               'end' flag,
               '3' sort_code
         from init_inv_data iid
         full join (
              select   group_id,
                       hos_id,
                       copy_code,
                       store_id,
                       inv_id,
                       sum(nvl(amount,0)) amount,
                       sum(nvl(amount_money,0)) amount_money
              from in_inv_data
              group by group_id,
                       hos_id,
                       copy_code,
                       store_id,
                       inv_id
         ) inid
         on inid.group_id=iid.group_id
         and inid.hos_id=iid.hos_id
         and inid.copy_code=iid.copy_code
         and inid.store_id=iid.store_id
         and inid.inv_id=iid.inv_id
         full join (
              select   group_id,
                       hos_id,
                       copy_code,
                       store_id,
                       inv_id,
                       sum(nvl(amount,0)) amount,
                       sum(nvl(amount_money,0)) amount_money
              from out_inv_data
              group by group_id,
                       hos_id,
                       copy_code,
                       store_id,
                       inv_id
         ) outid
         on outid.group_id=inid.group_id
         and outid.hos_id=inid.hos_id
         and outid.copy_code=inid.copy_code
         and outid.store_id=inid.store_id
         and outid.inv_id=inid.inv_id
         full join (
              select   group_id,
                       hos_id,
                       copy_code,
                       store_id,
                       inv_id,
                       sum(nvl(amount,0)) amount,
                       sum(nvl(amount_money,0)) amount_money
              from move_in_data
              group by group_id,
                       hos_id,
                       copy_code,
                       store_id,
                       inv_id
         ) move_in
         on move_in.group_id=inid.group_id
         and move_in.hos_id=inid.hos_id
         and move_in.copy_code=inid.copy_code
         and move_in.store_id=inid.store_id
         and move_in.inv_id=inid.inv_id
         full join (
              select   group_id,
                       hos_id,
                       copy_code,
                       store_id,
                       inv_id,
                       sum(nvl(amount,0)) amount,
                       sum(nvl(amount_money,0)) amount_money
              from move_out_data
              group by group_id,
                       hos_id,
                       copy_code,
                       store_id,
                       inv_id
         ) move_out
         on move_out.group_id=inid.group_id
         and move_out.hos_id=inid.hos_id
         and move_out.copy_code=inid.copy_code
         and move_out.store_id=inid.store_id
         and move_out.inv_id=inid.inv_id
      )
      group by group_id,hos_id,copy_code,inv_id,store_id
   ),
   inv_data as ( 
   

 select       a4.id,
              a4.no,
              a4.inv_code,
              a4.inv_name,
              a4.inv_model,
              a4.unit_name,
              a4.store_code,
              a4.store_name,
              a4.dept_code,
              a4.dept_name,
              a4.sup_code,
              to_char(a4.sup_name) sup_name,
              a4.price,
              a4.amount,
              a4.amount_money,
              a4.batch_no,
              a4.batch_sn,
              a4.bar_code,
              a4.fac_code,
              a4.fac_name,
              a4.make_date,
              a4.confirm_date,
              a4.maker_code,
              a4.maker_name,
              a4.stocker_code,
              a4.stocker_name,
              to_char(a4.bus_type_code) bus_type_code,
              to_char(a4.bus_type_name) bus_type_name,
              a4.flag,
              a4.sort_code
    from (
      select a3.*, rownum as rn
      from (
            select
                null id,
                null no,
                null inv_code,
                null inv_name,
                null inv_model,
                null unit_name,
                null store_code,
                null store_name,
                null dept_code,
                null dept_name,
                null sup_code,
                null sup_name,
                null price,
                0 amount,
                0 amount_money,
                null batch_no,
                null batch_sn,
                null bar_code,
                null fac_code,
                null fac_name,
                null make_date,
                null confirm_date,
                null  maker_code,
                null  maker_name,
                null  stocker_code,
                null  stocker_name,
                null bus_type_code,
                '期初' bus_type_name,
                'init' flag,
                1 sort_code
          from dual
          
         union all
         select
              null id,
              null no,
              null inv_code,
              null inv_name,
              null inv_model,
              null unit_name,
              null store_code,
              null store_name,
              null dept_code,
              null dept_name,
              null sup_code,
              null sup_name,
              null price,
              ia.amount,
              ia.amount_money,
              null batch_no,
              null batch_sn,
              null bar_code,
              null fac_code,
              null fac_name,
              null make_date,
              null confirm_date,
              null  maker_code,
              null  maker_name,
              null  stocker_code,
              null  stocker_name,
              null bus_type_code,
              '期初' bus_type_name,
              'init' flag,
              1 sort_code
        from init_inv_data ia
        left join mat_inv_dict mid
        on mid.group_id=ia.group_id
        and mid.hos_id=ia.hos_id
        and mid.copy_code=ia.copy_code
        and mid.inv_id=ia.inv_id
        and mid.is_stop=0
        left join hos_unit hu
        on hu.group_id=mid.group_id
        and hu.hos_id=mid.hos_id
        and hu.unit_code=mid.unit_code
        and hu.is_stop=0
        left join hos_store_dict hsd
        on hsd.group_id=ia.group_id
        and hsd.hos_id=ia.hos_id
        and hsd.store_id=ia.store_id
        and hsd.is_stop=0
        left join hos_dept_dict hdd
        on hdd.group_id=ia.group_id
        and hdd.hos_id=ia.hos_id
        and hdd.dept_id=ia.dept_id
        and hdd.is_stop=0
        left join hos_sup_dict sup
        on sup.group_id=ia.group_id
        and sup.hos_id=ia.hos_id
        and sup.sup_id=ia.sup_id
        and sup.is_stop=0
        left join hos_fac_dict hfd
        on hfd.group_id=ia.group_id
        and hfd.hos_id=ia.hos_id
        and hfd.fac_id=mid.fac_id
        and hfd.is_stop=0
        left join sys_user m
        on m.group_id=ia.group_id
        and m.hos_id=ia.hos_id
        and m.copy_code=ia.copy_code
        and m.user_id=ia.maker
        and m.is_stop=0
        left join hos_emp_dict hed
        on hed.group_id=ia.group_id
        and hed.hos_id=ia.hos_id
        and hed.emp_id=ia.stocker
        and hed.is_stop=0
        left join mat_bus_type mbt
        on mbt.bus_type_code=ia.bus_type_code
        and mbt.is_stop=0
      ) a3
    ) a4
    where rn > case when (
        select count(1) from init_inv_data 
      ) > 0 then 1 else 0 end
    union all
    select
          ia.id,
          ia.no,
          mid.inv_code,
          mid.inv_name,
          mid.inv_model,
          hu.unit_name,
          hsd.store_code,
          hsd.store_name,
          hdd.dept_code,
          hdd.dept_name,
          sup.sup_code,
          to_char(sup.sup_name),
          ia.price,
          ia.amount,
          ia.amount_money,
          ia.batch_no,
          ia.batch_sn,
          ia.bar_code,
          hfd.fac_code,
          hfd.fac_name,
          ia.make_date,
          ia.confirm_date,
          m.user_code maker_code,
          m.user_name maker_name,
          hed.emp_code stocker_code,
          hed.emp_name stocker_name,
          to_char(mbt.bus_type_code),
          to_char(mbt.bus_type_name),
          'in' flag,
          2 sort_code
    from in_inv_data ia
    left join mat_inv_dict mid
    on mid.group_id=ia.group_id
    and mid.hos_id=ia.hos_id
    and mid.copy_code=ia.copy_code
    and mid.inv_id=ia.inv_id
    and mid.is_stop=0
    left join hos_unit hu
    on hu.group_id=mid.group_id
    and hu.hos_id=mid.hos_id
    and hu.unit_code=mid.unit_code
    and hu.is_stop=0
    left join hos_store_dict hsd
    on hsd.group_id=ia.group_id
    and hsd.hos_id=ia.hos_id
    and hsd.store_id=ia.store_id
    and hsd.is_stop=0
    left join hos_dept_dict hdd
    on hdd.group_id=ia.group_id
    and hdd.hos_id=ia.hos_id
    and hdd.dept_id=ia.dept_id
    and hdd.is_stop=0
    left join hos_sup_dict sup
    on sup.group_id=ia.group_id
    and sup.hos_id=ia.hos_id
    and sup.sup_id=ia.sup_id
    and sup.is_stop=0
    left join hos_fac_dict hfd
    on hfd.group_id=ia.group_id
    and hfd.hos_id=ia.hos_id
    and hfd.fac_id=mid.fac_id
    and hfd.is_stop=0
    left join sys_user m
    on m.group_id=ia.group_id
    and m.hos_id=ia.hos_id
    and m.copy_code=ia.copy_code
    and m.user_id=ia.maker
    and m.is_stop=0
    left join hos_emp_dict hed
    on hed.group_id=ia.group_id
    and hed.hos_id=ia.hos_id
    and hed.emp_id=ia.stocker
    and hed.is_stop=0
    left join mat_bus_type mbt
    on mbt.bus_type_code=ia.bus_type_code
    and mbt.is_stop=0
    union all
    
    
    
      select
          ia.id,
          ia.no,
          mid.inv_code,
          mid.inv_name,
          mid.inv_model,
          hu.unit_name,
          hsd.store_code,
          hsd.store_name,
          null dept_code,
          null dept_name,
          out_store.store_code sup_code,
          to_char(out_store.store_name) sup_name,
          ia.price,
          ia.amount,
          ia.amount_money,
          ia.batch_no,
          ia.batch_sn,
          ia.bar_code,
          hfd.fac_code,
          hfd.fac_name,
          ia.make_date,
          ia.confirm_date,
          m.user_code maker_code,
          m.user_name maker_name,
          hed.emp_code stocker_code,
          hed.emp_name stocker_name,
          '14' bus_type_code,
          '移入库' bus_type_name,
          'in' flag,
          2 sort_code
    from move_in_data ia
    left join mat_inv_dict mid
    on mid.group_id=ia.group_id
    and mid.hos_id=ia.hos_id
    and mid.copy_code=ia.copy_code
    and mid.inv_id=ia.inv_id
    and mid.is_stop=0
    left join hos_unit hu
    on hu.group_id=mid.group_id
    and hu.hos_id=mid.hos_id
    and hu.unit_code=mid.unit_code
    and hu.is_stop=0
    left join hos_store_dict hsd
    on hsd.group_id=ia.group_id
    and hsd.hos_id=ia.hos_id
    and hsd.store_id=ia.store_id
    and hsd.is_stop=0
  
    left join hos_store_dict out_store
    on out_store.group_id=ia.group_id
    and out_store.hos_id=ia.hos_id
    and out_store.store_id=ia.out_store_id
    and out_store.is_stop=0
    left join hos_fac_dict hfd
    on hfd.group_id=ia.group_id
    and hfd.hos_id=ia.hos_id
    and hfd.fac_id=mid.fac_id
    and hfd.is_stop=0
    left join sys_user m
    on m.group_id=ia.group_id
    and m.hos_id=ia.hos_id
    and m.copy_code=ia.copy_code
    and m.user_id=ia.maker
    and m.is_stop=0
    left join hos_emp_dict hed
    on hed.group_id=ia.group_id
    and hed.hos_id=ia.hos_id
    and hed.emp_id=ia.stocker
    and hed.is_stop=0
    
    
    
    union all
    
    
    
    select
          ia.id,
          ia.no,
          mid.inv_code,
          mid.inv_name,
          mid.inv_model,
          hu.unit_name,
          hsd.store_code,
          hsd.store_name,
          hdd.dept_code,
          hdd.dept_name,
          sup.sup_code,
          to_char(sup.sup_name),
          ia.price,
          ia.amount,
          ia.amount_money,
          ia.batch_no,
          ia.batch_sn,
          ia.bar_code,
          hfd.fac_code,
          hfd.fac_name,
          ia.make_date,
          ia.confirm_date,
          m.user_code maker_code,
          m.user_name maker_name,
          hed.emp_code stocker_code,
          hed.emp_name stocker_name,
          to_char(mbt.bus_type_code),
          to_char(mbt.bus_type_name),
          'out' flag,
          2 sort_code
    from out_inv_data ia
    left join mat_inv_dict mid
    on mid.group_id=ia.group_id
    and mid.hos_id=ia.hos_id
    and mid.copy_code=ia.copy_code
    and mid.inv_id=ia.inv_id
    and mid.is_stop=0
    left join hos_unit hu
    on hu.group_id=mid.group_id
    and hu.hos_id=mid.hos_id
    and hu.unit_code=mid.unit_code
    and hu.is_stop=0
    left join hos_store_dict hsd
    on hsd.group_id=ia.group_id
    and hsd.hos_id=ia.hos_id
    and hsd.store_id=ia.store_id
    and hsd.is_stop=0
    left join hos_dept_dict hdd
    on hdd.group_id=ia.group_id
    and hdd.hos_id=ia.hos_id
    and hdd.dept_id=ia.dept_id
    and hdd.is_stop=0
    left join hos_sup_dict sup
    on sup.group_id=ia.group_id
    and sup.hos_id=ia.hos_id
    and sup.sup_id=ia.sup_id
    and sup.is_stop=0
    left join hos_fac_dict hfd
    on hfd.group_id=ia.group_id
    and hfd.hos_id=ia.hos_id
    and hfd.fac_id=mid.fac_id
    and hfd.is_stop=0
    left join sys_user m
    on m.group_id=ia.group_id
    and m.hos_id=ia.hos_id
    and m.copy_code=ia.copy_code
    and m.user_id=ia.maker
    and m.is_stop=0
    left join hos_emp_dict hed
    on hed.group_id=ia.group_id
    and hed.hos_id=ia.hos_id
    and hed.emp_id=ia.stocker
    and hed.is_stop=0
    left join mat_bus_type mbt
    on mbt.bus_type_code=ia.bus_type_code 
    and mbt.is_stop=0
    union all
    
    
    
    select
          ia.id,
          ia.no,
          mid.inv_code,
          mid.inv_name,
          mid.inv_model,
          hu.unit_name,
          hsd.store_code,
          hsd.store_name,
          in_store.store_code dept_code,
          in_store.store_name dept_name,
          null sup_code,
          null sup_name,
          ia.price,
          ia.amount,
          ia.amount_money,
          ia.batch_no,
          ia.batch_sn,
          ia.bar_code,
          hfd.fac_code,
          hfd.fac_name,
          ia.make_date,
          ia.confirm_date,
          m.user_code maker_code,
          m.user_name maker_name,
          hed.emp_code stocker_code,
          hed.emp_name stocker_name,
          '15' bus_type_code,
          '移出库' bus_type_name,
          'out' flag,
          2 sort_code
    from move_out_data ia
    left join mat_inv_dict mid
    on mid.group_id=ia.group_id
    and mid.hos_id=ia.hos_id
    and mid.copy_code=ia.copy_code
    and mid.inv_id=ia.inv_id
    and mid.is_stop=0
    left join hos_unit hu
    on hu.group_id=mid.group_id
    and hu.hos_id=mid.hos_id
    and hu.unit_code=mid.unit_code
    and hu.is_stop=0
    left join hos_store_dict hsd
    on hsd.group_id=ia.group_id
    and hsd.hos_id=ia.hos_id
    and hsd.store_id=ia.store_id
    and hsd.is_stop=0
    left join hos_store_dict in_store
    on in_store.group_id=ia.group_id
    and in_store.hos_id=ia.hos_id
    and in_store.store_id=ia.in_store_id
    and in_store.is_stop=0
   
    left join hos_fac_dict hfd
    on hfd.group_id=ia.group_id
    and hfd.hos_id=ia.hos_id
    and hfd.fac_id=mid.fac_id
    and hfd.is_stop=0
    left join sys_user m
    on m.group_id=ia.group_id
    and m.hos_id=ia.hos_id
    and m.copy_code=ia.copy_code
    and m.user_id=ia.maker
    and m.is_stop=0
    left join hos_emp_dict hed
    on hed.group_id=ia.group_id
    and hed.hos_id=ia.hos_id
    and hed.emp_id=ia.stocker
    and hed.is_stop=0
    union all
    
    
    
    
    
    
    select
          null id,
          null no,
          null inv_code,
          null inv_name,
          null inv_model,
          null unit_name,
          null store_code,
          null store_name,
          null dept_code,
          null dept_name,
          null sup_code,
          null sup_name,
          null price,
          ia.amount,
          ia.amount_money,
          null batch_no,
          null batch_sn,
          null bar_code,
          null fac_code,
          null fac_name,
          null make_date,
          null confirm_date,
          null  maker_code,
          null  maker_name,
          null  stocker_code,
          null  stocker_name,
          null bus_type_code,
          '期末' bus_type_name,
          'end' flag,
          3 sort_code
    from end_inv_data ia
    left join mat_inv_dict mid
    on mid.group_id=ia.group_id
    and mid.hos_id=ia.hos_id
    and mid.copy_code=ia.copy_code
    and mid.inv_id=ia.inv_id
    and mid.is_stop=0
    left join hos_unit hu
    on hu.group_id=mid.group_id
    and hu.hos_id=mid.hos_id
    and hu.unit_code=mid.unit_code
    and hu.is_stop=0
    left join hos_store_dict hsd
    on hsd.group_id=ia.group_id
    and hsd.hos_id=ia.hos_id
    and hsd.store_id=ia.store_id
    and hsd.is_stop=0
    left join hos_dept_dict hdd
    on hdd.group_id=ia.group_id
    and hdd.hos_id=ia.hos_id
    and hdd.dept_id=ia.dept_id
    and hdd.is_stop=0
    left join hos_sup_dict sup
    on sup.group_id=ia.group_id
    and sup.hos_id=ia.hos_id
    and sup.sup_id=ia.sup_id
    and sup.is_stop=0
    left join hos_fac_dict hfd
    on hfd.group_id=ia.group_id
    and hfd.hos_id=ia.hos_id
    and hfd.fac_id=mid.fac_id
    and hfd.is_stop=0
    left join sys_user m
    on m.group_id=ia.group_id
    and m.hos_id=ia.hos_id
    and m.copy_code=ia.copy_code
    and m.user_id=ia.maker
    and m.is_stop=0
    left join hos_emp_dict hed
    on hed.group_id=ia.group_id
    and hed.hos_id=ia.hos_id
    and hed.emp_id=ia.stocker
    and hed.is_stop=0
    left join mat_bus_type mbt
    on mbt.bus_type_code=ia.bus_type_code
    and mbt.is_stop=0
    
   )
   select  
        id,
           no,
        inv_code,
           inv_name,
           inv_model,
           unit_name,
           store_code,
           store_name,
           dept_code,
           dept_name,
           sup_code,
           sup_name,
           price,
           amount,
           amount_money,
           batch_no,
           batch_sn,
           bar_code,
           fac_code,
           fac_name,
           make_date,
           confirm_date,
           maker_code,
           maker_name,
           stocker_code,
           stocker_name,
           bus_type_code,
           bus_type_name,
           flag
   from inv_data
   order by sort_code,confirm_date,flag,no
	
	
	
	<!--   with init_data_collection as (
	      select group_id,
	             hos_id,
	             copy_code,
	             store_id,
	             inv_id,
	             sum(nvl(begin_amount, 0)) + sum(nvl(in_amount, 0)) -
	             sum(nvl(out_amount, 0)) as init_amount,
	             sum(nvl(begin_money, 0)) + sum(nvl(in_money, 0)) -
	             sum(nvl(out_money, 0)) as init_amount_money,
	             null as init_in_amount,
	             null as init_in_amount_money,
	             null as init_out_amount,
	             null as init_out_amount_money
	        from mat_inv_balance mib
	       <where>
	          <if test="group_id!=null and group_id!=''">
	            and mib.group_id=#{group_id}
	          </if>
	          <if test="hos_id!=null and hos_id!=''">
	            and mib.hos_id=#{hos_id}
	          </if>
	          <if test="copy_code!=null and copy_code!=''">
	            and mib.copy_code=#{copy_code}
	          </if>
	          <if test="store_id!=null and store_id!=''">
	            and mib.store_id=#{store_id}
	          </if>
	          <if test="inv_id!=null and inv_id!=''">
	            and mib.inv_id = #{inv_id}
	          </if>
	          <if test="preMonth!=null and preMonth!=''">
	            and mib.year||mib.month=#{preMonth}
	          </if>
	        </where>
	       group by group_id, hos_id, copy_code, store_id, inv_id
	      union all
	      select mim.group_id,
	             mim.hos_id,
	             mim.copy_code,
	             mim.store_id,
	             mid.inv_id,
	             null as init_amount,
	             null as init_amount_money,
	             sum(nvl(amount, 0)) as init_in_amount,
	             sum(nvl(amount_money, 0)) as init_in_amount_money,
	             null as init_out_amount,
	             null as init_out_amount_money
	        from mat_in_main mim
	        left join mat_in_detail mid
	          on mid.group_id = mim.group_id
	         and mid.hos_id = mim.hos_id
	         and mid.copy_code = mim.copy_code
	         and mid.in_id = mim.in_id
	        <where>
	          mid.inv_id is not null
	          and mim.bus_type_code!=1
	          <if test="group_id!=null and group_id!=''">
	            and mim.group_id=#{group_id}
	          </if>
	          <if test="hos_id!=null and hos_id!=''">
	            and mim.hos_id=#{hos_id}
	          </if>
	          <if test="copy_code!=null and copy_code!=''">
	            and mim.copy_code=#{copy_code}
	          </if>
	          <if test="store_id!=null and store_id!=''">
	            and mim.store_id=#{store_id}
	          </if>
	          <if test="inv_id!=null and inv_id!=''">
	            and mid.inv_id = #{inv_id}
	          </if>
	          <if test="preDate!=null and preDate!=''">
	            and mim.confirm_date>=to_date(#{preDate},'yyyy-MM-dd')
	          </if>
	          <if test="startDate!=null and startDate!=''">
	            and mim.confirm_date<![CDATA[<]]> to_date(#{startDate},'yyyy-MM-dd')
	          </if>
	        </where>
	       group by mim.group_id, mim.hos_id, mim.copy_code, mim.store_id, mid.inv_id
	      union all
	      select mom.group_id,
	             mom.hos_id,
	             mom.copy_code,
	             mom.store_id,
	             modd.inv_id,
	             null as init_amount,
	             null as init_amount_money,
	             null as init_in_amount,
	             null as init_in_amount_money,
	             sum(nvl(modd.amount, 0)) as init_out_amount,
	             sum(nvl(modd.amount_money, 0)) as init_out_amount_money
	        from mat_out_main mom
	        left join mat_out_detail modd
	          on modd.group_id = mom.group_id
	         and modd.hos_id = mom.hos_id
	         and modd.copy_code = mom.copy_code
	         and modd.out_id = mom.out_id
	        <where>
	          modd.inv_id is not null
	          <if test="group_id!=null and group_id!=''">
	            and mom.group_id=#{group_id}
	          </if>
	          <if test="hos_id!=null and hos_id!=''">
	            and mom.hos_id=#{hos_id}
	          </if>
	          <if test="copy_code!=null and copy_code!=''">
	            and mom.copy_code=#{copy_code}
	          </if>
	          <if test="store_id!=null and store_id!=''">
	            and mom.store_id=#{store_id}
	          </if>
	          <if test="inv_id!=null and inv_id!=''">
	            and modd.inv_id = #{inv_id}
	          </if>
	          <if test="preDate!=null and preDate!=''">
	            and mom.confirm_date>=to_date(#{preDate},'yyyy-MM-dd')
	          </if>
	          <if test="startDate!=null and startDate!=''">
	            and mom.confirm_date<![CDATA[<]]> to_date(#{startDate},'yyyy-MM-dd')
	          </if>
	        </where>
	       group by mom.group_id,
	                mom.hos_id,
	                mom.copy_code,
	                mom.store_id,
	                modd.inv_id
	  ),
	  init_inv_data as (
	       select  group_id,
	               hos_id,
	               copy_code,
	               null bus_type_code,
	               null as id,
	               null as no,
	               store_id,
	               null as price,
	               sum(nvl(init_amount,0))+sum(nvl(init_in_amount,0))-sum(nvl(init_out_amount,0)) amount,
	               sum(nvl(init_amount_money,0))+sum(nvl(init_in_amount_money,0))-sum(nvl(init_out_amount_money,0)) amount_money,
	               null as batch_no,
	               null as batch_sn,
	               null as bar_code,
	               null as make_date,
	               null as confirm_date,
	               null as maker,
	               null as stocker,
	               null as sup_id,
	               null as dept_id,
	               inv_id,
	               'init' as flag,
	               1 sort_code
	      from init_data_collection
	      group by group_id,
	               hos_id,
	               copy_code,
	               store_id,
	               inv_id
	 ),
	 in_inv_data as (
	 select mim.group_id,
	             mim.hos_id,
	             mim.copy_code,
	             mim.bus_type_code,
	             mim.in_id id,
	             mim.in_no no,
	             mim.store_id,
	             mid.price,
	             mid.amount,
	             mid.amount_money,
	             mid.batch_no,
	             mid.batch_sn,
	             mid.bar_code,
	             mim.in_date make_date,
	             mim.confirm_date confirm_date,
	             mim.maker,
	             mim.stocker,          
	             mim.sup_id,
	             null as dept_id,
	             mid.inv_id,
	             'in' as flag,
	             2 sort_code
	        from mat_in_main mim
	        left join mat_in_detail mid
	          on mid.group_id = mim.group_id
	         and mid.hos_id = mim.hos_id
	         and mid.copy_code = mim.copy_code
	         and mid.in_id = mim.in_id
	      <where>
	        mid.inv_id is not null
	        and mim.bus_type_code!=1
	        and mim.bus_type_code != 14
	        <if test="group_id!=null and group_id!=''">
	          and mim.group_id=#{group_id}
	        </if>
	        <if test="hos_id!=null and hos_id!=''">
	          and mim.hos_id=#{hos_id}
	        </if>
	        <if test="copy_code!=null and copy_code!=''">
	          and mim.copy_code=#{copy_code}
	        </if>
	        <if test="store_id!=null and store_id!=''">
	          and mim.store_id=#{store_id}
	        </if>
	        <if test="inv_id!=null and inv_id!=''">
	          and mid.inv_id = #{inv_id}
	        </if>
	        <if test="startDate!=null and startDate!=''">
	          and mim.confirm_date>=to_date(#{startDate},'yyyy-MM-dd')
	        </if>
	        <if test="endDate!=null and endDate!=''">
	          and mim.confirm_date<![CDATA[<=]]> to_date(#{endDate},'yyyy-MM-dd')
	        </if>
	      </where>
	 
	 ),
	 out_inv_data as (
	      select mom.group_id,
	             mom.hos_id,
	             mom.copy_code,
	             mom.bus_type_code,
	             mom.out_id id,
	             mom.out_no no,
	             mom.store_id,
	             modd.price,
	             modd.amount,
	             modd.amount_money,
	             modd.batch_no,
	             modd.batch_sn,
	             modd.bar_code,
	             mom.out_date make_date,
	             mom.confirm_date confirm_date,
	             mom.maker,
	             null as stocker,
	             null as sup_id,
	             mom.dept_id,
	             modd.inv_id,
	             'out' as flag,
	             2 sort_code
	        from mat_out_main mom
	        left join mat_out_detail modd
	          on modd.group_id = mom.group_id
	         and modd.hos_id = mom.hos_id
	         and modd.copy_code = mom.copy_code
	         and modd.out_id = mom.out_id
	       <where>
	          modd.inv_id is not null
	          and mom.bus_type_code!=15
	          <if test="group_id!=null and group_id!=''">
	            and mom.group_id=#{group_id}
	          </if>
	          <if test="hos_id!=null and hos_id!=''">
	            and mom.hos_id=#{hos_id}
	          </if>
	          <if test="copy_code!=null and copy_code!=''">
	            and mom.copy_code=#{copy_code}
	          </if>
	          <if test="store_id!=null and store_id!=''">
	            and mom.store_id=#{store_id}
	          </if>
	          <if test="inv_id!=null and inv_id!=''">
	            and modd.inv_id = #{inv_id}
	          </if>
	          <if test="startDate!=null and startDate!=''">
	            and mom.confirm_date>=to_date(#{startDate},'yyyy-MM-dd')
	          </if>
	          <if test="endDate!=null and endDate!=''">
	            and mom.confirm_date<![CDATA[<=]]> to_date(#{endDate},'yyyy-MM-dd')
	          </if>
	        </where>
	  ),
	  end_inv_data as (
	 
	       select
	             inid.group_id,
	             inid.hos_id,
	             inid.copy_code,
	             null as bus_type_code,
	             null as id,
	             null as no,
	             inid.store_id,
	             null as price,
	             nvl(iid.amount,0)+nvl(inid.amount,0)-nvl(outid.amount,0) amount,
	             nvl(iid.amount_money,0)+nvl(inid.amount_money,0)-nvl(outid.amount_money,0) amount_money,
	             null batch_no,
	             null batch_sn,
	             null bar_code,
	             null make_date,
	             null confirm_date,
	             null maker,
	             null stocker,
	             null sup_id,
	             null dept_id,
	             inid.inv_id,
	             'end' flag,
	             '3' sort_code
	       from init_inv_data iid
	       full join (
	            select   group_id,
	                     hos_id,
	                     copy_code,
	                     store_id,
	                     inv_id,
	                     sum(nvl(amount,0)) amount,
	                     sum(nvl(amount_money,0)) amount_money
	            from in_inv_data
	            group by group_id,
	                     hos_id,
	                     copy_code,
	                     store_id,
	                     inv_id
	       ) inid
	       on inid.group_id=iid.group_id
	       and inid.hos_id=iid.hos_id
	       and inid.copy_code=iid.copy_code
	       and inid.store_id=iid.store_id
	       and inid.inv_id=iid.inv_id
	       full join (
	            select   group_id,
	                     hos_id,
	                     copy_code,
	                     store_id,
	                     inv_id,
	                     sum(nvl(amount,0)) amount,
	                     sum(nvl(amount_money,0)) amount_money
	            from out_inv_data
	            group by group_id,
	                     hos_id,
	                     copy_code,
	                     store_id,
	                     inv_id
	       ) outid
	       on outid.group_id=inid.group_id
	       and outid.hos_id=inid.hos_id
	       and outid.copy_code=inid.copy_code
	       and outid.store_id=inid.store_id
	       and outid.inv_id=inid.inv_id
	  ),
	 inv_data as ( 
	 

 select       a4.id,
              a4.no,
              a4.inv_code,
              a4.inv_name,
              a4.inv_model,
              a4.unit_name,
              a4.store_code,
              a4.store_name,
              a4.dept_code,
              a4.dept_name,
              a4.sup_code,
              a4.sup_name,
              a4.price,
              a4.amount,
              a4.amount_money,
              a4.batch_no,
              a4.batch_sn,
              a4.bar_code,
              a4.fac_code,
              a4.fac_name,
              a4.make_date,
              a4.confirm_date,
              a4.maker_code,
              a4.maker_name,
              a4.stocker_code,
              a4.stocker_name,
              a4.bus_type_code,
              a4.bus_type_name,
              a4.flag,
              a4.sort_code
    from (
      select a3.*, rownum as rn
      from (
            select
                null id,
                null no,
                null inv_code,
                null inv_name,
                null inv_model,
                null unit_name,
                null store_code,
                null store_name,
                null dept_code,
                null dept_name,
                null sup_code,
                null sup_name,
                null price,
                0 amount,
                0 amount_money,
                null batch_no,
                null batch_sn,
                null bar_code,
                null fac_code,
                null fac_name,
                null make_date,
                null confirm_date,
                null  maker_code,
                null  maker_name,
                null  stocker_code,
                null  stocker_name,
                null bus_type_code,
                '期初' bus_type_name,
                'init' flag,
                1 sort_code
          from dual
          
         union all
         select
              null id,
              null no,
              null inv_code,
              null inv_name,
              null inv_model,
              null unit_name,
              null store_code,
              null store_name,
              null dept_code,
              null dept_name,
              null sup_code,
              null sup_name,
              null price,
              ia.amount,
              ia.amount_money,
              null batch_no,
              null batch_sn,
              null bar_code,
              null fac_code,
              null fac_name,
              null make_date,
              null confirm_date,
              null  maker_code,
              null  maker_name,
              null  stocker_code,
              null  stocker_name,
              null bus_type_code,
              '期初' bus_type_name,
              'init' flag,
              1 sort_code
        from init_inv_data ia
        left join mat_inv_dict mid
        on mid.group_id=ia.group_id
        and mid.hos_id=ia.hos_id
        and mid.copy_code=ia.copy_code
        and mid.inv_id=ia.inv_id
        and mid.is_stop=0
        left join hos_unit hu
        on hu.group_id=mid.group_id
        and hu.hos_id=mid.hos_id
        and hu.unit_code=mid.unit_code
        and hu.is_stop=0
        left join hos_store_dict hsd
        on hsd.group_id=ia.group_id
        and hsd.hos_id=ia.hos_id
        and hsd.store_id=ia.store_id
        and hsd.is_stop=0
        left join hos_dept_dict hdd
        on hdd.group_id=ia.group_id
        and hdd.hos_id=ia.hos_id
        and hdd.dept_id=ia.dept_id
        and hdd.is_stop=0
        left join hos_sup_dict sup
        on sup.group_id=ia.group_id
        and sup.hos_id=ia.hos_id
        and sup.sup_id=ia.sup_id
        and sup.is_stop=0
        left join hos_fac_dict hfd
        on hfd.group_id=ia.group_id
        and hfd.hos_id=ia.hos_id
        and hfd.fac_id=mid.fac_id
        and hfd.is_stop=0
        left join sys_user m
        on m.group_id=ia.group_id
        and m.hos_id=ia.hos_id
        and m.copy_code=ia.copy_code
        and m.user_id=ia.maker
        and m.is_stop=0
        left join hos_emp_dict hed
        on hed.group_id=ia.group_id
        and hed.hos_id=ia.hos_id
        and hed.emp_id=ia.stocker
        and hed.is_stop=0
        left join mat_bus_type mbt
        on mbt.bus_type_code=ia.bus_type_code
        and mbt.is_stop=0
      ) a3
    ) a4
    where rn > case when (
        select count(1) from init_inv_data 
      ) > 0 then 1 else 0 end
	  union all
	  select
	        ia.id,
	        ia.no,
	        mid.inv_code,
	        mid.inv_name,
	        mid.inv_model,
	        hu.unit_name,
	        hsd.store_code,
	        hsd.store_name,
	        hdd.dept_code,
	        hdd.dept_name,
	        sup.sup_code,
	        sup.sup_name,
	        ia.price,
	        ia.amount,
	        ia.amount_money,
	        ia.batch_no,
	        ia.batch_sn,
	        ia.bar_code,
	        hfd.fac_code,
	        hfd.fac_name,
	        ia.make_date,
	        ia.confirm_date,
	        m.user_code maker_code,
	        m.user_name maker_name,
	        hed.emp_code stocker_code,
	        hed.emp_name stocker_name,
	        mbt.bus_type_code,
	        mbt.bus_type_name,
	        'in' flag,
	        2 sort_code
	  from in_inv_data ia
	  left join mat_inv_dict mid
	  on mid.group_id=ia.group_id
	  and mid.hos_id=ia.hos_id
	  and mid.copy_code=ia.copy_code
	  and mid.inv_id=ia.inv_id
	  and mid.is_stop=0
	  left join hos_unit hu
	  on hu.group_id=mid.group_id
	  and hu.hos_id=mid.hos_id
	  and hu.unit_code=mid.unit_code
	  and hu.is_stop=0
	  left join hos_store_dict hsd
	  on hsd.group_id=ia.group_id
	  and hsd.hos_id=ia.hos_id
	  and hsd.store_id=ia.store_id
	  and hsd.is_stop=0
	  left join hos_dept_dict hdd
	  on hdd.group_id=ia.group_id
	  and hdd.hos_id=ia.hos_id
	  and hdd.dept_id=ia.dept_id
	  and hdd.is_stop=0
	  left join hos_sup_dict sup
	  on sup.group_id=ia.group_id
	  and sup.hos_id=ia.hos_id
	  and sup.sup_id=ia.sup_id
	  and sup.is_stop=0
	  left join hos_fac_dict hfd
	  on hfd.group_id=ia.group_id
	  and hfd.hos_id=ia.hos_id
	  and hfd.fac_id=mid.fac_id
	  and hfd.is_stop=0
	  left join sys_user m
	  on m.group_id=ia.group_id
	  and m.hos_id=ia.hos_id
	  and m.copy_code=ia.copy_code
	  and m.user_id=ia.maker
	  and m.is_stop=0
	  left join hos_emp_dict hed
	  on hed.group_id=ia.group_id
	  and hed.hos_id=ia.hos_id
	  and hed.emp_id=ia.stocker
	  and hed.is_stop=0
	  left join mat_bus_type mbt
	  on mbt.bus_type_code=ia.bus_type_code
	  and mbt.is_stop=0
	  union all
	  select
	  	    ia.id,
	        ia.no,
	        mid.inv_code,
	        mid.inv_name,
	        mid.inv_model,
	        hu.unit_name,
	        hsd.store_code,
	        hsd.store_name,
	        hdd.dept_code,
	        hdd.dept_name,
	        sup.sup_code,
	        sup.sup_name,
	        ia.price,
	        ia.amount,
	        ia.amount_money,
	        ia.batch_no,
	        ia.batch_sn,
	        ia.bar_code,
	        hfd.fac_code,
	        hfd.fac_name,
	        ia.make_date,
	        ia.confirm_date,
	        m.user_code maker_code,
	        m.user_name maker_name,
	        hed.emp_code stocker_code,
	        hed.emp_name stocker_name,
	        mbt.bus_type_code,
	        mbt.bus_type_name,
	        'out' flag,
	        2 sort_code
	  from out_inv_data ia
	  left join mat_inv_dict mid
	  on mid.group_id=ia.group_id
	  and mid.hos_id=ia.hos_id
	  and mid.copy_code=ia.copy_code
	  and mid.inv_id=ia.inv_id
	  and mid.is_stop=0
	  left join hos_unit hu
	  on hu.group_id=mid.group_id
	  and hu.hos_id=mid.hos_id
	  and hu.unit_code=mid.unit_code
	  and hu.is_stop=0
	  left join hos_store_dict hsd
	  on hsd.group_id=ia.group_id
	  and hsd.hos_id=ia.hos_id
	  and hsd.store_id=ia.store_id
	  and hsd.is_stop=0
	  left join hos_dept_dict hdd
	  on hdd.group_id=ia.group_id
	  and hdd.hos_id=ia.hos_id
	  and hdd.dept_id=ia.dept_id
	  and hdd.is_stop=0
	  left join hos_sup_dict sup
	  on sup.group_id=ia.group_id
	  and sup.hos_id=ia.hos_id
	  and sup.sup_id=ia.sup_id
	  and sup.is_stop=0
	  left join hos_fac_dict hfd
	  on hfd.group_id=ia.group_id
	  and hfd.hos_id=ia.hos_id
	  and hfd.fac_id=mid.fac_id
	  and hfd.is_stop=0
	  left join sys_user m
	  on m.group_id=ia.group_id
	  and m.hos_id=ia.hos_id
	  and m.copy_code=ia.copy_code
	  and m.user_id=ia.maker
	  and m.is_stop=0
	  left join hos_emp_dict hed
	  on hed.group_id=ia.group_id
	  and hed.hos_id=ia.hos_id
	  and hed.emp_id=ia.stocker
	  and hed.is_stop=0
	  left join mat_bus_type mbt
	  on mbt.bus_type_code=ia.bus_type_code
	  and mbt.is_stop=0
	  union all
	  select
	        null id,
	        null no,
	        null inv_code,
	        null inv_name,
	        null inv_model,
	        null unit_name,
	        null store_code,
	        null store_name,
	        null dept_code,
	        null dept_name,
	        null sup_code,
	        null sup_name,
	        null price,
	        ia.amount,
	        ia.amount_money,
	        null batch_no,
	        null batch_sn,
	        null bar_code,
	        null fac_code,
	        null fac_name,
	        null make_date,
	        null confirm_date,
	        null  maker_code,
	        null  maker_name,
	        null  stocker_code,
	        null  stocker_name,
	        null bus_type_code,
	        '期末' bus_type_name,
	        'end' flag,
	        3 sort_code
	  from end_inv_data ia
	  left join mat_inv_dict mid
	  on mid.group_id=ia.group_id
	  and mid.hos_id=ia.hos_id
	  and mid.copy_code=ia.copy_code
	  and mid.inv_id=ia.inv_id
	  and mid.is_stop=0
	  left join hos_unit hu
	  on hu.group_id=mid.group_id
	  and hu.hos_id=mid.hos_id
	  and hu.unit_code=mid.unit_code
	  and hu.is_stop=0
	  left join hos_store_dict hsd
	  on hsd.group_id=ia.group_id
	  and hsd.hos_id=ia.hos_id
	  and hsd.store_id=ia.store_id
	  and hsd.is_stop=0
	  left join hos_dept_dict hdd
	  on hdd.group_id=ia.group_id
	  and hdd.hos_id=ia.hos_id
	  and hdd.dept_id=ia.dept_id
	  and hdd.is_stop=0
	  left join hos_sup_dict sup
	  on sup.group_id=ia.group_id
	  and sup.hos_id=ia.hos_id
	  and sup.sup_id=ia.sup_id
	  and sup.is_stop=0
	  left join hos_fac_dict hfd
	  on hfd.group_id=ia.group_id
	  and hfd.hos_id=ia.hos_id
	  and hfd.fac_id=mid.fac_id
	  and hfd.is_stop=0
	  left join sys_user m
	  on m.group_id=ia.group_id
	  and m.hos_id=ia.hos_id
	  and m.copy_code=ia.copy_code
	  and m.user_id=ia.maker
	  and m.is_stop=0
	  left join hos_emp_dict hed
	  on hed.group_id=ia.group_id
	  and hed.hos_id=ia.hos_id
	  and hed.emp_id=ia.stocker
	  and hed.is_stop=0
	  left join mat_bus_type mbt
	  on mbt.bus_type_code=ia.bus_type_code
	  and mbt.is_stop=0
	  
	 )
	 select  
	 		 id,
	         no,
	 		 inv_code,
	         inv_name,
	         inv_model,
	         unit_name,
	         store_code,
	         store_name,
	         dept_code,
	         dept_name,
	         sup_code,
	         sup_name,
	         price,
	         amount,
	         amount_money,
	         batch_no,
	         batch_sn,
	         bar_code,
	         fac_code,
	         fac_name,
	         make_date,
	         confirm_date,
	         maker_code,
	         maker_name,
	         stocker_code,
	         stocker_name,
	         bus_type_code,
	         bus_type_name,
	         flag
	 from inv_data
	 order by sort_code,confirm_date,no -->
	</select>

	<select id="queryStoreMsg" parameterType="java.util.Map" resultMap="matStorageQueryWorkDetailMap">
		select store_code,store_name
		from hos_store_dict
		where group_id=#{group_id}
		and hos_id=#{hos_id}
		and store_id=#{store_id}
		and is_stop=0
	</select>
	
	<select id="queryInvMsg" parameterType="java.util.Map" resultMap="matStorageQueryWorkDetailMap">
		select 
		  mid.inv_code,mid.inv_name,
		  mid.inv_model,hu.unit_name
		from mat_inv_dict mid
		left join hos_unit hu
		on hu.group_id=mid.group_id
		and hu.hos_id=mid.hos_id
		and hu.unit_code=mid.unit_code
		and hu.is_stop=0
		where mid.group_id=#{group_id}
		and mid.hos_id=#{hos_id}
		and mid.copy_code=#{copy_code}
		and mid.inv_id=#{inv_id}
		and mid.is_stop=0
	</select>

</mapper>

