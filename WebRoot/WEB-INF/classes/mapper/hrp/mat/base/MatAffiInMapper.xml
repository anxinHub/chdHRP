<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chd.hrp.mat.dao.base.MatAffiInMapper">
	<!-- 代销入库主表 -->
	<resultMap id="matAffiInMain" type="java.util.Map">
		<result property="group_id" column="group_id"/>
		<result property="hos_id" column="hos_id"/>
		<result property="copy_code" column="copy_code"/>
		<result property="in_id" column="in_id"/> 
		<result property="in_no" column="in_no"/> 
		<result property="year" column="year"/>
		<result property="month" column="month"/>
		<result property="brief" column="brief"/>
		<result property="bus_type_code" column="bus_type_code"/>
		<result property="bus_type_name" column="bus_type_name"/>
		<result property="sup_no" column="sup_no"/> 
		<result property="sup_id" column="sup_id"/>
		<result property="sup_code" column="sup_code"/>
		<result property="sup_name" column="sup_name"/>
		
		<result property="store_id" column="store_id"/>
		<result property="store_no" column="store_no"/>
		<result property="store_code" column="store_code"/>
		<result property="store_name" column="store_name"/>
		
		<result property="stocker" column="stocker"/>
		<result property="stocker_code" column="stocker_code"/>
		<result property="stocker_name" column="stocker_name"/>
		
		<result property="stock_type_code" column="stock_type_code"/>
		<result property="stock_type_name" column="stock_type_name"/>
		
		<result property="in_date" column="in_date"/>
		<result property="maker" column="maker"/>
		<result property="maker_name" column="maker_name"/>
		
		<result property="checker" column="checker"/>
		<result property="checker_name" column="checker_name"/>
		<result property="check_date" column="check_date"/>
		
		<result property="confirmer" column="confirmer"/>
		<result property="confirmer_name" column="confirmer_name"/>
		<result property="confirm_date" column="confirm_date"/>
		
		<result property="state" column="state"/>
		<result property="state_name" column="state_name"/>
		<result property="protocol_id" column="protocol_id"/>
		<result property="protocol_code" column="protocol_code"/>
		<result property="protocol_name" column="protocol_name"/>
		
		<result property="app_dept" column="app_dept"/>
		<result property="app_dept_no" column="app_dept_no"/>
		<result property="app_dept_code" column="app_dept_code"/>
		<result property="app_dept_name" column="app_dept_name"/>
		<result property="proj_id" column="proj_id"/>
		<result property="proj_code" column="proj_code"/>
		<result property="proj_name" column="proj_name"/>
		
		<result property="come_from" column="come_from" />
		<result property="delivery_code" column="delivery_code"/>
		<result property="examiner" column="examiner"/>
		<result property="examiner_code" column="examiner_code"/>
		<result property="examiner_name" column="examiner_name"/>
		
	</resultMap>
	
	<!-- 代销入库明细表 -->
	<resultMap id="matAffiInDetail" type="java.util.Map">
		<result property="group_id" column="group_id"/>
		<result property="hos_id" column="hos_id"/>
		<result property="copy_code" column="copy_code"/>
		<result property="in_id" column="in_id"/>
		<result property="in_no" column="in_no"/>
		<result property="detail_id" column="detail_id"/>
		<result property="inv_id" column="inv_id"/>
		<result property="inv_no" column="inv_no"/>
		<result property="inv_code" column="inv_code"/>
		<result property="inv_name" column="inv_name"/>
		<result property="inv_model" column="inv_model"/>
		<result property="unit_code" column="unit_code"/>
		<result property="unit_name" column="unit_name"/>
		<result property="batch_no" column="batch_no"/>
		<result property="batch_sn" column="batch_sn"/>
		<result property="price" column="price"/>
		<result property="amount" column="amount"/>
		<result property="amount_money" column="amount_money"/>
		<result property="sale_price" column="sale_price"/>
		<result property="sale_money" column="sale_money"/>
		<result property="sell_price" column="sell_price"/>
		<result property="sell_money" column="sell_money"/>
		<result property="allot_price" column="allot_price"/>
		<result property="allot_money" column="allot_money"/>
		<result property="pack_code" column="pack_code"/>
		<result property="pack_name" column="pack_name"/>
		<result property="num_exchange" column="num_exchange"/>
		<result property="pack_price" column="pack_price"/>
		<result property="num" column="num"/>
		
		<result property="bar_code" column="bar_code"/>
		<result property="sn" column="sn"/>
		<result property="inva_date" column="inva_date"/>
		<result property="disinfect_date" column="disinfect_date"/>
		<result property="location_id" column="location_id"/>
		<result property="location_code" column="location_code"/>
		<result property="location_name" column="location_name"/>
		<result property="note" column="note"/>
		<result property="is_highvalue" column="is_highvalue"/>
		<result property="is_per_bar" column="is_per_bar"/>
		<result property="order_rela" column="order_rela"/>
		
		<result property="fac_name" column="fac_name"/>
		<result property="fac_date" column="fac_date"/>
		<result property="cert_id" column="cert_id"/>
		<result property="cert_code" column="cert_code"/>
		<result property="serial_no" column="serial_no"/>
		<result property="disinfect_no" column="disinfect_no"/>
		<result property="bid_code" column="bid_code"/>
		<result property="delivery_rela" column="delivery_rela"/>
	</resultMap>
	
	<resultMap id="matAffiInSource" type="java.util.Map">
		<result property="group_id" column="group_id"/>
		<result property="hos_id" column="hos_id"/>
		<result property="copy_code" column="copy_code"/>
		<result property="in_id" column="in_id"/>
		<result property="source_id" column="source_id"/>
		<result property="source_money" column="source_money"/>
	</resultMap>
	
	<!-- 查询最大序号 -->
	<select id="queryAffiInMainSeq"  resultType="java.lang.Long" useCache="false" flushCache="true">	
		select MAT_AFFI_IN_SEQ.nextval from dual
	</select>
	
	<!-- 查询最大序号 -->
	<select id="queryAffiInDetailSeq"  resultType="java.lang.Long" useCache="false" flushCache="true">	
		select MAT_AFFI_IN_DETAIL_SEQ.nextval from dual
	</select>
	
	<!-- 获取个体码 -->
	<select id="queryMatPerBar" parameterType="java.util.Map" resultType="java.lang.String" >
		SELECT max_no FROM MAT_NO_OTHER
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND type_code = #{type_code,jdbcType=INTEGER}
	</select>
	
	<!-- 插入个体码 -->
	<insert id="insertMatPerBar" parameterType="java.util.Map" >
		INSERT INTO MAT_NO_OTHER(group_id, hos_id, type_code, max_no)
		VALUES(
			#{group_id,jdbcType=INTEGER},
			#{hos_id,jdbcType=INTEGER},
			#{type_code,jdbcType=INTEGER},
			#{max_no,jdbcType=VARCHAR}
		)
	</insert>
	
	<!-- 修改个体码 -->
	<update id="updateMatPerBar" parameterType="java.util.Map" >
		UPDATE MAT_NO_OTHER
		SET max_no = #{max_no,jdbcType=VARCHAR}
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND type_code = #{type_code,jdbcType=INTEGER}
	</update>
	
	<!--新增入库订单关系表  -->
	<insert id="insertOrderRela" parameterType="java.util.List" >
		insert into mat_affi_in_order_rela(
			group_id, 
			hos_id, 
			copy_code, 
			in_id, 
			in_detail_id, 
			order_id, 
			order_detail_id, 
			in_amount, 
			order_amount
		)select t.* from(
		<foreach collection="list" item="item" index="index" separator=" union all " >
			select 		
				#{item.group_id,jdbcType=INTEGER},
				#{item.hos_id,jdbcType=INTEGER},
				#{item.copy_code,jdbcType=VARCHAR},
				#{item.in_id,jdbcType=INTEGER},
				#{item.in_detail_id,jdbcType=INTEGER},
				#{item.order_id,jdbcType=INTEGER},
				#{item.order_detail_id,jdbcType=INTEGER},
				#{item.in_amount,jdbcType=FLOAT},
				#{item.order_amount,jdbcType=FLOAT}
			from dual
		</foreach>
		)t
	</insert>
	
	<!-- 删除入库订单关系表 -->
	<delete id="deleteOrderRela" parameterType="java.util.Map" >
		DELETE mat_affi_in_order_rela
		<where>
			<if test="group_id != null and group_id != ''">
				and group_id = #{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and hos_id = #{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and copy_code = #{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="order_id != null and order_id != ''">
				and order_id = #{order_id,jdbcType=INTEGER}
			</if>
			<if test="order_detail_id != null and order_detail_id != ''">
				and order_detail_id = #{order_detail_id,jdbcType=INTEGER}
			</if>
			<if test="in_id != null and in_id != ''">
				and in_id = #{in_id,jdbcType=INTEGER}
			</if>
			<if test="in_detail_id != null and in_detail_id != ''">
				and in_detail_id = #{in_detail_id,jdbcType=INTEGER}
			</if>
		</where>
	</delete>
	
	<!-- 批量删除入库订单关系表 -->
	<delete id="deleteBatchOrderRela" parameterType="java.util.List" >
		DELETE mat_affi_in_order_rela
		where
			<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
					<if test="item.group_id != null and item.group_id != ''">
						 group_id = #{item.group_id,jdbcType=INTEGER}
					</if>
					<if test="item.hos_id != null and item.hos_id != ''">
						and hos_id = #{item.hos_id,jdbcType=INTEGER}
					</if>
					<if test="item.copy_code != null and item.copy_code != ''">
						and copy_code = #{item.copy_code,jdbcType=VARCHAR}
					</if>
					<if test="item.order_id != null and item.order_id != ''">
						and order_id = #{item.order_id,jdbcType=INTEGER}
					</if>
					<if test="item.order_detail_id != null and item.order_detail_id != ''">
						and order_detail_id = #{item.order_detail_id,jdbcType=INTEGER}
					</if>
					<if test="item.in_id != null and item.in_id != ''">
						and in_id = #{item.in_id,jdbcType=INTEGER}
					</if>
					<if test="item.in_detail_id != null and item.in_detail_id != ''">
						and in_detail_id = #{item.in_detail_id,jdbcType=INTEGER}
					</if>	
			</foreach>
		
	</delete>
	
	
	<!-- 批量删除入库订单关系表 -->
	<delete id="deleteBatchSupOrderRela" parameterType="java.util.List" >
		DELETE sup_delivery_in_rela
		where
			<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
					<if test="item.group_id != null and item.group_id != ''">
						 group_id = #{item.group_id,jdbcType=INTEGER}
					</if>
					<if test="item.hos_id != null and item.hos_id != ''">
						and hos_id = #{item.hos_id,jdbcType=INTEGER}
					</if>
					<if test="item.copy_code != null and item.copy_code != ''">
						and copy_code = #{item.copy_code,jdbcType=VARCHAR}
					</if>
					<if test="item.delivery_id != null and item.delivery_id != ''">
						and delivery_id = #{item.delivery_id,jdbcType=INTEGER}
					</if>
					<if test="item.in_id != null and item.in_id != ''">
						and in_id = #{item.in_id,jdbcType=INTEGER}
					</if>
					<if test="item.in_detail_id != null and item.in_detail_id != ''">
						and in_detail_id = #{item.in_detail_id,jdbcType=INTEGER}
					</if>	
			</foreach>
		
	</delete>
	
	<!-- 插入主表数据 -->
	<insert id="addMatAffiInMain" useGeneratedKeys="true" >	
		 
		INSERT INTO MAT_AFFI_IN (
			group_id, 
			hos_id, 
			copy_code, 
			in_id, 
			in_no,
			state
			<if test="year != null and year != ''">, year</if>
			<if test="month != null and month != ''">, month</if>
			<if test="brief != null ">, brief</if>
			<if test="bus_type_code != null and bus_type_code != ''">, bus_type_code</if>
			<if test="sup_no != null and sup_no != ''">, sup_no</if>
			<if test="sup_id != null and sup_id != ''">, sup_id</if>
			<if test="store_id != null and store_id != ''">, store_id</if>
			<if test="store_no != null and store_no != ''">, store_no</if>
			<if test="stocker != null and stocker != ''">, stocker</if>
			<if test="stock_type_code != null and stock_type_code != ''">, stock_type_code</if>
			<if test="in_date != null and in_date != ''">, in_date</if>
			<if test="maker != null and maker != ''">, maker</if>
			<if test="checker != null and checker != ''">, checker</if>
			<if test="check_date != null and check_date != ''">, check_date</if>
			<if test="confirmer != null and confirmer != ''">, confirmer</if>
			<if test="confirm_date != null and confirm_date != ''">, confirm_date</if>
			
			<if test="protocol_code != null and protocol_code != ''">, protocol_code</if>
			<if test="app_dept != null and app_dept != ''">, app_dept</if>
			<if test="proj_id != null and proj_id != ''">, proj_id</if>
			<if test="come_from != null and come_from != ''">, come_from</if>
			<if test="delivery_code != null ">, delivery_code</if>
			<if test="examiner != null and examiner != ''">, examiner</if>
		) VALUES (
			#{group_id,jdbcType=INTEGER},
			#{hos_id,jdbcType=INTEGER},
			#{copy_code,jdbcType=VARCHAR},
			#{in_id,jdbcType=INTEGER},
			#{in_no,jdbcType=VARCHAR},
			1
			<if test="year != null and year != ''">, #{year,jdbcType=VARCHAR}</if>
			<if test="month != null and month != ''">, #{month,jdbcType=VARCHAR}</if>
			<if test="brief != null ">, #{brief,jdbcType=VARCHAR}</if>
			<if test="bus_type_code != null and bus_type_code != ''">, #{bus_type_code,jdbcType=VARCHAR}</if>
			<if test="sup_no != null and sup_no != ''">, #{sup_no,jdbcType=INTEGER}</if>
			<if test="sup_id != null and sup_id != ''">, #{sup_id,jdbcType=INTEGER}</if>
			<if test="store_id != null and store_id != ''">, #{store_id,jdbcType=INTEGER}</if>
			<if test="store_no != null and store_no != ''">, #{store_no,jdbcType=INTEGER}</if>
			<if test="stocker != null and stocker != ''">, #{stocker,jdbcType=INTEGER}</if>
			<if test="stock_type_code != null and stock_type_code != ''">, #{stock_type_code,jdbcType=VARCHAR}</if>
			<if test="in_date != null and in_date != ''">, #{in_date,jdbcType=DATE}</if>
			<if test="maker != null and maker != ''">, #{maker,jdbcType=INTEGER}</if>
			<if test="checker != null and checker != ''">, #{checker,jdbcType=INTEGER}</if>
			<if test="check_date != null and check_date != ''">, #{check_date,jdbcType=DATE}</if>
			<if test="confirmer != null and confirmer != ''">, #{confirmer,jdbcType=INTEGER}</if>
			<if test="confirm_date != null and confirm_date != ''">, #{confirm_date,jdbcType=DATE}</if>
			
			<if test="protocol_code != null and protocol_code != ''">, #{protocol_code,jdbcType=VARCHAR}</if>
			<if test="app_dept != null and app_dept != ''">, #{app_dept,jdbcType=INTEGER}</if>
			<if test="proj_id != null and proj_id != ''">, #{proj_id,jdbcType=INTEGER}</if>
			<if test="come_from != null ">, #{come_from,jdbcType=INTEGER}</if>
			<if test="delivery_code != null ">, #{delivery_code,jdbcType=VARCHAR}</if>
			<if test="examiner != null and examiner != ''">, #{examiner,jdbcType=INTEGER}</if>
		)
	</insert>
	
	<!-- 批量插入主表数据 -->
	<insert id="addMatAffiInMainBatch" parameterType="java.util.List" >
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			INSERT INTO MAT_AFFI_IN (
				group_id, 
				hos_id, 
				copy_code, 
				in_id, 
				in_no,
				state
				<if test="item.year != null and item.year != ''">, year</if>
				<if test="item.month != null and item.month != ''">, month</if>
				<if test="item.brief != null ">, brief</if>
				<if test="item.bus_type_code != null and item.bus_type_code != ''">, bus_type_code</if>
				<if test="item.sup_no != null and item.sup_no != ''">, sup_no</if>
				<if test="item.sup_id != null and item.sup_id != ''">, sup_id</if>
				<if test="item.store_id != null and item.store_id != ''">, store_id</if>
				<if test="item.store_no != null and item.store_no != ''">, store_no</if>
				<if test="item.stocker != null and item.stocker != ''">, stocker</if>
				<if test="item.stock_type_code != null and item.stock_type_code != ''">, stock_type_code</if>
				<if test="item.in_date != null and item.in_date != ''">, in_date</if>
				<if test="item.maker != null and item.maker != ''">, maker</if>
				<if test="item.checker != null and item.checker != ''">, checker</if>
				<if test="item.check_date != null and item.check_date != ''">, check_date</if>
				<if test="item.confirmer != null and item.confirmer != ''">, confirmer</if>
				<if test="item.confirm_date != null and item.confirm_date != ''">, confirm_date</if>
				
				<if test="item.protocol_code != null and item.protocol_code != ''">, protocol_code</if>
				<if test="item.app_dept != null and item.app_dept != ''">, app_dept</if>
				<if test="item.proj_id != null and item.proj_id != ''">, proj_id</if>
				<if test="item.come_from != null and item.come_from != ''">, come_from</if>
				<if test="item.delivery_code != null ">, delivery_code</if>
				<if test="item.examiner != null and item.examiner != ''">, examiner</if>
			) VALUES (
				#{item.group_id,jdbcType=INTEGER},
				#{item.hos_id,jdbcType=INTEGER},
				#{item.copy_code,jdbcType=VARCHAR},
				#{item.in_id,jdbcType=INTEGER},
				#{item.in_no,jdbcType=VARCHAR},
				1
				<if test="item.year != null and item.year != ''">, #{item.year,jdbcType=VARCHAR}</if>
				<if test="item.month != null and item.month != ''">, #{item.month,jdbcType=VARCHAR}</if>
				<if test="item.brief != null ">, #{item.brief,jdbcType=VARCHAR}</if>
				<if test="item.bus_type_code != null and item.bus_type_code != ''">, #{item.bus_type_code,jdbcType=VARCHAR}</if>
				<if test="item.sup_no != null and item.sup_no != ''">, #{item.sup_no,jdbcType=INTEGER}</if>
				<if test="item.sup_id != null and item.sup_id != ''">, #{item.sup_id,jdbcType=INTEGER}</if>
				<if test="item.store_id != null and item.store_id != ''">, #{item.store_id,jdbcType=INTEGER}</if>
				<if test="item.store_no != null and item.store_no != ''">, #{item.store_no,jdbcType=INTEGER}</if>
				<if test="item.stocker != null and item.stocker != ''">, #{item.stocker,jdbcType=INTEGER}</if>
				<if test="item.stock_type_code != null and item.stock_type_code != ''">, #{item.stock_type_code,jdbcType=VARCHAR}</if>
				<if test="item.in_date != null and item.in_date != ''">, #{item.in_date,jdbcType=DATE}</if>
				<if test="item.maker != null and item.maker != ''">, #{item.maker,jdbcType=INTEGER}</if>
				<if test="item.checker != null and item.checker != ''">, #{item.checker,jdbcType=INTEGER}</if>
				<if test="item.check_date != null and item.check_date != ''">, #{item.check_date,jdbcType=DATE}</if>
				<if test="item.confirmer != null and item.confirmer != ''">, #{item.confirmer,jdbcType=INTEGER}</if>
				<if test="item.confirm_date != null and item.confirm_date != ''">, #{item.confirm_date,jdbcType=DATE}</if>
				
				<if test="item.protocol_code != null and item.protocol_code != ''">, #{item.protocol_code,jdbcType=VARCHAR}</if>
				<if test="item.app_dept != null and item.app_dept != ''">, #{item.app_dept,jdbcType=INTEGER}</if>
				<if test="item.proj_id != null and item.proj_id != ''">, #{item.proj_id,jdbcType=INTEGER}</if>
				<if test="item.come_from != null and item.come_from != ''">, #{item.come_from,jdbcType=INTEGER}</if>
				<if test="item.delivery_code != null and item.delivery_code != ''">, #{item.delivery_code,jdbcType=VARCHAR}</if>
				<if test="item.examiner != null and item.examiner != ''">, #{item.examiner,jdbcType=INTEGER}</if>
			)
		</foreach>
	</insert>
	
	<!-- 代销明细表数据增加（批量）  -->
	<insert id="addMatAffiInDetail" parameterType="java.util.List" >
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			INSERT INTO MAT_AFFI_IN_DETAIL (
				detail_id, 
				group_id, 
				hos_id, 
				copy_code, 
				in_id,
				in_no,
				inv_id, 
				inv_no,
				price
				<if test="item.batch_no != null and item.batch_no != ''">, batch_no</if>
				<if test="item.batch_sn != null and item.batch_sn != ''">, batch_sn</if> 
				<if test="item.amount != null ">, amount</if> 
				<if test="item.amount_money != null ">, amount_money</if>
				<if test="item.sale_price != null ">, sale_price</if>
				<if test="item.sale_money != null ">, sale_money</if>
				<if test="item.sell_price != null ">, sell_price</if>
				<if test="item.sell_money != null ">, sell_money</if>
				<if test="item.allot_price != null ">, allot_price</if>
				<if test="item.allot_money != null ">, allot_money</if>
				<if test="item.pack_code != null and item.pack_code != ''">, pack_code</if>
				<if test="item.num_exchange != null ">, num_exchange</if>
				<if test="item.pack_price != null ">, pack_price</if>
				<if test="item.num != null">, num</if>
				<if test="item.bar_code != null and item.bar_code != ''">, bar_code</if>
				<if test="item.sn != null and item.sn != ''">, sn</if>
				<if test="item.inva_date != null and item.inva_date != ''">, inva_date</if>
				<if test="item.disinfect_date != null and item.disinfect_date != ''">, disinfect_date</if>
				<if test="item.location_id != null">, location_id</if>
				<if test="item.note != null ">, note</if>
				<if test="item.cert_id != null">, cert_id</if>
				<if test="item.fac_date != null and item.fac_date != ''">, fac_date</if>
				<if test="item.serial_no != null ">, serial_no</if>
				<if test="item.disinfect_no != null ">, disinfect_no</if>
			)values(   
				#{item.detail_id,jdbcType=INTEGER},
				#{item.group_id,jdbcType=INTEGER},
				#{item.hos_id,jdbcType=INTEGER},
				#{item.copy_code,jdbcType=VARCHAR},
				#{item.in_id,jdbcType=INTEGER},
				#{item.in_no,jdbcType=VARCHAR}, 
				#{item.inv_id,jdbcType=INTEGER}, 
				#{item.inv_no,jdbcType=INTEGER}, 
				#{item.price,jdbcType=FLOAT}
				<if test="item.batch_no != null and item.batch_no != ''">, #{item.batch_no,jdbcType=VARCHAR}</if>
				<if test="item.batch_sn != null and item.batch_sn != ''">, #{item.batch_sn,jdbcType=VARCHAR}</if>
				<if test="item.amount != null ">, #{item.amount,jdbcType=FLOAT}</if>
				<if test="item.amount_money != null ">, #{item.amount_money,jdbcType=FLOAT}</if>
				<if test="item.sale_price != null ">, #{item.sale_price,jdbcType=FLOAT}</if>
				<if test="item.sale_money != null ">, #{item.sale_money,jdbcType=FLOAT}</if>
				<if test="item.sell_price != null ">, #{item.sell_price,jdbcType=FLOAT}</if>
				<if test="item.sell_money != null ">, #{item.sell_money,jdbcType=FLOAT}</if>
				<if test="item.allot_price != null ">, #{item.allot_price,jdbcType=FLOAT}</if>
				<if test="item.allot_money != null ">, #{item.allot_money,jdbcType=FLOAT}</if>
				<if test="item.pack_code != null and item.pack_code != ''">, #{item.pack_code,jdbcType=VARCHAR}</if>
				<if test="item.num_exchange != null ">, #{item.num_exchange,jdbcType=INTEGER}</if>
				<if test="item.pack_price != null ">, #{item.pack_price,jdbcType=INTEGER}</if>
				<if test="item.num != null ">, #{item.num,jdbcType=INTEGER}</if>
				<if test="item.bar_code != null and item.bar_code != ''">, #{item.bar_code,jdbcType=VARCHAR}</if>
				<if test="item.sn != null and item.sn != ''">, #{item.sn,jdbcType=VARCHAR}</if>
				<if test="item.inva_date != null and item.inva_date != ''">, #{item.inva_date,jdbcType=DATE}</if>
				<if test="item.disinfect_date != null and item.disinfect_date != ''">, #{item.disinfect_date,jdbcType=DATE}</if>
				<if test="item.location_id != null">, #{item.location_id,jdbcType=INTEGER}</if>
				<if test="item.note != null ">, #{item.note,jdbcType=VARCHAR}</if>
				<if test="item.cert_id != null">, #{item.cert_id,jdbcType=INTEGER}</if>
				<if test="item.fac_date != null and item.fac_date != ''">, #{item.fac_date,jdbcType=DATE}</if>
				<if test="item.serial_no != null ">, #{item.serial_no,jdbcType=VARCHAR}</if>
				<if test="item.disinfect_no != null ">, #{item.disinfect_no,jdbcType=VARCHAR}</if>
			)
		</foreach>
	</insert>
	
	<!-- 更新代销入库主表 -->
	<update id="updateMatAffiInMain" parameterType="java.util.Map">
		UPDATE mat_affi_in 
			<trim prefix="SET"  suffixOverrides=","> 
				<if test="year != null and year != ''">
					year = #{year,jdbcType=VARCHAR}, 
				</if>
				<if test="month != null and month != ''">
					month = #{month,jdbcType=VARCHAR}, 
				</if>
				<if test="brief != null ">
					brief = #{brief,jdbcType=VARCHAR},
				</if>
				<if test="bus_type_code != null and bus_type_code != ''">
					bus_type_code = #{bus_type_code,jdbcType=VARCHAR}, 
				</if> 
				<if test="sup_id != null and sup_id != ''">
					sup_id = #{sup_id,jdbcType=INTEGER},
				</if>
				<if test="sup_no != null and sup_no != ''">
					sup_no = #{sup_no,jdbcType=INTEGER},
				</if>
				<if test="store_id != null and store_id != ''">
					store_id = #{store_id,jdbcType=INTEGER},
				</if>
				<if test="store_no != null and store_no != ''">
					store_no = #{store_no,jdbcType=INTEGER},
				</if>
				<if test="stocker != null">
					stocker = #{stocker,jdbcType=INTEGER},
				</if>
				<if test="stock_type_code != null">
					stock_type_code = #{stock_type_code,jdbcType=VARCHAR},
				</if>
				<if test="in_date != null and in_date != ''">
					in_date = to_date(#{in_date},'yyyy/MM/dd'),
				</if>
				<if test="maker != null and maker != ''">
					maker = #{maker,jdbcType=INTEGER},
				</if>
				<if test="checker != null and checker != ''">
					checker = #{checker,jdbcType=INTEGER},
				</if>
				<if test="check_date != null and check_date != ''">
					check_date = #{check_date,jdbcType=DATE},
				</if>
				<if test="confirmer != null and confirmer != ''">
					confirmer = #{confirmer,jdbcType=INTEGER},
				</if>
				<if test="confirm_date != null and confirm_date != ''">
					confirm_date = #{confirm_date,jdbcType=DATE},
				</if>
				<if test="state != null and state != ''">
					state = #{state,jdbcType=INTEGER},
				</if>
				<if test="protocol_code != null">
					protocol_code = #{protocol_code,jdbcType=VARCHAR},
				</if>
				<if test="app_dept != null">
					app_dept = #{app_dept,jdbcType=INTEGER},
				</if>
				<if test="proj_id != null">
					proj_id = #{proj_id,jdbcType=INTEGER},
				</if>
				<if test="delivery_code != null">
					delivery_code = #{delivery_code,jdbcType=VARCHAR},
				</if>
				<if test="examiner != null">
					examiner = #{examiner,jdbcType=INTEGER},
				</if>
			</trim>
			<where>
				<if test="group_id != null and group_id != ''">
					and group_id =#{group_id,jdbcType=INTEGER}
				</if>
				<if test="hos_id != null and hos_id != ''">
					and hos_id =#{hos_id,jdbcType=INTEGER}
				</if>
				<if test="copy_code != null and copy_code != ''">
					and copy_code =#{copy_code,jdbcType=VARCHAR}
				</if>
				<if test="in_id != null and in_id != ''">
					and in_id =#{in_id,jdbcType=INTEGER}
				</if>
				<if test="in_no != null and in_no != ''">
					and in_no =#{in_no,jdbcType=VARCHAR}
				</if>
			</where>
		</update>
		
	<!-- 批量更新主表 -->
	<update id="updateBatchMatAffiInMain" parameterType="java.util.Map">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
		UPDATE mat_affi_in 
			<trim prefix="SET"  suffixOverrides=","> 
				<if test="item.year != null and item.year != ''">
					year = #{item.year,jdbcType=VARCHAR}, 
				</if>
				<if test="item.month != null and item.month != ''">
					month = #{item.month,jdbcType=VARCHAR}, 
				</if>
				<if test="item.brief != null ">
					brief = #{item.brief,jdbcType=VARCHAR},
				</if>
				<if test="item.bus_type_code != null and item.bus_type_code != ''">
					bus_type_code = #{item.bus_type_code,jdbcType=VARCHAR}, 
				</if> 
				<if test="item.sup_id != null and item.sup_id != ''">
					sup_id = #{item.sup_id,jdbcType=INTEGER},
				</if>
				<if test="item.sup_no != null and item.sup_no != ''">
					sup_no = #{item.sup_no,jdbcType=INTEGER},
				</if>
				<if test="item.store_id != null and item.store_id != ''">
					store_id = #{item.store_id,jdbcType=INTEGER},
				</if>
				<if test="item.store_no != null and item.store_no != ''">
					store_no = #{item.store_no,jdbcType=INTEGER},
				</if>
				<if test="item.stocker != null and item.stocker != ''">
					stocker = #{item.stocker,jdbcType=INTEGER},
				</if>
				<if test="item.stock_type_code != null">
					stock_type_code = #{item.stock_type_code,jdbcType=VARCHAR},
				</if>
				<if test="item.in_date != null and item.in_date != ''">
					in_date = #{item.in_date,jdbcType=DATE},
				</if>
				<if test="item.maker != null and item.maker != ''">
					maker = #{maker,jdbcType=INTEGER},
				</if>
				<if test="item.checker != null and item.checker != ''">
					checker = #{item.checker,jdbcType=INTEGER},
				</if>
				<if test="item.check_date != null and item.check_date != ''">
					check_date = #{item.check_date,jdbcType=DATE},
				</if>
				<if test="item.confirmer != null and item.confirmer != ''">
					confirmer = #{item.confirmer,jdbcType=INTEGER},
				</if>
				<if test="item.confirm_date != null and item.confirm_date != ''">
					confirm_date = #{item.confirm_date,jdbcType=DATE},
				</if>
				<if test="item.state != null and item.state != ''">
					state = #{item.state,jdbcType=INTEGER},
				</if>
				<if test="item.protocol_code != null">
					protocol_code = #{item.protocol_code,jdbcType=VARCHAR},
				</if>
				<if test="item.app_dept != null">
					app_dept = #{item.app_dept,jdbcType=INTEGER},
				</if>
				<if test="item.proj_id != null">
					proj_id = #{item.proj_id,jdbcType=INTEGER},
				</if>
				<if test="item.delivery_code != null">
					delivery_code = #{item.delivery_code,jdbcType=VARCHAR},
				</if>
				<if test="item.examiner != null">
					examiner = #{item.examiner,jdbcType=INTEGER},
				</if>
			</trim>
			<where>
				<if test="item.group_id != null and item.group_id != ''">
					 group_id =#{item.group_id,jdbcType=INTEGER}
				</if>
				<if test="item.hos_id != null and item.hos_id != ''">
					and hos_id =#{item.hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					and copy_code =#{item.copy_code,jdbcType=VARCHAR}
				</if>
				<if test="item.in_id != null and item.in_id != ''">
					and in_id =#{item.in_id,jdbcType=INTEGER}
				</if>
				<if test="item.in_no != null and item.in_no != ''">
					and in_no =#{item.in_no,jdbcType=VARCHAR}
				</if>
			</where>
		</foreach>
	</update>
		
	<!-- 批量更新代销入库明细表 -->
	<update id="updateMatAffiInDetail" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			UPDATE mat_affi_in_detail
				<trim prefix="SET"  suffixOverrides=","> 
					<if test="item.inv_no != null and item.inv_no != ''">
						inv_no = #{item.inv_no,jdbcType=INTEGER},
					</if>
					<if test="item.inv_id != null and item.inv_id != ''">
						inv_id = #{item.inv_id,jdbcType=INTEGER},
					</if>
					<if test="item.batch_no != null and item.batch_no != ''">
						batch_no = #{item.batch_no,jdbcType=VARCHAR},
					</if>
					<if test="item.batch_sn != null and item.batch_sn != ''">
						batch_sn = #{item.batch_sn,jdbcType=VARCHAR},
					</if>
				
					<if test="item.price != null">
						price = #{item.price,jdbcType=FLOAT},
					</if>
					<if test="item.amount != null">
						amount = #{item.amount,jdbcType=INTEGER}
					</if>
					<if test="item.amount_money != null">
						amount_money = #{item.amount_money,jdbcType=FLOAT}
					</if>
					<if test="item.sell_price != null">
						sell_price = #{item.sell_price,jdbcType=FLOAT}
					</if>
					<if test="item.sell_money != null">
						sell_money = #{item.sell_money,jdbcType=FLOAT},
					</if>
					<if test="item.sale_price != null">
						sale_price = #{item.sale_price,jdbcType=FLOAT}
					</if>
					<if test="item.sale_money != null">
						sale_money = #{item.sale_money,jdbcType=FLOAT},
					</if>
					<if test="item.allot_price != null">
						allot_price = #{item.allot_price,jdbcType=FLOAT}
					</if>
					<if test="item.allot_money != null">
						allot_money = #{item.allot_money,jdbcType=FLOAT},
					</if>
					<if test="item.pack_code != null">
						pack_code = #{item.pack_code,jdbcType=VARCHAR},
					</if>
					<if test="item.num_exchange!= null">
						num_exchange = #{item.num_exchange,jdbcType=INTEGER},
					</if>
					<if test="item.pack_price != null">
						pack_price = #{item.pack_price,jdbcType=FLOAT},
					</if>
					<if test="item.num != null">
						num = #{item.num,jdbcType=INTEGER},
					</if>
					<if test="item.bar_code != null and item.bar_code != ''">
						bar_code = #{item.bar_code,jdbcType=VARCHAR},
					</if>
					<if test="item.sn != null and item.sn != ''">
						sn = #{item.sn,jdbcType=VARCHAR},
					</if>
					<if test="item.inva_date != null">
						inva_date = #{item.inva_date,jdbcType=DATE},
					</if>
					<if test="item.disinfect_date != null">
						disinfect_date = #{item.disinfect_date,jdbcType=DATE},
					</if>
					<if test="item.location_id != null">
						location_id = #{item.location_id,jdbcType=INTEGER},
					</if>
					<if test="item.note != null">
						note = #{item.note,jdbcType=VARCHAR},
					</if>
					<if test="item.cert_id != null">
						cert_id = #{item.cert_id,jdbcType=INTEGER},
					</if>
					<if test="item.fac_date != null">
						fac_date = #{item.fac_date,jdbcType=DATE},
					</if>
					<if test="item.serial_no != null">
						serial_no = #{item.serial_no,jdbcType=VARCHAR},
					</if>
					<if test="item.disinfect_no != null">
						disinfect_no = #{item.disinfect_no,jdbcType=VARCHAR},
					</if>
				</trim>
				<where>
					<if test="group_id != null and group_id != ''">
						and group_id =#{group_id,jdbcType=INTEGER}
					</if>
					<if test="hos_id != null and hos_id != ''">
						and hos_id =#{hos_id,jdbcType=INTEGER}
					</if>
					<if test="copy_code != null and copy_code != ''">
						and copy_code =#{copy_code,jdbcType=VARCHAR}
					</if>
					<if test="in_id != null and in_id != ''">
						and in_id =#{in_id,jdbcType=INTEGER}
					</if>
					<if test="detail_id != null and detail_id != ''">
						and detail_id =#{detail_id,jdbcType=INTEGER}
					</if>
				</where>
		</foreach>
	</update>
	
	<!-- 删除 代销入库主表信息 -->
	<delete id="deleteMatAffiInMain" parameterType="java.util.Map">
		DELETE FROM mat_affi_in 
		<where>
			<if test="group_id != null and group_id != ''">
				and group_id =#{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and hos_id =#{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and copy_code =#{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="in_id != null and in_id != ''">
				and in_id =#{in_id,jdbcType=INTEGER}
			</if>
			<if test="in_no != null and in_no != ''">
				and in_no =#{in_no,jdbcType=VARCHAR}
			</if>
		</where>
	</delete>
	
	<!-- 删除 代销入库明细表信息 -->
	<delete id="deleteMatAffiInDetail" parameterType="java.util.Map">
		DELETE FROM mat_affi_in_detail 
		<where>
			<if test="group_id != null and group_id != ''">
				and group_id =#{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and hos_id =#{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and copy_code =#{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="in_id != null and in_id != ''">
				and in_id =#{in_id,jdbcType=INTEGER}
			</if>
			<if test="detail_id != null and detail_id != ''">
				and detail_id =#{detail_id,jdbcType=INTEGER}
			</if>
		</where>
	</delete>
	
	<!-- 批量 删除明细表信息 -->
	<delete id="deleteBatchDetail" parameterType="java.util.Map">
		delete from mat_affi_in_detail 
		<where>
			<if test="group_id != null and group_id != ''">
				and group_id =#{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				and hos_id =#{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				and copy_code =#{copy_code,jdbcType=VARCHAR}
			</if>
			<if test="in_id != null and in_id != ''">
				and in_id =#{in_id,jdbcType=INTEGER}
			</if>
		</where>
	</delete>
	
	<!-- 更新代销入库 明细表信息 -->
	<delete id="deleteMatAffiInDetailForUpdate" parameterType="java.util.Map">
		DELETE FROM mat_affi_in_detail 
		WHERE group_id = #{group_id,jdbcType=INTEGER} 
			and hos_id = #{hos_id,jdbcType=INTEGER} 
			and copy_code = #{copy_code,jdbcType=VARCHAR} 
			and in_id = #{in_id,jdbcType=INTEGER} 
			and detail_id not in (${detail_ids})
	</delete>
	
	<!-- 批量删除 代销入库表主表信息 -->
	<delete id="deleteBatchMatAffiInMain" parameterType="java.util.List">
		DELETE FROM mat_affi_in 
		WHERE
		<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
			group_id = #{item.group_id,jdbcType=INTEGER}
			and	hos_id = #{item.hos_id,jdbcType=INTEGER}
			and	copy_code =	#{item.copy_code,jdbcType=VARCHAR}
			and in_id = #{item.in_id,jdbcType=INTEGER}			
		</foreach>		
	</delete>
	
	<!-- 批量删除 代销入库表明细表信息 -->
	<delete id="deleteBatchMatAffiInDetail" parameterType="java.util.List">
		DELETE FROM mat_affi_in_detail
		where
		<foreach collection="list" index="index" item="item" open="(" separator="or" close=")">
				<if test="item.group_id != null and item.group_id != ''">
					group_id = #{item.group_id,jdbcType=INTEGER}
				</if>
				<if test="item.hos_id != null and item.hos_id != ''">
					and hos_id = #{item.hos_id,jdbcType=INTEGER}
				</if>
				<if test="item.copy_code != null and item.copy_code != ''">
					and copy_code = #{item.copy_code,jdbcType=VARCHAR}
				</if>
				<if test="item.in_id != null and item.in_id != ''">
					and in_id = #{item.in_id,jdbcType=INTEGER}
				</if>
		</foreach>
	</delete>
	
	<!-- 根据主键查询 代销入库主表信息 -->
	<select id="queryByCode" resultMap="matAffiInMain" parameterType="java.util.Map" >
		SELECT 
			a.group_id, 
			a.hos_id, 
			a.copy_code, 
			a.in_id, 
			a.in_no, 
			a.year, 
			a.month, 
			a.brief, 
			a.bus_type_code, 
			a.sup_no, 
			a.sup_id, 
			hsd.sup_code,
			hsd.sup_name, 
      		a.store_id, 
      		a.store_no, 
      		hs.store_code,
      		hs.store_name,
      		a.stocker, 
      		hed.emp_code stocker_code,hed.emp_name stocker_name,
      		a.stock_type_code, 
      		a.in_date, 
      		a.maker, 
      		b.user_name maker_name, 
      		a.checker, 
      		c.user_name checker_name, 
      		a.check_date, 
      		a.confirmer, 
      		d.user_name confirmer_name, 
      		a.confirm_date, 
      		a.state, 
      		mpm.protocol_id protocol_id,
      		mpm.protocol_code,
      		mpm.protocol_name,
      		a.app_dept,
      		hdd.dept_code app_dept_code,
      		hdd.dept_name app_dept_name,
      		a.proj_id,
      		hpd.proj_code,
      		hpd.proj_name,a.come_from,
      		a.delivery_code,
			a.examiner,hd.emp_code examiner_code,hd.emp_name examiner_name
		FROM mat_affi_in a 
		left join hos_emp_dict hed on a.group_id = hed.group_id and a.hos_id = hed.hos_id
			and a.stocker = hed.emp_id and hed.is_stop = 0
		left join sys_user b on a.group_id = b.group_id
			and a.hos_id = b.hos_id
			and a.maker = b.user_id
		left join sys_user c on a.group_id = c.group_id
			and a.hos_id = c.hos_id
			and a.checker = c.user_id
		left join sys_user d on a.group_id = d.group_id 
			and a.hos_id = d.hos_id
			and a.confirmer = d.user_id
		left join hos_sup_dict hsd on hsd.sup_id = a.sup_id
			and hsd.group_id = a.group_id
			and hsd.hos_id = a.hos_id
			<if test="show_history == 1">
				and a.sup_no = hsd.sup_no
			</if>
			<if test="show_history == 0">
				and hsd.is_stop = 0
			</if>
		left join hos_store_dict hs on hs.group_id = a.group_id
			and hs.hos_id = a.hos_id
			and hs.store_id = a.store_id
			<if test="show_history == 1">
				and hs.store_no = a.store_no
			</if>
			<if test="show_history == 0">
				and hs.is_stop = 0
			</if>
		left join hos_proj_dict hpd on hpd.proj_id = a.proj_id
			and hpd.group_id = a.group_id
			and hpd.hos_id = a.hos_id
			<if test="show_history == 1">
				and a.proj_id = hpd.proj_id
			</if>
			<if test="show_history == 0">
				and hpd.is_stop = 0
			</if>
		left join hos_dept hdd on hdd.dept_id = a.app_dept
			and hdd.group_id = a.group_id
			and hdd.hos_id = a.hos_id
			<if test="show_history == 0">
				and hdd.is_stop = 0
			</if>
		left join mat_protocol_main mpm on mpm.protocol_code= a.protocol_code
		 	and mpm.hos_id = a.hos_id
		 	and mpm.group_id = a.group_id
		 	and mpm.copy_code = a.copy_code
		left join hos_emp_dict hd on a.group_id = hd.group_id and a.hos_id = hd.hos_id
			and a.examiner = hd.emp_id and hd.is_stop = 0
		WHERE a.group_id = #{group_id,jdbcType=INTEGER} 
			and a.hos_id = #{hos_id,jdbcType=INTEGER} 
			and a.copy_code = #{copy_code,jdbcType=VARCHAR} 
			and a.in_id = #{in_id,jdbcType=INTEGER} 
			
  group by  a.group_id, a.hos_id, a.copy_code, a.in_id, a.in_no
  , a.year, a.month, a.brief, a.bus_type_code, a.sup_no
  , a.sup_id, hsd.sup_code, hsd.sup_name, a.store_id, a.store_no
  , hs.store_code, hs.store_name, a.stocker, a.stock_type_code, a.in_date
  , a.maker, b.user_name , a.checker, c.user_name, a.check_date
  , a.confirmer, d.user_name, a.confirm_date, a.state, mpm.protocol_id 
  , mpm.protocol_code, mpm.protocol_name, a.app_dept, hdd.dept_code , hdd.dept_name 
  , a.proj_id, hpd.proj_code, hpd.proj_name, a.come_from, a.delivery_code
  , a.examiner, hd.emp_code, hd.emp_name,hed.emp_code,hed.emp_name
	</select>
	
	<!-- 用于入库单主表加载 -->
	<select id="queryMatAffiInByCode" resultMap="matAffiInMain" parameterType="java.util.Map" >
		SELECT 
			a.group_id, 
			a.hos_id, 
			a.copy_code, 
			a.in_id, 
			a.in_no, 
			a.year, 
			a.month, 
			a.brief, 
			a.bus_type_code, 
			a.sup_no, 
			a.sup_id, 
			hsd.sup_code,
			hsd.sup_name, 
      		a.store_id, 
      		a.store_no, 
      		hs.store_code,
      		hs.store_name,
      		a.stocker, 
      		hed.emp_code stocker_code,
          	hed.emp_name stocker_name,
      		a.stock_type_code, 
      		a.in_date, 
      		a.maker, 
      		b.user_name maker_name, 
      		a.checker, 
      		c.user_name checker_name, 
      		a.check_date, 
      		a.confirmer, 
      		d.user_name confirmer_name, 
      		a.confirm_date, 
      		a.state, 
      		a.protocol_code protocol_id,
      		mpm.protocol_code,
      		mpm.protocol_name,
      		a.app_dept,
      		hdd.dept_no app_dept_no,
      		hdd.dept_code app_dept_code,
      		hdd.dept_name app_dept_name,
      		a.proj_id,
      		hpd.proj_code,
      		hpd.proj_name,
      		a.come_from,
      		a.delivery_code,
			a.examiner,hd.emp_code examiner_code,hd.emp_name examiner_name
		FROM mat_affi_in a
		left join sys_user b on a.group_id = b.group_id
			and a.hos_id = b.hos_id
			and a.maker = b.user_id
		left join sys_user c on a.group_id = c.group_id
			and a.hos_id = c.hos_id
			and a.checker = c.user_id
		left join sys_user d on a.group_id = d.group_id 
			and a.hos_id = d.hos_id
			and a.confirmer = d.user_id
		left join hos_emp_dict  hed on hed.group_id = a.group_id
			and hed.hos_id = a.hos_id
			and hed.emp_id = a.stocker
			<if test="show_history == 0">
				and hed.is_stop = 0
			</if>
		left join hos_sup_dict hsd on hsd.sup_id = a.sup_id
			and hsd.group_id = a.group_id
			and hsd.hos_id = a.hos_id
			<if test="show_history == 1">
				and a.sup_no = hsd.sup_no
			</if>
			<if test="show_history == 0">
				and hsd.is_stop = 0
			</if>
		left join hos_store_dict hs on hs.group_id = a.group_id
			and hs.hos_id = a.hos_id
			and hs.store_id = a.store_id
			<if test="show_history == 1">
				and hs.store_no = a.store_no
			</if>
			<if test="show_history == 0">
				and hs.is_stop = 0
			</if>
		left join hos_proj_dict hpd on hpd.proj_id = a.proj_id
			and hpd.group_id = a.group_id
			and hpd.hos_id = a.hos_id
			<if test="show_history == 1">
				 and a.proj_id= hpd.proj_id
			</if>
			<if test="show_history == 0">
				and hpd.is_stop = 0
			</if>
		left join hos_dept_dict hdd on hdd.dept_id = a.app_dept
			and hdd.group_id = a.group_id
			and hdd.hos_id = a.hos_id
			<if test="show_history == 0">
				and hdd.is_stop = 0
			</if>
		left join mat_protocol_main mpm on mpm.protocol_code = a.protocol_code
		 	and mpm.hos_id = a.hos_id
		 	and mpm.group_id = a.group_id
		 	and mpm.copy_code = a.copy_code
		left join hos_emp_dict hd on a.group_id = hd.group_id and a.hos_id = hd.hos_id
			and a.examiner = hd.emp_id and hd.is_stop = 0
		WHERE a.group_id = #{group_id,jdbcType=INTEGER} 
			and a.hos_id = #{hos_id,jdbcType=INTEGER} 
			and a.copy_code = #{copy_code,jdbcType=VARCHAR} 
			and a.in_id = #{in_id,jdbcType=INTEGER} 
	</select>
	
	<!-- 用于入库单明细表加载 -->
	<select id="queryDetailByCode" resultMap="matAffiInDetail" parameterType="java.util.Map">
		SELECT
			a.group_id, 
			a.hos_id, 
			a.copy_code, 
			a.in_id, 
			a.detail_id, 
			a.inv_id, 
			a.inv_no, 
			b.inv_code, 
			b.inv_name, 
			b.inv_model, 
			b.unit_code, 
			c.unit_name, 
			a.amount, 
			a.price, 
			a.amount_money, 
			a.pack_code, 
			e.pack_name, 
			a.num_exchange, 
			a.pack_price, 
			a.num, 
			a.batch_no, 
			a.batch_sn, 
			a.sn, 
			a.bar_code, 
			a.sell_price, 
			a.sell_money, 
			a.sale_price, 
			a.sale_money, 
			a.allot_price, 
			a.allot_money, 
			a.inva_date, 
			a.disinfect_date,
			a.disinfect_no,
			a.location_id, 
			d.location_name, 
			a.note, 
			f.order_rela, 
			b.is_highvalue, 
			b.is_batch, 
			b.is_bar, 
			b.is_per_bar, 
			b.is_quality, 
			b.is_single_ven, 
			b.is_disinfect,
			hf.fac_name,
			b.bid_code,
			mic.cert_id,mic.cert_code,a.fac_date,a.serial_no,g.delivery_rela
		FROM mat_affi_in_detail a
		left join mat_inv_dict b on a.group_id = b.group_id
			and a.hos_id = b.hos_id
			and a.copy_code = b.copy_code
			and a.inv_id = b.inv_id
			and a.inv_no = b.inv_no
		left join hos_unit c on b.group_id = c.group_id
			and b.hos_id = c.hos_id
			and b.unit_code = c.unit_code
		left join mat_location_dict d on a.group_id = d.group_id 
			and a.hos_id = d.hos_id
			and a.copy_code = d.copy_code
			and a.location_id = d.location_id
		left join hos_package e on a.group_id = e.group_id
			and a.hos_id = e.hos_id
			and a.pack_code = e.pack_code
		left join hos_fac_dict hf 
			on  hf.group_id = b.group_id
		    and hf.hos_id = b.hos_id
		    and hf.fac_id = b.fac_id
		    and hf.fac_no = b.fac_no
		left join mat_inv_cert mic 
			on mic.group_id = a.group_id
			and mic.hos_id = a.hos_id
			and mic.copy_code = a.copy_code
			and mic.cert_id = a.cert_id
<!-- 			and mic.cert_state = 1  -->
		left join (
			select in_detail_id, '['||to_char(wm_concat('{"order_id":'||order_id||',"order_detail_id":'||order_detail_id||',"in_amount":'||in_amount||',"order_amount":'||order_amount||'}'))||']' order_rela 
			from mat_affi_in_order_rela
			where group_id = #{group_id,jdbcType=INTEGER} 
				and hos_id = #{hos_id,jdbcType=INTEGER} 
				and copy_code = #{copy_code,jdbcType=VARCHAR}
				and in_id = #{in_id,jdbcType=INTEGER} 
			group by in_detail_id
		)f on a.detail_id = f.in_detail_id 
		left join (
			select in_detail_id,'[' || to_char(wm_concat('{"delivery_id":' || delivery_id || ',"delivery_no":' || delivery_no || ',"inv_id":' || inv_id || ',"in_amount":' || in_amount || ',"delivery_amount":' || delivery_amount || '}')) || ']' as delivery_rela
	       	from sup_delivery_in_rela 
	       	where group_id = #{group_id,jdbcType=INTEGER}
				and hos_id = #{hos_id,jdbcType=INTEGER}
				and copy_code = #{copy_code,jdbcType=VARCHAR}
				and in_id = #{in_id,jdbcType=INTEGER}
				and is_com = 1 
	       	group by in_detail_id
		)g on a.detail_id=g.in_detail_id
		WHERE a.group_id = #{group_id,jdbcType=INTEGER} 
			and a.hos_id = #{hos_id,jdbcType=INTEGER} 
			and a.copy_code = #{copy_code,jdbcType=VARCHAR} 
			and a.in_id = #{in_id,jdbcType=INTEGER}  
		order by a.detail_id
	</select>
	
	<!-- 根据主键Ids获取主表List -->
	<select id="queryMatAffiInMainByIds" parameterType="java.util.Map" resultMap="matAffiInMain" >
		SELECT group_id, hos_id, copy_code, in_id, in_no, year, month, bus_type_code, sup_no, sup_id, 
			store_id, store_no, in_date, brief, stocker, maker, 1 state, protocol_code, app_dept, proj_id,come_from,
			delivery_code,examiner
		FROM mat_affi_in
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			AND in_id in (${in_ids})
	</select>
	
	<!-- 根据主键Ids获取明细表List -->
	<select id="queryMatAffiInDetailByIds" parameterType="java.util.Map" resultMap="matAffiInDetail" >
		SELECT group_id, hos_id, copy_code, in_id,detail_id, inv_id, inv_no, batch_no, batch_sn, 
			price, amount, amount_money, sell_price, sell_money, sale_price, sale_money, allot_price, 
			allot_money, pack_code, num_exchange, pack_price, num, sn, bar_code, inva_date, 
			disinfect_date, location_id, note,cert_id,serial_no,fac_date,disinfect_no
		FROM mat_affi_in_detail
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			AND in_id in (${in_ids})
	</select>
	
	<!-- 根据主键Ids获取主表List -->
	<select id="queryMatInMainByIds" parameterType="java.util.Map" resultMap="matAffiInMain" >
		SELECT group_id, hos_id, copy_code, in_id, in_no, year, month, bus_type_code, sup_no, sup_id, stock_type_code,
			store_id, store_no, in_date, brief, stocker, maker, 1 state, protocol_code, app_dept, proj_id,come_from,delivery_code,
			examiner
		FROM mat_affi_in
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			AND in_id in (${in_ids})
	</select>
	
	<!-- 根据主键Ids获取明细表List -->
	<select id="queryMatInDetailByIds" parameterType="java.util.Map" resultMap="matAffiInDetail" >
		SELECT a.group_id, a.hos_id, a.copy_code, a.in_id,a.in_no, a.detail_id, a.inv_id, a.inv_no, a.batch_no, a.batch_sn, 
			a.price, nvl(a.amount,0) amount, nvl(a.amount_money,0) amount_money, nvl(a.sell_price,0) sell_price, nvl(a.sell_money,0) sell_money, 
			nvl(a.sale_price,0) sale_price, nvl(a.sale_money,0) sale_money, nvl(a.allot_price,0) allot_price, 
			nvl(a.allot_money,0) allot_money, a.pack_code, nvl(a.num_exchange,0) num_exchange, nvl(a.pack_price,0) pack_price, nvl(a.num,0) num, a.sn, a.bar_code, a.inva_date, 
			a.disinfect_date,a.disinfect_no, a.location_id, a.note, b.is_per_bar, b.is_highvalue,a.fac_date,a.serial_no,a.cert_id,a.disinfect_no
		FROM mat_affi_in_detail a
		LEFT JOIN MAT_INV_DICT b
			ON a.group_id = b.group_id AND a.hos_id = b.hos_id
			AND a.copy_code = b.copy_code AND a.inv_id = b.inv_id
			AND b.is_stop = 0
		WHERE a.group_id = #{group_id,jdbcType=INTEGER}
			AND a.hos_id = #{hos_id,jdbcType=INTEGER}
			AND a.copy_code = #{copy_code,jdbcType=VARCHAR}
			AND a.in_id in (${in_ids})
	</select>
	
	<!-- 获取上一张入库单ID -->
	<select id="queryMatAffiInBefore" parameterType="java.util.Map" resultType="String" >
		SELECT MAX(in_id)
		FROM mat_affi_in
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			AND store_id = #{store_id,jdbcType=INTEGER}
			AND bus_type_code = #{bus_type_code,jdbcType=VARCHAR}
			AND in_id &lt; #{in_id,jdbcType=INTEGER}
	</select>
	
	<!-- 获取下一张入库单ID -->
	<select id="queryMatAffiInNext" parameterType="java.util.Map" resultType="String" >
		SELECT MIN(in_id)
		FROM mat_affi_in
		WHERE group_id = #{group_id,jdbcType=INTEGER}
			AND hos_id = #{hos_id,jdbcType=INTEGER}
			AND copy_code = #{copy_code,jdbcType=VARCHAR}
			AND store_id = #{store_id,jdbcType=INTEGER}
			AND bus_type_code = #{bus_type_code,jdbcType=VARCHAR}
			AND in_id &gt; #{in_id,jdbcType=INTEGER}
	</select>
	
	<update id="updateBatchConfirm" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";" >
			UPDATE mat_affi_in 
			set
				year = #{item.year,jdbcType=VARCHAR},
				month = #{item.month,jdbcType=VARCHAR},
				confirm_date = fun_date_same_year_month(in_date, sysdate),
				confirmer = #{item.confirmer,jdbcType=INTEGER},
				state = #{item.state,jdbcType=INTEGER}
			WHERE group_id = #{item.group_id,jdbcType=INTEGER}
				and hos_id = #{item.hos_id,jdbcType=INTEGER}
				and copy_code = #{item.copy_code,jdbcType=VARCHAR}
				and in_id = #{item.in_id,jdbcType=INTEGER}
		</foreach>
	</update>
	
	
	<!-- 查询明细材料的信息用于生成条码 -->
	<select id="queryMatAffiInBarcodeByPrintTemlate" parameterType="java.util.Map" resultType="java.util.Map">
		select d.detail_id as id,
	         d.PRICE,
	         d.NOTE,
	         d.BATCH_NO,
	         d.BAR_CODE,
	         to_char(d.INVA_DATE, 'yyyy-MM-dd') as INVA_DATE,
	         to_char(d.FAC_DATE, 'yyyy-MM-dd') as fac_date,
	        
	         i.INV_CODE,
	         i.INV_NAME,
	         i.INV_MODEL,
	         u.UNIT_NAME as unit_code,
	         f.FAC_NAME  
	    from mat_affi_in_detail d
	    left join mat_inv_dict i
	      on d.group_id = i.group_id
	     and d.hos_id = i.hos_id
	     and d.copy_code = i.copy_code
	     and d.inv_id = i.inv_id
	     and d.inv_no = i.inv_no
	    left join hos_fac_dict f
	      on i.group_id = f.group_id
	     and i.hos_id = f.hos_id
	     and i.fac_id = f.fac_id
	     and i.fac_no = f.fac_no
	    left join hos_unit u
	      on d.group_id = u.group_id
	     and d.hos_id = u.hos_id
	     and i.unit_code = u.unit_code
	 <where>
			<if test="group_id != null and group_id != ''">
				AND d.group_id =#{group_id,jdbcType=INTEGER}
			</if>
			<if test="hos_id != null and hos_id != ''">
				AND d.hos_id =#{hos_id,jdbcType=INTEGER}
			</if>
			<if test="copy_code != null and copy_code != ''">
				AND d.copy_code =#{copy_code,jdbcType=VARCHAR}
			</if>
			<foreach collection="detail_idList" item="detail_id" separator="," open="and to_char(d.detail_id) in(" close=")">
			       #{detail_id,jdbcType=VARCHAR}
			</foreach>
		</where>
	</select>
	
	<select id="queryDeliveryAffiOrderIds"  parameterType="java.util.List" resultType="String">
		with list_temp as (
			<foreach collection="list" item="item" index="index" separator=" union all " >
				select    
					#{item.group_id,jdbcType=INTEGER} as group_id, 
					#{item.hos_id,jdbcType=INTEGER} as hos_id, 
					#{item.copy_code,jdbcType=VARCHAR} as copy_code,
					#{item.in_id,jdbcType=INTEGER} as in_id,
					#{item.delivery_id,jdbcType=INTEGER} as delivery_id,
					#{item.delivery_no,jdbcType=VARCHAR} as delivery_no,
					#{item.inv_id,jdbcType=INTEGER} as inv_id,
					#{item.is_com,jdbcType=INTEGER} as is_com
				from dual
			</foreach>
		),old_tmp as (
			select group_id,hos_id,copy_code,in_id,delivery_id,delivery_no,inv_id
			from sup_delivery_in_rela 
			where in_id in (
				select distinct in_id
				from list_temp
			) and is_com = 1
		)
		
		select to_char(wm_concat(order_id)) 
		from (
			select distinct b.order_id
			from (
	      		select group_id,hos_id,copy_code,in_id,delivery_id,delivery_no,inv_id
	      		from old_tmp
	      		minus
	      		select group_id,hos_id,copy_code,in_id,delivery_id,delivery_no,inv_id
	      		from list_temp
	 		) a 
	 		left join sup_delivery_order_rela b on a.group_id=b.group_id and a.hos_id=b.hos_id and a.copy_code=b.copy_code
	 			and a.delivery_id=b.delivery_id and a.delivery_no=b.delivery_no and a.inv_id=b.inv_id 
		)
 		
	</select>
</mapper>

